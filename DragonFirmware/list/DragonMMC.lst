                      (    DragonMMC.asm):00001         ;
                      (    DragonMMC.asm):00002         ; DragonPicoSD system ROM,
                      (    DragonMMC.asm):00003         ;
                      (    DragonMMC.asm):00004         ; 2011-06-13, Phill Harvey-Smith.
                      (    DragonMMC.asm):00005         ;
                      (    DragonMMC.asm):00006         ; Fixed for assembly with "mamou" cross-assembler,
                      (    DragonMMC.asm):00007         ; from NitrOS9 cocotools.
                      (    DragonMMC.asm):00008         ;
                      (    DragonMMC.asm):00009         ; 2012-10-07,   Began porting to CoCo.
                      (    DragonMMC.asm):00010         ;
                      (    DragonMMC.asm):00011         ; 2012-10-20,   Began merging with SuperDos for dos disk image emulation.
                      (    DragonMMC.asm):00012         ;
                      (    DragonMMC.asm):00013         ; 2016-03-21,   Abandoned use of Superdos, and reverted to a bugfixed 
                      (    DragonMMC.asm):00014         ;               Dragondos (1.3) for Dragon disk emulation.
                      (    DragonMMC.asm):00015         ;
                      (    DragonMMC.asm):00016         ; 2016-04-05,   Implemented RSDOS disk emulation.
                      (    DragonMMC.asm):00017         ;
                      (    DragonMMC.asm):00018         ; 2017-03-04,   Began implementing NMI handler for snapshot button.
                      (    DragonMMC.asm):00019         ;
                      (    DragonMMC.asm):00020         ; 2017-03-07,   Fixed a bug that caused MTAPERUN to crash if called from a program,
                      (    DragonMMC.asm):00021         ;               caused by stack being over-written. Fixed by effectively doing a
                      (    DragonMMC.asm):00022         ;                               clear 200,ramtop, to restore the machine to it's default power on 
                      (    DragonMMC.asm):00023         ;                               state.
                      (    DragonMMC.asm):00024         ;
                      (    DragonMMC.asm):00025         ; 2017-03-10,   Fixed a further bug with MTAPERUN caused by the fix to the stack 
                      (    DragonMMC.asm):00026         ;                               overwrite, where FlagonBird would crash on loading due to the 
                      (    DragonMMC.asm):00027         ;                               return address from MTAPERUN being destroyed by the clear above.
                      (    DragonMMC.asm):00028         ;                               we now save and restore the return address so that on exit MTAPERUN
                      (    DragonMMC.asm):00029         ;                               returns to the BASIC loop where it left off!
                      (    DragonMMC.asm):00030         ;                               MTAPERUN now also tries to validate that the EXEC address is within
                      (    DragonMMC.asm):00031         ;                               the area of memory loaded and only calls it if this is true.
                      (    DragonMMC.asm):00032         ;                               Implemented CFTypeE and CFTypeL to retrieve the EXEC and Load addresses
                      (    DragonMMC.asm):00033         ;                               of the next tape file.
                      (    DragonMMC.asm):00034         ; 
                      (    DragonMMC.asm):00035         ; 2017-03-10,   Note to self, calling a routine that does hardware IO with the wrong
                      (    DragonMMC.asm):00036         ;                               register contents leads to a crash!
                      (    DragonMMC.asm):00037         ;
                      (    DragonMMC.asm):00038         ; 2017-03-14,   Patched so that Basic programs will auto run when loaded, the CLOAD
                      (    DragonMMC.asm):00039         ;                               command never returns and jumps directly into the basic main interpreter
                      (    DragonMMC.asm):00040         ;                               loop. So we patch it in two ways, for tokenized programs we patch the RAM
                      (    DragonMMC.asm):00041         ;                               copy of the ROM to call a routine in the MMC rom to tidy up and run the 
                      (    DragonMMC.asm):00042         ;                               program. For ASCII programs we hook the "finish loading ASCII program" vector
                      (    DragonMMC.asm):00043         ;                               and cause it to run the program.
                      (    DragonMMC.asm):00044         ;
                      (    DragonMMC.asm):00045         ; 2017-03-20,   Moved SAM bits saving into CPLD as AVR could not give quick enough response
                      (    DragonMMC.asm):00046         ;               time and was therefore dropping bits.
                      (    DragonMMC.asm):00047         ;               Implemented NMI handler with menu that handles cold / warm re-booting and
                      (    DragonMMC.asm):00048         ;               Memory snapshots.
                      (    DragonMMC.asm):00049         ; 
                      (    DragonMMC.asm):00050         ; 2017-04-03,   Fixed BASIC program auto load / run bug that was borking PImania, caused by
                      (    DragonMMC.asm):00051         ;                               the wrong basic vector being patched leading to it being called in a recursive
                      (    DragonMMC.asm):00052         ;                               loop and overwriting the RAM by blowing the stack up :(
                      (    DragonMMC.asm):00053         ;                               Implemented conditianally assembled code that allows MCAS and auto-running basic 
                      (    DragonMMC.asm):00054         ;                               to be emulated in MESS, to help fix above.
                      (    DragonMMC.asm):00055         ;
                      (    DragonMMC.asm):00056         ; 2017-07-29    Implemented MMIRROR and MMIRRORA commands for capturing tape input to a cas file
                      (    DragonMMC.asm):00057         ;                               stored on the card.
                      (    DragonMMC.asm):00058         ;
                      (    DragonMMC.asm):00059         ; 2017-08-02    Removed array address function as will not be needed now that the AVR sorts files.
                      (    DragonMMC.asm):00060         ;                               Removal of dead code, streamlining prior to first full release.
                      (    DragonMMC.asm):00061         ;
                      (    DragonMMC.asm):00062         ; 2017-09-08    Forked to V1.00 for release.
                      (    DragonMMC.asm):00063         ;
                      (    DragonMMC.asm):00064         ; 2017-09-11    Began work on V1.10.
                      (    DragonMMC.asm):00065         ;                               Implemented MSETCFGS and MSETCFGC to set and clear the bits specified in the 
                      (    DragonMMC.asm):00066         ;                               config byte. So something like MSETCFGS $80,0 will set bit 7 of the system config 
                      (    DragonMMC.asm):00067         ;                               but leave bits 6..0 unchanged. Basically 'S' is OR cfgbyte and 'C' is AND NOT cfgbyte.
                      (    DragonMMC.asm):00068         ;
                      (    DragonMMC.asm):00069         ;
                      (    DragonMMC.asm):00070         ; 2017-10-08    Beta test release of 1.10.
                      (    DragonMMC.asm):00071         ;               Changes :
                      (    DragonMMC.asm):00072         ;                   
                      (    DragonMMC.asm):00073         ;                   Added MSETCFGs MSETCFGc to set and clear individual bits in config. 
                      (    DragonMMC.asm):00074         ;                   Added MLOADc to clear back to power on state and then do an MLOADa
                      (    DragonMMC.asm):00075         ;
                      (    DragonMMC.asm):00076         ;                   AVR firmware 2.70 now makes a bak file if an attempt to create an
                      (    DragonMMC.asm):00077         ;                   already existing file is made, instead of generating an error.
                      (    DragonMMC.asm):00078         ;
                      (    DragonMMC.asm):00079         ;                   Partially Re-written Dragon / RS dos emulation code to pass head and
                      (    DragonMMC.asm):00080         ;                   sector to AVR code, this allows us to create disk images.
                      (    DragonMMC.asm):00081         ;
                      (    DragonMMC.asm):00082         ;                   Before loading AUTOEXEC.DGN / .CCO the firmware now prints an autoboot 
                      (    DragonMMC.asm):00083         ;                   message and waits for 1 second before booting. Pressing space during the
                      (    DragonMMC.asm):00084         ;                   wait will abort the auto boot.
                      (    DragonMMC.asm):00085         ;
                      (    DragonMMC.asm):00086         ; 2024-10-02    Made changes to port to running on the Raspbery Pi Pico 2, these included:
                      (    DragonMMC.asm):00087         ;                                       Merging the read and write data register into one.
                      (    DragonMMC.asm):00088         ;                                       Adding a one byte latch read register for single byte results which
                      (    DragonMMC.asm):00089         ;                                       saves having to send the read_data command to get the result.
                      (    DragonMMC.asm):00090         ;                                       Removed RAM control register and replaced it with commands to get and
                      (    DragonMMC.asm):00091         ;                                       set it.
                      (    DragonMMC.asm):00092         ;                                       Removed PIA replacement and tape emulation code as no longer required.
                      (    DragonMMC.asm):00093         ;
                      (    DragonMMC.asm):00094         ; 2024-11-07    All commands now return a result, in result register.
                      (    DragonMMC.asm):00095         ;                                       Busy flag changed to bit 7 so we can use a simple tst/bmi loop.
                      (    DragonMMC.asm):00096         ;
                      (    DragonMMC.asm):00097         ;       
                      (    DragonMMC.asm):00098         
                      (    DragonMMC.asm):00099         ; These are defined by the makefile
                      (    DragonMMC.asm):00100         ;
                      (    DragonMMC.asm):00101         ;DragonDos              EQU             1       ; Define this if compiling for Standard DragonDos Cart.
                      (    DragonMMC.asm):00102         ;DragonAlpha    EQU             1       ; Define this if compiling for Dragon Alpha.
                      (    DragonMMC.asm):00103         ;RSDos                  EQU             1       ; Define this if compiling for the RS-DOS cart.
                      (    DragonMMC.asm):00104         
                      (    DragonMMC.asm):00105         ; Set to > 0 to enable debugging 
     0000             (    DragonMMC.asm):00106         DEBUG           EQU         0
                      (    DragonMMC.asm):00107         
                      (    DragonMMC.asm):00108         #Set to 1 for development version, mainly just affects signon message :)
     0001             (    DragonMMC.asm):00109         DEVEL           EQU             1
                      (    DragonMMC.asm):00110         
                      (    DragonMMC.asm):00111                                 use             cpudefs.asm
                      (      cpudefs.asm):00001         ;
                      (      cpudefs.asm):00002         ; CPUDEFS
                      (      cpudefs.asm):00003         ;
                      (      cpudefs.asm):00004         
                      (      cpudefs.asm):00005         ; bitmasks for flags
     0001             (      cpudefs.asm):00006         FlagCarry               equ             $01
     0002             (      cpudefs.asm):00007         FlagOverflow    equ             $02
     0004             (      cpudefs.asm):00008         FlagZero                equ             $04
     0008             (      cpudefs.asm):00009         FlagNegative    equ             $08
     0010             (      cpudefs.asm):00010         FlagIRQ                 equ             $10
     0020             (      cpudefs.asm):00011         FlagHlafCarry   equ             $20
     0040             (      cpudefs.asm):00012         FlagFIRQ                equ             $40
     0080             (      cpudefs.asm):00013         FlagEntire              equ             $80
                      (      cpudefs.asm):00014         
     FFF2             (      cpudefs.asm):00015         HWVecBase               equ             $FFF2
     FFF2             (      cpudefs.asm):00016         HWVecSWI3               equ             $FFF2
     FFF4             (      cpudefs.asm):00017         HWVecSWI2               equ             $FFF4
     FFF6             (      cpudefs.asm):00018         HWVecFIRQ               equ             $FFF6
     FFF8             (      cpudefs.asm):00019         HWVecIRQ                equ             $FFF8
     FFFA             (      cpudefs.asm):00020         HWVecSWI                equ             $FFFA
     FFFC             (      cpudefs.asm):00021         HWVecNMI                equ             $FFFC
     FFFE             (      cpudefs.asm):00022         HWVecReset              equ             $FFFE
                      (      cpudefs.asm):00023         
     0007             (      cpudefs.asm):00024         HWVecCount              equ             $7
                      (      cpudefs.asm):00025         
                      (      cpudefs.asm):00026         
                      (      cpudefs.asm):00027         
                      (      cpudefs.asm):00028         
                      (    DragonMMC.asm):00112                                 use             dgndefs.asm
                      (      dgndefs.asm):00001         *
                      (      dgndefs.asm):00002         * Deinitions for ports on Dragon 32/64/Alpha.
                      (      dgndefs.asm):00003         *
                      (      dgndefs.asm):00004         * 2004-11-16. P.Harvey-Smith.
                      (      dgndefs.asm):00005         *       Fixed the stupid error I made in the defines below
                      (      dgndefs.asm):00006         *       that made all the non DPxxxxx defines equal to FF00 !!!
                      (      dgndefs.asm):00007         *
                      (      dgndefs.asm):00008         * 2004-10-10. P.Harvey-Smith.
                      (      dgndefs.asm):00009         *       Tidyed up a little, moved romdefs into their own file.
                      (      dgndefs.asm):00010         *
                      (      dgndefs.asm):00011         * 2017-03-17.  P.Harvey-Smith.
                      (      dgndefs.asm):00012         *   Changed tabs to be 4 characters.
                      (      dgndefs.asm):00013         
                      (      dgndefs.asm):00014         ;TextScreenBase  equ $0400               ; Default text screen base
     0600             (      dgndefs.asm):00015         GraphScreenBase equ $0600               ; Default Graphics screen base
                      (      dgndefs.asm):00016         
     0020             (      dgndefs.asm):00017         TextLineLen equ     32                  ; 32 characters / line
                      (      dgndefs.asm):00018         
                      (      dgndefs.asm):00019         
     FF00             (      dgndefs.asm):00020         IO                  equ         $ff00               ; IO page on Dragon
                      (      dgndefs.asm):00021         
                      (      dgndefs.asm):00022         *
                      (      dgndefs.asm):00023         * Most of these symbols will be defined twice, as some 
                      (      dgndefs.asm):00024         * of the Dragon code, sets DP=$FF, and uses direct page
                      (      dgndefs.asm):00025         * addressing to access the io ports, whilst some of it
                      (      dgndefs.asm):00026         * uses absolute addressing.
                      (      dgndefs.asm):00027         * The versions starting DP must be used with DP=$FF.
                      (      dgndefs.asm):00028         *
                      (      dgndefs.asm):00029         
     0004             (      dgndefs.asm):00030         PIACRDDR    equ     $04                 ; Select DDR or Data reg
                      (      dgndefs.asm):00031         
                      (      dgndefs.asm):00032         *Pia 0 and 1 standard on all Dragons.
                      (      dgndefs.asm):00033         
     0000             (      dgndefs.asm):00034         DPPIA0DA        EQU             $00                         ; Side A Data/DDR
     0001             (      dgndefs.asm):00035         DPPIA0CRA       EQU             $01                         ; Side A Control.
     0002             (      dgndefs.asm):00036         DPPIA0DB        EQU             $02                         ; Side B Data/DDR
     0003             (      dgndefs.asm):00037         DPPIA0CRB       EQU             $03                         ; Side B Control.
                      (      dgndefs.asm):00038         
     FF00             (      dgndefs.asm):00039         PIA0DA          EQU             DPPIA0DA+IO             ; Side A Data/DDR
     FF01             (      dgndefs.asm):00040         PIA0CRA         EQU             DPPIA0CRA+IO        ; Side A Control.
     FF02             (      dgndefs.asm):00041         PIA0DB          EQU             DPPIA0DB+IO             ; Side A Data/DDR
     FF03             (      dgndefs.asm):00042         PIA0CRB         EQU             DPPIA0CRB+IO        ; Side A Control.
                      (      dgndefs.asm):00043         
     0020             (      dgndefs.asm):00044         DPPIA1DA        EQU             $20                         ; Side A Data/DDR
     0021             (      dgndefs.asm):00045         DPPIA1CRA       EQU             $21                         ; Side A Control.
     0022             (      dgndefs.asm):00046         DPPIA1DB        EQU             $22                         ; Side B Data/DDR
     0023             (      dgndefs.asm):00047         DPPIA1CRB       EQU             $23                         ; Side B Control.
                      (      dgndefs.asm):00048         
     FF20             (      dgndefs.asm):00049         PIA1DA          EQU             DPPIA1DA+IO             ; Side A Data/DDR
     FF21             (      dgndefs.asm):00050         PIA1CRA         EQU             DPPIA1CRA+IO        ; Side A Control.
     FF22             (      dgndefs.asm):00051         PIA1DB          EQU             DPPIA1DB+IO             ; Side A Data/DDR
     FF23             (      dgndefs.asm):00052         PIA1CRB         EQU             DPPIA1CRB+IO        ; Side A Control.
                      (      dgndefs.asm):00053         
                      (      dgndefs.asm):00054         * Dragon Alpha has a third PIA at FF24.
                      (      dgndefs.asm):00055         
     0024             (      dgndefs.asm):00056         DPPIA2DA        EQU             $24                         ; Side A Data/DDR
     0025             (      dgndefs.asm):00057         DPPIA2CRA       EQU             $25                         ; Side A Control.
     0026             (      dgndefs.asm):00058         DPPIA2DB        EQU             $26                         ; Side B Data/DDR
     0027             (      dgndefs.asm):00059         DPPIA2CRB       EQU             $27                         ; Side B Control.
                      (      dgndefs.asm):00060         
     FF24             (      dgndefs.asm):00061         PIA2DA          EQU             DPPIA2DA+IO             ; Side A Data/DDR
     FF25             (      dgndefs.asm):00062         PIA2CRA         EQU             DPPIA2CRA+IO        ; Side A Control.
     FF26             (      dgndefs.asm):00063         PIA2DB          EQU             DPPIA2DB+IO             ; Side A Data/DDR
     FF27             (      dgndefs.asm):00064         PIA2CRB         EQU             DPPIA2CRB+IO        ; Side A Control.
                      (      dgndefs.asm):00065         
                      (      dgndefs.asm):00066         ;WD2797 Floppy disk controler, used in Alpha Note registers in reverse order !
     002F             (      dgndefs.asm):00067         DPCmdRegA       EQU             $2F                         ; command/status                    
     002E             (      dgndefs.asm):00068         DPTrkRegA       EQU             $2E                         ; Track register
     002D             (      dgndefs.asm):00069         DPSecRegA       EQU             $2D                         ; Sector register
     002C             (      dgndefs.asm):00070         DPDataRegA      EQU             $2C                         ; Data register
                      (      dgndefs.asm):00071         
     ????             (      dgndefs.asm):00072         CmdRegA         EQU             DPCMDREGA+IO        ; command/status                    
     ????             (      dgndefs.asm):00073         TrkRegA         EQU             DPTRKREGA+IO        ; Track register
     ????             (      dgndefs.asm):00074         SecRegA         EQU             DPSECREGA+IO        ; Sector register
     ????             (      dgndefs.asm):00075         DataRegA        EQU             DPDATAREGA+IO       ; Data register
                      (      dgndefs.asm):00076         
                      (      dgndefs.asm):00077         ; Constants for Alpha AY-8912 sound chip, which is used to control
                      (      dgndefs.asm):00078         ; Drive select and motor on the Alpha
                      (      dgndefs.asm):00079         
     000E             (      dgndefs.asm):00080         AYIOREG         EQU             $0E                         ; AY-8912, IO Register number.
     0000             (      dgndefs.asm):00081         AYIdle          EQU             $00                         ; Make AY Idle.
     0001             (      dgndefs.asm):00082         AYWriteReg      EQU             $01                         ; Write AY Register
     0002             (      dgndefs.asm):00083         AYReadReg       EQU             $02                         ; Read AY Register
     0003             (      dgndefs.asm):00084         AYREGLatch      EQU             $03                         ; Latch register into AY
                      (      dgndefs.asm):00085         
     0003             (      dgndefs.asm):00086         DSMask          EQU             $03                         ; Drive select mask.
     0004             (      dgndefs.asm):00087         MotorMask       EQU             $04                         ; Motor enable mask
     0008             (      dgndefs.asm):00088         DDENMask        EQU             $08                         ; DDEN Mask
     0010             (      dgndefs.asm):00089         ENPMask         EQU             $10                         ; Enable Precomp mask
     0020             (      dgndefs.asm):00090         NMIMask         EQU             $20                         ; NMI enable Mask
                      (      dgndefs.asm):00091         
                      (      dgndefs.asm):00092         ; Dragon 64/Alpha Serial port.
     0004             (      dgndefs.asm):00093         DPAciaData      EQU             $04                         ; Acia Rx/Tx Register
     0005             (      dgndefs.asm):00094         DPAciaStat      EQU             $05                         ; Acia status register
     0006             (      dgndefs.asm):00095         DPAciaCmd       EQU             $06                         ; Acia command register
     0007             (      dgndefs.asm):00096         DPAciaCtrl      EQU             $07                         ; Acia control register
                      (      dgndefs.asm):00097         
     FF04             (      dgndefs.asm):00098         AciaData        EQU             DPAciaData+IO       ; Acia Rx/Tx Register
     FF05             (      dgndefs.asm):00099         AciaStat        EQU             DPAciaStat+IO       ; Acia status register
     FF06             (      dgndefs.asm):00100         AciaCmd         EQU             DPAciaCmd+IO        ; Acia command register
     FF07             (      dgndefs.asm):00101         AciaCtrl        EQU             DPAciaCtrl+IO       ; Acia control register
                      (      dgndefs.asm):00102         
                      (      dgndefs.asm):00103         ; Dragon Alpha Modem port (6850)
                      (      dgndefs.asm):00104         
     0028             (      dgndefs.asm):00105         DPModemCtrl     EQU             $28                         ; Modem Control/Status
     0029             (      dgndefs.asm):00106         DPModemData     EQU             $29                         ; Modem Rx/Tx Data
                      (      dgndefs.asm):00107         
     FF28             (      dgndefs.asm):00108         ModemCtrl       EQU             DPModemCtrl+IO      ; Modem Control/Status
     FF29             (      dgndefs.asm):00109         ModemData       EQU             DPModemData+IO      ; Modem Rx/Tx Data
                      (      dgndefs.asm):00110         
                      (      dgndefs.asm):00111         ;DragonDos Cartrage IO for WD2797
                      (      dgndefs.asm):00112         
                      (      dgndefs.asm):00113         ;WD2797 Floppy disk controler, used in DragonDos.
     0040             (      dgndefs.asm):00114         DPCmdRegD       EQU             $40                         ; command/status                    
     0041             (      dgndefs.asm):00115         DPTrkRegD       EQU             $41                         ; Track register
     0042             (      dgndefs.asm):00116         DPSecRegD       EQU             $42                         ; Sector register
     0043             (      dgndefs.asm):00117         DPDataRegD      EQU             $43                         ; Data register
                      (      dgndefs.asm):00118         
     ????             (      dgndefs.asm):00119         CmdRegD         EQU             DPCMDREGD+IO        ; command/status    4               
     ????             (      dgndefs.asm):00120         TrkRegD         EQU             DPTRKREGD+IO        ; Track register
     ????             (      dgndefs.asm):00121         SecRegD         EQU             DPSECREGD+IO        ; Sector register
     ????             (      dgndefs.asm):00122         DataRegD        EQU             DPDATAREGD+IO       ; Data register
                      (      dgndefs.asm):00123         
     0048             (      dgndefs.asm):00124         DPDSKCTLD       EQU             $48                         ; Disk DS/motor control reg
     FF48             (      dgndefs.asm):00125         DSKCTLD         EQU             DPDSKCTLD+IO            
                      (      dgndefs.asm):00126         
                      (      dgndefs.asm):00127         ; Disk IO bitmasks (DragonDos).
                      (      dgndefs.asm):00128         
     0020             (      dgndefs.asm):00129         NMIEnD          EQU             %00100000 
     0010             (      dgndefs.asm):00130         WPCEnD          EQU     %00010000 
     0008             (      dgndefs.asm):00131         SDensEnD        EQU     %00001000 
     0004             (      dgndefs.asm):00132         MotorOnD        EQU     %00000100 
     0000             (      dgndefs.asm):00133         Drive0D         EQU             %00000000
     0001             (      dgndefs.asm):00134         Drive1D         EQU             %00000001
     0002             (      dgndefs.asm):00135         Drive2D         EQU             %00000010
     0003             (      dgndefs.asm):00136         Drive3D         EQU             %00000011
     0003             (      dgndefs.asm):00137         DriveMaskD      EQU             %00000011               ; Mask to extract drives
                      (      dgndefs.asm):00138         
                      (      dgndefs.asm):00139         ; Disk IO bitmasks (Dragon Alpha).
                      (      dgndefs.asm):00140         
                      (      dgndefs.asm):00141         ;NMIEnA         EQU             %10000000               ; This is just a guess, but in current code just used as a flag 
     0080             (      dgndefs.asm):00142         Drive5or8       EQU             %10000000               ; is drive in 5" or 8" mode Acording to circuit trace on R.Harding's machine
     0040             (      dgndefs.asm):00143         WPCEnA          EQU             %01000000               ; Acording to circuit trace by R.Harding.
     0020             (      dgndefs.asm):00144         SDensEnA        EQU             %00100000               ; DDen Acording to circuit trace on R.Harding's machine
     0010             (      dgndefs.asm):00145         MotorOnA        EQU             %00010000       
     0001             (      dgndefs.asm):00146         Drive0A         EQU             %00000001               ; Drive selects acording to OS9 headers
     0002             (      dgndefs.asm):00147         Drive1A         EQU             %00000010
     0004             (      dgndefs.asm):00148         Drive2A         EQU             %00000100
     0008             (      dgndefs.asm):00149         Drive3A         EQU             %00001000
     000F             (      dgndefs.asm):00150         DriveMaskA      EQU             %00001111               ; Mask to extract drives
                      (      dgndefs.asm):00151         
                      (      dgndefs.asm):00152         ; On the Alpha, NMI is enabled/disabled by setting CA2 of the third PIA, High=enabled.
                      (      dgndefs.asm):00153         
                      (      dgndefs.asm):00154         ;WD1793/1772 Floppy disk controler, used in RS-DOS.
     0048             (      dgndefs.asm):00155         DPCmdRegT       EQU             $48                         ; command/status                    
     0049             (      dgndefs.asm):00156         DPTrkRegT       EQU             $49                         ; Track register
     004A             (      dgndefs.asm):00157         DPSecRegT       EQU             $4A                         ; Sector register
     004B             (      dgndefs.asm):00158         DPDataRegT      EQU             $4B                         ; Data registerT
                      (      dgndefs.asm):00159         
     ????             (      dgndefs.asm):00160         CmdRegT         EQU             DPCMDREGT+IO        ; command/status    4               
     ????             (      dgndefs.asm):00161         TrkRegT         EQU             DPTRKREGT+IO        ; Track register
     ????             (      dgndefs.asm):00162         SecRegT         EQU             DPSECREGT+IO        ; Sector register
     ????             (      dgndefs.asm):00163         DataRegT        EQU             DPDATAREGT+IO       ; Data register
                      (      dgndefs.asm):00164         
     0040             (      dgndefs.asm):00165         DPDSKCTLT       EQU             $40                         ; Disk DS/motor control reg
     FF40             (      dgndefs.asm):00166         DSKCTLT         EQU             DPDSKCTLT+IO            
                      (      dgndefs.asm):00167         
                      (      dgndefs.asm):00168         ; Disk IO bitmasks (RSDos FD-500).
                      (      dgndefs.asm):00169         
     0080             (      dgndefs.asm):00170         HaltEn          EQU             %10000000               ; Halt enable
     0040             (      dgndefs.asm):00171         SS0             EQU             %01000000               ; Side select
     0020             (      dgndefs.asm):00172         SDensEnT        EQU             %00100000               ; Double density enable 
     0020             (      dgndefs.asm):00173         NMIEnT          EQU             %00100000               ; Enable NMI, always enabled when in DD mode
     0010             (      dgndefs.asm):00174         WPCEnT          EQU             %00010000       
     0008             (      dgndefs.asm):00175         MotorOnT        EQU             %00001000               ; Drive selects only 3
     0001             (      dgndefs.asm):00176         Drive0T         EQU             %00000001
     0002             (      dgndefs.asm):00177         Drive1T         EQU             %00000010
     0004             (      dgndefs.asm):00178         Drive2T         EQU             %00000100
     0004             (      dgndefs.asm):00179         Drive3T         EQU             %00000100               ; Drive 3 same as drive 2 !
     0007             (      dgndefs.asm):00180         DriveMaskT      EQU             %00000111               ; Mask to extract drives
     000F             (      dgndefs.asm):00181         DriveOffMaskT EQU       MotorOnT+DriveMaskT     
                      (    DragonMMC.asm):00113                                 use             dosdefs.asm
                      (      dosdefs.asm):00001         ;
                      (      dosdefs.asm):00002         ; DragonDos,  Copyright (C) 1983,1984 Dragon Data Ltd.
                      (      dosdefs.asm):00003         ;
                      (      dosdefs.asm):00004         ; Disassembled 2004-11-05, P.Harvey-Smith.
                      (      dosdefs.asm):00005         ;
                      (      dosdefs.asm):00006         ; 2005-10-10, forked ram vars into seperate include file.
                      (      dosdefs.asm):00007         ;
                      (      dosdefs.asm):00008                         
     0010             (      dosdefs.asm):00009         TrackPrecomp    EQU     $10             ; Track to enable precomp if greater
                      (      dosdefs.asm):00010         
     0012             (      dosdefs.asm):00011         SectorsPerTrack EQU     $12             ; Sectors per track
     0028             (      dosdefs.asm):00012         FmtDefTracks    EQU     $28             ; Default tracks for format
     0050             (      dosdefs.asm):00013         FmtDefTracksA   EQU     $50             ; Dragon Alpha default tracks for format
     0001             (      dosdefs.asm):00014         FmtDefSides     EQU     $01
                      (      dosdefs.asm):00015         
     0004             (      dosdefs.asm):00016         MaxDriveNo      EQU     $04             ; Maximum valid drive no
     000E             (      dosdefs.asm):00017         MaxFilenameLen  EQU     $0E             ; Max filename length, DriveNo:Filename.EXT
     004F             (      dosdefs.asm):00018         MaxTrack        EQU     $4F             ; Maximum track no (80)
                      (      dosdefs.asm):00019         
                      (      dosdefs.asm):00020         ;
                      (      dosdefs.asm):00021         ; Boot command related.
                      (      dosdefs.asm):00022         ;
                      (      dosdefs.asm):00023         
     0003             (      dosdefs.asm):00024         BootFirstSector EQU     $03             ; Boot sector is track 0 sector 3
     0012             (      dosdefs.asm):00025         BootLastSector  EQU     $12             ; Last sector of boot
     4F53             (      dosdefs.asm):00026         BootSignature   EQU     $4F53           ; Boot signature 'OS'
     2600             (      dosdefs.asm):00027         BootLoadAddr    EQU     $2600           ; Boot area load address.
     2602             (      dosdefs.asm):00028         BootEntryAddr   EQU     $2602           ; Boot entry address
                      (      dosdefs.asm):00029         
                      (      dosdefs.asm):00030         ;
                      (      dosdefs.asm):00031         ; Dir track related
                      (      dosdefs.asm):00032         ;
                      (      dosdefs.asm):00033         
     0014             (      dosdefs.asm):00034         DirPrimary      EQU     $14             ; Primary dir track is track 20
     0010             (      dosdefs.asm):00035         DirBackup       EQU     $10             ; Backup on track 16
                      (      dosdefs.asm):00036         
                      (      dosdefs.asm):00037         ;
                      (      dosdefs.asm):00038         ; DOS Low memory variables
                      (      dosdefs.asm):00039         ;
                      (      dosdefs.asm):00040         
     00FF             (      dosdefs.asm):00041         AutoFlag        EQU     $FF             ; Auto re-number flag, if $613=this then auto enter basic lines
                      (      dosdefs.asm):00042         
     00EA             (      dosdefs.asm):00043         DosCommand      EQU     $00EA           ; Dos function no to execute
     00EB             (      dosdefs.asm):00044         DosDriveNo      EQU     $00EB           ; Last active drive number
     00EC             (      dosdefs.asm):00045         DskTrackNo      EQU     $00EC           ; Disk track no
     00ED             (      dosdefs.asm):00046         DskSectorNo     EQU     $00ED           ; Disk sectror no
     00EE             (      dosdefs.asm):00047         DiskBuffPtr     EQU     $00EE           ; Disk buffer pointer
     00F0             (      dosdefs.asm):00048         DosDiskError    EQU     $00F0           ; Disk error status byte
     00F1             (      dosdefs.asm):00049         DosCurrCtrlBlk  EQU     $00F1           ; Current file control block (FIB) (0..9) $FF=no files open
     00F2             (      dosdefs.asm):00050         DosBytesInDTA   EQU     $00F2           ; Number of bytes in DTA (also used for tracks in DSKINIT).
     00F2             (      dosdefs.asm):00051         DosDSKINITraks  EQU     $00F2           
     00F3             (      dosdefs.asm):00052         DosNoBytesMove  EQU     $00F3           ; Number of bytes to transfer to/from buffer, also head during format
     00F3             (      dosdefs.asm):00053         DosDSKINIHead   EQU     $00F3           
     00F4             (      dosdefs.asm):00054         DosRecLenFlag   EQU     $00F4           ; Record length flag, 00 don'r care $FF=do care, also DS flag in format
     00F5             (      dosdefs.asm):00055         DosRWFlag       EQU     $00F5           ; Read write flag, $00=read, $01= write, $FF=verifying
     00F6             (      dosdefs.asm):00056         DosIOInProgress EQU     $00f6           ; I/O currently in progress flag 0x00 check for time out, Non-0x00 skip timeout check
     00F7             (      dosdefs.asm):00057         DosMakeSysDsk   EQU     $00f7           ; Make system disk during format, $00=no, $FF=yes
                      (      dosdefs.asm):00058         
     00F8             (      dosdefs.asm):00059         DosSectorSeek   EQU     $00F8           ; Sector currently seeking {SuperDos Rom}
                      (      dosdefs.asm):00060         
                      (      dosdefs.asm):00061         *************************************************************************
                      (      dosdefs.asm):00062         
     0600             (      dosdefs.asm):00063         DosAreaStart    EQU     $0600           ; Start of RAM used by DOS
     0600             (      dosdefs.asm):00064         Thrash          EQU     $0600           ; Work byte, yes that's what it's called in the DD sourcecode!
     0601             (      dosdefs.asm):00065         Temps1          EQU     $0601           ; Temp storage for registers #1
     0602             (      dosdefs.asm):00066         Temps2          EQU     $0602           ; Temp storage for registers #2
     0603             (      dosdefs.asm):00067         TempC           EQU     $0603           ; Temp for FREAD
     0604             (      dosdefs.asm):00068         TempL           EQU     $0604           ; Temp for FREAD
                      (      dosdefs.asm):00069         
     0603             (      dosdefs.asm):00070         DosErrorCode    EQU     $0603           ; Error code from DOS
     0605             (      dosdefs.asm):00071         DosTimeout      EQU     $0605           ; Timeout count, Motor timer
                      (      dosdefs.asm):00072                                                 ; timeout occurs when this location is decremented from 0x01 to 0x00,                   
     0606             (      dosdefs.asm):00073         DosHWMaskFF40   EQU     $0606           ; Hardware command byte mask for FF40 (disk option)
     0607             (      dosdefs.asm):00074         DosHWMaskFF48   EQU     $0607           ; hardware control mask for $ff48 (latch temp)
     0608             (      dosdefs.asm):00075         DosVerifyFlag   EQU     $0608           ; Verify flag, 00=no verify $FF=verify
     0609             (      dosdefs.asm):00076         DosErrorMask    EQU     $0609           ; Error mask, ANDed with error code from WD
     060A             (      dosdefs.asm):00077         DosDefDriveNo   EQU     $060A           ; Default drive number
     060B             (      dosdefs.asm):00078         DosFWriteBPtr   EQU     $060B           ; FWrite buffer pointer 
     060D             (      dosdefs.asm):00079         DosBuffStart    EQU     $060D           ; Buffer start
     060F             (      dosdefs.asm):00080         DosBuffEnd      EQU     $060F           ; Buffer end
     0611             (      dosdefs.asm):00081         DosRunLoadFlag  EQU     $0611           ; Run/load flag $00=LOAD
     0612             (      dosdefs.asm):00082         DosFlFreadFlag  EQU     $0612           ; Fread/FLread flag 00=fread, $FF=FLread
                      (      dosdefs.asm):00083         
                      (      dosdefs.asm):00084         *************************************************************************
                      (      dosdefs.asm):00085         
                      (      dosdefs.asm):00086         ; Auto flags share their locations with FWrite buffers as they cannot both be 
                      (      dosdefs.asm):00087         ; active together
     0613             (      dosdefs.asm):00088         DosAutoFlag     EQU     $0613           ; Auto flag, $FF=auto, $00=no auto
     060D             (      dosdefs.asm):00089         DosAutoCurrent  EQU     DosBuffStart    ; AUTO current line no
     060F             (      dosdefs.asm):00090         DosAutoInc      EQU     DosBuffEnd      ; AUTO line increment
                      (      dosdefs.asm):00091         
                      (      dosdefs.asm):00092         *************************************************************************
                      (      dosdefs.asm):00093         
                      (      dosdefs.asm):00094         ; variables for ON ERROR
     0614             (      dosdefs.asm):00095         DosErrGotoFlag  EQU     $0614           ; ERROR GOTO flag, 0x00 Off Non-0x00 On 
     0615             (      dosdefs.asm):00096         DosErrDestLine  EQU     $0615           ; Error destination line
     0617             (      dosdefs.asm):00097         DosErrLineNo    EQU     $0617           ; line no error occured in (ERR line no)
     0619             (      dosdefs.asm):00098         DosErrLast      EQU     $0619           ; Error that occured
     061A             (      dosdefs.asm):00099         DosErrPtr       EQU     $061A           ; pointer to the statement that caused the error
                      (      dosdefs.asm):00100         
                      (      dosdefs.asm):00101         *************************************************************************
                      (      dosdefs.asm):00102         
     061C             (      dosdefs.asm):00103         Drv0Details     EQU     $061C           ; Drive 0 details (6 bytes)
     0622             (      dosdefs.asm):00104         Drv1Details     EQU     $0622           ; Drive 1 details (6 bytes)
     0628             (      dosdefs.asm):00105         Drv2Details     EQU     $0628           ; Drive 2 details (6 bytes)
     062E             (      dosdefs.asm):00106         Drv3Details     EQU     $062E           ; Drive 3 details (6 bytes)
     0006             (      dosdefs.asm):00107         DrvDeatailLen   EQU     $06             ; Entries are 6 bytes long
                      (      dosdefs.asm):00108         
                      (      dosdefs.asm):00109         ; Offsets into drive details
     0000             (      dosdefs.asm):00110         DrvDetDirLSN    EQU     $00             ; LSN of directory
     0002             (      dosdefs.asm):00111         DrvDetFreeLen   EQU     $02             ; Free length
     0003             (      dosdefs.asm):00112         DrvDetFreeEPtr  EQU     $03             ; Free extent pointer (LSN)
     0005             (      dosdefs.asm):00113         DrvDetUseCnt    EQU     $05             ; Usage/open file count ?
                      (      dosdefs.asm):00114         
                      (      dosdefs.asm):00115         *************************************************************************
                      (      dosdefs.asm):00116         
     0004             (      dosdefs.asm):00117         BuffCount       EQU     $04             ; 4 disk buffers
     0007             (      dosdefs.asm):00118         BuffDetailSize  EQU     $07             ; Buffer detail entries ar 7 bytes long
                      (      dosdefs.asm):00119         
     0634             (      dosdefs.asm):00120         Buff1Details    EQU     $0634           ; Disk buffer 1 details
     063B             (      dosdefs.asm):00121         Buff2Details    EQU     $063B           ; Disk buffer 2 details
     0642             (      dosdefs.asm):00122         Buff3Details    EQU     $0642           ; Disk buffer 3 details
     0649             (      dosdefs.asm):00123         Buff4Details    EQU     $0649           ; Disk buffer 4 details
                      (      dosdefs.asm):00124         
                      (      dosdefs.asm):00125         
                      (      dosdefs.asm):00126         ; Disk buffer details offsets for above table
     0000             (      dosdefs.asm):00127         BuffLSN         EQU     $00             ; LSN number 
     0002             (      dosdefs.asm):00128         BuffFlag        EQU     $02             ; Flag, see below...
     0003             (      dosdefs.asm):00129         BuffDrive       EQU     $03             ; Drive no 1..4
     0004             (      dosdefs.asm):00130         BuffAge         EQU     $04             ; Age of buffer since last use, 1=oldest..4=youngest
     0005             (      dosdefs.asm):00131         BuffAddr        EQU     $05             ; Buffer address
                      (      dosdefs.asm):00132         
                      (      dosdefs.asm):00133         ;BuffFlag values
                      (      dosdefs.asm):00134         
     0000             (      dosdefs.asm):00135         BuffFree        EQU     $00             ; Disk buffer is free
     0001             (      dosdefs.asm):00136         BuffUnknown     EQU     $01             ; Valid, clean
     0055             (      dosdefs.asm):00137         BuffInUse       EQU     $55             ; Buffer in use** not documented in DDv2c source.
     00FE             (      dosdefs.asm):00138         BuffDirtyExpire EQU     $FE             ; Buffer has been modified, but not written to disk, grace period expired
     00FF             (      dosdefs.asm):00139         BuffDirty       EQU     $FF             ; Buffer has been modified, but not written to disk
                      (      dosdefs.asm):00140         
                      (      dosdefs.asm):00141         *************************************************************************
                      (      dosdefs.asm):00142         
     0650             (      dosdefs.asm):00143         DosCurDriveInfo EQU     $0650           ; Dos current drive info
     0650             (      dosdefs.asm):00144         DosCurFilename  EQU     $0650           ; Current filename
     0658             (      dosdefs.asm):00145         DosCurExtension EQU     $0658           ; Current extension, used in validation
                      (      dosdefs.asm):00146         
     065B             (      dosdefs.asm):00147         DosCurDriveNo   EQU     $065B           ; Current drive no
     065C             (      dosdefs.asm):00148         DosLSNCounter   EQU     $065C           ; LSN counter in directory search
     065E             (      dosdefs.asm):00149         DosSaveBuffAddr EQU     $065E           ; Save buffer address
                      (      dosdefs.asm):00150         
                      (      dosdefs.asm):00151         
     0660             (      dosdefs.asm):00152         DosCurCount     EQU     $0660           ; Current count, used in various places (extent found?)
                      (      dosdefs.asm):00153                                                 ; marked as "Temp1, extent found" in DDv2c source
     0661             (      dosdefs.asm):00154         DosBytesRead    EQU     $0661           ; Number of bytes to read in DosFRead
     0663             (      dosdefs.asm):00155         DosSecOffset    EQU     $0663           ; Offset within sector for DosFRead to start
     0664             (      dosdefs.asm):00156         DosFWriteAddr   EQU     $0664           ; Fwrite address
     0667             (      dosdefs.asm):00157         DosPageBufAddr  EQU     $0667           ; Page buffer address
     0669             (      dosdefs.asm):00158         DosCurrSector   EQU     $0669           ; Current sector (LSN?)
     066B             (      dosdefs.asm):00159         DosTotalSFound  EQU     $066B           ; Total sectors found
     066D             (      dosdefs.asm):00160         DosFSNToFind    EQU     $066D           ; FSN sought
     066F             (      dosdefs.asm):00161         DosCurLSN       EQU     $066F           ; Current LSN, of current DIR sector being processed
     0671             (      dosdefs.asm):00162         DosFWBufPtr     EQU     $0671           ; Pointer to buffer in FWrite
     0673             (      dosdefs.asm):00163         DosFWByteCount  EQU     $0673           ; Number of bytes to write in FWrite
     0675             (      dosdefs.asm):00164         DosFWFPoint     EQU     $0675           ; File pointer to write at in FWrite
                      (      dosdefs.asm):00165         
     0678             (      dosdefs.asm):00166         DosSaveFCB      EQU     $0678           ; Temparary FCB pointer used by DosCreateFile.
     067A             (      dosdefs.asm):00167         DosSaveExt      EQU     $067A           ; Temporary extension used during DosCreateFile
     067D             (      dosdefs.asm):00168         DosTempFCBNo    EQU     $067D           ; Temporary Fileno / FCB no storage used by DosCreateFile.
     067F             (      dosdefs.asm):00169         DosCurDirBuff   EQU     $067F           ; Pointer to the current Dir sector, Buffer def block
     0681             (      dosdefs.asm):00170         DosTempFileNo   EQU     $0681           ; Temp file no whilst opening file
     0682             (      dosdefs.asm):00171         DosCurFileNo    EQU     $0682           ; Current file number on disk, to get dir entry for
                      (      dosdefs.asm):00172         
     0683             (      dosdefs.asm):00173         DosNewUSRTable  EQU     $0683           ; New USR table, relocated from low ram
                      (      dosdefs.asm):00174         
                      (      dosdefs.asm):00175         ;Drive parameter tables, note these need to be in this order.
     0697             (      dosdefs.asm):00176         DosD0Online     EQU     $0697           ; Drive 0 online flag
     0698             (      dosdefs.asm):00177         DosD1Online     EQU     $0698           ; Drive 1 online flag
     0699             (      dosdefs.asm):00178         DosD2Online     EQU     $0699           ; Drive 2 online flag
     069A             (      dosdefs.asm):00179         DosD3Online     EQU     $069A           ; Drive 3 online flag
                      (      dosdefs.asm):00180         
     069B             (      dosdefs.asm):00181         DosD0Track      EQU     $069B           ; Drive 0 current track
     069C             (      dosdefs.asm):00182         DosD1Track      EQU     $069C           ; Drive 1 current track
     069D             (      dosdefs.asm):00183         DosD2Track      EQU     $069D           ; Drive 2 current track
     069E             (      dosdefs.asm):00184         DosD3Track      EQU     $069E           ; Drive 3 current track
                      (      dosdefs.asm):00185         
     067E             (      dosdefs.asm):00186         DosTemp2        EQU     $067E           ; Temp, used in FindEmptyDir, CmdFLRead.... 
     069F             (      dosdefs.asm):00187         DosLBASec       EQU     $069F           ; as step rates meaningless for disk image
                      (      dosdefs.asm):00188         
     069F             (      dosdefs.asm):00189         DosD0StepRate   EQU     $069F           ; Drive 0 step rate
     06A0             (      dosdefs.asm):00190         DosD1StepRate   EQU     $06A0           ; Drive 1 step rate
     06A1             (      dosdefs.asm):00191         DosD2StepRate   EQU     $06A1           ; Drive 2 step rate
     06A2             (      dosdefs.asm):00192         DosD3StepRate   EQU     $06A2           ; Drive 3 step rate
                      (      dosdefs.asm):00193         
     06A3             (      dosdefs.asm):00194         DosD0Tracks     EQU     $06A3           ; Tracks on disk in drive 0
     06A4             (      dosdefs.asm):00195         DosD1Tracks     EQU     $06A4           ; Tracks on disk in drive 1
     06A5             (      dosdefs.asm):00196         DosD2Tracks     EQU     $06A5           ; Tracks on disk in drive 2
     06A6             (      dosdefs.asm):00197         DosD3Tracks     EQU     $06A6           ; Tracks on disk in drive 3
                      (      dosdefs.asm):00198         
     06A7             (      dosdefs.asm):00199         DosD0SecTrack   EQU     $06A7           ; Sectors per track drive 0
     06A8             (      dosdefs.asm):00200         DosD1SecTrack   EQU     $06A8           ; Sectors per track drive 1
     06A9             (      dosdefs.asm):00201         DosD2SecTrack   EQU     $06A9           ; Sectors per track drive 2
     06AA             (      dosdefs.asm):00202         DosD3SecTrack   EQU     $06AA           ; Sectors per track drive 3
                      (      dosdefs.asm):00203         
                      (      dosdefs.asm):00204         ; Offsets of tables from Online table, this way we can point an index register
                      (      dosdefs.asm):00205         ; at the drive online byte and access the other tables with offset,IR
                      (      dosdefs.asm):00206         
     0004             (      dosdefs.asm):00207         DosTrackTblOfs  EQU     (DosD0Track-DosD0Online)
     0008             (      dosdefs.asm):00208         DosStepTblOfs   EQU     (DosD0StepRate-DosD0Online)
     000C             (      dosdefs.asm):00209         DosTracksTblOfs EQU     (DosD0Tracks-DosD0Online)
     0010             (      dosdefs.asm):00210         DosSecTrkTblOfs EQU     (DosD0SecTrack-DosD0Online)
                      (      dosdefs.asm):00211         
     06AB             (      dosdefs.asm):00212         DosDirSecStatus EQU     $06AB           ; Directory sector status $06ab-$06bc
                      (      dosdefs.asm):00213         
     06BD             (      dosdefs.asm):00214         DosFCB0Addr     EQU     $06BD           ; File Control Block 0 Address 
     06DC             (      dosdefs.asm):00215         DosFCB1Addr     EQU     $06DC           ; File Control Block 1 Address
     06FB             (      dosdefs.asm):00216         DosFCB2Addr     EQU     $06FB           ; File Control Block 2 Address 
     071A             (      dosdefs.asm):00217         DosFCB3Addr     EQU     $071A           ; File Control Block 3 Address 
     0739             (      dosdefs.asm):00218         DosFCB4Addr     EQU     $0739           ; File Control Block 4 Address 
     0758             (      dosdefs.asm):00219         DosFCB5Addr     EQU     $0758           ; File Control Block 5 Address 
     0777             (      dosdefs.asm):00220         DosFCB6Addr     EQU     $0777           ; File Control Block 6 Address 
     0796             (      dosdefs.asm):00221         DosFCB7Addr     EQU     $0796           ; File Control Block 7 Address 
     07B5             (      dosdefs.asm):00222         DosFCB8Addr     EQU     $07B5           ; File Control Block 8 Address 
     07D4             (      dosdefs.asm):00223         DosFCB9Addr     EQU     $07D4           ; File Control Block 9 Address 
     07F3             (      dosdefs.asm):00224         DosFCBEnd       EQU     $07F3           ; First byte beyond last FCB
                      (      dosdefs.asm):00225         
     0800             (      dosdefs.asm):00226         DosDiskBuffBase EQU     $0800           ; Base of Disk buffers
                      (      dosdefs.asm):00227         
     001F             (      dosdefs.asm):00228         DosFCBLength    EQU     $1F             ; 31 bytes per FCB
                      (      dosdefs.asm):00229         
     000A             (      dosdefs.asm):00230         DosNumFCBs      EQU     (DosFCBEnd-DosFCB0Addr)/DosFCBLength    ; number of FCBs
                      (      dosdefs.asm):00231         
                      (      dosdefs.asm):00232         ;
                      (      dosdefs.asm):00233         ; FCB structure is :
                      (      dosdefs.asm):00234         ;
                      (      dosdefs.asm):00235         ; FCB format :
                      (      dosdefs.asm):00236         ; Pos   Len     Use
                      (      dosdefs.asm):00237         ; $00   8       File name
                      (      dosdefs.asm):00238         ; $08   3       Extension
                      (      dosdefs.asm):00239         ; $0B   1       Drive no (1..4)
                      (      dosdefs.asm):00240         ; $0C   3       Next read byte (file pointer?)
                      (      dosdefs.asm):00241         ; $0F   1       Directory flags
                      (      dosdefs.asm):00242         ; $10   3       Length of file
                      (      dosdefs.asm):00243         ; $13   2       First sector number (FSN) of extent 1
                      (      dosdefs.asm):00244         ; $15   2       LSN of extent 1
                      (      dosdefs.asm):00245         ; $17   1       sextors in extent 1
                      (      dosdefs.asm):00246         ; $18   2       First sector number (FSN) of extent 1
                      (      dosdefs.asm):00247         ; $1A   2       LSN of extent 1
                      (      dosdefs.asm):00248         ; $1C   1       sectors in extent 1
                      (      dosdefs.asm):00249         ; $1D   1       Number of dir entry
                      (      dosdefs.asm):00250         ; $1E   1       Directory number of last entry
                      (      dosdefs.asm):00251         
     0000             (      dosdefs.asm):00252         FCBFileName     EQU     $00     ; Filename (zero padded)
     0008             (      dosdefs.asm):00253         FCBExtension    EQU     $08     ; Extension (zero padded)
     000B             (      dosdefs.asm):00254         FCBDrive        EQU     $0B     ; Drive no
     000C             (      dosdefs.asm):00255         FCBFilePointer  EQU     $0C     ; File Pointer 
     000F             (      dosdefs.asm):00256         FCBDirFlags     EQU     $0F     ; Dir flags (attributes)
     0010             (      dosdefs.asm):00257         FCBFileLen      EQU     $10     ; File Length
     0013             (      dosdefs.asm):00258         FCBFSNExtent1   EQU     $13     ; FSN of extent 1
     0015             (      dosdefs.asm):00259         FCBLSNExtent1   EQU     $15     ; LSN of extent 1 
     0017             (      dosdefs.asm):00260         FCBSecExtent1   EQU     $17     ; Sectors in extent 1
     0018             (      dosdefs.asm):00261         FCBFSNExtent2   EQU     $18     ; FSN of extent 2
     001A             (      dosdefs.asm):00262         FCBLSNExtent2   EQU     $1A     ; LSN of extent 2 
     001C             (      dosdefs.asm):00263         FCBSecExtent2   EQU     $1C     ; Sectors in extent 2
     001D             (      dosdefs.asm):00264         FCBDiskFileNo   EQU     $1D     ; File number on disk, (dir entry no).
     001E             (      dosdefs.asm):00265         FCBDirNoLast    EQU     $1E     ; Dir no of last entry
                      (      dosdefs.asm):00266         
                      (      dosdefs.asm):00267         ;
                      (      dosdefs.asm):00268         ; Backup command stack frame offsets
                      (      dosdefs.asm):00269         ;
                      (      dosdefs.asm):00270         ; These are offset from U on stack
                      (      dosdefs.asm):00271         ;
                      (      dosdefs.asm):00272         
     0000             (      dosdefs.asm):00273         BupSrcDrive     EQU     0       ; Drive number of source 
     0001             (      dosdefs.asm):00274         BupSrcTrk       EQU     1       ; Source track 
     0002             (      dosdefs.asm):00275         BupSrcSec       EQU     2       ; Source sector no
     0003             (      dosdefs.asm):00276         BupSrcMess      EQU     3       ; Insert source message ptr
     0005             (      dosdefs.asm):00277         BupSrcBuff      EQU     5       ; Source sector buffer addr 
     0007             (      dosdefs.asm):00278         BupDestDrive    EQU     7       ; Drive number of dest 
     0008             (      dosdefs.asm):00279         BupDestTrk      EQU     8       ; Dest track a
     0009             (      dosdefs.asm):00280         BupDestSec      EQU     9       ; Dest sector no
     000A             (      dosdefs.asm):00281         BupDestMess     EQU     10      ; Insert dest message ptr
     000C             (      dosdefs.asm):00282         BupDestBuff     EQU     12      ; Dest sector buffer addr 
     000E             (      dosdefs.asm):00283         BupSecTrk       EQU     14      ; Sector count per track to copy 
     000F             (      dosdefs.asm):00284         BupAvailPages   EQU     15      ; Pages available to buffer sectors
                      (      dosdefs.asm):00285         
                      (      dosdefs.asm):00286         ;
                      (      dosdefs.asm):00287         ; Offset from X, which will point to BupSrcDrive, or BupDestDrive
                      (      dosdefs.asm):00288         ; 
                      (      dosdefs.asm):00289         
     0000             (      dosdefs.asm):00290         BupDrive        EQU     0       ; Drive number  
     0001             (      dosdefs.asm):00291         BupTrk          EQU     1       ; track 
     0002             (      dosdefs.asm):00292         BupSec          EQU     2       ; sector
     0003             (      dosdefs.asm):00293         BupMess         EQU     3       ; backup message
     0005             (      dosdefs.asm):00294         BupBuff         EQU     5       ; Source sector buffer addr ?
                      (      dosdefs.asm):00295         
     0010             (      dosdefs.asm):00296         BupStackFrame   EQU     16      ; backup stack frame size
                      (      dosdefs.asm):00297         
     D800             (      dosdefs.asm):00298         SpinUpDelay     EQU     $D800   ; Value for timeout loop
                      (      dosdefs.asm):00299         
                      (      dosdefs.asm):00300         
                      (      dosdefs.asm):00301         ;
                      (      dosdefs.asm):00302         ; Sync dir stack frame offsets
                      (      dosdefs.asm):00303         ;
                      (      dosdefs.asm):00304         ; These are offset from U on stack
                      (      dosdefs.asm):00305         ;
                      (      dosdefs.asm):00306         
     0000             (      dosdefs.asm):00307         SyncDriveCount  EQU     0       ; drive counter, done by bitshift
     0001             (      dosdefs.asm):00308         SyncDrive       EQU     1       ; Drive we are syncing
     0002             (      dosdefs.asm):00309         SyncBufferNo    EQU     2       ; Current buffer no
     0003             (      dosdefs.asm):00310         SyncSecNo       EQU     3       ; Sector we are syncing
     0004             (      dosdefs.asm):00311         SyncSectors     EQU     4       ; 4 sector numbers in the disk buffers
                      (      dosdefs.asm):00312         
                      (      dosdefs.asm):00313         ;
                      (      dosdefs.asm):00314         ; Dos function codes used by hardware routine.
                      (      dosdefs.asm):00315         ; 
                      (      dosdefs.asm):00316         
     0000             (      dosdefs.asm):00317         DosFnRestore    EQU     $00     ; Restore to track 0
     0001             (      dosdefs.asm):00318         DosFnSeek       EQU     $01     ; Seek to a track
     0002             (      dosdefs.asm):00319         DosFnReadSec    EQU     $02     ; Read a sector
     0003             (      dosdefs.asm):00320         DosFnWriteSecV  EQU     $03     ; Write a sector with verify
     0004             (      dosdefs.asm):00321         DosFnWriteSecN  EQU     $04     ; Write a sector no verify
     0005             (      dosdefs.asm):00322         DosFnWriteTrack EQU     $05     ; Write (format) track
     0006             (      dosdefs.asm):00323         DosFnReadAddr   EQU     $06     ; Read address mark
     0007             (      dosdefs.asm):00324         DosFnReadSec2   EQU     $07     ; Read first two bytes of a sector
     0008             (      dosdefs.asm):00325         DosFnWriteDef   EQU     $08     ; Write defective sector
                      (      dosdefs.asm):00326         
                      (      dosdefs.asm):00327         *******************************************
                      (      dosdefs.asm):00328         ***** Directory Track realted defines *****
                      (      dosdefs.asm):00329         *******************************************
                      (      dosdefs.asm):00330         
                      (      dosdefs.asm):00331         ;
                      (      dosdefs.asm):00332         ; Dir entry format(s).
                      (      dosdefs.asm):00333         ;
                      (      dosdefs.asm):00334         ; Dragon/Super dos directory entries can take one of 2 formats, they can be either a
                      (      dosdefs.asm):00335         ; filename block, containing filename, attributes & 4 allocation entries, or they can
                      (      dosdefs.asm):00336         ; be a continuation block, containing just allocation entries. 
                      (      dosdefs.asm):00337         ; This is controled by the byte at offset $18, and the attributes.
                      (      dosdefs.asm):00338         ;
                      (      dosdefs.asm):00339         ; if AttrContinued = 0 then 
                      (      dosdefs.asm):00340         ;       the byte at offset $18, contains the number of number of bytes in the last sector (256 bytes = 0).
                      (      dosdefs.asm):00341         ;
                      (      dosdefs.asm):00342         ; if AttrContinued = 1 then 
                      (      dosdefs.asm):00343         ;       the byte at offset $18 controls the format of the entry :
                      (      dosdefs.asm):00344         ;               if 0 then 
                      (      dosdefs.asm):00345         ;                       Entry is a filename entry
                      (      dosdefs.asm):00346         ;               else
                      (      dosdefs.asm):00347         ;                       Entry is a continuation block.
                      (      dosdefs.asm):00348         
                      (      dosdefs.asm):00349         ; Filename block format 
                      (      dosdefs.asm):00350         
     0000             (      dosdefs.asm):00351         DirEntAttr      EQU     $00             ; Attributes (see below)
     0001             (      dosdefs.asm):00352         DirEntFilename  EQU     $01             ; Filename, zero padded
     0009             (      dosdefs.asm):00353         DirEntExtension EQU     $09             ; Extension, zero padded
     000C             (      dosdefs.asm):00354         DirEntFnBlock1  EQU     $0C             ; Allocation block #1
     000F             (      dosdefs.asm):00355         DirEntFnBlock2  EQU     $0F             ; Allocation block #2
     0012             (      dosdefs.asm):00356         DirEntFnBlock3  EQU     $12             ; Allocation block #3
     0015             (      dosdefs.asm):00357         DirEntFnBlock4  EQU     $15             ; Allocation block #4
     0018             (      dosdefs.asm):00358         DirEntFlag      EQU     $18             ; Filename/Continuation flag 0/nonzero
     0018             (      dosdefs.asm):00359         DirEntLastBytes EQU     $18             ; bytes in last sector
                      (      dosdefs.asm):00360         
     0019             (      dosdefs.asm):00361         DirEntryLen     EQU     $19             ; Length of Dir Entry.
     0004             (      dosdefs.asm):00362         DirEntExts      EQU     4               ; 4 allocatoion blocks in filename block
                      (      dosdefs.asm):00363         
                      (      dosdefs.asm):00364         ; Continuation block, DirEntAttr, and DirEntFlag, as above.
                      (      dosdefs.asm):00365         
     0001             (      dosdefs.asm):00366         DirEntCntBlock1 EQU     $01             ; Allocation block #1
     0004             (      dosdefs.asm):00367         DirEntCntBlock2 EQU     $04             ; Allocation block #2
     0007             (      dosdefs.asm):00368         DirEntCntBlock3 EQU     $07             ; Allocation block #3
     000A             (      dosdefs.asm):00369         DirEntCntBlock4 EQU     $0A             ; Allocation block #4
     000D             (      dosdefs.asm):00370         DirEntCntBlock5 EQU     $0D             ; Allocation block #5
     0010             (      dosdefs.asm):00371         DirEntCntBlock6 EQU     $10             ; Allocation block #6
     0013             (      dosdefs.asm):00372         DirEntCntBlock7 EQU     $13             ; Allocation block #7
                      (      dosdefs.asm):00373         
     0007             (      dosdefs.asm):00374         DirEntCntExts   EQU     7               ; 7 allocatoion blocks in continuation block
                      (      dosdefs.asm):00375         
     000A             (      dosdefs.asm):00376         DirBlksPerSec   EQU     $0A             ; Number of dir blocks per dir sector
                      (      dosdefs.asm):00377         
                      (      dosdefs.asm):00378         ;
                      (      dosdefs.asm):00379         ; Allocation block format.
                      (      dosdefs.asm):00380         ;
                      (      dosdefs.asm):00381         
     0000             (      dosdefs.asm):00382         AllocLSN        EQU     $00             ; Logical sector number of start of allocation
     0002             (      dosdefs.asm):00383         AllocCount      EQU     $02             ; Count of number of sectors allocated.
     0003             (      dosdefs.asm):00384         AllocEntrySize  EQU     $03             ; Size of allocation entry
                      (      dosdefs.asm):00385         
     0003             (      dosdefs.asm):00386         AllocLen        EQU     3               ; Allocation length
                      (      dosdefs.asm):00387         
                      (      dosdefs.asm):00388         ;
                      (      dosdefs.asm):00389         ; File Attributes
                      (      dosdefs.asm):00390         ;
                      (      dosdefs.asm):00391         
     0080             (      dosdefs.asm):00392         AttrDeleted     EQU     %10000000       ; Deleted, may be reused
     0020             (      dosdefs.asm):00393         AttrContinued   EQU     %00100000       ; Continuation entry, byte at $18 giver next entry no
     0008             (      dosdefs.asm):00394         AttrEndOfDir    EQU     %00001000       ; End of directory, no more entries need to be scanned
     0002             (      dosdefs.asm):00395         AttrWriteProt   EQU     %00000010       ; Write protect flag
     0001             (      dosdefs.asm):00396         AttrIsCont      EQU     %00000001       ; This is a continuation entry.
                      (      dosdefs.asm):00397         
     0089             (      dosdefs.asm):00398         AttrAtFormat    EQU     AttrDeleted+AttrEndOfDir+AttrIsCont     ; Attributes set in DSKINIT     
     0081             (      dosdefs.asm):00399         AttrAfterDel    EQU     AttrDeleted+AttrIsCont                  ; Attributes set by DosDeleteFile
                      (      dosdefs.asm):00400         
     000A             (      dosdefs.asm):00401         DirEntPerSec    EQU     $0A                             ; Directory entries per sector
     00FA             (      dosdefs.asm):00402         DirLastByte     EQU     (DirEntPerSec*DirEntryLen)      ; First byte beyond last dire entry in sector
                      (      dosdefs.asm):00403         
                      (      dosdefs.asm):00404         ;
                      (      dosdefs.asm):00405         ; Offsets in Sector 0 on Dir track
                      (      dosdefs.asm):00406         ;
                      (      dosdefs.asm):00407         
     0000             (      dosdefs.asm):00408         BitmapPart1     EQU     $00             ; Bitmap uses bytes $00..$FB on first sector
     00FC             (      dosdefs.asm):00409         DirTracks       EQU     $FC             ; Tracks on disk
     00FD             (      dosdefs.asm):00410         DirSecPerTrk    EQU     $FD             ; Sectors/track 18=Single sided, 36=Double sided
     00FE             (      dosdefs.asm):00411         DirTracks1s     EQU     $FE             ; complement of DirTracks (used to validate)
     00FF             (      dosdefs.asm):00412         DirSecPerTrk1s  EQU     $FF             ; Complement of DirSecPerTrk (used to validate)
                      (      dosdefs.asm):00413         
                      (      dosdefs.asm):00414         ;
                      (      dosdefs.asm):00415         ; DOS Error codes.
                      (      dosdefs.asm):00416         ;
                      (      dosdefs.asm):00417         
     0080             (      dosdefs.asm):00418         ErrNR   EQU     $80                     ; not ready
     0082             (      dosdefs.asm):00419         ErrSK   EQU     $82                     ; seek
     0084             (      dosdefs.asm):00420         ErrWP   EQU     $84                     ; write protect
     0086             (      dosdefs.asm):00421         ErrRT   EQU     $86                     ; record type
     0088             (      dosdefs.asm):00422         ErrRF   EQU     $88                     ; record not found
     008A             (      dosdefs.asm):00423         ErrCC   EQU     $8A                     ; CRC
     008C             (      dosdefs.asm):00424         ErrLD   EQU     $8C                     ; Lost data
     008E             (      dosdefs.asm):00425         ErrBT   EQU     $8E                     ; boot
     0090             (      dosdefs.asm):00426         ErrIV   EQU     $90                     ; invalid volume / directory
     0092             (      dosdefs.asm):00427         ErrFD   EQU     $92                     ; Full directory
     0094             (      dosdefs.asm):00428         ErrDF   EQU     $94                     ; Disk full
     0096             (      dosdefs.asm):00429         ErrFS   EQU     $96                     ; File spec
     0098             (      dosdefs.asm):00430         ErrPT   EQU     $98                     ; Protection
     009A             (      dosdefs.asm):00431         ErrPE   EQU     $9A                     ; (read) Past end 
     009C             (      dosdefs.asm):00432         ErrFF   EQU     $9C                     ; File not Found 
     009E             (      dosdefs.asm):00433         ErrFE   EQU     $9E                     ; File exists
     00A0             (      dosdefs.asm):00434         ErrNE   EQU     $A0                     ; (file does) Not Exist
     00A2             (      dosdefs.asm):00435         ErrTF   EQU     $A2                     ; Too many Files open
     00A4             (      dosdefs.asm):00436         ErrPR   EQU     $A4                     ; Parameter
     00A6             (      dosdefs.asm):00437         ErrUD   EQU     $A6                     ; Undefined
     00FF             (      dosdefs.asm):00438         ErrSFF  EQU     $FF                     ; ????
                      (      dosdefs.asm):00439         
                      (      dosdefs.asm):00440                 if 0
0000                  (      dosdefs.asm):00441         DDErrNR         EQU     $80             ; Not ready
0000                  (      dosdefs.asm):00442         DDErrSK         EQU     $82             ; seek
0000                  (      dosdefs.asm):00443         DDErrWP         EQU     $84             ; write protect
0000                  (      dosdefs.asm):00444         DDErrRT         EQU     $86             ; record type
0000                  (      dosdefs.asm):00445         DDErrRF         EQU     $88             ; record not found
0000                  (      dosdefs.asm):00446         DDErrCC         EQU     $8A             ; CRC
0000                  (      dosdefs.asm):00447         DDErrLD         EQU     $8C             ; Lost data
0000                  (      dosdefs.asm):00448         DDErrBT         EQU     $8E             ; boot
0000                  (      dosdefs.asm):00449         DDErrIV         EQU     $90             ; invalid volume / directory
0000                  (      dosdefs.asm):00450         DDErrFD         EQU     $92             ; Full directory
0000                  (      dosdefs.asm):00451         DDErrDF         EQU     $94             ; Disk full
0000                  (      dosdefs.asm):00452         DDErrFS         EQU     $96             ; File spec
0000                  (      dosdefs.asm):00453         DDErrPT         EQU     $98             ; Protection
0000                  (      dosdefs.asm):00454         DDErrPE         EQU     $9A             ; (read) Past end 
0000                  (      dosdefs.asm):00455         DDErrFF         EQU     $9C             ; File not Found 
0000                  (      dosdefs.asm):00456         DDErrFE         EQU     $9E             ; File exists
0000                  (      dosdefs.asm):00457         DDErrNE         EQU     $A0             ; (file does) Not Exist
0000                  (      dosdefs.asm):00458         DDErrTF         EQU     $A2             ; Too many Files open
0000                  (      dosdefs.asm):00459         DDErrPR         EQU     $A4             ; Parameter
0000                  (      dosdefs.asm):00460         DDErrUD         EQU     $A6             ; Undefined
0000                  (      dosdefs.asm):00461         DDErrSFF        EQU     $FF             ; ????
                      (      dosdefs.asm):00462                 endc
     0080             (      dosdefs.asm):00463         DDFirstError    EQU     ErrNR           ; First error code
                      (      dosdefs.asm):00464         
     0012             (      dosdefs.asm):00465         SecTrkSS        EQU     18              ; 18 sectors / track single sided
     0024             (      dosdefs.asm):00466         SecTrkDS        EQU     36              ; 36 sectors / track double sided
                      (      dosdefs.asm):00467         
     0B40             (      dosdefs.asm):00468         MaxLSN          EQU     (SecTrkDS*80)   ; Maximum possible LSN
                      (      dosdefs.asm):00469         
     0800             (      dosdefs.asm):00470         DskInitBuffer   EQU     $0800           ; Address of format disk buffer
     0008             (      dosdefs.asm):00471         SectorsPerBAM   EQU     $08             ; Each BAM entry is for 8 sectors
     005A             (      dosdefs.asm):00472         BAMEntries40SS  EQU     (SectorsPerTrack*40)/SectorsPerBAM      ; Number of BAM entries for a single sided 40 track disk
     00B4             (      dosdefs.asm):00473         BAMEntriesSec   EQU     (MaxLSN/2)/SectorsPerBAM                ; Number of BAM entries per BAM sector
     05A0             (      dosdefs.asm):00474         BAMLSNPerSec    EQU     MaxLSN/2        ; Number of LSNs per BAM sector
                      (      dosdefs.asm):00475         
                      (      dosdefs.asm):00476         ; Offsets within BAM of directory track flags
     002D             (      dosdefs.asm):00477         BAMOffDirPriSS  EQU     (SectorsPerTrack*DirPrimary)/SectorsPerBAM
     0024             (      dosdefs.asm):00478         BAMOffDirBakSS  EQU     (SectorsPerTrack*DirBackup)/SectorsPerBAM
     005A             (      dosdefs.asm):00479         BAMOffDirPriDS  EQU     (SectorsPerTrack*(DirPrimary*2))/SectorsPerBAM
     0048             (      dosdefs.asm):00480         BAMOffDirBakDS  EQU     (SectorsPerTrack*(DirBackup*2))/SectorsPerBAM
                      (      dosdefs.asm):00481         
     0002             (      dosdefs.asm):00482         BAMSecCount     EQU     $02             ; No of BAM Sectors
     0010             (      dosdefs.asm):00483         DIRSecCount     EQU     $10             ; Dir sector count
                      (      dosdefs.asm):00484         
     00FF             (      dosdefs.asm):00485         DosFlagTrue     EQU     $FF             ; flag true / enabled
     0000             (      dosdefs.asm):00486         DosFlagFalse    EQU     $00             ; flag false /disabled
                      (      dosdefs.asm):00487         
     00FF             (      dosdefs.asm):00488         IOInProgress    EQU     DosFlagTrue     ; Flag that DOS IO in progress
     00FF             (      dosdefs.asm):00489         ErrGotoEnabled  EQU     DosFlagTrue     ; Flag that on error goto is enabled
                      (      dosdefs.asm):00490         
     0064             (      dosdefs.asm):00491         AutoStartLine   EQU     100             ; Default start line for AUTO
     000A             (      dosdefs.asm):00492         AutoIncrement   EQU     10              ; Default increment for AUTO
                      (      dosdefs.asm):00493         
                      (      dosdefs.asm):00494         ; DosFRead code shared between file read wrie and verify
                      (      dosdefs.asm):00495         ; DosRWFlag determines the operation to be performed
                      (      dosdefs.asm):00496         
     0000             (      dosdefs.asm):00497         FileOpRead      EQU     $00             ; Reading file
     0001             (      dosdefs.asm):00498         FileOpWrite     EQU     $01             ; Writing file
     00FF             (      dosdefs.asm):00499         FileOpVerify    EQU     $FF             ; verifying written data
                      (      dosdefs.asm):00500         
                      (      dosdefs.asm):00501         ; Extend file stack fram offsets
                      (      dosdefs.asm):00502         
     0000             (      dosdefs.asm):00503         ExtendSecCount  EQU     $00             ; Sector count
                      (      dosdefs.asm):00504         ;ExtendDirEntPtr        EQU     $04             ; Pointer to dir entry with last sector 
                      (      dosdefs.asm):00505         ;ExtendGeomPtr  EQU     $08             ; Pointer to disk geometry buffer
     000A             (      dosdefs.asm):00506         ExtendSecCount2 EQU     $0A             ; Sector count
                      (      dosdefs.asm):00507         
                      (      dosdefs.asm):00508                                 if 0
                      (      dosdefs.asm):00509         ;
                      (      dosdefs.asm):00510         ; Offsets within file header, compatible with DragonDos/SuperDos
                      (      dosdefs.asm):00511         ;
0000                  (      dosdefs.asm):00512         HdrID55         EQU     $00             ; magic marker byte #1
0000                  (      dosdefs.asm):00513         HdrType         EQU     $01             ; file type see filetypes below
0000                  (      dosdefs.asm):00514         HdrLoad         EQU     $02             ; Load address of file
0000                  (      dosdefs.asm):00515         HdrLen          EQU     $04             ; length of file
0000                  (      dosdefs.asm):00516         HdrExec         EQU     $06             ; entry address of file
0000                  (      dosdefs.asm):00517         HdrIDAA         EQU     $08             ; magic marker byte #2
                      (      dosdefs.asm):00518         
0000                  (      dosdefs.asm):00519         FileHeadLen     EQU     $09             ; header length in bytes
                      (      dosdefs.asm):00520                                 
                      (      dosdefs.asm):00521         ; File types
                      (      dosdefs.asm):00522         
0000                  (      dosdefs.asm):00523         FTypeBas        EQU     $01             ; Basic files
0000                  (      dosdefs.asm):00524         FTypeBin        EQU     $02             ; Binary file types
                      (      dosdefs.asm):00525                         
                      (      dosdefs.asm):00526                 
                      (      dosdefs.asm):00527         ; Marker bytes
0000                  (      dosdefs.asm):00528         MarkerHeadStart EQU     $55             ; start header marker
0000                  (      dosdefs.asm):00529         MarkerHeadEnd   EQU     $AA             ; end header marker
                      (      dosdefs.asm):00530                         endc
                      (      dosdefs.asm):00531         ; Device number
     0001             (      dosdefs.asm):00532         DevDisk         EQU     $01             ; disk device
                      (    DragonMMC.asm):00114                     use     WDdefs.asm
                      (       WDdefs.asm):00001         ;
                      (       WDdefs.asm):00002         ; WD17xx / WD27xx defines.
                      (       WDdefs.asm):00003         ;
                      (       WDdefs.asm):00004                         ifdef   Tandy
                      (       WDdefs.asm):00005         ; Disk command codes WD1793, WD1773, RSDos FDC carts.
0000                  (       WDdefs.asm):00006         WDCmdRestore    EQU     $00             ; Restore to track 0
0000                  (       WDdefs.asm):00007         WDCmdSeek       EQU     $10             ; Seek to track command
0000                  (       WDdefs.asm):00008         WDCmdReadSec    EQU     $80             ; Read sector command
0000                  (       WDdefs.asm):00009         WDCmdWriteSec   EQU     $A0             ; Write sector command
0000                  (       WDdefs.asm):00010         WDCmdReadAddr   EQU     $C0             ; Read address mark
0000                  (       WDdefs.asm):00011         WDCmdForceInt   EQU     $D0             ; Force inturrupt
0000                  (       WDdefs.asm):00012         WDCmdWriteTrack EQU     $F4             ; Write (format) track  
                      (       WDdefs.asm):00013                         else
                      (       WDdefs.asm):00014         ; Disk command codes WD2797, Dragon Dos, Cumana Dos, Dragon Alpha/Professional, Dragon Beta
     0000             (       WDdefs.asm):00015         WDCmdRestore    EQU     $00             ; Restore to track 0
     0010             (       WDdefs.asm):00016         WDCmdSeek       EQU     $10             ; Seek to track command
     0088             (       WDdefs.asm):00017         WDCmdReadSec    EQU     $88             ; Read sector command
     00A8             (       WDdefs.asm):00018         WDCmdWriteSec   EQU     $A8             ; Write sector command
     00C0             (       WDdefs.asm):00019         WDCmdReadAddr   EQU     $C0             ; Read address mark
     00D0             (       WDdefs.asm):00020         WDCmdForceInt   EQU     $D0             ; Force inturrupt
     00F4             (       WDdefs.asm):00021         WDCmdWriteTrack EQU     $F4             ; Write (format) track
                      (       WDdefs.asm):00022                         endc
                      (       WDdefs.asm):00023         ;
                      (       WDdefs.asm):00024         ; Step rates.
                      (       WDdefs.asm):00025         ;
                      (       WDdefs.asm):00026         
     0000             (       WDdefs.asm):00027         StepRate6ms     EQU     $00             ;  6ms step rate
     0001             (       WDdefs.asm):00028         StepRate12ms    EQU     $01             ; 12ms step rate
     0002             (       WDdefs.asm):00029         StepRate20ms    EQU     $02             ; 20ms step rate
     0003             (       WDdefs.asm):00030         StepRate30ms    EQU     $03             ; 30ms step rate
                      (       WDdefs.asm):00031         
     0002             (       WDdefs.asm):00032         SeepRateDefault EQU     StepRate20ms    ; Default
                      (       WDdefs.asm):00033         
                      (       WDdefs.asm):00034         ;
                      (       WDdefs.asm):00035         ; WD Error flag / status bits
                      (       WDdefs.asm):00036         ;
                      (       WDdefs.asm):00037         
     0080             (       WDdefs.asm):00038         WDErrNotReady   EQU     $80             ; Not ready
     0040             (       WDdefs.asm):00039         WDErrWriteProt  EQU     $40             ; Write protect
     0020             (       WDdefs.asm):00040         WDErrHeadLoaded EQU     $20             ; Head loaded, type 1
     0020             (       WDdefs.asm):00041         WDErrRecType    EQU     $20             ; Record type, read sec
     0010             (       WDdefs.asm):00042         WDErrSeek       EQU     $10             ; Seek error, type 1
     0010             (       WDdefs.asm):00043         WDErrRNF        EQU     $10             ; Record not found, read address, sector write sector
     0008             (       WDdefs.asm):00044         WDErrCRC        EQU     $08             ; CRC error all but read/write track
     0004             (       WDdefs.asm):00045         WDErrTrack0     EQU     $04             ; Head on track 0, type 1
     0004             (       WDdefs.asm):00046         WDErrLostData   EQU     $04             ; Lost data 
     0002             (       WDdefs.asm):00047         WDErrIndex      EQU     $02             ; Index pulse, type 1
     0002             (       WDdefs.asm):00048         WDErrDRQ        EQU     $02             ; Data request
     0001             (       WDdefs.asm):00049         WDErrBusy       EQU     $01             ; Busy
                      (       WDdefs.asm):00050         
     000F             (       WDdefs.asm):00051         WDErrMask0F     EQU     WDErrCRC+WDErrLostData+WDErrDRQ+WDErrBusy
     005F             (       WDdefs.asm):00052         WDErrMask5F     EQU     WDErrWriteProt+WDErrRNF+WDErrMask0F
     00DF             (       WDdefs.asm):00053         WDErrMaskDF     EQU     WDErrNotReady+WDErrMask5F
     0047             (       WDdefs.asm):00054         WDErrMaskFormat EQU     WDErrWriteProt+WDErrLostData+WDErrDRQ+WDErrBusy
     003F             (       WDdefs.asm):00055         WDDefErrMask    EQU     WDErrRecType+WDErrSeek+WDErrMask0F
     007C             (       WDdefs.asm):00056         WDErrMaskRW     EQU     WDErrWriteProt+WDErrRecType+WDErrRNF+WDErrCRC+WDErrLostData
                      (       WDdefs.asm):00057         
                      (       WDdefs.asm):00058         
                      (    DragonMMC.asm):00115                                 use             romdefs.asm
     0000             (      romdefs.asm):00001         DStubResWordsOfs                EQU     $0000           Offset of number of reserved words
     0001             (      romdefs.asm):00002         DStubResLookupOfs               EQU     $0001           Offset of reserved word lookup table
     0003             (      romdefs.asm):00003         DStubResJumpOfs                 EQU     $0003           Offset of reserved word jump table
     0005             (      romdefs.asm):00004         DStubFuncsOfs                   EQU     $0005           Offset of nummber of functions
     0006             (      romdefs.asm):00005         DStubFuncsLookupOfs             EQU     $0006           Offset of function lookup table
     0008             (      romdefs.asm):00006         DStubFuncsJumpOfs               EQU     $0008           Offset of functions jump table
                      (      romdefs.asm):00007         
     0021             (      romdefs.asm):00008         DSkip1                          EQU     $0021           Skip 1 byte (BRN)
     008C             (      romdefs.asm):00009         DSkip2                          EQU     $008C           Skip 2 bytes (CMPX)
     0086             (      romdefs.asm):00010         DSkip1LD                        EQU     $0086           Skip 1 byte (LDA)
     007D             (      romdefs.asm):00011         DSkip2TST                       EQU     $007D           Skip 2 bytes (TST)
                      (      romdefs.asm):00012         
     0000             (      romdefs.asm):00013         DCoCoVec167                     EQU     $0000           Vector dest for 167 
     0000             (      romdefs.asm):00014         DCoCoVect16A                    EQU     $0000           Vector dest for 16A
     0000             (      romdefs.asm):00015         DCoCoVect176                    EQU     $0000           Vector dest for 176
     0000             (      romdefs.asm):00016         DCoCoVect179                    EQU     $0000           Vector dest for 179
     0000             (      romdefs.asm):00017         DCoCoVect18B                    EQU     $0000           Vector dest for 18B
     0000             (      romdefs.asm):00018         DCoCoVect191                    EQU     $0000           Vector dest for 191
     0000             (      romdefs.asm):00019         DCoCoVect194                    EQU     $0000           Vector Dest for 194
     0000             (      romdefs.asm):00020         DCoCoVect197                    EQU     $0000           Vector Dest for 197
     0000             (      romdefs.asm):00021         DCoCoVect19A                    EQU     $0000           Vector Dest for 19A
     0000             (      romdefs.asm):00022         DCoCoVect1A3                    EQU     $0000           Vector Dest for 1A3
     0027             (      romdefs.asm):00023         DAddrFWareRamTop                EQU     $0027           Top of firmware RAM CLEAR xxx,yyyy set this to yyyy
     0074             (      romdefs.asm):00024         DAddrRamTop                     EQU     $0074           Physical end of RAM (4K, 16K, 32K or 64K).
     0021             (      romdefs.asm):00025         DAddrStack                      EQU     $0021           Address of top of machine stack
     0123             (      romdefs.asm):00026         DBasAddrCmdDisp                 EQU     $0123           Address of basic command dispatch
     0121             (      romdefs.asm):00027         DBasAddrCmdList                 EQU     $0121           Address of basic command list
     012D             (      romdefs.asm):00028         DBasAddrDskCmdDisp              EQU     $012D           Address of disk basic command dispatch
     012B             (      romdefs.asm):00029         DBasAddrDskCmdList              EQU     $012B           Address of disk basic command list
     0132             (      romdefs.asm):00030         DBasAddrDskFuncDisp             EQU     $0132           Address of disk basic function dispatcher
     0130             (      romdefs.asm):00031         DBasAddrDskFuncList             EQU     $0130           Address of disk basic function list
     0128             (      romdefs.asm):00032         DBasAddrFuncDisp                EQU     $0128           Address of basic function dispatcher
     0126             (      romdefs.asm):00033         DBasAddrFuncList                EQU     $0126           Address of basic function list
     00A6             (      romdefs.asm):00034         DBasAddrSigByte                 EQU     $00A6           Address of current significant bit in command line
     B84E             (      romdefs.asm):00035         DBasAOError                     EQU     $B84E           Print ?AO Error and return to basic
     0005             (      romdefs.asm):00036         DBasArrayEval                   EQU     $0005           Array evaluation flag, 0=eval, 1=dimensioning
     B400             (      romdefs.asm):00037         DBasBootBasic                   EQU     $B400           Restart basic, as if power on, also deletes current program
     0017             (      romdefs.asm):00038         DBasBotStack                    EQU     $0017           Bottom of stack at last check
     84DA             (      romdefs.asm):00039         DBasBRARun                      EQU     $84DA           BRA to main loop, used by DOS
     0000             (      romdefs.asm):00040         DBasBreakFlag                   EQU     $0000           Break flag, +ve=stop,-ve=end
     03D7             (      romdefs.asm):00041         DBasBuffer                      EQU     $03D7           Basic buffer space
     831C             (      romdefs.asm):00042         DBasChkArrSpaceMv               EQU     $831C           Check memory space at top of arrays + move arrays
     8331             (      romdefs.asm):00043         DBasChkB2Free                   EQU     $8331           Check B*2 bytes free above Arrays, OM error if not
     9C76             (      romdefs.asm):00044         DBasChkDirect                   EQU     $9C76           Check for direct mode, ID Error if so
     009F             (      romdefs.asm):00045         DBasChrGet                      EQU     $009F           Get next basic character routine
     00A5             (      romdefs.asm):00046         DBasChrGetCurr                  EQU     $00A5           Get current basic ccharacter
     00D3             (      romdefs.asm):00047         DBasCloadMOffs                  EQU     $00D3           2s complement of CLOADM offset
     8371             (      romdefs.asm):00048         DBasCmdMode                     EQU     $8371           Return to command mode
     0029             (      romdefs.asm):00049         DBasContLine                    EQU     $0029           Line no used by CONT
     0068             (      romdefs.asm):00050         DBasCurrentLine                 EQU     $0068           Current line no $FFFF in direct mode
     0001             (      romdefs.asm):00051         DBasDelim1                      EQU     $0001           First string delimiter
     0002             (      romdefs.asm):00052         DBasDelim2                      EQU     $0002           Second string delimiter
     002F             (      romdefs.asm):00053         DBasDirectTextPtr               EQU     $002F           Direct mode text pointer
     0008             (      romdefs.asm):00054         DBasDisArraySearch              EQU     $0008           Disable array search flag, 0=allow 0<>disable
     B851             (      romdefs.asm):00055         DBasDNError                     EQU     $B851           Print ?DN Error and return to basic
     84ED             (      romdefs.asm):00056         DBasDoDispatch                  EQU     $84ED           Do command dispatech, X must point to dispatch table
     00D7             (      romdefs.asm):00057         DBasEditorLineLen               EQU     $00D7           Editor line length
     82A9             (      romdefs.asm):00058         DBasErrorCodeTable              EQU     $82A9           List of 2 byte error codes eg 'SN' 'OM' 'UL' etc
     009D             (      romdefs.asm):00059         DBasExecAddr                    EQU     $009D           Exec address, on D64, at startup points to routine to boot all ram mode
     8B8D             (      romdefs.asm):00060         DBasFCError                     EQU     $8B8D           Print ?FC Error and return to basic
     83FF             (      romdefs.asm):00061         DBasFindLineNo                  EQU     $83FF           Find a line number in basic program
     B848             (      romdefs.asm):00062         DBasFMError                     EQU     $B848           Print ?FM Error and return to basic
     0007             (      romdefs.asm):00063         DBasGarbageFlag                 EQU     $0007           Garbage collection flag
     0003             (      romdefs.asm):00064         DBasGenCount                    EQU     $0003           General count/scratch var
     B7D4             (      romdefs.asm):00065         DBasGetDevNo                    EQU     $B7D4           Get dev no from line & validate
     869A             (      romdefs.asm):00066         DBasGetLineNo                   EQU     $869A           Get line no and store in BasTempLine
     8DEA             (      romdefs.asm):00067         DBasGetStrFirst                 EQU     $8DEA           Get first character of string into B
     8D9A             (      romdefs.asm):00068         DBasGetStrLenAddr               EQU     $8D9A           Get string len in B and address in X of string desc in FPA2
     8027             (      romdefs.asm):00069         DBasicCassBitIn                 EQU     $8027           Cassette bit input
     8024             (      romdefs.asm):00070         DBasicCassByIn                  EQU     $8024           Cassette byte input
     801E             (      romdefs.asm):00071         DBasicCassByOut                 EQU     $801E           Cassette byte output
     8018             (      romdefs.asm):00072         DBasicCassOff                   EQU     $8018           Cassette player motor off
     8015             (      romdefs.asm):00073         DBasicCassOn                    EQU     $8015           Cassette player motor on
     8021             (      romdefs.asm):00074         DBasicCassOnRd                  EQU     $8021           Cassette on for reading
     8009             (      romdefs.asm):00075         DBasicCursorB                   EQU     $8009           Cursor blink
     8000             (      romdefs.asm):00076         DBasicHWInit                    EQU     $8000           Hardware initialisation
     8012             (      romdefs.asm):00077         DBasicJoyIn                     EQU     $8012           Joystick input
     8006             (      romdefs.asm):00078         DBasicKbdIn                     EQU     $8006           Keyboard input
     800F             (      romdefs.asm):00079         DBasicPrintOut                  EQU     $800F           Printer output
     800C             (      romdefs.asm):00080         DBasicScreenOut                 EQU     $800C           Screen output
     802A             (      romdefs.asm):00081         DBasicSerIn                     EQU     $802A           Read a byte from serial
     802D             (      romdefs.asm):00082         DBasicSerOut                    EQU     $802D           Write a byte to serial port
     8030             (      romdefs.asm):00083         DBasicSetBaud                   EQU     $8030           Set baud rate
     8003             (      romdefs.asm):00084         DBasicSWInit                    EQU     $8003           Software initialisation
     801B             (      romdefs.asm):00085         DBasicWriteLead                 EQU     $801B           Cassette write leader
     9C7C             (      romdefs.asm):00086         DBasIDError                     EQU     $9C7C           Print ?ID Error and return to basic
     0004             (      romdefs.asm):00087         DBasIfCount                     EQU     $0004           If count - how many in a line
     B5D3             (      romdefs.asm):00088         DBasInBuffFromX                 EQU     $B5D3           Read input buffer at X as basic input
     0009             (      romdefs.asm):00089         DBasInputFlag                   EQU     $0009           Iinput/read flag, 0=input 0<>read
     B84B             (      romdefs.asm):00090         DBasIOError                     EQU     $B84B           Print ?IO Error and return to basic
     9D3D             (      romdefs.asm):00091         DBasIRQVec                      EQU     $9D3D           Basic IRQ routine, increments timer
     015A             (      romdefs.asm):00092         DBasJoyVal0                     EQU     $015A           Joystick(0) value
     015B             (      romdefs.asm):00093         DBasJoyVal1                     EQU     $015B           Joystick(1) value
     015C             (      romdefs.asm):00094         DBasJoyVal2                     EQU     $015C           Joystick(2) value
     015D             (      romdefs.asm):00095         DBasJoyVal3                     EQU     $015D           Joystick(3) value
     9DD9             (      romdefs.asm):00096         DBasLineInputEntry              EQU     $9DD9           Entry into LINE INPUT routine, used by DOS
     02DC             (      romdefs.asm):00097         DBasLinInpBuff                  EQU     $02DC           Basic line input buffer
     02DA             (      romdefs.asm):00098         DBasLinInpHead                  EQU     $02DA           Basic line input buffer header
     8EAA             (      romdefs.asm):00099         DBasList                        EQU     $8EAA           List basic program to SysDevN A must be 0 on entry
     0066             (      romdefs.asm):00100         DBasListLine                    EQU     $0066           Current line during list
     AA87             (      romdefs.asm):00101         DBasLocateScreen                EQU     $AA87           Initialise beginning of basic after graphics screen, no of pages in A
     8D6B             (      romdefs.asm):00102         DBasLSError                     EQU     $8D6B           Print ?LS Error and return to basic
     A101             (      romdefs.asm):00103         DBasNEError                     EQU     $A101           Print ?NE Error and return to basic
     8417             (      romdefs.asm):00104         DBasNew                         EQU     $8417           Remove current basic program from meory, like NEW command
     B631             (      romdefs.asm):00105         DBasNOError                     EQU     $B631           Print ?NO Error and return to basic
     0120             (      romdefs.asm):00106         DBasNumCmds                     EQU     $0120           Number of basic commands
     012A             (      romdefs.asm):00107         DBasNumDskCmds                  EQU     $012A           Number of disk basic commands
     012F             (      romdefs.asm):00108         DBasNumDskFuncs                 EQU     $012F           Number of disk basic functions
     0125             (      romdefs.asm):00109         DBasNumFuncs                    EQU     $0125           Number of basic functions
     002D             (      romdefs.asm):00110         DBasOldInputPtr                 EQU     $002D           Pointer to saved input during a STOP
     8342             (      romdefs.asm):00111         DBasOMError                     EQU     $8342           Print ?OM Error and return to basic
     91DB             (      romdefs.asm):00112         DBasOVError                     EQU     $91DB           Print ?OV Error and return to basic
     851B             (      romdefs.asm):00113         DBasPollKeyboard                EQU     $851B           Basic, poll keyboard and check for break
     978E             (      romdefs.asm):00114         DBasRandom8                     EQU     $978E           Generate an 8 bit random number and place in BasRandomSeed+1
     0115             (      romdefs.asm):00115         DBasRandomSeed                  EQU     $0115           Random number seed for RND function
     000A             (      romdefs.asm):00116         DBasRelateFlag                  EQU     $000A           Relational operator flag
     00D1             (      romdefs.asm):00117         DBasRenumStart                  EQU     $00D1           Renum start line no
     00D5             (      romdefs.asm):00118         DBasRenumStartLine              EQU     $00D5           Renum start line number
     00CF             (      romdefs.asm):00119         DBasRenumVal                    EQU     $00CF           Renum increment value
     8434             (      romdefs.asm):00120         DBasResetStack                  EQU     $8434           Reset basic stack to initial position
     8C52             (      romdefs.asm):00121         DBasResStr                      EQU     $8C52           Reserve B bytes of string space return start in X, setup low mem vars
     8CB3             (      romdefs.asm):00122         DBasResStr2                     EQU     $8CB3           Reserve B bytes of string space return start in X
     00AB             (      romdefs.asm):00123         DBasRndData                     EQU     $00AB           Used by RND
     849F             (      romdefs.asm):00124         DBasRun                         EQU     $849F           Run basic program in memory, like RUN
     85EE             (      romdefs.asm):00125         DBasSetProgPtrX                 EQU     $85EE           Sets basic program pointer to X-1
     B4B2             (      romdefs.asm):00126         DBasSignonMess                  EQU     $B4B2           Signon message address, for CoCo this is for Extended basic.
     85E7             (      romdefs.asm):00127         DBasSkipLineNo                  EQU     $85E7           Skip past line no in basic line, UL error if no line no.
     89B4             (      romdefs.asm):00128         DBasSNError                     EQU     $89B4           Print ?SN Error and return to basic
     0019             (      romdefs.asm):00129         DBasStartProg                   EQU     $0019           Start addr of basic program
     8C99             (      romdefs.asm):00130         DBasSTError                     EQU     $8C99           Print ?OM Error and return to basic
     01A9             (      romdefs.asm):00131         DBasStrDescStack                EQU     $01A9           String descriptor stack
     000B             (      romdefs.asm):00132         DBasStrFirstFreeTemp            EQU     $000B           First free temory string space pointer
     000D             (      romdefs.asm):00133         DBasStrLastUsedTemp             EQU     $000D           Last used tempory string space pointer
     0025             (      romdefs.asm):00134         DBasStrUtil                     EQU     $0025           Utility string pointer
     0120             (      romdefs.asm):00135         DBasStub0                       EQU     $0120           Basic Stub 0 (All basic on Dragon, Colour basic on Tandy)
     012A             (      romdefs.asm):00136         DBasStub1                       EQU     $012A           Basic stub 1 (Disk basic on Dragon, Extended basic on Tandy)
     0134             (      romdefs.asm):00137         DBasStub2                       EQU     $0134           Basic Stub 2 (Null on dragon, Disk basic on Tandy)
     013E             (      romdefs.asm):00138         DBasStub3                       EQU     $013E           Basic Stub 3 (do not use on dragon, user stub on Tandy)
     0013             (      romdefs.asm):00139         DBasTempFPA2                    EQU     $0013           Tempory FPA Mantissa for FPA2
     002B             (      romdefs.asm):00140         DBasTempLine                    EQU     $002B           Tempory line no
     000F             (      romdefs.asm):00141         DBasTempPtr                     EQU     $000F           Tempory pointer
     0011             (      romdefs.asm):00142         DBasTempPtr1                    EQU     $0011           Tempory discriptor pointer (stack search)
     003F             (      romdefs.asm):00143         DBasTempRelateFlag              EQU     $003F           Tempory relational operator flag
     003B             (      romdefs.asm):00144         DBasTempVarDesc                 EQU     $003B           Pointer to a tempory var descriptor
     8882             (      romdefs.asm):00145         DBasTMError                     EQU     $8882           Print ?TM Error and return to basic
     00AF             (      romdefs.asm):00146         DBasTronFlag                    EQU     $00AF           Tron flag nonzero=trace on
     8605             (      romdefs.asm):00147         DBasULError                     EQU     $8605           Print ?UL Error and return to basic
     0076             (      romdefs.asm):00148         DBasUnused1                     EQU     $0076           2 unused bytes
     00B0             (      romdefs.asm):00149         DBasUSRTableAddr                EQU     $00B0           Address of USR address table
     0134             (      romdefs.asm):00150         DBasUsrVecNoDisk                EQU     $0134           USR vector tabl when basic not installed
     001D             (      romdefs.asm):00151         DBasVarArrayAddr                EQU     $001D           Start address of Array table
     0052             (      romdefs.asm):00152         DBasVarAssign16                 EQU     $0052           Part of FPA1, used for 16bit assigns
     0033             (      romdefs.asm):00153         DBasVarDataAddr                 EQU     $0033           Address of next item in data
     0031             (      romdefs.asm):00154         DBasVarDataLine                 EQU     $0031           Line number of current data statement
     001F             (      romdefs.asm):00155         DBasVarEnd                      EQU     $001F           End of storage in use by basic
     004F             (      romdefs.asm):00156         DBasVarFPAcc1                   EQU     $004F           Floating point acumulator 1
     005C             (      romdefs.asm):00157         DBasVarFPAcc2                   EQU     $005C           Floating point acumulator 2
     0040             (      romdefs.asm):00158         DBasVarFPAcc3                   EQU     $0040           Floating point accumulator 3 (packed)
     0045             (      romdefs.asm):00159         DBasVarFPAcc4                   EQU     $0045           Floating point accumulator 4 (packed)
     004A             (      romdefs.asm):00160         DBasVarFPAcc5                   EQU     $004A           Floating point accumulator 5 (packed)
     0037             (      romdefs.asm):00161         DBasVarLastInUse                EQU     $0037           Pointer to variable last in use
     0039             (      romdefs.asm):00162         DBasVarPtrLast                  EQU     $0039           Poiinter to VARPTR last in use
     001B             (      romdefs.asm):00163         DBasVarSimpleAddr               EQU     $001B           Start address of simple variables
     0021             (      romdefs.asm):00164         DBasVarStringBase               EQU     $0021           Base address of string space (and stack)
     0023             (      romdefs.asm):00165         DBasVarStrTop                   EQU     $0023           Top of string space in use
     0006             (      romdefs.asm):00166         DBasVarType                     EQU     $0006           Variable type flag 0=numeric, $ff=string
     841F             (      romdefs.asm):00167         DBasVect1                       EQU     $841F           Sets up various basic vectors (after load), should be followed by call to BasVect2
     8424             (      romdefs.asm):00168         DBasVect1a                      EQU     $8424           Same as Vect1, but doesn't reset input pointer
     83ED             (      romdefs.asm):00169         DBasVect2                       EQU     $83ED           Finalises setup of basic vectors (after load), should be preceeded by call to BasVect1
     93B1             (      romdefs.asm):00170         DBasZDError                     EQU     $93B1           Print ?ZD Error and return to basic
     01E3             (      romdefs.asm):00171         DCasASCIIFlag                   EQU     $01E3           ASCII flag byte
     BAC3             (      romdefs.asm):00172         DCasAudioOff                    EQU     $BAC3           Turn off audio from cassette
     BAEC             (      romdefs.asm):00173         DCasAudioOn                     EQU     $BAEC           Turn on Audio from cassete to speaker
     0083             (      romdefs.asm):00174         DCasBitCount                    EQU     $0083           Cassette bit counter
     BDA5             (      romdefs.asm):00175         DCasBitIn                       EQU     $BDA5           Reads a bity into the 'Z' flag
     B93E             (      romdefs.asm):00176         DCasBlockIn                     EQU     $B93E           Reads a block into the cassete buffer pointed to by CasIOBuffAddr
     007D             (      romdefs.asm):00177         DCasBlockLen                    EQU     $007D           Cassete block length, number of bytes read, or to be written
     B999             (      romdefs.asm):00178         DCasBlockOut                    EQU     $B999           Write a block to cassete pointed to by CasIOBuffAddr
     007C             (      romdefs.asm):00179         DCasBlockType                   EQU     $007C           Cassete block type, 0=filename, 1=data, 255=EOF
     BDAD             (      romdefs.asm):00180         DCasByteIn                      EQU     $BDAD           Reads a single byte into the A register
     BE12             (      romdefs.asm):00181         DCasByteOut                     EQU     $BE12           Write byte in A register to cassete
     0080             (      romdefs.asm):00182         DCasCkSum                       EQU     $0080           Used by cassette routines for calculating checksum
     B65F             (      romdefs.asm):00183         DCasClosFiles                   EQU     $B65F           Close any open cassete file
     01E5             (      romdefs.asm):00184         DCasEntryAddr                   EQU     $01E5           Entry address for MC programs
     0070             (      romdefs.asm):00185         DCasEOFFlag                     EQU     $0070           Cassette IO Flag, nonzero if EOF reached
     B8B3             (      romdefs.asm):00186         DCasFindFile                    EQU     $B8B3           Searches a tape for specified filename
     01D2             (      romdefs.asm):00187         DCasFName                       EQU     $01D2           Cassete filename to search for or write out
     01DA             (      romdefs.asm):00188         DCasFNameFound                  EQU     $01DA           Filename found, when reading
     01D1             (      romdefs.asm):00189         DCasFNameLen                    EQU     $01D1           Length of cassette filename can be 0 to 8
     01E2             (      romdefs.asm):00190         DCasFType                       EQU     $01E2           File type 0=tokenized basic, 1=ASCII data, 2=Binary
     01E4             (      romdefs.asm):00191         DCasGapFlag                     EQU     $01E4           Gap flag byte
     007A             (      romdefs.asm):00192         DCasHeadBuffAddr                EQU     $007A           Address of cassette file header
     01DA             (      romdefs.asm):00193         DCasIOBuff                      EQU     $01DA           COS default IO buffer, if this contains filename block then folloing are valid
     007E             (      romdefs.asm):00194         DCasIOBuffAddr                  EQU     $007E           Cassette IO buffer address, where data will be read/written
     0079             (      romdefs.asm):00195         DCasIOBuffSize                  EQU     $0079           Size of cassette IO buffer
     0081             (      romdefs.asm):00196         DCasIOErrorCode                 EQU     $0081           Cassette IO error code 0=no error, 1=CRC, 2=attempt to load in non-ram area
     006E             (      romdefs.asm):00197         DCasIOFlag                      EQU     $006E           Cassette IO Flag, set to $FF when IO in progress
     0085             (      romdefs.asm):00198         DCasLastSine                    EQU     $0085           Casette last sine tabe entry
     0090             (      romdefs.asm):00199         DCasLeadCount                   EQU     $0090           Cassete leader count, number of $55 bytes in the leader
     01E7             (      romdefs.asm):00200         DCasLoadAddr                    EQU     $01E7           Load address
     0093             (      romdefs.asm):00201         DCasMax12                       EQU     $0093           Cassette Upper limit of 1200Hz
     0094             (      romdefs.asm):00202         DCasMax24                       EQU     $0094           Cassette Upper limit of 2400Hz
     0095             (      romdefs.asm):00203         DCasMotorDelay                  EQU     $0095           Cassette motor on delay (also inter-block gap)
     BDDC             (      romdefs.asm):00204         DCasMotorOff                    EQU     $BDDC           Turn off cassette motor
     BDCF             (      romdefs.asm):00205         DCasMotorOn                     EQU     $BDCF           Turn on motor, and wait for delay in CasMotorDelay
     0092             (      romdefs.asm):00206         DCasPartrt                      EQU     $0092           Cassette 1200/2400 partition
     0084             (      romdefs.asm):00207         DCasPhaseFlag                   EQU     $0084           Cassette Phase flag
     B748             (      romdefs.asm):00208         DCasReadBin                     EQU     $B748           Read in a binary file, similar to CLOADM
     B933             (      romdefs.asm):00209         DCasReadBlock1                  EQU     $B933           Turns on motor, reads header and then first block into CasIOBufAddr
     BDE7             (      romdefs.asm):00210         DCasReadLeader                  EQU     $BDE7           Turn on motor and read past leader
     0078             (      romdefs.asm):00211         DCasStatus                      EQU     $0078           Cassette status byte, 0=cassette closed, 1=open for input, 2=open for output
     0082             (      romdefs.asm):00212         DCasTemp                        EQU     $0082           Cassette tempory storage
     B6A5             (      romdefs.asm):00213         DCasWriteBasic                  EQU     $B6A5           Write tokenized basic program out, similar to CSAVE
     991B             (      romdefs.asm):00214         DCasWriteBin                    EQU     $991B           Write a binary file out push return address, then start,end and entry addresses and then JMP to this
     B991             (      romdefs.asm):00215         DCasWriteBlock1                 EQU     $B991           Turn on motor, write leader and then first block
     801B             (      romdefs.asm):00216         DCasWriteLeader                 EQU     $801B           Turn on motor and write out leader
     943E             (      romdefs.asm):00217         DCmdABS                         EQU     $943E           Basic Command
     8A12             (      romdefs.asm):00218         DCmdAND                         EQU     $8A12           Basic Command
     8DE6             (      romdefs.asm):00219         DCmdASC                         EQU     $8DE6           Basic Command
     9877             (      romdefs.asm):00220         DCmdATN                         EQU     $9877           Basic Command
     BADF             (      romdefs.asm):00221         DCmdAudio                       EQU     $BADF           Basic Command
     8DD2             (      romdefs.asm):00222         DCmdCHRS                        EQU     $8DD2           Basic Command
     B238             (      romdefs.asm):00223         DCmdCircle                      EQU     $B238           Basic Command
     8571             (      romdefs.asm):00224         DCmdClear                       EQU     $8571           Basic Command
     B6D5             (      romdefs.asm):00225         DCmdCload                       EQU     $B6D5           Basic Command
     B64D             (      romdefs.asm):00226         DCmdClose                       EQU     $B64D           Basic Command
     BA60             (      romdefs.asm):00227         DCmdCLS                         EQU     $BA60           Basic Command
     A8D4             (      romdefs.asm):00228         DCmdColor                       EQU     $A8D4           Basic Command
     8560             (      romdefs.asm):00229         DCmdCont                        EQU     $8560           Basic Command
     97CB             (      romdefs.asm):00230         DCmdCOS                         EQU     $97CB           Basic Command
     B683             (      romdefs.asm):00231         DCmdCsave                       EQU     $B683           Basic Command
     8613             (      romdefs.asm):00232         DCmdData                        EQU     $8613           Basic Command
     9C81             (      romdefs.asm):00233         DCmdDef                         EQU     $9C81           Basic Command
     9D61             (      romdefs.asm):00234         DCmdDelete                      EQU     $9D61           Basic Command
     8A8B             (      romdefs.asm):00235         DCmdDim                         EQU     $8A8B           Basic Command
     933C             (      romdefs.asm):00236         DCmdDivide                      EQU     $933C           Basic Command
     A049             (      romdefs.asm):00237         DCmdDload                       EQU     $A049           Basic Command
     B051             (      romdefs.asm):00238         DCmdDraw                        EQU     $B051           Basic Command
     9965             (      romdefs.asm):00239         DCmdEdit                        EQU     $9965           Basic Command
     8532             (      romdefs.asm):00240         DCmdEnd                         EQU     $8532           Basic Command
     B801             (      romdefs.asm):00241         DCmdEOF                         EQU     $B801           Basic Command
     B771             (      romdefs.asm):00242         DCmdExec                        EQU     $B771           Basic Command
     9713             (      romdefs.asm):00243         DCmdEXP                         EQU     $9713           Basic Command
     96A0             (      romdefs.asm):00244         DCmdExponet                     EQU     $96A0           Basic Command
     9956             (      romdefs.asm):00245         DCmdFIX                         EQU     $9956           Basic Command
     8448             (      romdefs.asm):00246         DCmdFor                         EQU     $8448           Basic Command
     AAF0             (      romdefs.asm):00247         DCmdGet                         EQU     $AAF0           Basic Command
     85B9             (      romdefs.asm):00248         DCmdGo                          EQU     $85B9           Basic Command
     A00E             (      romdefs.asm):00249         DCmdHexS                        EQU     $A00E           Basic Command
     8647             (      romdefs.asm):00250         DCmdIF                          EQU     $8647           Basic Command
     B797             (      romdefs.asm):00251         DCmdInkeyS                      EQU     $B797           Basic Command
     872B             (      romdefs.asm):00252         DCmdInput                       EQU     $872B           Basic Command
     9BB4             (      romdefs.asm):00253         DCmdInstr                       EQU     $9BB4           Basic Command
     9499             (      romdefs.asm):00254         DCmdINT                         EQU     $9499           Basic Command
     BB0D             (      romdefs.asm):00255         DCmdJoystk                      EQU     $BB0D           Basic Command
     8DF1             (      romdefs.asm):00256         DCmdLeftS                       EQU     $8DF1           Basic Command
     8DC7             (      romdefs.asm):00257         DCmdLEN                         EQU     $8DC7           Basic Command
     86BC             (      romdefs.asm):00258         DCmdLet                         EQU     $86BC           Basic Command
     A749             (      romdefs.asm):00259         DCmdLine                        EQU     $A749           Basic Command
     9DB1             (      romdefs.asm):00260         DCmdLineInput                   EQU     $9DB1           Line input command
     8EAA             (      romdefs.asm):00261         DCmdList                        EQU     $8EAA           Basic Command
     8EA4             (      romdefs.asm):00262         DCmdLList                       EQU     $8EA4           Basic Command
     923C             (      romdefs.asm):00263         DCmdLOG                         EQU     $923C           Basic Command
     8C31             (      romdefs.asm):00264         DCmdMEM                         EQU     $8C31           Basic Command
     8E15             (      romdefs.asm):00265         DCmdMidS                        EQU     $8E15           Basic Command
     9105             (      romdefs.asm):00266         DCmdMinus                       EQU     $9105           Basic Command
     B982             (      romdefs.asm):00267         DCmdMotor                       EQU     $B982           Basic Command
     9275             (      romdefs.asm):00268         DCmdMultiply                    EQU     $9275           Basic Command
     8415             (      romdefs.asm):00269         DCmdNew                         EQU     $8415           Basic Command
     8829             (      romdefs.asm):00270         DCmdNext                        EQU     $8829           Basic Command
     8675             (      romdefs.asm):00271         DCmdON                          EQU     $8675           Basic Command
     B829             (      romdefs.asm):00272         DCmdOpen                        EQU     $B829           Basic Command
     B835             (      romdefs.asm):00273         DCmdOpenEntry                   EQU     $B835           Entry into Basic open command used by Dragon/SuperDos
     8A11             (      romdefs.asm):00274         DCmdOR                          EQU     $8A11           Basic Command
     AC87             (      romdefs.asm):00275         DCmdPaint                       EQU     $AC87           Basic Command
     AA19             (      romdefs.asm):00276         DCmdPClear                      EQU     $AA19           Basic Command
     A8C0             (      romdefs.asm):00277         DCmdPCls                        EQU     $A8C0           Basic Command
     AABE             (      romdefs.asm):00278         DCmdPcopy                       EQU     $AABE           Basic Command
     8E96             (      romdefs.asm):00279         DCmdPeek                        EQU     $8E96           Basic Command
     ADBD             (      romdefs.asm):00280         DCmdPlay                        EQU     $ADBD           Basic Command
     910E             (      romdefs.asm):00281         DCmdPlus                        EQU     $910E           Basic Command
     A9AF             (      romdefs.asm):00282         DCmdPmode                       EQU     $A9AF           Basic Command
     BA45             (      romdefs.asm):00283         DCmdPoint                       EQU     $BA45           Basic Command
     8E9D             (      romdefs.asm):00284         DCmdPoke                        EQU     $8E9D           Basic Command
     9ADE             (      romdefs.asm):00285         DCmdPOS                         EQU     $9ADE           Basic Command
     A6C7             (      romdefs.asm):00286         DCmdPPoint                      EQU     $A6C7           Basic Command
     A6F3             (      romdefs.asm):00287         DCmdPReset                      EQU     $A6F3           Basic Command
     903D             (      romdefs.asm):00288         DCmdPrint                       EQU     $903D           Basic Command
     A6EF             (      romdefs.asm):00289         DCmdPset                        EQU     $A6EF           Basic Command
     AAF3             (      romdefs.asm):00290         DCmdPut                         EQU     $AAF3           Basic Command
     8777             (      romdefs.asm):00291         DCmdRead                        EQU     $8777           Basic Command
     877A             (      romdefs.asm):00292         DCmdReadFromX                   EQU     $877A           As basic READ command but ptr in X supplied by caller
     8616             (      romdefs.asm):00293         DCmdREM                         EQU     $8616           Basic Command
     9DFA             (      romdefs.asm):00294         DCmdRenum                       EQU     $9DFA           Basic Command
     BA04             (      romdefs.asm):00295         DCmdReset                       EQU     $BA04           Basic Command
     8514             (      romdefs.asm):00296         DCmdRestore                     EQU     $8514           Basic Command
     85F3             (      romdefs.asm):00297         DCmdReturn                      EQU     $85F3           Basic Command
     8E0E             (      romdefs.asm):00298         DCmdRightS                      EQU     $8E0E           Basic Command
     9772             (      romdefs.asm):00299         DCmdRND                         EQU     $9772           Basic Command
     85A5             (      romdefs.asm):00300         DCmdRun                         EQU     $85A5           Basic Command
     A9FE             (      romdefs.asm):00301         DCmdScreen                      EQU     $A9FE           Basic Command
     B9D3             (      romdefs.asm):00302         DCmdSet                         EQU     $B9D3           Basic Command
     9425             (      romdefs.asm):00303         DCmdSGN                         EQU     $9425           Basic Command
     97D1             (      romdefs.asm):00304         DCmdSIN                         EQU     $97D1           Basic Command
     B81F             (      romdefs.asm):00305         DCmdSkipf                       EQU     $B81F           Basic Command
     BA9B             (      romdefs.asm):00306         DCmdSound                       EQU     $BA9B           Basic Command
     9697             (      romdefs.asm):00307         DCmdSQR                         EQU     $9697           Basic Command
     8539             (      romdefs.asm):00308         DCmdStop                        EQU     $8539           Basic Command
     9B84             (      romdefs.asm):00309         DCmdStringS                     EQU     $9B84           Basic Command
     8C40             (      romdefs.asm):00310         DCmdSTRS                        EQU     $8C40           Basic Command
     9816             (      romdefs.asm):00311         DCmdTAN                         EQU     $9816           Basic Command
     9D59             (      romdefs.asm):00312         DCmdTimer                       EQU     $9D59           Basic Command
     9ADA             (      romdefs.asm):00313         DCmdTroff                       EQU     $9ADA           Basic Command
     9AD9             (      romdefs.asm):00314         DCmdTron                        EQU     $9AD9           Basic Command
     9D1D             (      romdefs.asm):00315         DCmdUSR                         EQU     $9D1D           Basic Command
     8E5C             (      romdefs.asm):00316         DCmdVAL                         EQU     $8E5C           Basic Command
     9AF4             (      romdefs.asm):00317         DCmdVarptr                      EQU     $9AF4           Basic Command
     00B3             (      romdefs.asm):00318         DGrBackground                   EQU     $00B3           Current background colour
     00B9             (      romdefs.asm):00319         DGrBytesPerLine                 EQU     $00B9           Number of byts/lin in current mode
     BA28             (      romdefs.asm):00320         DGrCalcPixelPos                 EQU     $BA28           Calculates Lo-res pixel pos from data on stack
     00D0             (      romdefs.asm):00321         DGrCircleRadius                 EQU     $00D0           Circle radius
     00CB             (      romdefs.asm):00322         DGrCircleXCo                    EQU     $00CB           Circle command X
     00CD             (      romdefs.asm):00323         DGrCircleYCo                    EQU     $00CD           Circle command Y
     A8C7             (      romdefs.asm):00324         DGrClearGrScreen                EQU     $A8C7           Clears grapics screen to value in B
     00C1             (      romdefs.asm):00325         DGrColourSet                    EQU     $00C1           Colour set currently in use
     00B4             (      romdefs.asm):00326         DGrColourTemp                   EQU     $00B4           Tempory colour in use
     00B5             (      romdefs.asm):00327         DGrCurrColour                   EQU     $00B5           Byte value for current colour, to set all pixels in byte to that colour
     00B6             (      romdefs.asm):00328         DGrCurrPmode                    EQU     $00B6           Current PMODE number
     00BD             (      romdefs.asm):00329         DGrCurrX                        EQU     $00BD           Current X cursor pos
     00C7             (      romdefs.asm):00330         DGrCurrXCo                      EQU     $00C7           Current Cursor X
     00BF             (      romdefs.asm):00331         DGrCurrY                        EQU     $00BF           Current Y cursor pos
     00C9             (      romdefs.asm):00332         DGrCurrYCo                      EQU     $00C9           Current Cursor Y
     00DB             (      romdefs.asm):00333         DGrDirtyFlag                    EQU     $00DB           Flag to tell if graphics screen has changed
     00BA             (      romdefs.asm):00334         DGrDisplayStartAddr             EQU     $00BA           Address of first byte in current display
     B051             (      romdefs.asm):00335         DGrDraw                         EQU     $B051           Draw on pmode screen as in DRAW command
     00E8             (      romdefs.asm):00336         DGrDrawAngle                    EQU     $00E8           Current angle for DRAW command
     00E9             (      romdefs.asm):00337         DGrDrawScale                    EQU     $00E9           Current scale for DRAW command
     00B2             (      romdefs.asm):00338         DGrForeground                   EQU     $00B2           Current foreground colour
     00B7             (      romdefs.asm):00339         DGrLastDisplayAddr              EQU     $00B7           Address of last byte in current display
     00C3             (      romdefs.asm):00340         DGrPixelNoX                     EQU     $00C3           Current horizontal pixel no
     00C5             (      romdefs.asm):00341         DGrPixelNoY                     EQU     $00C5           Current vertical pixel number
     00C2             (      romdefs.asm):00342         DGrPlotFlag                     EQU     $00C2           Plot/Unplot flag, 0=reset, nonzero=set
     AA23             (      romdefs.asm):00343         DGrReserveGrRam                 EQU     $AA23           Reserves memory for graphics, no graphics pages in B
     BA07             (      romdefs.asm):00344         DGrResetLRGPixel                EQU     $BA07           ReSets lo res pixel
     AA10             (      romdefs.asm):00345         DGrSelectColourSet              EQU     $AA10           Selects colour set dependent on B
     A938             (      romdefs.asm):00346         DGrSelectDisplay                EQU     $A938           Sets Text or Graphics screen, if Z=1 then text
     A9E1             (      romdefs.asm):00347         DGrSelectPage                   EQU     $A9E1           On entry B contains Pmode page to be used
     A9A4             (      romdefs.asm):00348         DGrSelectVDGColSet              EQU     $A9A4           Select colour set from data in GrColourSet
     A928             (      romdefs.asm):00349         DGrSetColours                   EQU     $A928           Sets up colours in low memory
     B9DF             (      romdefs.asm):00350         DGrSetLRGPixel                  EQU     $B9DF           Sets lo res pixel
     0086             (      romdefs.asm):00351         DGrSetResetData                 EQU     $0086           Data for Lo-res set/reset
     A989             (      romdefs.asm):00352         DGrSetVDGMode                   EQU     $A989           Set VDG to mode in A register
     A99D             (      romdefs.asm):00353         DGrSetVDGOffset                 EQU     $A99D           Set VDG offset to page in A
     00BC             (      romdefs.asm):00354         DGrStartPages                   EQU     $00BC           Page number of Start of graphics pages
     A006             (      romdefs.asm):00355         DIndCasBlockIn                  EQU     $A006           Indirect Read cassette block
     A008             (      romdefs.asm):00356         DIndCasBlockOut                 EQU     $A008           Indirect Write cassete block
     A004             (      romdefs.asm):00357         DIndCasOnRead                   EQU     $A004           Indirect prepare cassette for read
     A00C             (      romdefs.asm):00358         DIndCasWriteLead                EQU     $A00C           Indirect Write cassette leader
     A002             (      romdefs.asm):00359         DIndCharOutput                  EQU     $A002           Indirect Character output
     A00A             (      romdefs.asm):00360         DIndJoystickIn                  EQU     $A00A           Indirect joystick in
     A000             (      romdefs.asm):00361         DIndKeyInput                    EQU     $A000           Indirect keyboard input jsr()
     0072             (      romdefs.asm):00362         DIndVecReset                    EQU     $0072           Secondary Reset vector address, must point to NOP
     008A             (      romdefs.asm):00363         DMisc16BitScratch               EQU     $008A           Misc 16 bit scratch register (always zero ??)
     A66B             (      romdefs.asm):00364         DPixMaskTable2Col               EQU     $A66B           Pixel mask table 2 colour mode
     A673             (      romdefs.asm):00365         DPixMaskTable4Col               EQU     $A673           Pixel mask table 4 colour mode
     BD0A             (      romdefs.asm):00366         DPrinterCRLF                    EQU     $BD0A           Moves printer head to next line.
     BCF5             (      romdefs.asm):00367         DPrinterDirOut                  EQU     $BCF5           Sends character in A register to printer (uncooked)
     BD1A             (      romdefs.asm):00368         DPrinterOut                     EQU     $BD1A           Sends character in A register to printer
     010F             (      romdefs.asm):00369         DSecVecFIRQ                     EQU     $010F           Secondary FIRQ vector JMP+ address
     010C             (      romdefs.asm):00370         DSecVecIRQ                      EQU     $010C           Secondary IRQ vector JMP+ address
     0109             (      romdefs.asm):00371         DSecVecNMI                      EQU     $0109           Secondary NMI vector JMP+ address
     0106             (      romdefs.asm):00372         DSecVecSWI                      EQU     $0106           Secondary NMI vector JMP+ address
     0103             (      romdefs.asm):00373         DSecVecSWI2                     EQU     $0103           Secondary SWI2 vector JMP+ address
     0100             (      romdefs.asm):00374         DSecVecSWI3                     EQU     $0100           Secondary SWI3 vector JMP+ address
     0000             (      romdefs.asm):00375         DSerDLBaud                      EQU     $0000           Baud rate for DLOAD, unknown for Dragon
     0000             (      romdefs.asm):00376         DSerDLTimeout                   EQU     $0000           Timeourt for DLOAD, unknown for Dragon
     BAA0             (      romdefs.asm):00377         DSndBeep                        EQU     $BAA0           Play a beep duration in B, frequency in SndPitch
     BAC3             (      romdefs.asm):00378         DSndDisable                     EQU     $BAC3           Disables D/A sound output
     00E5             (      romdefs.asm):00379         DSndDotNoteScale                EQU     $00E5           Dotted note scale factor for Play
     BAED             (      romdefs.asm):00380         DSndDTOAOn                      EQU     $BAED           Turn on audio to D/A converter
     BAC5             (      romdefs.asm):00381         DSndEnable                      EQU     $BAC5           Enables D/A sound output
     008D             (      romdefs.asm):00382         DSndLength                      EQU     $008D           Sound duration
     00E1             (      romdefs.asm):00383         DSndNoteLen                     EQU     $00E1           Note length for PLAY
     00DE             (      romdefs.asm):00384         DSndOctave                      EQU     $00DE           Sound octave value for PLAY
     008C             (      romdefs.asm):00385         DSndPitch                       EQU     $008C           Sound pitch value
     AE9A             (      romdefs.asm):00386         DSndPlayNote                    EQU     $AE9A           Plays a note from the A register (ASCII)
     00E2             (      romdefs.asm):00387         DSndTempo                       EQU     $00E2           Tempo for PLAY
     00E3             (      romdefs.asm):00388         DSndTimerPlay                   EQU     $00E3           Timer for the Play command
     00DF             (      romdefs.asm):00389         DSndVolume                      EQU     $00DF           Sound volume for PLAY
     BB80             (      romdefs.asm):00390         DSysBoot64                      EQU     $BB80           Dragon 64 only, boots basic into all ram mode, with 48K available to basic.
     8344             (      romdefs.asm):00391         DSysErr                         EQU     $8344           Report error code in B register, cleanup and return to basic
     835E             (      romdefs.asm):00392         DSysErr2                        EQU     $835E           Report error in B, do NOT hook to RAM, or turn of cas etc
     BD52             (      romdefs.asm):00393         DSysReadJoystick                EQU     $BD52           Read hardware joystick values & update BasJoyVal0..3
     B3B4             (      romdefs.asm):00394         DSysReset                       EQU     $B3B4           Perform soft reset, as if reset button pressed
     BAD4             (      romdefs.asm):00395         DSysResetDA                     EQU     $BAD4           Reset D/A converter to $7E
     BD41             (      romdefs.asm):00396         DSysSelJoystick                 EQU     $BD41           Select joystick alue to read from A
     0112             (      romdefs.asm):00397         DSysTimeVal                     EQU     $0112           Current value of system timer
     BAD6             (      romdefs.asm):00398         DSysWriteDA                     EQU     $BAD6           Write value in A to D/A, bits 0 &1 should be 0
     0149             (      romdefs.asm):00399         DTextCapsLock                   EQU     $0149           Capslock flag, nonzero=uppercase
     BCA0             (      romdefs.asm):00400         DTextClearLine                  EQU     $BCA0           Clears a VDU line from current cursor pos to EOL
     BA77             (      romdefs.asm):00401         DTextCls                        EQU     $BA77           Clear text mode screen, resets cursor to top left
     BA79             (      romdefs.asm):00402         DTextClsChar                    EQU     $BA79           Clears srcrren to character in B register & resets cursor
     008F             (      romdefs.asm):00403         DTextCursFalshCnt               EQU     $008F           Cusrsor flash counter
     006F             (      romdefs.asm):00404         DTextDevN                       EQU     $006F           Current device number
     0035             (      romdefs.asm):00405         DTextKbdBuffAddr                EQU     $0035           Address of keyboard input buffer
     0097             (      romdefs.asm):00406         DTextKbdDelay                   EQU     $0097           Keyboard scan delay constant, used to debounce
     0150             (      romdefs.asm):00407         DTextKbdRollover                EQU     $0150           Rollover table, to check for key releases
     0087             (      romdefs.asm):00408         DTextLastKey                    EQU     $0087           ASCII code of last keypress, not cleard by key release
     B54A             (      romdefs.asm):00409         DTextOutChar                    EQU     $B54A           Outputs character in A to screen
     90A1             (      romdefs.asm):00410         DTextOutCRLF                    EQU     $90A1           Outputs an EOL sequence to the screen
     957A             (      romdefs.asm):00411         DTextOutNum16                   EQU     $957A           Outputs unsigned integer in D to the TextDevN device
     9582             (      romdefs.asm):00412         DTextOutNumFPA0                 EQU     $9582           Outputs number in FPA0 to screen
     90F8             (      romdefs.asm):00413         DTextOutQuestion                EQU     $90F8           Outputs a question mark to screen
     90F5             (      romdefs.asm):00414         DTextOutSpace                   EQU     $90F5           Outputs a space to screen
     90E5             (      romdefs.asm):00415         DTextOutString                  EQU     $90E5           Outputs string pointed to by X to screen, X should point to byte before first byte of string
     0148             (      romdefs.asm):00416         DTextPrnAutoCRLF                EQU     $0148           Printer auto EOL flag, nonzero will send EOL sequence at end of line
     0099             (      romdefs.asm):00417         DTextPrnCommaW                  EQU     $0099           Printer comma width
     009C             (      romdefs.asm):00418         DTextPrnCurrCol                 EQU     $009C           Printer current column
     014A             (      romdefs.asm):00419         DTextPrnEOLCnt                  EQU     $014A           Number of characters in EOL sequence 1..4
     014B             (      romdefs.asm):00420         DTextPrnEOLSeq                  EQU     $014B           End of line characters
     009A             (      romdefs.asm):00421         DTextPrnLastComma               EQU     $009A           Printer last comma width, should be printer line width - prinnter comma width
     009B             (      romdefs.asm):00422         DTextPrnLineW                   EQU     $009B           Printer line width
     03FF             (      romdefs.asm):00423         DTextPrnSelFlag                 EQU     $03FF           Dragon 64 printer selection flag, 0=paralell port, nonzero=RS232
     A93A             (      romdefs.asm):00424         DTextResetVDU                   EQU     $A93A           Resets to text mode and screen base address of $400
     BBE5             (      romdefs.asm):00425         DTextScanKbd                    EQU     $BBE5           Scan keyboard, return Char in A, Zero flag set if no key
     FF07             (      romdefs.asm):00426         DTextSerBaudRate                EQU     $FF07           Serial baud rate, note on Dragon 64, this is the actual hardware baud rate reg.
     03FD             (      romdefs.asm):00427         DTextSerEOLDelay                EQU     $03FD           End of line delay for serial port on Dragon 64 & CoCo
     BBB5             (      romdefs.asm):00428         DTextUpdateCurs                 EQU     $BBB5           Decrements TextCursFlashCnt, if zero resets and flashes cursor
     006A             (      romdefs.asm):00429         DTextVDUCommaW                  EQU     $006A           VDU comma width field
     006C             (      romdefs.asm):00430         DTextVDUCurrCol                 EQU     $006C           Current column for VDU output
     0088             (      romdefs.asm):00431         DTextVDUCursAddr                EQU     $0088           Current VDU cursor address
     006B             (      romdefs.asm):00432         DTextVDULastComma               EQU     $006B           VDU last comma field, should be VDU line width - VDU comma width
     006D             (      romdefs.asm):00433         DTextVDULineW                   EQU     $006D           VDU line width, normally 32
     BCAB             (      romdefs.asm):00434         DTextVDUOut                     EQU     $BCAB           Outputs Char in A to VDU, does not reset screen.
     852B             (      romdefs.asm):00435         DTextWaitKey                    EQU     $852B           Wait for a keypress, calls TextScanKbd, also handles break
     A0EA             (      romdefs.asm):00436         DTextWaitKeyCurs                EQU     $A0EA           Same as TextWaitKey, but with cursor
     B505             (      romdefs.asm):00437         DTextWaitKeyCurs2               EQU     $B505           Same as TextWaitKey, but with cursor
     B7CC             (      romdefs.asm):00438         DUtilCopyBXtoU                  EQU     $B7CC           Copy B bytes from X to U
     8C35             (      romdefs.asm):00439         DVarAssign16Bit                 EQU     $8C35           Assigns value in D register to a variable, and returns to basic
     8C37             (      romdefs.asm):00440         DVarAssign16Bit2                EQU     $8C37           Assigns value in D register to a variable, and returns to basic (1 less instruction!).
     9C3E             (      romdefs.asm):00441         DVarAssign16BitB                EQU     $9C3E           Assigns value in BasVarAssign16 to a variable, and returns to basic
     8C36             (      romdefs.asm):00442         DVarAssign8Bit                  EQU     $8C36           Assigns value in B register to a variable, and returns to basic
     89AC             (      romdefs.asm):00443         DVarCKChar                      EQU     $89AC           Check for char in B register in command line, SNError if not
     89A4             (      romdefs.asm):00444         DVarCKClBrac                    EQU     $89A4           Check for Close bracket ')' in command line, SNError if not
     89AA             (      romdefs.asm):00445         DVarCKComma                     EQU     $89AA           Check for Comma in command line, SNError if not
     89A7             (      romdefs.asm):00446         DVarCKOpBrac                    EQU     $89A7           Check for Open bracket '(' in command line, SNError if not
     8D9F             (      romdefs.asm):00447         DVarDelVar                      EQU     $8D9F           Frees up storage used by a variable
     8CD7             (      romdefs.asm):00448         DVarGarbageCollect              EQU     $8CD7           Forces garbage collection in string space
     8E83             (      romdefs.asm):00449         DVarGet16Bit                    EQU     $8E83           Returns value of variable in D,FCError if more than 16 bits
     8E51             (      romdefs.asm):00450         DVarGet8Bit                     EQU     $8E51           Returns value of variable in B,FCError if more than 8 bits
     8E7E             (      romdefs.asm):00451         DVarGetComma8                   EQU     $8E7E           Checks for comman then gets 8 bit.
     8877             (      romdefs.asm):00452         DVarGetExpr                     EQU     $8877           Evaluate and put the VARPTR of experssion which follows in BasVarAssign16 (carry set)
     8874             (      romdefs.asm):00453         DVarGetExprCC                   EQU     $8874           Evaluate and put the VARPTR of experssion which follows in BasVarAssign16 (carry clear)
     8887             (      romdefs.asm):00454         DVarGetStr                      EQU     $8887           Compiles string and moves to free string space, should be followed by VarGetExpr
     8B29             (      romdefs.asm):00455         DVarGetUsr                      EQU     $8B29           Returns argument to USRnn as a 16bit no in D
     8A94             (      romdefs.asm):00456         DVarGetVar                      EQU     $8A94           Gets VARPTR address of following name and places in BasVarPtrLast
     9165             (      romdefs.asm):00457         DVarNormFPA0                    EQU     $9165           Normalize FPA0
     01A0             (      romdefs.asm):00458         DVectAccessScreen               EQU     $01A0           Called before CLS, GET & PUT are executed
     019D             (      romdefs.asm):00459         DVectAssignStr                  EQU     $019D           Called before assigning string to string variable
     015E             (      romdefs.asm):00460         DVectBase                       EQU     $015E           Base address of ram hooks/vectors
     0188             (      romdefs.asm):00461         DVectCheckEOF                   EQU     $0188           called before checking for end of file
     017F             (      romdefs.asm):00462         DVectCheckKeys                  EQU     $017F           Called before keyboard is scanned for BREAK,SHIFT-@
     0173             (      romdefs.asm):00463         DVectCloseAllFiles              EQU     $0173           Called before closing all files
     0176             (      romdefs.asm):00464         DVectCloseFile                  EQU     $0176           Called before closing a file
     0185             (      romdefs.asm):00465         DVectCloseFileCmd               EQU     $0185           Called before closing an ASCII file read in as basic
     0179             (      romdefs.asm):00466         DVectCmdInterp                  EQU     $0179           Called before interpreting a token in A
     01A6             (      romdefs.asm):00467         DVectDeTokenize                 EQU     $01A6           Called before a line is de-tokenized
     0164             (      romdefs.asm):00468         DVectDevInit                    EQU     $0164           Called before initialising a device
     0161             (      romdefs.asm):00469         DVectDevNo                      EQU     $0161           Called when a device number is verified
     015E             (      romdefs.asm):00470         DVectDevOpen                    EQU     $015E           Called before a device is opened
     018B             (      romdefs.asm):00471         DVectEvaluateExpr               EQU     $018B           Called before evaluating expression
     019A             (      romdefs.asm):00472         DVectGetNextCmd                 EQU     $019A           Called before fetching next command to be executed by BASIC
     016A             (      romdefs.asm):00473         DVectInChar                     EQU     $016A           Called before inputting a char to A
     016D             (      romdefs.asm):00474         DVectInputFile                  EQU     $016D           Called before inputting from a file
     0182             (      romdefs.asm):00475         DVectLineInputFile              EQU     $0182           Called before LINE INPUT is executed
     0167             (      romdefs.asm):00476         DVectOutChar                    EQU     $0167           Called before outputting char in A to a device
     0170             (      romdefs.asm):00477         DVectOutputFile                 EQU     $0170           Called before outputting to a file
     017C             (      romdefs.asm):00478         DVectReReqestIn                 EQU     $017C           Called before re-requesing input from keyboard
     0197             (      romdefs.asm):00479         DVectResetBasMem                EQU     $0197           Called before changing BASIC memory vectors after LOAD etc
     0194             (      romdefs.asm):00480         DVectRunLink                    EQU     $0194           Called when RUN about to be executed
     0191             (      romdefs.asm):00481         DVectSysError                   EQU     $0191           Can be patched by system to trap error messages
     01A3             (      romdefs.asm):00482         DVectTokenize                   EQU     $01A3           Called before an ASCII line is tokenized
     018E             (      romdefs.asm):00483         DVectUserError                  EQU     $018E           Can be patched by user to trap error messages
     B44F             (      romdefs.asm):00484         DWarmStart                      EQU     $B44F           Warm start routine
     0071             (      romdefs.asm):00485         DWarmStartFlag                  EQU     $0071           Warm start flag $55=warm start, else cold start
                      (      romdefs.asm):00486         
     0000             (      romdefs.asm):00487         CStubResWordsOfs                EQU     $0000           Offset of number of reserved words
     0001             (      romdefs.asm):00488         CStubResLookupOfs               EQU     $0001           Offset of reserved word lookup table
     0003             (      romdefs.asm):00489         CStubResJumpOfs                 EQU     $0003           Offset of reserved word jump table
     0005             (      romdefs.asm):00490         CStubFuncsOfs                   EQU     $0005           Offset of nummber of functions
     0006             (      romdefs.asm):00491         CStubFuncsLookupOfs             EQU     $0006           Offset of function lookup table
     0008             (      romdefs.asm):00492         CStubFuncsJumpOfs               EQU     $0008           Offset of functions jump table
                      (      romdefs.asm):00493         
     0021             (      romdefs.asm):00494         CSkip1                          EQU     $0021           Skip 1 byte (BRN)
     008C             (      romdefs.asm):00495         CSkip2                          EQU     $008C           Skip 2 bytes (CMPX)
     0086             (      romdefs.asm):00496         CSkip1LD                        EQU     $0086           Skip 1 byte (LDA)
     007D             (      romdefs.asm):00497         CSkip2TST                       EQU     $007D           Skip 2 bytes (TST)
                      (      romdefs.asm):00498         
     8273             (      romdefs.asm):00499         CCoCoVec167                     EQU     $8273           Vector dest for 167 
     8CF1             (      romdefs.asm):00500         CCoCoVect16A                    EQU     $8CF1           Vector dest for 16A
     8286             (      romdefs.asm):00501         CCoCoVect176                    EQU     $8286           Vector dest for 176
     8E90             (      romdefs.asm):00502         CCoCoVect179                    EQU     $8E90           Vector dest for 179
     8846             (      romdefs.asm):00503         CCoCoVect18B                    EQU     $8846           Vector dest for 18B
     88F0             (      romdefs.asm):00504         CCoCoVect191                    EQU     $88F0           Vector dest for 191
     829C             (      romdefs.asm):00505         CCoCoVect194                    EQU     $829C           Vector Dest for 194
     87E5             (      romdefs.asm):00506         CCoCoVect197                    EQU     $87E5           Vector Dest for 197
     82B9             (      romdefs.asm):00507         CCoCoVect19A                    EQU     $82B9           Vector Dest for 19A
     8304             (      romdefs.asm):00508         CCoCoVect1A3                    EQU     $8304           Vector Dest for 1A3
     0027             (      romdefs.asm):00509         CAddrFWareRamTop                EQU     $0027           Top of firmware RAM CLEAR xxx,yyyy set this to yyyy
     0074             (      romdefs.asm):00510         CAddrRamTop                     EQU     $0074           Physical end of RAM (4K, 16K, 32K or 64K).
     0021             (      romdefs.asm):00511         CAddrStack                      EQU     $0021           Address of top of machine stack
     0123             (      romdefs.asm):00512         CBasAddrCmdDisp                 EQU     $0123           Address of basic command dispatch
     0121             (      romdefs.asm):00513         CBasAddrCmdList                 EQU     $0121           Address of basic command list
     012D             (      romdefs.asm):00514         CBasAddrDskCmdDisp              EQU     $012D           Address of disk basic command dispatch
     012B             (      romdefs.asm):00515         CBasAddrDskCmdList              EQU     $012B           Address of disk basic command list
     0132             (      romdefs.asm):00516         CBasAddrDskFuncDisp             EQU     $0132           Address of disk basic function dispatcher
     0130             (      romdefs.asm):00517         CBasAddrDskFuncList             EQU     $0130           Address of disk basic function list
     0128             (      romdefs.asm):00518         CBasAddrFuncDisp                EQU     $0128           Address of basic function dispatcher
     0126             (      romdefs.asm):00519         CBasAddrFuncList                EQU     $0126           Address of basic function list
     00A6             (      romdefs.asm):00520         CBasAddrSigByte                 EQU     $00A6           Address of current significant bit in command line
     A61C             (      romdefs.asm):00521         CBasAOError                     EQU     $A61C           Print ?AO Error and return to basic
     0005             (      romdefs.asm):00522         CBasArrayEval                   EQU     $0005           Array evaluation flag, 0=eval, 1=dimensioning
     A0B6             (      romdefs.asm):00523         CBasBootBasic                   EQU     $A0B6           Restart basic, as if power on, also deletes current program
     0017             (      romdefs.asm):00524         CBasBotStack                    EQU     $0017           Bottom of stack at last check
     ADC4             (      romdefs.asm):00525         CBasBRARun                      EQU     $ADC4           BRA to main loop, used by DOS
     0000             (      romdefs.asm):00526         CBasBreakFlag                   EQU     $0000           Break flag, +ve=stop,-ve=end
     03D7             (      romdefs.asm):00527         CBasBuffer                      EQU     $03D7           Basic buffer space
     AC1E             (      romdefs.asm):00528         CBasChkArrSpaceMv               EQU     $AC1E           Check memory space at top of arrays + move arrays
     AC33             (      romdefs.asm):00529         CBasChkB2Free                   EQU     $AC33           Check B*2 bytes free above Arrays, OM error if not
     8866             (      romdefs.asm):00530         CBasChkDirect                   EQU     $8866           Check for direct mode, ID Error if so
     009F             (      romdefs.asm):00531         CBasChrGet                      EQU     $009F           Get next basic character routine
     00A5             (      romdefs.asm):00532         CBasChrGetCurr                  EQU     $00A5           Get current basic ccharacter
     00D3             (      romdefs.asm):00533         CBasCloadMOffs                  EQU     $00D3           2s complement of CLOADM offset
     AC73             (      romdefs.asm):00534         CBasCmdMode                     EQU     $AC73           Return to command mode
     0029             (      romdefs.asm):00535         CBasContLine                    EQU     $0029           Line no used by CONT
     0068             (      romdefs.asm):00536         CBasCurrentLine                 EQU     $0068           Current line no $FFFF in direct mode
     0001             (      romdefs.asm):00537         CBasDelim1                      EQU     $0001           First string delimiter
     0002             (      romdefs.asm):00538         CBasDelim2                      EQU     $0002           Second string delimiter
     002F             (      romdefs.asm):00539         CBasDirectTextPtr               EQU     $002F           Direct mode text pointer
     0008             (      romdefs.asm):00540         CBasDisArraySearch              EQU     $0008           Disable array search flag, 0=allow 0<>disable
     A61F             (      romdefs.asm):00541         CBasDNError                     EQU     $A61F           Print ?DN Error and return to basic
     ADD4             (      romdefs.asm):00542         CBasDoDispatch                  EQU     $ADD4           Do command dispatech, X must point to dispatch table
     00D7             (      romdefs.asm):00543         CBasEditorLineLen               EQU     $00D7           Editor line length
     ABAF             (      romdefs.asm):00544         CBasErrorCodeTable              EQU     $ABAF           List of 2 byte error codes eg 'SN' 'OM' 'UL' etc
     009D             (      romdefs.asm):00545         CBasExecAddr                    EQU     $009D           Exec address, on D64, at startup points to routine to boot all ram mode
     B44A             (      romdefs.asm):00546         CBasFCError                     EQU     $B44A           Print ?FC Error and return to basic
     AD01             (      romdefs.asm):00547         CBasFindLineNo                  EQU     $AD01           Find a line number in basic program
     A616             (      romdefs.asm):00548         CBasFMError                     EQU     $A616           Print ?FM Error and return to basic
     0007             (      romdefs.asm):00549         CBasGarbageFlag                 EQU     $0007           Garbage collection flag
     0003             (      romdefs.asm):00550         CBasGenCount                    EQU     $0003           General count/scratch var
     A5A2             (      romdefs.asm):00551         CBasGetDevNo                    EQU     $A5A2           Get dev no from line & validate
     AF67             (      romdefs.asm):00552         CBasGetLineNo                   EQU     $AF67           Get line no and store in BasTempLine
     B6A4             (      romdefs.asm):00553         CBasGetStrFirst                 EQU     $B6A4           Get first character of string into B
     B654             (      romdefs.asm):00554         CBasGetStrLenAddr               EQU     $B654           Get string len in B and address in X of string desc in FPA2
     A755             (      romdefs.asm):00555         CBasicCassBitIn                 EQU     $A755           Cassette bit input
     A749             (      romdefs.asm):00556         CBasicCassByIn                  EQU     $A749           Cassette byte input
     A82A             (      romdefs.asm):00557         CBasicCassByOut                 EQU     $A82A           Cassette byte output
     A7EB             (      romdefs.asm):00558         CBasicCassOff                   EQU     $A7EB           Cassette player motor off
     A7CA             (      romdefs.asm):00559         CBasicCassOn                    EQU     $A7CA           Cassette player motor on
     A77C             (      romdefs.asm):00560         CBasicCassOnRd                  EQU     $A77C           Cassette on for reading
     A199             (      romdefs.asm):00561         CBasicCursorB                   EQU     $A199           Cursor blink
     0000             (      romdefs.asm):00562         CBasicHWInit                    EQU     $0000           Hardware initialisation
     A9DE             (      romdefs.asm):00563         CBasicJoyIn                     EQU     $A9DE           Joystick input
     A1C1             (      romdefs.asm):00564         CBasicKbdIn                     EQU     $A1C1           Keyboard input
     A2BF             (      romdefs.asm):00565         CBasicPrintOut                  EQU     $A2BF           Printer output
     A30A             (      romdefs.asm):00566         CBasicScreenOut                 EQU     $A30A           Screen output
     0000             (      romdefs.asm):00567         CBasicSerIn                     EQU     $0000           Read a byte from serial
     0000             (      romdefs.asm):00568         CBasicSerOut                    EQU     $0000           Write a byte to serial port
     0000             (      romdefs.asm):00569         CBasicSetBaud                   EQU     $0000           Set baud rate
     0000             (      romdefs.asm):00570         CBasicSWInit                    EQU     $0000           Software initialisation
     A7D8             (      romdefs.asm):00571         CBasicWriteLead                 EQU     $A7D8           Cassette write leader
     886C             (      romdefs.asm):00572         CBasIDError                     EQU     $886C           Print ?ID Error and return to basic
     0004             (      romdefs.asm):00573         CBasIfCount                     EQU     $0004           If count - how many in a line
     A39D             (      romdefs.asm):00574         CBasInBuffFromX                 EQU     $A39D           Read input buffer at X as basic input
     0009             (      romdefs.asm):00575         CBasInputFlag                   EQU     $0009           Iinput/read flag, 0=input 0<>read
     A619             (      romdefs.asm):00576         CBasIOError                     EQU     $A619           Print ?IO Error and return to basic
     A9B3             (      romdefs.asm):00577         CBasIRQVec                      EQU     $A9B3           Basic IRQ routine, increments timer
     015A             (      romdefs.asm):00578         CBasJoyVal0                     EQU     $015A           Joystick(0) value
     015B             (      romdefs.asm):00579         CBasJoyVal1                     EQU     $015B           Joystick(1) value
     015C             (      romdefs.asm):00580         CBasJoyVal2                     EQU     $015C           Joystick(2) value
     015D             (      romdefs.asm):00581         CBasJoyVal3                     EQU     $015D           Joystick(3) value
     89E8             (      romdefs.asm):00582         CBasLineInputEntry              EQU     $89E8           Entry into LINE INPUT routine, used by DOS
     02DC             (      romdefs.asm):00583         CBasLinInpBuff                  EQU     $02DC           Basic line input buffer
     02DA             (      romdefs.asm):00584         CBasLinInpHead                  EQU     $02DA           Basic line input buffer header
     B764             (      romdefs.asm):00585         CBasList                        EQU     $B764           List basic program to SysDevN A must be 0 on entry
     0066             (      romdefs.asm):00586         CBasListLine                    EQU     $0066           Current line during list
     96EC             (      romdefs.asm):00587         CBasLocateScreen                EQU     $96EC           Initialise beginning of basic after graphics screen, no of pages in A
     B625             (      romdefs.asm):00588         CBasLSError                     EQU     $B625           Print ?LS Error and return to basic
     8CDD             (      romdefs.asm):00589         CBasNEError                     EQU     $8CDD           Print ?NE Error and return to basic
     AD19             (      romdefs.asm):00590         CBasNew                         EQU     $AD19           Remove current basic program from meory, like NEW command
     A3FB             (      romdefs.asm):00591         CBasNOError                     EQU     $A3FB           Print ?NO Error and return to basic
     0120             (      romdefs.asm):00592         CBasNumCmds                     EQU     $0120           Number of basic commands
     012A             (      romdefs.asm):00593         CBasNumDskCmds                  EQU     $012A           Number of disk basic commands
     012F             (      romdefs.asm):00594         CBasNumDskFuncs                 EQU     $012F           Number of disk basic functions
     0125             (      romdefs.asm):00595         CBasNumFuncs                    EQU     $0125           Number of basic functions
     002D             (      romdefs.asm):00596         CBasOldInputPtr                 EQU     $002D           Pointer to saved input during a STOP
     AC44             (      romdefs.asm):00597         CBasOMError                     EQU     $AC44           Print ?OM Error and return to basic
     BA92             (      romdefs.asm):00598         CBasOVError                     EQU     $BA92           Print ?OV Error and return to basic
     ADEB             (      romdefs.asm):00599         CBasPollKeyboard                EQU     $ADEB           Basic, poll keyboard and check for break
     BF3B             (      romdefs.asm):00600         CBasRandom8                     EQU     $BF3B           Generate an 8 bit random number and place in BasRandomSeed+1
     0115             (      romdefs.asm):00601         CBasRandomSeed                  EQU     $0115           Random number seed for RND function
     000A             (      romdefs.asm):00602         CBasRelateFlag                  EQU     $000A           Relational operator flag
     00D1             (      romdefs.asm):00603         CBasRenumStart                  EQU     $00D1           Renum start line no
     00D5             (      romdefs.asm):00604         CBasRenumStartLine              EQU     $00D5           Renum start line number
     00CF             (      romdefs.asm):00605         CBasRenumVal                    EQU     $00CF           Renum increment value
     AD33             (      romdefs.asm):00606         CBasResetStack                  EQU     $AD33           Reset basic stack to initial position
     B50F             (      romdefs.asm):00607         CBasResStr                      EQU     $B50F           Reserve B bytes of string space return start in X, setup low mem vars
     B56D             (      romdefs.asm):00608         CBasResStr2                     EQU     $B56D           Reserve B bytes of string space return start in X
     00AB             (      romdefs.asm):00609         CBasRndData                     EQU     $00AB           Used by RND
     AD9E             (      romdefs.asm):00610         CBasRun                         EQU     $AD9E           Run basic program in memory, like RUN
     AEBB             (      romdefs.asm):00611         CBasSetProgPtrX                 EQU     $AEBB           Sets basic program pointer to X-1
     80E7             (      romdefs.asm):00612         CBasSignonMess                  EQU     $80E7           Signon message address, for CoCo this is for Extended basic.
     AEB4             (      romdefs.asm):00613         CBasSkipLineNo                  EQU     $AEB4           Skip past line no in basic line, UL error if no line no.
     B277             (      romdefs.asm):00614         CBasSNError                     EQU     $B277           Print ?SN Error and return to basic
     0019             (      romdefs.asm):00615         CBasStartProg                   EQU     $0019           Start addr of basic program
     B553             (      romdefs.asm):00616         CBasSTError                     EQU     $B553           Print ?OM Error and return to basic
     01A9             (      romdefs.asm):00617         CBasStrDescStack                EQU     $01A9           String descriptor stack
     000B             (      romdefs.asm):00618         CBasStrFirstFreeTemp            EQU     $000B           First free temory string space pointer
     000D             (      romdefs.asm):00619         CBasStrLastUsedTemp             EQU     $000D           Last used tempory string space pointer
     0025             (      romdefs.asm):00620         CBasStrUtil                     EQU     $0025           Utility string pointer
     0120             (      romdefs.asm):00621         CBasStub0                       EQU     $0120           Basic Stub 0 (All basic on Dragon, Colour basic on Tandy)
     012A             (      romdefs.asm):00622         CBasStub1                       EQU     $012A           Basic stub 1 (Disk basic on Dragon, Extended basic on Tandy)
     0134             (      romdefs.asm):00623         CBasStub2                       EQU     $0134           Basic Stub 2 (Null on dragon, Disk basic on Tandy)
     013E             (      romdefs.asm):00624         CBasStub3                       EQU     $013E           Basic Stub 3 (do not use on dragon, user stub on Tandy)
     0013             (      romdefs.asm):00625         CBasTempFPA2                    EQU     $0013           Tempory FPA Mantissa for FPA2
     002B             (      romdefs.asm):00626         CBasTempLine                    EQU     $002B           Tempory line no
     000F             (      romdefs.asm):00627         CBasTempPtr                     EQU     $000F           Tempory pointer
     0011             (      romdefs.asm):00628         CBasTempPtr1                    EQU     $0011           Tempory discriptor pointer (stack search)
     003F             (      romdefs.asm):00629         CBasTempRelateFlag              EQU     $003F           Tempory relational operator flag
     003B             (      romdefs.asm):00630         CBasTempVarDesc                 EQU     $003B           Pointer to a tempory var descriptor
     B151             (      romdefs.asm):00631         CBasTMError                     EQU     $B151           Print ?TM Error and return to basic
     00AF             (      romdefs.asm):00632         CBasTronFlag                    EQU     $00AF           Tron flag nonzero=trace on
     AED2             (      romdefs.asm):00633         CBasULError                     EQU     $AED2           Print ?UL Error and return to basic
     0076             (      romdefs.asm):00634         CBasUnused1                     EQU     $0076           2 unused bytes
     00B0             (      romdefs.asm):00635         CBasUSRTableAddr                EQU     $00B0           Address of USR address table
     013E             (      romdefs.asm):00636         CBasUsrVecNoDisk                EQU     $013E           USR vector tabl when basic not installed
     001D             (      romdefs.asm):00637         CBasVarArrayAddr                EQU     $001D           Start address of Array table
     0052             (      romdefs.asm):00638         CBasVarAssign16                 EQU     $0052           Part of FPA1, used for 16bit assigns
     0033             (      romdefs.asm):00639         CBasVarDataAddr                 EQU     $0033           Address of next item in data
     0031             (      romdefs.asm):00640         CBasVarDataLine                 EQU     $0031           Line number of current data statement
     001F             (      romdefs.asm):00641         CBasVarEnd                      EQU     $001F           End of storage in use by basic
     004F             (      romdefs.asm):00642         CBasVarFPAcc1                   EQU     $004F           Floating point acumulator 1
     005C             (      romdefs.asm):00643         CBasVarFPAcc2                   EQU     $005C           Floating point acumulator 2
     0040             (      romdefs.asm):00644         CBasVarFPAcc3                   EQU     $0040           Floating point accumulator 3 (packed)
     0045             (      romdefs.asm):00645         CBasVarFPAcc4                   EQU     $0045           Floating point accumulator 4 (packed)
     004A             (      romdefs.asm):00646         CBasVarFPAcc5                   EQU     $004A           Floating point accumulator 5 (packed)
     0037             (      romdefs.asm):00647         CBasVarLastInUse                EQU     $0037           Pointer to variable last in use
     0039             (      romdefs.asm):00648         CBasVarPtrLast                  EQU     $0039           Poiinter to VARPTR last in use
     001B             (      romdefs.asm):00649         CBasVarSimpleAddr               EQU     $001B           Start address of simple variables
     0021             (      romdefs.asm):00650         CBasVarStringBase               EQU     $0021           Base address of string space (and stack)
     0023             (      romdefs.asm):00651         CBasVarStrTop                   EQU     $0023           Top of string space in use
     0006             (      romdefs.asm):00652         CBasVarType                     EQU     $0006           Variable type flag 0=numeric, $ff=string
     AD21             (      romdefs.asm):00653         CBasVect1                       EQU     $AD21           Sets up various basic vectors (after load), should be followed by call to BasVect2
     AD26             (      romdefs.asm):00654         CBasVect1a                      EQU     $AD26           Same as Vect1, but doesn't reset input pointer
     ACEF             (      romdefs.asm):00655         CBasVect2                       EQU     $ACEF           Finalises setup of basic vectors (after load), should be preceeded by call to BasVect1
     BC06             (      romdefs.asm):00656         CBasZDError                     EQU     $BC06           Print ?ZD Error and return to basic
     01E3             (      romdefs.asm):00657         CCasASCIIFlag                   EQU     $01E3           ASCII flag byte
     A974             (      romdefs.asm):00658         CCasAudioOff                    EQU     $A974           Turn off audio from cassette
     A99D             (      romdefs.asm):00659         CCasAudioOn                     EQU     $A99D           Turn on Audio from cassete to speaker
     0083             (      romdefs.asm):00660         CCasBitCount                    EQU     $0083           Cassette bit counter
     A755             (      romdefs.asm):00661         CCasBitIn                       EQU     $A755           Reads a bity into the 'Z' flag
     A70B             (      romdefs.asm):00662         CCasBlockIn                     EQU     $A70B           Reads a block into the cassete buffer pointed to by CasIOBuffAddr
     007D             (      romdefs.asm):00663         CCasBlockLen                    EQU     $007D           Cassete block length, number of bytes read, or to be written
     A7F4             (      romdefs.asm):00664         CCasBlockOut                    EQU     $A7F4           Write a block to cassete pointed to by CasIOBuffAddr
     007C             (      romdefs.asm):00665         CCasBlockType                   EQU     $007C           Cassete block type, 0=filename, 1=data, 255=EOF
     A749             (      romdefs.asm):00666         CCasByteIn                      EQU     $A749           Reads a single byte into the A register
     A82A             (      romdefs.asm):00667         CCasByteOut                     EQU     $A82A           Write byte in A register to cassete
     0080             (      romdefs.asm):00668         CCasCkSum                       EQU     $0080           Used by cassette routines for calculating checksum
     A429             (      romdefs.asm):00669         CCasClosFiles                   EQU     $A429           Close any open cassete file
     01E5             (      romdefs.asm):00670         CCasEntryAddr                   EQU     $01E5           Entry address for MC programs
     0070             (      romdefs.asm):00671         CCasEOFFlag                     EQU     $0070           Cassette IO Flag, nonzero if EOF reached
     A681             (      romdefs.asm):00672         CCasFindFile                    EQU     $A681           Searches a tape for specified filename
     01D2             (      romdefs.asm):00673         CCasFName                       EQU     $01D2           Cassete filename to search for or write out
     01DA             (      romdefs.asm):00674         CCasFNameFound                  EQU     $01DA           Filename found, when reading
     01D1             (      romdefs.asm):00675         CCasFNameLen                    EQU     $01D1           Length of cassette filename can be 0 to 8
     01E2             (      romdefs.asm):00676         CCasFType                       EQU     $01E2           File type 0=tokenized basic, 1=ASCII data, 2=Binary
     01E4             (      romdefs.asm):00677         CCasGapFlag                     EQU     $01E4           Gap flag byte
     007A             (      romdefs.asm):00678         CCasHeadBuffAddr                EQU     $007A           Address of cassette file header
     01DA             (      romdefs.asm):00679         CCasIOBuff                      EQU     $01DA           COS default IO buffer, if this contains filename block then folloing are valid
     007E             (      romdefs.asm):00680         CCasIOBuffAddr                  EQU     $007E           Cassette IO buffer address, where data will be read/written
     0079             (      romdefs.asm):00681         CCasIOBuffSize                  EQU     $0079           Size of cassette IO buffer
     0081             (      romdefs.asm):00682         CCasIOErrorCode                 EQU     $0081           Cassette IO error code 0=no error, 1=CRC, 2=attempt to load in non-ram area
     006E             (      romdefs.asm):00683         CCasIOFlag                      EQU     $006E           Cassette IO Flag, set to $FF when IO in progress
     0085             (      romdefs.asm):00684         CCasLastSine                    EQU     $0085           Casette last sine tabe entry
     0092             (      romdefs.asm):00685         CCasLeadCount                   EQU     $0092           Cassete leader count, number of $55 bytes in the leader
     01E7             (      romdefs.asm):00686         CCasLoadAddr                    EQU     $01E7           Load address
     0091             (      romdefs.asm):00687         CCasMax12                       EQU     $0091           Cassette Upper limit of 1200Hz
     0092             (      romdefs.asm):00688         CCasMax24                       EQU     $0092           Cassette Upper limit of 2400Hz
     008A             (      romdefs.asm):00689         CCasMotorDelay                  EQU     $008A           Cassette motor on delay (also inter-block gap)
     A7EB             (      romdefs.asm):00690         CCasMotorOff                    EQU     $A7EB           Turn off cassette motor
     A7CA             (      romdefs.asm):00691         CCasMotorOn                     EQU     $A7CA           Turn on motor, and wait for delay in CasMotorDelay
     008F             (      romdefs.asm):00692         CCasPartrt                      EQU     $008F           Cassette 1200/2400 partition
     0084             (      romdefs.asm):00693         CCasPhaseFlag                   EQU     $0084           Cassette Phase flag
     A511             (      romdefs.asm):00694         CCasReadBin                     EQU     $A511           Read in a binary file, similar to CLOADM
     A701             (      romdefs.asm):00695         CCasReadBlock1                  EQU     $A701           Turns on motor, reads header and then first block into CasIOBufAddr
     A77C             (      romdefs.asm):00696         CCasReadLeader                  EQU     $A77C           Turn on motor and read past leader
     0078             (      romdefs.asm):00697         CCasStatus                      EQU     $0078           Cassette status byte, 0=cassette closed, 1=open for input, 2=open for output
     0082             (      romdefs.asm):00698         CCasTemp                        EQU     $0082           Cassette tempory storage
     A469             (      romdefs.asm):00699         CCasWriteBasic                  EQU     $A469           Write tokenized basic program out, similar to CSAVE
     833D             (      romdefs.asm):00700         CCasWriteBin                    EQU     $833D           Write a binary file out push return address, then start,end and entry addresses and then JMP to this
     A7E5             (      romdefs.asm):00701         CCasWriteBlock1                 EQU     $A7E5           Turn on motor, write leader and then first block
     A7D8             (      romdefs.asm):00702         CCasWriteLeader                 EQU     $A7D8           Turn on motor and write out leader
     BC93             (      romdefs.asm):00703         CCmdABS                         EQU     $BC93           Basic Command
     B2D5             (      romdefs.asm):00704         CCmdAND                         EQU     $B2D5           Basic Command
     B6A0             (      romdefs.asm):00705         CCmdASC                         EQU     $B6A0           Basic Command
     83B0             (      romdefs.asm):00706         CCmdATN                         EQU     $83B0           Basic Command
     A990             (      romdefs.asm):00707         CCmdAudio                       EQU     $A990           Basic Command
     B68C             (      romdefs.asm):00708         CCmdCHRS                        EQU     $B68C           Basic Command
     9E9D             (      romdefs.asm):00709         CCmdCircle                      EQU     $9E9D           Basic Command
     AE41             (      romdefs.asm):00710         CCmdClear                       EQU     $AE41           Basic Command
     A498             (      romdefs.asm):00711         CCmdCload                       EQU     $A498           Basic Command
     A416             (      romdefs.asm):00712         CCmdClose                       EQU     $A416           Basic Command
     A910             (      romdefs.asm):00713         CCmdCLS                         EQU     $A910           Basic Command
     9546             (      romdefs.asm):00714         CCmdColor                       EQU     $9546           Basic Command
     AE30             (      romdefs.asm):00715         CCmdCont                        EQU     $AE30           Basic Command
     8378             (      romdefs.asm):00716         CCmdCOS                         EQU     $8378           Basic Command
     A44C             (      romdefs.asm):00717         CCmdCsave                       EQU     $A44C           Basic Command
     AEE0             (      romdefs.asm):00718         CCmdData                        EQU     $AEE0           Basic Command
     8871             (      romdefs.asm):00719         CCmdDef                         EQU     $8871           Basic Command
     8970             (      romdefs.asm):00720         CCmdDelete                      EQU     $8970           Basic Command
     B34E             (      romdefs.asm):00721         CCmdDim                         EQU     $B34E           Basic Command
     BB91             (      romdefs.asm):00722         CCmdDivide                      EQU     $BB91           Basic Command
     8C18             (      romdefs.asm):00723         CCmdDload                       EQU     $8C18           Basic Command
     9CB6             (      romdefs.asm):00724         CCmdDraw                        EQU     $9CB6           Basic Command
     8533             (      romdefs.asm):00725         CCmdEdit                        EQU     $8533           Basic Command
     AE02             (      romdefs.asm):00726         CCmdEnd                         EQU     $AE02           Basic Command
     A5CE             (      romdefs.asm):00727         CCmdEOF                         EQU     $A5CE           Basic Command
     A53E             (      romdefs.asm):00728         CCmdExec                        EQU     $A53E           Basic Command
     84F2             (      romdefs.asm):00729         CCmdEXP                         EQU     $84F2           Basic Command
     011D             (      romdefs.asm):00730         CCmdExponet                     EQU     $011D           Basic Command
     8524             (      romdefs.asm):00731         CCmdFIX                         EQU     $8524           Basic Command
     AD47             (      romdefs.asm):00732         CCmdFor                         EQU     $AD47           Basic Command
     9755             (      romdefs.asm):00733         CCmdGet                         EQU     $9755           Basic Command
     AE86             (      romdefs.asm):00734         CCmdGo                          EQU     $AE86           Basic Command
     8BDD             (      romdefs.asm):00735         CCmdHexS                        EQU     $8BDD           Basic Command
     AF14             (      romdefs.asm):00736         CCmdIF                          EQU     $AF14           Basic Command
     A564             (      romdefs.asm):00737         CCmdInkeyS                      EQU     $A564           Basic Command
     AFF5             (      romdefs.asm):00738         CCmdInput                       EQU     $AFF5           Basic Command
     877E             (      romdefs.asm):00739         CCmdInstr                       EQU     $877E           Basic Command
     BCEE             (      romdefs.asm):00740         CCmdINT                         EQU     $BCEE           Basic Command
     A9C6             (      romdefs.asm):00741         CCmdJoystk                      EQU     $A9C6           Basic Command
     B6AB             (      romdefs.asm):00742         CCmdLeftS                       EQU     $B6AB           Basic Command
     B681             (      romdefs.asm):00743         CCmdLEN                         EQU     $B681           Basic Command
     AF89             (      romdefs.asm):00744         CCmdLet                         EQU     $AF89           Basic Command
     93BB             (      romdefs.asm):00745         CCmdLine                        EQU     $93BB           Basic Command
     89C0             (      romdefs.asm):00746         CCmdLineInput                   EQU     $89C0           Line input command
     B764             (      romdefs.asm):00747         CCmdList                        EQU     $B764           Basic Command
     B75E             (      romdefs.asm):00748         CCmdLList                       EQU     $B75E           Basic Command
     8446             (      romdefs.asm):00749         CCmdLOG                         EQU     $8446           Basic Command
     B4EE             (      romdefs.asm):00750         CCmdMEM                         EQU     $B4EE           Basic Command
     B6CF             (      romdefs.asm):00751         CCmdMidS                        EQU     $B6CF           Basic Command
     B9BC             (      romdefs.asm):00752         CCmdMinus                       EQU     $B9BC           Basic Command
     A7BD             (      romdefs.asm):00753         CCmdMotor                       EQU     $A7BD           Basic Command
     BACC             (      romdefs.asm):00754         CCmdMultiply                    EQU     $BACC           Basic Command
     AD17             (      romdefs.asm):00755         CCmdNew                         EQU     $AD17           Basic Command
     B0F8             (      romdefs.asm):00756         CCmdNext                        EQU     $B0F8           Basic Command
     AF42             (      romdefs.asm):00757         CCmdON                          EQU     $AF42           Basic Command
     A5F6             (      romdefs.asm):00758         CCmdOpen                        EQU     $A5F6           Basic Command
     A603             (      romdefs.asm):00759         CCmdOpenEntry                   EQU     $A603           Entry into Basic open command used by Dragon/SuperDos
     B2D4             (      romdefs.asm):00760         CCmdOR                          EQU     $B2D4           Basic Command
     98EC             (      romdefs.asm):00761         CCmdPaint                       EQU     $98EC           Basic Command
     968B             (      romdefs.asm):00762         CCmdPClear                      EQU     $968B           Basic Command
     9532             (      romdefs.asm):00763         CCmdPCls                        EQU     $9532           Basic Command
     9723             (      romdefs.asm):00764         CCmdPcopy                       EQU     $9723           Basic Command
     B750             (      romdefs.asm):00765         CCmdPeek                        EQU     $B750           Basic Command
     9A22             (      romdefs.asm):00766         CCmdPlay                        EQU     $9A22           Basic Command
     B9C5             (      romdefs.asm):00767         CCmdPlus                        EQU     $B9C5           Basic Command
     9621             (      romdefs.asm):00768         CCmdPmode                       EQU     $9621           Basic Command
     A8F5             (      romdefs.asm):00769         CCmdPoint                       EQU     $A8F5           Basic Command
     B757             (      romdefs.asm):00770         CCmdPoke                        EQU     $B757           Basic Command
     86AC             (      romdefs.asm):00771         CCmdPOS                         EQU     $86AC           Basic Command
     9339             (      romdefs.asm):00772         CCmdPPoint                      EQU     $9339           Basic Command
     9365             (      romdefs.asm):00773         CCmdPReset                      EQU     $9365           Basic Command
     B8F7             (      romdefs.asm):00774         CCmdPrint                       EQU     $B8F7           Basic Command
     9361             (      romdefs.asm):00775         CCmdPset                        EQU     $9361           Basic Command
     9758             (      romdefs.asm):00776         CCmdPut                         EQU     $9758           Basic Command
     B046             (      romdefs.asm):00777         CCmdRead                        EQU     $B046           Basic Command
     B049             (      romdefs.asm):00778         CCmdReadFromX                   EQU     $B049           As basic READ command but ptr in X supplied by caller
     AEE3             (      romdefs.asm):00779         CCmdREM                         EQU     $AEE3           Basic Command
     8A09             (      romdefs.asm):00780         CCmdRenum                       EQU     $8A09           Basic Command
     A8B1             (      romdefs.asm):00781         CCmdReset                       EQU     $A8B1           Basic Command
     ADE4             (      romdefs.asm):00782         CCmdRestore                     EQU     $ADE4           Basic Command
     AEC0             (      romdefs.asm):00783         CCmdReturn                      EQU     $AEC0           Basic Command
     B6C8             (      romdefs.asm):00784         CCmdRightS                      EQU     $B6C8           Basic Command
     BF1F             (      romdefs.asm):00785         CCmdRND                         EQU     $BF1F           Basic Command
     AE75             (      romdefs.asm):00786         CCmdRun                         EQU     $AE75           Basic Command
     9670             (      romdefs.asm):00787         CCmdScreen                      EQU     $9670           Basic Command
     A880             (      romdefs.asm):00788         CCmdSet                         EQU     $A880           Basic Command
     BC7A             (      romdefs.asm):00789         CCmdSGN                         EQU     $BC7A           Basic Command
     BF78             (      romdefs.asm):00790         CCmdSIN                         EQU     $BF78           Basic Command
     A5EC             (      romdefs.asm):00791         CCmdSkipf                       EQU     $A5EC           Basic Command
     A94B             (      romdefs.asm):00792         CCmdSound                       EQU     $A94B           Basic Command
     8480             (      romdefs.asm):00793         CCmdSQR                         EQU     $8480           Basic Command
     AE09             (      romdefs.asm):00794         CCmdStop                        EQU     $AE09           Basic Command
     874E             (      romdefs.asm):00795         CCmdStringS                     EQU     $874E           Basic Command
     B4FD             (      romdefs.asm):00796         CCmdSTRS                        EQU     $B4FD           Basic Command
     8381             (      romdefs.asm):00797         CCmdTAN                         EQU     $8381           Basic Command
     8968             (      romdefs.asm):00798         CCmdTimer                       EQU     $8968           Basic Command
     86A8             (      romdefs.asm):00799         CCmdTroff                       EQU     $86A8           Basic Command
     86A7             (      romdefs.asm):00800         CCmdTron                        EQU     $86A7           Basic Command
     0112             (      romdefs.asm):00801         CCmdUSR                         EQU     $0112           Basic Command
     B716             (      romdefs.asm):00802         CCmdVAL                         EQU     $B716           Basic Command
     86BE             (      romdefs.asm):00803         CCmdVarptr                      EQU     $86BE           Basic Command
     00B3             (      romdefs.asm):00804         CGrBackground                   EQU     $00B3           Current background colour
     00B9             (      romdefs.asm):00805         CGrBytesPerLine                 EQU     $00B9           Number of byts/lin in current mode
     A8D9             (      romdefs.asm):00806         CGrCalcPixelPos                 EQU     $A8D9           Calculates Lo-res pixel pos from data on stack
     00D0             (      romdefs.asm):00807         CGrCircleRadius                 EQU     $00D0           Circle radius
     00CB             (      romdefs.asm):00808         CGrCircleXCo                    EQU     $00CB           Circle command X
     00CD             (      romdefs.asm):00809         CGrCircleYCo                    EQU     $00CD           Circle command Y
     9539             (      romdefs.asm):00810         CGrClearGrScreen                EQU     $9539           Clears grapics screen to value in B
     00C1             (      romdefs.asm):00811         CGrColourSet                    EQU     $00C1           Colour set currently in use
     00B4             (      romdefs.asm):00812         CGrColourTemp                   EQU     $00B4           Tempory colour in use
     00B5             (      romdefs.asm):00813         CGrCurrColour                   EQU     $00B5           Byte value for current colour, to set all pixels in byte to that colour
     00B6             (      romdefs.asm):00814         CGrCurrPmode                    EQU     $00B6           Current PMODE number
     00BD             (      romdefs.asm):00815         CGrCurrX                        EQU     $00BD           Current X cursor pos
     00C7             (      romdefs.asm):00816         CGrCurrXCo                      EQU     $00C7           Current Cursor X
     00BF             (      romdefs.asm):00817         CGrCurrY                        EQU     $00BF           Current Y cursor pos
     00C9             (      romdefs.asm):00818         CGrCurrYCo                      EQU     $00C9           Current Cursor Y
     00DB             (      romdefs.asm):00819         CGrDirtyFlag                    EQU     $00DB           Flag to tell if graphics screen has changed
     00BA             (      romdefs.asm):00820         CGrDisplayStartAddr             EQU     $00BA           Address of first byte in current display
     9CB6             (      romdefs.asm):00821         CGrDraw                         EQU     $9CB6           Draw on pmode screen as in DRAW command
     00E8             (      romdefs.asm):00822         CGrDrawAngle                    EQU     $00E8           Current angle for DRAW command
     00E9             (      romdefs.asm):00823         CGrDrawScale                    EQU     $00E9           Current scale for DRAW command
     00B2             (      romdefs.asm):00824         CGrForeground                   EQU     $00B2           Current foreground colour
     00B7             (      romdefs.asm):00825         CGrLastDisplayAddr              EQU     $00B7           Address of last byte in current display
     00C3             (      romdefs.asm):00826         CGrPixelNoX                     EQU     $00C3           Current horizontal pixel no
     00C5             (      romdefs.asm):00827         CGrPixelNoY                     EQU     $00C5           Current vertical pixel number
     00C2             (      romdefs.asm):00828         CGrPlotFlag                     EQU     $00C2           Plot/Unplot flag, 0=reset, nonzero=set
     9695             (      romdefs.asm):00829         CGrReserveGrRam                 EQU     $9695           Reserves memory for graphics, no graphics pages in B
     A8B5             (      romdefs.asm):00830         CGrResetLRGPixel                EQU     $A8B5           ReSets lo res pixel
     9682             (      romdefs.asm):00831         CGrSelectColourSet              EQU     $9682           Selects colour set dependent on B
     95AA             (      romdefs.asm):00832         CGrSelectDisplay                EQU     $95AA           Sets Text or Graphics screen, if Z=1 then text
     9653             (      romdefs.asm):00833         CGrSelectPage                   EQU     $9653           On entry B contains Pmode page to be used
     9616             (      romdefs.asm):00834         CGrSelectVDGColSet              EQU     $9616           Select colour set from data in GrColourSet
     959A             (      romdefs.asm):00835         CGrSetColours                   EQU     $959A           Sets up colours in low memory
     A88D             (      romdefs.asm):00836         CGrSetLRGPixel                  EQU     $A88D           Sets lo res pixel
     0086             (      romdefs.asm):00837         CGrSetResetData                 EQU     $0086           Data for Lo-res set/reset
     95FB             (      romdefs.asm):00838         CGrSetVDGMode                   EQU     $95FB           Set VDG to mode in A register
     960F             (      romdefs.asm):00839         CGrSetVDGOffset                 EQU     $960F           Set VDG offset to page in A
     00BC             (      romdefs.asm):00840         CGrStartPages                   EQU     $00BC           Page number of Start of graphics pages
     A006             (      romdefs.asm):00841         CIndCasBlockIn                  EQU     $A006           Indirect Read cassette block
     A008             (      romdefs.asm):00842         CIndCasBlockOut                 EQU     $A008           Indirect Write cassete block
     A004             (      romdefs.asm):00843         CIndCasOnRead                   EQU     $A004           Indirect prepare cassette for read
     A00C             (      romdefs.asm):00844         CIndCasWriteLead                EQU     $A00C           Indirect Write cassette leader
     A002             (      romdefs.asm):00845         CIndCharOutput                  EQU     $A002           Indirect Character output
     A00A             (      romdefs.asm):00846         CIndJoystickIn                  EQU     $A00A           Indirect joystick in
     A000             (      romdefs.asm):00847         CIndKeyInput                    EQU     $A000           Indirect keyboard input jsr()
     0072             (      romdefs.asm):00848         CIndVecReset                    EQU     $0072           Secondary Reset vector address, must point to NOP
     008A             (      romdefs.asm):00849         CMisc16BitScratch               EQU     $008A           Misc 16 bit scratch register (always zero ??)
     92DD             (      romdefs.asm):00850         CPixMaskTable2Col               EQU     $92DD           Pixel mask table 2 colour mode
     92E5             (      romdefs.asm):00851         CPixMaskTable4Col               EQU     $92E5           Pixel mask table 4 colour mode
     0000             (      romdefs.asm):00852         CPrinterCRLF                    EQU     $0000           Moves printer head to next line.
     0000             (      romdefs.asm):00853         CPrinterDirOut                  EQU     $0000           Sends character in A register to printer (uncooked)
     A2BF             (      romdefs.asm):00854         CPrinterOut                     EQU     $A2BF           Sends character in A register to printer
     010F             (      romdefs.asm):00855         CSecVecFIRQ                     EQU     $010F           Secondary FIRQ vector JMP+ address
     010C             (      romdefs.asm):00856         CSecVecIRQ                      EQU     $010C           Secondary IRQ vector JMP+ address
     0109             (      romdefs.asm):00857         CSecVecNMI                      EQU     $0109           Secondary NMI vector JMP+ address
     0106             (      romdefs.asm):00858         CSecVecSWI                      EQU     $0106           Secondary NMI vector JMP+ address
     0103             (      romdefs.asm):00859         CSecVecSWI2                     EQU     $0103           Secondary SWI2 vector JMP+ address
     0100             (      romdefs.asm):00860         CSecVecSWI3                     EQU     $0100           Secondary SWI3 vector JMP+ address
     00E6             (      romdefs.asm):00861         CSerDLBaud                      EQU     $00E6           Baud rate for DLOAD, unknown for Dragon
     00E7             (      romdefs.asm):00862         CSerDLTimeout                   EQU     $00E7           Timeourt for DLOAD, unknown for Dragon
     A951             (      romdefs.asm):00863         CSndBeep                        EQU     $A951           Play a beep duration in B, frequency in SndPitch
     A974             (      romdefs.asm):00864         CSndDisable                     EQU     $A974           Disables D/A sound output
     00E5             (      romdefs.asm):00865         CSndDotNoteScale                EQU     $00E5           Dotted note scale factor for Play
     A99E             (      romdefs.asm):00866         CSndDTOAOn                      EQU     $A99E           Turn on audio to D/A converter
     A976             (      romdefs.asm):00867         CSndEnable                      EQU     $A976           Enables D/A sound output
     008D             (      romdefs.asm):00868         CSndLength                      EQU     $008D           Sound duration
     00E1             (      romdefs.asm):00869         CSndNoteLen                     EQU     $00E1           Note length for PLAY
     00DE             (      romdefs.asm):00870         CSndOctave                      EQU     $00DE           Sound octave value for PLAY
     008C             (      romdefs.asm):00871         CSndPitch                       EQU     $008C           Sound pitch value
     9AFF             (      romdefs.asm):00872         CSndPlayNote                    EQU     $9AFF           Plays a note from the A register (ASCII)
     00E2             (      romdefs.asm):00873         CSndTempo                       EQU     $00E2           Tempo for PLAY
     00E3             (      romdefs.asm):00874         CSndTimerPlay                   EQU     $00E3           Timer for the Play command
     00DF             (      romdefs.asm):00875         CSndVolume                      EQU     $00DF           Sound volume for PLAY
     0000             (      romdefs.asm):00876         CSysBoot64                      EQU     $0000           Dragon 64 only, boots basic into all ram mode, with 48K available to basic.
     AC46             (      romdefs.asm):00877         CSysErr                         EQU     $AC46           Report error code in B register, cleanup and return to basic
     AC60             (      romdefs.asm):00878         CSysErr2                        EQU     $AC60           Report error in B, do NOT hook to RAM, or turn of cas etc
     A9DE             (      romdefs.asm):00879         CSysReadJoystick                EQU     $A9DE           Read hardware joystick values & update BasJoyVal0..3
     A027             (      romdefs.asm):00880         CSysReset                       EQU     $A027           Perform soft reset, as if reset button pressed
     A985             (      romdefs.asm):00881         CSysResetDA                     EQU     $A985           Reset D/A converter to $7E
     A9A2             (      romdefs.asm):00882         CSysSelJoystick                 EQU     $A9A2           Select joystick alue to read from A
     0112             (      romdefs.asm):00883         CSysTimeVal                     EQU     $0112           Current value of system timer
     A987             (      romdefs.asm):00884         CSysWriteDA                     EQU     $A987           Write value in A to D/A, bits 0 &1 should be 0
     011A             (      romdefs.asm):00885         CTextCapsLock                   EQU     $011A           Capslock flag, nonzero=uppercase
     A323             (      romdefs.asm):00886         CTextClearLine                  EQU     $A323           Clears a VDU line from current cursor pos to EOL
     A928             (      romdefs.asm):00887         CTextCls                        EQU     $A928           Clear text mode screen, resets cursor to top left
     A92A             (      romdefs.asm):00888         CTextClsChar                    EQU     $A92A           Clears srcrren to character in B register & resets cursor
     008F             (      romdefs.asm):00889         CTextCursFalshCnt               EQU     $008F           Cusrsor flash counter
     006F             (      romdefs.asm):00890         CTextDevN                       EQU     $006F           Current device number
     0035             (      romdefs.asm):00891         CTextKbdBuffAddr                EQU     $0035           Address of keyboard input buffer
     011B             (      romdefs.asm):00892         CTextKbdDelay                   EQU     $011B           Keyboard scan delay constant, used to debounce
     0152             (      romdefs.asm):00893         CTextKbdRollover                EQU     $0152           Rollover table, to check for key releases
     0087             (      romdefs.asm):00894         CTextLastKey                    EQU     $0087           ASCII code of last keypress, not cleard by key release
     A282             (      romdefs.asm):00895         CTextOutChar                    EQU     $A282           Outputs character in A to screen
     B958             (      romdefs.asm):00896         CTextOutCRLF                    EQU     $B958           Outputs an EOL sequence to the screen
     BDCC             (      romdefs.asm):00897         CTextOutNum16                   EQU     $BDCC           Outputs unsigned integer in D to the TextDevN device
     BDD4             (      romdefs.asm):00898         CTextOutNumFPA0                 EQU     $BDD4           Outputs number in FPA0 to screen
     B9AF             (      romdefs.asm):00899         CTextOutQuestion                EQU     $B9AF           Outputs a question mark to screen
     B9AC             (      romdefs.asm):00900         CTextOutSpace                   EQU     $B9AC           Outputs a space to screen
     B99C             (      romdefs.asm):00901         CTextOutString                  EQU     $B99C           Outputs string pointed to by X to screen, X should point to byte before first byte of string
     0148             (      romdefs.asm):00902         CTextPrnAutoCRLF                EQU     $0148           Printer auto EOL flag, nonzero will send EOL sequence at end of line
     0099             (      romdefs.asm):00903         CTextPrnCommaW                  EQU     $0099           Printer comma width
     009C             (      romdefs.asm):00904         CTextPrnCurrCol                 EQU     $009C           Printer current column
     014A             (      romdefs.asm):00905         CTextPrnEOLCnt                  EQU     $014A           Number of characters in EOL sequence 1..4
     014B             (      romdefs.asm):00906         CTextPrnEOLSeq                  EQU     $014B           End of line characters
     009A             (      romdefs.asm):00907         CTextPrnLastComma               EQU     $009A           Printer last comma width, should be printer line width - prinnter comma width
     009B             (      romdefs.asm):00908         CTextPrnLineW                   EQU     $009B           Printer line width
     03FF             (      romdefs.asm):00909         CTextPrnSelFlag                 EQU     $03FF           Dragon 64 printer selection flag, 0=paralell port, nonzero=RS232
     95AC             (      romdefs.asm):00910         CTextResetVDU                   EQU     $95AC           Resets to text mode and screen base address of $400
     A1C1             (      romdefs.asm):00911         CTextScanKbd                    EQU     $A1C1           Scan keyboard, return Char in A, Zero flag set if no key
     0095             (      romdefs.asm):00912         CTextSerBaudRate                EQU     $0095           Serial baud rate, note on Dragon 64, this is the actual hardware baud rate reg.
     0097             (      romdefs.asm):00913         CTextSerEOLDelay                EQU     $0097           End of line delay for serial port on Dragon 64 & CoCo
     A199             (      romdefs.asm):00914         CTextUpdateCurs                 EQU     $A199           Decrements TextCursFlashCnt, if zero resets and flashes cursor
     006A             (      romdefs.asm):00915         CTextVDUCommaW                  EQU     $006A           VDU comma width field
     006C             (      romdefs.asm):00916         CTextVDUCurrCol                 EQU     $006C           Current column for VDU output
     0088             (      romdefs.asm):00917         CTextVDUCursAddr                EQU     $0088           Current VDU cursor address
     006B             (      romdefs.asm):00918         CTextVDULastComma               EQU     $006B           VDU last comma field, should be VDU line width - VDU comma width
     006D             (      romdefs.asm):00919         CTextVDULineW                   EQU     $006D           VDU line width, normally 32
     A30A             (      romdefs.asm):00920         CTextVDUOut                     EQU     $A30A           Outputs Char in A to VDU, does not reset screen.
     ADFB             (      romdefs.asm):00921         CTextWaitKey                    EQU     $ADFB           Wait for a keypress, calls TextScanKbd, also handles break
     8CC6             (      romdefs.asm):00922         CTextWaitKeyCurs                EQU     $8CC6           Same as TextWaitKey, but with cursor
     A171             (      romdefs.asm):00923         CTextWaitKeyCurs2               EQU     $A171           Same as TextWaitKey, but with cursor
     A59A             (      romdefs.asm):00924         CUtilCopyBXtoU                  EQU     $A59A           Copy B bytes from X to U
     B4F2             (      romdefs.asm):00925         CVarAssign16Bit                 EQU     $B4F2           Assigns value in D register to a variable, and returns to basic
     B4F3             (      romdefs.asm):00926         CVarAssign16Bit2                EQU     $B4F3           Assigns value in D register to a variable, and returns to basic (1 less instruction!).
     880E             (      romdefs.asm):00927         CVarAssign16BitB                EQU     $880E           Assigns value in BasVarAssign16 to a variable, and returns to basic
     B4F3             (      romdefs.asm):00928         CVarAssign8Bit                  EQU     $B4F3           Assigns value in B register to a variable, and returns to basic
     B26F             (      romdefs.asm):00929         CVarCKChar                      EQU     $B26F           Check for char in B register in command line, SNError if not
     B267             (      romdefs.asm):00930         CVarCKClBrac                    EQU     $B267           Check for Close bracket ')' in command line, SNError if not
     B26D             (      romdefs.asm):00931         CVarCKComma                     EQU     $B26D           Check for Comma in command line, SNError if not
     B26A             (      romdefs.asm):00932         CVarCKOpBrac                    EQU     $B26A           Check for Open bracket '(' in command line, SNError if not
     B659             (      romdefs.asm):00933         CVarDelVar                      EQU     $B659           Frees up storage used by a variable
     B591             (      romdefs.asm):00934         CVarGarbageCollect              EQU     $B591           Forces garbage collection in string space
     B73D             (      romdefs.asm):00935         CVarGet16Bit                    EQU     $B73D           Returns value of variable in D,FCError if more than 16 bits
     B70B             (      romdefs.asm):00936         CVarGet8Bit                     EQU     $B70B           Returns value of variable in B,FCError if more than 8 bits
     B738             (      romdefs.asm):00937         CVarGetComma8                   EQU     $B738           Checks for comman then gets 8 bit.
     B146             (      romdefs.asm):00938         CVarGetExpr                     EQU     $B146           Evaluate and put the VARPTR of experssion which follows in BasVarAssign16 (carry set)
     B143             (      romdefs.asm):00939         CVarGetExprCC                   EQU     $B143           Evaluate and put the VARPTR of experssion which follows in BasVarAssign16 (carry clear)
     B156             (      romdefs.asm):00940         CVarGetStr                      EQU     $B156           Compiles string and moves to free string space, should be followed by VarGetExpr
     B3E9             (      romdefs.asm):00941         CVarGetUsr                      EQU     $B3E9           Returns argument to USRnn as a 16bit no in D
     B357             (      romdefs.asm):00942         CVarGetVar                      EQU     $B357           Gets VARPTR address of following name and places in BasVarPtrLast
     BA1C             (      romdefs.asm):00943         CVarNormFPA0                    EQU     $BA1C           Normalize FPA0
     01A0             (      romdefs.asm):00944         CVectAccessScreen               EQU     $01A0           Called before CLS, GET & PUT are executed
     019D             (      romdefs.asm):00945         CVectAssignStr                  EQU     $019D           Called before assigning string to string variable
     015E             (      romdefs.asm):00946         CVectBase                       EQU     $015E           Base address of ram hooks/vectors
     0188             (      romdefs.asm):00947         CVectCheckEOF                   EQU     $0188           called before checking for end of file
     017F             (      romdefs.asm):00948         CVectCheckKeys                  EQU     $017F           Called before keyboard is scanned for BREAK,SHIFT-@
     0173             (      romdefs.asm):00949         CVectCloseAllFiles              EQU     $0173           Called before closing all files
     0176             (      romdefs.asm):00950         CVectCloseFile                  EQU     $0176           Called before closing a file
     0185             (      romdefs.asm):00951         CVectCloseFileCmd               EQU     $0185           Called before closing an ASCII file read in as basic
     0179             (      romdefs.asm):00952         CVectCmdInterp                  EQU     $0179           Called before interpreting a token in A
     01A6             (      romdefs.asm):00953         CVectDeTokenize                 EQU     $01A6           Called before a line is de-tokenized
     0164             (      romdefs.asm):00954         CVectDevInit                    EQU     $0164           Called before initialising a device
     0161             (      romdefs.asm):00955         CVectDevNo                      EQU     $0161           Called when a device number is verified
     015E             (      romdefs.asm):00956         CVectDevOpen                    EQU     $015E           Called before a device is opened
     018B             (      romdefs.asm):00957         CVectEvaluateExpr               EQU     $018B           Called before evaluating expression
     019A             (      romdefs.asm):00958         CVectGetNextCmd                 EQU     $019A           Called before fetching next command to be executed by BASIC
     016A             (      romdefs.asm):00959         CVectInChar                     EQU     $016A           Called before inputting a char to A
     016D             (      romdefs.asm):00960         CVectInputFile                  EQU     $016D           Called before inputting from a file
     0182             (      romdefs.asm):00961         CVectLineInputFile              EQU     $0182           Called before LINE INPUT is executed
     0167             (      romdefs.asm):00962         CVectOutChar                    EQU     $0167           Called before outputting char in A to a device
     0170             (      romdefs.asm):00963         CVectOutputFile                 EQU     $0170           Called before outputting to a file
     017C             (      romdefs.asm):00964         CVectReReqestIn                 EQU     $017C           Called before re-requesing input from keyboard
     0197             (      romdefs.asm):00965         CVectResetBasMem                EQU     $0197           Called before changing BASIC memory vectors after LOAD etc
     0194             (      romdefs.asm):00966         CVectRunLink                    EQU     $0194           Called when RUN about to be executed
     0191             (      romdefs.asm):00967         CVectSysError                   EQU     $0191           Can be patched by system to trap error messages
     01A3             (      romdefs.asm):00968         CVectTokenize                   EQU     $01A3           Called before an ASCII line is tokenized
     018E             (      romdefs.asm):00969         CVectUserError                  EQU     $018E           Can be patched by user to trap error messages
     80C0             (      romdefs.asm):00970         CWarmStart                      EQU     $80C0           Warm start routine
     0071             (      romdefs.asm):00971         CWarmStartFlag                  EQU     $0071           Warm start flag $55=warm start, else cold start
                      (      romdefs.asm):00972         
                      (      romdefs.asm):00973                                 ifdef Dragon
                      (      romdefs.asm):00974         
     0000             (      romdefs.asm):00975         StubResWordsOfs         EQU     DStubResWordsOfs
     0001             (      romdefs.asm):00976         StubResLookupOfs                EQU     DStubResLookupOfs
     0003             (      romdefs.asm):00977         StubResJumpOfs                  EQU     DStubResJumpOfs
     0005             (      romdefs.asm):00978         StubFuncsOfs                    EQU     DStubFuncsOfs
     0006             (      romdefs.asm):00979         StubFuncsLookupOfs              EQU     DStubFuncsLookupOfs
     0008             (      romdefs.asm):00980         StubFuncsJumpOfs                EQU     DStubFuncsJumpOfs
     0021             (      romdefs.asm):00981         Skip1                           EQU     DSkip1
     008C             (      romdefs.asm):00982         Skip2                           EQU     DSkip2
     0086             (      romdefs.asm):00983         Skip1LD                         EQU     DSkip1LD
     007D             (      romdefs.asm):00984         Skip2TST                        EQU     DSkip2TST
     0000             (      romdefs.asm):00985         CoCoVec167                      EQU     DCoCoVec167
     0000             (      romdefs.asm):00986         CoCoVect16A                     EQU     DCoCoVect16A
     0000             (      romdefs.asm):00987         CoCoVect176                     EQU     DCoCoVect176
     0000             (      romdefs.asm):00988         CoCoVect179                     EQU     DCoCoVect179
     0000             (      romdefs.asm):00989         CoCoVect18B                     EQU     DCoCoVect18B
     0000             (      romdefs.asm):00990         CoCoVect191                     EQU     DCoCoVect191
     0000             (      romdefs.asm):00991         CoCoVect194                     EQU     DCoCoVect194
     0000             (      romdefs.asm):00992         CoCoVect197                     EQU     DCoCoVect197
     0000             (      romdefs.asm):00993         CoCoVect19A                     EQU     DCoCoVect19A
     0000             (      romdefs.asm):00994         CoCoVect1A3                     EQU     DCoCoVect1A3
     0027             (      romdefs.asm):00995         AddrFWareRamTop                 EQU     DAddrFWareRamTop
     0074             (      romdefs.asm):00996         AddrRamTop                      EQU     DAddrRamTop
     0021             (      romdefs.asm):00997         AddrStack                       EQU     DAddrStack
     0123             (      romdefs.asm):00998         BasAddrCmdDisp                  EQU     DBasAddrCmdDisp
     0121             (      romdefs.asm):00999         BasAddrCmdList                  EQU     DBasAddrCmdList
     012D             (      romdefs.asm):01000         BasAddrDskCmdDisp               EQU     DBasAddrDskCmdDisp
     012B             (      romdefs.asm):01001         BasAddrDskCmdList               EQU     DBasAddrDskCmdList
     0132             (      romdefs.asm):01002         BasAddrDskFuncDisp              EQU     DBasAddrDskFuncDisp
     0130             (      romdefs.asm):01003         BasAddrDskFuncList              EQU     DBasAddrDskFuncList
     0128             (      romdefs.asm):01004         BasAddrFuncDisp                 EQU     DBasAddrFuncDisp
     0126             (      romdefs.asm):01005         BasAddrFuncList                 EQU     DBasAddrFuncList
     00A6             (      romdefs.asm):01006         BasAddrSigByte                  EQU     DBasAddrSigByte
     B84E             (      romdefs.asm):01007         BasAOError                      EQU     DBasAOError
     0005             (      romdefs.asm):01008         BasArrayEval                    EQU     DBasArrayEval
     B400             (      romdefs.asm):01009         BasBootBasic                    EQU     DBasBootBasic
     0017             (      romdefs.asm):01010         BasBotStack                     EQU     DBasBotStack
     84DA             (      romdefs.asm):01011         BasBRARun                       EQU     DBasBRARun
     0000             (      romdefs.asm):01012         BasBreakFlag                    EQU     DBasBreakFlag
     03D7             (      romdefs.asm):01013         BasBuffer                       EQU     DBasBuffer
     831C             (      romdefs.asm):01014         BasChkArrSpaceMv                EQU     DBasChkArrSpaceMv
     8331             (      romdefs.asm):01015         BasChkB2Free                    EQU     DBasChkB2Free
     9C76             (      romdefs.asm):01016         BasChkDirect                    EQU     DBasChkDirect
     009F             (      romdefs.asm):01017         BasChrGet                       EQU     DBasChrGet
     00A5             (      romdefs.asm):01018         BasChrGetCurr                   EQU     DBasChrGetCurr
     00D3             (      romdefs.asm):01019         BasCloadMOffs                   EQU     DBasCloadMOffs
     8371             (      romdefs.asm):01020         BasCmdMode                      EQU     DBasCmdMode
     0029             (      romdefs.asm):01021         BasContLine                     EQU     DBasContLine
     0068             (      romdefs.asm):01022         BasCurrentLine                  EQU     DBasCurrentLine
     0001             (      romdefs.asm):01023         BasDelim1                       EQU     DBasDelim1
     0002             (      romdefs.asm):01024         BasDelim2                       EQU     DBasDelim2
     002F             (      romdefs.asm):01025         BasDirectTextPtr                EQU     DBasDirectTextPtr
     0008             (      romdefs.asm):01026         BasDisArraySearch               EQU     DBasDisArraySearch
     B851             (      romdefs.asm):01027         BasDNError                      EQU     DBasDNError
     84ED             (      romdefs.asm):01028         BasDoDispatch                   EQU     DBasDoDispatch
     00D7             (      romdefs.asm):01029         BasEditorLineLen                EQU     DBasEditorLineLen
     82A9             (      romdefs.asm):01030         BasErrorCodeTable               EQU     DBasErrorCodeTable
     009D             (      romdefs.asm):01031         BasExecAddr                     EQU     DBasExecAddr
     8B8D             (      romdefs.asm):01032         BasFCError                      EQU     DBasFCError
     83FF             (      romdefs.asm):01033         BasFindLineNo                   EQU     DBasFindLineNo
     B848             (      romdefs.asm):01034         BasFMError                      EQU     DBasFMError
     0007             (      romdefs.asm):01035         BasGarbageFlag                  EQU     DBasGarbageFlag
     0003             (      romdefs.asm):01036         BasGenCount                     EQU     DBasGenCount
     B7D4             (      romdefs.asm):01037         BasGetDevNo                     EQU     DBasGetDevNo
     869A             (      romdefs.asm):01038         BasGetLineNo                    EQU     DBasGetLineNo
     8DEA             (      romdefs.asm):01039         BasGetStrFirst                  EQU     DBasGetStrFirst
     8D9A             (      romdefs.asm):01040         BasGetStrLenAddr                EQU     DBasGetStrLenAddr
     8027             (      romdefs.asm):01041         BasicCassBitIn                  EQU     DBasicCassBitIn
     8024             (      romdefs.asm):01042         BasicCassByIn                   EQU     DBasicCassByIn
     801E             (      romdefs.asm):01043         BasicCassByOut                  EQU     DBasicCassByOut
     8018             (      romdefs.asm):01044         BasicCassOff                    EQU     DBasicCassOff
     8015             (      romdefs.asm):01045         BasicCassOn                     EQU     DBasicCassOn
     8021             (      romdefs.asm):01046         BasicCassOnRd                   EQU     DBasicCassOnRd
     8009             (      romdefs.asm):01047         BasicCursorB                    EQU     DBasicCursorB
     8000             (      romdefs.asm):01048         BasicHWInit                     EQU     DBasicHWInit
     8012             (      romdefs.asm):01049         BasicJoyIn                      EQU     DBasicJoyIn
     8006             (      romdefs.asm):01050         BasicKbdIn                      EQU     DBasicKbdIn
     800F             (      romdefs.asm):01051         BasicPrintOut                   EQU     DBasicPrintOut
     800C             (      romdefs.asm):01052         BasicScreenOut                  EQU     DBasicScreenOut
     802A             (      romdefs.asm):01053         BasicSerIn                      EQU     DBasicSerIn
     802D             (      romdefs.asm):01054         BasicSerOut                     EQU     DBasicSerOut
     8030             (      romdefs.asm):01055         BasicSetBaud                    EQU     DBasicSetBaud
     8003             (      romdefs.asm):01056         BasicSWInit                     EQU     DBasicSWInit
     801B             (      romdefs.asm):01057         BasicWriteLead                  EQU     DBasicWriteLead
     9C7C             (      romdefs.asm):01058         BasIDError                      EQU     DBasIDError
     0004             (      romdefs.asm):01059         BasIfCount                      EQU     DBasIfCount
     B5D3             (      romdefs.asm):01060         BasInBuffFromX                  EQU     DBasInBuffFromX
     0009             (      romdefs.asm):01061         BasInputFlag                    EQU     DBasInputFlag
     B84B             (      romdefs.asm):01062         BasIOError                      EQU     DBasIOError
     9D3D             (      romdefs.asm):01063         BasIRQVec                       EQU     DBasIRQVec
     015A             (      romdefs.asm):01064         BasJoyVal0                      EQU     DBasJoyVal0
     015B             (      romdefs.asm):01065         BasJoyVal1                      EQU     DBasJoyVal1
     015C             (      romdefs.asm):01066         BasJoyVal2                      EQU     DBasJoyVal2
     015D             (      romdefs.asm):01067         BasJoyVal3                      EQU     DBasJoyVal3
     9DD9             (      romdefs.asm):01068         BasLineInputEntry               EQU     DBasLineInputEntry
     02DC             (      romdefs.asm):01069         BasLinInpBuff                   EQU     DBasLinInpBuff
     02DA             (      romdefs.asm):01070         BasLinInpHead                   EQU     DBasLinInpHead
     8EAA             (      romdefs.asm):01071         BasList                         EQU     DBasList
     0066             (      romdefs.asm):01072         BasListLine                     EQU     DBasListLine
     AA87             (      romdefs.asm):01073         BasLocateScreen                 EQU     DBasLocateScreen
     8D6B             (      romdefs.asm):01074         BasLSError                      EQU     DBasLSError
     A101             (      romdefs.asm):01075         BasNEError                      EQU     DBasNEError
     8417             (      romdefs.asm):01076         BasNew                          EQU     DBasNew
     B631             (      romdefs.asm):01077         BasNOError                      EQU     DBasNOError
     0120             (      romdefs.asm):01078         BasNumCmds                      EQU     DBasNumCmds
     012A             (      romdefs.asm):01079         BasNumDskCmds                   EQU     DBasNumDskCmds
     012F             (      romdefs.asm):01080         BasNumDskFuncs                  EQU     DBasNumDskFuncs
     0125             (      romdefs.asm):01081         BasNumFuncs                     EQU     DBasNumFuncs
     002D             (      romdefs.asm):01082         BasOldInputPtr                  EQU     DBasOldInputPtr
     8342             (      romdefs.asm):01083         BasOMError                      EQU     DBasOMError
     91DB             (      romdefs.asm):01084         BasOVError                      EQU     DBasOVError
     851B             (      romdefs.asm):01085         BasPollKeyboard                 EQU     DBasPollKeyboard
     978E             (      romdefs.asm):01086         BasRandom8                      EQU     DBasRandom8
     0115             (      romdefs.asm):01087         BasRandomSeed                   EQU     DBasRandomSeed
     000A             (      romdefs.asm):01088         BasRelateFlag                   EQU     DBasRelateFlag
     00D1             (      romdefs.asm):01089         BasRenumStart                   EQU     DBasRenumStart
     00D5             (      romdefs.asm):01090         BasRenumStartLine               EQU     DBasRenumStartLine
     00CF             (      romdefs.asm):01091         BasRenumVal                     EQU     DBasRenumVal
     8434             (      romdefs.asm):01092         BasResetStack                   EQU     DBasResetStack
     8C52             (      romdefs.asm):01093         BasResStr                       EQU     DBasResStr
     8CB3             (      romdefs.asm):01094         BasResStr2                      EQU     DBasResStr2
     00AB             (      romdefs.asm):01095         BasRndData                      EQU     DBasRndData
     849F             (      romdefs.asm):01096         BasRun                          EQU     DBasRun
     85EE             (      romdefs.asm):01097         BasSetProgPtrX                  EQU     DBasSetProgPtrX
     B4B2             (      romdefs.asm):01098         BasSignonMess                   EQU     DBasSignonMess
     85E7             (      romdefs.asm):01099         BasSkipLineNo                   EQU     DBasSkipLineNo
     89B4             (      romdefs.asm):01100         BasSNError                      EQU     DBasSNError
     0019             (      romdefs.asm):01101         BasStartProg                    EQU     DBasStartProg
     8C99             (      romdefs.asm):01102         BasSTError                      EQU     DBasSTError
     01A9             (      romdefs.asm):01103         BasStrDescStack                 EQU     DBasStrDescStack
     000B             (      romdefs.asm):01104         BasStrFirstFreeTemp             EQU     DBasStrFirstFreeTemp
     000D             (      romdefs.asm):01105         BasStrLastUsedTemp              EQU     DBasStrLastUsedTemp
     0025             (      romdefs.asm):01106         BasStrUtil                      EQU     DBasStrUtil
     0120             (      romdefs.asm):01107         BasStub0                        EQU     DBasStub0
     012A             (      romdefs.asm):01108         BasStub1                        EQU     DBasStub1
     0134             (      romdefs.asm):01109         BasStub2                        EQU     DBasStub2
     013E             (      romdefs.asm):01110         BasStub3                        EQU     DBasStub3
     0013             (      romdefs.asm):01111         BasTempFPA2                     EQU     DBasTempFPA2
     002B             (      romdefs.asm):01112         BasTempLine                     EQU     DBasTempLine
     000F             (      romdefs.asm):01113         BasTempPtr                      EQU     DBasTempPtr
     0011             (      romdefs.asm):01114         BasTempPtr1                     EQU     DBasTempPtr1
     003F             (      romdefs.asm):01115         BasTempRelateFlag               EQU     DBasTempRelateFlag
     003B             (      romdefs.asm):01116         BasTempVarDesc                  EQU     DBasTempVarDesc
     8882             (      romdefs.asm):01117         BasTMError                      EQU     DBasTMError
     00AF             (      romdefs.asm):01118         BasTronFlag                     EQU     DBasTronFlag
     8605             (      romdefs.asm):01119         BasULError                      EQU     DBasULError
     0076             (      romdefs.asm):01120         BasUnused1                      EQU     DBasUnused1
     00B0             (      romdefs.asm):01121         BasUSRTableAddr                 EQU     DBasUSRTableAddr
     0134             (      romdefs.asm):01122         BasUsrVecNoDisk                 EQU     DBasUsrVecNoDisk
     001D             (      romdefs.asm):01123         BasVarArrayAddr                 EQU     DBasVarArrayAddr
     0052             (      romdefs.asm):01124         BasVarAssign16                  EQU     DBasVarAssign16
     0033             (      romdefs.asm):01125         BasVarDataAddr                  EQU     DBasVarDataAddr
     0031             (      romdefs.asm):01126         BasVarDataLine                  EQU     DBasVarDataLine
     001F             (      romdefs.asm):01127         BasVarEnd                       EQU     DBasVarEnd
     004F             (      romdefs.asm):01128         BasVarFPAcc1                    EQU     DBasVarFPAcc1
     005C             (      romdefs.asm):01129         BasVarFPAcc2                    EQU     DBasVarFPAcc2
     0040             (      romdefs.asm):01130         BasVarFPAcc3                    EQU     DBasVarFPAcc3
     0045             (      romdefs.asm):01131         BasVarFPAcc4                    EQU     DBasVarFPAcc4
     004A             (      romdefs.asm):01132         BasVarFPAcc5                    EQU     DBasVarFPAcc5
     0037             (      romdefs.asm):01133         BasVarLastInUse                 EQU     DBasVarLastInUse
     0039             (      romdefs.asm):01134         BasVarPtrLast                   EQU     DBasVarPtrLast
     001B             (      romdefs.asm):01135         BasVarSimpleAddr                EQU     DBasVarSimpleAddr
     0021             (      romdefs.asm):01136         BasVarStringBase                EQU     DBasVarStringBase
     0023             (      romdefs.asm):01137         BasVarStrTop                    EQU     DBasVarStrTop
     0006             (      romdefs.asm):01138         BasVarType                      EQU     DBasVarType
     841F             (      romdefs.asm):01139         BasVect1                        EQU     DBasVect1
     8424             (      romdefs.asm):01140         BasVect1a                       EQU     DBasVect1a
     83ED             (      romdefs.asm):01141         BasVect2                        EQU     DBasVect2
     93B1             (      romdefs.asm):01142         BasZDError                      EQU     DBasZDError
     01E3             (      romdefs.asm):01143         CasASCIIFlag                    EQU     DCasASCIIFlag
     BAC3             (      romdefs.asm):01144         CasAudioOff                     EQU     DCasAudioOff
     BAEC             (      romdefs.asm):01145         CasAudioOn                      EQU     DCasAudioOn
     0083             (      romdefs.asm):01146         CasBitCount                     EQU     DCasBitCount
     BDA5             (      romdefs.asm):01147         CasBitIn                        EQU     DCasBitIn
     B93E             (      romdefs.asm):01148         CasBlockIn                      EQU     DCasBlockIn
     007D             (      romdefs.asm):01149         CasBlockLen                     EQU     DCasBlockLen
     B999             (      romdefs.asm):01150         CasBlockOut                     EQU     DCasBlockOut
     007C             (      romdefs.asm):01151         CasBlockType                    EQU     DCasBlockType
     BDAD             (      romdefs.asm):01152         CasByteIn                       EQU     DCasByteIn
     BE12             (      romdefs.asm):01153         CasByteOut                      EQU     DCasByteOut
     0080             (      romdefs.asm):01154         CasCkSum                        EQU     DCasCkSum
     B65F             (      romdefs.asm):01155         CasClosFiles                    EQU     DCasClosFiles
     01E5             (      romdefs.asm):01156         CasEntryAddr                    EQU     DCasEntryAddr
     0070             (      romdefs.asm):01157         CasEOFFlag                      EQU     DCasEOFFlag
     B8B3             (      romdefs.asm):01158         CasFindFile                     EQU     DCasFindFile
     01D2             (      romdefs.asm):01159         CasFName                        EQU     DCasFName
     01DA             (      romdefs.asm):01160         CasFNameFound                   EQU     DCasFNameFound
     01D1             (      romdefs.asm):01161         CasFNameLen                     EQU     DCasFNameLen
     01E2             (      romdefs.asm):01162         CasFType                        EQU     DCasFType
     01E4             (      romdefs.asm):01163         CasGapFlag                      EQU     DCasGapFlag
     007A             (      romdefs.asm):01164         CasHeadBuffAddr                 EQU     DCasHeadBuffAddr
     01DA             (      romdefs.asm):01165         CasIOBuff                       EQU     DCasIOBuff
     007E             (      romdefs.asm):01166         CasIOBuffAddr                   EQU     DCasIOBuffAddr
     0079             (      romdefs.asm):01167         CasIOBuffSize                   EQU     DCasIOBuffSize
     0081             (      romdefs.asm):01168         CasIOErrorCode                  EQU     DCasIOErrorCode
     006E             (      romdefs.asm):01169         CasIOFlag                       EQU     DCasIOFlag
     0085             (      romdefs.asm):01170         CasLastSine                     EQU     DCasLastSine
     0090             (      romdefs.asm):01171         CasLeadCount                    EQU     DCasLeadCount
     01E7             (      romdefs.asm):01172         CasLoadAddr                     EQU     DCasLoadAddr
     0093             (      romdefs.asm):01173         CasMax12                        EQU     DCasMax12
     0094             (      romdefs.asm):01174         CasMax24                        EQU     DCasMax24
     0095             (      romdefs.asm):01175         CasMotorDelay                   EQU     DCasMotorDelay
     BDDC             (      romdefs.asm):01176         CasMotorOff                     EQU     DCasMotorOff
     BDCF             (      romdefs.asm):01177         CasMotorOn                      EQU     DCasMotorOn
     0092             (      romdefs.asm):01178         CasPartrt                       EQU     DCasPartrt
     0084             (      romdefs.asm):01179         CasPhaseFlag                    EQU     DCasPhaseFlag
     B748             (      romdefs.asm):01180         CasReadBin                      EQU     DCasReadBin
     B933             (      romdefs.asm):01181         CasReadBlock1                   EQU     DCasReadBlock1
     BDE7             (      romdefs.asm):01182         CasReadLeader                   EQU     DCasReadLeader
     0078             (      romdefs.asm):01183         CasStatus                       EQU     DCasStatus
     0082             (      romdefs.asm):01184         CasTemp                         EQU     DCasTemp
     B6A5             (      romdefs.asm):01185         CasWriteBasic                   EQU     DCasWriteBasic
     991B             (      romdefs.asm):01186         CasWriteBin                     EQU     DCasWriteBin
     B991             (      romdefs.asm):01187         CasWriteBlock1                  EQU     DCasWriteBlock1
     801B             (      romdefs.asm):01188         CasWriteLeader                  EQU     DCasWriteLeader
     943E             (      romdefs.asm):01189         CmdABS                          EQU     DCmdABS
     8A12             (      romdefs.asm):01190         CmdAND                          EQU     DCmdAND
     8DE6             (      romdefs.asm):01191         CmdASC                          EQU     DCmdASC
     9877             (      romdefs.asm):01192         CmdATN                          EQU     DCmdATN
     BADF             (      romdefs.asm):01193         CmdAudio                        EQU     DCmdAudio
     8DD2             (      romdefs.asm):01194         CmdCHRS                         EQU     DCmdCHRS
     B238             (      romdefs.asm):01195         CmdCircle                       EQU     DCmdCircle
     8571             (      romdefs.asm):01196         CmdClear                        EQU     DCmdClear
     B6D5             (      romdefs.asm):01197         CmdCload                        EQU     DCmdCload
     B64D             (      romdefs.asm):01198         CmdClose                        EQU     DCmdClose
     BA60             (      romdefs.asm):01199         CmdCLS                          EQU     DCmdCLS
     A8D4             (      romdefs.asm):01200         CmdColor                        EQU     DCmdColor
     8560             (      romdefs.asm):01201         CmdCont                         EQU     DCmdCont
     97CB             (      romdefs.asm):01202         CmdCOS                          EQU     DCmdCOS
     B683             (      romdefs.asm):01203         CmdCsave                        EQU     DCmdCsave
     8613             (      romdefs.asm):01204         CmdData                         EQU     DCmdData
     9C81             (      romdefs.asm):01205         CmdDef                          EQU     DCmdDef
     9D61             (      romdefs.asm):01206         CmdDelete                       EQU     DCmdDelete
     8A8B             (      romdefs.asm):01207         CmdDim                          EQU     DCmdDim
     933C             (      romdefs.asm):01208         CmdDivide                       EQU     DCmdDivide
     A049             (      romdefs.asm):01209         CmdDload                        EQU     DCmdDload
     B051             (      romdefs.asm):01210         CmdDraw                         EQU     DCmdDraw
     9965             (      romdefs.asm):01211         CmdEdit                         EQU     DCmdEdit
     8532             (      romdefs.asm):01212         CmdEnd                          EQU     DCmdEnd
     B801             (      romdefs.asm):01213         CmdEOF                          EQU     DCmdEOF
     B771             (      romdefs.asm):01214         CmdExec                         EQU     DCmdExec
     9713             (      romdefs.asm):01215         CmdEXP                          EQU     DCmdEXP
     96A0             (      romdefs.asm):01216         CmdExponet                      EQU     DCmdExponet
     9956             (      romdefs.asm):01217         CmdFIX                          EQU     DCmdFIX
     8448             (      romdefs.asm):01218         CmdFor                          EQU     DCmdFor
     AAF0             (      romdefs.asm):01219         CmdGet                          EQU     DCmdGet
     85B9             (      romdefs.asm):01220         CmdGo                           EQU     DCmdGo
     A00E             (      romdefs.asm):01221         CmdHexS                         EQU     DCmdHexS
     8647             (      romdefs.asm):01222         CmdIF                           EQU     DCmdIF
     B797             (      romdefs.asm):01223         CmdInkeyS                       EQU     DCmdInkeyS
     872B             (      romdefs.asm):01224         CmdInput                        EQU     DCmdInput
     9BB4             (      romdefs.asm):01225         CmdInstr                        EQU     DCmdInstr
     9499             (      romdefs.asm):01226         CmdINT                          EQU     DCmdINT
     BB0D             (      romdefs.asm):01227         CmdJoystk                       EQU     DCmdJoystk
     8DF1             (      romdefs.asm):01228         CmdLeftS                        EQU     DCmdLeftS
     8DC7             (      romdefs.asm):01229         CmdLEN                          EQU     DCmdLEN
     86BC             (      romdefs.asm):01230         CmdLet                          EQU     DCmdLet
     A749             (      romdefs.asm):01231         CmdLine                         EQU     DCmdLine
     9DB1             (      romdefs.asm):01232         CmdLineInput                    EQU     DCmdLineInput
     8EAA             (      romdefs.asm):01233         CmdList                         EQU     DCmdList
     8EA4             (      romdefs.asm):01234         CmdLList                        EQU     DCmdLList
     923C             (      romdefs.asm):01235         CmdLOG                          EQU     DCmdLOG
     8C31             (      romdefs.asm):01236         CmdMEM                          EQU     DCmdMEM
     8E15             (      romdefs.asm):01237         CmdMidS                         EQU     DCmdMidS
     9105             (      romdefs.asm):01238         CmdMinus                        EQU     DCmdMinus
     B982             (      romdefs.asm):01239         CmdMotor                        EQU     DCmdMotor
     9275             (      romdefs.asm):01240         CmdMultiply                     EQU     DCmdMultiply
     8415             (      romdefs.asm):01241         CmdNew                          EQU     DCmdNew
     8829             (      romdefs.asm):01242         CmdNext                         EQU     DCmdNext
     8675             (      romdefs.asm):01243         CmdON                           EQU     DCmdON
     B829             (      romdefs.asm):01244         CmdOpen                         EQU     DCmdOpen
     B835             (      romdefs.asm):01245         CmdOpenEntry                    EQU     DCmdOpenEntry
     8A11             (      romdefs.asm):01246         CmdOR                           EQU     DCmdOR
     AC87             (      romdefs.asm):01247         CmdPaint                        EQU     DCmdPaint
     AA19             (      romdefs.asm):01248         CmdPClear                       EQU     DCmdPClear
     A8C0             (      romdefs.asm):01249         CmdPCls                         EQU     DCmdPCls
     AABE             (      romdefs.asm):01250         CmdPcopy                        EQU     DCmdPcopy
     8E96             (      romdefs.asm):01251         CmdPeek                         EQU     DCmdPeek
     ADBD             (      romdefs.asm):01252         CmdPlay                         EQU     DCmdPlay
     910E             (      romdefs.asm):01253         CmdPlus                         EQU     DCmdPlus
     A9AF             (      romdefs.asm):01254         CmdPmode                        EQU     DCmdPmode
     BA45             (      romdefs.asm):01255         CmdPoint                        EQU     DCmdPoint
     8E9D             (      romdefs.asm):01256         CmdPoke                         EQU     DCmdPoke
     9ADE             (      romdefs.asm):01257         CmdPOS                          EQU     DCmdPOS
     A6C7             (      romdefs.asm):01258         CmdPPoint                       EQU     DCmdPPoint
     A6F3             (      romdefs.asm):01259         CmdPReset                       EQU     DCmdPReset
     903D             (      romdefs.asm):01260         CmdPrint                        EQU     DCmdPrint
     A6EF             (      romdefs.asm):01261         CmdPset                         EQU     DCmdPset
     AAF3             (      romdefs.asm):01262         CmdPut                          EQU     DCmdPut
     8777             (      romdefs.asm):01263         CmdRead                         EQU     DCmdRead
     877A             (      romdefs.asm):01264         CmdReadFromX                    EQU     DCmdReadFromX
     8616             (      romdefs.asm):01265         CmdREM                          EQU     DCmdREM
     9DFA             (      romdefs.asm):01266         CmdRenum                        EQU     DCmdRenum
     BA04             (      romdefs.asm):01267         CmdReset                        EQU     DCmdReset
     8514             (      romdefs.asm):01268         CmdRestore                      EQU     DCmdRestore
     85F3             (      romdefs.asm):01269         CmdReturn                       EQU     DCmdReturn
     8E0E             (      romdefs.asm):01270         CmdRightS                       EQU     DCmdRightS
     9772             (      romdefs.asm):01271         CmdRND                          EQU     DCmdRND
     85A5             (      romdefs.asm):01272         CmdRun                          EQU     DCmdRun
     A9FE             (      romdefs.asm):01273         CmdScreen                       EQU     DCmdScreen
     B9D3             (      romdefs.asm):01274         CmdSet                          EQU     DCmdSet
     9425             (      romdefs.asm):01275         CmdSGN                          EQU     DCmdSGN
     97D1             (      romdefs.asm):01276         CmdSIN                          EQU     DCmdSIN
     B81F             (      romdefs.asm):01277         CmdSkipf                        EQU     DCmdSkipf
     BA9B             (      romdefs.asm):01278         CmdSound                        EQU     DCmdSound
     9697             (      romdefs.asm):01279         CmdSQR                          EQU     DCmdSQR
     8539             (      romdefs.asm):01280         CmdStop                         EQU     DCmdStop
     9B84             (      romdefs.asm):01281         CmdStringS                      EQU     DCmdStringS
     8C40             (      romdefs.asm):01282         CmdSTRS                         EQU     DCmdSTRS
     9816             (      romdefs.asm):01283         CmdTAN                          EQU     DCmdTAN
     9D59             (      romdefs.asm):01284         CmdTimer                        EQU     DCmdTimer
     9ADA             (      romdefs.asm):01285         CmdTroff                        EQU     DCmdTroff
     9AD9             (      romdefs.asm):01286         CmdTron                         EQU     DCmdTron
     9D1D             (      romdefs.asm):01287         CmdUSR                          EQU     DCmdUSR
     8E5C             (      romdefs.asm):01288         CmdVAL                          EQU     DCmdVAL
     9AF4             (      romdefs.asm):01289         CmdVarptr                       EQU     DCmdVarptr
     00B3             (      romdefs.asm):01290         GrBackground                    EQU     DGrBackground
     00B9             (      romdefs.asm):01291         GrBytesPerLine                  EQU     DGrBytesPerLine
     BA28             (      romdefs.asm):01292         GrCalcPixelPos                  EQU     DGrCalcPixelPos
     00D0             (      romdefs.asm):01293         GrCircleRadius                  EQU     DGrCircleRadius
     00CB             (      romdefs.asm):01294         GrCircleXCo                     EQU     DGrCircleXCo
     00CD             (      romdefs.asm):01295         GrCircleYCo                     EQU     DGrCircleYCo
     A8C7             (      romdefs.asm):01296         GrClearGrScreen                 EQU     DGrClearGrScreen
     00C1             (      romdefs.asm):01297         GrColourSet                     EQU     DGrColourSet
     00B4             (      romdefs.asm):01298         GrColourTemp                    EQU     DGrColourTemp
     00B5             (      romdefs.asm):01299         GrCurrColour                    EQU     DGrCurrColour
     00B6             (      romdefs.asm):01300         GrCurrPmode                     EQU     DGrCurrPmode
     00BD             (      romdefs.asm):01301         GrCurrX                         EQU     DGrCurrX
     00C7             (      romdefs.asm):01302         GrCurrXCo                       EQU     DGrCurrXCo
     00BF             (      romdefs.asm):01303         GrCurrY                         EQU     DGrCurrY
     00C9             (      romdefs.asm):01304         GrCurrYCo                       EQU     DGrCurrYCo
     00DB             (      romdefs.asm):01305         GrDirtyFlag                     EQU     DGrDirtyFlag
     00BA             (      romdefs.asm):01306         GrDisplayStartAddr              EQU     DGrDisplayStartAddr
     B051             (      romdefs.asm):01307         GrDraw                          EQU     DGrDraw
     00E8             (      romdefs.asm):01308         GrDrawAngle                     EQU     DGrDrawAngle
     00E9             (      romdefs.asm):01309         GrDrawScale                     EQU     DGrDrawScale
     00B2             (      romdefs.asm):01310         GrForeground                    EQU     DGrForeground
     00B7             (      romdefs.asm):01311         GrLastDisplayAddr               EQU     DGrLastDisplayAddr
     00C3             (      romdefs.asm):01312         GrPixelNoX                      EQU     DGrPixelNoX
     00C5             (      romdefs.asm):01313         GrPixelNoY                      EQU     DGrPixelNoY
     00C2             (      romdefs.asm):01314         GrPlotFlag                      EQU     DGrPlotFlag
     AA23             (      romdefs.asm):01315         GrReserveGrRam                  EQU     DGrReserveGrRam
     BA07             (      romdefs.asm):01316         GrResetLRGPixel                 EQU     DGrResetLRGPixel
     AA10             (      romdefs.asm):01317         GrSelectColourSet               EQU     DGrSelectColourSet
     A938             (      romdefs.asm):01318         GrSelectDisplay                 EQU     DGrSelectDisplay
     A9E1             (      romdefs.asm):01319         GrSelectPage                    EQU     DGrSelectPage
     A9A4             (      romdefs.asm):01320         GrSelectVDGColSet               EQU     DGrSelectVDGColSet
     A928             (      romdefs.asm):01321         GrSetColours                    EQU     DGrSetColours
     B9DF             (      romdefs.asm):01322         GrSetLRGPixel                   EQU     DGrSetLRGPixel
     0086             (      romdefs.asm):01323         GrSetResetData                  EQU     DGrSetResetData
     A989             (      romdefs.asm):01324         GrSetVDGMode                    EQU     DGrSetVDGMode
     A99D             (      romdefs.asm):01325         GrSetVDGOffset                  EQU     DGrSetVDGOffset
     00BC             (      romdefs.asm):01326         GrStartPages                    EQU     DGrStartPages
     A006             (      romdefs.asm):01327         IndCasBlockIn                   EQU     DIndCasBlockIn
     A008             (      romdefs.asm):01328         IndCasBlockOut                  EQU     DIndCasBlockOut
     A004             (      romdefs.asm):01329         IndCasOnRead                    EQU     DIndCasOnRead
     A00C             (      romdefs.asm):01330         IndCasWriteLead                 EQU     DIndCasWriteLead
     A002             (      romdefs.asm):01331         IndCharOutput                   EQU     DIndCharOutput
     A00A             (      romdefs.asm):01332         IndJoystickIn                   EQU     DIndJoystickIn
     A000             (      romdefs.asm):01333         IndKeyInput                     EQU     DIndKeyInput
     0072             (      romdefs.asm):01334         IndVecReset                     EQU     DIndVecReset
     008A             (      romdefs.asm):01335         Misc16BitScratch                EQU     DMisc16BitScratch
     A66B             (      romdefs.asm):01336         PixMaskTable2Col                EQU     DPixMaskTable2Col
     A673             (      romdefs.asm):01337         PixMaskTable4Col                EQU     DPixMaskTable4Col
     BD0A             (      romdefs.asm):01338         PrinterCRLF                     EQU     DPrinterCRLF
     BCF5             (      romdefs.asm):01339         PrinterDirOut                   EQU     DPrinterDirOut
     BD1A             (      romdefs.asm):01340         PrinterOut                      EQU     DPrinterOut
     010F             (      romdefs.asm):01341         SecVecFIRQ                      EQU     DSecVecFIRQ
     010C             (      romdefs.asm):01342         SecVecIRQ                       EQU     DSecVecIRQ
     0109             (      romdefs.asm):01343         SecVecNMI                       EQU     DSecVecNMI
     0106             (      romdefs.asm):01344         SecVecSWI                       EQU     DSecVecSWI
     0103             (      romdefs.asm):01345         SecVecSWI2                      EQU     DSecVecSWI2
     0100             (      romdefs.asm):01346         SecVecSWI3                      EQU     DSecVecSWI3
     0000             (      romdefs.asm):01347         SerDLBaud                       EQU     DSerDLBaud
     0000             (      romdefs.asm):01348         SerDLTimeout                    EQU     DSerDLTimeout
     BAA0             (      romdefs.asm):01349         SndBeep                         EQU     DSndBeep
     BAC3             (      romdefs.asm):01350         SndDisable                      EQU     DSndDisable
     00E5             (      romdefs.asm):01351         SndDotNoteScale                 EQU     DSndDotNoteScale
     BAED             (      romdefs.asm):01352         SndDTOAOn                       EQU     DSndDTOAOn
     BAC5             (      romdefs.asm):01353         SndEnable                       EQU     DSndEnable
     008D             (      romdefs.asm):01354         SndLength                       EQU     DSndLength
     00E1             (      romdefs.asm):01355         SndNoteLen                      EQU     DSndNoteLen
     00DE             (      romdefs.asm):01356         SndOctave                       EQU     DSndOctave
     008C             (      romdefs.asm):01357         SndPitch                        EQU     DSndPitch
     AE9A             (      romdefs.asm):01358         SndPlayNote                     EQU     DSndPlayNote
     00E2             (      romdefs.asm):01359         SndTempo                        EQU     DSndTempo
     00E3             (      romdefs.asm):01360         SndTimerPlay                    EQU     DSndTimerPlay
     00DF             (      romdefs.asm):01361         SndVolume                       EQU     DSndVolume
     BB80             (      romdefs.asm):01362         SysBoot64                       EQU     DSysBoot64
     8344             (      romdefs.asm):01363         SysErr                          EQU     DSysErr
     835E             (      romdefs.asm):01364         SysErr2                         EQU     DSysErr2
     BD52             (      romdefs.asm):01365         SysReadJoystick                 EQU     DSysReadJoystick
     B3B4             (      romdefs.asm):01366         SysReset                        EQU     DSysReset
     BAD4             (      romdefs.asm):01367         SysResetDA                      EQU     DSysResetDA
     BD41             (      romdefs.asm):01368         SysSelJoystick                  EQU     DSysSelJoystick
     0112             (      romdefs.asm):01369         SysTimeVal                      EQU     DSysTimeVal
     BAD6             (      romdefs.asm):01370         SysWriteDA                      EQU     DSysWriteDA
     0149             (      romdefs.asm):01371         TextCapsLock                    EQU     DTextCapsLock
     BCA0             (      romdefs.asm):01372         TextClearLine                   EQU     DTextClearLine
     BA77             (      romdefs.asm):01373         TextCls                         EQU     DTextCls
     BA79             (      romdefs.asm):01374         TextClsChar                     EQU     DTextClsChar
     008F             (      romdefs.asm):01375         TextCursFalshCnt                EQU     DTextCursFalshCnt
     006F             (      romdefs.asm):01376         TextDevN                        EQU     DTextDevN
     0035             (      romdefs.asm):01377         TextKbdBuffAddr                 EQU     DTextKbdBuffAddr
     0097             (      romdefs.asm):01378         TextKbdDelay                    EQU     DTextKbdDelay
     0150             (      romdefs.asm):01379         TextKbdRollover                 EQU     DTextKbdRollover
     0087             (      romdefs.asm):01380         TextLastKey                     EQU     DTextLastKey
     B54A             (      romdefs.asm):01381         TextOutChar                     EQU     DTextOutChar
     90A1             (      romdefs.asm):01382         TextOutCRLF                     EQU     DTextOutCRLF
     957A             (      romdefs.asm):01383         TextOutNum16                    EQU     DTextOutNum16
     9582             (      romdefs.asm):01384         TextOutNumFPA0                  EQU     DTextOutNumFPA0
     90F8             (      romdefs.asm):01385         TextOutQuestion                 EQU     DTextOutQuestion
     90F5             (      romdefs.asm):01386         TextOutSpace                    EQU     DTextOutSpace
     90E5             (      romdefs.asm):01387         TextOutString                   EQU     DTextOutString
     0148             (      romdefs.asm):01388         TextPrnAutoCRLF                 EQU     DTextPrnAutoCRLF
     0099             (      romdefs.asm):01389         TextPrnCommaW                   EQU     DTextPrnCommaW
     009C             (      romdefs.asm):01390         TextPrnCurrCol                  EQU     DTextPrnCurrCol
     014A             (      romdefs.asm):01391         TextPrnEOLCnt                   EQU     DTextPrnEOLCnt
     014B             (      romdefs.asm):01392         TextPrnEOLSeq                   EQU     DTextPrnEOLSeq
     009A             (      romdefs.asm):01393         TextPrnLastComma                EQU     DTextPrnLastComma
     009B             (      romdefs.asm):01394         TextPrnLineW                    EQU     DTextPrnLineW
     03FF             (      romdefs.asm):01395         TextPrnSelFlag                  EQU     DTextPrnSelFlag
     A93A             (      romdefs.asm):01396         TextResetVDU                    EQU     DTextResetVDU
     BBE5             (      romdefs.asm):01397         TextScanKbd                     EQU     DTextScanKbd
     FF07             (      romdefs.asm):01398         TextSerBaudRate                 EQU     DTextSerBaudRate
     03FD             (      romdefs.asm):01399         TextSerEOLDelay                 EQU     DTextSerEOLDelay
     BBB5             (      romdefs.asm):01400         TextUpdateCurs                  EQU     DTextUpdateCurs
     006A             (      romdefs.asm):01401         TextVDUCommaW                   EQU     DTextVDUCommaW
     006C             (      romdefs.asm):01402         TextVDUCurrCol                  EQU     DTextVDUCurrCol
     0088             (      romdefs.asm):01403         TextVDUCursAddr                 EQU     DTextVDUCursAddr
     006B             (      romdefs.asm):01404         TextVDULastComma                EQU     DTextVDULastComma
     006D             (      romdefs.asm):01405         TextVDULineW                    EQU     DTextVDULineW
     BCAB             (      romdefs.asm):01406         TextVDUOut                      EQU     DTextVDUOut
     852B             (      romdefs.asm):01407         TextWaitKey                     EQU     DTextWaitKey
     A0EA             (      romdefs.asm):01408         TextWaitKeyCurs                 EQU     DTextWaitKeyCurs
     B505             (      romdefs.asm):01409         TextWaitKeyCurs2                EQU     DTextWaitKeyCurs2
     B7CC             (      romdefs.asm):01410         UtilCopyBXtoU                   EQU     DUtilCopyBXtoU
     8C35             (      romdefs.asm):01411         VarAssign16Bit                  EQU     DVarAssign16Bit
     8C37             (      romdefs.asm):01412         VarAssign16Bit2                 EQU     DVarAssign16Bit2
     9C3E             (      romdefs.asm):01413         VarAssign16BitB                 EQU     DVarAssign16BitB
     8C36             (      romdefs.asm):01414         VarAssign8Bit                   EQU     DVarAssign8Bit
     89AC             (      romdefs.asm):01415         VarCKChar                       EQU     DVarCKChar
     89A4             (      romdefs.asm):01416         VarCKClBrac                     EQU     DVarCKClBrac
     89AA             (      romdefs.asm):01417         VarCKComma                      EQU     DVarCKComma
     89A7             (      romdefs.asm):01418         VarCKOpBrac                     EQU     DVarCKOpBrac
     8D9F             (      romdefs.asm):01419         VarDelVar                       EQU     DVarDelVar
     8CD7             (      romdefs.asm):01420         VarGarbageCollect               EQU     DVarGarbageCollect
     8E83             (      romdefs.asm):01421         VarGet16Bit                     EQU     DVarGet16Bit
     8E51             (      romdefs.asm):01422         VarGet8Bit                      EQU     DVarGet8Bit
     8E7E             (      romdefs.asm):01423         VarGetComma8                    EQU     DVarGetComma8
     8877             (      romdefs.asm):01424         VarGetExpr                      EQU     DVarGetExpr
     8874             (      romdefs.asm):01425         VarGetExprCC                    EQU     DVarGetExprCC
     8887             (      romdefs.asm):01426         VarGetStr                       EQU     DVarGetStr
     8B29             (      romdefs.asm):01427         VarGetUsr                       EQU     DVarGetUsr
     8A94             (      romdefs.asm):01428         VarGetVar                       EQU     DVarGetVar
     9165             (      romdefs.asm):01429         VarNormFPA0                     EQU     DVarNormFPA0
     01A0             (      romdefs.asm):01430         VectAccessScreen                EQU     DVectAccessScreen
     019D             (      romdefs.asm):01431         VectAssignStr                   EQU     DVectAssignStr
     015E             (      romdefs.asm):01432         VectBase                        EQU     DVectBase
     0188             (      romdefs.asm):01433         VectCheckEOF                    EQU     DVectCheckEOF
     017F             (      romdefs.asm):01434         VectCheckKeys                   EQU     DVectCheckKeys
     0173             (      romdefs.asm):01435         VectCloseAllFiles               EQU     DVectCloseAllFiles
     0176             (      romdefs.asm):01436         VectCloseFile                   EQU     DVectCloseFile
     0185             (      romdefs.asm):01437         VectCloseFileCmd                EQU     DVectCloseFileCmd
     0179             (      romdefs.asm):01438         VectCmdInterp                   EQU     DVectCmdInterp
     01A6             (      romdefs.asm):01439         VectDeTokenize                  EQU     DVectDeTokenize
     0164             (      romdefs.asm):01440         VectDevInit                     EQU     DVectDevInit
     0161             (      romdefs.asm):01441         VectDevNo                       EQU     DVectDevNo
     015E             (      romdefs.asm):01442         VectDevOpen                     EQU     DVectDevOpen
     018B             (      romdefs.asm):01443         VectEvaluateExpr                EQU     DVectEvaluateExpr
     019A             (      romdefs.asm):01444         VectGetNextCmd                  EQU     DVectGetNextCmd
     016A             (      romdefs.asm):01445         VectInChar                      EQU     DVectInChar
     016D             (      romdefs.asm):01446         VectInputFile                   EQU     DVectInputFile
     0182             (      romdefs.asm):01447         VectLineInputFile               EQU     DVectLineInputFile
     0167             (      romdefs.asm):01448         VectOutChar                     EQU     DVectOutChar
     0170             (      romdefs.asm):01449         VectOutputFile                  EQU     DVectOutputFile
     017C             (      romdefs.asm):01450         VectReReqestIn                  EQU     DVectReReqestIn
     0197             (      romdefs.asm):01451         VectResetBasMem                 EQU     DVectResetBasMem
     0194             (      romdefs.asm):01452         VectRunLink                     EQU     DVectRunLink
     0191             (      romdefs.asm):01453         VectSysError                    EQU     DVectSysError
     01A3             (      romdefs.asm):01454         VectTokenize                    EQU     DVectTokenize
     018E             (      romdefs.asm):01455         VectUserError                   EQU     DVectUserError
     B44F             (      romdefs.asm):01456         WarmStart                       EQU     DWarmStart
     0071             (      romdefs.asm):01457         WarmStartFlag                   EQU     DWarmStartFlag
                      (      romdefs.asm):01458         
                      (      romdefs.asm):01459                                 ENDC
                      (      romdefs.asm):01460         
                      (      romdefs.asm):01461                                 ifdef Tandy
                      (      romdefs.asm):01462         
0000                  (      romdefs.asm):01463         StubResWordsOfs                 EQU     CStubResWordsOfs
0000                  (      romdefs.asm):01464         StubResLookupOfs                EQU     CStubResLookupOfs
0000                  (      romdefs.asm):01465         StubResJumpOfs                  EQU     CStubResJumpOfs
0000                  (      romdefs.asm):01466         StubFuncsOfs                    EQU     CStubFuncsOfs
0000                  (      romdefs.asm):01467         StubFuncsLookupOfs              EQU     CStubFuncsLookupOfs
0000                  (      romdefs.asm):01468         StubFuncsJumpOfs                EQU     CStubFuncsJumpOfs
0000                  (      romdefs.asm):01469         Skip1                           EQU     CSkip1
0000                  (      romdefs.asm):01470         Skip2                           EQU     CSkip2
0000                  (      romdefs.asm):01471         Skip1LD                         EQU     CSkip1LD
0000                  (      romdefs.asm):01472         Skip2TST                        EQU     CSkip2TST
0000                  (      romdefs.asm):01473         CoCoVec167                      EQU     CCoCoVec167
0000                  (      romdefs.asm):01474         CoCoVect16A                     EQU     CCoCoVect16A
0000                  (      romdefs.asm):01475         CoCoVect176                     EQU     CCoCoVect176
0000                  (      romdefs.asm):01476         CoCoVect179                     EQU     CCoCoVect179
0000                  (      romdefs.asm):01477         CoCoVect18B                     EQU     CCoCoVect18B
0000                  (      romdefs.asm):01478         CoCoVect191                     EQU     CCoCoVect191
0000                  (      romdefs.asm):01479         CoCoVect194                     EQU     CCoCoVect194
0000                  (      romdefs.asm):01480         CoCoVect197                     EQU     CCoCoVect197
0000                  (      romdefs.asm):01481         CoCoVect19A                     EQU     CCoCoVect19A
0000                  (      romdefs.asm):01482         CoCoVect1A3                     EQU     CCoCoVect1A3
0000                  (      romdefs.asm):01483         AddrFWareRamTop                 EQU     CAddrFWareRamTop
0000                  (      romdefs.asm):01484         AddrRamTop                      EQU     CAddrRamTop
0000                  (      romdefs.asm):01485         AddrStack                       EQU     CAddrStack
0000                  (      romdefs.asm):01486         BasAddrCmdDisp                  EQU     CBasAddrCmdDisp
0000                  (      romdefs.asm):01487         BasAddrCmdList                  EQU     CBasAddrCmdList
0000                  (      romdefs.asm):01488         BasAddrDskCmdDisp               EQU     CBasAddrDskCmdDisp
0000                  (      romdefs.asm):01489         BasAddrDskCmdList               EQU     CBasAddrDskCmdList
0000                  (      romdefs.asm):01490         BasAddrDskFuncDisp              EQU     CBasAddrDskFuncDisp
0000                  (      romdefs.asm):01491         BasAddrDskFuncList              EQU     CBasAddrDskFuncList
0000                  (      romdefs.asm):01492         BasAddrFuncDisp                 EQU     CBasAddrFuncDisp
0000                  (      romdefs.asm):01493         BasAddrFuncList                 EQU     CBasAddrFuncList
0000                  (      romdefs.asm):01494         BasAddrSigByte                  EQU     CBasAddrSigByte
0000                  (      romdefs.asm):01495         BasAOError                      EQU     CBasAOError
0000                  (      romdefs.asm):01496         BasArrayEval                    EQU     CBasArrayEval
0000                  (      romdefs.asm):01497         BasBootBasic                    EQU     CBasBootBasic
0000                  (      romdefs.asm):01498         BasBotStack                     EQU     CBasBotStack
0000                  (      romdefs.asm):01499         BasBRARun                       EQU     CBasBRARun
0000                  (      romdefs.asm):01500         BasBreakFlag                    EQU     CBasBreakFlag
0000                  (      romdefs.asm):01501         BasBuffer                       EQU     CBasBuffer
0000                  (      romdefs.asm):01502         BasChkArrSpaceMv                EQU     CBasChkArrSpaceMv
0000                  (      romdefs.asm):01503         BasChkB2Free                    EQU     CBasChkB2Free
0000                  (      romdefs.asm):01504         BasChkDirect                    EQU     CBasChkDirect
0000                  (      romdefs.asm):01505         BasChrGet                       EQU     CBasChrGet
0000                  (      romdefs.asm):01506         BasChrGetCurr                   EQU     CBasChrGetCurr
0000                  (      romdefs.asm):01507         BasCloadMOffs                   EQU     CBasCloadMOffs
0000                  (      romdefs.asm):01508         BasCmdMode                      EQU     CBasCmdMode
0000                  (      romdefs.asm):01509         BasContLine                     EQU     CBasContLine
0000                  (      romdefs.asm):01510         BasCurrentLine                  EQU     CBasCurrentLine
0000                  (      romdefs.asm):01511         BasDelim1                       EQU     CBasDelim1
0000                  (      romdefs.asm):01512         BasDelim2                       EQU     CBasDelim2
0000                  (      romdefs.asm):01513         BasDirectTextPtr                EQU     CBasDirectTextPtr
0000                  (      romdefs.asm):01514         BasDisArraySearch               EQU     CBasDisArraySearch
0000                  (      romdefs.asm):01515         BasDNError                      EQU     CBasDNError
0000                  (      romdefs.asm):01516         BasDoDispatch                   EQU     CBasDoDispatch
0000                  (      romdefs.asm):01517         BasEditorLineLen                EQU     CBasEditorLineLen
0000                  (      romdefs.asm):01518         BasErrorCodeTable               EQU     CBasErrorCodeTable
0000                  (      romdefs.asm):01519         BasExecAddr                     EQU     CBasExecAddr
0000                  (      romdefs.asm):01520         BasFCError                      EQU     CBasFCError
0000                  (      romdefs.asm):01521         BasFindLineNo                   EQU     CBasFindLineNo
0000                  (      romdefs.asm):01522         BasFMError                      EQU     CBasFMError
0000                  (      romdefs.asm):01523         BasGarbageFlag                  EQU     CBasGarbageFlag
0000                  (      romdefs.asm):01524         BasGenCount                     EQU     CBasGenCount
0000                  (      romdefs.asm):01525         BasGetDevNo                     EQU     CBasGetDevNo
0000                  (      romdefs.asm):01526         BasGetLineNo                    EQU     CBasGetLineNo
0000                  (      romdefs.asm):01527         BasGetStrFirst                  EQU     CBasGetStrFirst
0000                  (      romdefs.asm):01528         BasGetStrLenAddr                EQU     CBasGetStrLenAddr
0000                  (      romdefs.asm):01529         BasicCassBitIn                  EQU     CBasicCassBitIn
0000                  (      romdefs.asm):01530         BasicCassByIn                   EQU     CBasicCassByIn
0000                  (      romdefs.asm):01531         BasicCassByOut                  EQU     CBasicCassByOut
0000                  (      romdefs.asm):01532         BasicCassOff                    EQU     CBasicCassOff
0000                  (      romdefs.asm):01533         BasicCassOn                     EQU     CBasicCassOn
0000                  (      romdefs.asm):01534         BasicCassOnRd                   EQU     CBasicCassOnRd
0000                  (      romdefs.asm):01535         BasicCursorB                    EQU     CBasicCursorB
0000                  (      romdefs.asm):01536         BasicHWInit                     EQU     CBasicHWInit
0000                  (      romdefs.asm):01537         BasicJoyIn                      EQU     CBasicJoyIn
0000                  (      romdefs.asm):01538         BasicKbdIn                      EQU     CBasicKbdIn
0000                  (      romdefs.asm):01539         BasicPrintOut                   EQU     CBasicPrintOut
0000                  (      romdefs.asm):01540         BasicScreenOut                  EQU     CBasicScreenOut
0000                  (      romdefs.asm):01541         BasicSerIn                      EQU     CBasicSerIn
0000                  (      romdefs.asm):01542         BasicSerOut                     EQU     CBasicSerOut
0000                  (      romdefs.asm):01543         BasicSetBaud                    EQU     CBasicSetBaud
0000                  (      romdefs.asm):01544         BasicSWInit                     EQU     CBasicSWInit
0000                  (      romdefs.asm):01545         BasicWriteLead                  EQU     CBasicWriteLead
0000                  (      romdefs.asm):01546         BasIDError                      EQU     CBasIDError
0000                  (      romdefs.asm):01547         BasIfCount                      EQU     CBasIfCount
0000                  (      romdefs.asm):01548         BasInBuffFromX                  EQU     CBasInBuffFromX
0000                  (      romdefs.asm):01549         BasInputFlag                    EQU     CBasInputFlag
0000                  (      romdefs.asm):01550         BasIOError                      EQU     CBasIOError
0000                  (      romdefs.asm):01551         BasIRQVec                       EQU     CBasIRQVec
0000                  (      romdefs.asm):01552         BasJoyVal0                      EQU     CBasJoyVal0
0000                  (      romdefs.asm):01553         BasJoyVal1                      EQU     CBasJoyVal1
0000                  (      romdefs.asm):01554         BasJoyVal2                      EQU     CBasJoyVal2
0000                  (      romdefs.asm):01555         BasJoyVal3                      EQU     CBasJoyVal3
0000                  (      romdefs.asm):01556         BasLineInputEntry               EQU     CBasLineInputEntry
0000                  (      romdefs.asm):01557         BasLinInpBuff                   EQU     CBasLinInpBuff
0000                  (      romdefs.asm):01558         BasLinInpHead                   EQU     CBasLinInpHead
0000                  (      romdefs.asm):01559         BasList                         EQU     CBasList
0000                  (      romdefs.asm):01560         BasListLine                     EQU     CBasListLine
0000                  (      romdefs.asm):01561         BasLocateScreen                 EQU     CBasLocateScreen
0000                  (      romdefs.asm):01562         BasLSError                      EQU     CBasLSError
0000                  (      romdefs.asm):01563         BasNEError                      EQU     CBasNEError
0000                  (      romdefs.asm):01564         BasNew                          EQU     CBasNew
0000                  (      romdefs.asm):01565         BasNOError                      EQU     CBasNOError
0000                  (      romdefs.asm):01566         BasNumCmds                      EQU     CBasNumCmds
0000                  (      romdefs.asm):01567         BasNumDskCmds                   EQU     CBasNumDskCmds
0000                  (      romdefs.asm):01568         BasNumDskFuncs                  EQU     CBasNumDskFuncs
0000                  (      romdefs.asm):01569         BasNumFuncs                     EQU     CBasNumFuncs
0000                  (      romdefs.asm):01570         BasOldInputPtr                  EQU     CBasOldInputPtr
0000                  (      romdefs.asm):01571         BasOMError                      EQU     CBasOMError
0000                  (      romdefs.asm):01572         BasOVError                      EQU     CBasOVError
0000                  (      romdefs.asm):01573         BasPollKeyboard                 EQU     CBasPollKeyboard
0000                  (      romdefs.asm):01574         BasRandom8                      EQU     CBasRandom8
0000                  (      romdefs.asm):01575         BasRandomSeed                   EQU     CBasRandomSeed
0000                  (      romdefs.asm):01576         BasRelateFlag                   EQU     CBasRelateFlag
0000                  (      romdefs.asm):01577         BasRenumStart                   EQU     CBasRenumStart
0000                  (      romdefs.asm):01578         BasRenumStartLine               EQU     CBasRenumStartLine
0000                  (      romdefs.asm):01579         BasRenumVal                     EQU     CBasRenumVal
0000                  (      romdefs.asm):01580         BasResetStack                   EQU     CBasResetStack
0000                  (      romdefs.asm):01581         BasResStr                       EQU     CBasResStr
0000                  (      romdefs.asm):01582         BasResStr2                      EQU     CBasResStr2
0000                  (      romdefs.asm):01583         BasRndData                      EQU     CBasRndData
0000                  (      romdefs.asm):01584         BasRun                          EQU     CBasRun
0000                  (      romdefs.asm):01585         BasSetProgPtrX                  EQU     CBasSetProgPtrX
0000                  (      romdefs.asm):01586         BasSignonMess                   EQU     CBasSignonMess
0000                  (      romdefs.asm):01587         BasSkipLineNo                   EQU     CBasSkipLineNo
0000                  (      romdefs.asm):01588         BasSNError                      EQU     CBasSNError
0000                  (      romdefs.asm):01589         BasStartProg                    EQU     CBasStartProg
0000                  (      romdefs.asm):01590         BasSTError                      EQU     CBasSTError
0000                  (      romdefs.asm):01591         BasStrDescStack                 EQU     CBasStrDescStack
0000                  (      romdefs.asm):01592         BasStrFirstFreeTemp             EQU     CBasStrFirstFreeTemp
0000                  (      romdefs.asm):01593         BasStrLastUsedTemp              EQU     CBasStrLastUsedTemp
0000                  (      romdefs.asm):01594         BasStrUtil                      EQU     CBasStrUtil
0000                  (      romdefs.asm):01595         BasStub0                        EQU     CBasStub0
0000                  (      romdefs.asm):01596         BasStub1                        EQU     CBasStub1
0000                  (      romdefs.asm):01597         BasStub2                        EQU     CBasStub2
0000                  (      romdefs.asm):01598         BasStub3                        EQU     CBasStub3
0000                  (      romdefs.asm):01599         BasTempFPA2                     EQU     CBasTempFPA2
0000                  (      romdefs.asm):01600         BasTempLine                     EQU     CBasTempLine
0000                  (      romdefs.asm):01601         BasTempPtr                      EQU     CBasTempPtr
0000                  (      romdefs.asm):01602         BasTempPtr1                     EQU     CBasTempPtr1
0000                  (      romdefs.asm):01603         BasTempRelateFlag               EQU     CBasTempRelateFlag
0000                  (      romdefs.asm):01604         BasTempVarDesc                  EQU     CBasTempVarDesc
0000                  (      romdefs.asm):01605         BasTMError                      EQU     CBasTMError
0000                  (      romdefs.asm):01606         BasTronFlag                     EQU     CBasTronFlag
0000                  (      romdefs.asm):01607         BasULError                      EQU     CBasULError
0000                  (      romdefs.asm):01608         BasUnused1                      EQU     CBasUnused1
0000                  (      romdefs.asm):01609         BasUSRTableAddr                 EQU     CBasUSRTableAddr
0000                  (      romdefs.asm):01610         BasUsrVecNoDisk                 EQU     CBasUsrVecNoDisk
0000                  (      romdefs.asm):01611         BasVarArrayAddr                 EQU     CBasVarArrayAddr
0000                  (      romdefs.asm):01612         BasVarAssign16                  EQU     CBasVarAssign16
0000                  (      romdefs.asm):01613         BasVarDataAddr                  EQU     CBasVarDataAddr
0000                  (      romdefs.asm):01614         BasVarDataLine                  EQU     CBasVarDataLine
0000                  (      romdefs.asm):01615         BasVarEnd                       EQU     CBasVarEnd
0000                  (      romdefs.asm):01616         BasVarFPAcc1                    EQU     CBasVarFPAcc1
0000                  (      romdefs.asm):01617         BasVarFPAcc2                    EQU     CBasVarFPAcc2
0000                  (      romdefs.asm):01618         BasVarFPAcc3                    EQU     CBasVarFPAcc3
0000                  (      romdefs.asm):01619         BasVarFPAcc4                    EQU     CBasVarFPAcc4
0000                  (      romdefs.asm):01620         BasVarFPAcc5                    EQU     CBasVarFPAcc5
0000                  (      romdefs.asm):01621         BasVarLastInUse                 EQU     CBasVarLastInUse
0000                  (      romdefs.asm):01622         BasVarPtrLast                   EQU     CBasVarPtrLast
0000                  (      romdefs.asm):01623         BasVarSimpleAddr                EQU     CBasVarSimpleAddr
0000                  (      romdefs.asm):01624         BasVarStringBase                EQU     CBasVarStringBase
0000                  (      romdefs.asm):01625         BasVarStrTop                    EQU     CBasVarStrTop
0000                  (      romdefs.asm):01626         BasVarType                      EQU     CBasVarType
0000                  (      romdefs.asm):01627         BasVect1                        EQU     CBasVect1
0000                  (      romdefs.asm):01628         BasVect1a                       EQU     CBasVect1a
0000                  (      romdefs.asm):01629         BasVect2                        EQU     CBasVect2
0000                  (      romdefs.asm):01630         BasZDError                      EQU     CBasZDError
0000                  (      romdefs.asm):01631         CasASCIIFlag                    EQU     CCasASCIIFlag
0000                  (      romdefs.asm):01632         CasAudioOff                     EQU     CCasAudioOff
0000                  (      romdefs.asm):01633         CasAudioOn                      EQU     CCasAudioOn
0000                  (      romdefs.asm):01634         CasBitCount                     EQU     CCasBitCount
0000                  (      romdefs.asm):01635         CasBitIn                        EQU     CCasBitIn
0000                  (      romdefs.asm):01636         CasBlockIn                      EQU     CCasBlockIn
0000                  (      romdefs.asm):01637         CasBlockLen                     EQU     CCasBlockLen
0000                  (      romdefs.asm):01638         CasBlockOut                     EQU     CCasBlockOut
0000                  (      romdefs.asm):01639         CasBlockType                    EQU     CCasBlockType
0000                  (      romdefs.asm):01640         CasByteIn                       EQU     CCasByteIn
0000                  (      romdefs.asm):01641         CasByteOut                      EQU     CCasByteOut
0000                  (      romdefs.asm):01642         CasCkSum                        EQU     CCasCkSum
0000                  (      romdefs.asm):01643         CasClosFiles                    EQU     CCasClosFiles
0000                  (      romdefs.asm):01644         CasEntryAddr                    EQU     CCasEntryAddr
0000                  (      romdefs.asm):01645         CasEOFFlag                      EQU     CCasEOFFlag
0000                  (      romdefs.asm):01646         CasFindFile                     EQU     CCasFindFile
0000                  (      romdefs.asm):01647         CasFName                        EQU     CCasFName
0000                  (      romdefs.asm):01648         CasFNameFound                   EQU     CCasFNameFound
0000                  (      romdefs.asm):01649         CasFNameLen                     EQU     CCasFNameLen
0000                  (      romdefs.asm):01650         CasFType                        EQU     CCasFType
0000                  (      romdefs.asm):01651         CasGapFlag                      EQU     CCasGapFlag
0000                  (      romdefs.asm):01652         CasHeadBuffAddr                 EQU     CCasHeadBuffAddr
0000                  (      romdefs.asm):01653         CasIOBuff                       EQU     CCasIOBuff
0000                  (      romdefs.asm):01654         CasIOBuffAddr                   EQU     CCasIOBuffAddr
0000                  (      romdefs.asm):01655         CasIOBuffSize                   EQU     CCasIOBuffSize
0000                  (      romdefs.asm):01656         CasIOErrorCode                  EQU     CCasIOErrorCode
0000                  (      romdefs.asm):01657         CasIOFlag                       EQU     CCasIOFlag
0000                  (      romdefs.asm):01658         CasLastSine                     EQU     CCasLastSine
0000                  (      romdefs.asm):01659         CasLeadCount                    EQU     CCasLeadCount
0000                  (      romdefs.asm):01660         CasLoadAddr                     EQU     CCasLoadAddr
0000                  (      romdefs.asm):01661         CasMax12                        EQU     CCasMax12
0000                  (      romdefs.asm):01662         CasMax24                        EQU     CCasMax24
0000                  (      romdefs.asm):01663         CasMotorDelay                   EQU     CCasMotorDelay
0000                  (      romdefs.asm):01664         CasMotorOff                     EQU     CCasMotorOff
0000                  (      romdefs.asm):01665         CasMotorOn                      EQU     CCasMotorOn
0000                  (      romdefs.asm):01666         CasPartrt                       EQU     CCasPartrt
0000                  (      romdefs.asm):01667         CasPhaseFlag                    EQU     CCasPhaseFlag
0000                  (      romdefs.asm):01668         CasReadBin                      EQU     CCasReadBin
0000                  (      romdefs.asm):01669         CasReadBlock1                   EQU     CCasReadBlock1
0000                  (      romdefs.asm):01670         CasReadLeader                   EQU     CCasReadLeader
0000                  (      romdefs.asm):01671         CasStatus                       EQU     CCasStatus
0000                  (      romdefs.asm):01672         CasTemp                         EQU     CCasTemp
0000                  (      romdefs.asm):01673         CasWriteBasic                   EQU     CCasWriteBasic
0000                  (      romdefs.asm):01674         CasWriteBin                     EQU     CCasWriteBin
0000                  (      romdefs.asm):01675         CasWriteBlock1                  EQU     CCasWriteBlock1
0000                  (      romdefs.asm):01676         CasWriteLeader                  EQU     CCasWriteLeader
0000                  (      romdefs.asm):01677         CmdABS                          EQU     CCmdABS
0000                  (      romdefs.asm):01678         CmdAND                          EQU     CCmdAND
0000                  (      romdefs.asm):01679         CmdASC                          EQU     CCmdASC
0000                  (      romdefs.asm):01680         CmdATN                          EQU     CCmdATN
0000                  (      romdefs.asm):01681         CmdAudio                        EQU     CCmdAudio
0000                  (      romdefs.asm):01682         CmdCHRS                         EQU     CCmdCHRS
0000                  (      romdefs.asm):01683         CmdCircle                       EQU     CCmdCircle
0000                  (      romdefs.asm):01684         CmdClear                        EQU     CCmdClear
0000                  (      romdefs.asm):01685         CmdCload                        EQU     CCmdCload
0000                  (      romdefs.asm):01686         CmdClose                        EQU     CCmdClose
0000                  (      romdefs.asm):01687         CmdCLS                          EQU     CCmdCLS
0000                  (      romdefs.asm):01688         CmdColor                        EQU     CCmdColor
0000                  (      romdefs.asm):01689         CmdCont                         EQU     CCmdCont
0000                  (      romdefs.asm):01690         CmdCOS                          EQU     CCmdCOS
0000                  (      romdefs.asm):01691         CmdCsave                        EQU     CCmdCsave
0000                  (      romdefs.asm):01692         CmdData                         EQU     CCmdData
0000                  (      romdefs.asm):01693         CmdDef                          EQU     CCmdDef
0000                  (      romdefs.asm):01694         CmdDelete                       EQU     CCmdDelete
0000                  (      romdefs.asm):01695         CmdDim                          EQU     CCmdDim
0000                  (      romdefs.asm):01696         CmdDivide                       EQU     CCmdDivide
0000                  (      romdefs.asm):01697         CmdDload                        EQU     CCmdDload
0000                  (      romdefs.asm):01698         CmdDraw                         EQU     CCmdDraw
0000                  (      romdefs.asm):01699         CmdEdit                         EQU     CCmdEdit
0000                  (      romdefs.asm):01700         CmdEnd                          EQU     CCmdEnd
0000                  (      romdefs.asm):01701         CmdEOF                          EQU     CCmdEOF
0000                  (      romdefs.asm):01702         CmdExec                         EQU     CCmdExec
0000                  (      romdefs.asm):01703         CmdEXP                          EQU     CCmdEXP
0000                  (      romdefs.asm):01704         CmdExponet                      EQU     CCmdExponet
0000                  (      romdefs.asm):01705         CmdFIX                          EQU     CCmdFIX
0000                  (      romdefs.asm):01706         CmdFor                          EQU     CCmdFor
0000                  (      romdefs.asm):01707         CmdGet                          EQU     CCmdGet
0000                  (      romdefs.asm):01708         CmdGo                           EQU     CCmdGo
0000                  (      romdefs.asm):01709         CmdHexS                         EQU     CCmdHexS
0000                  (      romdefs.asm):01710         CmdIF                           EQU     CCmdIF
0000                  (      romdefs.asm):01711         CmdInkeyS                       EQU     CCmdInkeyS
0000                  (      romdefs.asm):01712         CmdInput                        EQU     CCmdInput
0000                  (      romdefs.asm):01713         CmdInstr                        EQU     CCmdInstr
0000                  (      romdefs.asm):01714         CmdINT                          EQU     CCmdINT
0000                  (      romdefs.asm):01715         CmdJoystk                       EQU     CCmdJoystk
0000                  (      romdefs.asm):01716         CmdLeftS                        EQU     CCmdLeftS
0000                  (      romdefs.asm):01717         CmdLEN                          EQU     CCmdLEN
0000                  (      romdefs.asm):01718         CmdLet                          EQU     CCmdLet
0000                  (      romdefs.asm):01719         CmdLine                         EQU     CCmdLine
0000                  (      romdefs.asm):01720         CmdLineInput                    EQU     CCmdLineInput
0000                  (      romdefs.asm):01721         CmdList                         EQU     CCmdList
0000                  (      romdefs.asm):01722         CmdLList                        EQU     CCmdLList
0000                  (      romdefs.asm):01723         CmdLOG                          EQU     CCmdLOG
0000                  (      romdefs.asm):01724         CmdMEM                          EQU     CCmdMEM
0000                  (      romdefs.asm):01725         CmdMidS                         EQU     CCmdMidS
0000                  (      romdefs.asm):01726         CmdMinus                        EQU     CCmdMinus
0000                  (      romdefs.asm):01727         CmdMotor                        EQU     CCmdMotor
0000                  (      romdefs.asm):01728         CmdMultiply                     EQU     CCmdMultiply
0000                  (      romdefs.asm):01729         CmdNew                          EQU     CCmdNew
0000                  (      romdefs.asm):01730         CmdNext                         EQU     CCmdNext
0000                  (      romdefs.asm):01731         CmdON                           EQU     CCmdON
0000                  (      romdefs.asm):01732         CmdOpen                         EQU     CCmdOpen
0000                  (      romdefs.asm):01733         CmdOpenEntry                    EQU     CCmdOpenEntry
0000                  (      romdefs.asm):01734         CmdOR                           EQU     CCmdOR
0000                  (      romdefs.asm):01735         CmdPaint                        EQU     CCmdPaint
0000                  (      romdefs.asm):01736         CmdPClear                       EQU     CCmdPClear
0000                  (      romdefs.asm):01737         CmdPCls                         EQU     CCmdPCls
0000                  (      romdefs.asm):01738         CmdPcopy                        EQU     CCmdPcopy
0000                  (      romdefs.asm):01739         CmdPeek                         EQU     CCmdPeek
0000                  (      romdefs.asm):01740         CmdPlay                         EQU     CCmdPlay
0000                  (      romdefs.asm):01741         CmdPlus                         EQU     CCmdPlus
0000                  (      romdefs.asm):01742         CmdPmode                        EQU     CCmdPmode
0000                  (      romdefs.asm):01743         CmdPoint                        EQU     CCmdPoint
0000                  (      romdefs.asm):01744         CmdPoke                         EQU     CCmdPoke
0000                  (      romdefs.asm):01745         CmdPOS                          EQU     CCmdPOS
0000                  (      romdefs.asm):01746         CmdPPoint                       EQU     CCmdPPoint
0000                  (      romdefs.asm):01747         CmdPReset                       EQU     CCmdPReset
0000                  (      romdefs.asm):01748         CmdPrint                        EQU     CCmdPrint
0000                  (      romdefs.asm):01749         CmdPset                         EQU     CCmdPset
0000                  (      romdefs.asm):01750         CmdPut                          EQU     CCmdPut
0000                  (      romdefs.asm):01751         CmdRead                         EQU     CCmdRead
0000                  (      romdefs.asm):01752         CmdReadFromX                    EQU     CCmdReadFromX
0000                  (      romdefs.asm):01753         CmdREM                          EQU     CCmdREM
0000                  (      romdefs.asm):01754         CmdRenum                        EQU     CCmdRenum
0000                  (      romdefs.asm):01755         CmdReset                        EQU     CCmdReset
0000                  (      romdefs.asm):01756         CmdRestore                      EQU     CCmdRestore
0000                  (      romdefs.asm):01757         CmdReturn                       EQU     CCmdReturn
0000                  (      romdefs.asm):01758         CmdRightS                       EQU     CCmdRightS
0000                  (      romdefs.asm):01759         CmdRND                          EQU     CCmdRND
0000                  (      romdefs.asm):01760         CmdRun                          EQU     CCmdRun
0000                  (      romdefs.asm):01761         CmdScreen                       EQU     CCmdScreen
0000                  (      romdefs.asm):01762         CmdSet                          EQU     CCmdSet
0000                  (      romdefs.asm):01763         CmdSGN                          EQU     CCmdSGN
0000                  (      romdefs.asm):01764         CmdSIN                          EQU     CCmdSIN
0000                  (      romdefs.asm):01765         CmdSkipf                        EQU     CCmdSkipf
0000                  (      romdefs.asm):01766         CmdSound                        EQU     CCmdSound
0000                  (      romdefs.asm):01767         CmdSQR                          EQU     CCmdSQR
0000                  (      romdefs.asm):01768         CmdStop                         EQU     CCmdStop
0000                  (      romdefs.asm):01769         CmdStringS                      EQU     CCmdStringS
0000                  (      romdefs.asm):01770         CmdSTRS                         EQU     CCmdSTRS
0000                  (      romdefs.asm):01771         CmdTAN                          EQU     CCmdTAN
0000                  (      romdefs.asm):01772         CmdTimer                        EQU     CCmdTimer
0000                  (      romdefs.asm):01773         CmdTroff                        EQU     CCmdTroff
0000                  (      romdefs.asm):01774         CmdTron                         EQU     CCmdTron
0000                  (      romdefs.asm):01775         CmdUSR                          EQU     CCmdUSR
0000                  (      romdefs.asm):01776         CmdVAL                          EQU     CCmdVAL
0000                  (      romdefs.asm):01777         CmdVarptr                       EQU     CCmdVarptr
0000                  (      romdefs.asm):01778         GrBackground                    EQU     CGrBackground
0000                  (      romdefs.asm):01779         GrBytesPerLine                  EQU     CGrBytesPerLine
0000                  (      romdefs.asm):01780         GrCalcPixelPos                  EQU     CGrCalcPixelPos
0000                  (      romdefs.asm):01781         GrCircleRadius                  EQU     CGrCircleRadius
0000                  (      romdefs.asm):01782         GrCircleXCo                     EQU     CGrCircleXCo
0000                  (      romdefs.asm):01783         GrCircleYCo                     EQU     CGrCircleYCo
0000                  (      romdefs.asm):01784         GrClearGrScreen                 EQU     CGrClearGrScreen
0000                  (      romdefs.asm):01785         GrColourSet                     EQU     CGrColourSet
0000                  (      romdefs.asm):01786         GrColourTemp                    EQU     CGrColourTemp
0000                  (      romdefs.asm):01787         GrCurrColour                    EQU     CGrCurrColour
0000                  (      romdefs.asm):01788         GrCurrPmode                     EQU     CGrCurrPmode
0000                  (      romdefs.asm):01789         GrCurrX                         EQU     CGrCurrX
0000                  (      romdefs.asm):01790         GrCurrXCo                       EQU     CGrCurrXCo
0000                  (      romdefs.asm):01791         GrCurrY                         EQU     CGrCurrY
0000                  (      romdefs.asm):01792         GrCurrYCo                       EQU     CGrCurrYCo
0000                  (      romdefs.asm):01793         GrDirtyFlag                     EQU     CGrDirtyFlag
0000                  (      romdefs.asm):01794         GrDisplayStartAddr              EQU     CGrDisplayStartAddr
0000                  (      romdefs.asm):01795         GrDraw                          EQU     CGrDraw
0000                  (      romdefs.asm):01796         GrDrawAngle                     EQU     CGrDrawAngle
0000                  (      romdefs.asm):01797         GrDrawScale                     EQU     CGrDrawScale
0000                  (      romdefs.asm):01798         GrForeground                    EQU     CGrForeground
0000                  (      romdefs.asm):01799         GrLastDisplayAddr               EQU     CGrLastDisplayAddr
0000                  (      romdefs.asm):01800         GrPixelNoX                      EQU     CGrPixelNoX
0000                  (      romdefs.asm):01801         GrPixelNoY                      EQU     CGrPixelNoY
0000                  (      romdefs.asm):01802         GrPlotFlag                      EQU     CGrPlotFlag
0000                  (      romdefs.asm):01803         GrReserveGrRam                  EQU     CGrReserveGrRam
0000                  (      romdefs.asm):01804         GrResetLRGPixel                 EQU     CGrResetLRGPixel
0000                  (      romdefs.asm):01805         GrSelectColourSet               EQU     CGrSelectColourSet
0000                  (      romdefs.asm):01806         GrSelectDisplay                 EQU     CGrSelectDisplay
0000                  (      romdefs.asm):01807         GrSelectPage                    EQU     CGrSelectPage
0000                  (      romdefs.asm):01808         GrSelectVDGColSet               EQU     CGrSelectVDGColSet
0000                  (      romdefs.asm):01809         GrSetColours                    EQU     CGrSetColours
0000                  (      romdefs.asm):01810         GrSetLRGPixel                   EQU     CGrSetLRGPixel
0000                  (      romdefs.asm):01811         GrSetResetData                  EQU     CGrSetResetData
0000                  (      romdefs.asm):01812         GrSetVDGMode                    EQU     CGrSetVDGMode
0000                  (      romdefs.asm):01813         GrSetVDGOffset                  EQU     CGrSetVDGOffset
0000                  (      romdefs.asm):01814         GrStartPages                    EQU     CGrStartPages
0000                  (      romdefs.asm):01815         IndCasBlockIn                   EQU     CIndCasBlockIn
0000                  (      romdefs.asm):01816         IndCasBlockOut                  EQU     CIndCasBlockOut
0000                  (      romdefs.asm):01817         IndCasOnRead                    EQU     CIndCasOnRead
0000                  (      romdefs.asm):01818         IndCasWriteLead                 EQU     CIndCasWriteLead
0000                  (      romdefs.asm):01819         IndCharOutput                   EQU     CIndCharOutput
0000                  (      romdefs.asm):01820         IndJoystickIn                   EQU     CIndJoystickIn
0000                  (      romdefs.asm):01821         IndKeyInput                     EQU     CIndKeyInput
0000                  (      romdefs.asm):01822         IndVecReset                     EQU     CIndVecReset
0000                  (      romdefs.asm):01823         Misc16BitScratch                EQU     CMisc16BitScratch
0000                  (      romdefs.asm):01824         PixMaskTable2Col                EQU     CPixMaskTable2Col
0000                  (      romdefs.asm):01825         PixMaskTable4Col                EQU     CPixMaskTable4Col
0000                  (      romdefs.asm):01826         PrinterCRLF                     EQU     CPrinterCRLF
0000                  (      romdefs.asm):01827         PrinterDirOut                   EQU     CPrinterDirOut
0000                  (      romdefs.asm):01828         PrinterOut                      EQU     CPrinterOut
0000                  (      romdefs.asm):01829         SecVecFIRQ                      EQU     CSecVecFIRQ
0000                  (      romdefs.asm):01830         SecVecIRQ                       EQU     CSecVecIRQ
0000                  (      romdefs.asm):01831         SecVecNMI                       EQU     CSecVecNMI
0000                  (      romdefs.asm):01832         SecVecSWI                       EQU     CSecVecSWI
0000                  (      romdefs.asm):01833         SecVecSWI2                      EQU     CSecVecSWI2
0000                  (      romdefs.asm):01834         SecVecSWI3                      EQU     CSecVecSWI3
0000                  (      romdefs.asm):01835         SerDLBaud                       EQU     CSerDLBaud
0000                  (      romdefs.asm):01836         SerDLTimeout                    EQU     CSerDLTimeout
0000                  (      romdefs.asm):01837         SndBeep                         EQU     CSndBeep
0000                  (      romdefs.asm):01838         SndDisable                      EQU     CSndDisable
0000                  (      romdefs.asm):01839         SndDotNoteScale                 EQU     CSndDotNoteScale
0000                  (      romdefs.asm):01840         SndDTOAOn                       EQU     CSndDTOAOn
0000                  (      romdefs.asm):01841         SndEnable                       EQU     CSndEnable
0000                  (      romdefs.asm):01842         SndLength                       EQU     CSndLength
0000                  (      romdefs.asm):01843         SndNoteLen                      EQU     CSndNoteLen
0000                  (      romdefs.asm):01844         SndOctave                       EQU     CSndOctave
0000                  (      romdefs.asm):01845         SndPitch                        EQU     CSndPitch
0000                  (      romdefs.asm):01846         SndPlayNote                     EQU     CSndPlayNote
0000                  (      romdefs.asm):01847         SndTempo                        EQU     CSndTempo
0000                  (      romdefs.asm):01848         SndTimerPlay                    EQU     CSndTimerPlay
0000                  (      romdefs.asm):01849         SndVolume                       EQU     CSndVolume
0000                  (      romdefs.asm):01850         SysBoot64                       EQU     CSysBoot64
0000                  (      romdefs.asm):01851         SysErr                          EQU     CSysErr
0000                  (      romdefs.asm):01852         SysErr2                         EQU     CSysErr2
0000                  (      romdefs.asm):01853         SysReadJoystick                 EQU     CSysReadJoystick
0000                  (      romdefs.asm):01854         SysReset                        EQU     CSysReset
0000                  (      romdefs.asm):01855         SysResetDA                      EQU     CSysResetDA
0000                  (      romdefs.asm):01856         SysSelJoystick                  EQU     CSysSelJoystick
0000                  (      romdefs.asm):01857         SysTimeVal                      EQU     CSysTimeVal
0000                  (      romdefs.asm):01858         SysWriteDA                      EQU     CSysWriteDA
0000                  (      romdefs.asm):01859         TextCapsLock                    EQU     CTextCapsLock
0000                  (      romdefs.asm):01860         TextClearLine                   EQU     CTextClearLine
0000                  (      romdefs.asm):01861         TextCls                         EQU     CTextCls
0000                  (      romdefs.asm):01862         TextClsChar                     EQU     CTextClsChar
0000                  (      romdefs.asm):01863         TextCursFalshCnt                EQU     CTextCursFalshCnt
0000                  (      romdefs.asm):01864         TextDevN                        EQU     CTextDevN
0000                  (      romdefs.asm):01865         TextKbdBuffAddr                 EQU     CTextKbdBuffAddr
0000                  (      romdefs.asm):01866         TextKbdDelay                    EQU     CTextKbdDelay
0000                  (      romdefs.asm):01867         TextKbdRollover                 EQU     CTextKbdRollover
0000                  (      romdefs.asm):01868         TextLastKey                     EQU     CTextLastKey
0000                  (      romdefs.asm):01869         TextOutChar                     EQU     CTextOutChar
0000                  (      romdefs.asm):01870         TextOutCRLF                     EQU     CTextOutCRLF
0000                  (      romdefs.asm):01871         TextOutNum16                    EQU     CTextOutNum16
0000                  (      romdefs.asm):01872         TextOutNumFPA0                  EQU     CTextOutNumFPA0
0000                  (      romdefs.asm):01873         TextOutQuestion                 EQU     CTextOutQuestion
0000                  (      romdefs.asm):01874         TextOutSpace                    EQU     CTextOutSpace
0000                  (      romdefs.asm):01875         TextOutString                   EQU     CTextOutString
0000                  (      romdefs.asm):01876         TextPrnAutoCRLF                 EQU     CTextPrnAutoCRLF
0000                  (      romdefs.asm):01877         TextPrnCommaW                   EQU     CTextPrnCommaW
0000                  (      romdefs.asm):01878         TextPrnCurrCol                  EQU     CTextPrnCurrCol
0000                  (      romdefs.asm):01879         TextPrnEOLCnt                   EQU     CTextPrnEOLCnt
0000                  (      romdefs.asm):01880         TextPrnEOLSeq                   EQU     CTextPrnEOLSeq
0000                  (      romdefs.asm):01881         TextPrnLastComma                EQU     CTextPrnLastComma
0000                  (      romdefs.asm):01882         TextPrnLineW                    EQU     CTextPrnLineW
0000                  (      romdefs.asm):01883         TextPrnSelFlag                  EQU     CTextPrnSelFlag
0000                  (      romdefs.asm):01884         TextResetVDU                    EQU     CTextResetVDU
0000                  (      romdefs.asm):01885         TextScanKbd                     EQU     CTextScanKbd
0000                  (      romdefs.asm):01886         TextSerBaudRate                 EQU     CTextSerBaudRate
0000                  (      romdefs.asm):01887         TextSerEOLDelay                 EQU     CTextSerEOLDelay
0000                  (      romdefs.asm):01888         TextUpdateCurs                  EQU     CTextUpdateCurs
0000                  (      romdefs.asm):01889         TextVDUCommaW                   EQU     CTextVDUCommaW
0000                  (      romdefs.asm):01890         TextVDUCurrCol                  EQU     CTextVDUCurrCol
0000                  (      romdefs.asm):01891         TextVDUCursAddr                 EQU     CTextVDUCursAddr
0000                  (      romdefs.asm):01892         TextVDULastComma                EQU     CTextVDULastComma
0000                  (      romdefs.asm):01893         TextVDULineW                    EQU     CTextVDULineW
0000                  (      romdefs.asm):01894         TextVDUOut                      EQU     CTextVDUOut
0000                  (      romdefs.asm):01895         TextWaitKey                     EQU     CTextWaitKey
0000                  (      romdefs.asm):01896         TextWaitKeyCurs                 EQU     CTextWaitKeyCurs
0000                  (      romdefs.asm):01897         TextWaitKeyCurs2                EQU     CTextWaitKeyCurs2
0000                  (      romdefs.asm):01898         UtilCopyBXtoU                   EQU     CUtilCopyBXtoU
0000                  (      romdefs.asm):01899         VarAssign16Bit                  EQU     CVarAssign16Bit
0000                  (      romdefs.asm):01900         VarAssign16Bit2                 EQU     CVarAssign16Bit2
0000                  (      romdefs.asm):01901         VarAssign16BitB                 EQU     CVarAssign16BitB
0000                  (      romdefs.asm):01902         VarAssign8Bit                   EQU     CVarAssign8Bit
0000                  (      romdefs.asm):01903         VarCKChar                       EQU     CVarCKChar
0000                  (      romdefs.asm):01904         VarCKClBrac                     EQU     CVarCKClBrac
0000                  (      romdefs.asm):01905         VarCKComma                      EQU     CVarCKComma
0000                  (      romdefs.asm):01906         VarCKOpBrac                     EQU     CVarCKOpBrac
0000                  (      romdefs.asm):01907         VarDelVar                       EQU     CVarDelVar
0000                  (      romdefs.asm):01908         VarGarbageCollect               EQU     CVarGarbageCollect
0000                  (      romdefs.asm):01909         VarGet16Bit                     EQU     CVarGet16Bit
0000                  (      romdefs.asm):01910         VarGet8Bit                      EQU     CVarGet8Bit
0000                  (      romdefs.asm):01911         VarGetComma8                    EQU     CVarGetComma8
0000                  (      romdefs.asm):01912         VarGetExpr                      EQU     CVarGetExpr
0000                  (      romdefs.asm):01913         VarGetExprCC                    EQU     CVarGetExprCC
0000                  (      romdefs.asm):01914         VarGetStr                       EQU     CVarGetStr
0000                  (      romdefs.asm):01915         VarGetUsr                       EQU     CVarGetUsr
0000                  (      romdefs.asm):01916         VarGetVar                       EQU     CVarGetVar
0000                  (      romdefs.asm):01917         VarNormFPA0                     EQU     CVarNormFPA0
0000                  (      romdefs.asm):01918         VectAccessScreen                EQU     CVectAccessScreen
0000                  (      romdefs.asm):01919         VectAssignStr                   EQU     CVectAssignStr
0000                  (      romdefs.asm):01920         VectBase                        EQU     CVectBase
0000                  (      romdefs.asm):01921         VectCheckEOF                    EQU     CVectCheckEOF
0000                  (      romdefs.asm):01922         VectCheckKeys                   EQU     CVectCheckKeys
0000                  (      romdefs.asm):01923         VectCloseAllFiles               EQU     CVectCloseAllFiles
0000                  (      romdefs.asm):01924         VectCloseFile                   EQU     CVectCloseFile
0000                  (      romdefs.asm):01925         VectCloseFileCmd                EQU     CVectCloseFileCmd
0000                  (      romdefs.asm):01926         VectCmdInterp                   EQU     CVectCmdInterp
0000                  (      romdefs.asm):01927         VectDeTokenize                  EQU     CVectDeTokenize
0000                  (      romdefs.asm):01928         VectDevInit                     EQU     CVectDevInit
0000                  (      romdefs.asm):01929         VectDevNo                       EQU     CVectDevNo
0000                  (      romdefs.asm):01930         VectDevOpen                     EQU     CVectDevOpen
0000                  (      romdefs.asm):01931         VectEvaluateExpr                EQU     CVectEvaluateExpr
0000                  (      romdefs.asm):01932         VectGetNextCmd                  EQU     CVectGetNextCmd
0000                  (      romdefs.asm):01933         VectInChar                      EQU     CVectInChar
0000                  (      romdefs.asm):01934         VectInputFile                   EQU     CVectInputFile
0000                  (      romdefs.asm):01935         VectLineInputFile               EQU     CVectLineInputFile
0000                  (      romdefs.asm):01936         VectOutChar                     EQU     CVectOutChar
0000                  (      romdefs.asm):01937         VectOutputFile                  EQU     CVectOutputFile
0000                  (      romdefs.asm):01938         VectReReqestIn                  EQU     CVectReReqestIn
0000                  (      romdefs.asm):01939         VectResetBasMem                 EQU     CVectResetBasMem
0000                  (      romdefs.asm):01940         VectRunLink                     EQU     CVectRunLink
0000                  (      romdefs.asm):01941         VectSysError                    EQU     CVectSysError
0000                  (      romdefs.asm):01942         VectTokenize                    EQU     CVectTokenize
0000                  (      romdefs.asm):01943         VectUserError                   EQU     CVectUserError
0000                  (      romdefs.asm):01944         WarmStart                       EQU     CWarmStart
0000                  (      romdefs.asm):01945         WarmStartFlag                   EQU     CWarmStartFlag
                      (      romdefs.asm):01946         
                      (      romdefs.asm):01947                                 ENDC
                      (      romdefs.asm):01948                                 
     008A             (      romdefs.asm):01949         DBZero          EQU     Misc16BitScratch ; this is always set to Zero.
                      (      romdefs.asm):01950                                 
     003A             (      romdefs.asm):01951         StackBuf        equ     $3A             ; stack buffer size
     003D             (      romdefs.asm):01952         RelPTR          equ     $03D            ; Tempory arithmetic/logical table ptr
     00FA             (      romdefs.asm):01953         LineBufMax      equ     250             ; maximum line buffer length
                      (      romdefs.asm):01954         
                      (      romdefs.asm):01955         ; For compatibility with CoCo ROM listings
                      (      romdefs.asm):01956         ; first floating point accumulator
     004F             (      romdefs.asm):01957         FP0EXP          equ     BasVarFPAcc1    ; exponent
     0050             (      romdefs.asm):01958         FPA0            equ     BasVarFPAcc1+1  ; mantissa
     0054             (      romdefs.asm):01959         FP0SGN          equ     BasVarFPAcc1+5  ; sign
     0055             (      romdefs.asm):01960         COEFCT          equ     BasVarFPAcc1+6  ; polynomial coeficient counter
     0056             (      romdefs.asm):01961         StrDesc         equ     BasVarFPAcc1+7  ; tempory string descriptor (5 bytes)
                      (      romdefs.asm):01962         
                      (      romdefs.asm):01963         ; second floating point accumulator
     005C             (      romdefs.asm):01964         FP1EXP          equ     BasVarFPAcc2    ; exponent $5C
     005D             (      romdefs.asm):01965         FPA1            equ     BasVarFPAcc2+1  ; mantissa $5D
     0061             (      romdefs.asm):01966         FP1SGN          equ     BasVarFPAcc2+5  ; sign $61
     0062             (      romdefs.asm):01967         ResSGN          equ     BasVarFPAcc2+6  ; sign of result of FP operation $62
     0063             (      romdefs.asm):01968         FPSByte         equ     BasVarFPAcc2+7  ; floating point sub byte $63
     0064             (      romdefs.asm):01969         CoefPTR         equ     BasVarFPAcc2+8  ; Coeficient pointer
                      (      romdefs.asm):01970         
     005B             (      romdefs.asm):01971         FPCARY          equ     $005B   
                      (      romdefs.asm):01972         
     0013             (      romdefs.asm):01973         FPA2            equ     BasTempFPA2     ; FPA2
                      (      romdefs.asm):01974         
     00AB             (      romdefs.asm):01975         VarAB           equ     $00AB           ; temp vars / RND
     00AC             (      romdefs.asm):01976         VarAC           equ     $00AC           ; temp vars / RND
     00AD             (      romdefs.asm):01977         VarAD           equ     $00AD           ; temp vars / RND
     00AE             (      romdefs.asm):01978         VarAE           equ     $00AE           ; temp vars / RND
                      (      romdefs.asm):01979         
                      (      romdefs.asm):01980         ;
                      (      romdefs.asm):01981         ; Device numbers
                      (      romdefs.asm):01982         ;
                      (      romdefs.asm):01983         
     0000             (      romdefs.asm):01984         DevConsole      equ     0               ; console
     FFFF             (      romdefs.asm):01985         DevCasette      equ     -1              ; cassette
     FFFE             (      romdefs.asm):01986         DevPrinter      equ     -2              ; printer
                      (      romdefs.asm):01987                 
                      (      romdefs.asm):01988         ;
                      (      romdefs.asm):01989         ; Cassette file types
                      (      romdefs.asm):01990         ;
     0055             (      romdefs.asm):01991         SyncByte        equ     $55             ; Sync byte in cassete files
     003C             (      romdefs.asm):01992         BlockBegin      equ     $3C             ; Begining of block marker
                      (      romdefs.asm):01993         
                      (      romdefs.asm):01994         ;Block Types
     0000             (      romdefs.asm):01995         BtFileName      equ     $00             ; File name block
     0001             (      romdefs.asm):01996         BtData          equ     $01             ; Data block
     00FF             (      romdefs.asm):01997         BtEOF           equ     $FF             ; End of file block
                      (      romdefs.asm):01998         
     000F             (      romdefs.asm):01999         FNameBlockLen   equ     15              ; 15 bytes in header block
     0008             (      romdefs.asm):02000         CasFilenameLen  equ     8               ; Cassette filename length
     00FA             (      romdefs.asm):02001         DefBlockSize    equ     250             ; Default block size
                      (      romdefs.asm):02002         
                      (      romdefs.asm):02003         ;File Types, as stored in filename block
     0000             (      romdefs.asm):02004         FtBasic         equ     $00             ; Basic program
     0001             (      romdefs.asm):02005         FtDataFile      equ     $01             ; Data file
     0002             (      romdefs.asm):02006         FtMachineCode   equ     $02             ; Machine code program
     0003             (      romdefs.asm):02007         FtBinary        equ     $03             ; Binary file
     0088             (      romdefs.asm):02008         FtDream         equ     $88             ; Dream Assembler source file
     00FF             (      romdefs.asm):02009         FtHeaderless    equ     $FF             ; Headerless
                      (      romdefs.asm):02010         
                      (      romdefs.asm):02011         ;Ascii/Binary flag from filename block
     00FF             (      romdefs.asm):02012         AsAscii         equ     $FF             ; ASCII file
     0000             (      romdefs.asm):02013         AsBinary        equ     $00             ; Binary file (tokenised basic)
                      (      romdefs.asm):02014         
                      (      romdefs.asm):02015         ; Gap Flag from filename block
     0000             (      romdefs.asm):02016         GfUngapped      equ     $00             ; No gaps
     00FF             (      romdefs.asm):02017         GfGapped        equ     $FF             ; Gaps between blocks
                      (      romdefs.asm):02018         
                      (      romdefs.asm):02019         ; Cassette file IO types
     0001             (      romdefs.asm):02020         CasInputFile    equ     1               ; input file
     0002             (      romdefs.asm):02021         CasOutputFile   equ     2               ; output file
                      (      romdefs.asm):02022         
                      (      romdefs.asm):02023         ;
                      (      romdefs.asm):02024         ; Screen metrics.
                      (      romdefs.asm):02025         ;
     00FF             (      romdefs.asm):02026         GrMaxX          equ     255             ; Maximum X co-ordinate
     00BF             (      romdefs.asm):02027         GrMaxY          equ     191             ; Maximum Y co-ordinate
     0008             (      romdefs.asm):02028         GrMaxColour     equ     8               ; maximum colour number
     0004             (      romdefs.asm):02029         GrMaxPmode      equ     4               ; maximum pmode 
     0001             (      romdefs.asm):02030         GrMaxColourSet  equ     1               ; maximum colour set    
     0008             (      romdefs.asm):02031         GrMaxPages      equ     8               ; maximum PCLEAR pages
     0600             (      romdefs.asm):02032         GrPageSize      equ     $600            ; Graphic (pclear) page size in bytes
                      (      romdefs.asm):02033         
     0006             (      romdefs.asm):02034         GrStartPage     equ     $06             ; default start page for graphics memory $0600
     001E             (      romdefs.asm):02035         BasStartPage    equ     $1E             ; default start page for basic program $1E00
                      (      romdefs.asm):02036         
     0400             (      romdefs.asm):02037         TextScreenBase  equ     $0400           ; base of text screen
     0600             (      romdefs.asm):02038         GrScreenBase    equ     $0600           ; base of graphics pages
     0200             (      romdefs.asm):02039         TextScreenLen   equ     $0200           ; Length of text screen
     05FF             (      romdefs.asm):02040         TextScreenLast  equ     (TextScreenBase+TextScreenLen)-1        ; last character of text screen
                      (      romdefs.asm):02041         
                      (      romdefs.asm):02042         ;
                      (      romdefs.asm):02043         ; Lo-res colour masks
                      (      romdefs.asm):02044         ;
                      (      romdefs.asm):02045         
     0000             (      romdefs.asm):02046         MaskGreen       equ     $00             ; Green
     0010             (      romdefs.asm):02047         MaskYellow      equ     $10             ; Yellow
     0020             (      romdefs.asm):02048         MaskBlue        equ     $20             ; Blue
     0030             (      romdefs.asm):02049         MaskRed         equ     $30             ; red
     0040             (      romdefs.asm):02050         MaskBuff        equ     $40             ; buff / white
     0050             (      romdefs.asm):02051         MaskCyan        equ     $50             ; cyan
     0060             (      romdefs.asm):02052         MaskMagenta     equ     $60             ; magenta
     0070             (      romdefs.asm):02053         MaskOrange      equ     $70             ; orange
                      (      romdefs.asm):02054         
     0010             (      romdefs.asm):02055         LRGColourDiff   equ     $10             ; difference between colours    
                      (      romdefs.asm):02056         
                      (      romdefs.asm):02057         ;
                      (      romdefs.asm):02058         ; Lo-res pixel masks
                      (      romdefs.asm):02059         ;
     0008             (      romdefs.asm):02060         MaskUpR         equ     $08             ; upper right
     0004             (      romdefs.asm):02061         MaskUpL         equ     $04             ; upper left
     0002             (      romdefs.asm):02062         MaskLowR        equ     $02             ; lower right
     0001             (      romdefs.asm):02063         MaskLowL        equ     $01             ; lower left
     000F             (      romdefs.asm):02064         MaskAllOn       equ     (MaskUpR+MaskUpL+MaskLowR+MaskLowL)     ; all on
     0000             (      romdefs.asm):02065         MaskAllOff      equ     $00             ; all off
                      (      romdefs.asm):02066         
     0080             (      romdefs.asm):02067         MaskLRG         equ     $80             ; low res graphics
                      (      romdefs.asm):02068         
                      (      romdefs.asm):02069         ; 
                      (      romdefs.asm):02070         ; Lo-res (semigraphics) and text screen metrics.
                      (      romdefs.asm):02071         ;
                      (      romdefs.asm):02072         
     003F             (      romdefs.asm):02073         LoMaxX          equ     63              ; Maximum lo-res X co-ordinate
     001F             (      romdefs.asm):02074         LoMaxY          equ     31              ; Maximum lo-res Y co-ordinate
     0008             (      romdefs.asm):02075         LoMaxColour     equ     8               ; max lo-res colour
     0020             (      romdefs.asm):02076         TextCharsLine   equ     32              ; Text/Lo-res character cells per line
                      (      romdefs.asm):02077         
                      (      romdefs.asm):02078         ;
                      (      romdefs.asm):02079         ; Cartridge entry points
                      (      romdefs.asm):02080         ;
                      (      romdefs.asm):02081         
     C000             (      romdefs.asm):02082         CartBase        equ     $c000           ; cartridge area base
     C000             (      romdefs.asm):02083         CartEntryFIRQ   equ     CartBase        ; entry point when FIRQ generated
     C002             (      romdefs.asm):02084         CartEntryDOS    equ     CartBase+2      ; entry point when dos flag found 'DK' at $C000
     444B             (      romdefs.asm):02085         CartDOSFlag     equ     $444B           ; Dos flag word : 'DK' 
                      (      romdefs.asm):02086         
                      (      romdefs.asm):02087         ;
                      (      romdefs.asm):02088         ; Dragon 64 RAM basic stuff
                      (      romdefs.asm):02089         ;
                      (      romdefs.asm):02090         
     C000             (      romdefs.asm):02091         D64RAMBase      equ     $C000           ; Dragon 64 RAM basic starts at $c000
     FEFF             (      romdefs.asm):02092         D64RAMTop       equ     $FEFF           ; Dragon 64 RAM ends here 
                      (      romdefs.asm):02093         
                      (      romdefs.asm):02094         ;
                      (      romdefs.asm):02095         ; Firmware flag used by warm start and RAM basic boot
                      (      romdefs.asm):02096         ;
     0055             (      romdefs.asm):02097         FFlagTrue       equ     $55             ; flag initialised / true
     0012             (      romdefs.asm):02098         NOPFlag         equ     $12             ; op-code fro NOP, used to mark start of reset vector           
                      (      romdefs.asm):02099         
                      (      romdefs.asm):02100         ;
                      (      romdefs.asm):02101         ; General evaluation vars, multiple uses
                      (      romdefs.asm):02102         ;
                      (      romdefs.asm):02103         
     0037             (      romdefs.asm):02104         Eval37  equ     $37
     0038             (      romdefs.asm):02105         Eval38  equ     $38
     0039             (      romdefs.asm):02106         Eval39  equ     $39
     003A             (      romdefs.asm):02107         Eval3A  equ     $3A
     003B             (      romdefs.asm):02108         Eval3B  equ     $3B
     003C             (      romdefs.asm):02109         Eval3C  equ     $3C
     003E             (      romdefs.asm):02110         Eval3E  equ     $3E
     003F             (      romdefs.asm):02111         Eval3F  equ     $3F
                      (      romdefs.asm):02112         
     0040             (      romdefs.asm):02113         Eval40  equ     $40
     0041             (      romdefs.asm):02114         Eval41  equ     $41
     0042             (      romdefs.asm):02115         Eval42  equ     $42
     0043             (      romdefs.asm):02116         Eval43  equ     $43
     0044             (      romdefs.asm):02117         Eval44  equ     $44
     0045             (      romdefs.asm):02118         Eval45  equ     $45
     0046             (      romdefs.asm):02119         Eval46  equ     $46
     0047             (      romdefs.asm):02120         Eval47  equ     $47
     0048             (      romdefs.asm):02121         Eval48  equ     $48
     0049             (      romdefs.asm):02122         Eval49  equ     $49
     004A             (      romdefs.asm):02123         Eval4A  equ     $4A
     004B             (      romdefs.asm):02124         Eval4B  equ     $4B
     004C             (      romdefs.asm):02125         Eval4C  equ     $4C
     004D             (      romdefs.asm):02126         Eval4D  equ     $4D
     004E             (      romdefs.asm):02127         Eval4E  equ     $4E
                      (      romdefs.asm):02128         
     00CF             (      romdefs.asm):02129         EvalCF  equ     $CF
                      (      romdefs.asm):02130         
     00D1             (      romdefs.asm):02131         EvalD1  equ     $D1
     00D2             (      romdefs.asm):02132         EvalD2  equ     $D2
     00D3             (      romdefs.asm):02133         EvalD3  equ     $D3
     00D4             (      romdefs.asm):02134         EvalD4  equ     $D4
     00D5             (      romdefs.asm):02135         EvalD5  equ     $D5
     00D6             (      romdefs.asm):02136         EvalD6  equ     $D6
     00D7             (      romdefs.asm):02137         EvalD7  equ     $D7
     00D8             (      romdefs.asm):02138         EvalD8  equ     $D8
     00D9             (      romdefs.asm):02139         EvalD9  equ     $D9
     00DA             (      romdefs.asm):02140         EvalDA  equ     $DA
     00DB             (      romdefs.asm):02141         EvalDB  equ     $DB
     00DC             (      romdefs.asm):02142         EvalDC  equ     $DC     
                      (      romdefs.asm):02143         
     0047             (      romdefs.asm):02144         BasFoundLineNo  EQU     Eval47          ; Address of line number found by BasFindLineNo
                      (    DragonMMC.asm):00116                                 use             mmc2def.asm
                      (      mmc2def.asm):00001         ; /*
                      (      mmc2def.asm):00002         ; mmc2def.h Symbolic defines for DragonMMC
                      (      mmc2def.asm):00003         
                      (      mmc2def.asm):00004         ; 2011-05-25, Phill Harvey-Smith.
                      (      mmc2def.asm):00005         
                      (      mmc2def.asm):00006         ; // Register definitions, these are offsets from 0xFF50 on the Dragon side.
                      (      mmc2def.asm):00007         
                      (      mmc2def.asm):00008         ;; Old mappings                        
                      (      mmc2def.asm):00009         ;CMD_REG                 equ $00
                      (      mmc2def.asm):00010         ;LATCH_REG               equ $01
                      (      mmc2def.asm):00011         ;READ_DATA_REG           equ $02
                      (      mmc2def.asm):00012         ;WRITE_DATA_REG          equ $03
                      (      mmc2def.asm):00013         ;WRITE_DATA_REG          equ READ_DATA_REG
                      (      mmc2def.asm):00014         
     0000             (      mmc2def.asm):00015         CMD_REG                 equ $00
     0001             (      mmc2def.asm):00016         LATCH_REG               equ $01
     0002             (      mmc2def.asm):00017         READ_DATA_REG           equ $02
     0002             (      mmc2def.asm):00018         WRITE_DATA_REG          equ READ_DATA_REG
                      (      mmc2def.asm):00019         
                      (      mmc2def.asm):00020         
                      (      mmc2def.asm):00021         ; // DIR_CMD_REG commands
     0000             (      mmc2def.asm):00022         CMD_DIR_OPEN            equ $00
     0001             (      mmc2def.asm):00023         CMD_DIR_READ            equ $01
     0002             (      mmc2def.asm):00024         CMD_DIR_CWD             equ $02
     0003             (      mmc2def.asm):00025         CMD_DIR_GETCWD                  equ $03
     0004             (      mmc2def.asm):00026         CMD_DIR_MAKE                    equ     $04
     0005             (      mmc2def.asm):00027         CMD_DIR_REMOVE                  equ     $05
     0006             (      mmc2def.asm):00028         CMD_DIR_SET_SNAPPATH    equ $06
     0007             (      mmc2def.asm):00029         CMD_DIR_GET_SNAPPATH    equ $07
                      (      mmc2def.asm):00030         
                      (      mmc2def.asm):00031         ; // CMD_REG_COMMANDS
     0010             (      mmc2def.asm):00032         CMD_FILE_CLOSE          equ $10
     0011             (      mmc2def.asm):00033         CMD_FILE_OPEN_READ      equ $11
     0012             (      mmc2def.asm):00034         CMD_FILE_OPEN_IMG       equ $12
     0013             (      mmc2def.asm):00035         CMD_FILE_OPEN_WRITE     equ $13
     0014             (      mmc2def.asm):00036         CMD_FILE_DELETE         equ $14
     0015             (      mmc2def.asm):00037         CMD_FILE_GETINFO        equ $15
     0016             (      mmc2def.asm):00038         CMD_FILE_OPENAUTOD      equ $16
     0017             (      mmc2def.asm):00039         CMD_FILE_OPENAUTOC      equ $17
     0018             (      mmc2def.asm):00040         CMD_FILE_OPEN_OVERWRITE equ $18
     0019             (      mmc2def.asm):00041         CMD_FILE_OPEN_SNAPR             equ $19
     001A             (      mmc2def.asm):00042         CMD_FILE_OPEN_SNAPW             equ $1A
     001B             (      mmc2def.asm):00043         CMD_FILE_OPEN_STREAMR   equ     $1B
     001C             (      mmc2def.asm):00044         CMD_FILE_OPEN_STREAMW   equ     $1C
     001D             (      mmc2def.asm):00045         CMD_FILE_COPY                   equ $1D
     001E             (      mmc2def.asm):00046         CMD_FILE_RENAME                 equ     $1E
     001F             (      mmc2def.asm):00047         CMD_FILE_OPENCRE_IMG    equ     $1F
                      (      mmc2def.asm):00048         
     0020             (      mmc2def.asm):00049         CMD_INIT_READ           equ $20
     0021             (      mmc2def.asm):00050         CMD_INIT_WRITE          equ $21
     0022             (      mmc2def.asm):00051         CMD_READ_BYTES          equ $22
     0023             (      mmc2def.asm):00052         CMD_WRITE_BYTES         equ $23
     0024             (      mmc2def.asm):00053         CMD_REWIND                          equ $24
     0025             (      mmc2def.asm):00054         CMD_SEEK                            equ $25
     0026             (      mmc2def.asm):00055         CMD_TELL                            equ $26
     0027             (      mmc2def.asm):00056         CMD_GET_FID                         equ $27
                      (      mmc2def.asm):00057         
                      (      mmc2def.asm):00058         ; // READ_DATA_REG "commands"
                      (      mmc2def.asm):00059         
                      (      mmc2def.asm):00060         ; // Utility commands
     0030             (      mmc2def.asm):00061         CMD_GET_STRLEN                  equ $30
                      (      mmc2def.asm):00062         
                      (      mmc2def.asm):00063         ; // EXEC_PACKET_REG "commands"
     003F             (      mmc2def.asm):00064         CMD_EXEC_PACKET         equ $3F
                      (      mmc2def.asm):00065         
                      (      mmc2def.asm):00066         ; // SDOS_LBA_REG commands
     0040             (      mmc2def.asm):00067         CMD_LOAD_LBA            equ $40
     0041             (      mmc2def.asm):00068         CMD_GET_IMG_STATUS      equ $41
     0042             (      mmc2def.asm):00069         CMD_GET_IMG_NAME        equ $42
     0043             (      mmc2def.asm):00070         CMD_READ_IMG_SEC        equ $43
     0044             (      mmc2def.asm):00071         CMD_WRITE_IMG_SEC       equ $44
     0045             (      mmc2def.asm):00072         CMD_SER_IMG_INFO        equ $45
     0046             (      mmc2def.asm):00073         CMD_VALID_IMG_NAMES     equ $46
     0047             (      mmc2def.asm):00074         CMD_IMG_UNMOUNT         equ $47
     0048             (      mmc2def.asm):00075         CMD_IMG_SEEK                    equ $48
     0049             (      mmc2def.asm):00076         CMD_CREATE_IMG                  equ $49
     004A             (      mmc2def.asm):00077         CMD_GET_FDC_STATUS              equ $4A
     004B             (      mmc2def.asm):00078         CMD_READ_NEXT_IMG_SEC   equ $4B
     004C             (      mmc2def.asm):00079         CMD_LOAD_HR             equ $4C
                      (      mmc2def.asm):00080         
                      (      mmc2def.asm):00081         ; // Cassette file commands
                      (      mmc2def.asm):00082         
     0050             (      mmc2def.asm):00083         CMD_CAS_FTYPE                   equ $50
     005F             (      mmc2def.asm):00084         CMD_CAS_EMULATE         equ $5F
                      (      mmc2def.asm):00085         
                      (      mmc2def.asm):00086         ; // UTIL_CMD_REG commands
     0080             (      mmc2def.asm):00087         CMD_GET_CARD_TYPE       equ $80
     0090             (      mmc2def.asm):00088         CMD_SET_BUSY                    equ $90
     0091             (      mmc2def.asm):00089         CMD_NOP                             equ $91
     0092             (      mmc2def.asm):00090         CMD_SYNC                                equ $92
                      (      mmc2def.asm):00091         
     00A0             (      mmc2def.asm):00092         CMD_GET_PORT_DDR        equ $A0
     00A1             (      mmc2def.asm):00093         CMD_SET_PORT_DDR        equ $A1
     00A2             (      mmc2def.asm):00094         CMD_READ_PORT           equ $A2
     00A3             (      mmc2def.asm):00095         CMD_WRITE_PORT          equ $A3
                      (      mmc2def.asm):00096         
     00C0             (      mmc2def.asm):00097         CMD_GET_DATETIME        equ $C0
     00C1             (      mmc2def.asm):00098         CMD_SET_DATETIME        equ $C1
                      (      mmc2def.asm):00099         
     00E0             (      mmc2def.asm):00100         CMD_GET_FW_VER          equ $E0
     00E1             (      mmc2def.asm):00101         CMD_GET_BL_VER          equ $E1
                      (      mmc2def.asm):00102         
     00E8             (      mmc2def.asm):00103         CMD_GET_RAM_CTRL                equ $E8
     00E9             (      mmc2def.asm):00104         CMD_SET_RAM_CTRL                equ $E9
                      (      mmc2def.asm):00105         
     00EF             (      mmc2def.asm):00106         CMD_GET_SAMBITS                 equ     $EF
                      (      mmc2def.asm):00107         
     00F0             (      mmc2def.asm):00108         CMD_GET_CFG_BYTE        equ $F0
     00F1             (      mmc2def.asm):00109         CMD_SET_CFG_BYTE        equ $F1
     00F2             (      mmc2def.asm):00110         CMD_SET_PLATFORM                equ     $F2
     00FD             (      mmc2def.asm):00111         CMD_READ_AUX            equ $FD
     00FE             (      mmc2def.asm):00112         CMD_GET_HEARTBEAT       equ $FE
                      (      mmc2def.asm):00113         
                      (      mmc2def.asm):00114         
                      (      mmc2def.asm):00115         ;// Status codes
                      (      mmc2def.asm):00116         ;// Unlike AtoMMC, DragonMMC should return with STATUS_COMPLETE set when 
                      (      mmc2def.asm):00117         ;// a command completes.
                      (      mmc2def.asm):00118         ;// If an error condition occours, then STATUS_ERROR should be set, this 
                      (      mmc2def.asm):00119         ;// way we can use the 6809 BITA / BITB instructions to test for error.
                      (      mmc2def.asm):00120         ;// this also allows us to BMI on error.
                      (      mmc2def.asm):00121         ;//
                      (      mmc2def.asm):00122         ;// Multi-phase commands like getting directory entries return status 
                      (      mmc2def.asm):00123         ;// complete after each entry. On the last entry this is or'd with 
                      (      mmc2def.asm):00124         ;// STATUS_LAST.
                      (      mmc2def.asm):00125         ;//
     0080             (      mmc2def.asm):00126         STATUS_ERROR                    equ $80
     0040             (      mmc2def.asm):00127         STATUS_COMPLETE                 equ $40
                      (      mmc2def.asm):00128         
     007F             (      mmc2def.asm):00129         ERROR_MASK                          equ $7F
                      (      mmc2def.asm):00130         
                      (      mmc2def.asm):00131         ;// To be or'd with STATUS_COMPLETE
     0001             (      mmc2def.asm):00132         STATUS_LAST                         equ $01
                      (      mmc2def.asm):00133         
                      (      mmc2def.asm):00134         ; FATFS Errors 
     0000             (      mmc2def.asm):00135         FR_OK                               equ $00     ; /* (0) Succeeded */
     0001             (      mmc2def.asm):00136         FR_DISK_ERR                         equ $01 ; /* (1) A hard error occured in the low level disk I/O layer */
     0002             (      mmc2def.asm):00137         FR_INT_ERR                          equ $02 ; /* (2) Assertion failed */
     0003             (      mmc2def.asm):00138         FR_NOT_READY                    equ $03 ; /* (3) The physical drive cannot work */
     0004             (      mmc2def.asm):00139         FR_NO_FILE                          equ $04 ; /* (4) Could not find the file */
     0005             (      mmc2def.asm):00140         FR_NO_PATH                          equ $05 ; /* (5) Could not find the path */
     0006             (      mmc2def.asm):00141         FR_INVALID_NAME                 equ $06 ; /* (6) The path name format is invalid */
     0007             (      mmc2def.asm):00142         FR_DENIED                           equ $07 ; /* (7) Acces denied due to prohibited access or directory full */
     0008             (      mmc2def.asm):00143         FR_EXIST                            equ $08 ; /* (8) Acces denied due to prohibited access */
     0009             (      mmc2def.asm):00144         FR_INVALID_OBJECT               equ $09 ; /* (9) The file/directory object is invalid */
     000A             (      mmc2def.asm):00145         FR_WRITE_PROTECTED              equ $0A ; /* (10) The physical drive is write protected */
     000B             (      mmc2def.asm):00146         FR_INVALID_DRIVE                equ $0B ; /* (11) The logical drive number is invalid */
     000C             (      mmc2def.asm):00147         FR_NOT_ENABLED                  equ $0C ; /* (12) The volume has no work area */
     000D             (      mmc2def.asm):00148         FR_NO_FILESYSTEM                equ $0D ; /* (13) There is no valid FAT volume */
     000E             (      mmc2def.asm):00149         FR_MKFS_ABORTED                 equ $0E ; /* (14) The f_mkfs() aborted due to any parameter error */
     000F             (      mmc2def.asm):00150         FR_TIMEOUT                          equ $0F ; /* (15) Could not get a grant to access the volume within defined period */
     0010             (      mmc2def.asm):00151         FR_LOCKED                           equ $10 ; /* (16) The operation is rejected according to the file shareing policy */
     0011             (      mmc2def.asm):00152         FR_NOT_ENOUGH_CORE              equ $11 ; /* (17) LFN working buffer could not be allocated */
     0012             (      mmc2def.asm):00153         FR_TOO_MANY_OPEN_FILES  equ $12 ; /* (18) Number of open files > _FS_SHARE */
     0013             (      mmc2def.asm):00154         FR_INVALID_PARAMETER    equ $13 ; /* (19) Given parameter is invalid */
                      (      mmc2def.asm):00155                 
                      (      mmc2def.asm):00156         ; // To be or'd with STATUS_ERROR
     0020             (      mmc2def.asm):00157         ERROR_INVALID_CMD               equ $20
     0021             (      mmc2def.asm):00158         ERROR_INVALID_IMAGE             equ $21
     0022             (      mmc2def.asm):00159         ERROR_NO_DATA           equ $22
     0023             (      mmc2def.asm):00160         ERROR_INVALID_DRIVE     equ $23
     0024             (      mmc2def.asm):00161         ERROR_READ_ONLY         equ $24
     0025             (      mmc2def.asm):00162         ERROR_ALREADY_MOUNT     equ $25
     0026             (      mmc2def.asm):00163         ERROR_INVALID_TIME      equ $26
     0027             (      mmc2def.asm):00164         ERROR_INVALID_FID               equ $27
     0028             (      mmc2def.asm):00165         ERROR_INVALID_PARAM             equ $28
     0029             (      mmc2def.asm):00166         ERROR_NO_FREE_FID               equ $29
                      (      mmc2def.asm):00167         
                      (      mmc2def.asm):00168         ; // Config bit flags (system)
     0080             (      mmc2def.asm):00169         CFG_ENABLE_BOOTLOAD             equ $80 
     0004             (      mmc2def.asm):00170         CFG_BACKUP_FILE                 equ     $04
     0002             (      mmc2def.asm):00171         CFG_HIDE_MAC            equ $02
     0001             (      mmc2def.asm):00172         CFG_DEBUG_LOG               equ $01
                      (      mmc2def.asm):00173         
                      (      mmc2def.asm):00174         ; // Config bit flags (Dragon, CoCo)
                      (      mmc2def.asm):00175         
     0040             (      mmc2def.asm):00176         CFG_ENABLE_AUTOBOOT             equ $40
     0020             (      mmc2def.asm):00177         CFG_ENABLE_DOS                  equ $20
     0010             (      mmc2def.asm):00178         CFG_SHOW_DATETIME       equ $10
     0008             (      mmc2def.asm):00179         CFG_SHOW_COMPILE        equ $08
                      (      mmc2def.asm):00180         
                      (      mmc2def.asm):00181         ; File ids....
     0006             (      mmc2def.asm):00182         NO_FILES                                equ 6
     0000             (      mmc2def.asm):00183         CAS_FILE                                equ     0
                      (    DragonMMC.asm):00117                                 use             DragonMMCdef.asm
     FF00             ( DragonMMCdef.asm):00001         IO_BASE                         EQU             $ff00                                   ; I/O Page
     0050             ( DragonMMCdef.asm):00002         DP_REG_BASE                 EQU     $50                                 ; MMC reg base (DP offset)
                      ( DragonMMCdef.asm):00003         
     0050             ( DragonMMCdef.asm):00004         DP_D_CMD_REG            EQU         DP_REG_BASE+CMD_REG         ; command register
     0051             ( DragonMMCdef.asm):00005         DP_D_LATCH_REG          EQU         DP_REG_BASE+LATCH_REG           ; Latch register for command params
     0052             ( DragonMMCdef.asm):00006         DP_D_READ_DATA_REG      EQU     DP_REG_BASE+READ_DATA_REG       ; Read data register for AVR->Dragon
     0052             ( DragonMMCdef.asm):00007         DP_D_WRITE_DATA_REG     EQU         DP_REG_BASE+WRITE_DATA_REG  ; Write data reg for Dragon->AVR
                      ( DragonMMCdef.asm):00008         
     FF50             ( DragonMMCdef.asm):00009         D_CMD_REG                       EQU         IO_BASE+DP_D_CMD_REG            ; command register
     FF51             ( DragonMMCdef.asm):00010         D_LATCH_REG                     EQU         IO_BASE+DP_D_LATCH_REG          ; Latch register for command params
     FF52             ( DragonMMCdef.asm):00011         D_READ_DATA_REG         EQU     IO_BASE+DP_D_READ_DATA_REG      ; Read data register for AVR->Dragon
     FF52             ( DragonMMCdef.asm):00012         D_WRITE_DATA_REG        EQU         IO_BASE+DP_D_WRITE_DATA_REG ; Write data reg for Dragon->AVR
                      ( DragonMMCdef.asm):00013         
     0053             ( DragonMMCdef.asm):00014         DP_D_STATUS_REG         EQU         $53                                         ; Status register.
     FF53             ( DragonMMCdef.asm):00015         D_STATUS_REG            EQU         IO_BASE+DP_D_STATUS_REG             ; Status register.
                      ( DragonMMCdef.asm):00016         
                      ( DragonMMCdef.asm):00017         ;STATUS_FLAG_BUSY       EQU         $01                             ; AVR Busy (old)
     0080             ( DragonMMCdef.asm):00018         STATUS_FLAG_BUSY        EQU         $80                             ; Pico Busy (bmi...)
     0002             ( DragonMMCdef.asm):00019         STATUS_FLAG_READ        EQU         $02                             ; AVR has read our byte
     0004             ( DragonMMCdef.asm):00020         STATUS_FLAG_WRITTEN     EQU         $04                             ; AVR has written a byte
                      ( DragonMMCdef.asm):00021         
                      ( DragonMMCdef.asm):00022         ;
                      ( DragonMMCdef.asm):00023         ; The DragonMMC CPLD contains logic that allows reads from the PIA A side data register
                      ( DragonMMCdef.asm):00024         ; at $FF20 to be substituted with data comeing from the AVR. 
                      ( DragonMMCdef.asm):00025         ; This allows the AVR to generate an FSK'd signal that the default ROM will read
                      ( DragonMMCdef.asm):00026         ; as if it where coming from a real tape. This allows us to bootload the ROM flash program
                      ( DragonMMCdef.asm):00027         ; **BEFORE** the rom contains any valid code.
                      ( DragonMMCdef.asm):00028         ;
                      ( DragonMMCdef.asm):00029         ; Not used in Pico.
                      ( DragonMMCdef.asm):00030         
                      ( DragonMMCdef.asm):00031         ;DP_D_PIA_MAP        EQU     $55                        ; PIA MAP
                      ( DragonMMCdef.asm):00032         ;D_PIA_MAP           EQU     IO_BASE+DP_D_PIA_MAP       ; PIA MAP
                      ( DragonMMCdef.asm):00033         ;D_PIA_MAP_ENABLE    equ     $01                     ; Enable PIA map
                      ( DragonMMCdef.asm):00034         
                      ( DragonMMCdef.asm):00035         ;
                      ( DragonMMCdef.asm):00036         ; The DragonMMC board includes a 32K static RAM chip that can be mapped into the
                      ( DragonMMCdef.asm):00037         ; $8000-$FFEF area, which is normally occupied by the system and cartrige ROMS.
                      ( DragonMMCdef.asm):00038         ; This is done so that the roms can be copied accross and patched for MMC use without
                      ( DragonMMCdef.asm):00039         ; having to have an overlay rom, containing a patched copy of the Dragon's ROM, 
                      ( DragonMMCdef.asm):00040         ; this way I don't end up having to distribute Microsoft owned code.
                      ( DragonMMCdef.asm):00041         ;
                      ( DragonMMCdef.asm):00042         ; Shortly to be retired in favor of a command.
     0054             ( DragonMMCdef.asm):00043         DP_D_RAM_CTRL           EQU         $54                                 ; RAM control reg 
                      ( DragonMMCdef.asm):00044         
     FF54             ( DragonMMCdef.asm):00045         D_RAM_CTRL                  EQU     IO_BASE+DP_D_RAM_CTRL   ; RAM control reg
                      ( DragonMMCdef.asm):00046         
                      ( DragonMMCdef.asm):00047         ; D_RAM_CTRL bit encodings
                      ( DragonMMCdef.asm):00048         ; Not all of these are used in Pico implementation.
                      ( DragonMMCdef.asm):00049         
     0001             ( DragonMMCdef.asm):00050         D_RAM_ENABLE            EQU     $01                                 ; set to enable overlay ram, clear to disable
     0002             ( DragonMMCdef.asm):00051         D_RAM_VEC                   EQU     $02                             ; Read interrupt vectors from ROM (0) or RAM (1)
     0004             ( DragonMMCdef.asm):00052         D_FIRQ_ENABLE           EQU         $04                             ; Enable routing of clock to FIRQ for cart auto-start
     0008             ( DragonMMCdef.asm):00053         D_ROM_A14           EQU     $08                     ; A14 line to the rom, used to select Dragon (0) or CoCo (1)
                      ( DragonMMCdef.asm):00054         
     0010             ( DragonMMCdef.asm):00055         D_RAM_WP                    EQU     $10                             ; set to write protect ram, clear to write enable
     0020             ( DragonMMCdef.asm):00056         D_RAM_VEC_WP        EQU     $20                             ; Write protect area of RAM containing int vectors.
     0040             ( DragonMMCdef.asm):00057         D_NMI_ENABLE        EQU     $40                     ; Enable generation of NMI on snap button press.
                      ( DragonMMCdef.asm):00058         
     00F7             ( DragonMMCdef.asm):00059         D_SEL_DRAGON        EQU     $FF-D_ROM_A14           ; Select dragon
     0008             ( DragonMMCdef.asm):00060         D_SEL_COCO                  EQU     D_ROM_A14                   ; Select coco
                      ( DragonMMCdef.asm):00061         
                      ( DragonMMCdef.asm):00062         ;D_RAM_COLDBOOT      EQU     
                      ( DragonMMCdef.asm):00063         
                      ( DragonMMCdef.asm):00064         ;
                      ( DragonMMCdef.asm):00065         ; The DragonMMC CPLD contains logic that allows it to record writes to the SAM's write only
                      ( DragonMMCdef.asm):00066         ; configuration bits. This allows these to be saved and restored when a snapshot is created.
                      ( DragonMMCdef.asm):00067         ; Since there are 16 SAM control bits the register accupies 2 loacations MSB first, so may
                      ( DragonMMCdef.asm):00068         ; be loaded directly into a 16 bit register : D, X, Y, U, S.
                      ( DragonMMCdef.asm):00069         ;
                      ( DragonMMCdef.asm):00070         ; These are now handled by command CMD_GET_SAMBITS.
                      ( DragonMMCdef.asm):00071         
     0000             ( DragonMMCdef.asm):00072         PLAT_BOOTLOAD       EQU     $00                     ; Bootloader flags
     0001             ( DragonMMCdef.asm):00073         PLAT_DRAGON         EQU     $01                         ; Dragon platform
     0002             ( DragonMMCdef.asm):00074         PLAT_COCO                   EQU     $02                         ; CoCo platform
     00FF             ( DragonMMCdef.asm):00075         PLAT_INVALID        EQU     $FF                     ; Invalid platform flag
                      ( DragonMMCdef.asm):00076         
     0000             ( DragonMMCdef.asm):00077         PLAT_LOW            EQU     PLAT_BOOTLOAD           ; Lowest valid platform
     0002             ( DragonMMCdef.asm):00078         PLAT_HIGH           EQU     PLAT_COCO               ; Highest valid platform
                      ( DragonMMCdef.asm):00079         
     0600             ( DragonMMCdef.asm):00080         VarsBase                    EQU     $600                                ; base of vars
                      ( DragonMMCdef.asm):00081         
                      ( DragonMMCdef.asm):00082         ;NewUsrVec                  EQU     VarsBase+$00                    ; new USR vectors
     00EC             ( DragonMMCdef.asm):00083         NewUsrVec                   EQU     $EC                             ; Unused if dos not present.
                      ( DragonMMCdef.asm):00084         
     0024             ( DragonMMCdef.asm):00085         Dollar                      EQU     '$'
     003C             ( DragonMMCdef.asm):00086         BlkBegin                    EQU     '<'                             ; Cassette block begin byte
                      ( DragonMMCdef.asm):00087         ;SyncByte                   EQU     'U'                             ; Cassette sync byte
     0028             ( DragonMMCdef.asm):00088         OpenBrac                    EQU     '('                             ; Open bracket
     0029             ( DragonMMCdef.asm):00089         CloseBrac                   EQU     ')'                             ; Open bracket
     002C             ( DragonMMCdef.asm):00090         Comma                       EQU     ','                             ; Comma
                      ( DragonMMCdef.asm):00091         
                      ( DragonMMCdef.asm):00092         ; Offsets within file header, compatible with DragonDos/SuperDos
     0000             ( DragonMMCdef.asm):00093         HdrID55                     EQU     $00                             ; magic marker byte #1
     0001             ( DragonMMCdef.asm):00094         HdrType                     EQU     $01                             ; file type see filetypes below
     0002             ( DragonMMCdef.asm):00095         HdrLoad                     EQU     $02                             ; Load address of file
     0004             ( DragonMMCdef.asm):00096         HdrLen                      EQU     $04                             ; length of file
     0006             ( DragonMMCdef.asm):00097         HdrExec                     EQU     $06                             ; entry address of file
     0008             ( DragonMMCdef.asm):00098         HdrIDAA                     EQU     $08                             ; magic marker byte #2
                      ( DragonMMCdef.asm):00099         
     0009             ( DragonMMCdef.asm):00100         FileHeadLen                 EQU     $09
                      ( DragonMMCdef.asm):00101         
                      ( DragonMMCdef.asm):00102         ; File types
                      ( DragonMMCdef.asm):00103         
     0001             ( DragonMMCdef.asm):00104         FTypeBas                    EQU     $01                             ; Basic files
     0002             ( DragonMMCdef.asm):00105         FTypeBin                    EQU     $02                             ; Binary file types
                      ( DragonMMCdef.asm):00106         
                      ( DragonMMCdef.asm):00107         ; Marker bytes
     0055             ( DragonMMCdef.asm):00108         MarkerHeadStart     EQU     $55
     00AA             ( DragonMMCdef.asm):00109         MarkerHeadEnd       EQU     $AA
                      ( DragonMMCdef.asm):00110         
                      ( DragonMMCdef.asm):00111         ; Tempory vars
                      ( DragonMMCdef.asm):00112         
     0076             ( DragonMMCdef.asm):00113         CFGByte                     EQU     BasUnused1                  ; put it in unused byte at $76
                      ( DragonMMCdef.asm):00114         
     2112             ( DragonMMCdef.asm):00115         SignatureWord           EQU         $2112
                      (    DragonMMC.asm):00118                                 use             BasicTokens.asm
                      (  BasicTokens.asm):00001         ;
                      (  BasicTokens.asm):00002         ; BasicTokens.asm
                      (  BasicTokens.asm):00003         ;
                      (  BasicTokens.asm):00004         ; Values for Dragon and CoCo basic tokens.
                      (  BasicTokens.asm):00005         ;
                      (  BasicTokens.asm):00006         
                      (  BasicTokens.asm):00007         ;
                      (  BasicTokens.asm):00008         ; Dragon Commands
                      (  BasicTokens.asm):00009         ;
                      (  BasicTokens.asm):00010         
     0080             (  BasicTokens.asm):00011         DTokFOR         EQU     $80
     0081             (  BasicTokens.asm):00012         DTokGO          EQU     $81
     0082             (  BasicTokens.asm):00013         DTokREM         EQU     $82
     0083             (  BasicTokens.asm):00014         DTokREMComma    EQU     $83
     0084             (  BasicTokens.asm):00015         DTokELSE        EQU     $84
     0085             (  BasicTokens.asm):00016         DTokIF          EQU     $85
     0086             (  BasicTokens.asm):00017         DTokDATA        EQU     $86
     0087             (  BasicTokens.asm):00018         DTokPRINT       EQU     $87
     0088             (  BasicTokens.asm):00019         DTokON          EQU     $88
     0089             (  BasicTokens.asm):00020         DTokINPUT       EQU     $89
     008A             (  BasicTokens.asm):00021         DTokEND         EQU     $8A
     008B             (  BasicTokens.asm):00022         DTokNEXT        EQU     $8B
     008C             (  BasicTokens.asm):00023         DTokDIM         EQU     $8C
     008D             (  BasicTokens.asm):00024         DTokREAD        EQU     $8D
     008E             (  BasicTokens.asm):00025         DTokLET         EQU     $8E
     008F             (  BasicTokens.asm):00026         DTokRUN         EQU     $8F
     0090             (  BasicTokens.asm):00027         DTokRESTORE     EQU     $90
     0091             (  BasicTokens.asm):00028         DTokRETURN      EQU     $91
     0092             (  BasicTokens.asm):00029         DTokSTOP        EQU     $92
     0093             (  BasicTokens.asm):00030         DTokPOKE        EQU     $93
     0094             (  BasicTokens.asm):00031         DTokCONT        EQU     $94
     0095             (  BasicTokens.asm):00032         DTokLIST        EQU     $95
     0096             (  BasicTokens.asm):00033         DTokCLEAR       EQU     $96
     0097             (  BasicTokens.asm):00034         DTokNEW         EQU     $97
     0098             (  BasicTokens.asm):00035         DTokDEF         EQU     $98
     0099             (  BasicTokens.asm):00036         DTokCLOAD       EQU     $99
     009A             (  BasicTokens.asm):00037         DTokCSAVE       EQU     $9A
     009B             (  BasicTokens.asm):00038         DTokOPEN        EQU     $9B
     009C             (  BasicTokens.asm):00039         DTokCLOSE       EQU     $9C
     009D             (  BasicTokens.asm):00040         DTokLLIST       EQU     $9D
     009E             (  BasicTokens.asm):00041         DTokSET         EQU     $9E
     009F             (  BasicTokens.asm):00042         DTokRESET       EQU     $9F
     00A0             (  BasicTokens.asm):00043         DTokCLS         EQU     $A0
     00A1             (  BasicTokens.asm):00044         DTokMOTOR       EQU     $A1
     00A2             (  BasicTokens.asm):00045         DTokSOUND       EQU     $A2
     00A3             (  BasicTokens.asm):00046         DTokAUDIO       EQU     $A3
     00A4             (  BasicTokens.asm):00047         DTokEXEC        EQU     $A4
     00A5             (  BasicTokens.asm):00048         DTokSKIPF       EQU     $A5
     00A6             (  BasicTokens.asm):00049         DTokDELETE      EQU     $A6
     00A7             (  BasicTokens.asm):00050         DTokEDIT        EQU     $A7
     00A8             (  BasicTokens.asm):00051         DTokTRON        EQU     $A8
     00A9             (  BasicTokens.asm):00052         DTokTROFF       EQU     $A9
     00AA             (  BasicTokens.asm):00053         DTokLINE        EQU     $AA
     00AB             (  BasicTokens.asm):00054         DTokPCLS        EQU     $AB
     00AC             (  BasicTokens.asm):00055         DTokPSET        EQU     $AC
     00AD             (  BasicTokens.asm):00056         DTokPRESET      EQU     $AD
     00AE             (  BasicTokens.asm):00057         DTokSCREEN      EQU     $AE
     00AF             (  BasicTokens.asm):00058         DTokPCLEAR      EQU     $AF
     00B0             (  BasicTokens.asm):00059         DTokCOLOR       EQU     $B0
     00B1             (  BasicTokens.asm):00060         DTokCIRCLE      EQU     $B1
     00B2             (  BasicTokens.asm):00061         DTokPAINT       EQU     $B2
     00B3             (  BasicTokens.asm):00062         DTokGET         EQU     $B3
     00B4             (  BasicTokens.asm):00063         DTokPUT         EQU     $B4
     00B5             (  BasicTokens.asm):00064         DTokDRAW        EQU     $B5
     00B6             (  BasicTokens.asm):00065         DTokPCOPY       EQU     $B6
     00B7             (  BasicTokens.asm):00066         DTokPMODE       EQU     $B7
     00B8             (  BasicTokens.asm):00067         DTokPLAY        EQU     $B8
     00B9             (  BasicTokens.asm):00068         DTokDLOAD       EQU     $B9
     00BA             (  BasicTokens.asm):00069         DTokRENUM       EQU     $BA
     00BB             (  BasicTokens.asm):00070         DTokTAB         EQU     $BB
     00BC             (  BasicTokens.asm):00071         DTokTO          EQU     $BC
     00BD             (  BasicTokens.asm):00072         DTokSUB         EQU     $BD
     00BE             (  BasicTokens.asm):00073         DTokFN          EQU     $BE
     00BF             (  BasicTokens.asm):00074         DTokTHEN        EQU     $BF
     00C0             (  BasicTokens.asm):00075         DTokNOT         EQU     $C0
     00C1             (  BasicTokens.asm):00076         DTokSTEP        EQU     $C1
     00C2             (  BasicTokens.asm):00077         DTokOFF         EQU     $C2
     00C3             (  BasicTokens.asm):00078         DTokPLUS        EQU     $C3
     00C4             (  BasicTokens.asm):00079         DTokMINUS       EQU     $C4
     00C5             (  BasicTokens.asm):00080         DTokTIMES       EQU     $C5
     00C6             (  BasicTokens.asm):00081         DTokDIVIDE      EQU     $C6
     00C7             (  BasicTokens.asm):00082         DTokAT          EQU     $C7
     00C8             (  BasicTokens.asm):00083         DTokAND         EQU     $C8
     00C9             (  BasicTokens.asm):00084         DTokOR          EQU     $C9
     00CA             (  BasicTokens.asm):00085         DTokGREATER     EQU     $CA
     00CB             (  BasicTokens.asm):00086         DTokEQUAL       EQU     $CB
     00CC             (  BasicTokens.asm):00087         DTokLESS        EQU     $CC
     00CD             (  BasicTokens.asm):00088         DTokUSING       EQU     $CD
                      (  BasicTokens.asm):00089         
                      (  BasicTokens.asm):00090         ;
                      (  BasicTokens.asm):00091         ; Dragon Functions
                      (  BasicTokens.asm):00092         ; Tokens are preceeded by $FF
                      (  BasicTokens.asm):00093         ;
                      (  BasicTokens.asm):00094         
     0080             (  BasicTokens.asm):00095         DTokSGN         EQU     $80
     0081             (  BasicTokens.asm):00096         DTokINT         EQU     $81
     0082             (  BasicTokens.asm):00097         DTokABS         EQU     $82
     0083             (  BasicTokens.asm):00098         DTokPOS         EQU     $83
     0084             (  BasicTokens.asm):00099         DTokRND         EQU     $84
     0085             (  BasicTokens.asm):00100         DTokSQR         EQU     $85
     0086             (  BasicTokens.asm):00101         DTokLOG         EQU     $86
     0087             (  BasicTokens.asm):00102         DTokEXP         EQU     $87
     0088             (  BasicTokens.asm):00103         DTokSIN         EQU     $88
     0089             (  BasicTokens.asm):00104         DTokCOS         EQU     $89
     008A             (  BasicTokens.asm):00105         DTokTAN         EQU     $8A
     008B             (  BasicTokens.asm):00106         DTokATN         EQU     $8B
     008C             (  BasicTokens.asm):00107         DTokPEEK        EQU     $8C
     008D             (  BasicTokens.asm):00108         DTokLEN         EQU     $8D
     008E             (  BasicTokens.asm):00109         DTokSTRS        EQU     $8E
     008F             (  BasicTokens.asm):00110         DTokVAL         EQU     $8F
     0090             (  BasicTokens.asm):00111         DTokASC         EQU     $90
     0091             (  BasicTokens.asm):00112         DTokCHRS        EQU     $91
     0092             (  BasicTokens.asm):00113         DTokEOF         EQU     $92
     0093             (  BasicTokens.asm):00114         DTokJOYSTK      EQU     $93
     0094             (  BasicTokens.asm):00115         DTokFIX         EQU     $94
     0095             (  BasicTokens.asm):00116         DTokHEXS        EQU     $95
     0096             (  BasicTokens.asm):00117         DTokLEFTS       EQU     $96
     0097             (  BasicTokens.asm):00118         DTokRIGHTS      EQU     $97
     0098             (  BasicTokens.asm):00119         DTokMIDS        EQU     $98
     0099             (  BasicTokens.asm):00120         DTokPOINT       EQU     $99
     009A             (  BasicTokens.asm):00121         DTokINKEYS      EQU     $9A
     009B             (  BasicTokens.asm):00122         DTokMEM         EQU     $9B
     009C             (  BasicTokens.asm):00123         DTokVARPTR      EQU     $9C
     009D             (  BasicTokens.asm):00124         DTokINSTR       EQU     $9D
     009E             (  BasicTokens.asm):00125         DTokTIMER       EQU     $9E
     009F             (  BasicTokens.asm):00126         DTokPPOINT      EQU     $9F
     00A0             (  BasicTokens.asm):00127         DTokSTRINGS     EQU     $A0
     00A1             (  BasicTokens.asm):00128         DTokUSR         EQU     $A1
                      (  BasicTokens.asm):00129         
                      (  BasicTokens.asm):00130         ;
                      (  BasicTokens.asm):00131         ; DragonDOS / SuperDOS command tokens
                      (  BasicTokens.asm):00132         ;
     00CE             (  BasicTokens.asm):00133         DDTokAUTO       EQU     $CE     
     00CE             (  BasicTokens.asm):00134         DDTokBACKUP     EQU     $CE
     00D0             (  BasicTokens.asm):00135         DDTokBEEP       EQU     $D0
     00D1             (  BasicTokens.asm):00136         DDTokBOOT       EQU     $D1
     00D2             (  BasicTokens.asm):00137         DDTokCHAIN      EQU     $D2
     00D3             (  BasicTokens.asm):00138         DDTokCOPY       EQU     $D3
     00D4             (  BasicTokens.asm):00139         DDTokCREATE     EQU     $D4
     00D5             (  BasicTokens.asm):00140         DDTokDIR        EQU     $D5
     00D6             (  BasicTokens.asm):00141         DDTokDRIVE      EQU     $D6
     00D7             (  BasicTokens.asm):00142         DDTokDSKINIT    EQU     $D7
     00D8             (  BasicTokens.asm):00143         DDTokFREAD      EQU     $D8
     00D9             (  BasicTokens.asm):00144         DDTokFWRITE     EQU     $D9
     00DA             (  BasicTokens.asm):00145         DDTokERROR      EQU     $DA
     00DB             (  BasicTokens.asm):00146         DDTokKILL       EQU     $DB
     00DC             (  BasicTokens.asm):00147         DDTokLOAD       EQU     $DC
     00DD             (  BasicTokens.asm):00148         DDTokMERGE      EQU     $DD
     00DE             (  BasicTokens.asm):00149         DDTokPROTECT    EQU     $DE
     00DF             (  BasicTokens.asm):00150         DDTokWAIT       EQU     $DF
     00E0             (  BasicTokens.asm):00151         DDTokRENAME     EQU     $E0
     00E1             (  BasicTokens.asm):00152         DDTokSAVE       EQU     $E1
     00E2             (  BasicTokens.asm):00153         DDTokSREAD      EQU     $E2
     00E3             (  BasicTokens.asm):00154         DDTokSWRITE     EQU     $E3
     00E4             (  BasicTokens.asm):00155         DDTokVERIFY     EQU     $E4
     00E5             (  BasicTokens.asm):00156         DDTokFROM       EQU     $E5
     00E6             (  BasicTokens.asm):00157         DDTokFLREAD     EQU     $E6
     00E7             (  BasicTokens.asm):00158         DDTokSWAP       EQU     $E7
                      (  BasicTokens.asm):00159         
     00CE             (  BasicTokens.asm):00160         DDTokFirstC     EQU     DDTokAUTO       ; First + Last Dragondos command Token
     00E7             (  BasicTokens.asm):00161         DDTokLastC      EQU     DDTokSWAP
     001A             (  BasicTokens.asm):00162         DDTokCountC     EQU     (DDTokLastC-DDTokFirstC)+1
                      (  BasicTokens.asm):00163         ;
                      (  BasicTokens.asm):00164         ; DragonDOS / SuperDOS function tokens
                      (  BasicTokens.asm):00165         ;
                      (  BasicTokens.asm):00166         
     00A2             (  BasicTokens.asm):00167         DDTokLOF        EQU     $A2
     00A3             (  BasicTokens.asm):00168         DDTokFREE       EQU     $A3
     00A4             (  BasicTokens.asm):00169         DDTokERL        EQU     $A4
     00A5             (  BasicTokens.asm):00170         DDTokERR        EQU     $A5
     00A6             (  BasicTokens.asm):00171         DDTokHIMEM      EQU     $A6
     00A7             (  BasicTokens.asm):00172         DDTokLOC        EQU     $A7
     00A8             (  BasicTokens.asm):00173         DDTokFRES       EQU     $A8
                      (  BasicTokens.asm):00174         
     00A2             (  BasicTokens.asm):00175         DDTokFirstF     EQU     DDTokLOF        ; First + Last Dragondos function Token
     00A8             (  BasicTokens.asm):00176         DDTokLastF      EQU     DDTokFRES
     0007             (  BasicTokens.asm):00177         DDTokCountF     EQU     (DDTokLastF-DDTokFirstF)+1
                      (  BasicTokens.asm):00178         
                      (  BasicTokens.asm):00179         ; CoCo 1/2 Commands
                      (  BasicTokens.asm):00180         ;
                      (  BasicTokens.asm):00181         
     0080             (  BasicTokens.asm):00182         CTokFOR         EQU     $80
     0081             (  BasicTokens.asm):00183         CTokGO          EQU     $81
     0082             (  BasicTokens.asm):00184         CTokREM         EQU     $82
     0083             (  BasicTokens.asm):00185         CTokREMComma    EQU     $83
     0084             (  BasicTokens.asm):00186         CTokELSE        EQU     $84
     0085             (  BasicTokens.asm):00187         CTokIF          EQU     $85
     0086             (  BasicTokens.asm):00188         CTokDATA        EQU     $86
     0087             (  BasicTokens.asm):00189         CTokPRINT       EQU     $87
     0088             (  BasicTokens.asm):00190         CTokON          EQU     $88
     0089             (  BasicTokens.asm):00191         CTokINPUT       EQU     $89
     008A             (  BasicTokens.asm):00192         CTokEND         EQU     $8A
     008B             (  BasicTokens.asm):00193         CTokNEXT        EQU     $8B
     008C             (  BasicTokens.asm):00194         CTokDIM         EQU     $8C
     008D             (  BasicTokens.asm):00195         CTokREAD        EQU     $8D
     00BA             (  BasicTokens.asm):00196         CTokLET         EQU     $BA
     008E             (  BasicTokens.asm):00197         CTokRUN         EQU     $8E
     008F             (  BasicTokens.asm):00198         CTokRESTORE     EQU     $8F
     0090             (  BasicTokens.asm):00199         CTokRETURN      EQU     $90
     0091             (  BasicTokens.asm):00200         CTokSTOP        EQU     $91
     0092             (  BasicTokens.asm):00201         CTokPOKE        EQU     $92
     0093             (  BasicTokens.asm):00202         CTokCONT        EQU     $93
     0094             (  BasicTokens.asm):00203         CTokLIST        EQU     $94
     0095             (  BasicTokens.asm):00204         CTokCLEAR       EQU     $95
     0096             (  BasicTokens.asm):00205         CTokNEW         EQU     $96
     00B9             (  BasicTokens.asm):00206         CTokDEF         EQU     $B9
     0097             (  BasicTokens.asm):00207         CTokCLOAD       EQU     $97
     0098             (  BasicTokens.asm):00208         CTokCSAVE       EQU     $98
     0099             (  BasicTokens.asm):00209         CTokOPEN        EQU     $99
     009A             (  BasicTokens.asm):00210         CTokCLOSE       EQU     $9A
     009B             (  BasicTokens.asm):00211         CTokLLIST       EQU     $9B
     009C             (  BasicTokens.asm):00212         CTokSET         EQU     $9C
     009D             (  BasicTokens.asm):00213         CTokRESET       EQU     $9D
     009E             (  BasicTokens.asm):00214         CTokCLS         EQU     $9E
     009F             (  BasicTokens.asm):00215         CTokMOTOR       EQU     $9F
     00A0             (  BasicTokens.asm):00216         CTokSOUND       EQU     $A0
     00A1             (  BasicTokens.asm):00217         CTokAUDIO       EQU     $A1
     00A2             (  BasicTokens.asm):00218         CTokEXEC        EQU     $A2
     00A3             (  BasicTokens.asm):00219         CTokSKIPF       EQU     $A3
     00B5             (  BasicTokens.asm):00220         CTokDELETE      EQU     $B5
     00B6             (  BasicTokens.asm):00221         CTokEDIT        EQU     $B6
     00B7             (  BasicTokens.asm):00222         CTokTRON        EQU     $B7
     00B8             (  BasicTokens.asm):00223         CTokTROFF       EQU     $B8
     00BB             (  BasicTokens.asm):00224         CTokLINE        EQU     $BB
     00BC             (  BasicTokens.asm):00225         CTokPCLS        EQU     $BC
     00BD             (  BasicTokens.asm):00226         CTokPSET        EQU     $BD
     00BE             (  BasicTokens.asm):00227         CTokPRESET      EQU     $BE
     00BF             (  BasicTokens.asm):00228         CTokSCREEN      EQU     $BF
     00C0             (  BasicTokens.asm):00229         CTokPCLEAR      EQU     $C0
     00C1             (  BasicTokens.asm):00230         CTokCOLOR       EQU     $C1
     00C2             (  BasicTokens.asm):00231         CTokCIRCLE      EQU     $C2
     00C3             (  BasicTokens.asm):00232         CTokPAINT       EQU     $C3
     00C4             (  BasicTokens.asm):00233         CTokGET         EQU     $C4
     00C5             (  BasicTokens.asm):00234         CTokPUT         EQU     $C5
     00C6             (  BasicTokens.asm):00235         CTokDRAW        EQU     $C6
     00C7             (  BasicTokens.asm):00236         CTokPCOPY       EQU     $C7
     00C8             (  BasicTokens.asm):00237         CTokPMODE       EQU     $C8
     00C9             (  BasicTokens.asm):00238         CTokPLAY        EQU     $C9
     00CA             (  BasicTokens.asm):00239         CTokDLOAD       EQU     $CA
     00CB             (  BasicTokens.asm):00240         CTokRENUM       EQU     $CB
     00A4             (  BasicTokens.asm):00241         CTokTAB         EQU     $A4
     00A5             (  BasicTokens.asm):00242         CTokTO          EQU     $A5
     00A6             (  BasicTokens.asm):00243         CTokSUB         EQU     $A6
     00CC             (  BasicTokens.asm):00244         CTokFN          EQU     $CC
     00A7             (  BasicTokens.asm):00245         CTokTHEN        EQU     $A7
     00A8             (  BasicTokens.asm):00246         CTokNOT         EQU     $A8
     00A9             (  BasicTokens.asm):00247         CTokSTEP        EQU     $A9
     00AA             (  BasicTokens.asm):00248         CTokOFF         EQU     $AA
     00AB             (  BasicTokens.asm):00249         CTokPLUS        EQU     $AB
     00AC             (  BasicTokens.asm):00250         CTokMINUS       EQU     $AC
     00AD             (  BasicTokens.asm):00251         CTokTIMES       EQU     $AD
     00AE             (  BasicTokens.asm):00252         CTokDIVIDE      EQU     $AE
     00AF             (  BasicTokens.asm):00253         CTokAT          EQU     $AF
     00B0             (  BasicTokens.asm):00254         CTokAND         EQU     $B0
     00B1             (  BasicTokens.asm):00255         CTokOR          EQU     $B1
     00B2             (  BasicTokens.asm):00256         CTokGREATER     EQU     $B2
     00B3             (  BasicTokens.asm):00257         CTokEQUAL       EQU     $B3
     00B4             (  BasicTokens.asm):00258         CTokLESS        EQU     $B4
     00CD             (  BasicTokens.asm):00259         CTokUSING       EQU     $CD
                      (  BasicTokens.asm):00260         
                      (  BasicTokens.asm):00261         ;
                      (  BasicTokens.asm):00262         ; CoCo 1/2 Functions
                      (  BasicTokens.asm):00263         ; Tokens are preceeded by $FF
                      (  BasicTokens.asm):00264         ;
                      (  BasicTokens.asm):00265         
     0080             (  BasicTokens.asm):00266         CTokSGN         EQU     $80
     0081             (  BasicTokens.asm):00267         CTokINT         EQU     $81
     0082             (  BasicTokens.asm):00268         CTokABS         EQU     $82
     009A             (  BasicTokens.asm):00269         CTokPOS         EQU     $9A
     0084             (  BasicTokens.asm):00270         CTokRND         EQU     $84
     009B             (  BasicTokens.asm):00271         CTokSQR         EQU     $9B
     0099             (  BasicTokens.asm):00272         CTokLOG         EQU     $99
     0097             (  BasicTokens.asm):00273         CTokEXP         EQU     $97
     0085             (  BasicTokens.asm):00274         CTokSIN         EQU     $85
     0095             (  BasicTokens.asm):00275         CTokCOS         EQU     $95
     0096             (  BasicTokens.asm):00276         CTokTAN         EQU     $96
     0094             (  BasicTokens.asm):00277         CTokATN         EQU     $94
     0086             (  BasicTokens.asm):00278         CTokPEEK        EQU     $86
     0087             (  BasicTokens.asm):00279         CTokLEN         EQU     $87
     0088             (  BasicTokens.asm):00280         CTokSTRS        EQU     $88
     0089             (  BasicTokens.asm):00281         CTokVAL         EQU     $89
     008A             (  BasicTokens.asm):00282         CTokASC         EQU     $8A
     008B             (  BasicTokens.asm):00283         CTokCHRS        EQU     $8B
     008C             (  BasicTokens.asm):00284         CTokEOF         EQU     $8C
     008D             (  BasicTokens.asm):00285         CTokJOYSTK      EQU     $8D
     0098             (  BasicTokens.asm):00286         CTokFIX         EQU     $98
     009C             (  BasicTokens.asm):00287         CTokHEXS        EQU     $9C
     008E             (  BasicTokens.asm):00288         CTokLEFTS       EQU     $8E
     008F             (  BasicTokens.asm):00289         CTokRIGHTS      EQU     $8F
     0090             (  BasicTokens.asm):00290         CTokMIDS        EQU     $90
     0091             (  BasicTokens.asm):00291         CTokPOINT       EQU     $91
     0092             (  BasicTokens.asm):00292         CTokINKEYS      EQU     $92
     0093             (  BasicTokens.asm):00293         CTokMEM         EQU     $93
     009D             (  BasicTokens.asm):00294         CTokVARPTR      EQU     $9D
     009E             (  BasicTokens.asm):00295         CTokINSTR       EQU     $9E
     009F             (  BasicTokens.asm):00296         CTokTIMER       EQU     $9F
     00A0             (  BasicTokens.asm):00297         CTokPPOINT      EQU     $A0
     00A1             (  BasicTokens.asm):00298         CTokSTRINGS     EQU     $A1
     0083             (  BasicTokens.asm):00299         CTokUSR         EQU     $83
                      (  BasicTokens.asm):00300         
                      (  BasicTokens.asm):00301         ;
                      (  BasicTokens.asm):00302         ; CoCo RS-DOS command tokens
                      (  BasicTokens.asm):00303         ;
                      (  BasicTokens.asm):00304         
     00CE             (  BasicTokens.asm):00305         CDTokDIR        EQU     $CE
     00CF             (  BasicTokens.asm):00306         CDTokDRIVE      EQU     $CF
     00D0             (  BasicTokens.asm):00307         CDTokFIELD      EQU     $D0
     00D1             (  BasicTokens.asm):00308         CDTokFILES      EQU     $D1
     00D2             (  BasicTokens.asm):00309         CDTokKILL       EQU     $D2
     00D3             (  BasicTokens.asm):00310         CDTokLOAD       EQU     $D3
     00D4             (  BasicTokens.asm):00311         CDTokLSET       EQU     $D4
     00D5             (  BasicTokens.asm):00312         CDTokMERGE      EQU     $D5
     00D6             (  BasicTokens.asm):00313         CDTokRENAME     EQU     $D6
     00D7             (  BasicTokens.asm):00314         CDTokRSET       EQU     $D7
     00D8             (  BasicTokens.asm):00315         CDTokSAVE       EQU     $D8
     00D9             (  BasicTokens.asm):00316         CDTokWRITE      EQU     $D9
     00DA             (  BasicTokens.asm):00317         CDTokVERIFY     EQU     $DA
     00DB             (  BasicTokens.asm):00318         CDTokUNLOAD     EQU     $DB
     00DC             (  BasicTokens.asm):00319         CDTokDSKINI     EQU     $DC
     00DD             (  BasicTokens.asm):00320         CDTokBACKUP     EQU     $DD
     00DE             (  BasicTokens.asm):00321         CDTokCOPY       EQU     $DE
     00DF             (  BasicTokens.asm):00322         CDTokDISKIS     EQU     $DF
     00E0             (  BasicTokens.asm):00323         CDTokDISKOS     EQU     $E0
                      (  BasicTokens.asm):00324         
     00CE             (  BasicTokens.asm):00325         CDTokFirstC     EQU     CDTokDIR        ; First RS-DOS command Token
     00E0             (  BasicTokens.asm):00326         CDTokLastC      EQU     CDTokDISKOS
     0013             (  BasicTokens.asm):00327         CDTokCountC     EQU     (CDTokLastC-CDTokFirstC)+1
                      (  BasicTokens.asm):00328         
                      (  BasicTokens.asm):00329         ;
                      (  BasicTokens.asm):00330         ; CoCo RS-DOS function tokens
                      (  BasicTokens.asm):00331         ;
                      (  BasicTokens.asm):00332         
     00A2             (  BasicTokens.asm):00333         CDTokCVN        EQU     $A2
     00A3             (  BasicTokens.asm):00334         CDTokFREE       EQU     $A3
     00A4             (  BasicTokens.asm):00335         CDTokLOC        EQU     $A4
     00A5             (  BasicTokens.asm):00336         CDTokLOF        EQU     $A5
     00A6             (  BasicTokens.asm):00337         CDTokMKNS       EQU     $A6
                      (  BasicTokens.asm):00338         
     00A2             (  BasicTokens.asm):00339         CDTokFirstF     EQU     CDTokCVN        ; First RS-DOS function Token
     00A6             (  BasicTokens.asm):00340         CDTokLastF      EQU     CDTokMKNS
     0005             (  BasicTokens.asm):00341         CDTokCountF     EQU     (CDTokLastF-CDTokFirstF)+1
                      (  BasicTokens.asm):00342         
                      (  BasicTokens.asm):00343         
                      (  BasicTokens.asm):00344                         ifdef   Dragon
                      (  BasicTokens.asm):00345         
     00CE             (  BasicTokens.asm):00346         DOSTokFirstC    EQU     DDTokFirstC
     00E7             (  BasicTokens.asm):00347         DOSTokLastC     EQU     DDTokLastC
     001A             (  BasicTokens.asm):00348         DOSTokCountC    EQU     DDTokCountC
                      (  BasicTokens.asm):00349         
     00A2             (  BasicTokens.asm):00350         DOSTokFirstF    EQU     DDTokFirstF
     00A8             (  BasicTokens.asm):00351         DOSTokLastF     EQU     DDTokLastF
     0007             (  BasicTokens.asm):00352         DOSTokCountF    EQU     DDTokCountF
                      (  BasicTokens.asm):00353                         else
                      (  BasicTokens.asm):00354         
0000                  (  BasicTokens.asm):00355         DOSTokFirstC    EQU     CDTokFirstC
0000                  (  BasicTokens.asm):00356         DOSTokLastC     EQU     CDTokLastC
0000                  (  BasicTokens.asm):00357         DOSTokCountC    EQU     CDTokCountC
                      (  BasicTokens.asm):00358         
0000                  (  BasicTokens.asm):00359         DOSTokFirstF    EQU     CDTokFirstF
0000                  (  BasicTokens.asm):00360         DOSTokLastF     EQU     CDTokLastF
0000                  (  BasicTokens.asm):00361         DOSTokCountF    EQU     CDTokCountF
                      (  BasicTokens.asm):00362                         endc
                      (  BasicTokens.asm):00363         
                      (    DragonMMC.asm):00119                                 use     BasicDefs.asm
                      (    BasicDefs.asm):00001         ;
                      (    BasicDefs.asm):00002         ; BasicDefs.asm : definitions for Dragon / CoCo BASIC.
                      (    BasicDefs.asm):00003         ;
                      (    BasicDefs.asm):00004         
     F9FF             (    BasicDefs.asm):00005         BasMaxLineNo    EQU     $F9FF   ; Maximum allowable line number.
                      (    BasicDefs.asm):00006         
                      (    BasicDefs.asm):00007         ;
                      (    BasicDefs.asm):00008         ; Dragon Basic Error codes
                      (    BasicDefs.asm):00009         ; 
     0000             (    BasicDefs.asm):00010         DBErrNF         EQU     $00             ; Next without for              
     0002             (    BasicDefs.asm):00011         DBErrSN         EQU     $02             ; Syntax
     0004             (    BasicDefs.asm):00012         DBErrRG         EQU     $04             ; Return without GOSUB
     0006             (    BasicDefs.asm):00013         DBErrOD         EQU     $06             ; Out of Data
     0008             (    BasicDefs.asm):00014         DBErrFC         EQU     $08             ; Function Call
     000A             (    BasicDefs.asm):00015         DBErrOV         EQU     $0A             ; OVerflow
     000C             (    BasicDefs.asm):00016         DBErrOM         EQU     $0C             ; Out of Memory
     000E             (    BasicDefs.asm):00017         DBErrUL         EQU     $0E             ; Undefined Line
     0010             (    BasicDefs.asm):00018         DBErrBS         EQU     $10             ; Bad Subscript
     0012             (    BasicDefs.asm):00019         DBErrDD         EQU     $12             ; Direct Dimension
     0014             (    BasicDefs.asm):00020         DBErrZD         EQU     $14             ; Zero Divide
     0016             (    BasicDefs.asm):00021         DBErrID         EQU     $16             ; Illegal Direct
     0018             (    BasicDefs.asm):00022         DBErrTM         EQU     $18             ; Type Mismatch
     001A             (    BasicDefs.asm):00023         DBErrOS         EQU     $1A             ; Out of String space
     001C             (    BasicDefs.asm):00024         DBErrLS         EQU     $1C             ; Long String (len > 255)
     001E             (    BasicDefs.asm):00025         DBErrST         EQU     $1E             ; String formula Too complex
     0020             (    BasicDefs.asm):00026         DBErrCN         EQU     $20             ; Can't coNtinue
     0022             (    BasicDefs.asm):00027         DBErrUF         EQU     $22             ; Undefined Function
     0024             (    BasicDefs.asm):00028         DBErrFD         EQU     $24             ; bad File Data
     0026             (    BasicDefs.asm):00029         DBErrAO         EQU     $26             ; Already Open
     0028             (    BasicDefs.asm):00030         DBErrDN         EQU     $28             ; Device Number
     002A             (    BasicDefs.asm):00031         DBErrIO         EQU     $2A             ; Input Output
     002C             (    BasicDefs.asm):00032         DBErrFM         EQU     $2C             ; File Mismatch
     002E             (    BasicDefs.asm):00033         DBErrNO         EQU     $2E             ; file Not Open
     0030             (    BasicDefs.asm):00034         DBErrIE         EQU     $30             ; Input past End of file
     0032             (    BasicDefs.asm):00035         DBErrDS         EQU     $32             ; Direct Statement
     0034             (    BasicDefs.asm):00036         DBErrNE         EQU     $34             ; file does Not Exist
                      (    BasicDefs.asm):00037         
                      (    BasicDefs.asm):00038         ;
                      (    BasicDefs.asm):00039         ; CoCo Basic Error codes.
                      (    BasicDefs.asm):00040         ;
                      (    BasicDefs.asm):00041         
     0000             (    BasicDefs.asm):00042         CBErrNF         EQU     $00             ; Next without for              
     0002             (    BasicDefs.asm):00043         CBErrSN         EQU     $02             ; Syntax
     0004             (    BasicDefs.asm):00044         CBErrRG         EQU     $04             ; Return without GOSUB
     0006             (    BasicDefs.asm):00045         CBErrOD         EQU     $06             ; Out of Data
     0008             (    BasicDefs.asm):00046         CBErrFC         EQU     $08             ; Function Call
     000A             (    BasicDefs.asm):00047         CBErrOV         EQU     $0A             ; OVerflow
     000C             (    BasicDefs.asm):00048         CBErrOM         EQU     $0C             ; Out of Memory
     000E             (    BasicDefs.asm):00049         CBErrUL         EQU     $0E             ; Undefined Line
     0010             (    BasicDefs.asm):00050         CBErrBS         EQU     $10             ; Bad Subscript
     0012             (    BasicDefs.asm):00051         CBErrDD         EQU     $12             ; Direct Dimension
     0014             (    BasicDefs.asm):00052         CBErrZD         EQU     $14             ; Zero Divide
     0016             (    BasicDefs.asm):00053         CBErrID         EQU     $16             ; Illegal Direct
     0018             (    BasicDefs.asm):00054         CBErrTM         EQU     $18             ; Type Mismatch
     001A             (    BasicDefs.asm):00055         CBErrOS         EQU     $1A             ; Out of String space
     001C             (    BasicDefs.asm):00056         CBErrLS         EQU     $1C             ; Long String (len > 255)
     001E             (    BasicDefs.asm):00057         CBErrST         EQU     $1E             ; String formula Too complex
     0020             (    BasicDefs.asm):00058         CBErrCN         EQU     $20             ; Can't coNtinue
                      (    BasicDefs.asm):00059         
     0022             (    BasicDefs.asm):00060         CBErrFD         EQU     $22             ; bad File Data
     0024             (    BasicDefs.asm):00061         CBErrAO         EQU     $24             ; Already Open
     0026             (    BasicDefs.asm):00062         CBErrDN         EQU     $26             ; Device Number
     0028             (    BasicDefs.asm):00063         CBErrIO         EQU     $28             ; Input Output
     002A             (    BasicDefs.asm):00064         CBErrFM         EQU     $2A             ; File Mismatch
     002C             (    BasicDefs.asm):00065         CBErrNO         EQU     $2C             ; file Not Open
     002E             (    BasicDefs.asm):00066         CBErrIE         EQU     $2E             ; Input past End of file
     0030             (    BasicDefs.asm):00067         CBErrDS         EQU     $30             ; Direct Statement
                      (    BasicDefs.asm):00068         
                      (    BasicDefs.asm):00069         ;
                      (    BasicDefs.asm):00070         ; CoCo Extended basic error codes
                      (    BasicDefs.asm):00071         ;
                      (    BasicDefs.asm):00072         
     0032             (    BasicDefs.asm):00073         CBErrUF         EQU     $32             ; Undefined Function
     0034             (    BasicDefs.asm):00074         CBErrNE         EQU     $34             ; file does Not Exist
                      (    BasicDefs.asm):00075         
                      (    BasicDefs.asm):00076                 ifdef   Dragon
     0000             (    BasicDefs.asm):00077         BErrNF          EQU     DBErrNF         ; Next without for              
     0002             (    BasicDefs.asm):00078         BErrSN          EQU     DBErrSN         ; Syntax
     0004             (    BasicDefs.asm):00079         BErrRG          EQU     DBErrRG         ; Return without GOSUB
     0006             (    BasicDefs.asm):00080         BErrOD          EQU     DBErrOD         ; Out of Data
     0008             (    BasicDefs.asm):00081         BErrFC          EQU     DBErrFC         ; Function Call
     000A             (    BasicDefs.asm):00082         BErrOV          EQU     DBErrOV         ; OVerflow
     000C             (    BasicDefs.asm):00083         BErrOM          EQU     DBErrOM         ; Out of Memory
     000E             (    BasicDefs.asm):00084         BErrUL          EQU     DBErrUL         ; Undefined Line
     0010             (    BasicDefs.asm):00085         BErrBS          EQU     DBErrBS         ; Bad Subscript
     0012             (    BasicDefs.asm):00086         BErrDD          EQU     DBErrDD         ; Direct Dimension
     0014             (    BasicDefs.asm):00087         BErrZD          EQU     DBErrZD         ; Zero Divide
     0016             (    BasicDefs.asm):00088         BErrID          EQU     DBErrID         ; Illegal Direct
     0018             (    BasicDefs.asm):00089         BErrTM          EQU     DBErrTM         ; Type Mismatch
     001A             (    BasicDefs.asm):00090         BErrOS          EQU     DBErrOS         ; Out of String space
     001C             (    BasicDefs.asm):00091         BErrLS          EQU     DBErrLS         ; Long String (len > 255)
     001E             (    BasicDefs.asm):00092         BErrST          EQU     DBErrST         ; String formula Too complex
     0020             (    BasicDefs.asm):00093         BErrCN          EQU     DBErrCN         ; Can't coNtinue
     0022             (    BasicDefs.asm):00094         BErrUF          EQU     DBErrUF         ; Undefined Function
     0024             (    BasicDefs.asm):00095         BErrFD          EQU     DBErrFD         ; bad File Data
     0026             (    BasicDefs.asm):00096         BErrAO          EQU     DBErrAO         ; Already Open
     0028             (    BasicDefs.asm):00097         BErrDN          EQU     DBErrDN         ; Device Number
     002A             (    BasicDefs.asm):00098         BErrIO          EQU     DBErrIO         ; Input Output
     002C             (    BasicDefs.asm):00099         BErrFM          EQU     DBErrFM         ; File Mismatch
     002E             (    BasicDefs.asm):00100         BErrNO          EQU     DBErrNO         ; file Not Open
     0030             (    BasicDefs.asm):00101         BErrIE          EQU     DBErrIE         ; Input past End of file
     0032             (    BasicDefs.asm):00102         BErrDS          EQU     DBErrDS         ; Direct Statement
     0034             (    BasicDefs.asm):00103         BErrNE          EQU     DBErrNE         ; file does Not Exist
                      (    BasicDefs.asm):00104                 else
0000                  (    BasicDefs.asm):00105         BErrNF          EQU     CBErrNF         ; Next without for              
0000                  (    BasicDefs.asm):00106         BErrSN          EQU     CBErrSN         ; Syntax
0000                  (    BasicDefs.asm):00107         BErrRG          EQU     CBErrRG         ; Return without GOSUB
0000                  (    BasicDefs.asm):00108         BErrOD          EQU     CBErrOD         ; Out of Data
0000                  (    BasicDefs.asm):00109         BErrFC          EQU     CBErrFC         ; Function Call
0000                  (    BasicDefs.asm):00110         BErrOV          EQU     CBErrOV         ; OVerflow
0000                  (    BasicDefs.asm):00111         BErrOM          EQU     CBErrOM         ; Out of Memory
0000                  (    BasicDefs.asm):00112         BErrUL          EQU     CBErrUL         ; Undefined Line
0000                  (    BasicDefs.asm):00113         BErrBS          EQU     CBErrBS         ; Bad Subscript
0000                  (    BasicDefs.asm):00114         BErrDD          EQU     CBErrDD         ; Direct Dimension
0000                  (    BasicDefs.asm):00115         BErrZD          EQU     CBErrZD         ; Zero Divide
0000                  (    BasicDefs.asm):00116         BErrID          EQU     CBErrID         ; Illegal Direct
0000                  (    BasicDefs.asm):00117         BErrTM          EQU     CBErrTM         ; Type Mismatch
0000                  (    BasicDefs.asm):00118         BErrOS          EQU     CBErrOS         ; Out of String space
0000                  (    BasicDefs.asm):00119         BErrLS          EQU     CBErrLS         ; Long String (len > 255)
0000                  (    BasicDefs.asm):00120         BErrST          EQU     CBErrST         ; String formula Too complex
0000                  (    BasicDefs.asm):00121         BErrCN          EQU     CBErrCN         ; Can't coNtinue
0000                  (    BasicDefs.asm):00122         BErrUF          EQU     CBErrUF         ; Undefined Function
0000                  (    BasicDefs.asm):00123         BErrFD          EQU     CBErrFD         ; bad File Data
0000                  (    BasicDefs.asm):00124         BErrAO          EQU     CBErrAO         ; Already Open
0000                  (    BasicDefs.asm):00125         BErrDN          EQU     CBErrDN         ; Device Number
0000                  (    BasicDefs.asm):00126         BErrIO          EQU     CBErrIO         ; Input Output
0000                  (    BasicDefs.asm):00127         BErrFM          EQU     CBErrFM         ; File Mismatch
0000                  (    BasicDefs.asm):00128         BErrNO          EQU     CBErrNO         ; file Not Open
0000                  (    BasicDefs.asm):00129         BErrIE          EQU     CBErrIE         ; Input past End of file
0000                  (    BasicDefs.asm):00130         BErrDS          EQU     CBErrDS         ; Direct Statement
0000                  (    BasicDefs.asm):00131         BErrNE          EQU     CBErrNE         ; file does Not Exist
                      (    BasicDefs.asm):00132                 endc
                      (    DragonMMC.asm):00120                                 use             samdefs.asm
                      (      samdefs.asm):00001         ;
                      (      samdefs.asm):00002         ; SAM Defs.
                      (      samdefs.asm):00003         ;
                      (      samdefs.asm):00004         
     FFE0             (      samdefs.asm):00005         SAMVectors      equ             $FFE0                   ; SAM vector block at top of memory map
     0020             (      samdefs.asm):00006         SAMVecSize      equ             $20                             ; SAM vector block size
                      (      samdefs.asm):00007         
     FFC0             (      samdefs.asm):00008         SAMBase         equ             $FFC0                   ; Base of SAM bits
                      (      samdefs.asm):00009         
                      (      samdefs.asm):00010         ; V2 V1 V0      Mode(s)
                      (      samdefs.asm):00011         ;  0  0  0      AL, AE, S4, S6
                      (      samdefs.asm):00012         ;  0  0  1      G1C, G1R
                      (      samdefs.asm):00013         ;  0  1  0      G2C
                      (      samdefs.asm):00014         ;  0  1  1      G2R
                      (      samdefs.asm):00015         ;  1  0  0      G3C
                      (      samdefs.asm):00016         ;  1  0  1      G3R
                      (      samdefs.asm):00017         ;  1  1  0      G6C, G6R
                      (      samdefs.asm):00018         ;  1  1  1      DMA
                      (      samdefs.asm):00019         
     FFC0             (      samdefs.asm):00020         SAMCV0          equ             $FFC0                   ; Video mode bits
     FFC1             (      samdefs.asm):00021         SAMSV0          equ             $FFC1
     FFC2             (      samdefs.asm):00022         SAMCV1          equ             $FFC2
     FFC3             (      samdefs.asm):00023         SAMSV1          equ             $FFC3
     FFC4             (      samdefs.asm):00024         SAMCV2          equ             $FFC4
     FFC5             (      samdefs.asm):00025         SAMSV2          equ             $FFC5
                      (      samdefs.asm):00026         
                      (      samdefs.asm):00027         ;
                      (      samdefs.asm):00028         ; Binary offset from $0000, in 512 byte pages.
                      (      samdefs.asm):00029         ;
                      (      samdefs.asm):00030         
     FFC6             (      samdefs.asm):00031         SAMCF0          equ             $FFC6                   ; Display offset
     FFC7             (      samdefs.asm):00032         SAMSF0          equ             $FFC7
     FFC8             (      samdefs.asm):00033         SAMCF1          equ             $FFC8
     FFC9             (      samdefs.asm):00034         SAMSF1          equ             $FFC9
     FFCA             (      samdefs.asm):00035         SAMCF2          equ             $FFCA
     FFCB             (      samdefs.asm):00036         SAMSF2          equ             $FFCB
     FFCC             (      samdefs.asm):00037         SAMCF3          equ             $FFCC
     FFCD             (      samdefs.asm):00038         SAMSF3          equ             $FFCD
     FFCE             (      samdefs.asm):00039         SAMCF4          equ             $FFCE
     FFCF             (      samdefs.asm):00040         SAMSF4          equ             $FFCF
     FFD0             (      samdefs.asm):00041         SAMCF5          equ             $FFD0
     FFD1             (      samdefs.asm):00042         SAMSF5          equ             $FFD1
     FFD2             (      samdefs.asm):00043         SAMCF6          equ             $FFD2
     FFD3             (      samdefs.asm):00044         SAMSF6          equ             $FFD3
                      (      samdefs.asm):00045         
                      (      samdefs.asm):00046         ; Maps 2 pages of 32K into $0000-$7FFF, requires 64K RAM.
                      (      samdefs.asm):00047         
     FFD4             (      samdefs.asm):00048         SAMCP1          equ             $FFD4                   ; Page #1
     FFD5             (      samdefs.asm):00049         SAMSP1          equ             $FFD5
                      (      samdefs.asm):00050         
                      (      samdefs.asm):00051         ; R1 R0
                      (      samdefs.asm):00052         ;  0  0         Slow, 0.89MHz 
                      (      samdefs.asm):00053         ;  0  1         Address dependent 1.7MHz / 0.89MHz
                      (      samdefs.asm):00054         ;  1  0         Fast
                      (      samdefs.asm):00055         ;  1  1         Fast
                      (      samdefs.asm):00056         
     FFD6             (      samdefs.asm):00057         SAMCR0          equ             $FFD6                   ; CPU Rate
     FFD7             (      samdefs.asm):00058         SAMSR0          equ             $FFD7
     FFD8             (      samdefs.asm):00059         SAMCR1          equ             $FFD8
     FFD9             (      samdefs.asm):00060         SAMSR2          equ             $FFD9
                      (      samdefs.asm):00061         
                      (      samdefs.asm):00062         ; M1 M0
                      (      samdefs.asm):00063         ;  0  0          4K dynamic
                      (      samdefs.asm):00064         ;  0  1         16K dynamic
                      (      samdefs.asm):00065         ;  1  0         64K dynamic
                      (      samdefs.asm):00066         ;  1  1         64K static
                      (      samdefs.asm):00067         
     FFDA             (      samdefs.asm):00068         SAMCM0          equ             $FFDA                   ; Memory type
     FFDB             (      samdefs.asm):00069         SAMSM0          equ             $FFDB
     FFDC             (      samdefs.asm):00070         SAMCM1          equ             $FFDC
     FFDD             (      samdefs.asm):00071         SAMSM1          equ             $FFDD
                      (      samdefs.asm):00072         
                      (      samdefs.asm):00073         ; 0= RAM below 32K, ROM above, 1=RAM for entire map 
                      (      samdefs.asm):00074         ; In both map types top 256 bytes reserved for I/O space
                      (      samdefs.asm):00075         
     FFDE             (      samdefs.asm):00076         SAMCTY          equ             $FFDE                   ; Map type
     FFDF             (      samdefs.asm):00077         SAMSTY          equ             $FFDF
                      (      samdefs.asm):00078         
                      (      samdefs.asm):00079         
                      (      samdefs.asm):00080         
                      (      samdefs.asm):00081         
                      (    DragonMMC.asm):00121                                                 
                      (    DragonMMC.asm):00122                                 ORG     $C000
                      (    DragonMMC.asm):00123         
                      (    DragonMMC.asm):00124         
                      (    DragonMMC.asm):00125         ; Disk controler ID, if a cartrage starts with the chars 'DK', then the basic rom routines
                      (    DragonMMC.asm):00126         ; will do a JMP to $C002 to init the cartrage.
                      (    DragonMMC.asm):00127         
C000                  (    DragonMMC.asm):00128         __init
C000 444B             (    DragonMMC.asm):00129         DC000   FCC     /DK/                            
                      (    DragonMMC.asm):00130         
                      (    DragonMMC.asm):00131         ; Jump table.
C002 2026             (    DragonMMC.asm):00132         LC002   BRA    MMCInit
C004                  (    DragonMMC.asm):00133         __init_end
                      (    DragonMMC.asm):00134         
                      (    DragonMMC.asm):00135                         ifdef   BuildDos
                      (    DragonMMC.asm):00136                         ifdef   Dragon
                      (    DragonMMC.asm):00137                         use             dragondos_mmc.asm
                      (dragondos_mmc.asm):00001         ;
                      (dragondos_mmc.asm):00002         ; DragonDos 1.0, Copyright (C) 1982, Dragon Data Ltd.
                      (dragondos_mmc.asm):00003         ;
                      (dragondos_mmc.asm):00004         ; Disassembled 28/10/2004, P.Harvey-Smith.
                      (dragondos_mmc.asm):00005         ;
                      (dragondos_mmc.asm):00006         ; Ported to the Dragon Alpha/Professional hardware,
                      (dragondos_mmc.asm):00007         ; 29/10/2004 P.Harvey-Smith.
                      (dragondos_mmc.asm):00008         ;
                      (dragondos_mmc.asm):00009         
                      (dragondos_mmc.asm):00010         ;
                      (dragondos_mmc.asm):00011         ; 2016-03-17, PHS.
                      (dragondos_mmc.asm):00012         ; Updated to include all the bugfixes from DOS13.ROM
                      (dragondos_mmc.asm):00013         ;
                      (dragondos_mmc.asm):00014         
                      (dragondos_mmc.asm):00015         ;
                      (dragondos_mmc.asm):00016         ; The file RomDefs.asm contains a set of definitions for calling the ROM routines
                      (dragondos_mmc.asm):00017         ; of either the Dragon or CoCo machines, these will be assembled conditionally
                      (dragondos_mmc.asm):00018         ; depending on weather Dragon or Tandy is defined.
                      (dragondos_mmc.asm):00019         ;
                      (dragondos_mmc.asm):00020         
                      (dragondos_mmc.asm):00021         
                      (dragondos_mmc.asm):00022         
                      (dragondos_mmc.asm):00023                         ifdef   Tandy
                      (dragondos_mmc.asm):00024         ; Compiling to run on Tandy CoCo
                      (dragondos_mmc.asm):00025         
C004                  (dragondos_mmc.asm):00026         NextResJump     EQU     BasStub3+StubResJumpOfs         ; Jump to reserved word handler of user table
C004                  (dragondos_mmc.asm):00027         NextFuncsJump   EQU     BasStub3+StubFuncsJumpOfs       ; Jump to functions handler of user table
                      (dragondos_mmc.asm):00028                         ELSE
                      (dragondos_mmc.asm):00029         ; Compiling to run on Dragon 32/64/Alpha
     0137             (dragondos_mmc.asm):00030         NextResJump     EQU     BasStub2+StubResJumpOfs         ; Jump to reserved word handler of user table
     013C             (dragondos_mmc.asm):00031         NextFuncsJump   EQU     BasStub2+StubFuncsJumpOfs       ; Jump to functions handler of user table
                      (dragondos_mmc.asm):00032         
                      (dragondos_mmc.asm):00033                         ENDC
                      (dragondos_mmc.asm):00034         
                      (dragondos_mmc.asm):00035         ;               ORG     $C000
                      (dragondos_mmc.asm):00036         ; Disk controler ID, if a cartrage starts with the chars 'DK', then the basic rom routines
                      (dragondos_mmc.asm):00037         ; will do a JMP to $C002 to init the cartrage.
                      (dragondos_mmc.asm):00038         
                      (dragondos_mmc.asm):00039         ;DC000   FCC     /DK/                           
                      (dragondos_mmc.asm):00040         
                      (dragondos_mmc.asm):00041         ;LC002   BRA     DosInit
                      (dragondos_mmc.asm):00042         
                      (dragondos_mmc.asm):00043         ; Indirect jump table, these are probably the official DragonData entry
                      (dragondos_mmc.asm):00044         ; points to be called with jsr [entry]
                      (dragondos_mmc.asm):00045         
C004 C169             (dragondos_mmc.asm):00046                 FDB     DOSLowLevel             ; Low Level disk IO routine
C006 00EA             (dragondos_mmc.asm):00047                 FDB     DosCommand              ; Address of data table for low level command
C008 C669             (dragondos_mmc.asm):00048                 FDB     DOSValidFilename        ; Validate filename & copy to disk block.
C00A C727             (dragondos_mmc.asm):00049                 FDB     DOSOpenFile             ; Open A file.
C00C CDBF             (dragondos_mmc.asm):00050                 FDB     DOSCreateFile           ; Create file (make backup)
C00E CD24             (dragondos_mmc.asm):00051                 FDB     DOSGetFLen              ; Get file length
C010 CD66             (dragondos_mmc.asm):00052                 FDB     DOSCloseAll             ; Close all open files
C012 CD7C             (dragondos_mmc.asm):00053                 FDB     DOSCloseFile            ; Close file
C014 C83C             (dragondos_mmc.asm):00054                 FDB     DOSFRead                ; Read data from file
C016 CA04             (dragondos_mmc.asm):00055                 FDB     DOSFWrite               ; Write data to file
C018 CFF8             (dragondos_mmc.asm):00056                 FDB     DOSGetFree              ; Get free space on a disk
C01A CE61             (dragondos_mmc.asm):00057                 FDB     DOSDeleteFile           ; Delete a file
C01C CF48             (dragondos_mmc.asm):00058                 FDB     DOSProtectMC            ; Protect/unprotect file
C01E CF7A             (dragondos_mmc.asm):00059                 FDB     DOSRename               ; Rename a file 
C020 D07F             (dragondos_mmc.asm):00060                 FDB     DOSGetDirEntry          ; Get a directory entry
C022 D0F2             (dragondos_mmc.asm):00061                 FDB     DOSFindAndRead          ; Find free buffer and read sector
C024 C5E5             (dragondos_mmc.asm):00062                 FDB     DOSSyncDir              ; Copy updated sectors from track 20 to 16 (sync direcories)
C026 D1B5             (dragondos_mmc.asm):00063                 FDB     DOSReadAbsSector        ; Read absolute sector
C028 D1A5             (dragondos_mmc.asm):00064                 FDB     DOSWriteAbsSector       ; Write absolute sector (no verify)
                      (dragondos_mmc.asm):00065         
     0606             (dragondos_mmc.asm):00066         HEADFLAG        equ     DosHWMaskFF40   ; Reuse for head flag as unused in DragonMMC
                      (dragondos_mmc.asm):00067         ;
                      (dragondos_mmc.asm):00068         ; Init for MMC
                      (dragondos_mmc.asm):00069         ;
C02A 161FDF           (dragondos_mmc.asm):00070         MMCInit LBRA    RealMMCInit
                      (dragondos_mmc.asm):00071         ;
                      (dragondos_mmc.asm):00072         ; Init Dos
                      (dragondos_mmc.asm):00073         ; 
                      (dragondos_mmc.asm):00074         
C02D 1A50             (dragondos_mmc.asm):00075         DosInit orcc    #(FlagFIRQ+FlagIRQ)     ; Make sure ints disabled
C02F 8E0600           (dragondos_mmc.asm):00076                 LDX     #DosAreaStart           ; Point to bottom of dos vars area      
C032 1F12             (dragondos_mmc.asm):00077                 TFR     X,Y             
C034 6F80             (dragondos_mmc.asm):00078         LC02F   CLR     ,X+                     ; Clear a byte, increment X
C036 313F             (dragondos_mmc.asm):00079                 LEAY    -1,Y                    ; decrement counter
C038 26FA             (dragondos_mmc.asm):00080                 BNE     LC02F                   ; loop again if more to do
                      (dragondos_mmc.asm):00081         
                      (dragondos_mmc.asm):00082         ; X now points to the top of the dos variable area
                      (dragondos_mmc.asm):00083                 
C03A 1F10             (dragondos_mmc.asm):00084                 TFR     X,D
C03C 1F89             (dragondos_mmc.asm):00085                 TFR     A,B
C03E CB18             (dragondos_mmc.asm):00086                 ADDB    #$18
C040 D719             (dragondos_mmc.asm):00087                 STB     <BasStartProg           ; Setup new begining of basic
C042 BDAA87           (dragondos_mmc.asm):00088                 JSR     >BasLocateScreen
C045 96BA             (dragondos_mmc.asm):00089                 LDA     <GrDisplayStartAddr     ; Adjust graphics ram pages
C047 8B06             (dragondos_mmc.asm):00090                 ADDA    #$06
C049 97B7             (dragondos_mmc.asm):00091                 STA     <GrLastDisplayAddr
                      (dragondos_mmc.asm):00092         
                      (dragondos_mmc.asm):00093         ;
                      (dragondos_mmc.asm):00094         ; Init various low ram stuff, interrupt vectors, basic stub etc
                      (dragondos_mmc.asm):00095         ; 
                      (dragondos_mmc.asm):00096                 
C04B 8EDCA8           (dragondos_mmc.asm):00097                 LDX     #NewVectorTable                 ; Point to rom copy of data to copy
C04E E680             (dragondos_mmc.asm):00098         LC049   LDB     ,X+                     ; Get byte count byte
C050 2707             (dragondos_mmc.asm):00099                 BEQ     LC054                   ; zero= end of table, exit copy
C052 EE81             (dragondos_mmc.asm):00100                 LDU     ,X++                    ; Get destination address
C054 BDB7CC           (dragondos_mmc.asm):00101                 JSR     >UtilCopyBXtoU          ; do copy
C057 20F5             (dragondos_mmc.asm):00102                 BRA     LC049                   ; do next
                      (dragondos_mmc.asm):00103         
                      (dragondos_mmc.asm):00104         
C059                  (dragondos_mmc.asm):00105         LC054   
C059 C620             (dragondos_mmc.asm):00106                 LDB     #$20                    ; Set hardware control mask
C05B F70607           (dragondos_mmc.asm):00107                 STB     DosHWMaskFF48
C05E 730608           (dragondos_mmc.asm):00108                 COM     DosVerifyFlag           ; function unknown 
                      (dragondos_mmc.asm):00109                
C061 8E0683           (dragondos_mmc.asm):00110                 LDX     #DosNewUSRTable         ; Adjust usr vector base
C064 9FB0             (dragondos_mmc.asm):00111                 STX     <BasUSRTableAddr        
C066 CE8B8D           (dragondos_mmc.asm):00112                 LDU     #BasFCError             ; Setup the 10 usr vectors to point to BasFCError
C069 C60A             (dragondos_mmc.asm):00113                 LDB     #$0A                    ; do 10
                      (dragondos_mmc.asm):00114         
C06B EF81             (dragondos_mmc.asm):00115         LC066   STU     ,X++                    ; setup vector
C06D 5A               (dragondos_mmc.asm):00116                 DECB                            ; decrement count
C06E 26FB             (dragondos_mmc.asm):00117                 BNE     LC066                   ; loop again if more to do
                      (dragondos_mmc.asm):00118                 
C070 7C060A           (dragondos_mmc.asm):00119                 INC     DosDefDriveNo   
C073 8D30             (dragondos_mmc.asm):00120                 BSR     DosReset
                      (dragondos_mmc.asm):00121                 
C075 8E015E           (dragondos_mmc.asm):00122                 LDX     #VectBase               ; Point to ram hooks
C078 108EDCAF         (dragondos_mmc.asm):00123                 LDY     #RamHookTable           ; Point to ram hook table in rom
C07C CC137E           (dragondos_mmc.asm):00124                 LDD     #$137E                  ; load A with number of vectors B with opcode for JMP
C07F E780             (dragondos_mmc.asm):00125         LC07A   STB     ,X+     ; setup jump
C081 EEA1             (dragondos_mmc.asm):00126                 LDU     ,Y++                    ; setup vector
C083 EF81             (dragondos_mmc.asm):00127                 STU     ,X++
C085 4A               (dragondos_mmc.asm):00128                 DECA                            ; decrement counter
C086 26F7             (dragondos_mmc.asm):00129                 BNE     LC07A                   ; Loop again if more to do
                      (dragondos_mmc.asm):00130         
                      (dragondos_mmc.asm):00131         ;
                      (dragondos_mmc.asm):00132         ; Attempt to chain rom at $E000 if one exists.
                      (dragondos_mmc.asm):00133         ; 
                      (dragondos_mmc.asm):00134                
                      (dragondos_mmc.asm):00135         ;       LDX     #$4549                  ; Look for DK at $E000
                      (dragondos_mmc.asm):00136         ;        CMPX    $E000
                      (dragondos_mmc.asm):00137         ;        LBEQ    $E002                  ; Found it, call it's init routine
                      (dragondos_mmc.asm):00138                 
C088                  (dragondos_mmc.asm):00139         EIEND   
                      (dragondos_mmc.asm):00140         ;       LDX     #ResetVector            ; Setup new reset vector
                      (dragondos_mmc.asm):00141         ;        STX     <IndVecReset
                      (dragondos_mmc.asm):00142         ;        LDA     #$55
                      (dragondos_mmc.asm):00143         ;        STA     <WarmStartFlag
C088 1CAF             (dragondos_mmc.asm):00144                 andcc   #~(FlagIRQ+FlagFIRQ)    ; reenable inturrupts
                      (dragondos_mmc.asm):00145                 
                      (dragondos_mmc.asm):00146         ;        LDX     #BasSignonMess         ; Print staandard Basic signon message
                      (dragondos_mmc.asm):00147         ;        JSR     >TextOutString
                      (dragondos_mmc.asm):00148         
C08A 8EDD3A           (dragondos_mmc.asm):00149                 LDX     #DosSignonMess-1        ; Print dos signon message
C08D BD90E5           (dragondos_mmc.asm):00150                 JSR     >TextOutString  
                      (dragondos_mmc.asm):00151         
C090 7EE0AB           (dragondos_mmc.asm):00152                 jmp     >MMC_InitDone           ; do post init stuff
                      (dragondos_mmc.asm):00153                 
                      (dragondos_mmc.asm):00154         ;       JMP     >BasCmdMode             ; Go to command mode
                      (dragondos_mmc.asm):00155         
C093 A7C810           (dragondos_mmc.asm):00156         LC0A7   STA     DosSecTrkTblOfs,U       ; save sectors / track for this drive
C096 6DC810           (dragondos_mmc.asm):00157                 TST     DosSecTrkTblOfs,U       ; check what track we are currently on
C099 2607             (dragondos_mmc.asm):00158                 BNE     LC0B5                    
                      (dragondos_mmc.asm):00159                 
C09B BDC165           (dragondos_mmc.asm):00160                 JSR     >DosDoRestore
                      (dragondos_mmc.asm):00161                 
C09E 2402             (dragondos_mmc.asm):00162                 BCC     LC0B5
C0A0 3262             (dragondos_mmc.asm):00163                 LEAS    2,S
C0A2 39               (dragondos_mmc.asm):00164         LC0B5   RTS
C0A3 12               (dragondos_mmc.asm):00165                 NOP
C0A4 12               (dragondos_mmc.asm):00166                 NOP
                      (dragondos_mmc.asm):00167         
C0A5                  (dragondos_mmc.asm):00168         DosReset   
                      (dragondos_mmc.asm):00169         ;       LDA     #WDCmdForceInt          ; Force WD2797 to interrupt & reset
                      (dragondos_mmc.asm):00170         ;        STA     CMDREG
                      (dragondos_mmc.asm):00171                 
C0A5 8E0697           (dragondos_mmc.asm):00172                 LDX     #DosD0Online            ; Clear drive online flags 
                      (dragondos_mmc.asm):00173                 
C0A8 4F               (dragondos_mmc.asm):00174                 CLRA
C0A9 5F               (dragondos_mmc.asm):00175                 CLRB
C0AA ED84             (dragondos_mmc.asm):00176                 STD     ,X
C0AC ED02             (dragondos_mmc.asm):00177                 STD     2,X
                      (dragondos_mmc.asm):00178         ;       CLR     <DosIOInProgress
C0AE 0FF7             (dragondos_mmc.asm):00179                 CLR     <$F7
                      (dragondos_mmc.asm):00180                 
C0B0 8E0621           (dragondos_mmc.asm):00181                 LDX     #Drv0Details+DrvDetUseCnt       ; Clear drive in use counts
C0B3 6F84             (dragondos_mmc.asm):00182                 CLR     ,X
C0B5 6F06             (dragondos_mmc.asm):00183                 CLR     6,X
C0B7 6F0C             (dragondos_mmc.asm):00184                 CLR     12,X
C0B9 6F8812           (dragondos_mmc.asm):00185                 CLR     $12,X
C0BC 0FF6             (dragondos_mmc.asm):00186                 CLR     <DosIOInProgress        ; Flag to check for timeout
                      (dragondos_mmc.asm):00187                 
C0BE 8E06AB           (dragondos_mmc.asm):00188                 LDX     #DosDirSecStatus        ; Clear Dirctory status, FCBs etc
C0C1 6F80             (dragondos_mmc.asm):00189         LC0D9   CLR     ,X+
C0C3 8C07F3           (dragondos_mmc.asm):00190                 CMPX    #DosFCBEnd
C0C6 26F9             (dragondos_mmc.asm):00191                 BNE     LC0D9
                      (dragondos_mmc.asm):00192                 
C0C8 C604             (dragondos_mmc.asm):00193                 LDB     #$04                    ; Count of buffers to process
C0CA 8E0634           (dragondos_mmc.asm):00194                 LDX     #Buff1Details           ; Setup disk buffer initial values
C0CD CE0800           (dragondos_mmc.asm):00195                 LDU     #$0800                  ; addr of buffer
C0D0 6F02             (dragondos_mmc.asm):00196         LC0E8   CLR     2,X
C0D2 E704             (dragondos_mmc.asm):00197                 STB     4,X
C0D4 EF05             (dragondos_mmc.asm):00198                 STU     5,X
C0D6 33C90100         (dragondos_mmc.asm):00199                 LEAU    $0100,U                 ; Increment addr for next buffer
C0DA 3007             (dragondos_mmc.asm):00200                 LEAX    7,X                     ; do next buffer
C0DC 5A               (dragondos_mmc.asm):00201                 DECB                            ; done all ?
C0DD 26F1             (dragondos_mmc.asm):00202                 BNE     LC0E8                   ; no : do next
C0DF 39               (dragondos_mmc.asm):00203                 RTS
                      (dragondos_mmc.asm):00204         
                      (dragondos_mmc.asm):00205         ;
                      (dragondos_mmc.asm):00206         ; The following code is quite clever, there are actually multiple code paths.
                      (dragondos_mmc.asm):00207         ; This involves having a 2 byte instruction encoded as the oprand to a 3
                      (dragondos_mmc.asm):00208         ; byte instruction eg :-
                      (dragondos_mmc.asm):00209         ;
                      (dragondos_mmc.asm):00210         ; L00FA CMPX    #$C605
                      (dragondos_mmc.asm):00211         ;
                      (dragondos_mmc.asm):00212         ; CMPX is one byte long, so a jump to L00DB, will execute the oprand to the
                      (dragondos_mmc.asm):00213         ; CMPX, which decodes as LDB #$05 this saves a few bytes by not having LDB #xx,
                      (dragondos_mmc.asm):00214         ; BRA label.
                      (dragondos_mmc.asm):00215         ;
                      (dragondos_mmc.asm):00216         ; There are several examples of this in the Dos ROM !
                      (dragondos_mmc.asm):00217         ;
                      (dragondos_mmc.asm):00218                 
                      (dragondos_mmc.asm):00219         ; As several programs make calls to these entry points try and keep them in the same place 
                      (dragondos_mmc.asm):00220         ; they are in normal DragonDOS.
                      (dragondos_mmc.asm):00221         
C0E0 0000000000000000 (dragondos_mmc.asm):00222                 zmb             ($C0F8-*)
     0000000000000000
     0000000000000000
                      (dragondos_mmc.asm):00223                 
C0F8                  (dragondos_mmc.asm):00224         DosDoReadAddr   
C0F8 C606             (dragondos_mmc.asm):00225                 LDB     #DosFnReadAddr          ; Read address
C0FA 8C               (dragondos_mmc.asm):00226                 FCB     Skip2   
                      (dragondos_mmc.asm):00227         
C0FB                  (dragondos_mmc.asm):00228         DosDoWriteTrack   
C0FB C605             (dragondos_mmc.asm):00229                 LDB     #DosFnWriteTrack        ; Write track
C0FD 8C               (dragondos_mmc.asm):00230                 FCB     Skip2   
                      (dragondos_mmc.asm):00231         
C0FE                  (dragondos_mmc.asm):00232         DosDoWriteSecN   
C0FE C604             (dragondos_mmc.asm):00233                 LDB     #DosFnWriteSecN         ; WWrite sector no verify
C100 8C               (dragondos_mmc.asm):00234                 FCB     Skip2           
                      (dragondos_mmc.asm):00235         
C101                  (dragondos_mmc.asm):00236         DosDoWriteSecV   
C101 C603             (dragondos_mmc.asm):00237                 LDB     #DosFnWriteSecV         ; Write sector
C103 8C               (dragondos_mmc.asm):00238                 FCB     Skip2           
                      (dragondos_mmc.asm):00239         
C104                  (dragondos_mmc.asm):00240         DosDoReadSec   
C104 C602             (dragondos_mmc.asm):00241                 LDB     #DosFnReadSec           ; Read sector
                      (dragondos_mmc.asm):00242         
C106                  (dragondos_mmc.asm):00243         DosDoFuncinB   
C106 3402             (dragondos_mmc.asm):00244                 PSHS    A
C108 327E             (dragondos_mmc.asm):00245                 LEAS    -2,S                    ; Make room on stack
C10A 7F0600           (dragondos_mmc.asm):00246                 CLR     Thrash                  ; clear work byte       
C10D 8603             (dragondos_mmc.asm):00247         LC10D   LDA     #$03                    ; retry count ?
C10F EDE4             (dragondos_mmc.asm):00248                 STD     ,S                      ; save on stack
                      (dragondos_mmc.asm):00249         
C111 8D4F             (dragondos_mmc.asm):00250         LC111   BSR     DosDoSeek               ; Try to seek to track
C113 2509             (dragondos_mmc.asm):00251                 BCS     LC11E                   ; Error ?
                      (dragondos_mmc.asm):00252                 
C115 E661             (dragondos_mmc.asm):00253                 LDB     1,S                     ; No error, get dos op code
C117 D7EA             (dragondos_mmc.asm):00254                 STB     <DosCommand             ; Save operation to perform
C119 BDC169           (dragondos_mmc.asm):00255                 JSR     >DOSLowLevel
                      (dragondos_mmc.asm):00256         ;       JSR     >CON_DumpRegsWait
C11C 243C             (dragondos_mmc.asm):00257                 BCC     LC15A                   ; No error
                      (dragondos_mmc.asm):00258                 
C11E C184             (dragondos_mmc.asm):00259         LC11E   CMPB    #ErrWP          ; Write protect ?, no point in retrying !
C120 2727             (dragondos_mmc.asm):00260                 BEQ     LC149
                      (dragondos_mmc.asm):00261                 
C122 6AE4             (dragondos_mmc.asm):00262                 DEC     ,S                      ; Dec retry count
C124 2715             (dragondos_mmc.asm):00263                 BEQ     LC13B                   ; Any retries left ?
C126 E6E4             (dragondos_mmc.asm):00264                 LDB     ,S                      ; get retry count
C128 54               (dragondos_mmc.asm):00265                 LSRB                            ; gety lsbit
C129 2408             (dragondos_mmc.asm):00266                 BCC     LC133                   ; on even numbered retry, do recal
C12B 0CEC             (dragondos_mmc.asm):00267                 INC     <DskTrackNo             ; step out a track
C12D 8D33             (dragondos_mmc.asm):00268                 BSR     DosDoSeek
C12F 0AEC             (dragondos_mmc.asm):00269                 DEC     <DskTrackNo             ; step back in when retrying 
C131 20DE             (dragondos_mmc.asm):00270                 BRA     LC111
                      (dragondos_mmc.asm):00271         
C133 96EC             (dragondos_mmc.asm):00272         LC133   LDA     <DskTrackNo             ; Save Track no whilst doing restore
C135 8D2E             (dragondos_mmc.asm):00273                 BSR     DosDoRestore            ; Restore & Recalibrate
C137 97EC             (dragondos_mmc.asm):00274                 STA     <DskTrackNo             ; Put track no back
C139 20D6             (dragondos_mmc.asm):00275                 BRA     LC111                   ; Try again
                      (dragondos_mmc.asm):00276         
                      (dragondos_mmc.asm):00277         
                      (dragondos_mmc.asm):00278         ; We come here when all reties exhausted
C13B C180             (dragondos_mmc.asm):00279         LC13B   CMPB    #ErrNR          ; Not ready ?
C13D 2618             (dragondos_mmc.asm):00280                 BNE     LC157
C13F 7D0600           (dragondos_mmc.asm):00281                 TST     DosAreaStart
C142 2613             (dragondos_mmc.asm):00282                 BNE     LC157
C144 730600           (dragondos_mmc.asm):00283                 COM     DosAreaStart
C147 200A             (dragondos_mmc.asm):00284                 BRA     LC153
                      (dragondos_mmc.asm):00285         
                      (dragondos_mmc.asm):00286         ; Something to do with dir track ? Make sure same op done to both copies of Dir
C149 96EC             (dragondos_mmc.asm):00287         LC149   LDA     <DskTrackNo             ; Get track number
C14B 8114             (dragondos_mmc.asm):00288                 CMPA    #DirPrimary             ; Track 20 ?
C14D 2608             (dragondos_mmc.asm):00289                 BNE     LC157                   ; no : error
C14F 8610             (dragondos_mmc.asm):00290                 LDA     #DirBackup              ; set track to 16
C151 97EC             (dragondos_mmc.asm):00291                 STA     <DskTrackNo
C153 E661             (dragondos_mmc.asm):00292         LC153   LDB     1,S                     ; Get Dos op code
C155 20B6             (dragondos_mmc.asm):00293                 BRA     LC10D                   ; So same to track 16
                      (dragondos_mmc.asm):00294         
C157 1A01             (dragondos_mmc.asm):00295         LC157   ORCC    #FlagCarry              ; Flag error
C159 21               (dragondos_mmc.asm):00296                 FCB     Skip1                   ; opcocode for BRN
C15A 5F               (dragondos_mmc.asm):00297         LC15A   CLRB
C15B 3262             (dragondos_mmc.asm):00298                 LEAS    2,S                     ; Drop bytes from stack
C15D 3582             (dragondos_mmc.asm):00299                 PULS    A,PC                    ; restore & return
                      (dragondos_mmc.asm):00300         
                      (dragondos_mmc.asm):00301         ;
                      (dragondos_mmc.asm):00302         ; Another LDB, enbeded in CMPX sequence....
                      (dragondos_mmc.asm):00303         ; 
                      (dragondos_mmc.asm):00304         
C15F                  (dragondos_mmc.asm):00305         DosDoReadSec2
C15F C607             (dragondos_mmc.asm):00306                 LDB     #DosFnReadSec2          ; Read sector 2 (just first 2 chars)
C161 8C               (dragondos_mmc.asm):00307                 FCB     Skip2           
                      (dragondos_mmc.asm):00308         
C162                  (dragondos_mmc.asm):00309         DosDoSeek       
C162 C601             (dragondos_mmc.asm):00310                 LDB     #DosFnSeek
C164 8C               (dragondos_mmc.asm):00311                 FCB     Skip2                   ; Seek to a track
                      (dragondos_mmc.asm):00312         
C165                  (dragondos_mmc.asm):00313         DosDoRestore   
C165 C600             (dragondos_mmc.asm):00314                 LDB     #DosFnRestore           ; Restore to track 0
C167 D7EA             (dragondos_mmc.asm):00315                 STB     <DosCommand             ; save in hardware byte
                      (dragondos_mmc.asm):00316         
                      (dragondos_mmc.asm):00317         ;
                      (dragondos_mmc.asm):00318         ; Disk I/O.
                      (dragondos_mmc.asm):00319         ;
                      (dragondos_mmc.asm):00320         ; This is the main Disk I/O entry point. 
                      (dragondos_mmc.asm):00321         ; All registers are preserved except the condition codes and B on the
                      (dragondos_mmc.asm):00322         ; return. (error code).
                      (dragondos_mmc.asm):00323         ;
                      (dragondos_mmc.asm):00324         ; Call :
                      (dragondos_mmc.asm):00325         ;       DosDriveNo      = drive number
                      (dragondos_mmc.asm):00326         ;       DskSectorNo     = sector number
                      (dragondos_mmc.asm):00327         ;       DskTrackNo      = track number
                      (dragondos_mmc.asm):00328         ;       DiskBuffPtr     = buffer pointer
                      (dragondos_mmc.asm):00329         ;       DosCommand      = Dos function to execute (see below)
                      (dragondos_mmc.asm):00330         ;
                      (dragondos_mmc.asm):00331         ;               DosFnRestore    ($00), Restore to track 0
                      (dragondos_mmc.asm):00332         ;               DosFnSeek       ($01), Seek to a track
                      (dragondos_mmc.asm):00333         ;               DosFnReadSec    ($02), Read a sector
                      (dragondos_mmc.asm):00334         ;               DosFnWriteSecV  ($03), Write a sector with verify
                      (dragondos_mmc.asm):00335         ;               DosFnWriteSecN  ($04), Write a sector no verify
                      (dragondos_mmc.asm):00336         ;               DosFnWriteTrack ($05), Write (format) track
                      (dragondos_mmc.asm):00337         ;               DosFnReadAddr   ($06), Read address mark
                      (dragondos_mmc.asm):00338         ;               DosFnReadSec2   ($07), Read first two bytes of a sector
                      (dragondos_mmc.asm):00339         ;
                      (dragondos_mmc.asm):00340         ; Exit conditions :
                      (dragondos_mmc.asm):00341         ;       
                      (dragondos_mmc.asm):00342         ;       DosDiskError    = WD2797 status register, or zero if no error.                  
                      (dragondos_mmc.asm):00343         ;       B               = error code for basic or zero if no error.
                      (dragondos_mmc.asm):00344         ;       CC.carry        = 0 if no error, 1 if error.
                      (dragondos_mmc.asm):00345         ;
                      (dragondos_mmc.asm):00346         
C169                  (dragondos_mmc.asm):00347         DOSLowLevel   
C169 347B             (dragondos_mmc.asm):00348                 PSHS    CC,A,DP,X,Y,U
                      (dragondos_mmc.asm):00349         ;        ORCC    #(FlagIRQ+FlagFIRQ)    ; Disable interrupts    
C16B 66E4             (dragondos_mmc.asm):00350                 ROR     ,S
C16D 0FF0             (dragondos_mmc.asm):00351                 CLR     <DosDiskError           ; Flag no disk error
C16F 96EA             (dragondos_mmc.asm):00352                 LDA     <DosCommand             ; get HW byte
C171 8107             (dragondos_mmc.asm):00353                 CMPA    #$07                    ; Valid op
C173 2302             (dragondos_mmc.asm):00354                 BLS     LC179                   ; yes : do it !
C175 2008             (dragondos_mmc.asm):00355                 BRA     LC181                   ; No: error
                      (dragondos_mmc.asm):00356         
C177                  (dragondos_mmc.asm):00357         LC179   
C177 BDC23C           (dragondos_mmc.asm):00358                 JSR     >ResetAndStartDrive     
C17A 240E             (dragondos_mmc.asm):00359                 bcc     LC18C                   ; No error : continue
C17C C6FD             (dragondos_mmc.asm):00360                 LDB     #$FD                    ; yes flag error
                      (dragondos_mmc.asm):00361         
C17E 8C               (dragondos_mmc.asm):00362                 FCB     Skip2                   ; Andothe CMPX saving.....
                      (dragondos_mmc.asm):00363                 
C17F C6FC             (dragondos_mmc.asm):00364         LC181   LDB     #$FC                    ; Set error code
C181 1A01             (dragondos_mmc.asm):00365                 ORCC    #FlagCarry              ; and carry bit
C183 69E4             (dragondos_mmc.asm):00366                 ROL     ,S
C185 D7F0             (dragondos_mmc.asm):00367                 STB     <DosDiskError           ; Flag disk error
C187 160074           (dragondos_mmc.asm):00368                 LBRA    LC230
                      (dragondos_mmc.asm):00369         
                      (dragondos_mmc.asm):00370         ; Disable IRQ
                      (dragondos_mmc.asm):00371         
                      (dragondos_mmc.asm):00372         
C18A                  (dragondos_mmc.asm):00373         LC18C      
                      (dragondos_mmc.asm):00374         ; DragonDOS copies the control registers of the PIAs onto the slack here.
                      (dragondos_mmc.asm):00375         ; DragonMMC does not need to do this, however we manually move the stack pointer
                      (dragondos_mmc.asm):00376         ; so that the stack is setup the same.
C18A 327C             (dragondos_mmc.asm):00377                 leas    -4,s
C18C 8603             (dragondos_mmc.asm):00378                 LDA     #$03                    ; Retry count?
C18E 3402             (dragondos_mmc.asm):00379                 PSHS    A
                      (dragondos_mmc.asm):00380            
C190                  (dragondos_mmc.asm):00381         LC18B        
C190 96ED             (dragondos_mmc.asm):00382                 LDA     <DskSectorNo            ; Get disk sector no
C192                  (dragondos_mmc.asm):00383         LC1B5   
C192 BDEEC3           (dragondos_mmc.asm):00384                 JSR     >MMC_SendHR             ; Send head ans sector no
                      (dragondos_mmc.asm):00385         
C195 109E8A           (dragondos_mmc.asm):00386         LC1B8   LDY     <DBZero
C198 9EEE             (dragondos_mmc.asm):00387                 LDX     <DiskBuffPtr            ; Point to buffer
C19A D6EA             (dragondos_mmc.asm):00388                 LDB     <DosCommand             ; Get hardware byte (function code)
C19C 58               (dragondos_mmc.asm):00389                 ASLB                            ; Calculate offset in table
                      (dragondos_mmc.asm):00390                 
                      (dragondos_mmc.asm):00391         ;        LDA     #$FF                   ; Set DP=$FF, to make IO quicker
                      (dragondos_mmc.asm):00392         ;        TFR     A,DP
C19D CEDC98           (dragondos_mmc.asm):00393                 LDU     #DosFunctionTable       ; Point to function dispatch table
C1A0 ADD5             (dragondos_mmc.asm):00394                 JSR     [B,U]                   ; Jump to function handler
                      (dragondos_mmc.asm):00395         ;       JSR     >CON_DumpRegsWait
                      (dragondos_mmc.asm):00396                         
C1A2 97F0             (dragondos_mmc.asm):00397                 STA     <DosDiskError           ; Save error code
C1A4 2402             (dragondos_mmc.asm):00398                 BCC     LC1CF                   ; No timeout            
C1A6 202E             (dragondos_mmc.asm):00399                 BRA     LC1FD                   ; timeout, handle it
                      (dragondos_mmc.asm):00400         
C1A8 B40609           (dragondos_mmc.asm):00401         LC1CF   ANDA    DosErrorMask            ; Mask out error bits we are not interested in
C1AB 97F0             (dragondos_mmc.asm):00402                 STA     <DosDiskError           ; save errors for later use
C1AD 270E             (dragondos_mmc.asm):00403                 BEQ     LC1E4
                      (dragondos_mmc.asm):00404                 
C1AF 96EA             (dragondos_mmc.asm):00405                 LDA     <DosCommand             ; Get operation code
C1B1 8107             (dragondos_mmc.asm):00406                 CMPA    #DosFnReadSec2          ; ReadSec2 command ?            
C1B3 2704             (dragondos_mmc.asm):00407                 BEQ     LC1E0
                      (dragondos_mmc.asm):00408         
C1B5 6AE4             (dragondos_mmc.asm):00409                 DEC     ,S                      ; Dec retry count
C1B7 26DC             (dragondos_mmc.asm):00410                 BNE     LC1B8                   ; retry
                      (dragondos_mmc.asm):00411                 
C1B9 1A01             (dragondos_mmc.asm):00412         LC1E0   ORCC    #FlagCarry              ; Flag error
C1BB 2019             (dragondos_mmc.asm):00413                 BRA     LC1FD
                      (dragondos_mmc.asm):00414         
C1BD 7D0609           (dragondos_mmc.asm):00415         LC1E4   TST     DosErrorMask            ; is this write sector ?
C1C0 2A14             (dragondos_mmc.asm):00416                 BPL     LC1FD                   ; no : jump ahead
                      (dragondos_mmc.asm):00417                 
C1C2 96EC             (dragondos_mmc.asm):00418                 LDA     <DskTrackNo             ; Get track number
C1C4 8114             (dragondos_mmc.asm):00419                 CMPA    #DirPrimary             ; Primary Dir track ?
C1C6 270B             (dragondos_mmc.asm):00420                 BEQ     LC1FA
                      (dragondos_mmc.asm):00421         
C1C8 8110             (dragondos_mmc.asm):00422                 CMPA    #DirBackup              ; Secondary dir track ?
C1CA 2707             (dragondos_mmc.asm):00423                 BEQ     LC1FA
                      (dragondos_mmc.asm):00424         
C1CC 7D0608           (dragondos_mmc.asm):00425                 TST     DosVerifyFlag           ; should we verify?
C1CF 1CFE             (dragondos_mmc.asm):00426                 ANDCC   #~(FlagCarry)           ; Flag no carry
C1D1 2A03             (dragondos_mmc.asm):00427                 BPL     LC1FD                   ; no, skip ahead
                      (dragondos_mmc.asm):00428                 
C1D3 17FF89           (dragondos_mmc.asm):00429         LC1FA   LBSR    DosDoReadSec2
C1D6 3261             (dragondos_mmc.asm):00430         LC1FD   LEAS    1,S
C1D8 6964             (dragondos_mmc.asm):00431                 ROL     4,S
                      (dragondos_mmc.asm):00432                 
C1DA 8E069A           (dragondos_mmc.asm):00433                 LDX     #DosD0Track-1           ; Point to drive track table
C1DD D6EB             (dragondos_mmc.asm):00434                 LDB     <DosDriveNo             ; Get last used drive
C1DF 3A               (dragondos_mmc.asm):00435                 ABX                             ; get pointer to track for current drive
                      (dragondos_mmc.asm):00436         ;        LDA     trkreg                 ; Get current track number from WD
C1E0 96EC             (dragondos_mmc.asm):00437                 LDA     <DskTrackNo
C1E2 91EC             (dragondos_mmc.asm):00438                 CMPA    <DskTrackNo             ; Same as current track no ?
C1E4 2711             (dragondos_mmc.asm):00439                 BEQ     LC21F                   ; yes : update table
                      (dragondos_mmc.asm):00440                 
C1E6 F60609           (dragondos_mmc.asm):00441                 LDB     DosErrorMask            ; is this a seek ?
C1E9 C119             (dragondos_mmc.asm):00442                 CMPB    #$19
C1EB 260A             (dragondos_mmc.asm):00443                 BNE     LC21F
                      (dragondos_mmc.asm):00444         
C1ED C6FF             (dragondos_mmc.asm):00445                 LDB     #ErrSFF         ; Error code : no error
C1EF D7F0             (dragondos_mmc.asm):00446                 STB     <DosDiskError
C1F1 6664             (dragondos_mmc.asm):00447                 ROR     4,S
C1F3 1A01             (dragondos_mmc.asm):00448                 ORCC    #FlagCarry              ; flag error 
C1F5 6964             (dragondos_mmc.asm):00449                 ROL     4,S
                      (dragondos_mmc.asm):00450                 
C1F7                  (dragondos_mmc.asm):00451         LC21F   
C1F7 A784             (dragondos_mmc.asm):00452                 STA     ,X                      ; Update current track for current drive
                      (dragondos_mmc.asm):00453         
                      (dragondos_mmc.asm):00454         ; DragonDOS copies the control registers of the PIAs onto the slack here.
                      (dragondos_mmc.asm):00455         ; DragonMMC does not need to do this, however we manually move the stack pointer
                      (dragondos_mmc.asm):00456         ; so that the stack is setup the same.
C1F9 3264             (dragondos_mmc.asm):00457                 leas    4,s
C1FB                  (dragondos_mmc.asm):00458         LC226   
C1FB 7F0606           (dragondos_mmc.asm):00459                 CLR     DosHWMaskFF40           ; Clear hardware mask
C1FE 5F               (dragondos_mmc.asm):00460         LC230   CLRB                            ; Flag no error
C1FF 357B             (dragondos_mmc.asm):00461                 PULS    CC,A,DP,X,Y,U           ; Restore regs
C201 2501             (dragondos_mmc.asm):00462                 BCS     LC236                   ; error : skip
C203 39               (dragondos_mmc.asm):00463         LC235   RTS
                      (dragondos_mmc.asm):00464         
C204 D6F0             (dragondos_mmc.asm):00465         LC236   LDB     <DosDiskError           ; get last error code
C206 27FB             (dragondos_mmc.asm):00466                 BEQ     LC235                   ; none : return
C208 2A20             (dragondos_mmc.asm):00467                 BPL     LC25C
                      (dragondos_mmc.asm):00468         ;
                      (dragondos_mmc.asm):00469         ; Work out the dragon error code that coresponds to the hardware
                      (dragondos_mmc.asm):00470         ; error reported by WD.
                      (dragondos_mmc.asm):00471         ;        
C20A C1FC             (dragondos_mmc.asm):00472                 CMPB    #$FC
C20C 2604             (dragondos_mmc.asm):00473                 BNE     LC244
                      (dragondos_mmc.asm):00474          
C20E C6A4             (dragondos_mmc.asm):00475                 LDB     #ErrPR          ; parameter
C210 2027             (dragondos_mmc.asm):00476                 BRA     LC26B
                      (dragondos_mmc.asm):00477         
C212 C1FD             (dragondos_mmc.asm):00478         LC244   CMPB    #$FD
C214 2604             (dragondos_mmc.asm):00479                 BNE     LC24C
                      (dragondos_mmc.asm):00480                 
C216 C628             (dragondos_mmc.asm):00481                 LDB     #BErrDN                 ; Device Number 
C218 201F             (dragondos_mmc.asm):00482                 BRA     LC26B
                      (dragondos_mmc.asm):00483         
C21A C1FE             (dragondos_mmc.asm):00484         LC24C   CMPB    #$FE
C21C 2604             (dragondos_mmc.asm):00485                 BNE     LC254
                      (dragondos_mmc.asm):00486                 
C21E C680             (dragondos_mmc.asm):00487                 LDB     #ErrNR          ; not ready
C220 2017             (dragondos_mmc.asm):00488                 BRA     LC26B
                      (dragondos_mmc.asm):00489         
C222 C1FF             (dragondos_mmc.asm):00490         LC254   CMPB    #$FF
C224 2611             (dragondos_mmc.asm):00491                 BNE     LC269
                      (dragondos_mmc.asm):00492                 
C226 C682             (dragondos_mmc.asm):00493                 LDB     #ErrSK          ; seek
C228 200F             (dragondos_mmc.asm):00494                 BRA     LC26B
                      (dragondos_mmc.asm):00495         
C22A 1F98             (dragondos_mmc.asm):00496         LC25C   TFR     B,A
C22C C682             (dragondos_mmc.asm):00497                 LDB     #$82
C22E 49               (dragondos_mmc.asm):00498                 ROLA
C22F CB02             (dragondos_mmc.asm):00499         LC261   ADDB    #$02
C231 49               (dragondos_mmc.asm):00500                 ROLA
C232 4D               (dragondos_mmc.asm):00501                 TSTA
C233 2504             (dragondos_mmc.asm):00502                 BCS     LC26B
C235 26F8             (dragondos_mmc.asm):00503                 BNE     LC261
C237 C6A6             (dragondos_mmc.asm):00504         LC269   LDB     #ErrUD          ; undefined
C239 1A01             (dragondos_mmc.asm):00505         LC26B   ORCC    #FlagCarry
C23B 39               (dragondos_mmc.asm):00506                 RTS
                      (dragondos_mmc.asm):00507         ;
                      (dragondos_mmc.asm):00508         ; Reset controler chip, and spin up drive.
                      (dragondos_mmc.asm):00509         ;
                      (dragondos_mmc.asm):00510         
C23C                  (dragondos_mmc.asm):00511         ResetAndStartDrive   
                      (dragondos_mmc.asm):00512         ;       LDA     #WDCmdForceInt          ; Force interrupt
                      (dragondos_mmc.asm):00513         ;        STA     cmdreg
C23C 96EB             (dragondos_mmc.asm):00514                 LDA     <DosDriveNo             ; Get last active drive no
C23E 2705             (dragondos_mmc.asm):00515                 BEQ     LC27C
                      (dragondos_mmc.asm):00516                 
C240 4A               (dragondos_mmc.asm):00517                 DECA                            ; Make hw drive no 0..3
C241 8103             (dragondos_mmc.asm):00518                 CMPA    #$03                    ; Drive valid ?
C243 2303             (dragondos_mmc.asm):00519                 BLS     StartDrive2             ; yes : continue
                      (dragondos_mmc.asm):00520          
C245 1A01             (dragondos_mmc.asm):00521         LC27C   ORCC    #FlagCarry              ; Flag error
C247                  (dragondos_mmc.asm):00522         DosHookRetDevParam   
C247 39               (dragondos_mmc.asm):00523                 RTS
                      (dragondos_mmc.asm):00524         
C248                  (dragondos_mmc.asm):00525         StartDrive2
                      (dragondos_mmc.asm):00526         ;       ORA     #NMIEn+MotorOn          ; Mask in nmi enable & Motor on bits
                      (dragondos_mmc.asm):00527         ;        PSHS    A
                      (dragondos_mmc.asm):00528         ;        LDA     DosHWMaskFF48          ; Get HW byte mask
                      (dragondos_mmc.asm):00529         
                      (dragondos_mmc.asm):00530         ;       ANDA    #~DriveMask             ; Mask out drive bits   
                      (dragondos_mmc.asm):00531         ;       ORA     ,S+                     ; Mask in drive bits 
                      (dragondos_mmc.asm):00532                         
                      (dragondos_mmc.asm):00533         ;        STA     DosHWMaskFF48          ; Resave hardware mask
C248 8E069A           (dragondos_mmc.asm):00534                 LDX     #DosD0Track-1           ; Point to current track table
C24B 96EB             (dragondos_mmc.asm):00535                 LDA     <DosDriveNo             ; Get active drive
C24D A686             (dragondos_mmc.asm):00536                 LDA     A,X                     ; Get drive current track
                      (dragondos_mmc.asm):00537         ;        STA     trkreg                 ; Write to controler
C24F 86D2             (dragondos_mmc.asm):00538                 LDA     #$D2                    ; set timeout           
C251 B70605           (dragondos_mmc.asm):00539                 STA     DosTimeout
C254 5F               (dragondos_mmc.asm):00540                 CLRB                            ; no error ?
C255 39               (dragondos_mmc.asm):00541                 RTS
                      (dragondos_mmc.asm):00542         
                      (dragondos_mmc.asm):00543         ;
                      (dragondos_mmc.asm):00544         ; Dos function 0 restore
                      (dragondos_mmc.asm):00545         ;
                      (dragondos_mmc.asm):00546         
C256                  (dragondos_mmc.asm):00547         DosFunctionRestore   
C256 4F               (dragondos_mmc.asm):00548                 CLRA                            ; zero track no
C257 B700EC           (dragondos_mmc.asm):00549                 STA     >DskTrackNo             ; Save Track number
C25A 2003             (dragondos_mmc.asm):00550                 BRA     LC2B9
                      (dragondos_mmc.asm):00551         
                      (dragondos_mmc.asm):00552         ;
                      (dragondos_mmc.asm):00553         ; Dos function 1 seek
                      (dragondos_mmc.asm):00554         ; 
                      (dragondos_mmc.asm):00555         
C25C                  (dragondos_mmc.asm):00556         DosFunctionSeek
C25C B600EC           (dragondos_mmc.asm):00557                 LDA     >DskTrackNo             ; Get current track no
                      (dragondos_mmc.asm):00558         ;        CMPA    dptrkreg               ; Are we over it ?
                      (dragondos_mmc.asm):00559         ;        BRA     SeekTrackinA           ; no : seek to it
                      (dragondos_mmc.asm):00560         ;        CLRA
                      (dragondos_mmc.asm):00561         ;        STA     DosErrorMask           ; Turn off verify
                      (dragondos_mmc.asm):00562         ;        TFR     A,DP                   ; Reset DP
                      (dragondos_mmc.asm):00563         ;        RTS
                      (dragondos_mmc.asm):00564         
                      (dragondos_mmc.asm):00565         ;
                      (dragondos_mmc.asm):00566         ; Seek to a track, routine will exit either with an error
                      (dragondos_mmc.asm):00567         ; On entry A contains track to seek to.
                      (dragondos_mmc.asm):00568         ;
                      (dragondos_mmc.asm):00569         
C25F                  (dragondos_mmc.asm):00570         SeekTrackinA
                      (dragondos_mmc.asm):00571         ;       STA     <DPDataReg              ; <$43 ;DATAREG                 
                      (dragondos_mmc.asm):00572         ;        LDA     #WDCmdSeek             ; Seek command
                      (dragondos_mmc.asm):00573                 
C25F C619             (dragondos_mmc.asm):00574         LC2B9   LDB     #$19
C261 F70609           (dragondos_mmc.asm):00575                 STB     DosErrorMask
                      (dragondos_mmc.asm):00576         ;        LDX     #DosD0StepRate-1       ; Point to step rate table
                      (dragondos_mmc.asm):00577         ;        LDB     >DosDriveNo            ; Get active drive
                      (dragondos_mmc.asm):00578         ;        ORA     B,X                    ; Mask in that drive's step rate
                      (dragondos_mmc.asm):00579         ;        STA     dpcmdreg               ; save in command reg
                      (dragondos_mmc.asm):00580                 
C264 1F89             (dragondos_mmc.asm):00581                 tfr     a,b                     ; move track to b
C266 B600EB           (dragondos_mmc.asm):00582                 lda     >DosDriveNo             ; Get active drive
C269 4A               (dragondos_mmc.asm):00583                 deca                            ; make zero based
C26A 172C10           (dragondos_mmc.asm):00584                 lbsr    MMC_SeekCheck           ; Go check that it seeked ok
C26D 39               (dragondos_mmc.asm):00585                 rts
                      (dragondos_mmc.asm):00586         
                      (dragondos_mmc.asm):00587         ;LC2C8   MUL                            ; burn up CPU time waiting....
                      (dragondos_mmc.asm):00588         ;        MUL                            ; NMI will exit this loop
                      (dragondos_mmc.asm):00589         ;        LEAY    -1,Y                   ; decrement timeout counter
                      (dragondos_mmc.asm):00590         ;        BNE     LC2C8                  ; count exhausted ? : no keep going
                      (dragondos_mmc.asm):00591         ;        BRA     LC31B                  ; yes : error
                      (dragondos_mmc.asm):00592         
                      (dragondos_mmc.asm):00593         ;
                      (dragondos_mmc.asm):00594         ; Dos function 6 : Read address mark (Dragon)
                      (dragondos_mmc.asm):00595         ; not supported on MMC
                      (dragondos_mmc.asm):00596         
C26E                  (dragondos_mmc.asm):00597         DosFunctionReadAddr   
C26E 4F               (dragondos_mmc.asm):00598                 clra
C26F 39               (dragondos_mmc.asm):00599                 rts
                      (dragondos_mmc.asm):00600         
                      (dragondos_mmc.asm):00601         ;
                      (dragondos_mmc.asm):00602         ; Dos function 2 : Read sector (Dragon/Cumana)
                      (dragondos_mmc.asm):00603         ; 
C270                  (dragondos_mmc.asm):00604         DosFunctionReadSec
C270 3450             (dragondos_mmc.asm):00605                 pshs    x,u
C272 C63F             (dragondos_mmc.asm):00606                 LDB     #WDDefErrMask           ; set error mask
C274 F70609           (dragondos_mmc.asm):00607                 STB     DosErrorMask
                      (dragondos_mmc.asm):00608                 
C277 FE069F           (dragondos_mmc.asm):00609                 ldu     DosLBASec               ; get LBA
C27A 5F               (dragondos_mmc.asm):00610                 clrb                            ; msb always 0
C27B 96EB             (dragondos_mmc.asm):00611                 lda     <DosDriveNo             ; get drive
C27D 4A               (dragondos_mmc.asm):00612                 deca                            ; Zero based
C27E 172BAB           (dragondos_mmc.asm):00613                 lbsr    MMC_ReadDOSSec          ; go read it
                      (dragondos_mmc.asm):00614                 
C281 35D0             (dragondos_mmc.asm):00615                 puls    x,u,pc
                      (dragondos_mmc.asm):00616         
                      (dragondos_mmc.asm):00617         ;
                      (dragondos_mmc.asm):00618         ; Dos function 7 read first two bytes of a sector, used by BOOT command.
                      (dragondos_mmc.asm):00619         ;
                      (dragondos_mmc.asm):00620         
C283                  (dragondos_mmc.asm):00621         DosFunctionReadSec2  
C283 3450             (dragondos_mmc.asm):00622                 pshs    x,u
C285 8E004F           (dragondos_mmc.asm):00623                 ldx     #$004F                  ; put data here
C288 863F             (dragondos_mmc.asm):00624                 LDA     #WDDefErrMask           ; Set error mask
C28A B70609           (dragondos_mmc.asm):00625                 STA     DosErrorMask
                      (dragondos_mmc.asm):00626         
C28D FE069F           (dragondos_mmc.asm):00627                 ldu     DosLBASec               ; get LBA
C290 5F               (dragondos_mmc.asm):00628                 clrb                            ; msb always 0
C291 96EB             (dragondos_mmc.asm):00629                 lda     <DosDriveNo             ; get drive
C293 4A               (dragondos_mmc.asm):00630                 deca                            ; sddos drives zero based
C294 172B9C           (dragondos_mmc.asm):00631                 lbsr    MMC_ReadDOSSec2
C297 35D0             (dragondos_mmc.asm):00632                 puls    x,u,pc
                      (dragondos_mmc.asm):00633         ;
                      (dragondos_mmc.asm):00634         ; Dos function 4
                      (dragondos_mmc.asm):00635         ;
                      (dragondos_mmc.asm):00636         
C299                  (dragondos_mmc.asm):00637         DosFunctionWriteSecN   
                      (dragondos_mmc.asm):00638         ;
                      (dragondos_mmc.asm):00639         ; Dos function 3
                      (dragondos_mmc.asm):00640         ;
                      (dragondos_mmc.asm):00641         ;       rts
                      (dragondos_mmc.asm):00642                 
C299                  (dragondos_mmc.asm):00643         DosFunctionWriteSecV   
C299 3470             (dragondos_mmc.asm):00644                 pshs    x,y,u
C29B 86DF             (dragondos_mmc.asm):00645                 LDA     #WDErrMaskDF            ; set error mask
C29D B70609           (dragondos_mmc.asm):00646                 STA     DosErrorMask
                      (dragondos_mmc.asm):00647                 
C2A0 FE069F           (dragondos_mmc.asm):00648                 ldu     DosLBASec               ; get LBA
C2A3 5F               (dragondos_mmc.asm):00649                 clrb                            ; msb always 0
C2A4 96EB             (dragondos_mmc.asm):00650                 lda     <DosDriveNo             ; get drive
C2A6 4A               (dragondos_mmc.asm):00651                 deca                            ; sddos drives zero based
C2A7 172BB0           (dragondos_mmc.asm):00652                 lbsr    MMC_WriteDOSSec
                      (dragondos_mmc.asm):00653                 
C2AA 35F0             (dragondos_mmc.asm):00654                 puls    x,y,u,pc
                      (dragondos_mmc.asm):00655         
                      (dragondos_mmc.asm):00656         ;
                      (dragondos_mmc.asm):00657         ; Dos function 5 : Write (format) track
                      (dragondos_mmc.asm):00658         ; not implemented for mmc (yet!)
                      (dragondos_mmc.asm):00659         
C2AC                  (dragondos_mmc.asm):00660         DosFunctionWriteTrack 
C2AC 8647             (dragondos_mmc.asm):00661                 LDA     #WDErrMaskFormat        ; set error mask        
C2AE B70609           (dragondos_mmc.asm):00662                 STA     DosErrorMask
C2B1 4F               (dragondos_mmc.asm):00663                 clra
C2B2 39               (dragondos_mmc.asm):00664                 rts
                      (dragondos_mmc.asm):00665                 
                      (dragondos_mmc.asm):00666         ;
                      (dragondos_mmc.asm):00667         ; Dskinit dispatch routine
                      (dragondos_mmc.asm):00668         ;
                      (dragondos_mmc.asm):00669         ; Syntax :
                      (dragondos_mmc.asm):00670         ;       DSKINIT                         (default drive,sides,tracks)
                      (dragondos_mmc.asm):00671         ;       DSKINIT drive                   (specified drive, default sides,tracks) 
                      (dragondos_mmc.asm):00672         ;       DSKINIT drive,sides             (specified drive,sides default tracks) 
                      (dragondos_mmc.asm):00673         ;       DSKINIT drive,sides,tracks      (specified drive,sides,tracks)
                      (dragondos_mmc.asm):00674         ;
                      (dragondos_mmc.asm):00675                         
C2B3                  (dragondos_mmc.asm):00676         CmdDskInit   
C2B3 2723             (dragondos_mmc.asm):00677                 BEQ     LC3BC                   ; No parameters : use defaults
C2B5 BDC560           (dragondos_mmc.asm):00678                 JSR     >GetDriveNoInB          ; Get drive no
C2B8 D7EB             (dragondos_mmc.asm):00679                 STB     <DosDriveNo             ; save it
C2BA BDC3E7           (dragondos_mmc.asm):00680                 JSR     >GetCommaThen8Bit       ; Get comma, and then no of sides
C2BD 271E             (dragondos_mmc.asm):00681                 BEQ     LC3C1                   ; Error, use default sides & tracks
                      (dragondos_mmc.asm):00682                 
C2BF 5A               (dragondos_mmc.asm):00683                 DECB                            ; Convert sides to zero base
C2C0 C101             (dragondos_mmc.asm):00684                 CMPB    #$01                    ; > 1 sides specified : error & exit
C2C2 2211             (dragondos_mmc.asm):00685                 BHI     LC3B9                   ; Error : use default tracks
                      (dragondos_mmc.asm):00686                 
C2C4 D7F4             (dragondos_mmc.asm):00687                 STB     <DosRecLenFlag          ; Save sides
C2C6 BDC3E7           (dragondos_mmc.asm):00688                 JSR     >GetCommaThen8Bit       ; Get comman, then tracks
C2C9 2714             (dragondos_mmc.asm):00689                 BEQ     LC3C3                   ; Error : use default tracks
                      (dragondos_mmc.asm):00690                 
C2CB C128             (dragondos_mmc.asm):00691                 CMPB    #$28                    ; 40 tracks ?
C2CD 2712             (dragondos_mmc.asm):00692                 BEQ     LC3C5                   ; Yes skip on
                      (dragondos_mmc.asm):00693                 
C2CF 00F4             (dragondos_mmc.asm):00694                 NEG     <DosRecLenFlag
C2D1 C150             (dragondos_mmc.asm):00695                 CMPB    #$50                    ; 80 tracks ?
C2D3 270C             (dragondos_mmc.asm):00696                 BEQ     LC3C5                   ; yes, skip on
C2D5 7EC56D           (dragondos_mmc.asm):00697         LC3B9   JMP     >DosPRError
                      (dragondos_mmc.asm):00698         
                      (dragondos_mmc.asm):00699         ;
                      (dragondos_mmc.asm):00700         ; Set defaults for format : disk=1,sides=1,tracks=40
                      (dragondos_mmc.asm):00701         ;
C2D8 F6060A           (dragondos_mmc.asm):00702         LC3BC   LDB     DosDefDriveNo           ; use default drive
C2DB D7EB             (dragondos_mmc.asm):00703                 STB     <DosDriveNo             ; save in last used
C2DD 0FF4             (dragondos_mmc.asm):00704         LC3C1   CLR     <DosRecLenFlag          
C2DF C628             (dragondos_mmc.asm):00705         LC3C3   LDB     #FmtDefTracks           ; no of tracks to format by default
C2E1 D7F2             (dragondos_mmc.asm):00706         LC3C5   STB     <DosDSKINITraks
                      (dragondos_mmc.asm):00707                 
                      (dragondos_mmc.asm):00708         ;
                      (dragondos_mmc.asm):00709         ; <DosDSKINITraks = tracks to format
                      (dragondos_mmc.asm):00710         ; <DosRecLenFlag  = sides-1 so singlesided = 0, double sided = 1
                      (dragondos_mmc.asm):00711         ;  
                      (dragondos_mmc.asm):00712                
C2E3 BDD5A6           (dragondos_mmc.asm):00713                 JSR     >DosCloseAllFiles       ; close all files error if can't
C2E6 1026006E         (dragondos_mmc.asm):00714                 LBNE    DosJmpToSysError
                      (dragondos_mmc.asm):00715                 
C2EA 8E0800           (dragondos_mmc.asm):00716                 LDX     #DosDiskBuffBase        ; Point to the buffer base
C2ED 9FEE             (dragondos_mmc.asm):00717                 STX     <DiskBuffPtr
C2EF BDC165           (dragondos_mmc.asm):00718                 JSR     >DosDoRestore           ; Restore to track 0
C2F2 10260062         (dragondos_mmc.asm):00719                 LBNE    DosJmpToSysError        ; error : exit
                      (dragondos_mmc.asm):00720                 
C2F6 8601             (dragondos_mmc.asm):00721                 LDA     #$01                    ; start at sector 1
C2F8 97ED             (dragondos_mmc.asm):00722                 STA     <DskSectorNo            
C2FA BDC15F           (dragondos_mmc.asm):00723                 JSR     >DosDoReadSec2          ; try reading it
C2FD C180             (dragondos_mmc.asm):00724                 CMPB    #$80                    
C2FF 2757             (dragondos_mmc.asm):00725                 BEQ     DosJmpToSysError
                      (dragondos_mmc.asm):00726         
C301 96EB             (dragondos_mmc.asm):00727                 lda     <DosDriveNo             ; Get drive id
C303 4A               (dragondos_mmc.asm):00728                 deca                            ; make zero based
C304 D6F2             (dragondos_mmc.asm):00729                 ldb     <DosDSKINITraks         ; get tracks
C306 0DF4             (dragondos_mmc.asm):00730                 tst     <DosRecLenFlag          ; double sided ?
C308 2702             (dragondos_mmc.asm):00731                 beq     DoMMCFormat             ; no skip to format
C30A CA80             (dragondos_mmc.asm):00732                 orb     #$80                    ; flag double sided
                      (dragondos_mmc.asm):00733         
C30C                  (dragondos_mmc.asm):00734         DoMMCFormat     
C30C BDEE9E           (dragondos_mmc.asm):00735                 jsr     >MMC_FormatImage        ; Tell mmc to format virtual image
                      (dragondos_mmc.asm):00736         
C30F 96EB             (dragondos_mmc.asm):00737                 lda     <DosDriveNo             ; Get current drive
C311 4A               (dragondos_mmc.asm):00738                 deca                            ; zero based
                      (dragondos_mmc.asm):00739                 
C312 8E06A7           (dragondos_mmc.asm):00740                 ldx     #DosD0SecTrack          ; point to tracks / drive       
C315 C612             (dragondos_mmc.asm):00741                 ldb     #SectorsPerTrack        ; Calculate sectors / cylinder
C317 0DF4             (dragondos_mmc.asm):00742                 tst     <DosRecLenFlag          ; double sided ?
C319 2702             (dragondos_mmc.asm):00743                 beq     SetSecTrack             ; no skip to format
C31B CB12             (dragondos_mmc.asm):00744                 addb    #SectorsPerTrack        ; make double sided.
                      (dragondos_mmc.asm):00745                 
C31D                  (dragondos_mmc.asm):00746         SetSecTrack
C31D E786             (dragondos_mmc.asm):00747                 stb     a,x                     ; set logical sectors / track
                      (dragondos_mmc.asm):00748         
                      (dragondos_mmc.asm):00749         ;*********************[Redundent begin]**********************************        
                      (dragondos_mmc.asm):00750                 ifdef   IncludeRedundent  
C31F                  (dragondos_mmc.asm):00751         LC3E5   CLR     <DosDSKINIHead          ; do head 0
                      (dragondos_mmc.asm):00752                 CLR     <DskSectorNo            ; start at sector 0
                      (dragondos_mmc.asm):00753                 
                      (dragondos_mmc.asm):00754                 JSR     >SetupTrackLayout       ; setup track layout in ram
                      (dragondos_mmc.asm):00755                 JSR     >DosDoWriteTrack        ; write the track
                      (dragondos_mmc.asm):00756                 BCS     DosJmpToSysError        ; error : exit
                      (dragondos_mmc.asm):00757                 
                      (dragondos_mmc.asm):00758                 TST     <DosRecLenFlag          ; is this a double sided disk ? 
                      (dragondos_mmc.asm):00759                 BEQ     LC404                   ; nope skip
                      (dragondos_mmc.asm):00760                 LDA     #$01                    ; do side 1
                      (dragondos_mmc.asm):00761                 STA     <DosDSKINIHead
                      (dragondos_mmc.asm):00762                 NEGA
                      (dragondos_mmc.asm):00763                 STA     <DskSectorNo
                      (dragondos_mmc.asm):00764         
                      (dragondos_mmc.asm):00765                 JSR     >SetupTrackLayout       ; setup track layout in ram
                      (dragondos_mmc.asm):00766                 JSR     >DosDoWriteTrack        ; write the track
                      (dragondos_mmc.asm):00767                 BCS     DosJmpToSysError        ; error : exit
                      (dragondos_mmc.asm):00768         
C31F                  (dragondos_mmc.asm):00769         LC404   INC     <DskTrackNo             ; increment track 
                      (dragondos_mmc.asm):00770                 LDA     <DskTrackNo             
                      (dragondos_mmc.asm):00771                 CMPA    <DosDSKINITraks         ; have we done all yet ?
                      (dragondos_mmc.asm):00772                 BCS     LC3E5                   ; nope do next track
                      (dragondos_mmc.asm):00773         
                      (dragondos_mmc.asm):00774                 endc
                      (dragondos_mmc.asm):00775         ;*********************[Redundent end]************************************        
                      (dragondos_mmc.asm):00776                 
C31F BDC165           (dragondos_mmc.asm):00777                 JSR     >DosDoRestore           ; finished formatting, restore to track 0
C322 2534             (dragondos_mmc.asm):00778                 BCS     DosJmpToSysError
                      (dragondos_mmc.asm):00779         
                      (dragondos_mmc.asm):00780         ;*********************[Redundent begin]**********************************        
                      (dragondos_mmc.asm):00781                 ifdef   IncludeRedundent  
                      (dragondos_mmc.asm):00782                 
C324                  (dragondos_mmc.asm):00783         LC411   JSR     >DosDoSeek              ; seek to track 
                      (dragondos_mmc.asm):00784                 BCS     DosJmpToSysError        ; error : exit
                      (dragondos_mmc.asm):00785                 
                      (dragondos_mmc.asm):00786                 CLRA
                      (dragondos_mmc.asm):00787                 JSR     >CmdDskInitVerifyTrack  ; verify current track
                      (dragondos_mmc.asm):00788                 INC     <DskTrackNo             ; move to next track
                      (dragondos_mmc.asm):00789                 LDA     <DskTrackNo
                      (dragondos_mmc.asm):00790                 CMPA    <DosDSKINITraks         ; done all ?    
                      (dragondos_mmc.asm):00791                 BCS     LC411                   ; nope : do next track
                      (dragondos_mmc.asm):00792                 
                      (dragondos_mmc.asm):00793                 endc
                      (dragondos_mmc.asm):00794         ;*********************[Redundent end]************************************        
                      (dragondos_mmc.asm):00795                 
C324 9EEE             (dragondos_mmc.asm):00796                 LDX     <DiskBuffPtr            ; point at disk buffer
C326 DC8A             (dragondos_mmc.asm):00797                 LDD     <DBZero ; d=0
C328 ED81             (dragondos_mmc.asm):00798         LC426   STD     ,X++                    ; fill buffer with zeros
C32A 8C0B00           (dragondos_mmc.asm):00799                 CMPX    #DskInitBuffer+(3*256)  ; end of buffer?
C32D 26F9             (dragondos_mmc.asm):00800                 BNE     LC426                   ; nope keep filling
                      (dragondos_mmc.asm):00801                 
C32F 8601             (dragondos_mmc.asm):00802                 LDA     #$01                    ; sector 0 
C331 97ED             (dragondos_mmc.asm):00803                 STA     <DskSectorNo
C333 8614             (dragondos_mmc.asm):00804                 LDA     #DirPrimary             ; Directory track
C335 8D0A             (dragondos_mmc.asm):00805                 BSR     BuildAndWriteBAM        ; build and write BAM 
                      (dragondos_mmc.asm):00806         
C337 0AED             (dragondos_mmc.asm):00807                 DEC     <DskSectorNo            ; Point back at first BAM block 
C339 0AEE             (dragondos_mmc.asm):00808                 DEC     <DiskBuffPtr
C33B 8610             (dragondos_mmc.asm):00809                 LDA     #DirBackup              ; Directory backup track
C33D 8D08             (dragondos_mmc.asm):00810                 BSR     WriteBAM                ; Write BAM sectors
C33F 201A             (dragondos_mmc.asm):00811                 BRA     MakeBlankDir
                      (dragondos_mmc.asm):00812         
C341                  (dragondos_mmc.asm):00813         BuildAndWriteBAM   
C341 3402             (dragondos_mmc.asm):00814                 PSHS    A
C343 8D3D             (dragondos_mmc.asm):00815                 BSR     BuildBAM                ; Build BAM and geometry info
C345 3502             (dragondos_mmc.asm):00816                 PULS    A
                      (dragondos_mmc.asm):00817         
                      (dragondos_mmc.asm):00818         ; Write first 2 sectors to dir track
C347                  (dragondos_mmc.asm):00819         WriteBAM
C347 97EC             (dragondos_mmc.asm):00820                 STA     <DskTrackNo             ; Write sector to track
C349 BDC101           (dragondos_mmc.asm):00821                 JSR     >DosDoWriteSecV
C34C 250A             (dragondos_mmc.asm):00822                 BCS     DosJmpToSysError        ; error : exit
                      (dragondos_mmc.asm):00823                 
C34E 0CED             (dragondos_mmc.asm):00824                 INC     <DskSectorNo            ; do sector 2
C350 0CEE             (dragondos_mmc.asm):00825                 INC     <DiskBuffPtr
C352 BDC101           (dragondos_mmc.asm):00826                 JSR     >DosDoWriteSecV         ; Write sector to track
C355 2501             (dragondos_mmc.asm):00827                 BCS     DosJmpToSysError        ; error : exit
C357 39               (dragondos_mmc.asm):00828                 RTS
                      (dragondos_mmc.asm):00829         
                      (dragondos_mmc.asm):00830         ;
                      (dragondos_mmc.asm):00831         ; Exit with error, allow basic to handle it.
                      (dragondos_mmc.asm):00832         ;
                      (dragondos_mmc.asm):00833         
C358                  (dragondos_mmc.asm):00834         DosJmpToSysError   
C358 7EC56F           (dragondos_mmc.asm):00835                 JMP     >DosHookSysError        ; Jump to basic error handler
                      (dragondos_mmc.asm):00836         
                      (dragondos_mmc.asm):00837         ; Fill in a blank directory sector, setting default attributes.
                      (dragondos_mmc.asm):00838         ; Bug : this seems to only fill in the backup track, as the call to Lc489 will never return !
C35B                  (dragondos_mmc.asm):00839         MakeBlankDir   
C35B 0CEE             (dragondos_mmc.asm):00840                 INC     <DiskBuffPtr            ; Increment buff pointer by 1 page
C35D 9EEE             (dragondos_mmc.asm):00841                 LDX     <DiskBuffPtr                    
C35F CC890A           (dragondos_mmc.asm):00842                 LDD     #(AttrAtFormat*256)+DirEntPerSec        ; Get default attribute & number of entries                     
C362 A784             (dragondos_mmc.asm):00843         LC460   STA     ,X                      ; Fill in attributes
C364 308819           (dragondos_mmc.asm):00844                 LEAX    DirEntryLen,X           ; move to next entry
C367 5A               (dragondos_mmc.asm):00845                 DECB                            ; any more : continue
C368 26F8             (dragondos_mmc.asm):00846                 BNE     LC460                   
                      (dragondos_mmc.asm):00847                 
C36A 8D04             (dragondos_mmc.asm):00848                 BSR     LC46E           
                      (dragondos_mmc.asm):00849                 
C36C 8614             (dragondos_mmc.asm):00850                 LDA     #DirPrimary             ; Do primary dir track
C36E 97EC             (dragondos_mmc.asm):00851                 STA     <DskTrackNo
                      (dragondos_mmc.asm):00852                 
C370 CC1003           (dragondos_mmc.asm):00853         LC46E   LDD     #$1003                  ; Process 16 sectors starting at sector 3
C373 D7ED             (dragondos_mmc.asm):00854                 STB     <DskSectorNo
C375 BDC101           (dragondos_mmc.asm):00855         LC473   JSR     >DosDoWriteSecV         ; go write the sector
C378 25DE             (dragondos_mmc.asm):00856                 BCS     DosJmpToSysError        ; error : exit
                      (dragondos_mmc.asm):00857                 
C37A 0CED             (dragondos_mmc.asm):00858                 INC     <DskSectorNo            ; do next sector
C37C 4A               (dragondos_mmc.asm):00859                 DECA                            ; decrement count
C37D 26F6             (dragondos_mmc.asm):00860                 BNE     LC473                   ; keep going if more
C37F 7EC0A5           (dragondos_mmc.asm):00861                 JMP     >DosReset               ; reset dos
                      (dragondos_mmc.asm):00862         
                      (dragondos_mmc.asm):00863         ;
                      (dragondos_mmc.asm):00864         ; Build the block availability bitmap in sectors 1 and 2 of directory track
                      (dragondos_mmc.asm):00865         ; this does 3 things.
                      (dragondos_mmc.asm):00866         ; 1) Marks all physical sectors as available, adjusting for DS/SS & 40/80 tracks
                      (dragondos_mmc.asm):00867         ; 2) Marks all directory track sectors as being in use, ajusting for DS/SS disks.
                      (dragondos_mmc.asm):00868         ; 3) Fills in disk geometry bytes in the first BAM sector.
                      (dragondos_mmc.asm):00869         ;
C382                  (dragondos_mmc.asm):00870         BuildBAM   
C382 97EC             (dragondos_mmc.asm):00871                 STA     <DskTrackNo
C384 8612             (dragondos_mmc.asm):00872                 LDA     #SectorsPerTrack
C386 C65A             (dragondos_mmc.asm):00873                 LDB     #BAMEntries40SS         ; used to calculate number of needed BAM entries
C388 0DF4             (dragondos_mmc.asm):00874                 TST     <DosRecLenFlag          ; Double sided ?
C38A 2702             (dragondos_mmc.asm):00875                 BEQ     LC48C
                      (dragondos_mmc.asm):00876                 
C38C 58               (dragondos_mmc.asm):00877                 ASLB                            ; Double number of sectors as DS
C38D 48               (dragondos_mmc.asm):00878                 ASLA                            ; Double number of BAM entries as DS
C38E B708FD           (dragondos_mmc.asm):00879         LC48C   STA     DskInitBuffer+DirSecPerTrk      ; save sectors / track
C391 43               (dragondos_mmc.asm):00880                 COMA
C392 B708FF           (dragondos_mmc.asm):00881                 STA     DskInitBuffer+DirSecPerTrk1s    ; save complement for error check
                      (dragondos_mmc.asm):00882         
C395 96F2             (dragondos_mmc.asm):00883                 LDA     <DosDSKINITraks         ; Get number of tracks
C397 B708FC           (dragondos_mmc.asm):00884                 STA     DskInitBuffer+DirTracks ; Save no of tracks
                      (dragondos_mmc.asm):00885         
C39A 43               (dragondos_mmc.asm):00886                 COMA                            ; Complement for error check
C39B B708FE           (dragondos_mmc.asm):00887                 STA     DskInitBuffer+DirTracks1s       ; Save no of tracks check
                      (dragondos_mmc.asm):00888                 
C39E 9EEE             (dragondos_mmc.asm):00889                 LDX     <DiskBuffPtr
C3A0 CE0900           (dragondos_mmc.asm):00890                 LDU     #DskInitBuffer+(256*1)  ; 1 sector into buffer
C3A3 86FF             (dragondos_mmc.asm):00891                 LDA     #$FF                    ; Mark a block of sectors free
C3A5 A780             (dragondos_mmc.asm):00892         LC4A3   STA     ,X+
C3A7 5A               (dragondos_mmc.asm):00893                 DECB                            ; Any more BAM groups ?
C3A8 26FB             (dragondos_mmc.asm):00894                 BNE     LC4A3
                      (dragondos_mmc.asm):00895         
C3AA CC242D           (dragondos_mmc.asm):00896                 LDD     #(BAMOffDirBakSS*256)+BAMOffDirPriSS ; get offsets in BAM of dir sectors SS     
C3AD 0DF4             (dragondos_mmc.asm):00897                 TST     <DosRecLenFlag          ; double sided ?
C3AF 270D             (dragondos_mmc.asm):00898                 BEQ     LC4BC
C3B1 2A08             (dragondos_mmc.asm):00899                 BPL     LC4B9
                      (dragondos_mmc.asm):00900                 
C3B3 CCB4FF           (dragondos_mmc.asm):00901                 LDD     #$B4FF
C3B6 E7C0             (dragondos_mmc.asm):00902         LC4B4   STB     ,U+
C3B8 4A               (dragondos_mmc.asm):00903                 DECA
C3B9 26FB             (dragondos_mmc.asm):00904                 BNE     LC4B4
                      (dragondos_mmc.asm):00905         
C3BB CC485A           (dragondos_mmc.asm):00906         LC4B9   LDD     #(BAMOffDirBakDS*256)+BAMOffDirPriDS ; get offsets in BAM of dir sectors DS 
                      (dragondos_mmc.asm):00907         
C3BE DE8A             (dragondos_mmc.asm):00908         LC4BC   LDU     <DBZero ; U=0
C3C0 3402             (dragondos_mmc.asm):00909                 PSHS    A                       ; Mark track 20 dir in use
C3C2 8D02             (dragondos_mmc.asm):00910                 BSR     LC4C4
C3C4 3504             (dragondos_mmc.asm):00911                 PULS    B                       ; mark track 16 dir in use
                      (dragondos_mmc.asm):00912         
C3C6 9EEE             (dragondos_mmc.asm):00913         LC4C4   LDX     <DiskBuffPtr            ; get pointer to BAM
C3C8 3A               (dragondos_mmc.asm):00914                 ABX                             ; calculate offset
C3C9 86FC             (dragondos_mmc.asm):00915                 LDA     #$FC                    ; mask for last 2 sectors
C3CB EF81             (dragondos_mmc.asm):00916                 STU     ,X++                    ; mark dir sectors in use
C3CD A784             (dragondos_mmc.asm):00917                 STA     ,X
C3CF 39               (dragondos_mmc.asm):00918                 RTS
                      (dragondos_mmc.asm):00919         
C3D0                  (dragondos_mmc.asm):00920         CmdDskInitVerifyTrack   
C3D0 0FED             (dragondos_mmc.asm):00921                 CLR     <DskSectorNo            ; Sector 0
C3D2 0DF4             (dragondos_mmc.asm):00922                 TST     <DosRecLenFlag          ; is it DS ?
C3D4 2702             (dragondos_mmc.asm):00923                 BEQ     LC4D6                   ; nope just do side 0
C3D6 8D00             (dragondos_mmc.asm):00924                 BSR     LC4D6                   ; do side 0 then 1
                      (dragondos_mmc.asm):00925                 
C3D8 8612             (dragondos_mmc.asm):00926         LC4D6   LDA     #SectorsPerTrack        ; Sector counter
C3DA 0CED             (dragondos_mmc.asm):00927         LC4D8   INC     <DskSectorNo            ; next sector
C3DC BDC15F           (dragondos_mmc.asm):00928                 JSR     >DosDoReadSec2          ; go read it
C3DF 1025FF75         (dragondos_mmc.asm):00929                 LBCS    DosJmpToSysError        ; error : exit
C3E3 4A               (dragondos_mmc.asm):00930                 DECA                            ; decrement count
C3E4 26F4             (dragondos_mmc.asm):00931                 BNE     LC4D8                   ; loop again if more
C3E6 39               (dragondos_mmc.asm):00932         LC4E4   RTS
                      (dragondos_mmc.asm):00933         
                      (dragondos_mmc.asm):00934         ;*********************[Redundent begin]**********************************        
                      (dragondos_mmc.asm):00935                 ifdef   IncludeRedundent  
                      (dragondos_mmc.asm):00936         
                      (dragondos_mmc.asm):00937         ;
                      (dragondos_mmc.asm):00938         ; Setup format block for write track
                      (dragondos_mmc.asm):00939         ;
                      (dragondos_mmc.asm):00940         ; The track format used by write track is made up of records of 3 bytes :
                      (dragondos_mmc.asm):00941         ;
                      (dragondos_mmc.asm):00942         ; byte 0        repeat count
                      (dragondos_mmc.asm):00943         ; byte 1        data byte
                      (dragondos_mmc.asm):00944         ; byte 2        terminator byte
                      (dragondos_mmc.asm):00945         ; 
                      (dragondos_mmc.asm):00946         ; The low level write track then takes the byte counts and outputs the repeated 
                      (dragondos_mmc.asm):00947         ; bytes for us. This is slightly more complex than the systems used on other 
                      (dragondos_mmc.asm):00948         ; systems (e.g. Nascom, Atom, BBC) where the entire track is laid out in memory
                      (dragondos_mmc.asm):00949         ; raw. However this has the major advantage of needing much less memory, meaning
                      (dragondos_mmc.asm):00950         ; the track layout can be kept within the disk buffers. This means that (unlike 
                      (dragondos_mmc.asm):00951         ; the Atom and BBC DFS) formatting a disk does not corrupt any of the non DOS 
                      (dragondos_mmc.asm):00952         ; related memory - neat.
                      (dragondos_mmc.asm):00953         ;
                      (dragondos_mmc.asm):00954         
C3E7                  (dragondos_mmc.asm):00955         SetupTrackLayout   
                      (dragondos_mmc.asm):00956                 LDU     <DiskBuffPtr            ; Point to disk buffer
                      (dragondos_mmc.asm):00957                 LDX     #TrackHeaderTable
                      (dragondos_mmc.asm):00958                 LDY     #SectorIDTable          ; Table of sector IDs with required interleave          
                      (dragondos_mmc.asm):00959                 
                      (dragondos_mmc.asm):00960         ; Write track header
                      (dragondos_mmc.asm):00961                 LDB     #TrackHeaderSize        ; Count
                      (dragondos_mmc.asm):00962                 BSR     DosUtilCopyBXtoU        ; copy bytes
                      (dragondos_mmc.asm):00963                 
                      (dragondos_mmc.asm):00964         ; Write sector ID       
C3E7                  (dragondos_mmc.asm):00965         LC4F2   LDX     #SectorIDLayout         ; first part of sector ID
                      (dragondos_mmc.asm):00966                 LDB     #SectorIDP1Len          ; count 
                      (dragondos_mmc.asm):00967                 BSR     DosUtilCopyBXtoU        ; copy bytes
                      (dragondos_mmc.asm):00968                 
                      (dragondos_mmc.asm):00969         ; now fill in the C,H,R,N values for the sector 
                      (dragondos_mmc.asm):00970                 LDA     #$01                    ; repeat count 1 byte   
                      (dragondos_mmc.asm):00971                 LDB     <DskTrackNo             ; get Cylinder number 
                      (dragondos_mmc.asm):00972                 STD     ,U++                    ; save in buffer
                      (dragondos_mmc.asm):00973                 LDB     <DosDSKINIHead          ; get Head 
                      (dragondos_mmc.asm):00974                 STB     ,U+                     ; save in buffer (as term byte)
                      (dragondos_mmc.asm):00975                 LDB     ,Y+                     ; get sector (Record) number 
                      (dragondos_mmc.asm):00976                 STD     ,U++                    ; save count of 1 plus sector number
                      (dragondos_mmc.asm):00977                 STA     ,U+                     ; save sector size of 1 (N=256)
                      (dragondos_mmc.asm):00978                 
                      (dragondos_mmc.asm):00979         ; Write end of sector ID + Sector data area
                      (dragondos_mmc.asm):00980                 LDB     #SectorIDP2Len          ; count of bytes in rest of sector ID and sectro data
                      (dragondos_mmc.asm):00981                 BSR     DosUtilCopyBXtoU        ; coopy bytes
                      (dragondos_mmc.asm):00982                 
                      (dragondos_mmc.asm):00983                 TST     ,Y                      ; done all sectors?
                      (dragondos_mmc.asm):00984                 BNE     LC4F2                   ; nope loop again
                      (dragondos_mmc.asm):00985         
                      (dragondos_mmc.asm):00986         ; Write track filler bytes
                      (dragondos_mmc.asm):00987                 LDB     #TrackFillerLen         ; no of bytes at end of track
                      (dragondos_mmc.asm):00988         
C3E7                  (dragondos_mmc.asm):00989         DosUtilCopyBXtoU   
                      (dragondos_mmc.asm):00990                 JMP     >UtilCopyBXtoU
                      (dragondos_mmc.asm):00991                 endc
                      (dragondos_mmc.asm):00992         ;*********************[Redundent end]************************************        
                      (dragondos_mmc.asm):00993         
                      (dragondos_mmc.asm):00994         ;
                      (dragondos_mmc.asm):00995         ; GetCommaThen8Bit, scan for comma, error if not found, then fetch 8 bit that follows (or error). 
                      (dragondos_mmc.asm):00996         ;
                      (dragondos_mmc.asm):00997         
C3E7                  (dragondos_mmc.asm):00998         GetCommaThen8Bit
C3E7 9DA5             (dragondos_mmc.asm):00999                 JSR     <BasChrGetCurr          ; Get current basic char
C3E9 27FB             (dragondos_mmc.asm):01000                 BEQ     LC4E4                   ; Any left no: return 
C3EB BD89AA           (dragondos_mmc.asm):01001                 JSR     >VarCKComma             ; check for comma
C3EE 7EC510           (dragondos_mmc.asm):01002                 JMP     >Get8BitorError         ; go get it
                      (dragondos_mmc.asm):01003         
                      (dragondos_mmc.asm):01004         ;
                      (dragondos_mmc.asm):01005         ; Basic BACKUP command
                      (dragondos_mmc.asm):01006         ;
                      (dragondos_mmc.asm):01007         ; BACKUP src_drv TO dest_drv[,s][,t]
                      (dragondos_mmc.asm):01008         ;       src_drv         = source drive no 1..4
                      (dragondos_mmc.asm):01009         ;       dest_drv        = destination drive no 1..4
                      (dragondos_mmc.asm):01010         ;       s               = number of sides 1 or 2
                      (dragondos_mmc.asm):01011         ;       t               = number of tracks 40 or 80
                      (dragondos_mmc.asm):01012         ;
                      (dragondos_mmc.asm):01013         ; Stack frame
                      (dragondos_mmc.asm):01014         ;       $0015   Ram buffer size in sectors
                      (dragondos_mmc.asm):01015         ;       $0014   Sectors / tracks
                      (dragondos_mmc.asm):01016         ;
                      (dragondos_mmc.asm):01017         ;  Destination Drive ---------------------------        
                      (dragondos_mmc.asm):01018         ;
                      (dragondos_mmc.asm):01019         ;       $0012   Ram pointer
                      (dragondos_mmc.asm):01020         ;       $0010   String pointer
                      (dragondos_mmc.asm):01021         ;       $0009   Sector
                      (dragondos_mmc.asm):01022         ;       $0008   Track
                      (dragondos_mmc.asm):01023         ;       $0007   Drive
                      (dragondos_mmc.asm):01024         ;
                      (dragondos_mmc.asm):01025         ;  Source drive --------------------------------
                      (dragondos_mmc.asm):01026         ;       
                      (dragondos_mmc.asm):01027         ;       $0005   Ram pointer
                      (dragondos_mmc.asm):01028         ;       $0003   String pointer
                      (dragondos_mmc.asm):01029         ;       $0002   Sector
                      (dragondos_mmc.asm):01030         ;       $0001   Track
                      (dragondos_mmc.asm):01031         ;       $0000   Drive
                      (dragondos_mmc.asm):01032         ;  U->
                      (dragondos_mmc.asm):01033         ;
                      (dragondos_mmc.asm):01034         
C3F1                  (dragondos_mmc.asm):01035         CmdBackup 
C3F1 3270             (dragondos_mmc.asm):01036                 LEAS    -BupStackFrame,S        ; Make tempory space on stack
C3F3 1F43             (dragondos_mmc.asm):01037                 TFR     S,U                     ; Point U at base of tempory space (Like OS-9 !)
C3F5 1F30             (dragondos_mmc.asm):01038                 TFR     U,D             
C3F7 830040           (dragondos_mmc.asm):01039                 SUBD    #$0040                  ; reserve room for working stack
C3FA 931F             (dragondos_mmc.asm):01040                 SUBD    <BasVarEnd              ; Check that we have suficient memory available
C3FC 102BBF42         (dragondos_mmc.asm):01041                 LBMI    BasOMError              ; NO: report ?OM error
                      (dragondos_mmc.asm):01042                 
C400 8101             (dragondos_mmc.asm):01043                 CMPA    #$01                    ; At least 1 sector's worth of ram (256 bytes) available
C402 102DBF3C         (dragondos_mmc.asm):01044                 LBLT    BasOMError              ; NO: report ?OM error
C406 A74F             (dragondos_mmc.asm):01045                 STA     BupAvailPages,U         ; Store memory page count of avaiable RAM
C408 8612             (dragondos_mmc.asm):01046                 LDA     #SectorsPerTrack        ; Sectors per track, initially 18 for SS disk
C40A A74E             (dragondos_mmc.asm):01047                 STA     BupSecTrk,U
C40C DC1F             (dragondos_mmc.asm):01048                 LDD     <BasVarEnd              ; Get end of RAM in use by basic
C40E ED45             (dragondos_mmc.asm):01049                 STD     BupSrcBuff,U            ; save in buffer pointers for source and dest
C410 ED4C             (dragondos_mmc.asm):01050                 STD     BupDestBuff,U
                      (dragondos_mmc.asm):01051         
C412 CCDCD4           (dragondos_mmc.asm):01052                 LDD     #MessInsertSource-1     ; Insert source and destination message pointers
C415 ED43             (dragondos_mmc.asm):01053                 STD     BupSrcMess,U
C417 CCDCE3           (dragondos_mmc.asm):01054                 LDD     #MessInsertDest-1
C41A ED4A             (dragondos_mmc.asm):01055                 STD     BupDestMess,U
                      (dragondos_mmc.asm):01056                 
C41C CC0001           (dragondos_mmc.asm):01057                 LDD     #$0001                  ; Set source and dest track and sector to 0 & 1
C41F ED41             (dragondos_mmc.asm):01058                 STD     BupSrcTrk,U
C421 ED48             (dragondos_mmc.asm):01059                 STD     BupDestTrk,U
C423 B6060A           (dragondos_mmc.asm):01060                 LDA     DosDefDriveNo           ; Get default drive no
C426 A7C4             (dragondos_mmc.asm):01061                 STA     ,U                      ; save in source drive
C428 A747             (dragondos_mmc.asm):01062                 STA     BupDestDrive,U          ; and dest
C42A 108E02D0         (dragondos_mmc.asm):01063                 LDY     #(SectorsPerTrack*40)   ; sector count 720 sectors=ss40 disk
                      (dragondos_mmc.asm):01064         
C42E 9DA5             (dragondos_mmc.asm):01065                 JSR     <BasChrGetCurr
C430 274A             (dragondos_mmc.asm):01066                 BEQ     DoCmdBackup             ; No params backup from default drive to default 
C432 BDC510           (dragondos_mmc.asm):01067                 JSR     >Get8BitorError
C435 C104             (dragondos_mmc.asm):01068                 CMPB    #MaxDriveNo             ; greater than Max drive (4)?
C437 1022012F         (dragondos_mmc.asm):01069                 LBHI    DosDNError
                      (dragondos_mmc.asm):01070         
C43B E7C4             (dragondos_mmc.asm):01071                 STB     ,U                      ; Save source drive
C43D E747             (dragondos_mmc.asm):01072                 STB     BupDestDrive,U          ; and default dest to same drive
                      (dragondos_mmc.asm):01073         
C43F 9DA5             (dragondos_mmc.asm):01074                 JSR     <BasChrGetCurr          ; Get current character from basic
C441 2739             (dragondos_mmc.asm):01075                 BEQ     DoCmdBackup             ; end of line : yes do backup
                      (dragondos_mmc.asm):01076         
C443 81BC             (dragondos_mmc.asm):01077                 CMPA    #DTokTO                 ; is this the "TO" token ?
C445 2619             (dragondos_mmc.asm):01078                 BNE     CmdBackupErrorExit
                      (dragondos_mmc.asm):01079         
C447 9D9F             (dragondos_mmc.asm):01080                 JSR     <BasChrGet              ; Get next char, skip over "TO"
C449 BDC510           (dragondos_mmc.asm):01081                 JSR     >Get8BitorError         ; Get dest drive in B
C44C C104             (dragondos_mmc.asm):01082                 CMPB    #MaxDriveNo             ; greater than Max drive (4)?
C44E 10220118         (dragondos_mmc.asm):01083                 LBHI    DosDNError
                      (dragondos_mmc.asm):01084         
C452 E747             (dragondos_mmc.asm):01085                 STB     BupDestDrive,U          ; Save in Dest driveno
                      (dragondos_mmc.asm):01086         
C454 8D91             (dragondos_mmc.asm):01087                 BSR     GetCommaThen8Bit        ; Skip comma, and get next param
C456 2724             (dragondos_mmc.asm):01088                 BEQ     DoCmdBackup             ; nothing : do backup
                      (dragondos_mmc.asm):01089         
C458 C102             (dragondos_mmc.asm):01090                 CMPB    #$02                    ; 2 sided disk specified ?
C45A 2707             (dragondos_mmc.asm):01091                 BEQ     BackupDS                ; yes backup double sided
C45C C101             (dragondos_mmc.asm):01092                 CMPB    #$01                    ; 1 sided disk specified ?
C45E 2709             (dragondos_mmc.asm):01093                 BEQ     BackupSS                ; yes backup single sided
                      (dragondos_mmc.asm):01094         
                      (dragondos_mmc.asm):01095         
C460                  (dragondos_mmc.asm):01096         CmdBackupErrorExit   
C460 7E89B4           (dragondos_mmc.asm):01097                 JMP     >BasSNError             ; error : exit
                      (dragondos_mmc.asm):01098         
C463                  (dragondos_mmc.asm):01099         BackupDS   
C463 1F20             (dragondos_mmc.asm):01100                 TFR     Y,D                     ; Double sector count if double sided
C465 31AB             (dragondos_mmc.asm):01101                 LEAY    D,Y
C467 684E             (dragondos_mmc.asm):01102                 ASL     BupSecTrk,U             ; Set sectors per track for DS disk
                      (dragondos_mmc.asm):01103         
C469                  (dragondos_mmc.asm):01104         BackupSS   
C469 BDC3E7           (dragondos_mmc.asm):01105                 JSR     >GetCommaThen8Bit       ; Get next param (if any)
C46C 270E             (dragondos_mmc.asm):01106                 BEQ     DoCmdBackup             ; none: continue
C46E C150             (dragondos_mmc.asm):01107                 CMPB    #$50                    ; Do 80 tracks ?
C470 2706             (dragondos_mmc.asm):01108                 BEQ     Backup80
C472 C128             (dragondos_mmc.asm):01109                 CMPB    #$28                    ; Do 40 tracks ?
C474 2706             (dragondos_mmc.asm):01110                 BEQ     DoCmdBackup
C476 20E8             (dragondos_mmc.asm):01111                 BRA     CmdBackupErrorExit      ; neither : error
                      (dragondos_mmc.asm):01112         
C478                  (dragondos_mmc.asm):01113         Backup80
C478 1F20             (dragondos_mmc.asm):01114                 TFR     Y,D                     ; Double sector count if 80 track
C47A 31AB             (dragondos_mmc.asm):01115                 LEAY    D,Y
                      (dragondos_mmc.asm):01116         
C47C                  (dragondos_mmc.asm):01117         DoCmdBackup   
C47C 4F               (dragondos_mmc.asm):01118                 CLRA
C47D                  (dragondos_mmc.asm):01119         BupReadFromSrc   
C47D 3121             (dragondos_mmc.asm):01120                 LEAY    1,Y                     ; Get sector count
C47F 30C4             (dragondos_mmc.asm):01121                 LEAX    ,U                      ; point to source drive on stack frame
C481 8D6D             (dragondos_mmc.asm):01122                 BSR     BupCheckPrompt          ; Check if drives are same & prompt if so
                      (dragondos_mmc.asm):01123                 
C483 313F             (dragondos_mmc.asm):01124         LC5B2   LEAY    -1,Y                    ; decrement sector count
C485 2606             (dragondos_mmc.asm):01125                 BNE     LC5BC                   ; if more sectors, do next
C487 8D1D             (dragondos_mmc.asm):01126                 BSR     BupWriteToDest
C489 32C810           (dragondos_mmc.asm):01127                 LEAS    BupStackFrame,U         ; Clear stack frame
C48C 39               (dragondos_mmc.asm):01128         LC5BB   RTS
                      (dragondos_mmc.asm):01129         
C48D A14F             (dragondos_mmc.asm):01130         LC5BC   CMPA    BupAvailPages,U         ; Filled all available RAM pages ?      
C48F 260E             (dragondos_mmc.asm):01131                 BNE     LC5CE                   ; no : do next sector
C491 8D13             (dragondos_mmc.asm):01132                 BSR     BupWriteToDest          ; Yes : write to destination
C493 3406             (dragondos_mmc.asm):01133                 PSHS    D
C495 DC1F             (dragondos_mmc.asm):01134                 LDD     <BasVarEnd              ; Get end of basic storage
C497 ED4C             (dragondos_mmc.asm):01135                 STD     BupDestBuff,U           ; Save in source and dest buffer pointers
C499 ED45             (dragondos_mmc.asm):01136                 STD     BupSrcBuff,U
C49B 3506             (dragondos_mmc.asm):01137                 PULS    D
C49D 20DE             (dragondos_mmc.asm):01138                 BRA     BupReadFromSrc          ; Do next sector
                      (dragondos_mmc.asm):01139         
C49F C602             (dragondos_mmc.asm):01140         LC5CE   LDB     #DosFnReadSec           ; Read the sectors
C4A1 8D12             (dragondos_mmc.asm):01141                 BSR     LC5E4                   ; go do it
C4A3 4C               (dragondos_mmc.asm):01142                 INCA                            
C4A4 20DD             (dragondos_mmc.asm):01143                 BRA     LC5B2
                      (dragondos_mmc.asm):01144         
C4A6                  (dragondos_mmc.asm):01145         BupWriteToDest   
C4A6 4D               (dragondos_mmc.asm):01146                 TSTA
C4A7 27E3             (dragondos_mmc.asm):01147                 BEQ     LC5BB
C4A9 3047             (dragondos_mmc.asm):01148                 LEAX    BupDestDrive,U          ; Point to dest drive vars
C4AB 8D43             (dragondos_mmc.asm):01149                 BSR     BupCheckPrompt          ; Check if drives are same & prompt if so
C4AD C603             (dragondos_mmc.asm):01150                 LDB     #DosFnWriteSecV         ; write sectors to destination
C4AF 8D04             (dragondos_mmc.asm):01151         LC5DE   BSR     LC5E4                   ; go do it
C4B1 4A               (dragondos_mmc.asm):01152                 DECA                            ; decrement sector count
C4B2 26FB             (dragondos_mmc.asm):01153                 BNE     LC5DE                   ; if more go again
C4B4 39               (dragondos_mmc.asm):01154         LC5E3   RTS
                      (dragondos_mmc.asm):01155         
C4B5 3406             (dragondos_mmc.asm):01156         LC5E4   PSHS    D
C4B7 A684             (dragondos_mmc.asm):01157                 LDA     ,X                      ; Get source drive
C4B9 97EB             (dragondos_mmc.asm):01158                 STA     <DosDriveNo             ; make source drive the current drive
                      (dragondos_mmc.asm):01159         
C4BB EC05             (dragondos_mmc.asm):01160                 LDD     BupSrcBuff,X            ; point to source buffer
C4BD DDEE             (dragondos_mmc.asm):01161                 STD     <DiskBuffPtr
C4BF EC01             (dragondos_mmc.asm):01162                 LDD     BupSrcTrk,X             ; get source track and sector
C4C1 DDEC             (dragondos_mmc.asm):01163                 STD     <DskTrackNo             ; set them
C4C3 E661             (dragondos_mmc.asm):01164                 LDB     1,S                     ; get the function code read or write
C4C5 BDC106           (dragondos_mmc.asm):01165                 JSR     >DosDoFuncinB           ; Ask dos to do it !
C4C8 2414             (dragondos_mmc.asm):01166                 BCC     LC60D                   ; no error, skip on
C4CA F70603           (dragondos_mmc.asm):01167                 STB     DosErrorCode            ; save error code
                      (dragondos_mmc.asm):01168         
C4CD A661             (dragondos_mmc.asm):01169                 LDA     1,S                     ; Get function, read or write
C4CF 8102             (dragondos_mmc.asm):01170                 CMPA    #DosFnReadSec           ; Read ?
C4D1 2605             (dragondos_mmc.asm):01171                 BNE     LC607
C4D3 3516             (dragondos_mmc.asm):01172                 PULS    D,X
                      (dragondos_mmc.asm):01173         
C4D5 BDC4A6           (dragondos_mmc.asm):01174                 JSR     >BupWriteToDest
C4D8 F60603           (dragondos_mmc.asm):01175         LC607   LDB     DosErrorCode            ; Retrieve error code
C4DB 7EC56F           (dragondos_mmc.asm):01176                 JMP     >DosHookSysError
                      (dragondos_mmc.asm):01177         
C4DE 6C02             (dragondos_mmc.asm):01178         LC60D   INC     BupSrcSec,X             ; Move to next source sector
C4E0 A602             (dragondos_mmc.asm):01179                 LDA     BupSrcSec,X
C4E2 A14E             (dragondos_mmc.asm):01180                 CMPA    BupSecTrk,U             ; still sectors on this track to read ?
C4E4 2306             (dragondos_mmc.asm):01181                 BLS     LC61B                   ; yep : keep going
                      (dragondos_mmc.asm):01182                 
C4E6 8601             (dragondos_mmc.asm):01183                 LDA     #$01
C4E8 A702             (dragondos_mmc.asm):01184                 STA     BupSrcSec,X             ; set source sec to 1
C4EA 6C01             (dragondos_mmc.asm):01185                 INC     BupSrcTrk,X             ; increment source track
C4EC 6C05             (dragondos_mmc.asm):01186         LC61B   INC     BupSrcBuff,X            ; move to next memorty page
C4EE 3586             (dragondos_mmc.asm):01187                 PULS    D,PC
                      (dragondos_mmc.asm):01188         
                      (dragondos_mmc.asm):01189         ;
                      (dragondos_mmc.asm):01190         ; Check if source and dest drives are the same and if so prompt to swap disks.
                      (dragondos_mmc.asm):01191         ;
                      (dragondos_mmc.asm):01192         
C4F0                  (dragondos_mmc.asm):01193         BupCheckPrompt   
C4F0 E6C4             (dragondos_mmc.asm):01194                 LDB     ,U                      ; get source drive
C4F2 E147             (dragondos_mmc.asm):01195                 CMPB    7,U                     ; same as dest drive ?
C4F4 26BE             (dragondos_mmc.asm):01196                 BNE     LC5E3                   ; no : continue
                      (dragondos_mmc.asm):01197                 
C4F6 3472             (dragondos_mmc.asm):01198                 PSHS    A,X,Y,U
C4F8 BDBA77           (dragondos_mmc.asm):01199                 JSR     >TextCls                ; clear screen
C4FB AE61             (dragondos_mmc.asm):01200                 LDX     1,S                     ; get message pointer
C4FD AE03             (dragondos_mmc.asm):01201                 LDX     3,X
C4FF BD90E5           (dragondos_mmc.asm):01202                 JSR     >TextOutString          ; Print message (insert source/insert dest)
C502 8EDCF7           (dragondos_mmc.asm):01203                 LDX     #DMessPressAnyKey-1
C505 BD90E5           (dragondos_mmc.asm):01204                 JSR     >TextOutString          ; Print press any key
C508 BDB505           (dragondos_mmc.asm):01205                 JSR     >TextWaitKeyCurs2       ; Wait for a kepress
C50B BDBA77           (dragondos_mmc.asm):01206                 JSR     >TextCls
C50E 35F2             (dragondos_mmc.asm):01207                 PULS    A,X,Y,U,PC
                      (dragondos_mmc.asm):01208         
                      (dragondos_mmc.asm):01209         ;
                      (dragondos_mmc.asm):01210         ; Get8BitorError, get non zero 8 bit value in B, or generate error
                      (dragondos_mmc.asm):01211         ;
C510                  (dragondos_mmc.asm):01212         Get8BitorError
C510 3460             (dragondos_mmc.asm):01213                 PSHS    Y,U
C512 BD8E51           (dragondos_mmc.asm):01214                 JSR     >VarGet8Bit             ; Get 8 bit value into B
C515 5D               (dragondos_mmc.asm):01215                 TSTB                            ; B non zero ?
C516 2603             (dragondos_mmc.asm):01216                 BNE     LC64A
C518 7E8B8D           (dragondos_mmc.asm):01217                 JMP     >BasFCError             ; No : error
                      (dragondos_mmc.asm):01218                 
C51B 35E0             (dragondos_mmc.asm):01219         LC64A   PULS    Y,U,PC                  ; Restore and return
                      (dragondos_mmc.asm):01220         
C51D                  (dragondos_mmc.asm):01221         DosCmdDispatch   
C51D 81FF             (dragondos_mmc.asm):01222                 CMPA    #$FF                    ; Invalid token ?
C51F 1027C491         (dragondos_mmc.asm):01223                 LBEQ    BasSNError
C523 80CE             (dragondos_mmc.asm):01224                 SUBA    #DDTokFirstC            ; Make token number zero based
C525 2A03             (dragondos_mmc.asm):01225                 BPL     LC659                   ; valid token : yep continue
                      (dragondos_mmc.asm):01226                 
C527 7E89B4           (dragondos_mmc.asm):01227         LC656   JMP     >BasSNError             ; nope SNError
                      (dragondos_mmc.asm):01228         
C52A 811A             (dragondos_mmc.asm):01229         LC659   CMPA    #DDTokCountC            ; check token in range
C52C 2406             (dragondos_mmc.asm):01230                 BCC     LC663                   ; Nope, continue to next jump table
C52E 8EE11F           (dragondos_mmc.asm):01231                 LDX     #CommandDispatchTable   ; Point to command address table
C531 7E84ED           (dragondos_mmc.asm):01232                 JMP     >BasDoDispatch          ; go do it !
                      (dragondos_mmc.asm):01233                 
C534 6E9F0137         (dragondos_mmc.asm):01234         LC663   JMP     [>NextResJump]          ; Jump to user reserved word handler >$0137
                      (dragondos_mmc.asm):01235         
C538                  (dragondos_mmc.asm):01236         DosFuncDispatch   
C538 C044             (dragondos_mmc.asm):01237                 SUBB    #$44
C53A 2A02             (dragondos_mmc.asm):01238                 BPL     LC66D                   ; Check token in range, skip if ok
C53C 20E9             (dragondos_mmc.asm):01239                 BRA     LC656                   ; else ?SN Error
                      (dragondos_mmc.asm):01240         
C53E C10E             (dragondos_mmc.asm):01241         LC66D   CMPB    #(DDTokCountF*2)        ; check token in range
C540 2408             (dragondos_mmc.asm):01242                 BCC     LC679                   ; nope : skip to next handler
C542 8EE179           (dragondos_mmc.asm):01243                 LDX     #FunctionDipatchTable   ; point to function table
C545 AD95             (dragondos_mmc.asm):01244                 JSR     [B,X]                   ; jump to function
C547 7E8874           (dragondos_mmc.asm):01245                 JMP     >VarGetExprCC           ; return value to basic
                      (dragondos_mmc.asm):01246         
C54A 6E9F013C         (dragondos_mmc.asm):01247         LC679   JMP     [>NextFuncsJump]        ; Jump to user function handler >$013C
                      (dragondos_mmc.asm):01248         
                      (dragondos_mmc.asm):01249         ; test and flush all buffers
                      (dragondos_mmc.asm):01250         
C54E                  (dragondos_mmc.asm):01251         TestAndFlushAll   
C54E 8E0634           (dragondos_mmc.asm):01252                 LDX     #Buff1Details           ; Point to first buffer
C551 BDD15F           (dragondos_mmc.asm):01253         LC680   JSR     >TestAndFlushBuffer     ; Flush if needed
C554 2619             (dragondos_mmc.asm):01254                 BNE     DosHookSysError         ; error : exit
                      (dragondos_mmc.asm):01255                 
C556 6F02             (dragondos_mmc.asm):01256                 CLR     BuffFlag,X              ; mark buffer free
C558 3007             (dragondos_mmc.asm):01257                 LEAX    BuffDetailSize,X        ; move to next buffer
C55A 8C0650           (dragondos_mmc.asm):01258                 CMPX    #(Buff1Details+(BuffCount*BuffDetailSize))      
                      (dragondos_mmc.asm):01259                 
C55D 25F2             (dragondos_mmc.asm):01260                 BCS     LC680                   ; done all : no loop again
C55F 39               (dragondos_mmc.asm):01261         LC68E   RTS
                      (dragondos_mmc.asm):01262         
                      (dragondos_mmc.asm):01263         ;
                      (dragondos_mmc.asm):01264         ; Get drive no in B, returns drive no (from command) in B,
                      (dragondos_mmc.asm):01265         ; or causes error if (drive < 0 ) or (drive > 4)
                      (dragondos_mmc.asm):01266         ;
                      (dragondos_mmc.asm):01267         
C560                  (dragondos_mmc.asm):01268         GetDriveNoInB   
C560 BD8E51           (dragondos_mmc.asm):01269                 JSR     >VarGet8Bit             ; Get 8 bit var
C563 5D               (dragondos_mmc.asm):01270                 TSTB
C564 2704             (dragondos_mmc.asm):01271                 BEQ     DosDNError
C566 C104             (dragondos_mmc.asm):01272                 CMPB    #$04                    ; Valid < 4 ?
C568 23F5             (dragondos_mmc.asm):01273                 BLS     LC68E                   ; yes : skip
                      (dragondos_mmc.asm):01274                  
C56A                  (dragondos_mmc.asm):01275         DosDNError   
C56A C628             (dragondos_mmc.asm):01276                 LDB     #BErrDN                 ; Device no error
C56C 8C               (dragondos_mmc.asm):01277                 FCB     Skip2           
                      (dragondos_mmc.asm):01278         
C56D                  (dragondos_mmc.asm):01279         DosPRError
C56D C6A4             (dragondos_mmc.asm):01280                 LDB     #ErrPR          ; Parameter error
                      (dragondos_mmc.asm):01281         
C56F                  (dragondos_mmc.asm):01282         DosHookSysError   
C56F F70619           (dragondos_mmc.asm):01283                 STB     DosErrLast              ; save last error code
C572 9E68             (dragondos_mmc.asm):01284                 LDX     <BasCurrentLine         ; Get current line no
C574 BF0617           (dragondos_mmc.asm):01285                 STX     DosErrLineNo            ; save for ERR routine
C577 BD8434           (dragondos_mmc.asm):01286                 JSR     >BasResetStack          ; reset basic stack
C57A 0FF6             (dragondos_mmc.asm):01287                 CLR     <DosIOInProgress        ; Flag no IO in progress
C57C BDBDDC           (dragondos_mmc.asm):01288                 JSR     >CasMotorOff            ; turn off tape motor
C57F BDBAC3           (dragondos_mmc.asm):01289                 JSR     >SndDisable             ; disable sound
C582 0F6F             (dragondos_mmc.asm):01290                 CLR     <TextDevN               ; Set device no back to console
C584 BD90A1           (dragondos_mmc.asm):01291                 JSR     >TextOutCRLF            ; output EOL
C587 7D0614           (dragondos_mmc.asm):01292                 TST     DosErrGotoFlag          ; Do we have an error handler ?
C58A 2A06             (dragondos_mmc.asm):01293                 BPL     LC6C1                   ; Yes, handle errors
C58C 9E68             (dragondos_mmc.asm):01294                 LDX     <BasCurrentLine         ; Get current line no
C58E 3001             (dragondos_mmc.asm):01295                 LEAX    1,X
C590 2611             (dragondos_mmc.asm):01296                 BNE     LC6D2
                      (dragondos_mmc.asm):01297         
C592 BD90F8           (dragondos_mmc.asm):01298         LC6C1   JSR     >TextOutQuestion        ; output '?'
C595 8E82A9           (dragondos_mmc.asm):01299                 LDX     #BasErrorCodeTable      ; Point to error code table $82A9
C598 F60619           (dragondos_mmc.asm):01300                 LDB     DosErrLast              ; Get last error code
C59B 2A03             (dragondos_mmc.asm):01301                 BPL     LC6CF
                      (dragondos_mmc.asm):01302                 
C59D 8EDC93           (dragondos_mmc.asm):01303                 LDX     #(DosErrorCodeTable-DDFirstError)       ; Get pointer to error table !
C5A0 7E835E           (dragondos_mmc.asm):01304         LC6CF   JMP     >SysErr2                ; Jump to basic Error handler
                      (dragondos_mmc.asm):01305         
C5A3 8E84DA           (dragondos_mmc.asm):01306         LC6D2   LDX     #BasBRARun              ; Go back to main interpreter loop $84DA
C5A6 3410             (dragondos_mmc.asm):01307                 PSHS    X                       ; push X as return address
C5A8 FC0615           (dragondos_mmc.asm):01308                 LDD     DosErrDestLine          ; get on error goto line
C5AB DD2B             (dragondos_mmc.asm):01309                 STD     <BasTempLine            ; save it in temp line
C5AD 7E85E7           (dragondos_mmc.asm):01310                 JMP     >BasSkipLineNo          ; jump to it.
                      (dragondos_mmc.asm):01311         ;
                      (dragondos_mmc.asm):01312         ; New reset vector
                      (dragondos_mmc.asm):01313         ;
                      (dragondos_mmc.asm):01314         
C5B0                  (dragondos_mmc.asm):01315         DOSResetVector
C5B0 12               (dragondos_mmc.asm):01316                 NOP                             ; Main ROM checks for reset->NOP
                      (dragondos_mmc.asm):01317         ;        CLRA                           ; Reset DP=0
                      (dragondos_mmc.asm):01318         ;        TFR     A,DP           
C5B1 BDC0A5           (dragondos_mmc.asm):01319                 JSR     >DosReset               ; Reset WD, and various Dos vars.
C5B4 7F0609           (dragondos_mmc.asm):01320                 CLR     DosErrorMask            ; reset various flags
C5B7 7F0605           (dragondos_mmc.asm):01321                 CLR     DosTimeout
C5BA 7F0613           (dragondos_mmc.asm):01322                 CLR     DosAutoFlag
                      (dragondos_mmc.asm):01323         ;        LDA     #$35                   ; Re-enable NMI
                      (dragondos_mmc.asm):01324         ;        STA     PIA0CRB
                      (dragondos_mmc.asm):01325         ;        JMP     >WarmStart             ; Jump back to Main ROM reset routine
C5BD 39               (dragondos_mmc.asm):01326                 RTS
                      (dragondos_mmc.asm):01327                 
                      (dragondos_mmc.asm):01328         ;
                      (dragondos_mmc.asm):01329         ; NMI vector, called to break out of read & write loops between 6809 & WD
                      (dragondos_mmc.asm):01330         ; This allows the IO routines to handle sectors of all lengths.
                      (dragondos_mmc.asm):01331         ;
                      (dragondos_mmc.asm):01332         
C5BE                  (dragondos_mmc.asm):01333         NMISrv   
C5BE 3B               (dragondos_mmc.asm):01334                 rti
                      (dragondos_mmc.asm):01335         ;       LDA     dpcmdreg                ; Read status register.
                      (dragondos_mmc.asm):01336         ;        CLRB                           ; Reset DP=0
                      (dragondos_mmc.asm):01337         ;        TFR     B,DP
                      (dragondos_mmc.asm):01338         ;        LEAS    12,S                   ; Drop registers from stack
                      (dragondos_mmc.asm):01339         ;        TSTA                           ; Setup CC
                      (dragondos_mmc.asm):01340         ;LC6FF   RTS
                      (dragondos_mmc.asm):01341         
                      (dragondos_mmc.asm):01342         ;
                      (dragondos_mmc.asm):01343         ; New IRQ vector, used to count down and shut off drives.
                      (dragondos_mmc.asm):01344         ;
                      (dragondos_mmc.asm):01345         
C5BF                  (dragondos_mmc.asm):01346         IRQSrv   
C5BF 2017             (dragondos_mmc.asm):01347                 BRA     LC724
                      (dragondos_mmc.asm):01348                 
C5C1 260F             (dragondos_mmc.asm):01349         LC702   BNE     LC71E                   ; Yes: don't time out
C5C3 B60605           (dragondos_mmc.asm):01350                 LDA     DosTimeout              ; Get timeout byte 
C5C6 270A             (dragondos_mmc.asm):01351                 BEQ     LC71E                   ; Already timed out : exit
                      (dragondos_mmc.asm):01352          
C5C8 4A               (dragondos_mmc.asm):01353                 DECA                            ; Decrement timeout count
C5C9 B70605           (dragondos_mmc.asm):01354                 STA     DosTimeout      
                      (dragondos_mmc.asm):01355         
C5CC 2604             (dragondos_mmc.asm):01356                 BNE     LC71E                   ; not zero, don't timeout yet
C5CE 8D15             (dragondos_mmc.asm):01357                 BSR     DOSSyncDir              ; syncronsise directory
C5D0 2603             (dragondos_mmc.asm):01358                 BNE     LC721                   ; Error : report it
C5D2                  (dragondos_mmc.asm):01359         LC71E
C5D2 200A             (dragondos_mmc.asm):01360                 BRA     LC72D
C5D4 12               (dragondos_mmc.asm):01361                 NOP
                      (dragondos_mmc.asm):01362                         
C5D5 7EC56F           (dragondos_mmc.asm):01363         LC721   JMP     >DosHookSysError
                      (dragondos_mmc.asm):01364         
C5D8 3404             (dragondos_mmc.asm):01365         LC724   PSHS    B
                      (dragondos_mmc.asm):01366         ;       CLRA                            ; DP = 0
                      (dragondos_mmc.asm):01367         ;       TFR     A,DP                    
C5DA 0DF6             (dragondos_mmc.asm):01368                 TST     <DosIOInProgress        ; Doing IO ?
C5DC 20E3             (dragondos_mmc.asm):01369                 BRA     LC702
                      (dragondos_mmc.asm):01370         
C5DE 3504             (dragondos_mmc.asm):01371         LC72D   PULS    B
C5E0 7E9D3D           (dragondos_mmc.asm):01372                 JMP     BasIRQVec
                      (dragondos_mmc.asm):01373                 
C5E3 12               (dragondos_mmc.asm):01374                 NOP
C5E4 12               (dragondos_mmc.asm):01375                 NOP
                      (dragondos_mmc.asm):01376         ;
                      (dragondos_mmc.asm):01377         ; Copy updated track 20 to track 16
                      (dragondos_mmc.asm):01378         ;
                      (dragondos_mmc.asm):01379         ; Backup the directory to the alternate directory.
                      (dragondos_mmc.asm):01380         ;
                      (dragondos_mmc.asm):01381         ; No calling arguments.
                      (dragondos_mmc.asm):01382         ;
                      (dragondos_mmc.asm):01383         ; Stack frame.
                      (dragondos_mmc.asm):01384         ;       $0008   Sector number
                      (dragondos_mmc.asm):01385         ;       $0007   Sector number
                      (dragondos_mmc.asm):01386         ;       $0006   Sector number
                      (dragondos_mmc.asm):01387         ;       $0005   Sector number
                      (dragondos_mmc.asm):01388         ;       $0004   Number of full buffers
                      (dragondos_mmc.asm):01389         ;       $0003   Current sector number
                      (dragondos_mmc.asm):01390         ;       $0002   User's drive number
                      (dragondos_mmc.asm):01391         ;       $0001   Last error
                      (dragondos_mmc.asm):01392         ;       $0000   bitmask for 'DTYDIR'
                      (dragondos_mmc.asm):01393         ;
                      (dragondos_mmc.asm):01394         
C5E5                  (dragondos_mmc.asm):01395         DOSSyncDir   
C5E5 BDC54E           (dragondos_mmc.asm):01396                 JSR     >TestAndFlushAll        ; Flush all buffers if needed
C5E8 3278             (dragondos_mmc.asm):01397                 LEAS    -8,S                    ; Make room on stack
C5EA 33E4             (dragondos_mmc.asm):01398                 LEAU    ,S                      ; Point U at stack frame
C5EC 3144             (dragondos_mmc.asm):01399                 LEAY    SyncSectors,U           ; point Y at sync sector table
                      (dragondos_mmc.asm):01400                 
C5EE 8E0800           (dragondos_mmc.asm):01401                 LDX     #DosDiskBuffBase        ; Point at tempory buffer area
C5F1 9FEE             (dragondos_mmc.asm):01402                 STX     <DiskBuffPtr
C5F3 6F42             (dragondos_mmc.asm):01403                 CLR     SyncBufferNo,U          ; clear buffer no counter
C5F5 D6EB             (dragondos_mmc.asm):01404                 LDB     <DosDriveNo             ; Get last accessed drive
C5F7 E741             (dragondos_mmc.asm):01405                 STB     SyncDrive,U             ; Save it
C5F9 C601             (dragondos_mmc.asm):01406                 LDB     #$01                    ; Drive counter shifted left to count
C5FB E7C4             (dragondos_mmc.asm):01407                 STB     ,U
C5FD 0FEB             (dragondos_mmc.asm):01408                 CLR     <DosDriveNo
C5FF 8E06AA           (dragondos_mmc.asm):01409                 LDX     #DosDirSecStatus-1      ; $06AA
                      (dragondos_mmc.asm):01410                 
C602 C612             (dragondos_mmc.asm):01411         LC751   LDB     #SectorsPerTrack        ; Sector count
C604 E743             (dragondos_mmc.asm):01412                 STB     SyncSecNo,U
C606 0CEB             (dragondos_mmc.asm):01413                 INC     <DosDriveNo
                      (dragondos_mmc.asm):01414         
C608 E643             (dragondos_mmc.asm):01415         LC757   LDB     SyncSecNo,U             ; get sector no
C60A A685             (dragondos_mmc.asm):01416                 LDA     B,X                     ; get it's status byte
C60C A5C4             (dragondos_mmc.asm):01417                 BITA    ,U                      ; test it
C60E 271E             (dragondos_mmc.asm):01418                 BEQ     LC77D
                      (dragondos_mmc.asm):01419                 
C610 43               (dragondos_mmc.asm):01420                 COMA
C611 A485             (dragondos_mmc.asm):01421                 ANDA    B,X
C613 A785             (dragondos_mmc.asm):01422                 STA     B,X
C615 6C42             (dragondos_mmc.asm):01423                 INC     SyncBufferNo,U          ; move to next buffer
C617 D7ED             (dragondos_mmc.asm):01424                 STB     <DskSectorNo
C619 E7A0             (dragondos_mmc.asm):01425                 STB     ,Y+
C61B C614             (dragondos_mmc.asm):01426                 LDB     #DirPrimary             ; Track 20
C61D D7EC             (dragondos_mmc.asm):01427                 STB     <DskTrackNo             
C61F BDC104           (dragondos_mmc.asm):01428                 JSR     >DosDoReadSec           ; Go read sector
                      (dragondos_mmc.asm):01429                 
C622 2621             (dragondos_mmc.asm):01430                 BNE     LC794                   ; Error !
                      (dragondos_mmc.asm):01431                 
C624 0CEE             (dragondos_mmc.asm):01432                 INC     <DiskBuffPtr            ; use next disk buffer
C626 E642             (dragondos_mmc.asm):01433                 LDB     SyncBufferNo,U          ; Check to see if we have filled all buffers
C628 C104             (dragondos_mmc.asm):01434                 CMPB    #$04                    
C62A 2502             (dragondos_mmc.asm):01435                 BCS     LC77D                   ; nope keep going
C62C 8D1A             (dragondos_mmc.asm):01436                 BSR     LC797                   ; flush them
                      (dragondos_mmc.asm):01437                 
C62E 6A43             (dragondos_mmc.asm):01438         LC77D   DEC     SyncSecNo,U             ; decrement sector no
C630 26D6             (dragondos_mmc.asm):01439                 BNE     LC757                   ; keep going if more sectors
                      (dragondos_mmc.asm):01440                 
C632 6D42             (dragondos_mmc.asm):01441                 TST     SyncBufferNo,U          ; any buffers in use ?, so sectors still waiting to be flushed ?
C634 2702             (dragondos_mmc.asm):01442                 BEQ     LC787                   ; no  skip
C636 8D10             (dragondos_mmc.asm):01443                 BSR     LC797                   ; yes : flush them
                      (dragondos_mmc.asm):01444                 
C638 68C4             (dragondos_mmc.asm):01445         LC787   ASL     ,U                      ; move to next drive                    
C63A A6C4             (dragondos_mmc.asm):01446                 LDA     ,U                              
C63C 8108             (dragondos_mmc.asm):01447                 CMPA    #$08                    ; done all drives ?     
C63E 23C2             (dragondos_mmc.asm):01448                 BLS     LC751                   ; nope do next
                      (dragondos_mmc.asm):01449                         
C640 A641             (dragondos_mmc.asm):01450                 LDA     SyncDrive,U             ; Restore last used drive
C642 97EB             (dragondos_mmc.asm):01451                 STA     <DosDriveNo
                      (dragondos_mmc.asm):01452         
C644 5F               (dragondos_mmc.asm):01453                 CLRB                            ; Flag no error
C645 3248             (dragondos_mmc.asm):01454         LC794   LEAS    8,U                     ; Drop stack frame
C647 39               (dragondos_mmc.asm):01455                 RTS
                      (dragondos_mmc.asm):01456         
C648 8610             (dragondos_mmc.asm):01457         LC797   LDA     #DirBackup              ; Backup track no
C64A 97EC             (dragondos_mmc.asm):01458                 STA     <DskTrackNo
C64C 0AEE             (dragondos_mmc.asm):01459         LC79B   DEC     <DiskBuffPtr            ; Move to previous buffer
C64E 313F             (dragondos_mmc.asm):01460                 LEAY    -1,Y
C650 A6A4             (dragondos_mmc.asm):01461                 LDA     ,Y
C652 97ED             (dragondos_mmc.asm):01462                 STA     <DskSectorNo            ; Pickup sector no
C654 BDC101           (dragondos_mmc.asm):01463                 JSR     >DosDoWriteSecV         ; Go write it
C657 2703             (dragondos_mmc.asm):01464                 BEQ     LC7AB
                      (dragondos_mmc.asm):01465         
C659 3248             (dragondos_mmc.asm):01466                 LEAS    8,U
C65B 39               (dragondos_mmc.asm):01467                 RTS
                      (dragondos_mmc.asm):01468         
C65C 6A42             (dragondos_mmc.asm):01469         LC7AB   DEC     SyncBufferNo,U          ; move to previous disk buffer
C65E 26EC             (dragondos_mmc.asm):01470                 BNE     LC79B
C660 39               (dragondos_mmc.asm):01471         LC7AF   RTS
                      (dragondos_mmc.asm):01472         
C661                  (dragondos_mmc.asm):01473         FIRQSrv   
                      (dragondos_mmc.asm):01474         ;       TST     PIACRA                  ; Clear interrupt conditions 
                      (dragondos_mmc.asm):01475         ;        TST     PIACRB
C661 3B               (dragondos_mmc.asm):01476                 RTI                             ; and return
                      (dragondos_mmc.asm):01477         
                      (dragondos_mmc.asm):01478         ;
                      (dragondos_mmc.asm):01479         ; Validate and open a file.
                      (dragondos_mmc.asm):01480         ;
                      (dragondos_mmc.asm):01481         ; Entry conditions are as for DOSValidFilename (below).
                      (dragondos_mmc.asm):01482         ; Exit conditions are as for DOSOpenFile if carry clear, else
                      (dragondos_mmc.asm):01483         ; error code in B if carry set.
                      (dragondos_mmc.asm):01484         ;
                      (dragondos_mmc.asm):01485         
C662                  (dragondos_mmc.asm):01486         DosValidateAndOpen
C662 8D05             (dragondos_mmc.asm):01487                 BSR     DOSValidFilename        ; Validate filename
C664 26FA             (dragondos_mmc.asm):01488                 BNE     LC7AF                   ; Error : exit
C666 7EC727           (dragondos_mmc.asm):01489                 JMP     >DOSOpenFile            ; Open file if valid
                      (dragondos_mmc.asm):01490                 
                      (dragondos_mmc.asm):01491         ;
                      (dragondos_mmc.asm):01492         ; Validate filename and copy to current drive block
                      (dragondos_mmc.asm):01493         ;
                      (dragondos_mmc.asm):01494         ;       On entry:
                      (dragondos_mmc.asm):01495         ;         X points to filename e.g. '3:FILENAME.EXT'
                      (dragondos_mmc.asm):01496         ;         B length of filename e.g. 0x0e
                      (dragondos_mmc.asm):01497         ;         Y points to default extension to use if none is given e.g. 'DAT'.
                      (dragondos_mmc.asm):01498         ;           Use '   ' for no default extension
                      (dragondos_mmc.asm):01499         ;       
                      (dragondos_mmc.asm):01500         ;       If no drive given default drive (DosDriveNo) is used.                   
                      (dragondos_mmc.asm):01501         ;               
                      (dragondos_mmc.asm):01502         ;       On Return:
                      (dragondos_mmc.asm):01503         ;         Filename appears at $0650-$065a (DosCurFilename)
                      (dragondos_mmc.asm):01504         ;         Current drive (DosCurDriveNo) is set
                      (dragondos_mmc.asm):01505         ;         CC.Z clear on error
                      (dragondos_mmc.asm):01506         ;         B contains error code
                      (dragondos_mmc.asm):01507         ;         U $065b always (SuperDosE6)
                      (dragondos_mmc.asm):01508         ;
                      (dragondos_mmc.asm):01509         ; Filenames can be of the following formats :
                      (dragondos_mmc.asm):01510         ;       "d:filename.ext"
                      (dragondos_mmc.asm):01511         ;       "filename.ext:d"
                      (dragondos_mmc.asm):01512         ;       "d:filename"
                      (dragondos_mmc.asm):01513         ;       "filename:d"
                      (dragondos_mmc.asm):01514         ;       "filename"
                      (dragondos_mmc.asm):01515         ;       "filename.ext"
                      (dragondos_mmc.asm):01516         ;
                      (dragondos_mmc.asm):01517         
C669                  (dragondos_mmc.asm):01518         DOSValidFilename  
C669 7EDD55           (dragondos_mmc.asm):01519                 JMP     >LDFF3
                      (dragondos_mmc.asm):01520                         
C66C B7065B           (dragondos_mmc.asm):01521         LC7C1   STA     DosCurDriveNo           ; Set current drive number, default if non specified
C66F 7F0660           (dragondos_mmc.asm):01522                 CLR     DosCurCount
C672 CE0650           (dragondos_mmc.asm):01523                 LDU     #DosCurDriveInfo        ; Point at current drive info
                      (dragondos_mmc.asm):01524         
C675 8607             (dragondos_mmc.asm):01525                 LDA     #$07                    ; Zero out first 8 bytes (filename)     
C677 6FC6             (dragondos_mmc.asm):01526         LC7CC   CLR     A,U
C679 4A               (dragondos_mmc.asm):01527                 DECA
C67A 2AFB             (dragondos_mmc.asm):01528                 BPL     LC7CC
                      (dragondos_mmc.asm):01529                 
C67C A622             (dragondos_mmc.asm):01530                 LDA     2,Y                     ; Transfer extension into current details
C67E B7065A           (dragondos_mmc.asm):01531                 STA     DosCurExtension+2       ; $065A
C681 A621             (dragondos_mmc.asm):01532                 LDA     1,Y
C683 B70659           (dragondos_mmc.asm):01533                 STA     DosCurExtension+1       ; $0659
C686 A6A4             (dragondos_mmc.asm):01534                 LDA     ,Y
C688 B70658           (dragondos_mmc.asm):01535                 STA     DosCurExtension         ; $0658
                      (dragondos_mmc.asm):01536         
C68B C10E             (dragondos_mmc.asm):01537                 CMPB    #MaxFilenameLen         ; Filename too long ?
C68D 2245             (dragondos_mmc.asm):01538                 BHI     LC829                   ; Yep : error
                      (dragondos_mmc.asm):01539                 
C68F C103             (dragondos_mmc.asm):01540                 CMPB    #$03                    ; Long enough to contain drive no ?
C691 2529             (dragondos_mmc.asm):01541                 BCS     LC811                   ; nope : skip on
                      (dragondos_mmc.asm):01542                 
                      (dragondos_mmc.asm):01543         ; Because of the order of compare a drive letter at the END of the filename always
                      (dragondos_mmc.asm):01544         ; takes presedence, this would only be siginificant if the filename where something like
                      (dragondos_mmc.asm):01545         ; '1:2' which would access a file called '1' on drive 2, and NOT 2 on drive 1
                      (dragondos_mmc.asm):01546                 
C693 C002             (dragondos_mmc.asm):01547                 SUBB    #$02                    ; Look for drive no at end of filename
C695 A685             (dragondos_mmc.asm):01548                 LDA     B,X
C697 813A             (dragondos_mmc.asm):01549                 CMPA    #':'                    ; Seperator present ? $3A
C699 2606             (dragondos_mmc.asm):01550                 BNE     LC7F6                   ; No skip on
C69B 5C               (dragondos_mmc.asm):01551                 INCB
C69C A685             (dragondos_mmc.asm):01552                 LDA     B,X                     ; Get drive no
C69E 5C               (dragondos_mmc.asm):01553                 INCB
C69F 200A             (dragondos_mmc.asm):01554                 BRA     LC800
                      (dragondos_mmc.asm):01555         
C6A1 CB02             (dragondos_mmc.asm):01556         LC7F6   ADDB    #$02                    ; Check for drive at begining of path
C6A3 A601             (dragondos_mmc.asm):01557                 LDA     1,X
C6A5 813A             (dragondos_mmc.asm):01558                 CMPA    #':'                    ; Seperator present ? $3A
C6A7 2613             (dragondos_mmc.asm):01559                 BNE     LC811                   ; nope, use default drive
                      (dragondos_mmc.asm):01560                 
C6A9 A681             (dragondos_mmc.asm):01561                 LDA     ,X++                    ; Get ascii drive no
C6AB 8030             (dragondos_mmc.asm):01562         LC800   SUBA    #$30                    ; Work out drive number
                      (dragondos_mmc.asm):01563                 
C6AD 2304             (dragondos_mmc.asm):01564                 BLS     LC808                   ; invalid : exit
C6AF 8104             (dragondos_mmc.asm):01565                 CMPA    #MaxDriveNo             ; Drive valid ?
C6B1 2304             (dragondos_mmc.asm):01566                 BLS     LC80C                   ; valid, skip on
                      (dragondos_mmc.asm):01567                 
C6B3 C628             (dragondos_mmc.asm):01568         LC808   LDB     #BErrDN                 ; Error device no
C6B5 39               (dragondos_mmc.asm):01569                 RTS
C6B6 12               (dragondos_mmc.asm):01570                 NOP
                      (dragondos_mmc.asm):01571                         
C6B7 B7065B           (dragondos_mmc.asm):01572         LC80C   STA     DosCurDriveNo           ; Set current drive if specified
C6BA C002             (dragondos_mmc.asm):01573                 SUBB    #$02
                      (dragondos_mmc.asm):01574         
                      (dragondos_mmc.asm):01575         ; Parse filename looking for extension seperator
                      (dragondos_mmc.asm):01576                 
C6BC A680             (dragondos_mmc.asm):01577         LC811   LDA     ,X+                     ; Get next char
C6BE 5A               (dragondos_mmc.asm):01578                 DECB                            ; Decrement path count
C6BF 2B64             (dragondos_mmc.asm):01579                 BMI     LC87A                   ; Reached end : yes skip
                      (dragondos_mmc.asm):01580                 
C6C1 812F             (dragondos_mmc.asm):01581                 CMPA    #'/'                    ; Check for slash $2F
C6C3 2704             (dragondos_mmc.asm):01582                 BEQ     LC81E
                      (dragondos_mmc.asm):01583         
C6C5 812E             (dragondos_mmc.asm):01584                 CMPA    #'.'                    ; Check for period $2E
C6C7 261C             (dragondos_mmc.asm):01585                 BNE     LC83A
                      (dragondos_mmc.asm):01586         
C6C9 11830650         (dragondos_mmc.asm):01587         LC81E   CMPU    #DosCurDriveInfo        ; $0650
C6CD 2705             (dragondos_mmc.asm):01588                 BEQ     LC829
                      (dragondos_mmc.asm):01589                 
C6CF 7D0660           (dragondos_mmc.asm):01590                 TST     DosCurCount             ; First pass ?
C6D2 2703             (dragondos_mmc.asm):01591                 BEQ     LC82C                   ; yes : skip on
                      (dragondos_mmc.asm):01592         
C6D4 C696             (dragondos_mmc.asm):01593         LC829   LDB     #ErrFS          ; Error : bad filespec 
C6D6 39               (dragondos_mmc.asm):01594                 RTS
                      (dragondos_mmc.asm):01595         
C6D7 7C0660           (dragondos_mmc.asm):01596         LC82C   INC     DosCurCount             ; Mark second pass
C6DA CE0658           (dragondos_mmc.asm):01597                 LDU     #DosCurExtension        ; $0658
C6DD 6FC4             (dragondos_mmc.asm):01598                 CLR     ,U                      ; Zero out extension
C6DF 6F41             (dragondos_mmc.asm):01599                 CLR     1,U
C6E1 6F42             (dragondos_mmc.asm):01600                 CLR     2,U
C6E3 20D7             (dragondos_mmc.asm):01601                 BRA     LC811
                      (dragondos_mmc.asm):01602         
                      (dragondos_mmc.asm):01603         ; Validate filename chars
                      (dragondos_mmc.asm):01604         
C6E5 8141             (dragondos_mmc.asm):01605         LC83A   CMPA    #'A'                    ; $41
C6E7 2510             (dragondos_mmc.asm):01606                 BCS     LC84E                   ; Below, check if still valid
                      (dragondos_mmc.asm):01607                 
C6E9 815A             (dragondos_mmc.asm):01608                 CMPA    #'Z'                    ; $5A
C6EB 2318             (dragondos_mmc.asm):01609                 BLS     LC85A                   ; valid, skip on
                      (dragondos_mmc.asm):01610                 
C6ED 8020             (dragondos_mmc.asm):01611                 SUBA    #$20                    ; Convert to lower case if upper
C6EF 8141             (dragondos_mmc.asm):01612                 CMPA    #'A'                    ; $41
C6F1 25E1             (dragondos_mmc.asm):01613                 BCS     LC829                   ; Invalid, return error
                      (dragondos_mmc.asm):01614                 
C6F3 815A             (dragondos_mmc.asm):01615                 CMPA    #'Z'                    ; $5A
C6F5 230E             (dragondos_mmc.asm):01616                 BLS     LC85A                   ; Valid: skip on
C6F7 20DB             (dragondos_mmc.asm):01617                 BRA     LC829
                      (dragondos_mmc.asm):01618         
C6F9 812D             (dragondos_mmc.asm):01619         LC84E   CMPA    #'-'                    ; $2D
C6FB 2708             (dragondos_mmc.asm):01620                 BEQ     LC85A                   ; Valid skip on
                      (dragondos_mmc.asm):01621                 
C6FD 8130             (dragondos_mmc.asm):01622                 CMPA    #'0'                    ; $30
C6FF 25D3             (dragondos_mmc.asm):01623                 BCS     LC829                   ; Invalid : error
                      (dragondos_mmc.asm):01624                 
C701 8139             (dragondos_mmc.asm):01625                 CMPA    #'9'                    ; $39
C703 22CF             (dragondos_mmc.asm):01626                 BHI     LC829                   ; Invalid : error
                      (dragondos_mmc.asm):01627                 
C705 A7C0             (dragondos_mmc.asm):01628         LC85A   STA     ,U+                     ; Save char in path
C707 1183065B         (dragondos_mmc.asm):01629                 CMPU    #DosCurDriveNo          ; Path full ?
C70B 2605             (dragondos_mmc.asm):01630                 BNE     LC867                   ; nope : skip
                      (dragondos_mmc.asm):01631                 
C70D 5D               (dragondos_mmc.asm):01632                 TSTB                            ; Done all path chars ?
C70E 26C4             (dragondos_mmc.asm):01633                 BNE     LC829                   ; nope : error !
C710 2013             (dragondos_mmc.asm):01634                 BRA     LC87A
                      (dragondos_mmc.asm):01635         
C712 11830658         (dragondos_mmc.asm):01636         LC867   CMPU    #DosCurExtension        ; Reached extension ? $0658
C716 26A4             (dragondos_mmc.asm):01637                 BNE     LC811
                      (dragondos_mmc.asm):01638                 
C718 A680             (dragondos_mmc.asm):01639                 LDA     ,X+                     ; Get next 
C71A 5A               (dragondos_mmc.asm):01640                 DECB                            ; Dec count
C71B 2B08             (dragondos_mmc.asm):01641                 BMI     LC87A                   ; Done, return
                      (dragondos_mmc.asm):01642                 
C71D 812E             (dragondos_mmc.asm):01643                 CMPA    #'.'                    ; Check for seperator $2E
C71F 27A8             (dragondos_mmc.asm):01644                 BEQ     LC81E                   ; yep loop back
                      (dragondos_mmc.asm):01645                 
C721 812F             (dragondos_mmc.asm):01646                 CMPA    #'/'                    ; Check for seperator $2F
C723 27A4             (dragondos_mmc.asm):01647                 BEQ     LC81E                   ; Yep loop back
                      (dragondos_mmc.asm):01648                 
C725 5F               (dragondos_mmc.asm):01649         LC87A   CLRB
C726 39               (dragondos_mmc.asm):01650                 RTS
                      (dragondos_mmc.asm):01651         
                      (dragondos_mmc.asm):01652         ;
                      (dragondos_mmc.asm):01653         ; Open a file and copy dir entry into FCB.
                      (dragondos_mmc.asm):01654         ;
                      (dragondos_mmc.asm):01655         ; The name in DosCurFilename is searched for in the FIBs, if found then
                      (dragondos_mmc.asm):01656         ; the FIB number is returned in A. If not found a FIB is created and the
                      (dragondos_mmc.asm):01657         ; disk is searched for the filaname. If not file is found ErrNE is returned
                      (dragondos_mmc.asm):01658         ; in B.
                      (dragondos_mmc.asm):01659         ;
                      (dragondos_mmc.asm):01660         ;  On entry:
                      (dragondos_mmc.asm):01661         ;           Filename at DosCurFilename
                      (dragondos_mmc.asm):01662         ;           Drive no at DosCurDriveNo   
                      (dragondos_mmc.asm):01663         ;         Returns:
                      (dragondos_mmc.asm):01664         ;           CC.Z clear on error
                      (dragondos_mmc.asm):01665         ;           A FIB number (0-9)
                      (dragondos_mmc.asm):01666         ;           B contains error code
                      (dragondos_mmc.asm):01667         ;
                      (dragondos_mmc.asm):01668         
C727                  (dragondos_mmc.asm):01669         DOSOpenFile   
C727 8E06BD           (dragondos_mmc.asm):01670                 LDX     #DosFCB0Addr            ; Point to first FCB
C72A 0FF1             (dragondos_mmc.asm):01671                 CLR     <DosCurrCtrlBlk
C72C FC0650           (dragondos_mmc.asm):01672                 LDD     DosCurDriveInfo         ; Get first 2 bytes of current drive info
C72F 10A384           (dragondos_mmc.asm):01673         LC884   CMPD    ,X                      ; Does this FCB point to it ?
C732 2616             (dragondos_mmc.asm):01674                 BNE     LC89F                   ; Nope : check next
                      (dragondos_mmc.asm):01675                 
                      (dragondos_mmc.asm):01676         ; Found matching first 2 bytes of name in an FCB
                      (dragondos_mmc.asm):01677                 
C734 CE0652           (dragondos_mmc.asm):01678                 LDU     #DosCurDriveInfo+2      ; Check bytes 2..end of filename
C737 3102             (dragondos_mmc.asm):01679                 LEAY    2,X                     ; Compare from byte 2 of FCB
C739 C60A             (dragondos_mmc.asm):01680                 LDB     #$0A                    ; Do 10 bytes, rest of filename + ext
C73B A6C0             (dragondos_mmc.asm):01681         LC890   LDA     ,U+                     ; Get a byte from current
C73D A1A0             (dragondos_mmc.asm):01682                 CMPA    ,Y+                     ; compare to FCB
C73F 2606             (dragondos_mmc.asm):01683                 BNE     LC89C                   ; Don't match : exit check
C741 5A               (dragondos_mmc.asm):01684                 DECB                            ; Decrement counter
C742 26F7             (dragondos_mmc.asm):01685                 BNE     LC890                   ; Not at end : do next
C744 1600AB           (dragondos_mmc.asm):01686                 LBRA    LC947
                      (dragondos_mmc.asm):01687         
                      (dragondos_mmc.asm):01688         
                      (dragondos_mmc.asm):01689         ; Move to check next FCB
                      (dragondos_mmc.asm):01690         
C747 FC0650           (dragondos_mmc.asm):01691         LC89C   LDD     DosCurDriveInfo         ; Re-get first 2 chars of current filaname
C74A 30881F           (dragondos_mmc.asm):01692         LC89F   LEAX    DosFCBLength,X          ; Skip to next FCB
C74D 0CF1             (dragondos_mmc.asm):01693                 INC     <DosCurrCtrlBlk         ; Set current control block
C74F 8C07F3           (dragondos_mmc.asm):01694                 CMPX    #DosFCBEnd              ; End of blocks ?
C752 25DB             (dragondos_mmc.asm):01695                 BCS     LC884                   ; No, loop back and check this block
                      (dragondos_mmc.asm):01696                 
C754 0FF1             (dragondos_mmc.asm):01697                 CLR     <DosCurrCtrlBlk         ; Set current block to zero
C756 8E06BD           (dragondos_mmc.asm):01698                 LDX     #DosFCB0Addr            ; Point at first FCB
                      (dragondos_mmc.asm):01699         
C759 6D84             (dragondos_mmc.asm):01700         LC8AE   TST     ,X                      ; FCB in use ?
C75B 270D             (dragondos_mmc.asm):01701                 BEQ     LC8BF                   ; No : skip on
                      (dragondos_mmc.asm):01702                 
C75D 30881F           (dragondos_mmc.asm):01703                 LEAX    DosFCBLength,X          ; Check next FCB
C760 0CF1             (dragondos_mmc.asm):01704                 INC     <DosCurrCtrlBlk         
C762 8C07F3           (dragondos_mmc.asm):01705                 CMPX    #DosFCBEnd              ; Done all FCBs
C765 25F2             (dragondos_mmc.asm):01706                 BCS     LC8AE                   ; No : check next, yes error, can't open file, no free FCBS
C767 C6A2             (dragondos_mmc.asm):01707                 LDB     #ErrTF          ; error : too many files open
C769 39               (dragondos_mmc.asm):01708         LC8BE   RTS
                      (dragondos_mmc.asm):01709         
C76A C60C             (dragondos_mmc.asm):01710         LC8BF   LDB     #$0C                    ; Copy 12 characters of filename
C76C 1F12             (dragondos_mmc.asm):01711                 TFR     X,Y                     ; Point Y at selected FCB
C76E CE0650           (dragondos_mmc.asm):01712                 LDU     #DosCurDriveInfo        ; Point at current info
C771 A6C0             (dragondos_mmc.asm):01713         LC8C6   LDA     ,U+                     ; Copy filename
C773 A7A0             (dragondos_mmc.asm):01714                 STA     ,Y+
C775 5A               (dragondos_mmc.asm):01715                 DECB                            ; Dec count
C776 26F9             (dragondos_mmc.asm):01716                 BNE     LC8C6                   ; if not all done : do next
                      (dragondos_mmc.asm):01717                 
C778 97EB             (dragondos_mmc.asm):01718                 STA     <DosDriveNo             ; Save current drive
                      (dragondos_mmc.asm):01719         
                      (dragondos_mmc.asm):01720         ; Note in disassembled superdos source, the following was LDU #$0616, which is part of the error line !
                      (dragondos_mmc.asm):01721         ; This makes no sense, and is Drv0Details, in DragonDos source, I think I just fixed a 20 year old
                      (dragondos_mmc.asm):01722         ; bug !!!!!!
                      (dragondos_mmc.asm):01723         
C77A CE061C           (dragondos_mmc.asm):01724                 LDU     #Drv0Details            ; Get drive details      
C77D C606             (dragondos_mmc.asm):01725                 LDB     #DrvDeatailLen          ; 6 bytes/drive
C77F 3D               (dragondos_mmc.asm):01726                 MUL
C780 33CB             (dragondos_mmc.asm):01727                 LEAU    D,U                     ; Point at drive detail block
C782 6C45             (dragondos_mmc.asm):01728                 INC     DrvDetUseCnt,U          ; Increment usage/open file count       
                      (dragondos_mmc.asm):01729                 
C784 C613             (dragondos_mmc.asm):01730                 LDB     #$13                    ; Clear rest of FCB
C786 6FA0             (dragondos_mmc.asm):01731         LC8DB   CLR     ,Y+
C788 5A               (dragondos_mmc.asm):01732                 DECB                            ; Dec counter
C789 26FB             (dragondos_mmc.asm):01733                 BNE     LC8DB                   ; Loop if more
                      (dragondos_mmc.asm):01734                 
C78B 8680             (dragondos_mmc.asm):01735                 LDA     #AttrDeleted            ; Flag file as deleted by default
C78D A70F             (dragondos_mmc.asm):01736                 STA     FCBDirFlags,X
                      (dragondos_mmc.asm):01737                 
C78F 7F0681           (dragondos_mmc.asm):01738                 CLR     DosTempFileNo           ; start temp fileno at 0
C792 BDD028           (dragondos_mmc.asm):01739                 JSR     >DosGetDiskGeometry     ; get disk geometry
C795 26D2             (dragondos_mmc.asm):01740                 BNE     LC8BE                   ; error : exit
                      (dragondos_mmc.asm):01741                 
C797 10AE84           (dragondos_mmc.asm):01742                 LDY     ,X                      ; get LSN number from buffer                    
C79A 3122             (dragondos_mmc.asm):01743                 LEAY    2,Y                     ; add 2
C79C 8610             (dragondos_mmc.asm):01744                 LDA     #DIRSecCount            ; set number of sectors to scan
C79E B70660           (dragondos_mmc.asm):01745                 STA     DosCurCount
                      (dragondos_mmc.asm):01746         
C7A1 10BF065C         (dragondos_mmc.asm):01747         LC8F6   STY     DosLSNCounter           ; save LSN
C7A5 BDD0F2           (dragondos_mmc.asm):01748                 JSR     >DOSFindAndRead         ; go read it
C7A8 26BF             (dragondos_mmc.asm):01749                 BNE     LC8BE                   ; error
                      (dragondos_mmc.asm):01750                 
C7AA AE05             (dragondos_mmc.asm):01751                 LDX     BuffAddr,X              ; get address of data buffer
C7AC 338900FA         (dragondos_mmc.asm):01752                 LEAU    DirLastByte,X           ; point U at first byte after last entry
C7B0 FF065E           (dragondos_mmc.asm):01753                 STU     DosSaveBuffAddr         ; save buff addr
                      (dragondos_mmc.asm):01754         
C7B3 A684             (dragondos_mmc.asm):01755         LC908   LDA     ,X                      ; get first data byte (attribute)
C7B5 8581             (dragondos_mmc.asm):01756                 BITA    #(AttrDeleted+AttrIsCont) ; is this a deleted or continuation entry ?   
C7B7 261A             (dragondos_mmc.asm):01757                 BNE     LC928
                      (dragondos_mmc.asm):01758         
C7B9 FC0650           (dragondos_mmc.asm):01759                 LDD     DosCurFilename          ; get first 2 characters of filename
C7BC 10A301           (dragondos_mmc.asm):01760                 CMPD    DirEntFilename,X        ; compare to directory entry
C7BF 2612             (dragondos_mmc.asm):01761                 BNE     LC928                   ; not the same, skip to next
                      (dragondos_mmc.asm):01762         
C7C1 CE0652           (dragondos_mmc.asm):01763                 LDU     #DosCurFilename+2       ; check the rest of the name
C7C4 3103             (dragondos_mmc.asm):01764                 LEAY    DirEntFilename+2,X      ; point to name[2] in entry             
C7C6 C609             (dragondos_mmc.asm):01765                 LDB     #$09                    ; check 9 characters, 6 left from name + 3 from extension
C7C8 A6C0             (dragondos_mmc.asm):01766         LC91D   LDA     ,U+                     ; get character from name
C7CA A1A0             (dragondos_mmc.asm):01767                 CMPA    ,Y+                     ; compare to dir entry
C7CC 2605             (dragondos_mmc.asm):01768                 BNE     LC928                   ; not equal : give up
                      (dragondos_mmc.asm):01769                 
C7CE 5A               (dragondos_mmc.asm):01770                 DECB                            ; decrement character count
C7CF 26F7             (dragondos_mmc.asm):01771                 BNE     LC91D                   ; keep going if more to compare
                      (dragondos_mmc.asm):01772                 
C7D1 202C             (dragondos_mmc.asm):01773                 BRA     LC954                   ; if we get here then we have a match
                      (dragondos_mmc.asm):01774         
C7D3 A684             (dragondos_mmc.asm):01775         LC928   LDA     ,X                      ; get first data byte (attribute)
C7D5 8508             (dragondos_mmc.asm):01776                 BITA    #AttrEndOfDir           ; end of directory ?
C7D7 2616             (dragondos_mmc.asm):01777                 BNE     LC944                   ; yep 
                      (dragondos_mmc.asm):01778                 
C7D9 7C0681           (dragondos_mmc.asm):01779                 INC     DosTempFileNo           ; Move to next fileno
C7DC 308819           (dragondos_mmc.asm):01780                 LEAX    DirEntryLen,X           ; move to next dir entry in sector
C7DF BC065E           (dragondos_mmc.asm):01781                 CMPX    DosSaveBuffAddr         ; beyond last entry ?
C7E2 25CF             (dragondos_mmc.asm):01782                 BCS     LC908                   ; nope process next entry
                      (dragondos_mmc.asm):01783                 
C7E4 10BE065C         (dragondos_mmc.asm):01784                 LDY     DosLSNCounter           ; get current DIR LSN
C7E8 3121             (dragondos_mmc.asm):01785                 LEAY    1,Y                     ; increment it
C7EA 7A0660           (dragondos_mmc.asm):01786                 DEC     DosCurCount             ; decrement directory sector count
C7ED 26B2             (dragondos_mmc.asm):01787                 BNE     LC8F6                   ; if any left loop again
                      (dragondos_mmc.asm):01788                 
C7EF BDCD57           (dragondos_mmc.asm):01789         LC944   JSR     >DosFCBNoToAddr         ; get FCB address
C7F2 5F               (dragondos_mmc.asm):01790         LC947   CLRB
C7F3 6D0F             (dragondos_mmc.asm):01791                 TST     FCBDirFlags,X           ; check flags
C7F5 2A02             (dragondos_mmc.asm):01792                 BPL     LC94E                   ; not a deleted file
                      (dragondos_mmc.asm):01793                 
C7F7 C6A0             (dragondos_mmc.asm):01794                 LDB     #ErrNE                  ; flag file does not exist
C7F9 300C             (dragondos_mmc.asm):01795         LC94E   LEAX    FCBFilePointer,X        ; point to file pointer !!!
C7FB 96F1             (dragondos_mmc.asm):01796                 LDA     <DosCurrCtrlBlk
C7FD 5D               (dragondos_mmc.asm):01797                 TSTB                            ; set CC.Z on error
C7FE 39               (dragondos_mmc.asm):01798                 RTS
                      (dragondos_mmc.asm):01799         
C7FF 3410             (dragondos_mmc.asm):01800         LC954   PSHS    X                       ; save dir entry pointer
C801 BDCD57           (dragondos_mmc.asm):01801                 JSR     >DosFCBNoToAddr         ; get FCB address
C804 3520             (dragondos_mmc.asm):01802                 PULS    Y                       ; recover dir entry pointer
C806 B60681           (dragondos_mmc.asm):01803                 LDA     DosTempFileNo           ; get file no
                      (dragondos_mmc.asm):01804                 
                      (dragondos_mmc.asm):01805         ; Fill in FCB
                      (dragondos_mmc.asm):01806         
C809 A7881D           (dragondos_mmc.asm):01807                 STA     FCBDiskFileNo,X         ; fill in fileno
C80C A6A4             (dragondos_mmc.asm):01808                 LDA     ,Y
C80E A70F             (dragondos_mmc.asm):01809                 STA     FCBDirFlags,X           ; attribute
                      (dragondos_mmc.asm):01810                 
C810 EC2C             (dragondos_mmc.asm):01811                 LDD     DirEntFnBlock1,Y
C812 ED8815           (dragondos_mmc.asm):01812                 STD     FCBLSNExtent1,X         ; LSN of extent 1
                      (dragondos_mmc.asm):01813                 
C815 A62E             (dragondos_mmc.asm):01814                 LDA     DirEntFnBlock1+2,Y
C817 A78817           (dragondos_mmc.asm):01815                 STA     FCBSecExtent1,X         ; sector count of extent 1
C81A A78819           (dragondos_mmc.asm):01816                 STA     FCBFSNExtent2+1,X
                      (dragondos_mmc.asm):01817                 
C81D 6F8818           (dragondos_mmc.asm):01818                 CLR     FCBFSNExtent2,X
C820 6F8813           (dragondos_mmc.asm):01819                 CLR     FCBFSNExtent1,X         ; Clear FSN 
C823 6F8814           (dragondos_mmc.asm):01820                 CLR     FCBFSNExtent1+1,X
                      (dragondos_mmc.asm):01821                 
C826 EC2F             (dragondos_mmc.asm):01822                 LDD     DirEntFnBlock2,Y        ; LSN of extent 2
C828 ED881A           (dragondos_mmc.asm):01823                 STD     FCBLSNExtent2,X
                      (dragondos_mmc.asm):01824                 
C82B A6A811           (dragondos_mmc.asm):01825                 LDA     DirEntFnBlock2+2,Y      ; sector count of extent 2
C82E A7881C           (dragondos_mmc.asm):01826                 STA     FCBSecExtent2,X
                      (dragondos_mmc.asm):01827                 
C831 CCFFFF           (dragondos_mmc.asm):01828                 LDD     #$FFFF                  ; set file len to -1
C834 ED8810           (dragondos_mmc.asm):01829                 STD     FCBFileLen,X            
C837 A78812           (dragondos_mmc.asm):01830                 STA     FCBFileLen+2,X
C83A 20B6             (dragondos_mmc.asm):01831                 BRA     LC947
                      (dragondos_mmc.asm):01832         
                      (dragondos_mmc.asm):01833         ;
                      (dragondos_mmc.asm):01834         ; Read from a file.
                      (dragondos_mmc.asm):01835         ;
                      (dragondos_mmc.asm):01836         ; Entry :
                      (dragondos_mmc.asm):01837         ;       A = FCB no
                      (dragondos_mmc.asm):01838         ;       X = pointer to buffer to receive data
                      (dragondos_mmc.asm):01839         ;       Y = no of bytes to read
                      (dragondos_mmc.asm):01840         ;       U = MSW of file offset (FSN sector no).
                      (dragondos_mmc.asm):01841         ;       B = LSB of file offset (byte within sector).
                      (dragondos_mmc.asm):01842         ;               U:B is effectivly the filepointer.
                      (dragondos_mmc.asm):01843         ; Exit:
                      (dragondos_mmc.asm):01844         ;       B = Error code
                      (dragondos_mmc.asm):01845         ;       X = no of bytes *NOT* read if error = EOF
                      (dragondos_mmc.asm):01846         ;
                      (dragondos_mmc.asm):01847         ; Secondary entry points :
                      (dragondos_mmc.asm):01848         ;       RWrite  called by DOSFWrite
                      (dragondos_mmc.asm):01849         ;       Verify  called by DOSFWrite
                      (dragondos_mmc.asm):01850         ;
                      (dragondos_mmc.asm):01851         
C83C                  (dragondos_mmc.asm):01852         DOSFRead   
C83C 0FF5             (dragondos_mmc.asm):01853                 CLR     <DosRWFlag              ; Flag this is a read
C83E 97F1             (dragondos_mmc.asm):01854                 STA     <DosCurrCtrlBlk         ; set control block
C840 2007             (dragondos_mmc.asm):01855                 BRA     LC99E                   ; skip ahead
                      (dragondos_mmc.asm):01856         
C842                  (dragondos_mmc.asm):01857         RWrite   
C842 8601             (dragondos_mmc.asm):01858                 LDA     #FileOpWrite            ; Flag this is a write
C844 8C               (dragondos_mmc.asm):01859                 FCB     CSkip2
                      (dragondos_mmc.asm):01860         
C845                  (dragondos_mmc.asm):01861         Verify   
C845 86FF             (dragondos_mmc.asm):01862                 LDA     #FileOpVerify           ; Flag this is a verify
C847 97F5             (dragondos_mmc.asm):01863                 STA     <DosRWFlag
                      (dragondos_mmc.asm):01864                 
C849 10BF0661         (dragondos_mmc.asm):01865         LC99E   STY     DosBytesRead            ; save byte count
C84D 102700E3         (dragondos_mmc.asm):01866                 LBEQ    DosFReadExit            ; no bytes : exit
                      (dragondos_mmc.asm):01867                 
C851 FF0669           (dragondos_mmc.asm):01868                 STU     DosCurrSector           ; save file pointer
C854 F70663           (dragondos_mmc.asm):01869                 STB     DosSecOffset
C857 3410             (dragondos_mmc.asm):01870                 PSHS    X                       ; save buffer pointer
                      (dragondos_mmc.asm):01871                 
C859 BDCD57           (dragondos_mmc.asm):01872                 JSR     >DosFCBNoToAddr         ; convert FCB no to address in X
                      (dragondos_mmc.asm):01873                 
C85C A60B             (dragondos_mmc.asm):01874                 LDA     FCBDrive,X              ; get drive number
C85E 97EB             (dragondos_mmc.asm):01875                 STA     <DosDriveNo
                      (dragondos_mmc.asm):01876                 
C860 0DF5             (dragondos_mmc.asm):01877                 TST     <DosRWFlag              ; Is this a read or write ?
C862 260B             (dragondos_mmc.asm):01878                 BNE     LC9C4                   ; if write skip on
                      (dragondos_mmc.asm):01879                 
C864 FC0661           (dragondos_mmc.asm):01880                 LDD     DosBytesRead            ; get bytes read so far
C867 E30D             (dragondos_mmc.asm):01881                 ADDD    FCBFilePointer+1,X      ; add LSW of fileptr
C869 2402             (dragondos_mmc.asm):01882                 BCC     LC9C2                   ; any carry ?
                      (dragondos_mmc.asm):01883                 
C86B 6C0C             (dragondos_mmc.asm):01884                 INC     FCBFilePointer,X        ; carry to MSB
C86D ED0D             (dragondos_mmc.asm):01885         LC9C2   STD     FCBFilePointer+1,X      ; update fileptr
                      (dragondos_mmc.asm):01886         
C86F 3510             (dragondos_mmc.asm):01887         LC9C4   PULS    X                       ; recover data buffer ptr       
                      (dragondos_mmc.asm):01888         
C871 F60663           (dragondos_mmc.asm):01889                 LDB     DosSecOffset            ; get offset into last sector
C874 4F               (dragondos_mmc.asm):01890         LC9C9   CLRA            
C875 50               (dragondos_mmc.asm):01891                 NEGB                            ; distance to end of sector             
C876 2601             (dragondos_mmc.asm):01892                 BNE     LC9CE                   ; not zero, skip
                      (dragondos_mmc.asm):01893                 
C878 4C               (dragondos_mmc.asm):01894                 INCA                            ; increment MSB
C879 10B30661         (dragondos_mmc.asm):01895         LC9CE   CMPD    DosBytesRead            ; read all bytes yet ?
C87D 2303             (dragondos_mmc.asm):01896                 BLS     LC9D7                   ; nope 
                      (dragondos_mmc.asm):01897                 
C87F FC0661           (dragondos_mmc.asm):01898                 LDD     DosBytesRead            ; get bytes read
C882 3416             (dragondos_mmc.asm):01899         LC9D7   PSHS    D,X                     ; save 
C884 FE0669           (dragondos_mmc.asm):01900                 LDU     DosCurrSector           ; get current FSN
C887 BDC936           (dragondos_mmc.asm):01901                 JSR     >FSNtoLSN               ; convert to LSN
C88A 260E             (dragondos_mmc.asm):01902                 BNE     DosFReadErrorExit                       ; error, tydy up stack and return
                      (dragondos_mmc.asm):01903                 
C88C 1F02             (dragondos_mmc.asm):01904                 TFR     D,Y                     ; transfer LSN to Y     
                      (dragondos_mmc.asm):01905                 
C88E A60F             (dragondos_mmc.asm):01906                 LDA     FCBDirFlags,X           ; get directory flags from FIB
C890 8502             (dragondos_mmc.asm):01907                 BITA    #AttrWriteProt          ; is the file protected?
C892 2709             (dragondos_mmc.asm):01908                 BEQ     LC9F2                   ; no skip
                      (dragondos_mmc.asm):01909                 
C894 0DF5             (dragondos_mmc.asm):01910                 TST     <DosRWFlag              ; are we reading or writing?
C896 2705             (dragondos_mmc.asm):01911                 BEQ     LC9F2                   ; writing, and protected!
C898 C698             (dragondos_mmc.asm):01912                 LDB     #ErrPT                  ; protected error
C89A                  (dragondos_mmc.asm):01913         DosFReadErrorExit   
C89A 3264             (dragondos_mmc.asm):01914                 LEAS    4,S                     ; clean up stack
C89C 39               (dragondos_mmc.asm):01915                 RTS                             ; return
                      (dragondos_mmc.asm):01916         
C89D AE62             (dragondos_mmc.asm):01917         LC9F2   LDX     2,S                     ; get pointer to buffer                 
C89F 6D61             (dragondos_mmc.asm):01918                 TST     1,S                     ; test MSB of length
C8A1 262A             (dragondos_mmc.asm):01919                 BNE     LCA22                   ; skip ahead if nonzero
                      (dragondos_mmc.asm):01920                 
C8A3 0DF5             (dragondos_mmc.asm):01921                 TST     <DosRWFlag              ; are we reading or writing?
C8A5 2707             (dragondos_mmc.asm):01922                 BEQ     LCA03                   ; reading, do it
                      (dragondos_mmc.asm):01923                 
C8A7 2A0A             (dragondos_mmc.asm):01924                 BPL     LCA08                   ; writing, do it
C8A9 BDD1AE           (dragondos_mmc.asm):01925                 JSR     >DosVerifyAbsSector     ; else go verify it
C8AC 2008             (dragondos_mmc.asm):01926                 BRA     LCA0B                   ; skip on
                      (dragondos_mmc.asm):01927         
C8AE BDD1B5           (dragondos_mmc.asm):01928         LCA03   JSR     >DOSReadAbsSector       ; read the sector
C8B1 2003             (dragondos_mmc.asm):01929                 BRA     LCA0B                   ; skip on
                      (dragondos_mmc.asm):01930         
C8B3 BDD1A5           (dragondos_mmc.asm):01931         LCA08   JSR     >DOSWriteAbsSector      ; write the sector
C8B6 26E2             (dragondos_mmc.asm):01932         LCA0B   BNE     DosFReadErrorExit               ; error clean up stack and exit
                      (dragondos_mmc.asm):01933         
C8B8 6C62             (dragondos_mmc.asm):01934                 INC     2,S                     ; increment MSB of buffer
C8BA BE0669           (dragondos_mmc.asm):01935                 LDX     DosCurrSector           ; increment current sector
C8BD 3001             (dragondos_mmc.asm):01936                 LEAX    1,X
C8BF BF0669           (dragondos_mmc.asm):01937                 STX     DosCurrSector           ; and save it back
C8C2 7A0661           (dragondos_mmc.asm):01938                 DEC     DosBytesRead            ; decrement MSB of length
C8C5 FC0661           (dragondos_mmc.asm):01939                 LDD     DosBytesRead            ; get length
C8C8 3516             (dragondos_mmc.asm):01940                 PULS    D,X                     ; restore length & pointer (flags unchanged)
C8CA 26A8             (dragondos_mmc.asm):01941                 BNE     LC9C9                   ; keep going if more to do      
C8CC 39               (dragondos_mmc.asm):01942                 RTS                             ; otherwise return to caller
                      (dragondos_mmc.asm):01943         
C8CD 0DF5             (dragondos_mmc.asm):01944         LCA22   TST     <DosRWFlag              ; skip this part on verify
C8CF 2B46             (dragondos_mmc.asm):01945                 BMI     RWNext                  
                      (dragondos_mmc.asm):01946                 
C8D1 BDD0F2           (dragondos_mmc.asm):01947                 JSR     >DOSFindAndRead         ; read next sector to buffer
C8D4 26C4             (dragondos_mmc.asm):01948                 BNE     DosFReadErrorExit       ; error, exit
                      (dragondos_mmc.asm):01949                 
C8D6 BF0667           (dragondos_mmc.asm):01950                 STX     DosPageBufAddr          ; save page buffer pointer
C8D9 10AE62           (dragondos_mmc.asm):01951                 LDY     2,S                     ; get user buffer ptr
C8DC F60663           (dragondos_mmc.asm):01952                 LDB     DosSecOffset            ; get offset into the sector 
C8DF 0DF5             (dragondos_mmc.asm):01953                 TST     <DosRWFlag              ; reading or writing?
C8E1 2728             (dragondos_mmc.asm):01954                 BEQ     LCA60                   ; branch if reading
                      (dragondos_mmc.asm):01955         
                      (dragondos_mmc.asm):01956         ; This code is used if we are writing   
C8E3 86FF             (dragondos_mmc.asm):01957                 LDA     #BuffDirty              ; mark buffer dirty                                     
C8E5 A702             (dragondos_mmc.asm):01958                 STA     BuffFlag,X
C8E7 AE05             (dragondos_mmc.asm):01959                 LDX     BuffAddr,X              ; get address of data in buffer 
C8E9 3A               (dragondos_mmc.asm):01960                 ABX                             ; add offset within sector
                      (dragondos_mmc.asm):01961                 
C8EA 1F10             (dragondos_mmc.asm):01962                 TFR     X,D                     ; Deleted from DDv2 as redundent
C8EC 5A               (dragondos_mmc.asm):01963                 DECB                            ; Deleted from DDv2 as redundent
C8ED 2400             (dragondos_mmc.asm):01964                 BCC     LCA44                   ; Deleted from DDv2 as redundent
                      (dragondos_mmc.asm):01965                 
C8EF E661             (dragondos_mmc.asm):01966         LCA44   LDB     1,S                     ; get byte count
C8F1 A6A0             (dragondos_mmc.asm):01967         LCA46   LDA     ,Y+                     ; get data from user's buffer
C8F3 A780             (dragondos_mmc.asm):01968                 STA     ,X+                     ; put in disk read buffer
C8F5 5A               (dragondos_mmc.asm):01969                 DECB                            ; decrement count
C8F6 26F9             (dragondos_mmc.asm):01970                 BNE     LCA46                   ; keep going until all done
                      (dragondos_mmc.asm):01971                 
C8F8 1F10             (dragondos_mmc.asm):01972                 TFR     X,D                     ; get disk buffer pointer into d
C8FA 5D               (dragondos_mmc.asm):01973                 TSTB                            ; reached end of buffer?
C8FB 261A             (dragondos_mmc.asm):01974                 BNE     RWNext                  ; nope
                      (dragondos_mmc.asm):01975                 
C8FD BE0667           (dragondos_mmc.asm):01976                 LDX     DosPageBufAddr          ; get Page buffer address in X
C900 3420             (dragondos_mmc.asm):01977                 PSHS    Y                       ; save Y
C902 BDD15F           (dragondos_mmc.asm):01978                 JSR     >TestAndFlushBuffer     ; flush the buffer to disk
C905 3520             (dragondos_mmc.asm):01979                 PULS    Y                       ; restore Y
C907 2691             (dragondos_mmc.asm):01980                 BNE     DosFReadErrorExit       ; error, exit
C909 200C             (dragondos_mmc.asm):01981                 BRA     RWNext                  ; keep going
                      (dragondos_mmc.asm):01982         
                      (dragondos_mmc.asm):01983         ; this code is used if we are reading
C90B AE05             (dragondos_mmc.asm):01984         LCA60   LDX     BuffAddr,X              ; get address of data in buffer 
C90D 3A               (dragondos_mmc.asm):01985                 ABX                             ; add offset within buffer
C90E E661             (dragondos_mmc.asm):01986                 LDB     1,S                     ; lsb of length of data
C910 A680             (dragondos_mmc.asm):01987         LCA65   LDA     ,X+                     ; fetch a byte from disk buffer
C912 A7A0             (dragondos_mmc.asm):01988                 STA     ,Y+                     ; write a byte to user's buffer
C914 5A               (dragondos_mmc.asm):01989                 DECB                            ; decrement byte count
C915 26F9             (dragondos_mmc.asm):01990                 BNE     LCA65                   ; keep going until all done
                      (dragondos_mmc.asm):01991         
                      (dragondos_mmc.asm):01992         ; read / write next sector
C917 BE0669           (dragondos_mmc.asm):01993         RWNext  LDX     DosCurrSector           ; move to the next LSN
C91A 3001             (dragondos_mmc.asm):01994                 LEAX    1,X
C91C BF0669           (dragondos_mmc.asm):01995                 STX     DosCurrSector           ; save it back
C91F 1F21             (dragondos_mmc.asm):01996                 TFR     Y,X                     ; user's buffer to X    
C921 FC0661           (dragondos_mmc.asm):01997                 LDD     DosBytesRead            ; get bytes read
C924 A3E1             (dragondos_mmc.asm):01998                 SUBD    ,S++                    ; subtract bytes transferred
C926 FD0661           (dragondos_mmc.asm):01999                 STD     DosBytesRead            ; save it back
C929 3262             (dragondos_mmc.asm):02000                 LEAS    2,S                     ; drop pointer from stack
C92B 2707             (dragondos_mmc.asm):02001                 BEQ     DosFReadExit            ; branch if done all
C92D 7F0663           (dragondos_mmc.asm):02002                 CLR     DosSecOffset            ; clear sector offset, so we start 
C930 5F               (dragondos_mmc.asm):02003                 CLRB                            ; at beginning of next sector
C931 7EC874           (dragondos_mmc.asm):02004                 JMP     >LC9C9                  ; loop again
                      (dragondos_mmc.asm):02005         
C934                  (dragondos_mmc.asm):02006         DosFReadExit   
C934 5F               (dragondos_mmc.asm):02007                 CLRB                            ; no error
C935 39               (dragondos_mmc.asm):02008                 RTS
                      (dragondos_mmc.asm):02009         
                      (dragondos_mmc.asm):02010         ; 
                      (dragondos_mmc.asm):02011         ; Convert a file sector number to a logical sector number.
                      (dragondos_mmc.asm):02012         ;
                      (dragondos_mmc.asm):02013         ; On entry 
                      (dragondos_mmc.asm):02014         ;  U                    FSN that we want
                      (dragondos_mmc.asm):02015         ;  DosCurrCtrlBlk       Current FIB no.
                      (dragondos_mmc.asm):02016         ;
                      (dragondos_mmc.asm):02017         ; Returns:
                      (dragondos_mmc.asm):02018         ;  D                    Logical sector number
                      (dragondos_mmc.asm):02019         ;  X                    FIB entry
                      (dragondos_mmc.asm):02020         ;  U                    FSN (preserved).
                      (dragondos_mmc.asm):02021         
C936                  (dragondos_mmc.asm):02022         FSNtoLSN 
C936 BDCD57           (dragondos_mmc.asm):02023                 JSR     >DosFCBNoToAddr         ; get FCB addr in X
C939 1F30             (dragondos_mmc.asm):02024         LCA8E   TFR     U,D                     ; get FSN in D
C93B A38813           (dragondos_mmc.asm):02025                 SUBD    FCBFSNExtent1,X         ; test to see where extent block is in file
C93E 250D             (dragondos_mmc.asm):02026                 BCS     LCAA2                   ; if -ve then this block is after the one we want
                      (dragondos_mmc.asm):02027         
                      (dragondos_mmc.asm):02028         ; check to see if required sector is within this group of sectors
                      (dragondos_mmc.asm):02029         
C940 4D               (dragondos_mmc.asm):02030                 TSTA                            ; If MSB is not 0 then it is not
C941 260A             (dragondos_mmc.asm):02031                 BNE     LCAA2                   
                      (dragondos_mmc.asm):02032                 
C943 E18817           (dragondos_mmc.asm):02033                 CMPB    FCBSecExtent1,X         
C946 2405             (dragondos_mmc.asm):02034                 BCC     LCAA2
                      (dragondos_mmc.asm):02035         
C948 E38815           (dragondos_mmc.asm):02036                 ADDD    FCBLSNExtent1,X
C94B 2012             (dragondos_mmc.asm):02037                 BRA     LCAB4
                      (dragondos_mmc.asm):02038         
                      (dragondos_mmc.asm):02039         ; check extent 2
                      (dragondos_mmc.asm):02040         
C94D 1F30             (dragondos_mmc.asm):02041         LCAA2   TFR     U,D                     ; get FSN in D
C94F A38818           (dragondos_mmc.asm):02042                 SUBD    FCBFSNExtent2,X         ; test to see where extent block is in file
C952 250E             (dragondos_mmc.asm):02043                 BCS     LCAB7                   ; if -ve then this block is after the one we want
                      (dragondos_mmc.asm):02044           
                      (dragondos_mmc.asm):02045         ; check to see if required sector is within this group of sectors
                      (dragondos_mmc.asm):02046         
C954 4D               (dragondos_mmc.asm):02047                 TSTA                            ; If MSB is not 0 then it is not
C955 260B             (dragondos_mmc.asm):02048                 BNE     LCAB7
                      (dragondos_mmc.asm):02049           
C957 E1881C           (dragondos_mmc.asm):02050                 CMPB    FCBSecExtent2,X
C95A 2406             (dragondos_mmc.asm):02051                 BCC     LCAB7
                      (dragondos_mmc.asm):02052                 
C95C E3881A           (dragondos_mmc.asm):02053                 ADDD    FCBLSNExtent2,X
                      (dragondos_mmc.asm):02054         
C95F 1A04             (dragondos_mmc.asm):02055         LCAB4   ORCC    #FlagZero               ; Found the block we want flag it
C961 39               (dragondos_mmc.asm):02056                 RTS
                      (dragondos_mmc.asm):02057         
                      (dragondos_mmc.asm):02058         ; Wanted FSN not in extent 1 or 2
                      (dragondos_mmc.asm):02059         
C962 3440             (dragondos_mmc.asm):02060         LCAB7   PSHS    U                       ; save FSN
C964 8D3E             (dragondos_mmc.asm):02061                 BSR     FindFSNinU              ; scan extents
C966 260B             (dragondos_mmc.asm):02062                 BNE     LCAC8                   ; error exit
                      (dragondos_mmc.asm):02063                 
C968 FC066B           (dragondos_mmc.asm):02064                 LDD     DosTotalSFound          ; how many scanned?
C96B 10B3066D         (dragondos_mmc.asm):02065                 CMPD    DosFSNToFind            ; Have we found it?
C96F 2204             (dragondos_mmc.asm):02066                 BHI     LCACA                   ; branch if so
                      (dragondos_mmc.asm):02067                 
C971 C69A             (dragondos_mmc.asm):02068                 LDB     #ErrPE          ; else past EOF error
C973 35C0             (dragondos_mmc.asm):02069         LCAC8   PULS    U,PC                    ; restore & return
                      (dragondos_mmc.asm):02070         
                      (dragondos_mmc.asm):02071         ; At this point Y points to allocation extent block in directory entry.
                      (dragondos_mmc.asm):02072         
C975 E022             (dragondos_mmc.asm):02073         LCACA   SUBB    AllocCount,Y            ; length of extent
C977 8200             (dragondos_mmc.asm):02074                 SBCA    #$00                    ; propogate carry       
C979 ED8813           (dragondos_mmc.asm):02075                 STD     FCBFSNExtent1,X         ; start of this extent
                      (dragondos_mmc.asm):02076                 
C97C A622             (dragondos_mmc.asm):02077                 LDA     AllocCount,Y            ; get allocation sector count
C97E A78817           (dragondos_mmc.asm):02078                 STA     FCBSecExtent1,X         ; save it in extent
C981 ECA4             (dragondos_mmc.asm):02079                 LDD     ,Y                      ; get allocation LSN
C983 ED8815           (dragondos_mmc.asm):02080                 STD     FCBLSNExtent1,X         ; save in extent
                      (dragondos_mmc.asm):02081                 
C986 1F20             (dragondos_mmc.asm):02082                 TFR     Y,D                     ; transfer start LSN to D
C988 3440             (dragondos_mmc.asm):02083                 PSHS    U                       ; save FSN
C98A A3E1             (dragondos_mmc.asm):02084                 SUBD    ,S++                    ; subtract from LSN
C98C 3540             (dragondos_mmc.asm):02085                 PULS    U                       ; restore FSN
                      (dragondos_mmc.asm):02086                 
C98E C113             (dragondos_mmc.asm):02087                 CMPB    #DirEntryLen-6          ; end of entry?
C990 2410             (dragondos_mmc.asm):02088                 BCC     LCAF7                   ; yep, no more extents
                      (dragondos_mmc.asm):02089                 
C992 A625             (dragondos_mmc.asm):02090                 LDA     5,Y                     ; length of next extent
C994 A7881C           (dragondos_mmc.asm):02091                 STA     FCBSecExtent2,X
C997 EC23             (dragondos_mmc.asm):02092                 LDD     3,Y                     ; LSN of next extent
C999 ED881A           (dragondos_mmc.asm):02093                 STD     $1A,X
C99C FC066B           (dragondos_mmc.asm):02094                 LDD     DosTotalSFound
C99F ED8818           (dragondos_mmc.asm):02095                 STD     FCBFSNExtent2,X
C9A2 2095             (dragondos_mmc.asm):02096         LCAF7   BRA     LCA8E                   ; loop again
                      (dragondos_mmc.asm):02097         
                      (dragondos_mmc.asm):02098         ;
                      (dragondos_mmc.asm):02099         ; Scan extents
                      (dragondos_mmc.asm):02100         ;
                      (dragondos_mmc.asm):02101         ; Entry : 
                      (dragondos_mmc.asm):02102         ;       X       Address of a FCB
                      (dragondos_mmc.asm):02103         ;       U       FSN to find (File Sector Number)
                      (dragondos_mmc.asm):02104         ;       B       File number (on disk), also in $1d,X
                      (dragondos_mmc.asm):02105         ;
                      (dragondos_mmc.asm):02106         ; Returns with:
                      (dragondos_mmc.asm):02107         ;       DosTotalSFound  number of sectors scanned
                      (dragondos_mmc.asm):02108         ;       DosFSNToFind    Original U 
                      (dragondos_mmc.asm):02109         ;       Y               Extent entry in dir sector.
                      (dragondos_mmc.asm):02110         ;
                      (dragondos_mmc.asm):02111         
C9A4                  (dragondos_mmc.asm):02112         FindFSNinU   
C9A4 3410             (dragondos_mmc.asm):02113                 PSHS    X                       
C9A6 7F066C           (dragondos_mmc.asm):02114                 CLR     DosTotalSFound+1
C9A9 7F066B           (dragondos_mmc.asm):02115                 CLR     DosTotalSFound
C9AC FF066D           (dragondos_mmc.asm):02116                 STU     DosFSNToFind            ; set FSN to find 
C9AF E6881D           (dragondos_mmc.asm):02117                 LDB     FCBDiskFileNo,X         ; set current file to be FCB file
C9B2 F70682           (dragondos_mmc.asm):02118                 STB     DosCurFileNo
C9B5 BDD07F           (dragondos_mmc.asm):02119                 JSR     >DOSGetDirEntry         ; Go get directory entry
C9B8 2647             (dragondos_mmc.asm):02120                 BNE     LCB56                   ; Error : exit
                      (dragondos_mmc.asm):02121                 
C9BA 1F13             (dragondos_mmc.asm):02122                 TFR     X,U                     ; point u at dir entry
C9BC 3510             (dragondos_mmc.asm):02123                 PULS    X                       ; recover FCB pointer
                      (dragondos_mmc.asm):02124                 
C9BE 314C             (dragondos_mmc.asm):02125                 LEAY    DirEntFnBlock1,U        ; point Y at first allocation block
C9C0 C604             (dragondos_mmc.asm):02126                 LDB     #$04                    ; entry counter
C9C2 A6C4             (dragondos_mmc.asm):02127         LCB17   LDA     ,U                      ; get attributes 
C9C4 8420             (dragondos_mmc.asm):02128                 ANDA    #AttrContinued          ; extract continuation flag     
C9C6 2703             (dragondos_mmc.asm):02129                 BEQ     LCB20                   ; not a continuation block, skip
                      (dragondos_mmc.asm):02130                 
C9C8 A6C818           (dragondos_mmc.asm):02131                 LDA     DirEntFlag,U            ; get dir entry flag
                      (dragondos_mmc.asm):02132         
C9CB 3406             (dragondos_mmc.asm):02133         LCB20   PSHS    D
C9CD FC066B           (dragondos_mmc.asm):02134         LCB22   LDD     DosTotalSFound          ; get total sectors found so far
C9D0 EB22             (dragondos_mmc.asm):02135                 ADDB    2,Y                     ; add sector count for this allocation block to total
C9D2 8900             (dragondos_mmc.asm):02136                 ADCA    #$00                    ; carry from b to a if neeeded
C9D4 FD066B           (dragondos_mmc.asm):02137                 STD     DosTotalSFound          ; update total found
C9D7 10B3066D         (dragondos_mmc.asm):02138                 CMPD    DosFSNToFind            ; found the sector we need yet ?
C9DB 2223             (dragondos_mmc.asm):02139                 BHI     LCB55                   ; yep : exit
                      (dragondos_mmc.asm):02140                 
C9DD 3123             (dragondos_mmc.asm):02141                 LEAY    AllocEntrySize,Y        ; move to next allocation entry                 
C9DF 6A61             (dragondos_mmc.asm):02142                 DEC     1,S                     ; decrement entry counter
C9E1 26EA             (dragondos_mmc.asm):02143                 BNE     LCB22                   ; if more to do loop again
                      (dragondos_mmc.asm):02144         
C9E3 E6E4             (dragondos_mmc.asm):02145                 LDB     ,S                      ; recover DirEntFlag or AttrContinued   
C9E5 2717             (dragondos_mmc.asm):02146                 BEQ     LCB53                   ; if it's 0
                      (dragondos_mmc.asm):02147                 
C9E7 3262             (dragondos_mmc.asm):02148                 LEAS    2,S                     ; drop stack frame
C9E9 F70682           (dragondos_mmc.asm):02149                 STB     DosCurFileNo            
                      (dragondos_mmc.asm):02150         
C9EC 3410             (dragondos_mmc.asm):02151                 PSHS    X                       ; save FCB pointer      
C9EE BDD07F           (dragondos_mmc.asm):02152                 JSR     >DOSGetDirEntry         ; get next entry
C9F1 1F13             (dragondos_mmc.asm):02153                 TFR     X,U                     ; make u point to dir entry
C9F3 3510             (dragondos_mmc.asm):02154                 PULS    X                       ; recover FCB pointer
C9F5 2701             (dragondos_mmc.asm):02155                 BEQ     LCB4D
                      (dragondos_mmc.asm):02156         
C9F7 39               (dragondos_mmc.asm):02157                 RTS
                      (dragondos_mmc.asm):02158         
C9F8 3141             (dragondos_mmc.asm):02159         LCB4D   LEAY    DirEntCntBlock1,U       ; point at first extension entry                        
C9FA C607             (dragondos_mmc.asm):02160                 LDB     #$07                    ; 7 entries in a continuation block
C9FC 20C4             (dragondos_mmc.asm):02161                 BRA     LCB17
                      (dragondos_mmc.asm):02162         
C9FE 313D             (dragondos_mmc.asm):02163         LCB53   LEAY    -3,Y
CA00 5F               (dragondos_mmc.asm):02164         LCB55   CLRB                            ; flag no error
CA01 3262             (dragondos_mmc.asm):02165         LCB56   LEAS    2,S                     ; Drop stack frame
CA03 39               (dragondos_mmc.asm):02166                 RTS                             ; Return
                      (dragondos_mmc.asm):02167         
                      (dragondos_mmc.asm):02168         ;
                      (dragondos_mmc.asm):02169         ; Write to a file.
                      (dragondos_mmc.asm):02170         ;
                      (dragondos_mmc.asm):02171         ; Entry :
                      (dragondos_mmc.asm):02172         ;       A = FCB no
                      (dragondos_mmc.asm):02173         ;       X = pointer to buffer to receive data
                      (dragondos_mmc.asm):02174         ;       U = no of bytes to read
                      (dragondos_mmc.asm):02175         ;       Y = MSW of file offset (FSN sector no).
                      (dragondos_mmc.asm):02176         ;       B = LSB of file offset (byte within sector).
                      (dragondos_mmc.asm):02177         ;               Y:B is effectivly the filepointer.
                      (dragondos_mmc.asm):02178         ; Exit:
                      (dragondos_mmc.asm):02179         ;       B = Error code
                      (dragondos_mmc.asm):02180         ;
                      (dragondos_mmc.asm):02181         
CA04                  (dragondos_mmc.asm):02182         DOSFWrite   
CA04 97F1             (dragondos_mmc.asm):02183                 STA     <DosCurrCtrlBlk         ; Set FCB to be current
CA06 BF0671           (dragondos_mmc.asm):02184                 STX     DosFWBufPtr             ; save params for later
CA09 FF0673           (dragondos_mmc.asm):02185                 STU     DosFWByteCount
CA0C 10BF0675         (dragondos_mmc.asm):02186                 STY     DosFWFPoint
CA10 F70677           (dragondos_mmc.asm):02187                 STB     DosFWFPoint+2
                      (dragondos_mmc.asm):02188                 
CA13 BDCD57           (dragondos_mmc.asm):02189                 JSR     >DosFCBNoToAddr         ; Get address of FCB
                      (dragondos_mmc.asm):02190         
CA16 E60B             (dragondos_mmc.asm):02191                 LDB     FCBDrive,X              ; set drive from FCB
CA18 D7EB             (dragondos_mmc.asm):02192                 STB     <DosDriveNo
                      (dragondos_mmc.asm):02193                 
CA1A BDCD24           (dragondos_mmc.asm):02194         LCB6F   JSR     >DOSGetFLen             ; get the file length in U:A
CA1D 270E             (dragondos_mmc.asm):02195                 BEQ     LCB82                   ; no error : skip
                      (dragondos_mmc.asm):02196                 
CA1F C19C             (dragondos_mmc.asm):02197                 CMPB    #ErrFF          ; File not found ?
CA21 2701             (dragondos_mmc.asm):02198                 BEQ     LCB79                   ; yep : create the file
CA23 39               (dragondos_mmc.asm):02199         LCB78   RTS
                      (dragondos_mmc.asm):02200         
CA24 96F1             (dragondos_mmc.asm):02201         LCB79   LDA     <DosCurrCtrlBlk         ; Get current FCB
CA26 BDCDBF           (dragondos_mmc.asm):02202                 JSR     >DOSCreateFile          ; Create the file
CA29 26F8             (dragondos_mmc.asm):02203                 BNE     LCB78                   ; error : exit
CA2B 20ED             (dragondos_mmc.asm):02204                 BRA     LCB6F                   ; success : check file length
                      (dragondos_mmc.asm):02205         
                      (dragondos_mmc.asm):02206         ; If we come here we have successfuly got the file len
                      (dragondos_mmc.asm):02207         
CA2D 11B30675         (dragondos_mmc.asm):02208         LCB82   CMPU    DosFWFPoint             ; is file pointer beyond EOF ?  
CA31 220A             (dragondos_mmc.asm):02209                 BHI     LCB92                   ; no : continue
CA33 2505             (dragondos_mmc.asm):02210                 BCS     LCB8F                   ; yes : error
                      (dragondos_mmc.asm):02211                 
CA35 B10677           (dragondos_mmc.asm):02212                 CMPA    DosFWFPoint+2           ; check LSB, if MSW equal
CA38 2403             (dragondos_mmc.asm):02213                 BCC     LCB92                   ; not past end : continue
                      (dragondos_mmc.asm):02214                 
CA3A C69A             (dragondos_mmc.asm):02215         LCB8F   LDB     #ErrPE          ; error : past end
CA3C 39               (dragondos_mmc.asm):02216         LCB91   RTS
                      (dragondos_mmc.asm):02217         
CA3D 3402             (dragondos_mmc.asm):02218         LCB92   PSHS    A                       ; save LSB of length    
CA3F FC0673           (dragondos_mmc.asm):02219                 LDD     DosFWByteCount          ; get no of bytes to write      
CA42 FB0677           (dragondos_mmc.asm):02220                 ADDB    DosFWFPoint+2           ; add current filepointer, 
CA45 B90676           (dragondos_mmc.asm):02221                 ADCA    DosFWFPoint+1
CA48 3404             (dragondos_mmc.asm):02222                 PSHS    B                       ; save LSB of len+FP
CA4A 1F89             (dragondos_mmc.asm):02223                 TFR     A,B                     
CA4C B60675           (dragondos_mmc.asm):02224                 LDA     DosFWFPoint             ; get MSB
CA4F 8900             (dragondos_mmc.asm):02225                 ADCA    #$00                    ; deal with carry from LSW to MSB
                      (dragondos_mmc.asm):02226                 
CA51 3440             (dragondos_mmc.asm):02227                 PSHS    U                       
CA53 A3E1             (dragondos_mmc.asm):02228                 SUBD    ,S++                    ; Subtract no of sectors in file from MSW of new filesize 
CA55 1F98             (dragondos_mmc.asm):02229                 TFR     B,A
CA57 3504             (dragondos_mmc.asm):02230                 PULS    B                       ; recover LSB of len+FP
CA59 2208             (dragondos_mmc.asm):02231                 BHI     LCBB8                   ; new filesize higher extend file
CA5B 250E             (dragondos_mmc.asm):02232                 BCS     LCBC0                   ; new filesize lower do write
                      (dragondos_mmc.asm):02233                 
CA5D E0E4             (dragondos_mmc.asm):02234                 SUBB    ,S                      ; MSW is equal check LSB
CA5F 2406             (dragondos_mmc.asm):02235                 BCC     LCBBC                   ; new filesize higher extend file
CA61 2008             (dragondos_mmc.asm):02236                 BRA     LCBC0                   ; new filesize lower or equal do write
                      (dragondos_mmc.asm):02237         
CA63 E0E4             (dragondos_mmc.asm):02238         LCBB8   SUBB    ,S
CA65 8200             (dragondos_mmc.asm):02239                 SBCA    #$00
CA67 8D2E             (dragondos_mmc.asm):02240         LCBBC   BSR     ExtendFile              ; extend the file ?
CA69 2629             (dragondos_mmc.asm):02241                 BNE     LCBE9                   ; error :  return
                      (dragondos_mmc.asm):02242                 
CA6B 3261             (dragondos_mmc.asm):02243         LCBC0   LEAS    1,S                     ; drop saved byte
CA6D F60677           (dragondos_mmc.asm):02244                 LDB     DosFWFPoint+2           ; recover file pointer LSB
CA70 BE0671           (dragondos_mmc.asm):02245                 LDX     DosFWBufPtr             ; and buffer
CA73 10BE0673         (dragondos_mmc.asm):02246                 LDY     DosFWByteCount          ; and count
CA77 FE0675           (dragondos_mmc.asm):02247                 LDU     DosFWFPoint             ; and FP MSB
                      (dragondos_mmc.asm):02248                 
CA7A BDC842           (dragondos_mmc.asm):02249                 JSR     >RWrite                 ; entry point for write
CA7D 26BD             (dragondos_mmc.asm):02250                 BNE     LCB91                   ; error : exit
                      (dragondos_mmc.asm):02251                 
CA7F 7D0608           (dragondos_mmc.asm):02252                 TST     DosVerifyFlag           ; verify written data ?
CA82 27B8             (dragondos_mmc.asm):02253                 BEQ     LCB91                   ; nope : return
                      (dragondos_mmc.asm):02254                 
CA84 F60677           (dragondos_mmc.asm):02255                 LDB     DosFWFPoint+2           ; recover file pointer LSB
CA87 BE0671           (dragondos_mmc.asm):02256                 LDX     DosFWBufPtr             ; and buffer
CA8A 10BE0673         (dragondos_mmc.asm):02257                 LDY     DosFWByteCount          ; and count
CA8E FE0675           (dragondos_mmc.asm):02258                 LDU     DosFWFPoint             ; and FP MSB
CA91 16FDB1           (dragondos_mmc.asm):02259                 LBRA    Verify                  ; go verify  it 
                      (dragondos_mmc.asm):02260         
CA94 3261             (dragondos_mmc.asm):02261         LCBE9   LEAS    1,S                     ; clean up stack
CA96 39               (dragondos_mmc.asm):02262                 RTS                             ; return 
                      (dragondos_mmc.asm):02263         
                      (dragondos_mmc.asm):02264         ; 
                      (dragondos_mmc.asm):02265         ; Extend a file, called by DOSFWrite
                      (dragondos_mmc.asm):02266         ;
                      (dragondos_mmc.asm):02267         ; Entry :
                      (dragondos_mmc.asm):02268         ;       DosCurrCtrlBlk  = Fileno
                      (dragondos_mmc.asm):02269         ;       DosDriveNo      = drive number
                      (dragondos_mmc.asm):02270         ;       D               = number of bytes to extend file
                      (dragondos_mmc.asm):02271         ;
                      (dragondos_mmc.asm):02272         ; Returns:
                      (dragondos_mmc.asm):02273         ;       B               = error code
                      (dragondos_mmc.asm):02274         ;
                      (dragondos_mmc.asm):02275         ; The data on the disk is not preset / initialized.
                      (dragondos_mmc.asm):02276         ;
                      (dragondos_mmc.asm):02277         ; Procedure:
                      (dragondos_mmc.asm):02278         ; The number of bytes that can be allocated to the last sector allready
                      (dragondos_mmc.asm):02279         ; allocated to the file is detected.
                      (dragondos_mmc.asm):02280         ; Get a free extent, if contiguous add it to the currently allocated 
                      (dragondos_mmc.asm):02281         ; extent, otherwise make a new one.
                      (dragondos_mmc.asm):02282         ; Decrease free extent by number of sectors needed (or all),
                      (dragondos_mmc.asm):02283         ; If more sectors needed, loop.
                      (dragondos_mmc.asm):02284         ; Figure number of bytes used in last sector and store in DIR.
                      (dragondos_mmc.asm):02285         ;
                      (dragondos_mmc.asm):02286         ; Update length of file and last sector.
                      (dragondos_mmc.asm):02287         ;
                      (dragondos_mmc.asm):02288         
                      (dragondos_mmc.asm):02289         ; stack frame offsets
     0000             (dragondos_mmc.asm):02290         ExtBytes        EQU     0               ; number of bytes to extend**
     0002             (dragondos_mmc.asm):02291         ExtExtentPtr    EQU     2               ; Extent pointer
     0004             (dragondos_mmc.asm):02292         ExtEntry        EQU     4               ; Entry pointer
     0006             (dragondos_mmc.asm):02293         ExtWant         EQU     6               ; Best LSN block found
     0008             (dragondos_mmc.asm):02294         ExtDiskPtr      EQU     8               ; pointer to drive table (DrvDet* consts)
     000A             (dragondos_mmc.asm):02295         ExtSaveExd      EQU     10              ; ?
                      (dragondos_mmc.asm):02296         
     000C             (dragondos_mmc.asm):02297         ExtendFrameSize EQU     $0C             ; stack frame size
                      (dragondos_mmc.asm):02298         
                      (dragondos_mmc.asm):02299         ; ** Since disk sectors are 256 bytes, and the 6809 stores the MSB in the 16 bit 
                      (dragondos_mmc.asm):02300         ; registers pushed onto the stack with MSB at the lowest address (smallest offset 
                      (dragondos_mmc.asm):02301         ; from S), ExBytes,S will access the MSB of ExBytes, which will be the number of 
                      (dragondos_mmc.asm):02302         ; whole sectors requested.
                      (dragondos_mmc.asm):02303         
CA97                  (dragondos_mmc.asm):02304         ExtendFile   
CA97 3274             (dragondos_mmc.asm):02305                 LEAS    -ExtendFrameSize,S      ; make room on stack
CA99 EDE4             (dragondos_mmc.asm):02306                 STD     ExtBytes,S              ; save number of bytes
CA9B ED6A             (dragondos_mmc.asm):02307                 STD     ExtSaveExd,S
                      (dragondos_mmc.asm):02308                 
CA9D 8601             (dragondos_mmc.asm):02309                 LDA     #$01                    ; Flag that we are working....
CA9F 97F6             (dragondos_mmc.asm):02310                 STA     <DosIOInProgress
CAA1 BDD028           (dragondos_mmc.asm):02311                 JSR     >DosGetDiskGeometry     ; get disk geometry
CAA4 102600E5         (dragondos_mmc.asm):02312                 LBNE    ExtendFileExit          ; error exit
                      (dragondos_mmc.asm):02313                 
CAA8 AF68             (dragondos_mmc.asm):02314                 STX     ExtDiskPtr,S            ; save pointer to geometry buffer
CAAA BDCD57           (dragondos_mmc.asm):02315                 JSR     >DosFCBNoToAddr         ; get address of FCB
CAAD E6881E           (dragondos_mmc.asm):02316                 LDB     FCBDirNoLast,X          ; get directory index of last file segment
CAB0 BDD07F           (dragondos_mmc.asm):02317                 JSR     >DOSGetDirEntry         ; go get it
CAB3 102600D6         (dragondos_mmc.asm):02318                 LBNE    ExtendFileExit          ; error : exit
                      (dragondos_mmc.asm):02319                 
CAB7 AF64             (dragondos_mmc.asm):02320                 STX     ExtEntry,S              ; save directory pointer                        
CAB9 FE067F           (dragondos_mmc.asm):02321                 LDU     DosCurDirBuff           ; get def block for dir sector
CABC 86FF             (dragondos_mmc.asm):02322                 LDA     #-1                     ; flag it dirty
CABE A742             (dragondos_mmc.asm):02323                 STA     BuffFlag,U
                      (dragondos_mmc.asm):02324         
                      (dragondos_mmc.asm):02325         ; Work out the number of whole sectors we need to extend the file by.
                      (dragondos_mmc.asm):02326         ; Round up if ammount to extend / sector size has a remainer.
                      (dragondos_mmc.asm):02327         ; number of whole sectors will be in A and remainder in B
                      (dragondos_mmc.asm):02328         
CAC0 4F               (dragondos_mmc.asm):02329                 CLRA                            
CAC1 E68818           (dragondos_mmc.asm):02330                 LDB     DirEntLastBytes,X       ; no bytes in last sector
CAC4 2601             (dragondos_mmc.asm):02331                 BNE     LCC1C                   ; zero, skip
                      (dragondos_mmc.asm):02332                 
CAC6 4C               (dragondos_mmc.asm):02333                 INCA                            ; inc MSB
CAC7 E3E4             (dragondos_mmc.asm):02334         LCC1C   ADDD    ,S                      ; add to number of bytes to extend      
CAC9 5D               (dragondos_mmc.asm):02335                 TSTB                            ; remainder = 0
CACA 2601             (dragondos_mmc.asm):02336                 BNE     LCC22                   ; no.....
                      (dragondos_mmc.asm):02337                 
CACC 4A               (dragondos_mmc.asm):02338                 DECA                            ; decrement MSB
CACD EDE4             (dragondos_mmc.asm):02339         LCC22   STD     ,S                      ; resave amount to extend.      
CACF 4D               (dragondos_mmc.asm):02340                 TSTA                            ; more than space in last sector?
CAD0 102700A1         (dragondos_mmc.asm):02341                 LBEQ    LCCCA                   ; nope, no allocation change needed
                      (dragondos_mmc.asm):02342                 
CAD4 C604             (dragondos_mmc.asm):02343                 LDB     #DirEntExts             ; 4 allocation blocks in directory entry
CAD6 310C             (dragondos_mmc.asm):02344                 LEAY    DirEntFnBlock1,X        ; point to first allocation block in dir
CAD8 A684             (dragondos_mmc.asm):02345                 LDA     DirEntAttr,X            ; get flags of directory entry
CADA 8501             (dragondos_mmc.asm):02346                 BITA    #AttrIsCont             ; Continuation block?
CADC 2704             (dragondos_mmc.asm):02347                 BEQ     LCC37                   ; no, read filename block extents 
                      (dragondos_mmc.asm):02348                 
CADE 3101             (dragondos_mmc.asm):02349                 LEAY    DirEntCntBlock1,X       ; point at first continuation block extent
CAE0 C607             (dragondos_mmc.asm):02350                 LDB     #DirEntCntExts          ; get the extent count for continuation block (7)
                      (dragondos_mmc.asm):02351         
CAE2 6D22             (dragondos_mmc.asm):02352         LCC37   TST     AllocCount,Y            ; any sectors allocated?
CAE4 2614             (dragondos_mmc.asm):02353                 BNE     LCC4F                   ; yes, skip, find last one
                      (dragondos_mmc.asm):02354                 
CAE6 CCFFFF           (dragondos_mmc.asm):02355                 LDD     #-1                     ; max possible allocation....
CAE9 ED66             (dragondos_mmc.asm):02356                 STD     ExtWant,S               ; save it on stack
CAEB 313D             (dragondos_mmc.asm):02357                 LEAY    -AllocLen,Y
CAED 10AF62           (dragondos_mmc.asm):02358                 STY     ExtExtentPtr,S          ; save extent pointer on stack
CAF0 AE68             (dragondos_mmc.asm):02359                 LDX     ExtDiskPtr,S            ; get drive table pointer
CAF2 6D02             (dragondos_mmc.asm):02360                 TST     DrvDetFreeLen,X         ; check to see if we have free space on disk
CAF4 1026009B         (dragondos_mmc.asm):02361                 LBNE    LCCE8
CAF8 203E             (dragondos_mmc.asm):02362                 BRA     LCC8D
                      (dragondos_mmc.asm):02363         
                      (dragondos_mmc.asm):02364         ; find last used allocation block in current directory / continuation block
CAFA 6D22             (dragondos_mmc.asm):02365         LCC4F   TST     AllocCount,Y            ; any sectors allocated?
CAFC 2705             (dragondos_mmc.asm):02366                 BEQ     LCC58                   ; no.....
                      (dragondos_mmc.asm):02367                 
CAFE 3123             (dragondos_mmc.asm):02368                 LEAY    AllocLen,Y              ; move to next alloc block
CB00 5A               (dragondos_mmc.asm):02369                 DECB                            ; decrement alloc block count
CB01 26F7             (dragondos_mmc.asm):02370                 BNE     LCC4F                   ; loop if more to do
                      (dragondos_mmc.asm):02371                 
CB03 313D             (dragondos_mmc.asm):02372         LCC58   LEAY    -AllocLen,Y             ; point at previous alloc block
CB05 ECA4             (dragondos_mmc.asm):02373                 LDD     AllocLSN,Y              ; Get LSN of block
CB07 EB22             (dragondos_mmc.asm):02374                 ADDB    AllocCount,Y            ; add count to LSN
CB09 8900             (dragondos_mmc.asm):02375                 ADCA    #$00                    ; propagate carry
CB0B ED66             (dragondos_mmc.asm):02376                 STD     ExtWant,S               ; Save LSN of 1 block past this allocation
CB0D 10AF62           (dragondos_mmc.asm):02377                 STY     ExtExtentPtr,S          ; save dir extent pointer
CB10 AE68             (dragondos_mmc.asm):02378                 LDX     ExtDiskPtr,S            ; get disk pointer
CB12 6D02             (dragondos_mmc.asm):02379                 TST     DrvDetFreeLen,X         ; Test disk free length
CB14 2722             (dragondos_mmc.asm):02380                 BEQ     LCC8D                                   
                      (dragondos_mmc.asm):02381                 
CB16 EC66             (dragondos_mmc.asm):02382                 LDD     ExtWant,S               ; get starting LSN for search                           
CB18 A303             (dragondos_mmc.asm):02383                 SUBD    DrvDetFreeEPtr,X        ; get free extent pointer
CB1A 272C             (dragondos_mmc.asm):02384                 BEQ     LCC9D                   ; branch if same
                      (dragondos_mmc.asm):02385                 
CB1C BDCBDC           (dragondos_mmc.asm):02386                 JSR     >GetFreeExtent          ; else get a free extent
CB1F 2706             (dragondos_mmc.asm):02387                 BEQ     LCC7C                   ; branch if OK
                      (dragondos_mmc.asm):02388                 
CB21 C194             (dragondos_mmc.asm):02389                 CMPB    #ErrDF          ; Disk full?
CB23 2668             (dragondos_mmc.asm):02390                 BNE     ExtendFileExit          ; no extend the extent
CB25 206C             (dragondos_mmc.asm):02391                 BRA     LCCE8                   ; skip ahead
                      (dragondos_mmc.asm):02392         
                      (dragondos_mmc.asm):02393         ; replace old extent
CB27 AE68             (dragondos_mmc.asm):02394         LCC7C   LDX     ExtDiskPtr,S            
CB29 3442             (dragondos_mmc.asm):02395                 PSHS    A,U                     ; save regs
CB2B E602             (dragondos_mmc.asm):02396                 LDB     DrvDetFreeLen,X         ; get length of free block              
CB2D AE03             (dragondos_mmc.asm):02397                 LDX     DrvDetFreeEPtr,X        ; get extent pointer for block
CB2F BDCEBD           (dragondos_mmc.asm):02398                 JSR     >DeleteExtent           ; go and delete it
CB32 3542             (dragondos_mmc.asm):02399                 PULS    A,U                     ; restore regs
CB34 2657             (dragondos_mmc.asm):02400                 BNE     ExtendFileExit          ; error, exit
CB36 2005             (dragondos_mmc.asm):02401                 BRA     LCC92
                      (dragondos_mmc.asm):02402         
CB38 BDCBDC           (dragondos_mmc.asm):02403         LCC8D   JSR     >GetFreeExtent          ; go get free extent
CB3B 2650             (dragondos_mmc.asm):02404                 BNE     ExtendFileExit          ; error exit
                      (dragondos_mmc.asm):02405         
CB3D AE68             (dragondos_mmc.asm):02406         LCC92   LDX     ExtDiskPtr,S            ; point to disk table
CB3F EF03             (dragondos_mmc.asm):02407                 STU     DrvDetFreeEPtr,X        ; save LSN of free block
CB41 A702             (dragondos_mmc.asm):02408                 STA     DrvDetFreeLen,X         ; save no of sectors free
CB43 11A366           (dragondos_mmc.asm):02409                 CMPU    ExtWant,S               ; compare free pointer to want pointer
CB46 264B             (dragondos_mmc.asm):02410                 BNE     LCCE8                   ; skip if not same, new extent
                      (dragondos_mmc.asm):02411         
                      (dragondos_mmc.asm):02412         ; check if the available space, has enough sectors for the ammount requested.
                      (dragondos_mmc.asm):02413         ; see note at begining of ExtendFile, about ExtBytes :) 
CB48 A6E4             (dragondos_mmc.asm):02414         LCC9D   LDA     ExtBytes,S              ; MSB of wanted bytes (number of whole sectors)         
CB4A A102             (dragondos_mmc.asm):02415                 CMPA    DrvDetFreeLen,X         ; free len
CB4C 2502             (dragondos_mmc.asm):02416                 BCS     LCCA5                   ; branch if free len lower
                      (dragondos_mmc.asm):02417         
CB4E A602             (dragondos_mmc.asm):02418                 LDA     DrvDetFreeLen,X         ; number of sectors free
CB50 10AE62           (dragondos_mmc.asm):02419         LCCA5   LDY     ExtExtentPtr,S          ; get pointer to extent
CB53 3402             (dragondos_mmc.asm):02420                 PSHS    A                       ; free sector count
CB55 AB22             (dragondos_mmc.asm):02421                 ADDA    AllocCount,Y            ; add allocation count 
CB57 2404             (dragondos_mmc.asm):02422                 BCC     LCCB2                   ; branch if no overflow....             
                      (dragondos_mmc.asm):02423         
CB59 3502             (dragondos_mmc.asm):02424                 PULS    A                       ; restore sector count
CB5B 2036             (dragondos_mmc.asm):02425                 BRA     LCCE8                   ; branch....
                      (dragondos_mmc.asm):02426         
                      (dragondos_mmc.asm):02427         ; Sector count in A still stacked
CB5D A722             (dragondos_mmc.asm):02428         LCCB2   STA     AllocCount,Y            ; update count  
CB5F A602             (dragondos_mmc.asm):02429                 LDA     DrvDetFreeLen,X         ; get free len
CB61 A0E4             (dragondos_mmc.asm):02430                 SUBA    ,S                      ; subtract number of sectors allocated
CB63 A702             (dragondos_mmc.asm):02431                 STA     DrvDetFreeLen,X         ; resave it
CB65 EC03             (dragondos_mmc.asm):02432                 LDD     DrvDetFreeEPtr,X        ; get LSN of beginning of free block
CB67 EBE4             (dragondos_mmc.asm):02433                 ADDB    ,S                      ; and number of complete sectors
CB69 8900             (dragondos_mmc.asm):02434                 ADCA    #$00                    ; propagate carry
CB6B ED03             (dragondos_mmc.asm):02435                 STD     DrvDetFreeEPtr,X        ; resave it
                      (dragondos_mmc.asm):02436                 
CB6D A661             (dragondos_mmc.asm):02437                 LDA     ExtBytes+1,S            ; get number of sectors wanted
CB6F A0E0             (dragondos_mmc.asm):02438                 SUBA    ,S+                     ; subtract no of sectors allocated
CB71 A7E4             (dragondos_mmc.asm):02439                 STA     ,S                      ; resave
CB73 26C3             (dragondos_mmc.asm):02440                 BNE     LCC8D                   ; if not zero loop again, to allocate more!
                      (dragondos_mmc.asm):02441         
CB75 AE64             (dragondos_mmc.asm):02442         LCCCA   LDX     ExtEntry,S              ; get entry pointer
CB77 1F13             (dragondos_mmc.asm):02443                 TFR     X,U                     ; save in U
CB79 BDCD57           (dragondos_mmc.asm):02444                 JSR     >DosFCBNoToAddr         ; get FCB address
CB7C EC6A             (dragondos_mmc.asm):02445                 LDD     ExtSaveExd,S            ; get original bytes requested
CB7E E38811           (dragondos_mmc.asm):02446                 ADDD    FCBFileLen+1,X          ; add LSW of current file len
CB81 2403             (dragondos_mmc.asm):02447                 BCC     LCCDB                   ; branch if no carry
                      (dragondos_mmc.asm):02448         
CB83 6C8810           (dragondos_mmc.asm):02449                 INC     FCBFileLen,X            ; increment MSB if carry to poroagate it
CB86 ED8811           (dragondos_mmc.asm):02450         LCCDB   STD     FCBFileLen+1,X          ; save new file length
CB89 E7C818           (dragondos_mmc.asm):02451                 STB     DirEntLastBytes,U       ; update bytes in last sector
CB8C 5F               (dragondos_mmc.asm):02452                 CLRB
                      (dragondos_mmc.asm):02453         
CB8D                  (dragondos_mmc.asm):02454         ExtendFileExit   
CB8D 326C             (dragondos_mmc.asm):02455                 LEAS    ExtendFrameSize,S       ; drop stack frame
CB8F 0FF6             (dragondos_mmc.asm):02456                 CLR     <DosIOInProgress        ; clear IO flag
CB91 5D               (dragondos_mmc.asm):02457                 TSTB                            ; set error
CB92 39               (dragondos_mmc.asm):02458                 RTS
                      (dragondos_mmc.asm):02459         
CB93 EC62             (dragondos_mmc.asm):02460         LCCE8   LDD     ExtExtentPtr,S          ; get extent pointer
CB95 1F02             (dragondos_mmc.asm):02461                 TFR     D,Y                     ; save it in Y
CB97 A364             (dragondos_mmc.asm):02462                 SUBD    ExtEntry,S              
CB99 C113             (dragondos_mmc.asm):02463                 CMPB    #$13                    ; room for another entry in dir block
CB9B 240B             (dragondos_mmc.asm):02464                 BHS     NewDir                  ; no....make a new continuation block
                      (dragondos_mmc.asm):02465                 
CB9D 3123             (dragondos_mmc.asm):02466                 LEAY    AllocEntrySize,Y        ; move to next allocation entry
CB9F 10AF62           (dragondos_mmc.asm):02467                 STY     ExtExtentPtr,S          ; save allocation pointer
CBA2 EC03             (dragondos_mmc.asm):02468         LCCF7   LDD     DrvDetFreeEPtr,X        ; get pointer to free block of sectors
CBA4 EDA4             (dragondos_mmc.asm):02469                 STD     AllocLSN,Y              ; save it in entry
CBA6 20A0             (dragondos_mmc.asm):02470                 BRA     LCC9D                   ; loop to check all extending done
                      (dragondos_mmc.asm):02471         
                      (dragondos_mmc.asm):02472         ; add a new continuation block to the directory                 
CBA8 8601             (dragondos_mmc.asm):02473         NewDir  LDA     #$01                    ; flag continuation type entry
CBAA BDCFA7           (dragondos_mmc.asm):02474                 JSR     >FindEmptyDir           ; find empty directory entry block
CBAD 26DE             (dragondos_mmc.asm):02475                 BNE     ExtendFileExit          ; error exit
                      (dragondos_mmc.asm):02476                 
CBAF 10AE64           (dragondos_mmc.asm):02477                 LDY     ExtEntry,S              ; get extent pointer
CBB2 A7A818           (dragondos_mmc.asm):02478                 STA     DirEntFlag,Y            ; flag continuation entry
CBB5 E6A4             (dragondos_mmc.asm):02479                 LDB     DirEntAttr,Y            ; get entry attributes
CBB7 CA20             (dragondos_mmc.asm):02480                 ORB     #AttrContinued          ; flag it as a continuation block
CBB9 E7A4             (dragondos_mmc.asm):02481                 STB     DirEntAttr,Y            ; save it back
                      (dragondos_mmc.asm):02482                 
CBBB C6FF             (dragondos_mmc.asm):02483                 LDB     #BuffDirty              ; mark disk buffer dirty
CBBD E702             (dragondos_mmc.asm):02484                 STB     BuffFlag,X
                      (dragondos_mmc.asm):02485                 
CBBF C601             (dragondos_mmc.asm):02486                 LDB     #AttrIsCont             ; mark as continuation
CBC1 E7C4             (dragondos_mmc.asm):02487                 STB     DirEntAttr,U
CBC3 EF64             (dragondos_mmc.asm):02488                 STU     ExtEntry,S
                      (dragondos_mmc.asm):02489                 
CBC5 BDCD57           (dragondos_mmc.asm):02490                 JSR     >DosFCBNoToAddr         ; get FCB address in X
CBC8 A7881E           (dragondos_mmc.asm):02491                 STA     FCBDirNoLast,X
                      (dragondos_mmc.asm):02492                 
CBCB 31C819           (dragondos_mmc.asm):02493                 LEAY    DirEntryLen,U
CBCE C618             (dragondos_mmc.asm):02494                 LDB     #DirEntryLen-1          ; zero continuation block to initialize
CBD0 6FA2             (dragondos_mmc.asm):02495         LCD25   CLR     ,-Y                     ; clear a byte poiubter back
CBD2 5A               (dragondos_mmc.asm):02496                 DECB                            ; decrement count
CBD3 26FB             (dragondos_mmc.asm):02497                 BNE     LCD25                   ; loop again if not all done
                      (dragondos_mmc.asm):02498                 
CBD5 10AF62           (dragondos_mmc.asm):02499                 STY     ExtExtentPtr,S          ; save pointer to first extent in block
CBD8 AE68             (dragondos_mmc.asm):02500                 LDX     ExtDiskPtr,S            ; get disk pointer
CBDA 20C6             (dragondos_mmc.asm):02501                 BRA     LCCF7                   ; loop to allocate 
                      (dragondos_mmc.asm):02502         
                      (dragondos_mmc.asm):02503         ;
                      (dragondos_mmc.asm):02504         ; Get free extent
                      (dragondos_mmc.asm):02505         ;
                      (dragondos_mmc.asm):02506         ; This must be called by ExtendFile and allocates one extent from the
                      (dragondos_mmc.asm):02507         ; free list.
                      (dragondos_mmc.asm):02508         ;
                      (dragondos_mmc.asm):02509         ; In order of prefference it will find a sector:
                      (dragondos_mmc.asm):02510         ;       At the LSN specified. 
                      (dragondos_mmc.asm):02511         ;       At the start of a pair of tracks.
                      (dragondos_mmc.asm):02512         ;       Outside of the directory track.
                      (dragondos_mmc.asm):02513         ;       At the start of the track outside of the directory.
                      (dragondos_mmc.asm):02514         ;       At the start of the track inside of the directory.
                      (dragondos_mmc.asm):02515         ;       Any free sector at the start of a contiguous block.
                      (dragondos_mmc.asm):02516         ;
                      (dragondos_mmc.asm):02517         ; Entry:
                      (dragondos_mmc.asm):02518         ;       ExtWant,S       = LSN preffered, of $FFFF.
                      (dragondos_mmc.asm):02519         ;       DosDriveNo      = drive number
                      (dragondos_mmc.asm):02520         ;
                      (dragondos_mmc.asm):02521         ; Returns: 
                      (dragondos_mmc.asm):02522         ;       U               = LSN
                      (dragondos_mmc.asm):02523         ;       A               = length of extent.
                      (dragondos_mmc.asm):02524         ;       B               = error code (if any).
                      (dragondos_mmc.asm):02525         ;
                      (dragondos_mmc.asm):02526         
     0000             (dragondos_mmc.asm):02527         GFTry           EQU     0
     0002             (dragondos_mmc.asm):02528         GFPointBuff     EQU     2       ; buffer pointer?
     0004             (dragondos_mmc.asm):02529         GFlag           EQU     4       ; flags?
     0005             (dragondos_mmc.asm):02530         TempLSN         EQU     5       ; Temporary LSN
     0007             (dragondos_mmc.asm):02531         TempCount       EQU     7       ; Tempory count
     0008             (dragondos_mmc.asm):02532         BTCount         EQU     8
                      (dragondos_mmc.asm):02533         
     0009             (dragondos_mmc.asm):02534         GFFrameSize     EQU     9       ; Stack frame size
                      (dragondos_mmc.asm):02535         
CBDC                  (dragondos_mmc.asm):02536         GetFreeExtent   
CBDC 10FF0601         (dragondos_mmc.asm):02537                 STS     Temps1                  ; save old stack pointer
CBE0 3277             (dragondos_mmc.asm):02538                 LEAS    -GFFrameSize,S          ; make room for our stack frame
CBE2 6F64             (dragondos_mmc.asm):02539                 CLR     GFlag,S                 ; zero flags                    
CBE4 BDD028           (dragondos_mmc.asm):02540                 JSR     >DosGetDiskGeometry     ; get disk geometry
CBE7 102600F4         (dragondos_mmc.asm):02541                 LBNE    GetFreeExtentExit       ; error, exit
                      (dragondos_mmc.asm):02542                 
CBEB 10AE84           (dragondos_mmc.asm):02543                 LDY     DrvDetDirLSN,X          ; get LSN of directory
CBEE EEE811           (dragondos_mmc.asm):02544                 LDU     (ExtWant+GFFrameSize+2),S       ; get ammount we want (note +2 for PC)
CBF1 EF65             (dragondos_mmc.asm):02545                 STU     TempLSN,S               ; save it in temp
CBF3 3041             (dragondos_mmc.asm):02546                 LEAX    1,U                     ; is requested LSN = $FFFF 
CBF5 270F             (dragondos_mmc.asm):02547                 BEQ     LCD5B                   ; yes, an use any block
                      (dragondos_mmc.asm):02548         
                      (dragondos_mmc.asm):02549         ; test to see if the supplied LSN is in use     
CBF7 8D3E             (dragondos_mmc.asm):02550                 BSR     GoGetBit                ; go get bitmap for requested LSN (U)
CBF9 2639             (dragondos_mmc.asm):02551                 BNE     GoFoundFree             ; branch if LSN not in use
                      (dragondos_mmc.asm):02552                 
CBFB 118305A0         (dragondos_mmc.asm):02553                 CMPU    #BAMLSNPerSec           ; LSN < 1440
CBFF 2505             (dragondos_mmc.asm):02554                 BCS     LCD5B                   ; yes, try stepping in
                      (dragondos_mmc.asm):02555                 
CC01 CE058E           (dragondos_mmc.asm):02556                 LDU     #1422                   ; Try this LSN (+ 1 track) next
CC04 2021             (dragondos_mmc.asm):02557                 BRA     LCD7C                   ; else try stepping out
                      (dragondos_mmc.asm):02558         
CC06 33A4             (dragondos_mmc.asm):02559         LCD5B   LEAU    ,Y                      ; U=LSN of directory
CC08 86FF             (dragondos_mmc.asm):02560         LCD5D   LDA     #$FF                    ; flag GFTry invalid (-ve)
CC0A A7E4             (dragondos_mmc.asm):02561                 STA     GFTry,S
                      (dragondos_mmc.asm):02562         
                      (dragondos_mmc.asm):02563         ; Try the start of each track until we find a free sector on two consecutive
                      (dragondos_mmc.asm):02564         ; tracks, or reach the beginning of the disk.
                      (dragondos_mmc.asm):02565                 
CC0C 33C8EE           (dragondos_mmc.asm):02566         LCD61   LEAU    -SecTrkSS,U             ; Decrement LSN by one complete track
CC0F EF7E             (dragondos_mmc.asm):02567                 STU     -2,S                    ; TSTU :)
CC11 2B0C             (dragondos_mmc.asm):02568                 BMI     LCD74                   ; branch if LSN < 0
                      (dragondos_mmc.asm):02569                         
CC13 8D22             (dragondos_mmc.asm):02570                 BSR     GoGetBit                ; get bitmask for LSN
CC15 27F1             (dragondos_mmc.asm):02571                 BEQ     LCD5D                   ; branch if LSN in use, try another
                      (dragondos_mmc.asm):02572                 
CC17 6DE4             (dragondos_mmc.asm):02573                 TST     GFTry,S                 ; is GFtry valid?
CC19 2A19             (dragondos_mmc.asm):02574                 BPL     GoFoundFree             ; yep we found a valid block    
                      (dragondos_mmc.asm):02575                 
CC1B EFE4             (dragondos_mmc.asm):02576                 STU     GFTry,S                 ; save current sector, as current try
CC1D 20ED             (dragondos_mmc.asm):02577                 BRA     LCD61                   ; look on previous track
                      (dragondos_mmc.asm):02578         
CC1F EEE4             (dragondos_mmc.asm):02579         LCD74   LDU     GFTry,S
CC21 EF7E             (dragondos_mmc.asm):02580                 STU     -2,S                    ; TSTU :)
CC23 2A0F             (dragondos_mmc.asm):02581                 BPL     GoFoundFree             ; LSN for try is +ve, test it
                      (dragondos_mmc.asm):02582                 
CC25 33A4             (dragondos_mmc.asm):02583                 LEAU    ,Y                      ; U=LSN of directory, try track after dir
                      (dragondos_mmc.asm):02584                 
CC27 33C812           (dragondos_mmc.asm):02585         LCD7C   LEAU    SecTrkSS,U              ; Increment LSN by one complete track
CC2A 11830B40         (dragondos_mmc.asm):02586                 CMPU    #MaxLSN                 ; beyond max LSN?
CC2E 220A             (dragondos_mmc.asm):02587                 BHI     LCD8F                   ; yes try next test
                      (dragondos_mmc.asm):02588                 
CC30 8D05             (dragondos_mmc.asm):02589                 BSR     GoGetBit                ; get bitmask for LSN
CC32 27F3             (dragondos_mmc.asm):02590                 BEQ     LCD7C                   ; branch if LSN in use, try next track out
                      (dragondos_mmc.asm):02591         
CC34                  (dragondos_mmc.asm):02592         GoFoundFree
CC34 160082           (dragondos_mmc.asm):02593                 LBRA    FoundFree               ; we've found a free block, go use it
                      (dragondos_mmc.asm):02594         
CC37                  (dragondos_mmc.asm):02595         GoGetBit
CC37 1600AB           (dragondos_mmc.asm):02596                 LBRA    GetBit                  ; jump that alows us to short jump.....                 
                      (dragondos_mmc.asm):02597         
CC3A 86FF             (dragondos_mmc.asm):02598         LCD8F   LDA     #$FF                    ; Temp  count = -1
CC3C A767             (dragondos_mmc.asm):02599                 STA     TempCount,S
                      (dragondos_mmc.asm):02600                 
CC3E A664             (dragondos_mmc.asm):02601                 LDA     GFlag,S                 ; get flag
CC40 DE8A             (dragondos_mmc.asm):02602         LCD95   LDU     <DBZero                 ; U = zero
CC42 44               (dragondos_mmc.asm):02603                 LSRA                            ; bottom buffer?
CC43 2503             (dragondos_mmc.asm):02604                 BCS     LCD9D                   ; yes.....
                      (dragondos_mmc.asm):02605                 
CC45 CE05A0           (dragondos_mmc.asm):02606                 LDU     #BAMLSNPerSec           ; no go get other buffer
CC48 8DED             (dragondos_mmc.asm):02607         LCD9D   BSR     GoGetBit
                      (dragondos_mmc.asm):02608         
CC4A C6B4             (dragondos_mmc.asm):02609                 LDB     #BAMEntriesSec          ; 180 BAM entries per sector....
CC4C A680             (dragondos_mmc.asm):02610         LCDA1   LDA     ,X+                     ; get next byte from BAM 
CC4E 2607             (dragondos_mmc.asm):02611                 BNE     LCDAC                   ; branch if next 8 sectors all free
                      (dragondos_mmc.asm):02612                 
CC50 3348             (dragondos_mmc.asm):02613                 LEAU    8,U                     ; increment LSN by 8 (8 LSNs per BAM entry)
CC52 5A               (dragondos_mmc.asm):02614                 DECB                            ; decrement entry counter
CC53 26F7             (dragondos_mmc.asm):02615                 BNE     LCDA1                   ; look again if entry counter nonzero
CC55 2041             (dragondos_mmc.asm):02616                 BRA     LCDED                   ; counter zero skip ahead
                      (dragondos_mmc.asm):02617         
                      (dragondos_mmc.asm):02618         ; look for the bigest block of free LSNs....
                      (dragondos_mmc.asm):02619         
CC57 5F               (dragondos_mmc.asm):02620         LCDAC   CLRB                            ; Zero BTCount
CC58 E768             (dragondos_mmc.asm):02621                 STB     BTCount,S
                      (dragondos_mmc.asm):02622                 
CC5A 3440             (dragondos_mmc.asm):02623                 PSHS    U                       ; save LSN (stack offsets +2 because of push)
CC5C 5C               (dragondos_mmc.asm):02624         LCDB1   INCB                            ; increment counter
CC5D A680             (dragondos_mmc.asm):02625                 LDA     ,X+                     ; get byte from BAM 
CC5F 4C               (dragondos_mmc.asm):02626                 INCA                            ; is it $FF?
CC60 27FA             (dragondos_mmc.asm):02627                 BEQ     LCDB1                   ; yes occupied loop again
                      (dragondos_mmc.asm):02628                 
CC62 E16A             (dragondos_mmc.asm):02629                 CMPB    BTCount+2,S             ; biggest block found ? 
CC64 2304             (dragondos_mmc.asm):02630                 BLS     LCDBF                   ; nope skip on
                      (dragondos_mmc.asm):02631                 
CC66 E76A             (dragondos_mmc.asm):02632                 STB     BTCount+2,S             ; Yes save it
CC68 EFE4             (dragondos_mmc.asm):02633                 STU     ,S                      ; update stacked LSN
                      (dragondos_mmc.asm):02634                 
CC6A 301F             (dragondos_mmc.asm):02635         LCDBF   LEAX    -1,X                    ; back one byte in BAM
CC6C 8608             (dragondos_mmc.asm):02636                 LDA     #SectorsPerBAM          ; multiply BAM byte counter by entries 
CC6E 3D               (dragondos_mmc.asm):02637                 MUL                             ; per BAM byte
CC6F 33CB             (dragondos_mmc.asm):02638                 LEAU    D,U                     ; point LSN at it
                      (dragondos_mmc.asm):02639                 
CC71 5F               (dragondos_mmc.asm):02640         LCDC6   CLRB                            ; clear counter
CC72 A680             (dragondos_mmc.asm):02641                 LDA     ,X+                     ; get next BAM byte
CC74 26E6             (dragondos_mmc.asm):02642                 BNE     LCDB1                   ; if not zero loop again
                      (dragondos_mmc.asm):02643                 
CC76 3348             (dragondos_mmc.asm):02644                 LEAU    SectorsPerBAM,U         ; add group of 8 to LSN
CC78 1F10             (dragondos_mmc.asm):02645                 TFR     X,D                     ; test for end of BAM 
CC7A C1B4             (dragondos_mmc.asm):02646                 CMPB    #BAMEntriesSec
CC7C 25F3             (dragondos_mmc.asm):02647                 BCS     LCDC6                   ; nope loop again
                      (dragondos_mmc.asm):02648                 
CC7E 3540             (dragondos_mmc.asm):02649                 PULS    U                       ; restore LSN of biggest block
                      (dragondos_mmc.asm):02650                 
CC80 8D63             (dragondos_mmc.asm):02651                 BSR     GetBit                  ; get bitmap
CC82 3348             (dragondos_mmc.asm):02652                 LEAU    SectorsPerBAM,U         ; move up 8 LSNs
CC84 A684             (dragondos_mmc.asm):02653                 LDA     ,X                      ; get byte of LSN
                      (dragondos_mmc.asm):02654                 
CC86 E668             (dragondos_mmc.asm):02655                 LDB     BTCount,S               ; get count
CC88 C101             (dragondos_mmc.asm):02656                 CMPB    #$01                    ; just 1 group of 8?
CC8A 2205             (dragondos_mmc.asm):02657                 BHI     LCDE6                   ; branch if not....
                      (dragondos_mmc.asm):02658                 
CC8C 335F             (dragondos_mmc.asm):02659         LCDE1   LEAU    -1,U                    ; Back up LSN.....                      
CC8E 48               (dragondos_mmc.asm):02660                 ASLA                            ; shift bitmap
CC8F 24FB             (dragondos_mmc.asm):02661                 BCC     LCDE1                   ; till we get correct LSN for bit...
                      (dragondos_mmc.asm):02662                 
CC91 48               (dragondos_mmc.asm):02663         LCDE6   ASLA                            ; shift bitmap
CC92 2404             (dragondos_mmc.asm):02664                 BCC     LCDED                   ; branch if beginning of bitmap byte?
CC94 335F             (dragondos_mmc.asm):02665                 LEAU    -1,U                    ; back up LSN
CC96 20F9             (dragondos_mmc.asm):02666                 BRA     LCDE6                   ; loop again
                      (dragondos_mmc.asm):02667         
CC98 C102             (dragondos_mmc.asm):02668         LCDED   CMPB    #$02                    ; 2 blocks of 8?        
CC9A 241D             (dragondos_mmc.asm):02669                 BCC     FoundFree               ; yep, found enough
                      (dragondos_mmc.asm):02670                 
CC9C E167             (dragondos_mmc.asm):02671                 CMPB    TempCount,S             ; bigger than count
CC9E 2219             (dragondos_mmc.asm):02672                 BHI     FoundFree               ; yep, found enough
                      (dragondos_mmc.asm):02673                 
CCA0 A667             (dragondos_mmc.asm):02674                 LDA     TempCount,S             ; temp count = $FF
CCA2 4C               (dragondos_mmc.asm):02675                 INCA
CCA3 260A             (dragondos_mmc.asm):02676                 BNE     LCE04                   ; no....
                      (dragondos_mmc.asm):02677                 
CCA5 E767             (dragondos_mmc.asm):02678                 STB     TempCount,S             ; save temp count
CCA7 EF65             (dragondos_mmc.asm):02679                 STU     TempLSN,S               ; and temp LSN  
CCA9 A664             (dragondos_mmc.asm):02680                 LDA     GFlag,S                 ; get GFlag
CCAB 8803             (dragondos_mmc.asm):02681                 EORA    #$03                    ; flip bottom 2 bits
CCAD 2091             (dragondos_mmc.asm):02682                 BRA     LCD95                   ; go look again.....
                      (dragondos_mmc.asm):02683         
CCAF EE65             (dragondos_mmc.asm):02684         LCE04   LDU     TempLSN,S               ; get TempLSN
CCB1 8D32             (dragondos_mmc.asm):02685                 BSR     GetBit                  ; go get it's bitmap entries
CCB3 2604             (dragondos_mmc.asm):02686                 BNE     FoundFree               ; got some, allocate it 
                      (dragondos_mmc.asm):02687                 
CCB5 C694             (dragondos_mmc.asm):02688                 LDB     #ErrDF                  ; disk full 
CCB7 2026             (dragondos_mmc.asm):02689                 BRA     GetFreeExtentExit       ; exit, cleaning up
                      (dragondos_mmc.asm):02690         
CCB9                  (dragondos_mmc.asm):02691         FoundFree   
CCB9 8D2A             (dragondos_mmc.asm):02692                 BSR     GetBit                  ; Get bitmap
CCBB 5F               (dragondos_mmc.asm):02693                 CLRB                            ; sector count?
                      (dragondos_mmc.asm):02694                 
CCBC 5C               (dragondos_mmc.asm):02695         LCE11   INCB
CCBD 2717             (dragondos_mmc.asm):02696                 BEQ     LCE2B                   ; overflow?
                      (dragondos_mmc.asm):02697                 
                      (dragondos_mmc.asm):02698         ; this clears the bit in the BAM, reserving the block for the file        
CCBF 3402             (dragondos_mmc.asm):02699                 PSHS    A                       ; save bitmask
CCC1 43               (dragondos_mmc.asm):02700                 COMA                            ; compliment, to get turn off mask
CCC2 A484             (dragondos_mmc.asm):02701                 ANDA    ,X                      ; turn of bit
CCC4 A784             (dragondos_mmc.asm):02702                 STA     ,X                      ; resave it
CCC6 3502             (dragondos_mmc.asm):02703                 PULS    A                       ; restore bitmask
                      (dragondos_mmc.asm):02704                 
CCC8 48               (dragondos_mmc.asm):02705                 ASLA                            ; shift bitmask left (try next block)
CCC9 2404             (dragondos_mmc.asm):02706                 BCC     LCE24                   ; branch if all bits done
                      (dragondos_mmc.asm):02707                 
CCCB 8601             (dragondos_mmc.asm):02708                 LDA     #$01                    ; re-initialize mask    
CCCD 3001             (dragondos_mmc.asm):02709                 LEAX    1,X                     ; get next group of blocks' bits from BAM
CCCF A584             (dragondos_mmc.asm):02710         LCE24   BITA    ,X                      ; is sector in use ?
CCD1 26E9             (dragondos_mmc.asm):02711                 BNE     LCE11                   ; no reserve it
CCD3 1F98             (dragondos_mmc.asm):02712                 TFR     B,A                     ; yes, get sector count in A
                      (dragondos_mmc.asm):02713                 
CCD5 8C               (dragondos_mmc.asm):02714                 FCB     Skip2
CCD6 86FF             (dragondos_mmc.asm):02715         LCE2B   LDA     #$FF                    ; 
CCD8 AE62             (dragondos_mmc.asm):02716                 LDX     GFPointBuff,S           ; get disk buffer entry pointer
CCDA C6FF             (dragondos_mmc.asm):02717                 LDB     #BuffDirty              ; make buffer dirty so it will be re-written
CCDC E702             (dragondos_mmc.asm):02718                 STB     BuffFlag,X
CCDE 5F               (dragondos_mmc.asm):02719                 CLRB                            ; flag no error
                      (dragondos_mmc.asm):02720                 
CCDF                  (dragondos_mmc.asm):02721         GetFreeExtentExit   
CCDF 10FE0601         (dragondos_mmc.asm):02722                 LDS     Temps1                  ; restore saved stack pointer
CCE3 5D               (dragondos_mmc.asm):02723                 TSTB                            ; test B, set CC.C on error
CCE4 39               (dragondos_mmc.asm):02724                 RTS                             ; return to caller
                      (dragondos_mmc.asm):02725         ;
                      (dragondos_mmc.asm):02726         ; Get byte and bitmask for LSN
                      (dragondos_mmc.asm):02727         ;
                      (dragondos_mmc.asm):02728         ; The appropreate sector is read if not already in memory.
                      (dragondos_mmc.asm):02729         ;
                      (dragondos_mmc.asm):02730         ; On error returns to the calling program....
                      (dragondos_mmc.asm):02731         ;
                      (dragondos_mmc.asm):02732         ; Entry:
                      (dragondos_mmc.asm):02733         ;       U       = LSN
                      (dragondos_mmc.asm):02734         ;       Y       = Directory LSN
                      (dragondos_mmc.asm):02735         ;
                      (dragondos_mmc.asm):02736         ; Returns:
                      (dragondos_mmc.asm):02737         ;       A       = bitmask
                      (dragondos_mmc.asm):02738         ;       X       = byte within table
                      (dragondos_mmc.asm):02739         ;       U,Y     = preserved.
                      (dragondos_mmc.asm):02740         ;
                      (dragondos_mmc.asm):02741         ; It is important to note that within the BAM a 1 bit represents a free
                      (dragondos_mmc.asm):02742         ; sector and a 0 bit represents a used sector.
                      (dragondos_mmc.asm):02743         ; The BAM is also split over the first two sectors of the directory track
                      (dragondos_mmc.asm):02744         ; such that the first 1440 LSNs are in bytes 0..179 of sector 1
                      (dragondos_mmc.asm):02745         ; and the second 1440 sectors are in bytes 0..179 of the second sector.
                      (dragondos_mmc.asm):02746         ;
                      (dragondos_mmc.asm):02747         
                      (dragondos_mmc.asm):02748         
CCE5 3460             (dragondos_mmc.asm):02749         GetBit  PSHS    Y,U                     ; save regs
CCE7 8601             (dragondos_mmc.asm):02750                 LDA     #$01                    ; bit for 1st sector
CCE9 118305A0         (dragondos_mmc.asm):02751                 CMPU    #BAMLSNPerSec           ; LSN in first table?
CCED 2507             (dragondos_mmc.asm):02752                 BCS     LCE4B                   ; yes, skip ahead
                      (dragondos_mmc.asm):02753                 
CCEF 3121             (dragondos_mmc.asm):02754                 LEAY    1,Y                     ; point to next table
CCF1 33C9FA60         (dragondos_mmc.asm):02755                 LEAU    -BAMLSNPerSec,U         ; decrement U to get offset in second table
CCF5 48               (dragondos_mmc.asm):02756                 ASLA                            ; bit for second sector
                      (dragondos_mmc.asm):02757                 
CCF6 3440             (dragondos_mmc.asm):02758         LCE4B   PSHS    U                       ; save LSN required
CCF8 A56C             (dragondos_mmc.asm):02759                 BITA    GFlag+8,S               ; Already free?
CCFA 260D             (dragondos_mmc.asm):02760                 BNE     LCE5E                   ; yes.....
                      (dragondos_mmc.asm):02761                 
CCFC A76C             (dragondos_mmc.asm):02762                 STA     GFlag+8,S               ; save it
CCFE BDD0F2           (dragondos_mmc.asm):02763                 JSR     >DOSFindAndRead         ; read LSN (Y), buffer entry ptr returned in X
CD01 26DC             (dragondos_mmc.asm):02764                 BNE     GetFreeExtentExit                       ; error exit
                      (dragondos_mmc.asm):02765                 
CD03 AF6A             (dragondos_mmc.asm):02766                 STX     GFPointBuff+8,S         ; store disk buffer entry pointer
CD05 86FF             (dragondos_mmc.asm):02767                 LDA     #BuffDirty              ; mark buffer dirty
CD07 A702             (dragondos_mmc.asm):02768                 STA     BuffFlag,X              
                      (dragondos_mmc.asm):02769         
CD09 AE6A             (dragondos_mmc.asm):02770         LCE5E   LDX     GFPointBuff+8,S         ; get disk buffer entry pointer
CD0B AE05             (dragondos_mmc.asm):02771                 LDX     BuffAddr,X              ; get address of data
CD0D 3506             (dragondos_mmc.asm):02772                 PULS    D                       ; recover required LSN
                      (dragondos_mmc.asm):02773                 
CD0F 44               (dragondos_mmc.asm):02774                 LSRA                            ; D=D/8, get LSN bit and byte offset in BAM.
CD10 56               (dragondos_mmc.asm):02775                 RORB
CD11 44               (dragondos_mmc.asm):02776                 LSRA
CD12 56               (dragondos_mmc.asm):02777                 RORB
CD13 44               (dragondos_mmc.asm):02778                 LSRA
CD14 56               (dragondos_mmc.asm):02779                 RORB
                      (dragondos_mmc.asm):02780                 
CD15 A663             (dragondos_mmc.asm):02781                 LDA     3,S                     ; get LSB of required LSN
CD17 8407             (dragondos_mmc.asm):02782                 ANDA    #$07                    ; mask off bottom 3 bits
CD19 CEA672           (dragondos_mmc.asm):02783                 LDU     #DPixMaskTable4Col-1    ; convenient no->bitmask table....                              
CD1C 40               (dragondos_mmc.asm):02784                 NEGA                            ; negate A
CD1D A6C6             (dragondos_mmc.asm):02785                 LDA     A,U                     ; get bit from table
CD1F 3A               (dragondos_mmc.asm):02786                 ABX                             ; lookup byte in BAM
CD20 A584             (dragondos_mmc.asm):02787                 BITA    ,X                      ; extract it
CD22 35E0             (dragondos_mmc.asm):02788                 PULS    Y,U,PC                  ; restore and return
                      (dragondos_mmc.asm):02789         
                      (dragondos_mmc.asm):02790         
                      (dragondos_mmc.asm):02791         ;
                      (dragondos_mmc.asm):02792         ; Get a file length.
                      (dragondos_mmc.asm):02793         ;
                      (dragondos_mmc.asm):02794         ; Entry :
                      (dragondos_mmc.asm):02795         ;       A       = FCB no.
                      (dragondos_mmc.asm):02796         ;
                      (dragondos_mmc.asm):02797         ; Exit :
                      (dragondos_mmc.asm):02798         ;       U:A     = length of file 
                      (dragondos_mmc.asm):02799         ;       B       = Error code
                      (dragondos_mmc.asm):02800         ;
                      (dragondos_mmc.asm):02801         
CD24                  (dragondos_mmc.asm):02802         DOSGetFLen   
CD24 97F1             (dragondos_mmc.asm):02803                 STA     <DosCurrCtrlBlk         ; save FCB no
CD26 8D2F             (dragondos_mmc.asm):02804                 BSR     DosFCBNoToAddr          ; get address of FCB
CD28 6D0F             (dragondos_mmc.asm):02805                 TST     FCBDirFlags,X           ; get dir flags from FCB
CD2A 2A03             (dragondos_mmc.asm):02806                 BPL     LCE84                   ; ok skip
                      (dragondos_mmc.asm):02807                 
CD2C C69C             (dragondos_mmc.asm):02808                 LDB     #ErrFF          ; error : file not found
CD2E 39               (dragondos_mmc.asm):02809         LCE83   RTS
                      (dragondos_mmc.asm):02810         
CD2F A68812           (dragondos_mmc.asm):02811         LCE84   LDA     FCBFileLen+2,X          ; number of extra bytes in last sector          
CD32 EE8810           (dragondos_mmc.asm):02812                 LDU     FCBFileLen,X            ; number of sectors
CD35 3141             (dragondos_mmc.asm):02813                 LEAY    1,U                     
CD37 261C             (dragondos_mmc.asm):02814                 BNE     LCEAA
                      (dragondos_mmc.asm):02815         
                      (dragondos_mmc.asm):02816         ; Note U must still be $FFFF here so that FindFSNinU won't stop too soon.
                      (dragondos_mmc.asm):02817                 
CD39 BDC9A4           (dragondos_mmc.asm):02818                 JSR     >FindFSNinU             ; Go find File sector no in U
CD3C 26F0             (dragondos_mmc.asm):02819                 BNE     LCE83
                      (dragondos_mmc.asm):02820                 
CD3E F60682           (dragondos_mmc.asm):02821                 LDB     DosCurFileNo            ; get file number
CD41 E7881E           (dragondos_mmc.asm):02822                 STB     FCBDirNoLast,X          ; save in FCB
                      (dragondos_mmc.asm):02823                 
CD44 A6C818           (dragondos_mmc.asm):02824         LCE99   LDA     DirEntLastBytes,U       ; get bytes in last sector
CD47 A78812           (dragondos_mmc.asm):02825                 STA     FCBFileLen+2,X          ; add to file length
CD4A FE066B           (dragondos_mmc.asm):02826                 LDU     DosTotalSFound
CD4D 4D               (dragondos_mmc.asm):02827                 TSTA                            ; 0 bytes in last sector ?
CD4E 2702             (dragondos_mmc.asm):02828                 BEQ     LCEA7                   ; yep skip ahead
                      (dragondos_mmc.asm):02829                 
CD50 335F             (dragondos_mmc.asm):02830                 LEAU    -1,U                    ; decrement total sectors found
CD52 EF8810           (dragondos_mmc.asm):02831         LCEA7   STU     FCBFileLen,X            ; set file len
CD55 5F               (dragondos_mmc.asm):02832         LCEAA   CLRB                            ; no error
CD56 39               (dragondos_mmc.asm):02833         LCEAB   RTS
                      (dragondos_mmc.asm):02834         
                      (dragondos_mmc.asm):02835         ;
                      (dragondos_mmc.asm):02836         ; Convert an FCB number to it's address.
                      (dragondos_mmc.asm):02837         ;
                      (dragondos_mmc.asm):02838         ; Entry :
                      (dragondos_mmc.asm):02839         ;       A       = FCB number 0..9
                      (dragondos_mmc.asm):02840         ;
                      (dragondos_mmc.asm):02841         ; Exit :
                      (dragondos_mmc.asm):02842         ;       X       = address of FCB
                      (dragondos_mmc.asm):02843         ;       D,U,Y   = preserved
                      (dragondos_mmc.asm):02844         ;
                      (dragondos_mmc.asm):02845         
CD57                  (dragondos_mmc.asm):02846         DosFCBNoToAddr   
CD57 3406             (dragondos_mmc.asm):02847                 PSHS    D
CD59 96F1             (dragondos_mmc.asm):02848                 LDA     <DosCurrCtrlBlk         ; get current FCB no
CD5B C61F             (dragondos_mmc.asm):02849                 LDB     #DosFCBLength           ; work out offset into table
CD5D 3D               (dragondos_mmc.asm):02850                 MUL
CD5E 1F01             (dragondos_mmc.asm):02851                 TFR     D,X                     ; get offset into X
CD60 308906BD         (dragondos_mmc.asm):02852                 LEAX    DosFCB0Addr,X           ; work out address of FCB
CD64 3586             (dragondos_mmc.asm):02853                 PULS    D,PC
                      (dragondos_mmc.asm):02854         
                      (dragondos_mmc.asm):02855         ;
                      (dragondos_mmc.asm):02856         ; Close All open files and clean up buffers for one drive.
                      (dragondos_mmc.asm):02857         ;
                      (dragondos_mmc.asm):02858         ; This should be called four times when basic returns to the "OK" 
                      (dragondos_mmc.asm):02859         ; prompt.
                      (dragondos_mmc.asm):02860         ;
                      (dragondos_mmc.asm):02861         ; Note: only closes files on the current disk (in DosDriveNo).
                      (dragondos_mmc.asm):02862         ;
                      (dragondos_mmc.asm):02863         ; Entry:
                      (dragondos_mmc.asm):02864         ;
                      (dragondos_mmc.asm):02865         ;       DosDriveNo      = drive no to close files on.
                      (dragondos_mmc.asm):02866         ;
                      (dragondos_mmc.asm):02867         ; Returns:
                      (dragondos_mmc.asm):02868         ;       B               = Error code.
                      (dragondos_mmc.asm):02869         ;
                      (dragondos_mmc.asm):02870         
CD66                  (dragondos_mmc.asm):02871         DOSCloseAll   
CD66 860A             (dragondos_mmc.asm):02872                 LDA     #DosNumFCBs             ; do all FCBs
CD68 97F1             (dragondos_mmc.asm):02873                 STA     <DosCurrCtrlBlk         ; set current FCB no
                      (dragondos_mmc.asm):02874                 
CD6A 8DEB             (dragondos_mmc.asm):02875         LCEBF   BSR     DosFCBNoToAddr          ; Get FCB address
CD6C A60B             (dragondos_mmc.asm):02876                 LDA     FCBDrive,X              ; get drive from FCB 
CD6E 91EB             (dragondos_mmc.asm):02877                 CMPA    <DosDriveNo             ; same as current drive ?
CD70 2604             (dragondos_mmc.asm):02878                 BNE     LCECB                   ; nope skip on
                      (dragondos_mmc.asm):02879                 
CD72 8D0A             (dragondos_mmc.asm):02880                 BSR     DosCloseFile2           ; close the file
CD74 26E0             (dragondos_mmc.asm):02881                 BNE     LCEAB                   ; error : exit
                      (dragondos_mmc.asm):02882         
CD76 0AF1             (dragondos_mmc.asm):02883         LCECB   DEC     <DosCurrCtrlBlk         ; do next block
CD78 2AF0             (dragondos_mmc.asm):02884                 BPL     LCEBF                   ; if more loop again
CD7A 5F               (dragondos_mmc.asm):02885         LCECF   CLRB
CD7B 39               (dragondos_mmc.asm):02886                 RTS
                      (dragondos_mmc.asm):02887         
                      (dragondos_mmc.asm):02888         ;
                      (dragondos_mmc.asm):02889         ; Close a single file.
                      (dragondos_mmc.asm):02890         ;
                      (dragondos_mmc.asm):02891         ; Entry:
                      (dragondos_mmc.asm):02892         ;       A       = FCB no to close.
                      (dragondos_mmc.asm):02893         ;
                      (dragondos_mmc.asm):02894         ; Exit:
                      (dragondos_mmc.asm):02895         ;       B       = Error code.
                      (dragondos_mmc.asm):02896         ;
                      (dragondos_mmc.asm):02897         ; If this was the last file open for that drive, it will call cleanup for all
                      (dragondos_mmc.asm):02898         ; pages associated with that drive, and then invalidate them. The directory
                      (dragondos_mmc.asm):02899         ; track for that drive is then backed up.
                      (dragondos_mmc.asm):02900         ;
                      (dragondos_mmc.asm):02901         
CD7C                  (dragondos_mmc.asm):02902         DOSCloseFile   
CD7C 97F1             (dragondos_mmc.asm):02903                 STA     <DosCurrCtrlBlk         ; set current FCB no
                      (dragondos_mmc.asm):02904         
CD7E                  (dragondos_mmc.asm):02905         DosCloseFile2   
CD7E 8DD7             (dragondos_mmc.asm):02906                 BSR     DosFCBNoToAddr          ; Get FCB address
CD80 6D84             (dragondos_mmc.asm):02907                 TST     ,X                      ; is first character of filename zero ?
CD82 27F6             (dragondos_mmc.asm):02908                 BEQ     LCECF                   ; yes : return
                      (dragondos_mmc.asm):02909                 
CD84 96EB             (dragondos_mmc.asm):02910                 LDA     <DosDriveNo             ; save current drive on stack
CD86 3402             (dragondos_mmc.asm):02911                 PSHS    A
CD88 A60B             (dragondos_mmc.asm):02912                 LDA     FCBDrive,X              ; get drive from FCB 
CD8A 97EB             (dragondos_mmc.asm):02913                 STA     <DosDriveNo             ; make it current
CD8C 6F84             (dragondos_mmc.asm):02914                 CLR     ,X                      ; zero out first char of filename 
                      (dragondos_mmc.asm):02915                 
CD8E BDD028           (dragondos_mmc.asm):02916                 JSR     >DosGetDiskGeometry     ; get disk geometry
CD91 2626             (dragondos_mmc.asm):02917                 BNE     DOSCloseFileExit                        ; error : exit
                      (dragondos_mmc.asm):02918                 
CD93 6D05             (dragondos_mmc.asm):02919                 TST     DrvDetUseCnt,X          ; Number of files in use on this drive
CD95 2707             (dragondos_mmc.asm):02920                 BEQ     LCEF3                   ; branch if zero
                      (dragondos_mmc.asm):02921                 
CD97 6A05             (dragondos_mmc.asm):02922                 DEC     DrvDetUseCnt,X          ; else decrement file in use count
CD99 2703             (dragondos_mmc.asm):02923                 BEQ     LCEF3                   ; again test for zero
                      (dragondos_mmc.asm):02924                 
CD9B 5F               (dragondos_mmc.asm):02925                 CLRB                            ; flag no error
CD9C 201B             (dragondos_mmc.asm):02926                 BRA     DOSCloseFileExit        ; and exit
                      (dragondos_mmc.asm):02927         
                      (dragondos_mmc.asm):02928         ; clean up the drive
CD9E E602             (dragondos_mmc.asm):02929         LCEF3   LDB     DrvDetFreeLen,X         ; get free length byte
CDA0 270D             (dragondos_mmc.asm):02930                 BEQ     LCF04                   ; branch if zero
                      (dragondos_mmc.asm):02931                 
CDA2 3410             (dragondos_mmc.asm):02932                 PSHS    X                       ; save buffer ptr
CDA4 AE03             (dragondos_mmc.asm):02933                 LDX     DrvDetFreeEPtr,X        ; get free extent pointer
CDA6 BDCEBD           (dragondos_mmc.asm):02934                 JSR     >DeleteExtent           ; and delete it
                      (dragondos_mmc.asm):02935                 
CDA9 3510             (dragondos_mmc.asm):02936                 PULS    X                       ; recover buffer ptr
CDAB 260C             (dragondos_mmc.asm):02937                 BNE     DOSCloseFileExit        ; branch if error
                      (dragondos_mmc.asm):02938                 
CDAD 6F02             (dragondos_mmc.asm):02939                 CLR     DrvDetFreeLen,X         ; free length byte
CDAF BDC5E5           (dragondos_mmc.asm):02940         LCF04   JSR     >DOSSyncDir             ; Syncronise directory tracks
                      (dragondos_mmc.asm):02941                 
                      (dragondos_mmc.asm):02942         ; Invalidate drive table so user can swap disks now.    
CDB2 CE0696           (dragondos_mmc.asm):02943                 LDU     #DosD0Online-1          ; point to drive online table
CDB5 96EB             (dragondos_mmc.asm):02944                 LDA     <DosDriveNo             ; mark FCB's drive as inactive
CDB7 6FC6             (dragondos_mmc.asm):02945                 CLR     A,U
                      (dragondos_mmc.asm):02946                 
CDB9                  (dragondos_mmc.asm):02947         DOSCloseFileExit   
CDB9 3502             (dragondos_mmc.asm):02948                 PULS    A                       ; recover acive drive at call
CDBB 97EB             (dragondos_mmc.asm):02949                 STA     <DosDriveNo             ; restore it
CDBD 5D               (dragondos_mmc.asm):02950                 TSTB                            ; set flags for error
CDBE 39               (dragondos_mmc.asm):02951         LCF13   RTS
                      (dragondos_mmc.asm):02952         
                      (dragondos_mmc.asm):02953         ;
                      (dragondos_mmc.asm):02954         ; Create a file.
                      (dragondos_mmc.asm):02955         ;
                      (dragondos_mmc.asm):02956         ; If a file exists with the supplied name, is is renamed with a ".BAK" extension.
                      (dragondos_mmc.asm):02957         ; If there is already a ".BAK" file then it is first deleted.
                      (dragondos_mmc.asm):02958         ; DOSRCreateFile is called for the real creation.
                      (dragondos_mmc.asm):02959         ;
                      (dragondos_mmc.asm):02960         ; Entry:        
                      (dragondos_mmc.asm):02961         ;       A       = File number
                      (dragondos_mmc.asm):02962         ;
                      (dragondos_mmc.asm):02963         ; Exit:
                      (dragondos_mmc.asm):02964         ;       B       = Error code
                      (dragondos_mmc.asm):02965         ;
                      (dragondos_mmc.asm):02966         
CDBF                  (dragondos_mmc.asm):02967         DOSCreateFile   
CDBF B7067D           (dragondos_mmc.asm):02968                 STA     DosTempFCBNo            ; save file number
CDC2 BDCD57           (dragondos_mmc.asm):02969                 JSR     >DosFCBNoToAddr         ; get file's address
CDC5 BF0678           (dragondos_mmc.asm):02970                 STX     DosSaveFCB              ; save it's FCB address
                      (dragondos_mmc.asm):02971                 
CDC8 C60C             (dragondos_mmc.asm):02972                 LDB     #8+3+1                  ; Length of name,extension,drive
CDCA CE0650           (dragondos_mmc.asm):02973                 LDU     #DosCurDriveInfo        ; point at current drive info
CDCD A680             (dragondos_mmc.asm):02974         LCF22   LDA     ,X+                     ; get a byte from FCB
CDCF A7C0             (dragondos_mmc.asm):02975                 STA     ,U+                     ; save in current drive info
CDD1 5A               (dragondos_mmc.asm):02976                 DECB                            ; decrement count
CDD2 26F9             (dragondos_mmc.asm):02977                 BNE     LCF22                   ; loop if more to do
                      (dragondos_mmc.asm):02978                 
CDD4 EC5C             (dragondos_mmc.asm):02979                 LDD     -4,U                    ; get and save current extension
CDD6 FD067A           (dragondos_mmc.asm):02980                 STD     DosSaveExt
CDD9 A65E             (dragondos_mmc.asm):02981                 LDA     -2,U
CDDB B7067C           (dragondos_mmc.asm):02982                 STA     DosSaveExt+2
                      (dragondos_mmc.asm):02983                 
CDDE CC4241           (dragondos_mmc.asm):02984                 LDD     #"BA"                   ; set current extension to "BAK"
CDE1 ED5C             (dragondos_mmc.asm):02985                 STD     -4,U
CDE3 864B             (dragondos_mmc.asm):02986                 LDA     #'K'
CDE5 A75E             (dragondos_mmc.asm):02987                 STA     -2,U
                      (dragondos_mmc.asm):02988                 
CDE7 6D03             (dragondos_mmc.asm):02989                 TST     (FCBDirFlags-12),X      ; because X no longer points at beginning of FCB!
CDE9 2B29             (dragondos_mmc.asm):02990                 BMI     LCF69                   ; flags minus....brnach :)
                      (dragondos_mmc.asm):02991                 
CDEB BDC727           (dragondos_mmc.asm):02992                 JSR     >DOSOpenFile            ; Try opening 'FILENAME.BAK'
CDEE C1A0             (dragondos_mmc.asm):02993                 CMPB    #ErrNE                  ; test if we got file doesn't exist error? 
                      (dragondos_mmc.asm):02994                 
CDF0 270A             (dragondos_mmc.asm):02995                 BEQ     LCF51                   ; correct place to go
                      (dragondos_mmc.asm):02996                 
CDF2 5D               (dragondos_mmc.asm):02997                 TSTB                            ; test for error
CDF3 26C9             (dragondos_mmc.asm):02998                 BNE     LCF13                   ; if error return
                      (dragondos_mmc.asm):02999                 
CDF5 BDCE61           (dragondos_mmc.asm):03000                 JSR     >DOSDeleteFile          ; else delete the current BAK file
CDF8 26C4             (dragondos_mmc.asm):03001                 BNE     LCF13                   ; if error return
                      (dragondos_mmc.asm):03002                 
CDFA 300C             (dragondos_mmc.asm):03003         LCF4F   leax    12,x                    ; Move FCB pointer forward
CDFC 6F14             (dragondos_mmc.asm):03004         LCF51   clr     -12,x                   ; clear first char of filename
CDFE BDDD4D           (dragondos_mmc.asm):03005                 JSR     LDFCA
CE01 2711             (dragondos_mmc.asm):03006                 BEQ     LCF69
                      (dragondos_mmc.asm):03007                 
CE03 BDCF7A           (dragondos_mmc.asm):03008                 JSR     >DOSRename              ; rename original file to bak.
CE06 2704             (dragondos_mmc.asm):03009                 BEQ     LCF61                   ; no error, branch on
                      (dragondos_mmc.asm):03010                 
CE08 C19C             (dragondos_mmc.asm):03011                 CMPB    #ErrFF                  ; is it ?? error !!!!
CE0A 26B2             (dragondos_mmc.asm):03012                 BNE     LCF13                   ; no : exit
                      (dragondos_mmc.asm):03013         
CE0C B6067D           (dragondos_mmc.asm):03014         LCF61   LDA     DosTempFCBNo            ; get temp fileno
CE0F BDCD7C           (dragondos_mmc.asm):03015                 JSR     >DOSCloseFile           ; close the file
CE12 26AA             (dragondos_mmc.asm):03016                 BNE     LCF13                   ; error, exit
                      (dragondos_mmc.asm):03017                 
CE14 FC067A           (dragondos_mmc.asm):03018         LCF69   LDD     DosSaveExt              ; restore original extension
CE17 FD0658           (dragondos_mmc.asm):03019                 STD     DosCurExtension
CE1A B6067C           (dragondos_mmc.asm):03020                 LDA     DosSaveExt+2
CE1D B7065A           (dragondos_mmc.asm):03021                 STA     DosCurExtension+2
                      (dragondos_mmc.asm):03022                 
CE20 BDC727           (dragondos_mmc.asm):03023                 JSR     >DOSOpenFile            ; try opening file
CE23 2704             (dragondos_mmc.asm):03024                 BEQ     DOSRawCreate            ; no error, skip
                      (dragondos_mmc.asm):03025                 
CE25 C1A0             (dragondos_mmc.asm):03026                 CMPB    #ErrNE                  ; is it file does not exist error?
CE27 2695             (dragondos_mmc.asm):03027                 BNE     LCF13                   ; no, exit
                      (dragondos_mmc.asm):03028                 
                      (dragondos_mmc.asm):03029         ;
                      (dragondos_mmc.asm):03030         ; Raw create
                      (dragondos_mmc.asm):03031         ;
                      (dragondos_mmc.asm):03032         ; Entry:
                      (dragondos_mmc.asm):03033         ;       A       = file no
                      (dragondos_mmc.asm):03034         ;
                      (dragondos_mmc.asm):03035         ; Exit:
                      (dragondos_mmc.asm):03036         ;       B       = Error code
                      (dragondos_mmc.asm):03037         ;
                      (dragondos_mmc.asm):03038         ;       
                      (dragondos_mmc.asm):03039                 
CE29                  (dragondos_mmc.asm):03040         DOSRawCreate   
CE29 97F1             (dragondos_mmc.asm):03041                 STA     <DosCurrCtrlBlk         ; save fileno as current
CE2B BDCD57           (dragondos_mmc.asm):03042                 JSR     >DosFCBNoToAddr         ; get it's FCB address
                      (dragondos_mmc.asm):03043                 
CE2E 6D0F             (dragondos_mmc.asm):03044                 TST     FCBDirFlags,X           ; test FCB's flags
CE30 2B03             (dragondos_mmc.asm):03045                 BMI     LCF8A                   ; 
                      (dragondos_mmc.asm):03046                  
CE32 C69E             (dragondos_mmc.asm):03047                 LDB     #ErrFE                  ; flag file exists.....
CE34 39               (dragondos_mmc.asm):03048         LCF89   RTS
                      (dragondos_mmc.asm):03049         
CE35 4F               (dragondos_mmc.asm):03050         LCF8A   CLRA                            ; clear, flag normal filename block wanted
CE36 BDCFA7           (dragondos_mmc.asm):03051                 JSR     >FindEmptyDir           ; find an empty filename block in directory 
CE39 26F9             (dragondos_mmc.asm):03052                 BNE     LCF89                   ; error, exit
                      (dragondos_mmc.asm):03053                 
CE3B BDCD57           (dragondos_mmc.asm):03054                 JSR     >DosFCBNoToAddr         ; get address of FCB
CE3E A7881D           (dragondos_mmc.asm):03055                 STA     FCBDiskFileNo,X         ; save filenumber in FCB
CE41 A7881E           (dragondos_mmc.asm):03056                 STA     FCBDirNoLast,X
                      (dragondos_mmc.asm):03057                 
                      (dragondos_mmc.asm):03058         ;clear out FCB extents  
CE44 C61C             (dragondos_mmc.asm):03059                 LDB     #FCBSecExtent2          ; point to end of second FCB extent
CE46 6F85             (dragondos_mmc.asm):03060         LCF9B   CLR     B,X                     ; clear a byte  
CE48 5A               (dragondos_mmc.asm):03061                 DECB                            ; decrement offset
CE49 C10C             (dragondos_mmc.asm):03062                 CMPB    #FCBFilePointer         ; reached FCB file pointer
CE4B 24F9             (dragondos_mmc.asm):03063                 BCC     LCF9B                   ; nope, loop again
                      (dragondos_mmc.asm):03064                 
CE4D C618             (dragondos_mmc.asm):03065                 LDB     #DirEntryLen-1          ; clear bytes in DIR entry
CE4F 6FC5             (dragondos_mmc.asm):03066         LCFA4   CLR     B,U                     ; clear a byte
                      (dragondos_mmc.asm):03067         
CE51                  (dragondos_mmc.asm):03068         CmdRenameMC
CE51 5A               (dragondos_mmc.asm):03069                 DECB                            ; decrement count       
CE52 2AFB             (dragondos_mmc.asm):03070                 BPL     LCFA4                   ; keep going until all done
                      (dragondos_mmc.asm):03071                 
CE54 3341             (dragondos_mmc.asm):03072                 LEAU    DirEntFilename,U        ; point at dir entry filename
CE56 C60B             (dragondos_mmc.asm):03073                 LDB     #8+3                    ; length of filename + ext
CE58 A680             (dragondos_mmc.asm):03074         LCFAD   LDA     ,X+                     ; get a byte from FCB
CE5A A7C0             (dragondos_mmc.asm):03075                 STA     ,U+                     ; put in dir entry
CE5C 5A               (dragondos_mmc.asm):03076                 DECB                            ; decrement count
CE5D 26F9             (dragondos_mmc.asm):03077                 BNE     LCFAD                   ; loop if not all done
                      (dragondos_mmc.asm):03078                 
CE5F 5F               (dragondos_mmc.asm):03079                 CLRB                            ; flag no error
CE60 39               (dragondos_mmc.asm):03080         LCFB5   RTS                             ; return
                      (dragondos_mmc.asm):03081         
                      (dragondos_mmc.asm):03082         ;
                      (dragondos_mmc.asm):03083         ; Delete a file from disk.
                      (dragondos_mmc.asm):03084         ;
                      (dragondos_mmc.asm):03085         ; Entry:
                      (dragondos_mmc.asm):03086         ;       A       = filenumber
                      (dragondos_mmc.asm):03087         ;
                      (dragondos_mmc.asm):03088         ; Exit:
                      (dragondos_mmc.asm):03089         ;       B       = Error code
                      (dragondos_mmc.asm):03090         ;
                      (dragondos_mmc.asm):03091         
CE61                  (dragondos_mmc.asm):03092         DOSDeleteFile   
CE61 BDCF67           (dragondos_mmc.asm):03093                 JSR     >DosCheckProtect        ; check file protection
CE64 26FA             (dragondos_mmc.asm):03094                 BNE     LCFB5                   ; error, return
                      (dragondos_mmc.asm):03095                 
CE66 3410             (dragondos_mmc.asm):03096                 PSHS    X                       ; save FCB pointer
CE68 E6881D           (dragondos_mmc.asm):03097                 LDB     FCBDiskFileNo,X         ; get disk file  number
CE6B BDD0B3           (dragondos_mmc.asm):03098                 JSR     >DOSGetDirEntry2        ; Get dir entry 
CE6E 2647             (dragondos_mmc.asm):03099                 BNE     LD00C                   ; error, cleanup and exit
                      (dragondos_mmc.asm):03100                 
CE70 1F13             (dragondos_mmc.asm):03101                 TFR     X,U                     ; save dir entry pointer in U
CE72 3510             (dragondos_mmc.asm):03102                 PULS    X                       ; restore FCB pointer
                      (dragondos_mmc.asm):03103                 
CE74 314C             (dragondos_mmc.asm):03104                 LEAY    DirEntFnBlock1,U        ; point Y to first allocation block     
CE76 C604             (dragondos_mmc.asm):03105                 LDB     #$04
CE78 A6C4             (dragondos_mmc.asm):03106         LCFCD   LDA     DirEntAttr,U            ; get attributes from directory entry
CE7A 8420             (dragondos_mmc.asm):03107                 ANDA    #AttrContinued          ; is this a continuation block?
CE7C 2703             (dragondos_mmc.asm):03108                 BEQ     LCFD6
                      (dragondos_mmc.asm):03109                 
CE7E A6C818           (dragondos_mmc.asm):03110                 LDA     DirEntFlag,U            ; get block no of continuation entries
CE81 3406             (dragondos_mmc.asm):03111         LCFD6   PSHS    D                       ; save D
CE83 C681             (dragondos_mmc.asm):03112                 LDB     #AttrAfterDel           ; invalidate block
CE85 E7C4             (dragondos_mmc.asm):03113                 STB     ,U
                      (dragondos_mmc.asm):03114                 
CE87 3410             (dragondos_mmc.asm):03115                 PSHS    X                       ; save FCB pointer
                      (dragondos_mmc.asm):03116                 
CE89 AEA1             (dragondos_mmc.asm):03117         LCFDE   LDX     ,Y++                    ; get allocation LSN
CE8B E6A0             (dragondos_mmc.asm):03118                 LDB     ,Y+                     ; get allocation sector count
CE8D 270A             (dragondos_mmc.asm):03119                 BEQ     LCFEE                   ; branch if zero sectors, end of allocations
                      (dragondos_mmc.asm):03120                 
CE8F 3420             (dragondos_mmc.asm):03121                 PSHS    Y                       ; save allocation entry pointer
CE91 8D2A             (dragondos_mmc.asm):03122                 BSR     DeleteExtent            ; delete the extent
CE93 3520             (dragondos_mmc.asm):03123                 PULS    Y                       ; restore allocation entry pointer
CE95 1026FA01         (dragondos_mmc.asm):03124                 LBNE    DosFReadErrorExit       ; cleanup and exit if error
                      (dragondos_mmc.asm):03125                 
CE99 6A63             (dragondos_mmc.asm):03126         LCFEE   DEC     3,S                     ; decrement entry count
CE9B 26EC             (dragondos_mmc.asm):03127                 BNE     LCFDE                   ; loop again if more entries in this dir block
                      (dragondos_mmc.asm):03128                 
CE9D 3510             (dragondos_mmc.asm):03129                 PULS    X                       ; restore FCB pointer
CE9F E6E4             (dragondos_mmc.asm):03130                 LDB     ,S                      ; get more extents flag
CEA1 2713             (dragondos_mmc.asm):03131                 BEQ     LD00B                   ; exit if no more extents
                      (dragondos_mmc.asm):03132                 
CEA3 3262             (dragondos_mmc.asm):03133                 LEAS    2,S                     ; drop counter and flags
CEA5 3410             (dragondos_mmc.asm):03134                 PSHS    X                       ; save FCB pointer
CEA7 BDD0B3           (dragondos_mmc.asm):03135                 JSR     >DOSGetDirEntry2        ; get next directory block      
CEAA 1F13             (dragondos_mmc.asm):03136                 TFR     X,U                     ; put pointer to dir block in U
CEAC 3510             (dragondos_mmc.asm):03137                 PULS    X                       ; restore FCB pointer
CEAE 26B0             (dragondos_mmc.asm):03138                 BNE     LCFB5                   ; branch if errors in DOSGetDirEntry2
                      (dragondos_mmc.asm):03139                 
CEB0 3141             (dragondos_mmc.asm):03140                 LEAY    DirEntCntBlock1,U       ; point to first allocation in continuation block
CEB2 C607             (dragondos_mmc.asm):03141                 LDB     #DirEntCntExts          ; initilize number of allocations count
CEB4 20C2             (dragondos_mmc.asm):03142                 BRA     LCFCD                   ; go delete them
                      (dragondos_mmc.asm):03143         
CEB6 5F               (dragondos_mmc.asm):03144         LD00B   CLRB                            ; flag no error
CEB7 0FF6             (dragondos_mmc.asm):03145         LD00C   CLR     <DosIOInProgress        ; flag no dos io in progress
CEB9 3262             (dragondos_mmc.asm):03146                 LEAS    2,S                     ; clen up stack
CEBB 5D               (dragondos_mmc.asm):03147                 TSTB                            ; set CC.C on error
CEBC 39               (dragondos_mmc.asm):03148                 RTS
                      (dragondos_mmc.asm):03149         ;
                      (dragondos_mmc.asm):03150         ; Delete one extent.
                      (dragondos_mmc.asm):03151         ;
                      (dragondos_mmc.asm):03152         ; Called by DOSDeleteFile (amongst others). Marks one extent's worth of sectors
                      (dragondos_mmc.asm):03153         ; free.
                      (dragondos_mmc.asm):03154         ;
                      (dragondos_mmc.asm):03155         ; Entry:
                      (dragondos_mmc.asm):03156         ;       B       = Number of sectors.
                      (dragondos_mmc.asm):03157         ;       X       = starting LSN.
                      (dragondos_mmc.asm):03158         ;
                      (dragondos_mmc.asm):03159         ; Exit:
                      (dragondos_mmc.asm):03160         ;       B       = Error code.
                      (dragondos_mmc.asm):03161         ;
                      (dragondos_mmc.asm):03162         ;
                      (dragondos_mmc.asm):03163         ; stack frame
                      (dragondos_mmc.asm):03164         ;       4,s     0
                      (dragondos_mmc.asm):03165         ;       2,s     LSN to delete
                      (dragondos_mmc.asm):03166         ;       0,s     Sector count
                      (dragondos_mmc.asm):03167         ;
                      (dragondos_mmc.asm):03168         
CEBD                  (dragondos_mmc.asm):03169         DeleteExtent   
CEBD 4F               (dragondos_mmc.asm):03170                 CLRA                            ; clear A, makes D=sector count
CEBE 3402             (dragondos_mmc.asm):03171                 PSHS    A                       ; save A
CEC0 3416             (dragondos_mmc.asm):03172                 PSHS    D,X                     ; save sector count and LSN
                      (dragondos_mmc.asm):03173                 
CEC2 BDD028           (dragondos_mmc.asm):03174                 JSR     >DosGetDiskGeometry     ; get the geometry of the disk
CEC5 267E             (dragondos_mmc.asm):03175                 BNE     DeleteExtentExit        ; error, exit
                      (dragondos_mmc.asm):03176                 
CEC7 10AE84           (dragondos_mmc.asm):03177                 LDY     DrvDetDirLSN,X          ; get LSN of directory  
CECA EC62             (dragondos_mmc.asm):03178                 LDD     2,S                     ; get LSN of extent to delete
CECC 8305A0           (dragondos_mmc.asm):03179                 SUBD    #BAMLSNPerSec           ; subtract BAM entries in first BAM sector
CECF 250B             (dragondos_mmc.asm):03180                 BCS     LD031                   ; branch if in first sector (-ve result)
                      (dragondos_mmc.asm):03181                 
CED1 3121             (dragondos_mmc.asm):03182                 LEAY    1,Y                     ; move to next BAM sector
                      (dragondos_mmc.asm):03183                 
CED3 ED62             (dragondos_mmc.asm):03184                 STD     2,S                     ; save offset within BAM                        
CED5 E3E4             (dragondos_mmc.asm):03185                 ADDD    ,S                      ; add sector count
CED7 8305A0           (dragondos_mmc.asm):03186                 SUBD    #BAMLSNPerSec           ; subtract BAM entries in first BAM sector
CEDA 2467             (dragondos_mmc.asm):03187                 BCC     LD098                   ; error allocation overflows BAMs 
                      (dragondos_mmc.asm):03188                 
CEDC EC62             (dragondos_mmc.asm):03189         LD031   LDD     2,S                     ; get LSN of extent to delete
CEDE E3E4             (dragondos_mmc.asm):03190                 ADDD    ,S                      ; add number of sectors to delete
CEE0 8305A0           (dragondos_mmc.asm):03191                 SUBD    #BAMLSNPerSec           ; subtract BAM entries in first BAM sector
CEE3 2507             (dragondos_mmc.asm):03192                 BCS     LD041                   ; branch if in first BAM sector
                      (dragondos_mmc.asm):03193                 
CEE5 E764             (dragondos_mmc.asm):03194                 STB     4,S                     ; calc no of sectors in second BAM
CEE7 50               (dragondos_mmc.asm):03195                 NEGB
CEE8 EB61             (dragondos_mmc.asm):03196                 ADDB    1,S
CEEA E761             (dragondos_mmc.asm):03197                 STB     1,S
                      (dragondos_mmc.asm):03198                 
CEEC BDD0F2           (dragondos_mmc.asm):03199         LD041   JSR     >DOSFindAndRead         ; read required BAM sector
CEEF 2654             (dragondos_mmc.asm):03200                 BNE     DeleteExtentExit        ; error, exit
                      (dragondos_mmc.asm):03201                 
CEF1 86FF             (dragondos_mmc.asm):03202                 LDA     #BuffDirty              ; mark BAM sector buffer dirty
CEF3 A702             (dragondos_mmc.asm):03203                 STA     2,X
                      (dragondos_mmc.asm):03204                 
CEF5 EC62             (dragondos_mmc.asm):03205                 LDD     2,S                     ; get LSN to delete from
CEF7 44               (dragondos_mmc.asm):03206                 LSRA                            ; divide LSN by 8, to get the byte needed
CEF8 56               (dragondos_mmc.asm):03207                 RORB
CEF9 66E4             (dragondos_mmc.asm):03208                 ROR     ,S
CEFB 44               (dragondos_mmc.asm):03209                 LSRA
CEFC 56               (dragondos_mmc.asm):03210                 RORB
CEFD 66E4             (dragondos_mmc.asm):03211                 ROR     ,S
CEFF 44               (dragondos_mmc.asm):03212                 LSRA
CF00 56               (dragondos_mmc.asm):03213                 RORB
CF01 66E4             (dragondos_mmc.asm):03214                 ROR     ,S
                      (dragondos_mmc.asm):03215                 
                      (dragondos_mmc.asm):03216         ; this leaves the byte at 0,s with the bottom 3 bits of D in the *TOP* 3 bits
                      (dragondos_mmc.asm):03217         ; so in the loop below we need to decrement by $20 each loop, rather than 1.
                      (dragondos_mmc.asm):03218         ; e.g.
                      (dragondos_mmc.asm):03219         ; D=bbbb bbbb bbbb bbbb  0,S=0000 0000  before shift
                      (dragondos_mmc.asm):03220         ; D=000b bbbb bbbb bbbb  0,S=bbb0 0000  after shift
                      (dragondos_mmc.asm):03221         ;
                      (dragondos_mmc.asm):03222                 
CF03 AE05             (dragondos_mmc.asm):03223                 LDX     BuffAddr,X              ; get address of BAM buffer
CF05 3A               (dragondos_mmc.asm):03224                 ABX                             ; add calculated offset
                      (dragondos_mmc.asm):03225                 
CF06 C601             (dragondos_mmc.asm):03226                 LDB     #$01                    ; get bitmap 
CF08 A6E4             (dragondos_mmc.asm):03227                 LDA     ,S                      ; get bit number
CF0A 2705             (dragondos_mmc.asm):03228                 BEQ     LD066                   ; zero, exit loop
                      (dragondos_mmc.asm):03229                 
CF0C 58               (dragondos_mmc.asm):03230         LD061   ASLB                            ; shift bit number left
CF0D 8020             (dragondos_mmc.asm):03231                 SUBA    #$20                    ; we take $20, because of shift above   
CF0F 26FB             (dragondos_mmc.asm):03232                 BNE     LD061                   ; loop if not zero
                      (dragondos_mmc.asm):03233         
CF11 E7E4             (dragondos_mmc.asm):03234         LD066   STB     ,S                      ; 0,S now contains starting bit
CF13 E661             (dragondos_mmc.asm):03235                 LDB     1,S                     ; get sector count
                      (dragondos_mmc.asm):03236                 
CF15 A6E4             (dragondos_mmc.asm):03237         LD06A   LDA     ,S                      ; get bitmask 
CF17 AA84             (dragondos_mmc.asm):03238                 ORA     ,X                      ; or it with BAM, deallocate sector
CF19 A784             (dragondos_mmc.asm):03239                 STA     ,X                      ; put back in BAM
CF1B 5A               (dragondos_mmc.asm):03240                 DECB                            ; decrement sector count
CF1C 2718             (dragondos_mmc.asm):03241                 BEQ     LD08B                   ; branch if no more sectors
                      (dragondos_mmc.asm):03242                 
CF1E 68E4             (dragondos_mmc.asm):03243                 ASL     ,S                      ; shift mask left
CF20 24F3             (dragondos_mmc.asm):03244                 BCC     LD06A                   ; skip if mask not shifted into carry
                      (dragondos_mmc.asm):03245                 
CF22 8601             (dragondos_mmc.asm):03246                 LDA     #$01                    ; re-initialize mask
CF24 A7E4             (dragondos_mmc.asm):03247                 STA     ,S                      
CF26 3001             (dragondos_mmc.asm):03248                 LEAX    1,X                     ; move to next BAM byte
                      (dragondos_mmc.asm):03249                 
                      (dragondos_mmc.asm):03250         ; check to see if we have more than 16 LSNs left to delete, if so do them quickly
                      (dragondos_mmc.asm):03251         ; by marking groups of 16 sectors free.....
                      (dragondos_mmc.asm):03252                 
CF28 C110             (dragondos_mmc.asm):03253         LD07D   CMPB    #$10                    ; more than 16 sectors left to flag?    
CF2A 25E9             (dragondos_mmc.asm):03254                 BCS     LD06A                   ; no, continue doing a sector at a time
                      (dragondos_mmc.asm):03255                 
CF2C 86FF             (dragondos_mmc.asm):03256                 LDA     #$FF                    ; mark a group of 8 sectors at once
CF2E A780             (dragondos_mmc.asm):03257                 STA     ,X+                     ; mark next 8
CF30 A780             (dragondos_mmc.asm):03258                 STA     ,X+                     ; and next 8
CF32 C010             (dragondos_mmc.asm):03259                 SUBB    #$10                    ; decrement sector count by 16
CF34 26F2             (dragondos_mmc.asm):03260                 BNE     LD07D                   ; loop again
                      (dragondos_mmc.asm):03261                 
CF36 8E05A0           (dragondos_mmc.asm):03262         LD08B   LDX     #BAMLSNPerSec           ; get BAM entries / sec
CF39 3264             (dragondos_mmc.asm):03263                 LEAS    4,S                     ; clean up stack        
CF3B E6E0             (dragondos_mmc.asm):03264                 LDB     ,S+                     ; get count
CF3D 2601             (dragondos_mmc.asm):03265                 BNE     GoDeleteExtent          ; loop again if not zero
CF3F 39               (dragondos_mmc.asm):03266                 RTS
                      (dragondos_mmc.asm):03267         
CF40                  (dragondos_mmc.asm):03268         GoDeleteExtent   
CF40 16FF7A           (dragondos_mmc.asm):03269                 LBRA    DeleteExtent
                      (dragondos_mmc.asm):03270         
CF43 C690             (dragondos_mmc.asm):03271         LD098   LDB     #ErrIV                  ; Error invalid volume
CF45                  (dragondos_mmc.asm):03272         DeleteExtentExit   
CF45 3265             (dragondos_mmc.asm):03273                 LEAS    5,S                     ; clean up stack
CF47 39               (dragondos_mmc.asm):03274         LD09C   RTS                     
                      (dragondos_mmc.asm):03275         
                      (dragondos_mmc.asm):03276         ;
                      (dragondos_mmc.asm):03277         ; Set protection status.
                      (dragondos_mmc.asm):03278         ;
                      (dragondos_mmc.asm):03279         ; Entry:
                      (dragondos_mmc.asm):03280         ;       A       = file number
                      (dragondos_mmc.asm):03281         ;       B       = 1 protect, 0 unprotect
                      (dragondos_mmc.asm):03282         ;
                      (dragondos_mmc.asm):03283         ; Exit:
                      (dragondos_mmc.asm):03284         ;       B       = error code
                      (dragondos_mmc.asm):03285         ; 
                      (dragondos_mmc.asm):03286         
CF48                  (dragondos_mmc.asm):03287         DOSProtectMC
CF48 97F1             (dragondos_mmc.asm):03288         LD09D   STA     <DosCurrCtrlBlk         ; set current file number
CF4A BDCD57           (dragondos_mmc.asm):03289                 JSR     >DosFCBNoToAddr         ; get it's FCB address
                      (dragondos_mmc.asm):03290                 
CF4D A60F             (dragondos_mmc.asm):03291                 LDA     FCBDirFlags,X           ; get flags from dir entry
CF4F 2B26             (dragondos_mmc.asm):03292                 BMI     LD0CC                   ; error.....
                      (dragondos_mmc.asm):03293                 
CF51 5D               (dragondos_mmc.asm):03294                 TSTB                            ; shoud we protect / unprotect?
CF52 2703             (dragondos_mmc.asm):03295                 BEQ     LD0AC                   ; branch if unprotect
                      (dragondos_mmc.asm):03296                 
CF54 8A02             (dragondos_mmc.asm):03297                 ORA     #AttrWriteProt          ; set protection bit
                      (dragondos_mmc.asm):03298         
CF56 8C               (dragondos_mmc.asm):03299                 FCB     Skip2                   ; skip 2 bytes
CF57 84FD             (dragondos_mmc.asm):03300         LD0AC   ANDA    #~AttrWriteProt         ; reset protection bit
CF59 A70F             (dragondos_mmc.asm):03301                 STA     FCBDirFlags,X           ; put back in dir entry
                      (dragondos_mmc.asm):03302                 
CF5B E6881D           (dragondos_mmc.asm):03303                 LDB     FCBDiskFileNo,X         ; get file number on disk
CF5E BDD0B3           (dragondos_mmc.asm):03304                 JSR     >DOSGetDirEntry2        ; go get it's dir enetry
CF61 26E4             (dragondos_mmc.asm):03305                 BNE     LD09C                   ; error, return
                      (dragondos_mmc.asm):03306                 
CF63 A784             (dragondos_mmc.asm):03307                 STA     DirEntAttr,X            ; put it in dir attributes.
CF65 5F               (dragondos_mmc.asm):03308                 CLRB                            ; flag no error
CF66 39               (dragondos_mmc.asm):03309         LD0BB   RTS
                      (dragondos_mmc.asm):03310         
CF67                  (dragondos_mmc.asm):03311         DosCheckProtect   
CF67 97F1             (dragondos_mmc.asm):03312                 STA     <DosCurrCtrlBlk         ; set current file number
CF69 BDCD57           (dragondos_mmc.asm):03313                 JSR     >DosFCBNoToAddr         ; get it's FCB address
                      (dragondos_mmc.asm):03314                 
CF6C A60F             (dragondos_mmc.asm):03315                 LDA     FCBDirFlags,X           ; get flags from dir entry
CF6E 2B07             (dragondos_mmc.asm):03316                 BMI     LD0CC
                      (dragondos_mmc.asm):03317                 
CF70 8502             (dragondos_mmc.asm):03318                 BITA    #AttrWriteProt          ; check write protect attribute
CF72 27F2             (dragondos_mmc.asm):03319                 BEQ     LD0BB                   ; not protected....
CF74 C698             (dragondos_mmc.asm):03320                 LDB     #ErrPT                  ; protection error
CF76 39               (dragondos_mmc.asm):03321                 RTS
                      (dragondos_mmc.asm):03322         
CF77 C69C             (dragondos_mmc.asm):03323         LD0CC   LDB     #ErrFF                  ; return file not found
CF79 39               (dragondos_mmc.asm):03324         LD0CE   RTS
                      (dragondos_mmc.asm):03325         
                      (dragondos_mmc.asm):03326         ;
                      (dragondos_mmc.asm):03327         ; Rename a file.
                      (dragondos_mmc.asm):03328         ;
                      (dragondos_mmc.asm):03329         ; Entry:
                      (dragondos_mmc.asm):03330         ;       DosCurFilename  = newname
                      (dragondos_mmc.asm):03331         ;       A               = fileid
                      (dragondos_mmc.asm):03332         ;
                      (dragondos_mmc.asm):03333         ; Exit:
                      (dragondos_mmc.asm):03334         ;       B               = Error code
                      (dragondos_mmc.asm):03335         ;
                      (dragondos_mmc.asm):03336         
     000B             (dragondos_mmc.asm):03337         FNLength        EQU     8+3             ; filename length
                      (dragondos_mmc.asm):03338         
CF7A                  (dragondos_mmc.asm):03339         DOSRename
CF7A BDCF67           (dragondos_mmc.asm):03340                 JSR     >DosCheckProtect        ; is the file protected?
CF7D 26FA             (dragondos_mmc.asm):03341                 BNE     LD0CE                   ; yep, (or error) exit
                      (dragondos_mmc.asm):03342                 
                      (dragondos_mmc.asm):03343         ; copy name into FCB    
CF7F C60B             (dragondos_mmc.asm):03344                 LDB     #FNLength               ; byte count to copy                    
CF81 CE0650           (dragondos_mmc.asm):03345                 LDU     #DosCurFilename         ; point at new filename
CF84 A6C0             (dragondos_mmc.asm):03346         LD0D9   LDA     ,U+                     ; get a byte from new name
CF86 A780             (dragondos_mmc.asm):03347                 STA     ,X+                     ; copy into FCB
CF88 5A               (dragondos_mmc.asm):03348                 DECB                            ; dec count
CF89 26F9             (dragondos_mmc.asm):03349                 BNE     LD0D9                   ; loop if more to copy
                      (dragondos_mmc.asm):03350                 
CF8B 3015             (dragondos_mmc.asm):03351                 LEAX    -FNLength,X             ; point back at beginning of FCB
CF8D E6881D           (dragondos_mmc.asm):03352                 LDB     FCBDiskFileNo,X         ; get file number on disk
CF90 BDD0B3           (dragondos_mmc.asm):03353                 JSR     >DOSGetDirEntry2        ; go get it's entry
CF93 26E4             (dragondos_mmc.asm):03354                 BNE     LD0CE                   ; error, exit
                      (dragondos_mmc.asm):03355                 
CF95 CE0650           (dragondos_mmc.asm):03356                 LDU     #DosCurFilename         ; point at new name
CF98 C60B             (dragondos_mmc.asm):03357                 LDB     #FNLength               ; byte count to copy
CF9A 3001             (dragondos_mmc.asm):03358                 LEAX    1,X                     ; move past attribute byte
CF9C A6C0             (dragondos_mmc.asm):03359         LD0F1   LDA     ,U+                     ; get a byte from new name
CF9E A780             (dragondos_mmc.asm):03360                 STA     ,X+                     ; save in dir entry
CFA0 5A               (dragondos_mmc.asm):03361                 DECB                            ; decrement count
CFA1 26F9             (dragondos_mmc.asm):03362                 BNE     LD0F1                   ; loop if more
                      (dragondos_mmc.asm):03363                 
CFA3 0FF6             (dragondos_mmc.asm):03364                 CLR     <DosIOInProgress        ; clear IO in progress
CFA5 5F               (dragondos_mmc.asm):03365                 CLRB                            ; flag no error
CFA6 39               (dragondos_mmc.asm):03366         LD0FB   RTS
                      (dragondos_mmc.asm):03367         
                      (dragondos_mmc.asm):03368         ;
                      (dragondos_mmc.asm):03369         ; Find empty directory slot.
                      (dragondos_mmc.asm):03370         ;
                      (dragondos_mmc.asm):03371         ; Entry:
                      (dragondos_mmc.asm):03372         ;       A       = 0, normal
                      (dragondos_mmc.asm):03373         ;               = 1, continuation blocks, can't start in slot 0.
                      (dragondos_mmc.asm):03374         ;
                      (dragondos_mmc.asm):03375         ; Return:
                      (dragondos_mmc.asm):03376         ;       A       = New dir entry number found
                      (dragondos_mmc.asm):03377         ;       X       = Page table for buffer
                      (dragondos_mmc.asm):03378         ;       U       = Entry within buffer
                      (dragondos_mmc.asm):03379         ;       B       = Error code.
                      (dragondos_mmc.asm):03380         ;
                      (dragondos_mmc.asm):03381         ; Note that the buffer is always marked dirty.
                      (dragondos_mmc.asm):03382         ;
                      (dragondos_mmc.asm):03383         
CFA7                  (dragondos_mmc.asm):03384         FindEmptyDir   
CFA7 40               (dragondos_mmc.asm):03385                 NEGA                            ; convert 0/1 to $00/$FF
CFA8 B7067E           (dragondos_mmc.asm):03386                 STA     DosTemp2                ; save in temp
CFAB BDD028           (dragondos_mmc.asm):03387                 JSR     >DosGetDiskGeometry     ; get geometry of the disk
CFAE 26F6             (dragondos_mmc.asm):03388                 BNE     LD0FB                   ; error return
                      (dragondos_mmc.asm):03389                 
CFB0 AE84             (dragondos_mmc.asm):03390                 LDX     BuffLSN,X               ; Get LSN from details
CFB2 3410             (dragondos_mmc.asm):03391                 PSHS    X                       ; save on stack
                      (dragondos_mmc.asm):03392                 
CFB4 3002             (dragondos_mmc.asm):03393                 LEAX    2,X                     ; add 2 to LSN
CFB6 BF066F           (dragondos_mmc.asm):03394         LD10B   STX     DosCurLSN               ; make current
CFB9 1F12             (dragondos_mmc.asm):03395                 TFR     X,Y                     ; save it in Y
CFBB BDD0F2           (dragondos_mmc.asm):03396                 JSR     >DOSFindAndRead         ; find LSN and read into buffer
CFBE 2635             (dragondos_mmc.asm):03397                 BNE     FindEmptyDirExit        ; error, exit
                      (dragondos_mmc.asm):03398                 
CFC0 EE05             (dragondos_mmc.asm):03399                 LDU     BuffAddr,X              ; get buffer address
CFC2 C60A             (dragondos_mmc.asm):03400                 LDB     #DirBlksPerSec          ; 10 dir blocks per sector
CFC4 7D067E           (dragondos_mmc.asm):03401                 TST     DosTemp2                ; are we looking for filename, or continuation? 
CFC7 2A05             (dragondos_mmc.asm):03402                 BPL     LD123                   ; branch if filename
                      (dragondos_mmc.asm):03403                 
CFC9 70067E           (dragondos_mmc.asm):03404                 NEG     DosTemp2                ; turn $FF->1
CFCC 2007             (dragondos_mmc.asm):03405                 BRA     LD12A
                      (dragondos_mmc.asm):03406         
                      (dragondos_mmc.asm):03407         ; if we get here DosTemp = 0, so look at first directory block,
                      (dragondos_mmc.asm):03408         ; however the above neg will turn $FF back to $1, so searches for 
                      (dragondos_mmc.asm):03409         ; continuation blocks always beging at entry 1.
CFCE A6C4             (dragondos_mmc.asm):03410         LD123   LDA     DirEntAttr,U            ; get attributes from entry
CFD0 2B1B             (dragondos_mmc.asm):03411                 BMI     LD142                   ; entry deleted, can be re-used
                      (dragondos_mmc.asm):03412                 
CFD2 7C067E           (dragondos_mmc.asm):03413                 INC     DosTemp2                ; increment entry counter
CFD5 33C819           (dragondos_mmc.asm):03414         LD12A   LEAU    DirEntryLen,U           ; move to next entry in sector
CFD8 5A               (dragondos_mmc.asm):03415                 DECB                            ; decrement counter
CFD9 26F3             (dragondos_mmc.asm):03416                 BNE     LD123                   ; loop again if more to search
                      (dragondos_mmc.asm):03417                 
CFDB BE066F           (dragondos_mmc.asm):03418                 LDX     DosCurLSN               ; move to the next sector in the directory
CFDE 3001             (dragondos_mmc.asm):03419                 LEAX    1,X
CFE0 1F10             (dragondos_mmc.asm):03420                 TFR     X,D                     ; transfer LSN to D
CFE2 A3E4             (dragondos_mmc.asm):03421                 SUBD    ,S                      ; subtract start LSN
CFE4 C112             (dragondos_mmc.asm):03422                 CMPB    #SectorsPerTrack        ; got to end of dir track?
CFE6 25CE             (dragondos_mmc.asm):03423                 BCS     LD10B                   ; no search next sector
                      (dragondos_mmc.asm):03424                 
CFE8 3262             (dragondos_mmc.asm):03425                 LEAS    2,S                     ; drop saved LSN
CFEA C692             (dragondos_mmc.asm):03426                 LDB     #ErrFD                  ; return full directory error
CFEC 39               (dragondos_mmc.asm):03427                 RTS
                      (dragondos_mmc.asm):03428         
CFED 86FF             (dragondos_mmc.asm):03429         LD142   LDA     #BuffDirty                      
CFEF A702             (dragondos_mmc.asm):03430                 STA     BuffFlag,X
CFF1 B6067E           (dragondos_mmc.asm):03431                 LDA     DosTemp2                ; get dir entry number
CFF4 5F               (dragondos_mmc.asm):03432                 CLRB                            ; flag no error
CFF5                  (dragondos_mmc.asm):03433         FindEmptyDirExit   
CFF5 3262             (dragondos_mmc.asm):03434                 LEAS    2,S                     ; clean up stack
CFF7 39               (dragondos_mmc.asm):03435                 RTS                             ; return
                      (dragondos_mmc.asm):03436         
                      (dragondos_mmc.asm):03437         ;
                      (dragondos_mmc.asm):03438         ; Get free space on a disk.
                      (dragondos_mmc.asm):03439         ;
                      (dragondos_mmc.asm):03440         ; Entry:
                      (dragondos_mmc.asm):03441         ;       DosDriveNo      = drive to get info for
                      (dragondos_mmc.asm):03442         ;
                      (dragondos_mmc.asm):03443         ; Exit: 
                      (dragondos_mmc.asm):03444         ;       X               = Free sectors
                      (dragondos_mmc.asm):03445         ;       B               = Error code
                      (dragondos_mmc.asm):03446         ;
                      (dragondos_mmc.asm):03447         
CFF8                  (dragondos_mmc.asm):03448         DOSGetFree   
CFF8 8D2E             (dragondos_mmc.asm):03449                 BSR     DosGetDiskGeometry      ; get the geometry for the disk
CFFA 2610             (dragondos_mmc.asm):03450                 BNE     LD161                   ; error, exit
                      (dragondos_mmc.asm):03451                 
CFFC 10AE84           (dragondos_mmc.asm):03452                 LDY     ,X                      ; get LSN in buffer...LSN of dir track                  
CFFF 9E8A             (dragondos_mmc.asm):03453                 LDX     <DBZero                 ; X=0, initialize free block count
D001 8D0A             (dragondos_mmc.asm):03454                 BSR     LD162                   ; get free sectors in first BAM sector
D003 2607             (dragondos_mmc.asm):03455                 BNE     LD161                   ; error, exit
                      (dragondos_mmc.asm):03456                 
D005 3121             (dragondos_mmc.asm):03457                 LEAY    1,Y                     ; move to next BAM sector
D007 8D04             (dragondos_mmc.asm):03458                 BSR     LD162                   ; get free sectors in second BAM sector
D009 2601             (dragondos_mmc.asm):03459                 BNE     LD161                   ; error, exit
D00B 5F               (dragondos_mmc.asm):03460                 CLRB                            ; flag no errors
D00C 39               (dragondos_mmc.asm):03461         LD161   RTS
                      (dragondos_mmc.asm):03462         
                      (dragondos_mmc.asm):03463         ; count bits in 1 BAM sector
D00D 3410             (dragondos_mmc.asm):03464         LD162   PSHS    X                       ; save X
D00F BDD0F2           (dragondos_mmc.asm):03465                 JSR     >DOSFindAndRead         ; read LSN in Y
D012 26E1             (dragondos_mmc.asm):03466                 BNE     FindEmptyDirExit        ; error, exit
                      (dragondos_mmc.asm):03467                 
D014 EE05             (dragondos_mmc.asm):03468                 LDU     BuffAddr,X              ; get pointer to loaded sector
D016 3510             (dragondos_mmc.asm):03469                 PULS    X                       ; restore X
                      (dragondos_mmc.asm):03470                 
D018 C6B4             (dragondos_mmc.asm):03471                 LDB     #BAMEntriesSec          ; count of bytes to process
D01A A6C0             (dragondos_mmc.asm):03472         LD16F   LDA     ,U+                     ; get a byte from buffer
D01C 44               (dragondos_mmc.asm):03473         LD171   LSRA                            ; shift bit 0 into carry
D01D 2402             (dragondos_mmc.asm):03474                 BCC     LD176                   ; branch if bit clear, sector in use
                      (dragondos_mmc.asm):03475                 
D01F 3001             (dragondos_mmc.asm):03476                 LEAX    1,X                     ; otherwise increment sector count
D021 4D               (dragondos_mmc.asm):03477         LD176   TSTA                            ; all bits processed?
D022 26F8             (dragondos_mmc.asm):03478                 BNE     LD171                   ; nope, shift and test again
                      (dragondos_mmc.asm):03479                 
D024 5A               (dragondos_mmc.asm):03480                 DECB                            ; decrement byte count
D025 26F3             (dragondos_mmc.asm):03481                 BNE     LD16F                   ; loop again if not all done
D027 39               (dragondos_mmc.asm):03482                 RTS
                      (dragondos_mmc.asm):03483                 
                      (dragondos_mmc.asm):03484         ;
                      (dragondos_mmc.asm):03485         ; Get geometry for a disk and set the apropreate low memory vars.
                      (dragondos_mmc.asm):03486         ; Read from disk if in memory copy not valid.
                      (dragondos_mmc.asm):03487         ;
                      (dragondos_mmc.asm):03488         ; Entry: 
                      (dragondos_mmc.asm):03489         ;       DosDriveNo      = drive to get info for
                      (dragondos_mmc.asm):03490         ;
                      (dragondos_mmc.asm):03491         ; Exit: 
                      (dragondos_mmc.asm):03492         ;       Drive vars setup in low ram, to be same as disk in drive.
                      (dragondos_mmc.asm):03493         ;       X               = Address of buffer detail entry for buffer to use
                      (dragondos_mmc.asm):03494         ;
                      (dragondos_mmc.asm):03495         
D028                  (dragondos_mmc.asm):03496         DosGetDiskGeometry
D028 8E061C           (dragondos_mmc.asm):03497                 LDX     #Drv0Details            ; Point at drive details
D02B CE0696           (dragondos_mmc.asm):03498                 LDU     #DosD0Online-1          ; Point at drive online table
D02E C606             (dragondos_mmc.asm):03499                 LDB     #DrvDeatailLen          ; Get drive table entry len
D030 96EB             (dragondos_mmc.asm):03500                 LDA     <DosDriveNo             ; Get last used drive
                      (dragondos_mmc.asm):03501         
D032 33C6             (dragondos_mmc.asm):03502                 LEAU    A,U                     ; Point U at drive online flag
D034 4A               (dragondos_mmc.asm):03503                 DECA                            ; Make zero based
D035 3D               (dragondos_mmc.asm):03504                 MUL                             ; Calculate offset of drive we need
D036 308B             (dragondos_mmc.asm):03505                 LEAX    D,X
D038 6DC4             (dragondos_mmc.asm):03506                 TST     ,U                      ; Is drive online ?
                      (dragondos_mmc.asm):03507         
D03A 263E             (dragondos_mmc.asm):03508                 BNE     LD1CF                   ; Yes : exit
                      (dragondos_mmc.asm):03509                 
D03C 108E0168         (dragondos_mmc.asm):03510                 LDY     #SectorsPerTrack*DirPrimary     ; First sector of DIR track ($0168)
D040 8612             (dragondos_mmc.asm):03511                 LDA     #SectorsPerTrack        ; Set sectors per track for this drive
                      (dragondos_mmc.asm):03512         ;        STA     DosSecTrkTblOfs,U      ; Set it
D042 BDC093           (dragondos_mmc.asm):03513                 JSR     LC0A7
                      (dragondos_mmc.asm):03514         
D045 3410             (dragondos_mmc.asm):03515                 PSHS    X                       ; Save drive detail pointer
D047 BDD0F2           (dragondos_mmc.asm):03516                 JSR     >DOSFindAndRead         ; Find free buffer and read sector
D04A 1026F9B3         (dragondos_mmc.asm):03517                 LBNE    LCB56                   ; Error : exit
                      (dragondos_mmc.asm):03518         
                      (dragondos_mmc.asm):03519         ; At this point X points to buffer details ???
                      (dragondos_mmc.asm):03520                 
D04E AE05             (dragondos_mmc.asm):03521                 LDX     BuffAddr,X              ; Get address of buffer data
D050 EC8900FE         (dragondos_mmc.asm):03522                 LDD     DirTracks1s,X           ; Get complements of tracks/secs per track
D054 43               (dragondos_mmc.asm):03523                 COMA                            ; Complemetn them for compare
D055 53               (dragondos_mmc.asm):03524                 COMB
D056 10A38900FC       (dragondos_mmc.asm):03525                 CMPD    DirTracks,X             ; compare them to validate the disk
D05B 3510             (dragondos_mmc.asm):03526                 PULS    X                       ; restore drive detail pointer
D05D 261D             (dragondos_mmc.asm):03527                 BNE     LD1D1                   ; Not the same, not valid disk.
                      (dragondos_mmc.asm):03528                 
D05F E7C810           (dragondos_mmc.asm):03529                 STB     DosSecTrkTblOfs,U       ; Set Sectors/Track for this disk
D062 A74C             (dragondos_mmc.asm):03530                 STA     DosTracksTblOfs,U       ; Set tracks for this disk
D064 6AC4             (dragondos_mmc.asm):03531                 DEC     ,U                      ; Mark drive online
D066 C112             (dragondos_mmc.asm):03532                 CMPB    #SectorsPerTrack        ; Disk single sided ?
D068 2701             (dragondos_mmc.asm):03533                 BEQ     LD1C0                   ; yes : skip on
                      (dragondos_mmc.asm):03534         
D06A 5F               (dragondos_mmc.asm):03535                 CLRB                            ; zero it
D06B 3404             (dragondos_mmc.asm):03536         LD1C0   PSHS    B                       ; save it
D06D 6F02             (dragondos_mmc.asm):03537                 CLR     BuffFlag,X              ; Clear buffer flag
D06F CC0168           (dragondos_mmc.asm):03538                 LDD     #SectorsPerTrack*DirPrimary     ; First sector of DIR track ($0168)
D072 6DE0             (dragondos_mmc.asm):03539                 TST     ,S+                     ; Do we need to double ? 
D074 2602             (dragondos_mmc.asm):03540                 BNE     LD1CD                   ; no : skip
                      (dragondos_mmc.asm):03541                 
D076 58               (dragondos_mmc.asm):03542                 ASLB                            ; Multiply D by 2, as we have 2 sides
D077 49               (dragondos_mmc.asm):03543                 ROLA
D078 ED84             (dragondos_mmc.asm):03544         LD1CD   STD     ,X                      ; save it
D07A 5F               (dragondos_mmc.asm):03545         LD1CF   CLRB                            ; No error
D07B 39               (dragondos_mmc.asm):03546                 RTS                             ; Return
                      (dragondos_mmc.asm):03547         
D07C C690             (dragondos_mmc.asm):03548         LD1D1   LDB     #ErrIV          ; Flag error, invalid Volume
D07E 39               (dragondos_mmc.asm):03549         LD1D3   RTS
                      (dragondos_mmc.asm):03550         
                      (dragondos_mmc.asm):03551         ;
                      (dragondos_mmc.asm):03552         ; Get directory entry.
                      (dragondos_mmc.asm):03553         ;
                      (dragondos_mmc.asm):03554         ; Entry: 
                      (dragondos_mmc.asm):03555         ;       DosDriveNo      = drive to process
                      (dragondos_mmc.asm):03556         ;       B               = File number(on disk) to get entry for
                      (dragondos_mmc.asm):03557         ;
                      (dragondos_mmc.asm):03558         ; Exit: 
                      (dragondos_mmc.asm):03559         ;       X               = Pointer to required Dir entry.
                      (dragondos_mmc.asm):03560         ;       DosCurLSN       = LSN of directory entry.
                      (dragondos_mmc.asm):03561         ;       DosCurDirBuff   = buffer pointer to LSN buffer
                      (dragondos_mmc.asm):03562         ;       B               = error code
                      (dragondos_mmc.asm):03563         ;
                      (dragondos_mmc.asm):03564         
D07F                  (dragondos_mmc.asm):03565         DOSGetDirEntry   
D07F 86FF             (dragondos_mmc.asm):03566                 LDA     #$FF                    ; Init sector counter
D081 4C               (dragondos_mmc.asm):03567         LD1D6   INCA                            ; increment sector counter
D082 C00A             (dragondos_mmc.asm):03568                 SUBB    #DirEntPerSec           ; Decrement file no, by a sectors worth of files
D084 2CFB             (dragondos_mmc.asm):03569                 BGE     LD1D6                   ; Done all ? no : continue looping
                      (dragondos_mmc.asm):03570                 
D086 CB0A             (dragondos_mmc.asm):03571                 ADDB    #DirEntPerSec           ; Compensate for over loop
                      (dragondos_mmc.asm):03572                 
                      (dragondos_mmc.asm):03573         ; At this point A contains the sector number within the directory that we are intereted in.
                      (dragondos_mmc.asm):03574         ; and B contains the entry within that sector of the file's details.
                      (dragondos_mmc.asm):03575                 
D088 3406             (dragondos_mmc.asm):03576                 PSHS    D                       ; Save them
D08A 8D9C             (dragondos_mmc.asm):03577                 BSR     DosGetDiskGeometry      ; Setup disk geometry from disk in drive
D08C 1026F971         (dragondos_mmc.asm):03578                 LBNE    LCB56                   ; Error : exit
                      (dragondos_mmc.asm):03579                 
D090 EC84             (dragondos_mmc.asm):03580                 LDD     ,X                      ; Get LSN number from buffer
D092 C30002           (dragondos_mmc.asm):03581                 ADDD    #$0002                  ; Advance past bitmap sectors
D095 EBE0             (dragondos_mmc.asm):03582                 ADDB    ,S+                     ; Add sector offset calculated above
D097 8900             (dragondos_mmc.asm):03583                 ADCA    #$00                    ; Deal with carry
D099 FD066F           (dragondos_mmc.asm):03584                 STD     DosCurLSN               ; Save LSN
D09C 1F02             (dragondos_mmc.asm):03585                 TFR     D,Y                     ; Get LSN into Y
D09E BDD0F2           (dragondos_mmc.asm):03586                 JSR     >DOSFindAndRead         ; Find free buffer and read sector
D0A1 3502             (dragondos_mmc.asm):03587                 PULS    A                       ; Retrieve entry number witin sector
D0A3 26D9             (dragondos_mmc.asm):03588                 BNE     LD1D3                   ; Error : exit
                      (dragondos_mmc.asm):03589                 
D0A5 1F13             (dragondos_mmc.asm):03590                 TFR     X,U                     
D0A7 C619             (dragondos_mmc.asm):03591                 LDB     #DirEntryLen            ; Length of dir entry
D0A9 3D               (dragondos_mmc.asm):03592                 MUL                             ; Calculate offset
D0AA BF067F           (dragondos_mmc.asm):03593                 STX     DosCurDirBuff           ; Saave block def pointer
D0AD AE05             (dragondos_mmc.asm):03594                 LDX     BuffAddr,X              ; Get pointer to block data
D0AF 308B             (dragondos_mmc.asm):03595                 LEAX    D,X                     ; Get offset of DIR entry into X
D0B1 5F               (dragondos_mmc.asm):03596                 CLRB                            ; Flag no error
D0B2 39               (dragondos_mmc.asm):03597                 RTS
                      (dragondos_mmc.asm):03598         
                      (dragondos_mmc.asm):03599         ;
                      (dragondos_mmc.asm):03600         ; Get directory entry
                      (dragondos_mmc.asm):03601         ;
                      (dragondos_mmc.asm):03602         ; Entry:
                      (dragondos_mmc.asm):03603         ;       B       = directory entry number
                      (dragondos_mmc.asm):03604         ;
                      (dragondos_mmc.asm):03605         ; Exit:
                      (dragondos_mmc.asm):03606         ;       X       = directory entry pointer
                      (dragondos_mmc.asm):03607         ;       Y       = buffer table pointer
                      (dragondos_mmc.asm):03608         ;       D       = preserved
                      (dragondos_mmc.asm):03609         ;
                      (dragondos_mmc.asm):03610         
D0B3                  (dragondos_mmc.asm):03611         DOSGetDirEntry2   
D0B3 3406             (dragondos_mmc.asm):03612                 PSHS    D
D0B5 8DC8             (dragondos_mmc.asm):03613                 BSR     DOSGetDirEntry          ; Get directory entry we are interested in
D0B7 1026F946         (dragondos_mmc.asm):03614                 LBNE    LCB56                   ; Error : exit
D0BB 10BE067F         (dragondos_mmc.asm):03615                 LDY     DosCurDirBuff           ; Get Buffer def block for this entry
D0BF 86FE             (dragondos_mmc.asm):03616                 LDA     #BuffDirtyExpire        ; Set flag
D0C1 A722             (dragondos_mmc.asm):03617                 STA     BuffFlag,Y
D0C3 5F               (dragondos_mmc.asm):03618                 CLRB                            ; Flag no error
D0C4 3586             (dragondos_mmc.asm):03619                 PULS    D,PC                    ; Restore and return
                      (dragondos_mmc.asm):03620         
                      (dragondos_mmc.asm):03621         ;
                      (dragondos_mmc.asm):03622         ; Find a free disk buffer.
                      (dragondos_mmc.asm):03623         ; Find buffer with same sector
                      (dragondos_mmc.asm):03624         ;
                      (dragondos_mmc.asm):03625         ; Entry: 
                      (dragondos_mmc.asm):03626         ;       Y               = LSN to find
                      (dragondos_mmc.asm):03627         ;       DosDriveNo      = drive to process
                      (dragondos_mmc.asm):03628         ;
                      (dragondos_mmc.asm):03629         ; Exits:
                      (dragondos_mmc.asm):03630         ;       X               = buffer table
                      (dragondos_mmc.asm):03631         ;       U               = pointer to detail entry for free buffer (or 0).
                      (dragondos_mmc.asm):03632         ;       B               = 0 if found $FF if not found
                      (dragondos_mmc.asm):03633         ;
                      (dragondos_mmc.asm):03634         
D0C6                  (dragondos_mmc.asm):03635         FindFreeBuffer   
D0C6 8E0634           (dragondos_mmc.asm):03636                 LDX     #Buff1Details           ; Point at disk buffer detail table
D0C9 DE8A             (dragondos_mmc.asm):03637                 LDU     <DBZero                 ; U=0 
D0CB C604             (dragondos_mmc.asm):03638                 LDB     #BuffCount              ; 4 Disk buffers
                      (dragondos_mmc.asm):03639         
D0CD A602             (dragondos_mmc.asm):03640         LD222   LDA     BuffFlag,X              ; Get buffer flag in A
D0CF 2717             (dragondos_mmc.asm):03641                 BEQ     LD23D                   ; Zero ?
                      (dragondos_mmc.asm):03642                 
D0D1 8155             (dragondos_mmc.asm):03643                 CMPA    #BuffInUse              ; Is buffer in use ?
D0D3 2715             (dragondos_mmc.asm):03644                 BEQ     LD23F                   ; no, skip
                      (dragondos_mmc.asm):03645                 
D0D5 10AC84           (dragondos_mmc.asm):03646                 CMPY    BuffLSN,X               ; is LSN the same?
D0D8 260A             (dragondos_mmc.asm):03647                 BNE     LD239                   ; no, skip
                      (dragondos_mmc.asm):03648                 
D0DA 96EB             (dragondos_mmc.asm):03649                 LDA     <DosDriveNo             ; Get last drive
D0DC A103             (dragondos_mmc.asm):03650                 CMPA    BuffDrive,X             ; Is this buffer using the same drive ?
D0DE 2604             (dragondos_mmc.asm):03651                 BNE     LD239                   ; nope, skip on
D0E0 8D66             (dragondos_mmc.asm):03652                 BSR     MakeBuffYoungest        ; Make this the youngest buffer
D0E2 5F               (dragondos_mmc.asm):03653                 CLRB                            ; Flag no error
D0E3 39               (dragondos_mmc.asm):03654                 RTS
                      (dragondos_mmc.asm):03655         
D0E4 6D02             (dragondos_mmc.asm):03656         LD239   TST     BuffFlag,X              ; Is buffer free ?
D0E6 2602             (dragondos_mmc.asm):03657                 BNE     LD23F                   ; nope, look at next
                      (dragondos_mmc.asm):03658                 
D0E8 1F13             (dragondos_mmc.asm):03659         LD23D   TFR     X,U                     ; Select this buffer
D0EA 3007             (dragondos_mmc.asm):03660         LD23F   LEAX    BuffDetailSize,X        ; move on to next buffer detail entry
D0EC 5A               (dragondos_mmc.asm):03661                 DECB                            ; Decrement counter
D0ED 26DE             (dragondos_mmc.asm):03662                 BNE     LD222                   ; Any more to check ? : yes loop again
                      (dragondos_mmc.asm):03663         
D0EF C6FF             (dragondos_mmc.asm):03664                 LDB     #$FF                    ; Flag error
D0F1 39               (dragondos_mmc.asm):03665         LD246   RTS
                      (dragondos_mmc.asm):03666         
                      (dragondos_mmc.asm):03667         ;
                      (dragondos_mmc.asm):03668         ; Find a free buffer and read sector.
                      (dragondos_mmc.asm):03669         ;
                      (dragondos_mmc.asm):03670         ; Entry: 
                      (dragondos_mmc.asm):03671         ;       Y               = LSN to read
                      (dragondos_mmc.asm):03672         ;       DosDriveNo      = drive to process
                      (dragondos_mmc.asm):03673         ; Exit:
                      (dragondos_mmc.asm):03674         ;       X               = pointer to buffer entry 
                      (dragondos_mmc.asm):03675         ;       U               = preserved
                      (dragondos_mmc.asm):03676         ;       B               = error code 
                      (dragondos_mmc.asm):03677         ;
                      (dragondos_mmc.asm):03678         ; A buffer is allocated from the 4 buffer pool in the following order of
                      (dragondos_mmc.asm):03679         ; preference:
                      (dragondos_mmc.asm):03680         ;       1, Sector already in buffer
                      (dragondos_mmc.asm):03681         ;       2, An empty buffer
                      (dragondos_mmc.asm):03682         ;       3, Least recently used buffer, flushed first.
                      (dragondos_mmc.asm):03683         ;
                      (dragondos_mmc.asm):03684         
D0F2                  (dragondos_mmc.asm):03685         DOSFindAndRead   
D0F2 3440             (dragondos_mmc.asm):03686                 PSHS    U                       ; save U
D0F4 BDD0C6           (dragondos_mmc.asm):03687                 JSR     >FindFreeBuffer         ; Find free buffer, pointer to details returned in U
D0F7 1027F906         (dragondos_mmc.asm):03688                 LBEQ    LCB56                   ; error, exit
                      (dragondos_mmc.asm):03689                 
D0FB 30C4             (dragondos_mmc.asm):03690                 LEAX    ,U                      ; Make X point to details
D0FD 3540             (dragondos_mmc.asm):03691                 PULS    U
D0FF 2604             (dragondos_mmc.asm):03692                 BNE     LD25A
                      (dragondos_mmc.asm):03693                 
D101 8D1C             (dragondos_mmc.asm):03694                 BSR     FindFreeDiskBuffer      ; Find buffer to read data into
D103 26EC             (dragondos_mmc.asm):03695                 BNE     LD246
                      (dragondos_mmc.asm):03696                 
D105 6F02             (dragondos_mmc.asm):03697         LD25A   CLR     BuffFlag,X              ; Make buffer free
D107 10AF84           (dragondos_mmc.asm):03698                 STY     ,X
D10A 96EB             (dragondos_mmc.asm):03699                 LDA     <DosDriveNo             ; Get last drive
D10C A703             (dragondos_mmc.asm):03700                 STA     BuffDrive,X             ; Set this drive's buffer
D10E 3410             (dragondos_mmc.asm):03701                 PSHS    X                       ; Save buffer detail pointer
D110 AE05             (dragondos_mmc.asm):03702                 LDX     BuffAddr,X              ; Get address of buffer
D112 BDD1B5           (dragondos_mmc.asm):03703                 JSR     >DOSReadAbsSector       ; Read the sector
                      (dragondos_mmc.asm):03704         ;       JSR     >CON_DumpRegsWait
D115 3510             (dragondos_mmc.asm):03705                 PULS    X                       ; Restore buff detail pointer
D117 26D8             (dragondos_mmc.asm):03706                 BNE     LD246                   ; Error : exit
                      (dragondos_mmc.asm):03707                 
D119 8601             (dragondos_mmc.asm):03708                 LDA     #$01                    ; Set flag to 1
D11B A702             (dragondos_mmc.asm):03709                 STA     BuffFlag,X
D11D 5F               (dragondos_mmc.asm):03710                 CLRB                            ; No error
D11E 39               (dragondos_mmc.asm):03711                 RTS
                      (dragondos_mmc.asm):03712         
                      (dragondos_mmc.asm):03713         ;
                      (dragondos_mmc.asm):03714         ; Find least recently used disk buffer, if none, and there is 
                      (dragondos_mmc.asm):03715         ; a dirty buffer, then flush it and use that one.
                      (dragondos_mmc.asm):03716         ;
                      (dragondos_mmc.asm):03717         ; Exit : X=pointer to buffer info block.
                      (dragondos_mmc.asm):03718         ;
                      (dragondos_mmc.asm):03719         
D11F                  (dragondos_mmc.asm):03720         FindFreeDiskBuffer   
D11F 3466             (dragondos_mmc.asm):03721                 PSHS    D,Y,U
D121 8E0634           (dragondos_mmc.asm):03722         LD276   LDX     #Buff1Details           ; Point to disk buffer table
D124 C604             (dragondos_mmc.asm):03723                 LDB     #$04                    ; Check 4 buffers
D126 A604             (dragondos_mmc.asm):03724         LD27B   LDA     BuffAge,X               ; Get buffer age
D128 8101             (dragondos_mmc.asm):03725                 CMPA    #$01                    ; Oldest ?
D12A 2705             (dragondos_mmc.asm):03726                 BEQ     LD286                   ; Yes go process it
                      (dragondos_mmc.asm):03727                 
D12C 3007             (dragondos_mmc.asm):03728                 LEAX    7,X                     ; Do next bufffer
D12E 5A               (dragondos_mmc.asm):03729                 DECB                            ; Decrement buffer count
D12F 26F5             (dragondos_mmc.asm):03730                 BNE     LD27B                   ; More : do next
                      (dragondos_mmc.asm):03731         
D131 8D15             (dragondos_mmc.asm):03732         LD286   BSR     MakeBuffYoungest        ; Adjust ages of all other buffers
D133 A602             (dragondos_mmc.asm):03733                 LDA     BuffFlag,X              ; Get buffer flag byte 
D135 8155             (dragondos_mmc.asm):03734                 CMPA    #$55                    ; In use ???
D137 27E8             (dragondos_mmc.asm):03735                 BEQ     LD276                   ; yes, select another buffer
                      (dragondos_mmc.asm):03736                 
D139 4C               (dragondos_mmc.asm):03737                 INCA                            ; Check for Flag=$FF
D13A 2604             (dragondos_mmc.asm):03738                 BNE     LD295                   ; no : skip on
                      (dragondos_mmc.asm):03739                 
D13C 6A02             (dragondos_mmc.asm):03740                 DEC     BuffFlag,X              ; yes, select another buffer
D13E 20E1             (dragondos_mmc.asm):03741                 BRA     LD276
                      (dragondos_mmc.asm):03742         
D140 8D1D             (dragondos_mmc.asm):03743         LD295   BSR     TestAndFlushBuffer      ; Check for buffer flush needed ?
                      (dragondos_mmc.asm):03744                 
D142 2702             (dragondos_mmc.asm):03745                 BEQ     LD29B                   ; no error, skip
D144 E761             (dragondos_mmc.asm):03746                 STB     1,S                     ; save error code on stack for return
                      (dragondos_mmc.asm):03747                 
D146 35E6             (dragondos_mmc.asm):03748         LD29B   PULS    D,Y,U,PC                ; restore and return
                      (dragondos_mmc.asm):03749         
                      (dragondos_mmc.asm):03750         ;
                      (dragondos_mmc.asm):03751         ; Update the LRU counts of buffers.
                      (dragondos_mmc.asm):03752         ;
                      (dragondos_mmc.asm):03753         ; Entry:
                      (dragondos_mmc.asm):03754         ;       X       = page table entry
                      (dragondos_mmc.asm):03755         ;
                      (dragondos_mmc.asm):03756         ; Exits:
                      (dragondos_mmc.asm):03757         ;       Entry becomes most recently used.
                      (dragondos_mmc.asm):03758         ;
                      (dragondos_mmc.asm):03759         
D148                  (dragondos_mmc.asm):03760         MakeBuffYoungest   
D148 C604             (dragondos_mmc.asm):03761                 LDB     #BuffCount              ; Process 4 buffers
D14A A604             (dragondos_mmc.asm):03762                 LDA     BuffAge,X               ; Get current buffer Age
D14C CE0634           (dragondos_mmc.asm):03763                 LDU     #Buff1Details           ; Point to disk buffer table
D14F A144             (dragondos_mmc.asm):03764         LD2A4   CMPA    BuffAge,U               ; Compare to current buffer age
D151 2202             (dragondos_mmc.asm):03765                 BHI     LD2AA                   ; higher ? skip
D153 6A44             (dragondos_mmc.asm):03766                 DEC     BuffAge,U               ; Decrement Age byte (make older)
                      (dragondos_mmc.asm):03767                 
D155 3347             (dragondos_mmc.asm):03768         LD2AA   LEAU    BuffDetailSize,U        ; Do next buffer
D157 5A               (dragondos_mmc.asm):03769                 DECB                            ; Decrement count
D158 26F5             (dragondos_mmc.asm):03770                 BNE     LD2A4                   ; More : do next
D15A 8604             (dragondos_mmc.asm):03771                 LDA     #$04                    ; Mark this as youngest buffer
D15C A704             (dragondos_mmc.asm):03772                 STA     BuffAge,X
D15E 39               (dragondos_mmc.asm):03773                 RTS
                      (dragondos_mmc.asm):03774         
                      (dragondos_mmc.asm):03775         ;
                      (dragondos_mmc.asm):03776         ; Clean up a buffer.
                      (dragondos_mmc.asm):03777         ;
                      (dragondos_mmc.asm):03778         ; If buffer is dirty, flush it to disk, and if verify is on, or 
                      (dragondos_mmc.asm):03779         ; write is to directory tracks, then verify it.
                      (dragondos_mmc.asm):03780         ;
                      (dragondos_mmc.asm):03781         ; Maintain a list of directory sectors which need updating.
                      (dragondos_mmc.asm):03782         ;
                      (dragondos_mmc.asm):03783         ; Entry:
                      (dragondos_mmc.asm):03784         ;       X       = buffer table
                      (dragondos_mmc.asm):03785         ;
                      (dragondos_mmc.asm):03786         ; Exit:
                      (dragondos_mmc.asm):03787         ;       X       = preserved
                      (dragondos_mmc.asm):03788         ;       B       = error code
                      (dragondos_mmc.asm):03789         ;
                      (dragondos_mmc.asm):03790         
D15F                  (dragondos_mmc.asm):03791         TestAndFlushBuffer   
D15F 6D02             (dragondos_mmc.asm):03792                 TST     BuffFlag,X              ; Buffer dirty ?
D161 2B02             (dragondos_mmc.asm):03793                 BMI     FlushBuffer             ; Yes, flush it !
D163 5F               (dragondos_mmc.asm):03794                 CLRB                            ; No error ?
D164 39               (dragondos_mmc.asm):03795                 RTS
                      (dragondos_mmc.asm):03796         
D165                  (dragondos_mmc.asm):03797         FlushBuffer
D165 96EB             (dragondos_mmc.asm):03798                 LDA     <DosDriveNo             ; Get last drive accessed
D167 3402             (dragondos_mmc.asm):03799                 PSHS    A                       ; save it on stack
D169 3410             (dragondos_mmc.asm):03800                 PSHS    X                       ; Save buffer pointer
D16B 86FF             (dragondos_mmc.asm):03801                 LDA     #$FF                    ; Flag Dos IO in progress
D16D 97F6             (dragondos_mmc.asm):03802                 STA     <DosIOInProgress
D16F 6F02             (dragondos_mmc.asm):03803                 CLR     BuffFlag,X              ; Flag buffer no longer dirty
D171 A603             (dragondos_mmc.asm):03804                 LDA     BuffDrive,X             ; Get drive this buffer refers to
D173 97EB             (dragondos_mmc.asm):03805                 STA     <DosDriveNo             ; Save in last accessed drive
D175 10AE84           (dragondos_mmc.asm):03806                 LDY     ,X                      ; get LSN ?
D178 AE05             (dragondos_mmc.asm):03807                 LDX     BuffAddr,X              ; Get buffer pointer
D17A BDD1A5           (dragondos_mmc.asm):03808                 JSR     >DOSWriteAbsSector      ; Write it
                      (dragondos_mmc.asm):03809         
D17D 3510             (dragondos_mmc.asm):03810                 PULS    X                       ; Retrieve buffer pointer
D17F 261C             (dragondos_mmc.asm):03811                 BNE     LD2F2                   ; no error : skip ahead
                      (dragondos_mmc.asm):03812         
D181 96EC             (dragondos_mmc.asm):03813                 LDA     <DskTrackNo             ; Get current track no
D183 8114             (dragondos_mmc.asm):03814                 CMPA    #DirPrimary             ; track 20 (directory) ?
D185 2611             (dragondos_mmc.asm):03815                 BNE     LD2ED                   ; no : skip ahead
                      (dragondos_mmc.asm):03816         
                      (dragondos_mmc.asm):03817         ;
                      (dragondos_mmc.asm):03818         ; I do not have a clue why this code does this, it seems to take a byte from
                      (dragondos_mmc.asm):03819         ; the basic rom do some stuff to it and update the Directory sector status table 
                      (dragondos_mmc.asm):03820         ; with it !
                      (dragondos_mmc.asm):03821         ; 
                      (dragondos_mmc.asm):03822         ; Looking at $A673, the 8 bytes before it are $80,$40,$20,$10,$08,$04,$02,$01
                      (dragondos_mmc.asm):03823         ; This is the 2 colour pixel mask table, but is a convenient table for mapping a bit
                      (dragondos_mmc.asm):03824         ; number to the bit it represents.
                      (dragondos_mmc.asm):03825         ;
                      (dragondos_mmc.asm):03826                 
D187 CEA673           (dragondos_mmc.asm):03827                 LDU     #PixMaskTable4Col       ; This for some strange reason points U at basic rom !!!        
D18A 96EB             (dragondos_mmc.asm):03828                 LDA     <DosDriveNo             ; get last drive
D18C 40               (dragondos_mmc.asm):03829                 NEGA
D18D A6C6             (dragondos_mmc.asm):03830                 LDA     A,U
                      (dragondos_mmc.asm):03831         
D18F CE06AA           (dragondos_mmc.asm):03832                 LDU     #DosDirSecStatus-1      ; Point to directory status table
D192 D6ED             (dragondos_mmc.asm):03833                 LDB     <DskSectorNo            ; get sector number
D194 AAC5             (dragondos_mmc.asm):03834                 ORA     B,U                     ; Put a byte in table
D196 A7C5             (dragondos_mmc.asm):03835                 STA     B,U
                      (dragondos_mmc.asm):03836         
D198 8601             (dragondos_mmc.asm):03837         LD2ED   LDA     #$01                    ; Mark bufer as youngest
D19A A702             (dragondos_mmc.asm):03838                 STA     BuffFlag,X
D19C 5F               (dragondos_mmc.asm):03839                 CLRB
                      (dragondos_mmc.asm):03840                 
D19D 3502             (dragondos_mmc.asm):03841         LD2F2   PULS    A
D19F 97EB             (dragondos_mmc.asm):03842                 STA     <DosDriveNo             ; Restore last drive
D1A1 0FF6             (dragondos_mmc.asm):03843                 CLR     <DosIOInProgress        ; Mark no io in progress
D1A3 5D               (dragondos_mmc.asm):03844                 TSTB
D1A4 39               (dragondos_mmc.asm):03845                 RTS
                      (dragondos_mmc.asm):03846         
                      (dragondos_mmc.asm):03847         ;
                      (dragondos_mmc.asm):03848         ; Write absolute sector.
                      (dragondos_mmc.asm):03849         ;
                      (dragondos_mmc.asm):03850         ; Entry :    
                      (dragondos_mmc.asm):03851         ;       X               = Address to store data
                      (dragondos_mmc.asm):03852         ;       Y               = LSN to read
                      (dragondos_mmc.asm):03853         ;       DosDriveNo      = drive to process
                      (dragondos_mmc.asm):03854         ;
                      (dragondos_mmc.asm):03855         ; Exit:
                      (dragondos_mmc.asm):03856         ;       X               = preserved
                      (dragondos_mmc.asm):03857         ;       B               = error code
                      (dragondos_mmc.asm):03858         ;
                      (dragondos_mmc.asm):03859         
D1A5                  (dragondos_mmc.asm):03860         DOSWriteAbsSector   
D1A5 8D15             (dragondos_mmc.asm):03861                 BSR     CalcTrackFromLSN        ; Setup disk vars in low ram with trackno
D1A7 BDC0FE           (dragondos_mmc.asm):03862                 JSR     >DosDoWriteSecN
                      (dragondos_mmc.asm):03863         
D1AA 9EEE             (dragondos_mmc.asm):03864         LD2FF   LDX     <DiskBuffPtr            ; Restore buffer pointer 
D1AC 5D               (dragondos_mmc.asm):03865                 TSTB                            ; Test for Error
D1AD 39               (dragondos_mmc.asm):03866                 RTS                             ; return to caller
                      (dragondos_mmc.asm):03867         
                      (dragondos_mmc.asm):03868         ;
                      (dragondos_mmc.asm):03869         ; Verify absolute sector.
                      (dragondos_mmc.asm):03870         ;
                      (dragondos_mmc.asm):03871         ; Entry and Exit as for Write absolute sector.
                      (dragondos_mmc.asm):03872         ;
                      (dragondos_mmc.asm):03873         
D1AE                  (dragondos_mmc.asm):03874         DosVerifyAbsSector
D1AE 8D0C             (dragondos_mmc.asm):03875         LD303   BSR     CalcTrackFromLSN        ; Setup disk vars in low ram with trackno
D1B0 BDC15F           (dragondos_mmc.asm):03876                 JSR     >DosDoReadSec2
D1B3 20F5             (dragondos_mmc.asm):03877                 BRA     LD2FF
                      (dragondos_mmc.asm):03878         
                      (dragondos_mmc.asm):03879         ;
                      (dragondos_mmc.asm):03880         ; Read absolute sector.
                      (dragondos_mmc.asm):03881         ;
                      (dragondos_mmc.asm):03882         ; Entry and Exit as for Write absolute sector.
                      (dragondos_mmc.asm):03883         ;
                      (dragondos_mmc.asm):03884         
D1B5                  (dragondos_mmc.asm):03885         DOSReadAbsSector   
D1B5 8D05             (dragondos_mmc.asm):03886                 BSR     CalcTrackFromLSN        ; Setup disk vars in low ram with trackno
D1B7 BDC104           (dragondos_mmc.asm):03887                 JSR     >DosDoReadSec           ; Go read data
D1BA 20EE             (dragondos_mmc.asm):03888                 BRA     LD2FF                   ; Return to caller
                      (dragondos_mmc.asm):03889         
                      (dragondos_mmc.asm):03890         ;
                      (dragondos_mmc.asm):03891         ; Calculate track from Logical sector number.
                      (dragondos_mmc.asm):03892         ; 
                      (dragondos_mmc.asm):03893         ; Entry: 
                      (dragondos_mmc.asm):03894         ;       X       = Buffer pointer
                      (dragondos_mmc.asm):03895         ;       Y       = LSN to read/write
                      (dragondos_mmc.asm):03896         ;
                      (dragondos_mmc.asm):03897         ; Exit: 
                      (dragondos_mmc.asm):03898         ;       A       = Track
                      (dragondos_mmc.asm):03899         ;       B       = Sector        
                      (dragondos_mmc.asm):03900         ;       Low ram vars DskTrackNo and DskSectorNo also set.
                      (dragondos_mmc.asm):03901         ;
                      (dragondos_mmc.asm):03902         
D1BC                  (dragondos_mmc.asm):03903         CalcTrackFromLSN        
D1BC 9FEE             (dragondos_mmc.asm):03904                 STX     <DiskBuffPtr            ; Save in buffer pointer
D1BE 8E06A6           (dragondos_mmc.asm):03905                 LDX     #DosD0SecTrack-1        ; Point to Sec/Track table
D1C1 D6EB             (dragondos_mmc.asm):03906                 LDB     <DosDriveNo             ; Get last drive
D1C3 E685             (dragondos_mmc.asm):03907                 LDB     B,X                     ; Get Sec/Track for that drive
D1C5 4F               (dragondos_mmc.asm):03908                 CLRA
D1C6 3406             (dragondos_mmc.asm):03909                 PSHS    D                       ; Save it
D1C8 6FE2             (dragondos_mmc.asm):03910                 CLR     ,-S                     ; Make room on stack
D1CA 1F20             (dragondos_mmc.asm):03911                 TFR     Y,D                     ; Get LSN into D
                      (dragondos_mmc.asm):03912                 
                      (dragondos_mmc.asm):03913         ; Calculate which track we need
                      (dragondos_mmc.asm):03914         
D1CC 6CE4             (dragondos_mmc.asm):03915         LD321   INC     ,S                      ; Inc track counter
D1CE A361             (dragondos_mmc.asm):03916                 SUBD    1,S                     ; Decrement sec/track from LSN
D1D0 2AFA             (dragondos_mmc.asm):03917                 BPL     LD321                   ; keep looping till it goes -ve
                      (dragondos_mmc.asm):03918                 
D1D2 EB62             (dragondos_mmc.asm):03919                 ADDB    2,S                     ; Compensate for over-loop
D1D4 A6E4             (dragondos_mmc.asm):03920                 LDA     ,S                      ; Get track needed
D1D6 4A               (dragondos_mmc.asm):03921                 DECA                            ; Compensate track for over loop
D1D7 5C               (dragondos_mmc.asm):03922                 INCB
D1D8 3263             (dragondos_mmc.asm):03923                 LEAS    3,S                     ; Drop stack temps
D1DA DDEC             (dragondos_mmc.asm):03924                 STD     <DskTrackNo             ; Save track no
D1DC 39               (dragondos_mmc.asm):03925                 RTS
                      (dragondos_mmc.asm):03926         
                      (dragondos_mmc.asm):03927         
                      (dragondos_mmc.asm):03928         ;
                      (dragondos_mmc.asm):03929         ; Copy command dispatch routine
                      (dragondos_mmc.asm):03930         ;
                      (dragondos_mmc.asm):03931         ; Syntax :
                      (dragondos_mmc.asm):03932         ;       COPY filespec TO filespec       
                      (dragondos_mmc.asm):03933         ;
                      (dragondos_mmc.asm):03934         ; Stack setup as follows 
                      (dragondos_mmc.asm):03935         ;
                      (dragondos_mmc.asm):03936         ; offset        size    purpose
                      (dragondos_mmc.asm):03937         ; 0             1       Source FCB number
                      (dragondos_mmc.asm):03938         ; 1             1       Destination FCB number
                      (dragondos_mmc.asm):03939         ; 2             2       Buffer pointer ?
                      (dragondos_mmc.asm):03940         ; 4             3       File pointer pos
                      (dragondos_mmc.asm):03941         ;
                      (dragondos_mmc.asm):03942         
     0000             (dragondos_mmc.asm):03943         CopySrcFCBNo    equ     0               ; Source file FCB no
     0001             (dragondos_mmc.asm):03944         CopyDstFCBNo    equ     1               ; Destination FCB no
     0002             (dragondos_mmc.asm):03945         CopyIOBufPtr    equ     2               ; IO buffer pointer
     0004             (dragondos_mmc.asm):03946         CopySrcFP       equ     4               ; Source filepointer
                      (dragondos_mmc.asm):03947         
D1DD                  (dragondos_mmc.asm):03948         CmdCopy 
D1DD BDCD66           (dragondos_mmc.asm):03949                 JSR     >DOSCloseAll            ; Close all files & devices
D1E0 2634             (dragondos_mmc.asm):03950                 BNE     LD36B                   ; Error : exit
D1E2 3279             (dragondos_mmc.asm):03951                 LEAS    -7,S                    ; Make room on stack
                      (dragondos_mmc.asm):03952                 
                      (dragondos_mmc.asm):03953         ;
                      (dragondos_mmc.asm):03954         ; Make a buffer for copying the file.
                      (dragondos_mmc.asm):03955         ;
                      (dragondos_mmc.asm):03956         
D1E4 1F40             (dragondos_mmc.asm):03957                 TFR     S,D                     ; move to D
D1E6 830100           (dragondos_mmc.asm):03958                 SUBD    #$0100                  ; Make room for 1 sector
D1E9 931F             (dragondos_mmc.asm):03959                 SUBD    <BasVarEnd              ; Will we overwrite basic ?             
D1EB 102BB153         (dragondos_mmc.asm):03960                 LBMI    BasOMError              ; yes : error, exit
                      (dragondos_mmc.asm):03961                 
D1EF 5F               (dragondos_mmc.asm):03962                 CLRB
D1F0 4D               (dragondos_mmc.asm):03963                 TSTA                            ; At least 1 page of ram available
D1F1 1027B14D         (dragondos_mmc.asm):03964                 LBEQ    BasOMError              ; no : error, exit
                      (dragondos_mmc.asm):03965                 
D1F5 ED62             (dragondos_mmc.asm):03966                 STD     CopyIOBufPtr,S          ; IO buffer pointer
D1F7 BDD57F           (dragondos_mmc.asm):03967                 JSR     >DosGetFilenameAndOpen
D1FA 261A             (dragondos_mmc.asm):03968                 BNE     LD36B                   ; Error : exit
D1FC A7E4             (dragondos_mmc.asm):03969                 STA     CopySrcFCBNo,S          ; save FCB no of source
                      (dragondos_mmc.asm):03970                 
D1FE BDCD24           (dragondos_mmc.asm):03971                 JSR     >DOSGetFLen             ; Get file length
D201 2613             (dragondos_mmc.asm):03972                 BNE     LD36B
D203 9DA5             (dragondos_mmc.asm):03973                 JSR     <BasChrGetCurr          ; scan current char from params
                      (dragondos_mmc.asm):03974                 
                      (dragondos_mmc.asm):03975                 ifndef  Tandy
D205 81BC             (dragondos_mmc.asm):03976                 CMPA    #DTokTO                 ; "TO" token (Dragon)
                      (dragondos_mmc.asm):03977                 else
                      (dragondos_mmc.asm):03978                 CMPA    #CTokTO                 ; "TO" token (CoCo)
                      (dragondos_mmc.asm):03979                 endc
D207 1026B7A9         (dragondos_mmc.asm):03980                 LBNE    BasSNError              ; no : Error
                      (dragondos_mmc.asm):03981                 
D20B 9D9F             (dragondos_mmc.asm):03982                 JSR     <BasChrGet              ; Get next character
D20D BDD57F           (dragondos_mmc.asm):03983                 JSR     >DosGetFilenameAndOpen  ; Get dest filename FCB number in A             
D210 2707             (dragondos_mmc.asm):03984                 BEQ     LD36E                   ; No error : continue
                      (dragondos_mmc.asm):03985                 
D212 C1A0             (dragondos_mmc.asm):03986                 CMPB    #ErrNE          ; File not exist ?
D214 2703             (dragondos_mmc.asm):03987                 BEQ     LD36E                   ; does not exit, create it
                      (dragondos_mmc.asm):03988                 
D216 7EC56F           (dragondos_mmc.asm):03989         LD36B   JMP     >DosHookSysError        ; Error : exit
                      (dragondos_mmc.asm):03990         
D219 A761             (dragondos_mmc.asm):03991         LD36E   STA     CopyDstFCBNo,S          ; Save destination FCB number
D21B BDCDBF           (dragondos_mmc.asm):03992                 JSR     >DOSCreateFile          ; re-write destination file
D21E 26F6             (dragondos_mmc.asm):03993                 BNE     LD36B                   ; error : exit
                      (dragondos_mmc.asm):03994                 
D220 A6E4             (dragondos_mmc.asm):03995         LD375   LDA     CopySrcFCBNo,S          ; Get source FCB no
D222 97F1             (dragondos_mmc.asm):03996                 STA     <DosCurrCtrlBlk         ; Save current FCB
D224 BDCD57           (dragondos_mmc.asm):03997                 JSR     >DosFCBNoToAddr         ; Get FCB address
                      (dragondos_mmc.asm):03998                 
                      (dragondos_mmc.asm):03999         ; Compare file pointer position with file length for source file
                      (dragondos_mmc.asm):04000         
D227 EC0C             (dragondos_mmc.asm):04001                 LDD     FCBFilePointer,X        ; MSW
D229 10A38810         (dragondos_mmc.asm):04002                 CMPD    FCBFileLen,X
D22D 2507             (dragondos_mmc.asm):04003                 BCS     LD38B                   ; not there yet, continue copying
                      (dragondos_mmc.asm):04004         
                      (dragondos_mmc.asm):04005         ;***    LDD     FCBFilePointer+2,X      ; LSB
                      (dragondos_mmc.asm):04006         ;***    CMPD    FCBFileLen+2,X
D22F A60E             (dragondos_mmc.asm):04007                 LDA     FCBFilePointer+2,X      ; LSB
D231 A18812           (dragondos_mmc.asm):04008                 CMPA    FCBFileLen+2,X
D234 2750             (dragondos_mmc.asm):04009                 BEQ     LD3DB                   ; reached EOF, copy done
                      (dragondos_mmc.asm):04010         
D236 EE0C             (dragondos_mmc.asm):04011         LD38B   LDU     FCBFilePointer,X        ; get source fileptr in U:A
D238 A60E             (dragondos_mmc.asm):04012                 LDA     FCBFilePointer+2,X
                      (dragondos_mmc.asm):04013                 
D23A A766             (dragondos_mmc.asm):04014                 STA     CopySrcFP+2,S           ; save source filepointer
D23C EF64             (dragondos_mmc.asm):04015                 STU     CopySrcFP,S
                      (dragondos_mmc.asm):04016                 
D23E EC62             (dragondos_mmc.asm):04017                 LDD     CopyIOBufPtr,S          ; point to IO buff
D240 E365             (dragondos_mmc.asm):04018                 ADDD    CopySrcFP+1,S           ; 
D242 ED65             (dragondos_mmc.asm):04019                 STD     CopySrcFP+1,S
D244 2402             (dragondos_mmc.asm):04020                 BCC     LD39D
                      (dragondos_mmc.asm):04021                 
D246 6C64             (dragondos_mmc.asm):04022                 INC     CopySrcFP,S
D248 A664             (dragondos_mmc.asm):04023         LD39D   LDA     CopySrcFP,S
D24A A08810           (dragondos_mmc.asm):04024                 SUBA    FCBFileLen,X
D24D 250E             (dragondos_mmc.asm):04025                 BCS     LD3B2
                      (dragondos_mmc.asm):04026                 
D24F EC65             (dragondos_mmc.asm):04027                 LDD     CopySrcFP+1,S
D251 A38811           (dragondos_mmc.asm):04028                 SUBD    FCBFileLen+1,X
D254 2307             (dragondos_mmc.asm):04029                 BLS     LD3B2
                      (dragondos_mmc.asm):04030                 
D256 EC8811           (dragondos_mmc.asm):04031                 LDD     FCBFileLen+1,X
D259 A30D             (dragondos_mmc.asm):04032                 SUBD    FCBFilePointer+1,X
D25B ED62             (dragondos_mmc.asm):04033                 STD     CopyIOBufPtr,S
                      (dragondos_mmc.asm):04034                 
D25D A6E4             (dragondos_mmc.asm):04035         LD3B2   LDA     CopySrcFCBNo,S          ; retrieve source FCB no
D25F EE0C             (dragondos_mmc.asm):04036                 LDU     FCBFilePointer,X
D261 E60E             (dragondos_mmc.asm):04037                 LDB     FCBFilePointer+2,X
D263 10AE62           (dragondos_mmc.asm):04038                 LDY     CopyIOBufPtr,S
D266 9E1F             (dragondos_mmc.asm):04039                 LDX     BasVarEnd
D268 BDC83C           (dragondos_mmc.asm):04040                 JSR     >DOSFRead               ; go read source file
D26B 26A9             (dragondos_mmc.asm):04041                 BNE     LD36B                   ; error : exit
                      (dragondos_mmc.asm):04042                 
D26D A661             (dragondos_mmc.asm):04043                 LDA     CopyDstFCBNo,S          ; get destination FCB
D26F 97F1             (dragondos_mmc.asm):04044                 STA     <DosCurrCtrlBlk         ; make current
D271 BDCD57           (dragondos_mmc.asm):04045                 JSR     >DosFCBNoToAddr         ; get FCB address
                      (dragondos_mmc.asm):04046                 
D274 10AE8810         (dragondos_mmc.asm):04047                 LDY     FCBFileLen,X
D278 E68812           (dragondos_mmc.asm):04048                 LDB     FCBFileLen+2,X
D27B EE62             (dragondos_mmc.asm):04049                 LDU     CopyIOBufPtr,S
D27D 9E1F             (dragondos_mmc.asm):04050                 LDX     BasVarEnd
D27F BDCA04           (dragondos_mmc.asm):04051                 JSR     >DOSFWrite              ; go write to destination
                      (dragondos_mmc.asm):04052                 
D282 2692             (dragondos_mmc.asm):04053                 BNE     LD36B                   ; error exit
D284 209A             (dragondos_mmc.asm):04054                 BRA     LD375
                      (dragondos_mmc.asm):04055         
D286 BDCD66           (dragondos_mmc.asm):04056         LD3DB   JSR     >DOSCloseAll            ; close all files
D289 1026FF89         (dragondos_mmc.asm):04057                 LBNE    LD36B                   ; error exit
D28D 3267             (dragondos_mmc.asm):04058                 LEAS    7,S                     ; cleanup stack
D28F 39               (dragondos_mmc.asm):04059                 RTS
                      (dragondos_mmc.asm):04060         
                      (dragondos_mmc.asm):04061         ;
                      (dragondos_mmc.asm):04062         ; basic MERGE command
                      (dragondos_mmc.asm):04063         ;
                      (dragondos_mmc.asm):04064         ; Merges basic program in memory with a program from disk.
                      (dragondos_mmc.asm):04065         ;
                      (dragondos_mmc.asm):04066         ; MERGE "filename"
                      (dragondos_mmc.asm):04067         ;
                      (dragondos_mmc.asm):04068         
D290                  (dragondos_mmc.asm):04069         CmdMerge   
D290 BDD579           (dragondos_mmc.asm):04070                 JSR     >DosValidateAndOpenBAS  ; open basic program file
D293 2649             (dragondos_mmc.asm):04071                 BNE     LD433                   ; error, exit
                      (dragondos_mmc.asm):04072                 
D295 BDD317           (dragondos_mmc.asm):04073                 JSR     >ReadHeadGetTypeA       ; read header, get filetype             
D298 2644             (dragondos_mmc.asm):04074                 BNE     LD433                   ; error, exit
                      (dragondos_mmc.asm):04075                 
D29A 8101             (dragondos_mmc.asm):04076                 CMPA    #FTypeBas               ; is the file basic?                            
D29C 263E             (dragondos_mmc.asm):04077                 BNE     GenFMError              ; nope, FM error, exit
                      (dragondos_mmc.asm):04078                 
D29E DE1B             (dragondos_mmc.asm):04079                 LDU     <BasVarSimpleAddr       ; point at end of basic program
D2A0 109E19           (dragondos_mmc.asm):04080                 LDY     <BasStartProg           ; point at beginning of basic program
                      (dragondos_mmc.asm):04081                 
D2A3 3460             (dragondos_mmc.asm):04082                 PSHS    Y,U                     ; save regs
D2A5 3341             (dragondos_mmc.asm):04083                 LEAU    1,U                     ; point 1 byte into vars 
D2A7 DF19             (dragondos_mmc.asm):04084                 STU     <BasStartProg           ; make this the new start of basic
D2A9 BDD38B           (dragondos_mmc.asm):04085                 JSR     >DoBasLoad              ; glo load program
                      (dragondos_mmc.asm):04086                 
D2AC 3550             (dragondos_mmc.asm):04087                 PULS    X,U                     ; recover old start and end prog addressses
D2AE DF1B             (dragondos_mmc.asm):04088                 STU     <BasVarSimpleAddr       ; and reset them
D2B0 9F19             (dragondos_mmc.asm):04089                 STX     <BasStartProg
D2B2 3341             (dragondos_mmc.asm):04090                 LEAU    1,U                     ; point to loaded basic program
                      (dragondos_mmc.asm):04091                 
D2B4 ECC1             (dragondos_mmc.asm):04092         LD409   LDD     ,U++                    ; get pointer to next line
D2B6 271E             (dragondos_mmc.asm):04093                 BEQ     LD42B                   ; exit if zero, we have reached the end of loaded program
                      (dragondos_mmc.asm):04094                 
D2B8 ECC1             (dragondos_mmc.asm):04095                 LDD     ,U++                    ; get line number 
D2BA FD02DA           (dragondos_mmc.asm):04096                 STD     BasLinInpHead           ; save it in line input buffer
D2BD DD2B             (dragondos_mmc.asm):04097                 STD     <BasTempLine            ; save it in tem line
D2BF 5F               (dragondos_mmc.asm):04098                 CLRB                            ; clear B
D2C0 8E02DC           (dragondos_mmc.asm):04099                 LDX     #BasLinInpBuff          ; point at line input buffer
D2C3 5C               (dragondos_mmc.asm):04100         LD418   INCB                            ; increment line char count
D2C4 A6C0             (dragondos_mmc.asm):04101                 LDA     ,U+                     ; get a loaded byte
D2C6 A780             (dragondos_mmc.asm):04102                 STA     ,X+                     ; put it in line input buffer
D2C8 26F9             (dragondos_mmc.asm):04103                 BNE     LD418                   ; loop for next, if byte not zero (EOL)
                      (dragondos_mmc.asm):04104         
D2CA CB04             (dragondos_mmc.asm):04105                 ADDB    #$04                    ;
D2CC D703             (dragondos_mmc.asm):04106                 STB     <BasGenCount
                      (dragondos_mmc.asm):04107         
D2CE 3440             (dragondos_mmc.asm):04108                 PSHS    U                       ; save loaded program pointer
D2D0 8D0F             (dragondos_mmc.asm):04109                 BSR     LD436                   ; put line in basic
D2D2 3540             (dragondos_mmc.asm):04110                 PULS    U                       ; recover loaded program pointer
D2D4 20DE             (dragondos_mmc.asm):04111                 BRA     LD409                   ; loop again
                      (dragondos_mmc.asm):04112         
D2D6 7F0611           (dragondos_mmc.asm):04113         LD42B   CLR     DosRunLoadFlag          ; clear load run flag
D2D9 16008C           (dragondos_mmc.asm):04114                 LBRA    LD4BD                   ; finish off load
                      (dragondos_mmc.asm):04115         
D2DC                  (dragondos_mmc.asm):04116         GenFMError   
D2DC C62C             (dragondos_mmc.asm):04117                 LDB     #BErrFM                 ; FM error
D2DE 7EC56F           (dragondos_mmc.asm):04118         LD433   JMP     >DosHookSysError        ; call error hook
                      (dragondos_mmc.asm):04119         
D2E1 BD83FF           (dragondos_mmc.asm):04120         LD436   JSR     >BasFindLineNo          ; find the line 
D2E4 2512             (dragondos_mmc.asm):04121                 BCS     LD44D                   ; branch if new line number
                      (dragondos_mmc.asm):04122                 
                      (dragondos_mmc.asm):04123         ; line found with the same number, delete the current line and inser the new one.
D2E6 DC47             (dragondos_mmc.asm):04124                 LDD     <BasFoundLineNo         ; get address of found line 
D2E8 A384             (dragondos_mmc.asm):04125                 SUBD    ,X                      ; calculate length of founc line (-ve)
D2EA D31B             (dragondos_mmc.asm):04126                 ADDD    <BasVarSimpleAddr       ; add base of loaded prog to line length 
D2EC DD1B             (dragondos_mmc.asm):04127                 STD     <BasVarSimpleAddr       ; set end address for copy
D2EE EE84             (dragondos_mmc.asm):04128                 LDU     ,X                      ; get address of next line
D2F0 A6C0             (dragondos_mmc.asm):04129         LD445   LDA     ,U+                     ; get a byte from next line
D2F2 A780             (dragondos_mmc.asm):04130                 STA     ,X+                     ; overwrite this line
D2F4 9C1B             (dragondos_mmc.asm):04131                 CMPX    <BasVarSimpleAddr       ; done all?     
D2F6 26F8             (dragondos_mmc.asm):04132                 BNE     LD445                   ; no,keep going
                      (dragondos_mmc.asm):04133         
D2F8 DC1B             (dragondos_mmc.asm):04134         LD44D   LDD     <BasVarSimpleAddr       ; get new base of variables
D2FA DD43             (dragondos_mmc.asm):04135                 STD     <Eval43                 ; save it
D2FC DB03             (dragondos_mmc.asm):04136                 ADDB    <BasGenCount            ; add gencount to number of bytes moved
D2FE 8900             (dragondos_mmc.asm):04137                 ADCA    #$00                    ; process any carry B->A
D300 DD41             (dragondos_mmc.asm):04138                 STD     <Eval41                 ; save it
D302 BD831C           (dragondos_mmc.asm):04139                 JSR     >BasChkArrSpaceMv       ; check array space and move
                      (dragondos_mmc.asm):04140                 
D305 CE02D8           (dragondos_mmc.asm):04141                 LDU     #$02D8                  ; point to input buffer
D308 A6C0             (dragondos_mmc.asm):04142         LD45D   LDA     ,U+                     ; get a byte from buffer        
D30A A780             (dragondos_mmc.asm):04143                 STA     ,X+                     ; put it in program
D30C 9C45             (dragondos_mmc.asm):04144                 CMPX    <Eval45                 ; end of line?
D30E 26F8             (dragondos_mmc.asm):04145                 BNE     LD45D                   ; no keep going
D310 9E41             (dragondos_mmc.asm):04146                 LDX     <Eval41                 ; update end of basic program
D312 9F1B             (dragondos_mmc.asm):04147                 STX     <BasVarSimpleAddr
D314 7E83ED           (dragondos_mmc.asm):04148                 JMP     >BasVect2               ; re-link lines.        
                      (dragondos_mmc.asm):04149         
                      (dragondos_mmc.asm):04150         
                      (dragondos_mmc.asm):04151         ;
                      (dragondos_mmc.asm):04152         ; Read a header from the open file, into the DosCurDriveInfo
                      (dragondos_mmc.asm):04153         ; Check that the header contacins the correct marker bytes at beginning and end.
                      (dragondos_mmc.asm):04154         ; If valid return file type byte in A else generate and FM error.
                      (dragondos_mmc.asm):04155         ;
                      (dragondos_mmc.asm):04156         ; Entry:
                      (dragondos_mmc.asm):04157         ;       DosCurrCtrlBlk  = file no to read
                      (dragondos_mmc.asm):04158         ;
                      (dragondos_mmc.asm):04159         ; Exit:
                      (dragondos_mmc.asm):04160         ;       A               = filetype byte from header
                      (dragondos_mmc.asm):04161         ;       X               = points to header block
                      (dragondos_mmc.asm):04162         ;       B               = Error code (despit comments in DDv2c source).
                      (dragondos_mmc.asm):04163         ;
                      (dragondos_mmc.asm):04164         
D317                  (dragondos_mmc.asm):04165         ReadHeadGetTypeA   
D317 8E0650           (dragondos_mmc.asm):04166                 LDX     #DosCurDriveInfo        ; point at current drive info
D31A 108E0009         (dragondos_mmc.asm):04167                 LDY     #FileHeadLen            ; 9 bytes, header size
D31E DE8A             (dragondos_mmc.asm):04168                 LDU     <DBZero                 ; U=0 filebointer at BOF
D320 5F               (dragondos_mmc.asm):04169                 CLRB                            ; B=0
D321 96F1             (dragondos_mmc.asm):04170                 LDA     <DosCurrCtrlBlk         ; get current control block
D323 BDC83C           (dragondos_mmc.asm):04171                 JSR     >DOSFRead               ; read file header      
D326 2701             (dragondos_mmc.asm):04172                 BEQ     LD47E                   ; no error
D328 39               (dragondos_mmc.asm):04173                 RTS
                      (dragondos_mmc.asm):04174         
D329 8655             (dragondos_mmc.asm):04175         LD47E   LDA     #MarkerHeadStart        ; check for header marker bytes
D32B 8E0650           (dragondos_mmc.asm):04176                 LDX     #DosCurDriveInfo        ; point at file header in buffer
D32E A184             (dragondos_mmc.asm):04177                 CMPA    ,X                      ; first marker present?
D330 26AA             (dragondos_mmc.asm):04178                 BNE     GenFMError              ; generate FM error if not
                      (dragondos_mmc.asm):04179                 
D332 43               (dragondos_mmc.asm):04180                 COMA                            ; check for second marker at end of header
D333 A108             (dragondos_mmc.asm):04181                 CMPA    HdrIDAA,X               ; second marker present?
D335 26A5             (dragondos_mmc.asm):04182                 BNE     GenFMError              ; generate FM error if not
D337 A601             (dragondos_mmc.asm):04183                 LDA     HdrType,X               ; get filetype in A             
D339 5F               (dragondos_mmc.asm):04184                 CLRB
D33A 39               (dragondos_mmc.asm):04185                 RTS
                      (dragondos_mmc.asm):04186         
                      (dragondos_mmc.asm):04187         ;
                      (dragondos_mmc.asm):04188         ; Load a basic or binary file into memory.
                      (dragondos_mmc.asm):04189         ;
                      (dragondos_mmc.asm):04190         ; If basic, any basic program already in memory will be overwritten 
                      (dragondos_mmc.asm):04191         ; and variables cleared.
                      (dragondos_mmc.asm):04192         ;
                      (dragondos_mmc.asm):04193         ; If binary, the program will be read into any location that is not ROM.
                      (dragondos_mmc.asm):04194         ;
                      (dragondos_mmc.asm):04195         ; RUN "filename"        : load and run 
                      (dragondos_mmc.asm):04196         ; LOAD "filename"       : load but don't run 
                      (dragondos_mmc.asm):04197         ;
                      (dragondos_mmc.asm):04198         
                      (dragondos_mmc.asm):04199         ; Clear various flags
D33B                  (dragondos_mmc.asm):04200         DosHookRun   
D33B 7F0614           (dragondos_mmc.asm):04201                 CLR     DosErrGotoFlag          ; Clear on error goto flag
D33E 7F0619           (dragondos_mmc.asm):04202                 CLR     DosErrLast              ; clear last error code
D341 7F0617           (dragondos_mmc.asm):04203                 CLR     DosErrLineNo            ; clear last error line
D344 7F0618           (dragondos_mmc.asm):04204                 CLR     DosErrLineNo+1
D347 8122             (dragondos_mmc.asm):04205                 CMPA    #$22                    ; quote
D349 2702             (dragondos_mmc.asm):04206                 BEQ     LD4A2
D34B 4D               (dragondos_mmc.asm):04207                 TSTA
D34C 39               (dragondos_mmc.asm):04208                 RTS
                      (dragondos_mmc.asm):04209         
D34D 3262             (dragondos_mmc.asm):04210         LD4A2   LEAS    2,S                     ; drop return address
D34F C601             (dragondos_mmc.asm):04211                 LDB     #$01                    ; flag run
                      (dragondos_mmc.asm):04212         
D351 21               (dragondos_mmc.asm):04213                 FCB     Skip1
                      (dragondos_mmc.asm):04214                 
D352 5F               (dragondos_mmc.asm):04215         CmdLoad CLRB                            ; flag load
D353 F70611           (dragondos_mmc.asm):04216                 STB     DosRunLoadFlag          
D356 BDD579           (dragondos_mmc.asm):04217                 JSR     >DosValidateAndOpenBAS  ; check and open the basic program file
D359 2683             (dragondos_mmc.asm):04218                 BNE     LD433                   ; error, exit
                      (dragondos_mmc.asm):04219                 
D35B BDD317           (dragondos_mmc.asm):04220                 JSR     >ReadHeadGetTypeA       ; read header of basic program
D35E 1026FF7C         (dragondos_mmc.asm):04221                 LBNE    LD433                   ; error, exit
                      (dragondos_mmc.asm):04222                 
D362 8101             (dragondos_mmc.asm):04223                 CMPA    #FTypeBas               ; is the file of type basic?
D364 2649             (dragondos_mmc.asm):04224                 BNE     LD504                   ; nope, go check for machine code
                      (dragondos_mmc.asm):04225                 
D366 8D23             (dragondos_mmc.asm):04226                 BSR     DoBasLoad               ; load the file into the program memory
                      (dragondos_mmc.asm):04227         
D368 0FF6             (dragondos_mmc.asm):04228         LD4BD   CLR     <DosIOInProgress        ; mark IO not in progress
                      (dragondos_mmc.asm):04229                 
D36A 9E19             (dragondos_mmc.asm):04230                 LDX     <BasStartProg           ; point at start of program
D36C BD85EE           (dragondos_mmc.asm):04231                 JSR     >BasSetProgPtrX         ; asjust pointer
                      (dragondos_mmc.asm):04232                 
D36F 9E27             (dragondos_mmc.asm):04233                 LDX     <AddrFWareRamTop        ; get the end of RAM
D371 9F23             (dragondos_mmc.asm):04234                 STX     <BasVarStrTop           ; setup string variables
                      (dragondos_mmc.asm):04235                 
D373 9E1B             (dragondos_mmc.asm):04236                 LDX     <BasVarSimpleAddr       ; arrays top = simple vars top, 
D375 9F1D             (dragondos_mmc.asm):04237                 STX     <BasVarArrayAddr        ; no arrays defined
                      (dragondos_mmc.asm):04238                 
D377 9F1F             (dragondos_mmc.asm):04239                 STX     BasVarEnd               ; and no simple vars defined
                      (dragondos_mmc.asm):04240                 
D379 BD8514           (dragondos_mmc.asm):04241         LD4CE   JSR     >CmdRestore             ; perform a basic 'RESTORE' reset data pointers
D37C BD8434           (dragondos_mmc.asm):04242                 JSR     >BasResetStack          ; reset basic stack
                      (dragondos_mmc.asm):04243                 
D37F 7D0611           (dragondos_mmc.asm):04244                 TST     DosRunLoadFlag          ; should we run the loaded code?
D382 2703             (dragondos_mmc.asm):04245                 BEQ     LD4DC                   ; nope, just return
                      (dragondos_mmc.asm):04246                 
D384 7E849F           (dragondos_mmc.asm):04247                 JMP     >BasRun                 ; go run it
                      (dragondos_mmc.asm):04248         
D387 4F               (dragondos_mmc.asm):04249         LD4DC   CLRA                            ; flag no error
D388 7E8371           (dragondos_mmc.asm):04250                 JMP     >BasCmdMode             ; return to command mode
                      (dragondos_mmc.asm):04251         
                      (dragondos_mmc.asm):04252         ;
                      (dragondos_mmc.asm):04253         ; Load code of basic program
                      (dragondos_mmc.asm):04254         ; On entry X points to file header
                      (dragondos_mmc.asm):04255         ; 
                      (dragondos_mmc.asm):04256         
D38B                  (dragondos_mmc.asm):04257         DoBasLoad   
D38B EC04             (dragondos_mmc.asm):04258                 LDD     HdrLen,X                ; get file length
D38D 1F02             (dragondos_mmc.asm):04259                 TFR     D,Y                     ; get it into Y for FRead below
D38F D319             (dragondos_mmc.asm):04260                 ADDD    <BasStartProg           ; add the start of basic, to get the new end
                      (dragondos_mmc.asm):04261                 
D391 DD1F             (dragondos_mmc.asm):04262                 STD     BasVarEnd               ; save it 
D393 C640             (dragondos_mmc.asm):04263                 LDB     #$40                    ; Check we have 128 bytes free RAM
D395 BD8331           (dragondos_mmc.asm):04264                 JSR     >BasChkB2Free           ; go check, OM error if insufficient
                      (dragondos_mmc.asm):04265                 
D398 96F1             (dragondos_mmc.asm):04266         LD4ED   LDA     <DosCurrCtrlBlk         ; get current control block
D39A DE8A             (dragondos_mmc.asm):04267                 LDU     <DBZero ; U=0
D39C C609             (dragondos_mmc.asm):04268                 LDB     #FileHeadLen            ; start reading at byte 9
D39E 9E19             (dragondos_mmc.asm):04269                 LDX     <BasStartProg           ; into BasStartProg
D3A0 BDC83C           (dragondos_mmc.asm):04270                 JSR     >DOSFRead               ; go read it
                      (dragondos_mmc.asm):04271                 
D3A3 1026F1C8         (dragondos_mmc.asm):04272                 LBNE    DosHookSysError         ; error, try catching it
                      (dragondos_mmc.asm):04273                 
D3A7 BD83ED           (dragondos_mmc.asm):04274                 JSR     >BasVect2               ; tidy up after load
D3AA 3002             (dragondos_mmc.asm):04275                 LEAX    2,X                     ; point past end of program
D3AC 9F1B             (dragondos_mmc.asm):04276                 STX     <BasVarSimpleAddr       ; save in basic vars
D3AE 39               (dragondos_mmc.asm):04277         LD503   RTS                             ; return
                      (dragondos_mmc.asm):04278         
D3AF 8102             (dragondos_mmc.asm):04279         LD504   CMPA    #FTypeBin               ; is this file a machine code program?
D3B1 1026FF27         (dragondos_mmc.asm):04280                 LBNE    GenFMError              ; nope, errror not basic or machine code
                      (dragondos_mmc.asm):04281                 
D3B5 EE06             (dragondos_mmc.asm):04282                 LDU     HdrExec,X               ; get Exec address from header
D3B7 DF9D             (dragondos_mmc.asm):04283                 STU     <BasExecAddr            ; save it in basic exec vector
                      (dragondos_mmc.asm):04284                 
D3B9 9DA5             (dragondos_mmc.asm):04285                 JSR     <BasChrGetCurr          ; get current character from basic
D3BB 2712             (dragondos_mmc.asm):04286                 BEQ     LD524                   ; no more, skip on
                      (dragondos_mmc.asm):04287                 
D3BD 3410             (dragondos_mmc.asm):04288                 PSHS    X                       ; save X
D3BF 8D6B             (dragondos_mmc.asm):04289                 BSR     VarGetComma16           ; get load offset in X
D3C1 1F13             (dragondos_mmc.asm):04290                 TFR     X,U                     ; save offset in U
                      (dragondos_mmc.asm):04291                 
D3C3 3510             (dragondos_mmc.asm):04292                 PULS    X                       ; restore header pointer
D3C5 EC06             (dragondos_mmc.asm):04293                 LDD     HdrExec,X               ; get exec address
D3C7 A302             (dragondos_mmc.asm):04294                 SUBD    HdrLoad,X               ; subtract load address giving exec address offset
D3C9 EF02             (dragondos_mmc.asm):04295                 STU     HdrLoad,X               ; save new load address
D3CB E302             (dragondos_mmc.asm):04296                 ADDD    HdrLoad,X               ; add exec offset to new load address
D3CD DD9D             (dragondos_mmc.asm):04297                 STD     <BasExecAddr            ; save it in basic exec address
                      (dragondos_mmc.asm):04298                 
D3CF 10AE04           (dragondos_mmc.asm):04299         LD524   LDY     HdrLen,X                ; get file length into Y
D3D2 96F1             (dragondos_mmc.asm):04300                 LDA     <DosCurrCtrlBlk         ; get current control block
D3D4 C609             (dragondos_mmc.asm):04301                 LDB     #FileHeadLen            ; set file position in U:B
D3D6 DE8A             (dragondos_mmc.asm):04302                 LDU     <DBZero ; U=0
D3D8 AE02             (dragondos_mmc.asm):04303                 LDX     HdrLoad,X               ; get load address
D3DA BDC83C           (dragondos_mmc.asm):04304                 JSR     >DOSFRead               ; go read the file into memory
                      (dragondos_mmc.asm):04305                 
D3DD 1026F18E         (dragondos_mmc.asm):04306                 LBNE    DosHookSysError         ; try catching error if any
                      (dragondos_mmc.asm):04307                 
D3E1 7D0611           (dragondos_mmc.asm):04308                 TST     DosRunLoadFlag          ; test if we should run loaded code?
D3E4 27C8             (dragondos_mmc.asm):04309                 BEQ     LD503                   ; nope return to caller
D3E6 6E9F009D         (dragondos_mmc.asm):04310                 JMP     [>BasExecAddr]          ; exec loaded program
                      (dragondos_mmc.asm):04311         
                      (dragondos_mmc.asm):04312         ;
                      (dragondos_mmc.asm):04313         ; basic SAVE comamnd
                      (dragondos_mmc.asm):04314         ;
                      (dragondos_mmc.asm):04315         ; Save a basic or binary program to disk.
                      (dragondos_mmc.asm):04316         ;
                      (dragondos_mmc.asm):04317         ; If basic:
                      (dragondos_mmc.asm):04318         ;   SAVE "filename"
                      (dragondos_mmc.asm):04319         ;
                      (dragondos_mmc.asm):04320         ; If binary:
                      (dragondos_mmc.asm):04321         ;   SAVE "filename",start,end,entry
                      (dragondos_mmc.asm):04322         ;
                      (dragondos_mmc.asm):04323         ; DosCurFilename is used as a buffer to buld the file header :-
                      (dragondos_mmc.asm):04324         ;
                      (dragondos_mmc.asm):04325         ; DosCurFilename        $55
                      (dragondos_mmc.asm):04326         ; DosCurFilename        FileType
                      (dragondos_mmc.asm):04327         ; DosCurFilename+2      Start address
                      (dragondos_mmc.asm):04328         ; DosCurFilename+4      Length
                      (dragondos_mmc.asm):04329         ; DosCurFilename+6      Entry address   
                      (dragondos_mmc.asm):04330         ; DosCurFilename+8      $AA
                      (dragondos_mmc.asm):04331         ;
                      (dragondos_mmc.asm):04332         
D3EA                  (dragondos_mmc.asm):04333         CmdSave   
D3EA BD8887           (dragondos_mmc.asm):04334                 JSR     >VarGetStr              ; get string into temp variable
D3ED BD8877           (dragondos_mmc.asm):04335                 JSR     >VarGetExpr             ; Get address of string in FAC
D3F0 9DA5             (dragondos_mmc.asm):04336                 JSR     <BasChrGetCurr          ; get current basic character
D3F2 273E             (dragondos_mmc.asm):04337                 BEQ     LD587                   ; none, skip, it's a basic program being saved
                      (dragondos_mmc.asm):04338                 
D3F4 108EDD0D         (dragondos_mmc.asm):04339                 LDY     #DosExtBin              ; otherwise it's machine code, point to BIN extension
D3F8 8D23             (dragondos_mmc.asm):04340                 BSR     LD572                   ; try to open or create the file
                      (dragondos_mmc.asm):04341                 
D3FA 8D30             (dragondos_mmc.asm):04342                 BSR     VarGetComma16           ; get start address
D3FC BF0652           (dragondos_mmc.asm):04343                 STX     DosCurFilename+2        ; save it away
                      (dragondos_mmc.asm):04344                 
D3FF 8D2B             (dragondos_mmc.asm):04345                 BSR     VarGetComma16           ; get end address
D401 1F10             (dragondos_mmc.asm):04346                 TFR     X,D                     ; save it in D
D403 BC0652           (dragondos_mmc.asm):04347                 CMPX    DosCurFilename+2        ; compare to start address      
D406 1025F163         (dragondos_mmc.asm):04348                 LBCS    DosPRError              ; PR error if it's lower
                      (dragondos_mmc.asm):04349                 
D40A B30652           (dragondos_mmc.asm):04350                 SUBD    DosCurFilename+2        ; subtract start address from end address giving length in D
D40D 102BB77C         (dragondos_mmc.asm):04351                 LBMI    BasFCError              ; FC error if it's -ve
                      (dragondos_mmc.asm):04352                 
D411 FD0654           (dragondos_mmc.asm):04353                 STD     DosCurFilename+4        ; save length
                      (dragondos_mmc.asm):04354                 
D414 8D16             (dragondos_mmc.asm):04355                 BSR     VarGetComma16           ; get entry address
D416 BF0656           (dragondos_mmc.asm):04356                 STX     DosCurFilename+6        ; save it
                      (dragondos_mmc.asm):04357         
D419 C602             (dragondos_mmc.asm):04358                 LDB     #FTypeBin               ; set filetype to binary
D41B 202F             (dragondos_mmc.asm):04359                 BRA     LD5A1
                      (dragondos_mmc.asm):04360         
D41D BDD58D           (dragondos_mmc.asm):04361         LD572   JSR     >DosOpenFileExtY        ; get the supplied filename & try opening
D420 2704             (dragondos_mmc.asm):04362                 BEQ     LD57B                   ; all ok, skip on and create
                      (dragondos_mmc.asm):04363                 
D422 C1A0             (dragondos_mmc.asm):04364                 CMPB    #ErrNE          ; File does not exist error?
D424 2640             (dragondos_mmc.asm):04365                 BNE     LD5BB                   ; no, skip to error handler
                      (dragondos_mmc.asm):04366                 
D426 BDCDBF           (dragondos_mmc.asm):04367         LD57B   JSR     >DOSCreateFile          ; (re)create file
D429 263B             (dragondos_mmc.asm):04368                 BNE     LD5BB                   ; error skip to handler
D42B 39               (dragondos_mmc.asm):04369                 RTS
                      (dragondos_mmc.asm):04370         ;
                      (dragondos_mmc.asm):04371         ; syntax check for a comma then get 16 bit integer.
                      (dragondos_mmc.asm):04372         ;
D42C                  (dragondos_mmc.asm):04373         VarGetComma16   
D42C BD89AA           (dragondos_mmc.asm):04374                 JSR     >VarCKComma             ; syntax check for comma
D42F 7E8E83           (dragondos_mmc.asm):04375                 JMP     >VarGet16Bit            ; get 16 bit integer (in X)
                      (dragondos_mmc.asm):04376         
                      (dragondos_mmc.asm):04377         ; continuation of save code
D432 108EDD07         (dragondos_mmc.asm):04378         LD587   LDY     #DosExtBas              ; point at BAS extension
D436 8DE5             (dragondos_mmc.asm):04379                 BSR     LD572                   ; try to create or open file
                      (dragondos_mmc.asm):04380                 
D438 9E19             (dragondos_mmc.asm):04381                 LDX     <BasStartProg           ; get the address of the start of the basic program
D43A BF0652           (dragondos_mmc.asm):04382                 STX     DosCurFilename+2        ; set this as start address
                      (dragondos_mmc.asm):04383                 
D43D DC1B             (dragondos_mmc.asm):04384                 LDD     <BasVarSimpleAddr       ; address of simple vars = address of end of program
D43F 9319             (dragondos_mmc.asm):04385                 SUBD    <BasStartProg           ; subtract address of start of program
D441 FD0654           (dragondos_mmc.asm):04386                 STD     DosCurFilename+4        ; save it in length
                      (dragondos_mmc.asm):04387                 
D444 8E8B8D           (dragondos_mmc.asm):04388                 LDX     #BasFCError             ; set exec address to the FC error routine
D447 BF0656           (dragondos_mmc.asm):04389                 STX     DosCurFilename+6        ; set it
                      (dragondos_mmc.asm):04390                 
D44A C601             (dragondos_mmc.asm):04391                 LDB     #FTypeBas               ; filetype basic
                      (dragondos_mmc.asm):04392         
D44C 8E0650           (dragondos_mmc.asm):04393         LD5A1   LDX     #DosCurFilename         ; point to DosCurFilename, used as header buffer
D44F 8655             (dragondos_mmc.asm):04394                 LDA     #MarkerHeadStart        ; mark start of header                  
D451 A784             (dragondos_mmc.asm):04395                 STA     ,X                      ; save in header
D453 43               (dragondos_mmc.asm):04396                 COMA                            ; complement it to give end marker
D454 A708             (dragondos_mmc.asm):04397                 STA     HdrIDAA,X               ; save it in header
                      (dragondos_mmc.asm):04398                 
D456 E701             (dragondos_mmc.asm):04399                 STB     HdrType,X               ; set filetype
                      (dragondos_mmc.asm):04400                 
D458 96F1             (dragondos_mmc.asm):04401                 LDA     <DosCurrCtrlBlk         ; get current control block
D45A 5F               (dragondos_mmc.asm):04402                 CLRB                            ; Y:B, filepointer offset = 0:0
D45B 109E8A           (dragondos_mmc.asm):04403                 LDY     <DBZero
D45E CE0009           (dragondos_mmc.asm):04404                 LDU     #FileHeadLen            ; length of header
D461 BDCA04           (dragondos_mmc.asm):04405                 JSR     >DOSFWrite              ; go write it   
D464 2703             (dragondos_mmc.asm):04406                 BEQ     LD5BE                   ; if it wrote ok, go write rest of file
                      (dragondos_mmc.asm):04407         
D466 7EC56F           (dragondos_mmc.asm):04408         LD5BB   JMP     >DosHookSysError        ; call error handler
                      (dragondos_mmc.asm):04409         
D469 96F1             (dragondos_mmc.asm):04410         LD5BE   LDA     <DosCurrCtrlBlk         ; get current control block
D46B C609             (dragondos_mmc.asm):04411                 LDB     #FileHeadLen            ; file offset, just after header
D46D BE0652           (dragondos_mmc.asm):04412                 LDX     DosCurFilename+2        ; get start address     
D470 FE0654           (dragondos_mmc.asm):04413                 LDU     DosCurFilename+4        ; get number of bytes (file len)
D473 109E8A           (dragondos_mmc.asm):04414                 LDY     <DBZero ; Y=0
D476 BDCA04           (dragondos_mmc.asm):04415                 JSR     >DOSFWrite              ; write the rest of the file
D479 26EB             (dragondos_mmc.asm):04416                 BNE     LD5BB                   ; branch on error
                      (dragondos_mmc.asm):04417                 
D47B 0FF6             (dragondos_mmc.asm):04418                 CLR     <DosIOInProgress        ; clear file io
D47D 39               (dragondos_mmc.asm):04419                 RTS
                      (dragondos_mmc.asm):04420         ;
                      (dragondos_mmc.asm):04421         ; Basic CHAIN command 
                      (dragondos_mmc.asm):04422         ;
                      (dragondos_mmc.asm):04423         ; The command will save all of the users simple variables, arrays and strings.
                      (dragondos_mmc.asm):04424         ; It will re-initialize the stack so as to flush and FOR-NEXT loops or pending
                      (dragondos_mmc.asm):04425         ; RETURNS.
                      (dragondos_mmc.asm):04426         ; It will also reset the READ-DATA pointer back to the beginning of the program. 
                      (dragondos_mmc.asm):04427         ;
                      (dragondos_mmc.asm):04428         ; CHAIN "progname"
                      (dragondos_mmc.asm):04429         ; CHAIN "progname",runline
                      (dragondos_mmc.asm):04430         ;
                      (dragondos_mmc.asm):04431         
D47E                  (dragondos_mmc.asm):04432         CmdChain   
D47E BDD579           (dragondos_mmc.asm):04433                 JSR     >DosValidateAndOpenBAS  ; check and open the basic program file
D481 1026011E         (dragondos_mmc.asm):04434                 LBNE    LD6F8                   ; error : exit
                      (dragondos_mmc.asm):04435                 
D485 BDD317           (dragondos_mmc.asm):04436                 JSR     >ReadHeadGetTypeA       ; go read the file's header, type in A
D488 1026F0E3         (dragondos_mmc.asm):04437                 LBNE    DosHookSysError         ; error : exit
                      (dragondos_mmc.asm):04438                 
D48C 8101             (dragondos_mmc.asm):04439                 CMPA    #FTypeBas               ; make sure it's a basic program type
D48E 1026FE4A         (dragondos_mmc.asm):04440                 LBNE    GenFMError              ; nope : generate FM error
                      (dragondos_mmc.asm):04441                 
D492 BDD514           (dragondos_mmc.asm):04442                 JSR     >LD669                  ; check and move strings to string area if needed
                      (dragondos_mmc.asm):04443                 
D495 EC04             (dragondos_mmc.asm):04444                 LDD     HdrLen,X                ; get length of file to chain
D497 FD0656           (dragondos_mmc.asm):04445                 STD     DosCurFilename+6        ; save it 
                      (dragondos_mmc.asm):04446                 
D49A D319             (dragondos_mmc.asm):04447                 ADDD    <BasStartProg           ; work out where chained program will end
D49C 931B             (dragondos_mmc.asm):04448                 SUBD    <BasVarSimpleAddr       ; work out offset to current start of vars
D49E 3406             (dragondos_mmc.asm):04449                 PSHS    D                       ; save it
                      (dragondos_mmc.asm):04450                 
D4A0 D31F             (dragondos_mmc.asm):04451                 ADDD    BasVarEnd               ; add offset to end of simple vars
D4A2 DD1F             (dragondos_mmc.asm):04452                 STD     BasVarEnd               ; and update end of simple vars
D4A4 C640             (dragondos_mmc.asm):04453                 LDB     #$40                    ; reserve 128 bytes of storage
D4A6 BD8331           (dragondos_mmc.asm):04454                 JSR     >BasChkB2Free           ; check to see if free, error if not
                      (dragondos_mmc.asm):04455                 
D4A9 ECE4             (dragondos_mmc.asm):04456                 LDD     ,S                      ; get offset between new end of prog and beginning 
                      (dragondos_mmc.asm):04457                                                 ; of vars
D4AB 2A0F             (dragondos_mmc.asm):04458                 BPL     LD611                   ; branch if positive
                      (dragondos_mmc.asm):04459         
                      (dragondos_mmc.asm):04460         ; -ve offset move vars down, staring at beginning so as not to overwrite ourselves
D4AD 9E1B             (dragondos_mmc.asm):04461                 LDX     <BasVarSimpleAddr       ; point at beginning of vars
D4AF 338B             (dragondos_mmc.asm):04462                 LEAU    D,X                     ; add offset
                      (dragondos_mmc.asm):04463         
D4B1 A680             (dragondos_mmc.asm):04464         LD606   LDA     ,X+                     ; get a byte from current vars area
D4B3 A7C0             (dragondos_mmc.asm):04465                 STA     ,U+                     ; save it in new vars area
D4B5 11931F           (dragondos_mmc.asm):04466                 CMPU    BasVarEnd               ; reached end of vars yet
D4B8 23F7             (dragondos_mmc.asm):04467                 BLS     LD606                   ; nope, loop again
                      (dragondos_mmc.asm):04468                 
D4BA 200E             (dragondos_mmc.asm):04469                 BRA     LD61F                   ; branch on over other copy loop
                      (dragondos_mmc.asm):04470         
                      (dragondos_mmc.asm):04471         ; +ve offset move vars down, staring at end so as not to overwrite ourselves
D4BC 9E1F             (dragondos_mmc.asm):04472         LD611   LDX     BasVarEnd               ; point to end of vars
D4BE 3001             (dragondos_mmc.asm):04473                 LEAX    1,X                     ; add 1
D4C0 338B             (dragondos_mmc.asm):04474                 LEAU    D,X                     ; add offset
                      (dragondos_mmc.asm):04475                 
D4C2 A682             (dragondos_mmc.asm):04476         LD617   LDA     ,-X                     ; get a byte from current vars area
D4C4 A7C2             (dragondos_mmc.asm):04477                 STA     ,-U                     ; save it in new vars area
D4C6 9C1B             (dragondos_mmc.asm):04478                 CMPX    <BasVarSimpleAddr       ; reached beginning of vars?
D4C8 24F8             (dragondos_mmc.asm):04479                 BCC     LD617                   ; nope, loop again
                      (dragondos_mmc.asm):04480                 
D4CA ECE4             (dragondos_mmc.asm):04481         LD61F   LDD     ,S                      ; get offset 
D4CC D31B             (dragondos_mmc.asm):04482                 ADDD    <BasVarSimpleAddr       ; add simple vars address
D4CE DD1B             (dragondos_mmc.asm):04483                 STD     <BasVarSimpleAddr       ; save updated address
                      (dragondos_mmc.asm):04484                 
D4D0 3506             (dragondos_mmc.asm):04485                 PULS    D                       ; pull offset
D4D2 D31D             (dragondos_mmc.asm):04486                 ADDD    <BasVarArrayAddr        ; add beginning of arrays address
D4D4 DD1D             (dragondos_mmc.asm):04487                 STD     <BasVarArrayAddr        ; save updated address
                      (dragondos_mmc.asm):04488                 
D4D6 DE1F             (dragondos_mmc.asm):04489                 LDU     BasVarEnd               ; get address of end of vars
D4D8 109E1D           (dragondos_mmc.asm):04490                 LDY     <BasVarArrayAddr        ; get address of arrays
D4DB 9DA5             (dragondos_mmc.asm):04491                 JSR     <BasChrGetCurr          ; get next character from basic
D4DD 271E             (dragondos_mmc.asm):04492                 BEQ     LD652                   ; no character, skip on
                      (dragondos_mmc.asm):04493                 
D4DF C62C             (dragondos_mmc.asm):04494                 LDB     #','                    ; check for a comma
D4E1 BD89AC           (dragondos_mmc.asm):04495                 JSR     >VarCKChar              ; error if not
                      (dragondos_mmc.asm):04496                 
D4E4 BD869A           (dragondos_mmc.asm):04497                 JSR     >BasGetLineNo           ; get supplied line number, convert to binary 
D4E7 BD8424           (dragondos_mmc.asm):04498                 JSR     >BasVect1a              ; "erase" basic vars
D4EA DF1F             (dragondos_mmc.asm):04499                 STU     BasVarEnd               ; restore end of variables
                      (dragondos_mmc.asm):04500                 
D4EC 109F1D           (dragondos_mmc.asm):04501                 STY     <BasVarArrayAddr        ; restore array address
D4EF 10BE0656         (dragondos_mmc.asm):04502                 LDY     DosCurFilename+6        ; get length of program to chain
D4F3 BDD398           (dragondos_mmc.asm):04503                 JSR     >LD4ED                  ; go load it
                      (dragondos_mmc.asm):04504                 
D4F6 DC2B             (dragondos_mmc.asm):04505                 LDD     <BasTempLine            ; get line to start running at
D4F8 BD85E7           (dragondos_mmc.asm):04506                 JSR     >BasSkipLineNo          ; go skip to it
D4FB 200F             (dragondos_mmc.asm):04507                 BRA     LD661
                      (dragondos_mmc.asm):04508         
D4FD BD841F           (dragondos_mmc.asm):04509         LD652   JSR     >BasVect1               ; "erase" basic vars
D500 DF1F             (dragondos_mmc.asm):04510                 STU     BasVarEnd               ; restore end of variables
                      (dragondos_mmc.asm):04511                 
D502 109F1D           (dragondos_mmc.asm):04512                 STY     <BasVarArrayAddr        ; restore array address
D505 10BE0656         (dragondos_mmc.asm):04513                 LDY     DosCurFilename+6        ; get length of program to chain
D509 BDD398           (dragondos_mmc.asm):04514                 JSR     >LD4ED                  ; go load it
                      (dragondos_mmc.asm):04515         
D50C C601             (dragondos_mmc.asm):04516         LD661   LDB     #$01                    ; flag run
D50E F70611           (dragondos_mmc.asm):04517                 STB     DosRunLoadFlag  
D511 7ED379           (dragondos_mmc.asm):04518                 JMP     >LD4CE                  ; go run it
                      (dragondos_mmc.asm):04519         
                      (dragondos_mmc.asm):04520         ; scan simple variable and array areas, for any string variables, check if they 
                      (dragondos_mmc.asm):04521         ; already reside in the cleared string area at the top of RAM. If not move them
                      (dragondos_mmc.asm):04522         ; there. This is done as strings may be defined as literals within the program text
                      (dragondos_mmc.asm):04523         ; these will be erased when chaining a program so we need to move them so they 
                      (dragondos_mmc.asm):04524         ; persist.
                      (dragondos_mmc.asm):04525         
D514 DEA6             (dragondos_mmc.asm):04526         LD669   LDU     <BasAddrSigByte         ; get address of current basic program pointer
D516 3450             (dragondos_mmc.asm):04527                 PSHS    X,U                     ; save regs
                      (dragondos_mmc.asm):04528                 
D518 9E1B             (dragondos_mmc.asm):04529                 LDX     <BasVarSimpleAddr       ; point at simple variables
D51A 3002             (dragondos_mmc.asm):04530                 LEAX    2,X                     ; add 2
D51C 9C1D             (dragondos_mmc.asm):04531         LD671   CMPX    <BasVarArrayAddr        ; compare to address of array variables
D51E 240A             (dragondos_mmc.asm):04532                 BCC     LD67F                   ; Found end, branch and do arrays
                      (dragondos_mmc.asm):04533                 
D520 6D1F             (dragondos_mmc.asm):04534                 TST     -1,X                    ; test second character of var name
D522 2A02             (dragondos_mmc.asm):04535                 BPL     LD67B                   ; branch if numeric
D524 8D32             (dragondos_mmc.asm):04536                 BSR     LD6AD                   ; check and move string to string area if needed
                      (dragondos_mmc.asm):04537                 
D526 3007             (dragondos_mmc.asm):04538         LD67B   LEAX    7,X                     ; move to next simple var
D528 20F2             (dragondos_mmc.asm):04539                 BRA     LD671                   ; loop again
                      (dragondos_mmc.asm):04540         
D52A DE1D             (dragondos_mmc.asm):04541         LD67F   LDU     <BasVarArrayAddr        ; point at array area
D52C 11931F           (dragondos_mmc.asm):04542         LD681   CMPU    BasVarEnd               ; at end of arrays ?
D52F 241F             (dragondos_mmc.asm):04543                 BCC     LD6A5                   ; yep, exit
                      (dragondos_mmc.asm):04544                 
D531 EC42             (dragondos_mmc.asm):04545                 LDD     2,U                     ; get length of array
D533 30CB             (dragondos_mmc.asm):04546                 LEAX    D,U                     ; point X at array base + len
D535 3410             (dragondos_mmc.asm):04547                 PSHS    X                       ; save X
                      (dragondos_mmc.asm):04548                 
D537 6D41             (dragondos_mmc.asm):04549                 TST     1,U                     ; test array name for string array
D539 2A11             (dragondos_mmc.asm):04550                 BPL     LD6A1                   ; it's numeric, skip on
                      (dragondos_mmc.asm):04551                 
D53B E644             (dragondos_mmc.asm):04552                 LDB     4,U                     ; get number of dimensions
D53D 4F               (dragondos_mmc.asm):04553                 CLRA                            ; zero MSB
D53E 58               (dragondos_mmc.asm):04554                 ASLB                            ; multiply no of dimensions, by 2 
                      (dragondos_mmc.asm):04555                                                 ; as dimension lengths are each 2 bytes
D53F 30CB             (dragondos_mmc.asm):04556                 LEAX    D,U                     ; point X at beginning of array data
D541 3005             (dragondos_mmc.asm):04557                 LEAX    5,X                     ; add on header size
                      (dragondos_mmc.asm):04558                 
D543 BDD558           (dragondos_mmc.asm):04559         LD698   JSR     >LD6AD                  ; check string descriptot and move to string space if needed
D546 3005             (dragondos_mmc.asm):04560                 LEAX    5,X                     ; move to next descriptor in array
D548 ACE4             (dragondos_mmc.asm):04561                 CMPX    ,S                      ; reached the end of this array yet?
D54A 25F7             (dragondos_mmc.asm):04562                 BCS     LD698                   ; nope, keep checking
                      (dragondos_mmc.asm):04563                 
D54C 3540             (dragondos_mmc.asm):04564         LD6A1   PULS    U                       ; restore pointer to next array
D54E 20DC             (dragondos_mmc.asm):04565                 BRA     LD681                   ; and loop again
                      (dragondos_mmc.asm):04566         
D550 BD8CD7           (dragondos_mmc.asm):04567         LD6A5   JSR     >VarGarbageCollect      ; garbage collect
D553 3550             (dragondos_mmc.asm):04568                 PULS    X,U                     ; restore regs
D555 DFA6             (dragondos_mmc.asm):04569                 STU     <BasAddrSigByte         ; restore basic pointer
D557 39               (dragondos_mmc.asm):04570                 RTS
                      (dragondos_mmc.asm):04571         
                      (dragondos_mmc.asm):04572         ; move a string into the string area if not null and not already there.
                      (dragondos_mmc.asm):04573         ; enter with X pointing to the descriptor of the string to move, typically from
                      (dragondos_mmc.asm):04574         ; the simple variables area
                      (dragondos_mmc.asm):04575         
D558 3450             (dragondos_mmc.asm):04576         LD6AD   PSHS    X,U                     ; save regs
D55A 9C21             (dragondos_mmc.asm):04577                 CMPX    <BasVarStringBase       ; is string in string area in high memory?
D55C 2413             (dragondos_mmc.asm):04578                 BCC     LD6C6                   ; yes, no need to move it
                      (dragondos_mmc.asm):04579                 
D55E E684             (dragondos_mmc.asm):04580                 LDB     ,X                      ; get string length
D560 270F             (dragondos_mmc.asm):04581                 BEQ     LD6C6                   ; no need to move null string
                      (dragondos_mmc.asm):04582                 
D562 BD8CB3           (dragondos_mmc.asm):04583                 JSR     >BasResStr2             ; reserve bytes in string area for B bytes
D565 1F13             (dragondos_mmc.asm):04584                 TFR     X,U                     ; point U at new string         
D567 10AEE4           (dragondos_mmc.asm):04585                 LDY     ,S                      ; point y at old string
D56A AE22             (dragondos_mmc.asm):04586                 LDX     2,Y                     ; get address of old string data
D56C EF22             (dragondos_mmc.asm):04587                 STU     2,Y                     ; update sescriptor's string pointer with new string
D56E BDB7CC           (dragondos_mmc.asm):04588                 JSR     >UtilCopyBXtoU          ; copy the string data
D571 35D0             (dragondos_mmc.asm):04589         LD6C6   PULS    X,U,PC                  ; restore and return
                      (dragondos_mmc.asm):04590         
                      (dragondos_mmc.asm):04591         
                      (dragondos_mmc.asm):04592         ;
                      (dragondos_mmc.asm):04593         ; Validate and open DAT file supplied on command
                      (dragondos_mmc.asm):04594         ;
                      (dragondos_mmc.asm):04595         
D573                  (dragondos_mmc.asm):04596         DosValidateAndOpenDAT   
D573 108EDD0A         (dragondos_mmc.asm):04597                 LDY     #DosExtDat              ; get pointer to extension 'DAT'
D577 200A             (dragondos_mmc.asm):04598                 BRA     DosGetFilenameAndOpenExt
                      (dragondos_mmc.asm):04599         
                      (dragondos_mmc.asm):04600         ;
                      (dragondos_mmc.asm):04601         ; Validate and open Basic program file supplied on command
                      (dragondos_mmc.asm):04602         ;
                      (dragondos_mmc.asm):04603         
D579                  (dragondos_mmc.asm):04604         DosValidateAndOpenBAS   
D579 108EDD07         (dragondos_mmc.asm):04605                 LDY     #DosExtBas              ; get pointer to extension 'BAS'
D57D 2004             (dragondos_mmc.asm):04606                 BRA     DosGetFilenameAndOpenExt
                      (dragondos_mmc.asm):04607         
                      (dragondos_mmc.asm):04608         ;
                      (dragondos_mmc.asm):04609         ; Get a filename from Dos and open it
                      (dragondos_mmc.asm):04610         ;       Takes a string supplied on command name, fetches it and
                      (dragondos_mmc.asm):04611         ;       tries to open the file of that name.
                      (dragondos_mmc.asm):04612         ; 
                      (dragondos_mmc.asm):04613         ; If entered at DosGetFilenameAndOpenExt then extension must be pointed to by Y
                      (dragondos_mmc.asm):04614         ;
                      (dragondos_mmc.asm):04615         ; Exits with :-
                      (dragondos_mmc.asm):04616         ;       A       = FCB number for opened file
                      (dragondos_mmc.asm):04617         ;       B       = Error code 
                      (dragondos_mmc.asm):04618         ;       Y       = ptr to extension
                      (dragondos_mmc.asm):04619         ;
                      (dragondos_mmc.asm):04620         
D57F                  (dragondos_mmc.asm):04621         DosGetFilenameAndOpen   
D57F 108EDD10         (dragondos_mmc.asm):04622                 LDY     #DosExtNone             ; Point to Blank extension
                      (dragondos_mmc.asm):04623         
D583                  (dragondos_mmc.asm):04624         DosGetFilenameAndOpenExt   
D583 3420             (dragondos_mmc.asm):04625                 PSHS    Y                       ; save extension pointer
D585 BD8887           (dragondos_mmc.asm):04626                 JSR     >VarGetStr              ; get string into temp variable
D588 BD8877           (dragondos_mmc.asm):04627                 JSR     >VarGetExpr             ; Get address of string in FAC
D58B 3520             (dragondos_mmc.asm):04628                 PULS    Y
                      (dragondos_mmc.asm):04629                 
D58D                  (dragondos_mmc.asm):04630         DosOpenFileExtY   
D58D 9E52             (dragondos_mmc.asm):04631                 LDX     <FPA0+2                 ; get address of filename string
D58F 3410             (dragondos_mmc.asm):04632                 PSHS    X
D591 E684             (dragondos_mmc.asm):04633                 LDB     ,X                      ; Get string length
D593 AE02             (dragondos_mmc.asm):04634                 LDX     2,X                     ; Get pointer to actual string data
D595 BDC662           (dragondos_mmc.asm):04635                 JSR     >DosValidateAndOpen     ; Validate & open file (if valid)
D598 3510             (dragondos_mmc.asm):04636                 PULS    X
D59A 3406             (dragondos_mmc.asm):04637                 PSHS    D
D59C BD8D9F           (dragondos_mmc.asm):04638                 JSR     >VarDelVar              ; delete var
D59F 3506             (dragondos_mmc.asm):04639                 PULS    D
D5A1 5D               (dragondos_mmc.asm):04640                 TSTB                            ; Test error and set flags
D5A2 39               (dragondos_mmc.asm):04641                 RTS
                      (dragondos_mmc.asm):04642         
D5A3 7EC56F           (dragondos_mmc.asm):04643         LD6F8   JMP     >DosHookSysError
                      (dragondos_mmc.asm):04644         
                      (dragondos_mmc.asm):04645         ; 
                      (dragondos_mmc.asm):04646         ; Close 1 or all files.
                      (dragondos_mmc.asm):04647         ;
                      (dragondos_mmc.asm):04648         
D5A6                  (dragondos_mmc.asm):04649         DosCloseAllFiles   
D5A6 8609             (dragondos_mmc.asm):04650                 LDA     #$09                    ; set current control block to 10
D5A8 97F1             (dragondos_mmc.asm):04651                 STA     <DosCurrCtrlBlk
                      (dragondos_mmc.asm):04652                 
D5AA BDCD7E           (dragondos_mmc.asm):04653         LD6FF   JSR     >DosCloseFile2          ; Try to close the file for this block
D5AD 2619             (dragondos_mmc.asm):04654                 BNE     LD71D                   ; error : call error handler
                      (dragondos_mmc.asm):04655                 
D5AF 0AF1             (dragondos_mmc.asm):04656                 DEC     <DosCurrCtrlBlk         ; do next
D5B1 2AF7             (dragondos_mmc.asm):04657                 BPL     LD6FF
                      (dragondos_mmc.asm):04658                 
D5B3 0FF6             (dragondos_mmc.asm):04659         LD708   CLR     <DosIOInProgress        ; flag no dos io 
D5B5 39               (dragondos_mmc.asm):04660         LD70A   RTS
                      (dragondos_mmc.asm):04661         
D5B6                  (dragondos_mmc.asm):04662         DosCloseSingleFile      
D5B6 5D               (dragondos_mmc.asm):04663                 TSTB
D5B7 2FFC             (dragondos_mmc.asm):04664                 BLE     LD70A                   ; >= 0, not ours
D5B9 0F6F             (dragondos_mmc.asm):04665                 CLR     <DTextDevN              ; reset device number
D5BB 3262             (dragondos_mmc.asm):04666                 LEAS    2,S                     ; drop return address
D5BD 0DF7             (dragondos_mmc.asm):04667                 TST     <$F7                    ; don't think this is correct!
D5BF 260A             (dragondos_mmc.asm):04668                 BNE     DosHookReadInput        
                      (dragondos_mmc.asm):04669                 
D5C1 D7EB             (dragondos_mmc.asm):04670                 STB     <DosDriveNo             ; save last active drive
                      (dragondos_mmc.asm):04671                 
D5C3 BDCD66           (dragondos_mmc.asm):04672                 JSR     >DOSCloseAll            ; close all files
D5C6 27EB             (dragondos_mmc.asm):04673         LD71B   BEQ     LD708                   ; exit
                      (dragondos_mmc.asm):04674         
D5C8 7EC56F           (dragondos_mmc.asm):04675         LD71D   JMP     >DosHookSysError
                      (dragondos_mmc.asm):04676         
D5CB                  (dragondos_mmc.asm):04677         DosHookReadInput   
D5CB 8DD9             (dragondos_mmc.asm):04678                 BSR     DosCloseAllFiles        ; close all files
D5CD 7ED9EC           (dragondos_mmc.asm):04679                 JMP     >CheckAndDoAuto         ; check see if auto active, if so do it
                      (dragondos_mmc.asm):04680         
                      (dragondos_mmc.asm):04681         ;
                      (dragondos_mmc.asm):04682         ; CREATE command dispatch routine
                      (dragondos_mmc.asm):04683         ;
                      (dragondos_mmc.asm):04684         ; Syntax :
                      (dragondos_mmc.asm):04685         ;
                      (dragondos_mmc.asm):04686         ;       CREATE "filename",size_in_bytes
                      (dragondos_mmc.asm):04687         ;
                      (dragondos_mmc.asm):04688         
D5D0                  (dragondos_mmc.asm):04689         CmdCreate   
D5D0 BDD573           (dragondos_mmc.asm):04690                 JSR     >DosValidateAndOpenDAT  ; validate and open the supplied filename
D5D3 2708             (dragondos_mmc.asm):04691                 BEQ     LD732                   ; branch if no error
                      (dragondos_mmc.asm):04692                 
D5D5 C19E             (dragondos_mmc.asm):04693                 CMPB    #ErrFE          ; check for file exists
D5D7 2704             (dragondos_mmc.asm):04694                 BEQ     LD732                   ; if it exists just set length
                      (dragondos_mmc.asm):04695                 
D5D9 C1A0             (dragondos_mmc.asm):04696                 CMPB    #ErrNE          ; File does not exist error
D5DB 26EB             (dragondos_mmc.asm):04697                 BNE     LD71D                   ; call error handler
                      (dragondos_mmc.asm):04698                 
D5DD 96F1             (dragondos_mmc.asm):04699         LD732   LDA     <DosCurrCtrlBlk         ; get current control block
D5DF BDCDBF           (dragondos_mmc.asm):04700                 JSR     >DOSCreateFile          ; go create the file
D5E2 26E4             (dragondos_mmc.asm):04701                 BNE     LD71D                   ; if error, call the error handler
                      (dragondos_mmc.asm):04702                 
D5E4 9DA5             (dragondos_mmc.asm):04703                 JSR     <BasChrGetCurr          ; get current character from basic
D5E6 2736             (dragondos_mmc.asm):04704                 BEQ     LD773                   ; nothing, return, crate zero length file
                      (dragondos_mmc.asm):04705                 
D5E8 BD89AA           (dragondos_mmc.asm):04706                 JSR     >VarCKComma             ; syntax check for comma 
D5EB BD8887           (dragondos_mmc.asm):04707                 JSR     >VarGetStr
                      (dragondos_mmc.asm):04708                 
D5EE BDD72F           (dragondos_mmc.asm):04709                 JSR     >Get24bitUA             ; get filesize?
D5F1 0D51             (dragondos_mmc.asm):04710         LD746   TST     <FPA0+1
D5F3 2712             (dragondos_mmc.asm):04711                 BEQ     LD75C
                      (dragondos_mmc.asm):04712                 
D5F5 CCFF00           (dragondos_mmc.asm):04713                 LDD     #$FF00                  ; claculate ammount to extend file by
D5F8 8D1F             (dragondos_mmc.asm):04714                 BSR     LD76E
                      (dragondos_mmc.asm):04715                 
D5FA DC52             (dragondos_mmc.asm):04716                 LDD     <FPA0+2
D5FC 83FF00           (dragondos_mmc.asm):04717                 SUBD    #$FF00
D5FF DD52             (dragondos_mmc.asm):04718                 STD     <FPA0+2
D601 24EE             (dragondos_mmc.asm):04719                 BCC     LD746
                      (dragondos_mmc.asm):04720                 
D603 0A51             (dragondos_mmc.asm):04721                 DEC     <FPA0+1
D605 26EA             (dragondos_mmc.asm):04722                 BNE     LD746
                      (dragondos_mmc.asm):04723                 
D607 DC52             (dragondos_mmc.asm):04724         LD75C   LDD     <FPA0+2
D609 27AA             (dragondos_mmc.asm):04725                 BEQ     LD70A
                      (dragondos_mmc.asm):04726                 
D60B 1083FF00         (dragondos_mmc.asm):04727                 CMPD    #$FF00
D60F 2308             (dragondos_mmc.asm):04728                 BLS     LD76E
                      (dragondos_mmc.asm):04729                 
D611 83FF00           (dragondos_mmc.asm):04730                 SUBD    #$FF00
D614 8D03             (dragondos_mmc.asm):04731                 BSR     LD76E
                      (dragondos_mmc.asm):04732                 
D616 CCFF00           (dragondos_mmc.asm):04733                 LDD     #$FF00
                      (dragondos_mmc.asm):04734         
D619 BDCA97           (dragondos_mmc.asm):04735         LD76E   JSR     >ExtendFile             ; extend file
D61C 26AA             (dragondos_mmc.asm):04736                 BNE     LD71D                   ; call error handler if error
D61E 39               (dragondos_mmc.asm):04737         LD773   RTS
                      (dragondos_mmc.asm):04738         
                      (dragondos_mmc.asm):04739         ;
                      (dragondos_mmc.asm):04740         ; Remove a file from disk directory, deallocate any space on the disk
                      (dragondos_mmc.asm):04741         ; for this file.
                      (dragondos_mmc.asm):04742         ;
                      (dragondos_mmc.asm):04743         ;   KILL "filename"
                      (dragondos_mmc.asm):04744         ;
                      (dragondos_mmc.asm):04745         
D61F                  (dragondos_mmc.asm):04746         CmdKill   
D61F BDD57F           (dragondos_mmc.asm):04747                 JSR     >DosGetFilenameAndOpen  ; find the filename and open it
D622 2605             (dragondos_mmc.asm):04748                 BNE     LD77E                   ; error, exit
                      (dragondos_mmc.asm):04749                 
D624 BDCE61           (dragondos_mmc.asm):04750                 JSR     >DOSDeleteFile          ; delete the file
D627 278A             (dragondos_mmc.asm):04751                 BEQ     LD708                   ; no error, return to basic
                      (dragondos_mmc.asm):04752                 
D629 7EC56F           (dragondos_mmc.asm):04753         LD77E   JMP     >DosHookSysError        ; call error handler
                      (dragondos_mmc.asm):04754         
                      (dragondos_mmc.asm):04755         ;
                      (dragondos_mmc.asm):04756         ; Protect/unprotect a file.
                      (dragondos_mmc.asm):04757         ;
                      (dragondos_mmc.asm):04758         ;   PROTECT "filename"          turns ON protection
                      (dragondos_mmc.asm):04759         ;   PROTECT ON "filename"       turns ON protection
                      (dragondos_mmc.asm):04760         ;   PROTECT OFF "filename"      turns OFF protection
                      (dragondos_mmc.asm):04761         ;
                      (dragondos_mmc.asm):04762         
D62C                  (dragondos_mmc.asm):04763         CmdProtect   
D62C 4D               (dragondos_mmc.asm):04764                 TSTA                            ; test current character
D62D 2A0A             (dragondos_mmc.asm):04765                 BPL     BasProtectOn            ; go get filename, protect on
                      (dragondos_mmc.asm):04766                 
D62F 81C2             (dragondos_mmc.asm):04767                 CMPA    #DTokOFF                ; 'OFF' token?
D631 2718             (dragondos_mmc.asm):04768                 BEQ     BasProtectOff           ; yep go deal with it
                      (dragondos_mmc.asm):04769                 
D633 8188             (dragondos_mmc.asm):04770                 CMPA    #DTokON                 ; 'ON' token
D635 1026B37B         (dragondos_mmc.asm):04771                 LBNE    BasSNError              ; nope, SN error
                      (dragondos_mmc.asm):04772         
D639                  (dragondos_mmc.asm):04773         BasProtectOn
D639 8D08             (dragondos_mmc.asm):04774                 BSR     LD798                   ; get filename
D63B C601             (dragondos_mmc.asm):04775                 LDB     #$01                    ; flag protect on
D63D BDCF48           (dragondos_mmc.asm):04776         LD792   JSR     DOSProtectMC            ; go turn it off/on
D640 26E7             (dragondos_mmc.asm):04777                 BNE     LD77E                   ; Go handle errors
D642 39               (dragondos_mmc.asm):04778                 RTS
                      (dragondos_mmc.asm):04779         
D643 9D9F             (dragondos_mmc.asm):04780         LD798   JSR     <BasChrGet              ; get a character from basic
D645 BDD57F           (dragondos_mmc.asm):04781                 JSR     DosGetFilenameAndOpen   ; get the filename and open file
D648 2625             (dragondos_mmc.asm):04782                 BNE     LD7C4                   ; Go handle errors
D64A 39               (dragondos_mmc.asm):04783                 RTS
                      (dragondos_mmc.asm):04784         
D64B                  (dragondos_mmc.asm):04785         BasProtectOff   
D64B 8DF6             (dragondos_mmc.asm):04786                 BSR     LD798                   ; go get filename
D64D 5F               (dragondos_mmc.asm):04787                 CLRB                            ; flag protect off
D64E 20ED             (dragondos_mmc.asm):04788                 BRA     LD792                   ; go do it
                      (dragondos_mmc.asm):04789         
                      (dragondos_mmc.asm):04790         ;
                      (dragondos_mmc.asm):04791         ; Rename a file.
                      (dragondos_mmc.asm):04792         ;
                      (dragondos_mmc.asm):04793         ;   RENAME "oldname" TO "newname"
                      (dragondos_mmc.asm):04794         ;
                      (dragondos_mmc.asm):04795         
D650                  (dragondos_mmc.asm):04796         CmdRename   
D650 BDD57F           (dragondos_mmc.asm):04797                 JSR     >DosGetFilenameAndOpen  ; get first filename and open it
D653 261A             (dragondos_mmc.asm):04798                 BNE     LD7C4                   ; error, exit
                      (dragondos_mmc.asm):04799                 
D655 3402             (dragondos_mmc.asm):04800                 PSHS    A                       ; save FCB no
D657 C6BC             (dragondos_mmc.asm):04801                 LDB     #DTokTO                 ; check for 'TO' token
D659 BD89AC           (dragondos_mmc.asm):04802                 JSR     >VarCKChar              ; syntax check for it
                      (dragondos_mmc.asm):04803                 
D65C BDD57F           (dragondos_mmc.asm):04804                 JSR     >DosGetFilenameAndOpen  ; get second filename and open
D65F 270C             (dragondos_mmc.asm):04805                 BEQ     LD7C2                   ; generate error
                      (dragondos_mmc.asm):04806                 
D661 C1A0             (dragondos_mmc.asm):04807                 CMPB    #ErrNE                  ; Error from open "Not exist"?
D663 260A             (dragondos_mmc.asm):04808                 BNE     LD7C4                   ; no, real error
                      (dragondos_mmc.asm):04809                 
D665 3502             (dragondos_mmc.asm):04810                 PULS    A                       ; restore FCB no
D667 BDCF7A           (dragondos_mmc.asm):04811                 JSR     >DOSRename              ; go change the name.
D66A 2603             (dragondos_mmc.asm):04812                 BNE     LD7C4                   ; deal with error
D66C 39               (dragondos_mmc.asm):04813                 RTS
                      (dragondos_mmc.asm):04814         
D66D C69E             (dragondos_mmc.asm):04815         LD7C2   LDB     #ErrFE                  ; File exists error for destinatiion file
D66F 7EC56F           (dragondos_mmc.asm):04816         LD7C4   JMP     >DosHookSysError        ; deal with errors
                      (dragondos_mmc.asm):04817         
                      (dragondos_mmc.asm):04818         ;
                      (dragondos_mmc.asm):04819         ; Basic FLREAD.
                      (dragondos_mmc.asm):04820         ; 
                      (dragondos_mmc.asm):04821         
D672                  (dragondos_mmc.asm):04822         CmdFLRead   
D672 8D0D             (dragondos_mmc.asm):04823                 BSR     FLReadSetup             ; get setup for read open file etc
D674 86FF             (dragondos_mmc.asm):04824                 LDA     #$FF                    ; flag FLREAD
D676 B70612           (dragondos_mmc.asm):04825                 STA     DosFlFreadFlag
D679 BDD814           (dragondos_mmc.asm):04826                 JSR     >LD969                  ; do the read
D67C 8D30             (dragondos_mmc.asm):04827                 BSR     LD803                   ; fix the pointers
D67E 7E9DD9           (dragondos_mmc.asm):04828                 JMP     >BasLineInputEntry      ; finish off input put it into string
                      (dragondos_mmc.asm):04829                 
                      (dragondos_mmc.asm):04830         
D681                  (dragondos_mmc.asm):04831         FLReadSetup   
D681 BDD573           (dragondos_mmc.asm):04832                 JSR     >DosValidateAndOpenDAT  ; validate filename and open it
D684 2652             (dragondos_mmc.asm):04833                 BNE     LD82D                   ; error, exit
                      (dragondos_mmc.asm):04834                 
D686 BDD6DB           (dragondos_mmc.asm):04835                 JSR     >FLRWGetNamePos         ; get name of file, and filepointer pos
D689 BDCD57           (dragondos_mmc.asm):04836                 JSR     >DosFCBNoToAddr         ; get address of FCB in X
                      (dragondos_mmc.asm):04837                 
D68C 7D067E           (dragondos_mmc.asm):04838                 TST     DosTemp2                ; did we set the filepointer
D68F 270A             (dragondos_mmc.asm):04839                 BEQ     LD7F0                   ; branch if not
                      (dragondos_mmc.asm):04840                 
D691 FE0664           (dragondos_mmc.asm):04841                 LDU     DosFWriteAddr           ; get offset to read from
D694 F60666           (dragondos_mmc.asm):04842                 LDB     DosFWriteAddr+2
D697 EF0C             (dragondos_mmc.asm):04843                 STU     FCBFilePointer,X        ; copy to FCB
D699 E70E             (dragondos_mmc.asm):04844                 STB     FCBFilePointer+2,X
                      (dragondos_mmc.asm):04845                 
D69B BDD887           (dragondos_mmc.asm):04846         LD7F0   JSR     >LD9DC                  ; check and read file
D69E 8E02DC           (dragondos_mmc.asm):04847                 LDX     #BasLinInpBuff          ; point at basic input buffer
D6A1 6F84             (dragondos_mmc.asm):04848                 CLR     ,X                      ; clear fist byte
D6A3 9D9F             (dragondos_mmc.asm):04849                 JSR     <BasChrGet              ; go read from buffer.
D6A5 39               (dragondos_mmc.asm):04850                 RTS                             
                      (dragondos_mmc.asm):04851         
                      (dragondos_mmc.asm):04852         ;
                      (dragondos_mmc.asm):04853         ; Basic FREAD command
                      (dragondos_mmc.asm):04854         ;
                      (dragondos_mmc.asm):04855         ; FREAD "filename",FROM xx, FOR yy; variable list
                      (dragondos_mmc.asm):04856         ;
                      (dragondos_mmc.asm):04857         ;       0 > xx > 350208
                      (dragondos_mmc.asm):04858         ;       0 > yy > 255
                      (dragondos_mmc.asm):04859         ;
                      (dragondos_mmc.asm):04860          
D6A6                  (dragondos_mmc.asm):04861         CmdFRead   
D6A6 8DD9             (dragondos_mmc.asm):04862                 BSR     FLReadSetup             ; get setup for read open file etc
D6A8 7F0612           (dragondos_mmc.asm):04863                 CLR     DosFlFreadFlag          ; flag FREAD
                      (dragondos_mmc.asm):04864                 
D6AB BD877A           (dragondos_mmc.asm):04865                 JSR     >CmdReadFromX           ; read  the input
                      (dragondos_mmc.asm):04866         
                      (dragondos_mmc.asm):04867         ; give what we didn't use back... this relies on TempL and TempC
                      (dragondos_mmc.asm):04868         ; being in conecutive memory locations.
                      (dragondos_mmc.asm):04869         ; Count of read bytes ios in TempC:TempL
                      (dragondos_mmc.asm):04870         ;
D6AE BDCD57           (dragondos_mmc.asm):04871         LD803   JSR     >DosFCBNoToAddr         ; get address of FCB
D6B1 F60604           (dragondos_mmc.asm):04872                 LDB     TempL                   ; is there anything left?       
D6B4 270E             (dragondos_mmc.asm):04873                 BEQ     LD819                   ; no
                      (dragondos_mmc.asm):04874                 
D6B6 7F0603           (dragondos_mmc.asm):04875                 CLR     TempL-1                 ; clear remainder count MSB
D6B9 EC0D             (dragondos_mmc.asm):04876                 LDD     FCBFilePointer+1,X      ; get filepointer
D6BB B30603           (dragondos_mmc.asm):04877                 SUBD    TempL-1                 ; subtract ammount read
D6BE ED0D             (dragondos_mmc.asm):04878                 STD     FCBFilePointer+1,X      ; save it back
D6C0 2402             (dragondos_mmc.asm):04879                 BCC     LD819                   ; any carry to MSB?
D6C2 6A0C             (dragondos_mmc.asm):04880                 DEC     FCBFilePointer,X        ; yes do carry
                      (dragondos_mmc.asm):04881                 
D6C4 0DF4             (dragondos_mmc.asm):04882         LD819   TST     <DosRecLenFlag          ; test record length flag       
D6C6 270D             (dragondos_mmc.asm):04883                 BEQ     LD82A                   ; zero, exit, no FOR statement
                      (dragondos_mmc.asm):04884                 
D6C8 D6F3             (dragondos_mmc.asm):04885                 LDB     <DosNoBytesMove         ; check number of bytes specified in FOR
D6CA 2709             (dragondos_mmc.asm):04886                 BEQ     LD82A                   ; zero, exit
                      (dragondos_mmc.asm):04887                 
D6CC 4F               (dragondos_mmc.asm):04888                 CLRA                            ; clear MSB
D6CD E30D             (dragondos_mmc.asm):04889                 ADDD    FCBFilePointer+1,X      ; add FOR to filepointer
D6CF ED0D             (dragondos_mmc.asm):04890                 STD     FCBFilePointer+1,X
D6D1 2402             (dragondos_mmc.asm):04891                 BCC     LD82A                   ; branch if no carry
D6D3 6C0C             (dragondos_mmc.asm):04892                 INC     FCBFilePointer,X        ; do carry
                      (dragondos_mmc.asm):04893         
D6D5 0F6F             (dragondos_mmc.asm):04894         LD82A   CLR     <TextDevN               ; input back to console
D6D7 39               (dragondos_mmc.asm):04895         LD82C   RTS
                      (dragondos_mmc.asm):04896         
D6D8 7EC56F           (dragondos_mmc.asm):04897         LD82D   JMP     >DosHookSysError        ; call error handler
                      (dragondos_mmc.asm):04898         
D6DB                  (dragondos_mmc.asm):04899         FLRWGetNamePos   
D6DB BD9C76           (dragondos_mmc.asm):04900                 JSR     >BasChkDirect           ; check for direct mode, error if so
D6DE 96F1             (dragondos_mmc.asm):04901                 LDA     <DosCurrCtrlBlk         ; get current FCB no
D6E0 BDCD24           (dragondos_mmc.asm):04902                 JSR     >DOSGetFLen             ; get file length
D6E3 26F3             (dragondos_mmc.asm):04903                 BNE     LD82D                   ; branch if error
                      (dragondos_mmc.asm):04904                 
D6E5 FF0664           (dragondos_mmc.asm):04905                 STU     DosFWriteAddr           ; save file length, as write address
D6E8 B70666           (dragondos_mmc.asm):04906                 STA     DosFWriteAddr+2         ; so we default to appending to the file
                      (dragondos_mmc.asm):04907                 
D6EB 0FF4             (dragondos_mmc.asm):04908                 CLR     <DosRecLenFlag          ; clear record length
D6ED 7F067E           (dragondos_mmc.asm):04909                 CLR     DosTemp2                ; clear temp var
D6F0 8601             (dragondos_mmc.asm):04910                 LDA     #DevDisk                ; set device number to disk                     
D6F2 976F             (dragondos_mmc.asm):04911                 STA     <TextDevN
                      (dragondos_mmc.asm):04912                 
D6F4 9DA5             (dragondos_mmc.asm):04913         LD849   JSR     <BasChrGetCurr          ; get current character from basic
D6F6 813B             (dragondos_mmc.asm):04914                 CMPA    #';'                    ; is it a semicolon?    
D6F8 27DD             (dragondos_mmc.asm):04915                 BEQ     LD82C                   ; yep get data to read/write
                      (dragondos_mmc.asm):04916                 
D6FA BD89AA           (dragondos_mmc.asm):04917                 JSR     >VarCKComma             ; syntax check for comma
D6FD 81E5             (dragondos_mmc.asm):04918                 CMPA    #DDTokFROM              ; is it 'FROM' token?
D6FF 2614             (dragondos_mmc.asm):04919                 BNE     LD86A                   ; no, deal with it
                      (dragondos_mmc.asm):04920                 
D701 9D9F             (dragondos_mmc.asm):04921                 JSR     <BasChrGet              ; get next character from basic
D703 BD8887           (dragondos_mmc.asm):04922                 JSR     >VarGetStr              ; get filepointer pos to read/write
D706 8D27             (dragondos_mmc.asm):04923                 BSR     Get24bitUA              ; convert it to 24 bit in U:A
                      (dragondos_mmc.asm):04924                 
D708 FF0664           (dragondos_mmc.asm):04925                 STU     DosFWriteAddr           ; update the write address
D70B B70666           (dragondos_mmc.asm):04926                 STA     DosFWriteAddr+2         ; 
D70E 86FF             (dragondos_mmc.asm):04927                 LDA     #$FF                    ; set DosTemp2 flag
D710 B7067E           (dragondos_mmc.asm):04928                 STA     DosTemp2
D713 20DF             (dragondos_mmc.asm):04929                 BRA     LD849                   ; loop again
                      (dragondos_mmc.asm):04930         
D715 8180             (dragondos_mmc.asm):04931         LD86A   CMPA    #DTokFOR                ; for token?
D717 260D             (dragondos_mmc.asm):04932                 BNE     GenBasSNError           ; nope, generate SN error
                      (dragondos_mmc.asm):04933                 
D719 9D9F             (dragondos_mmc.asm):04934                 JSR     <BasChrGet              ; get it from basic
D71B BDC510           (dragondos_mmc.asm):04935                 JSR     >Get8BitorError         ; go get an 8 bit record size
                      (dragondos_mmc.asm):04936                 
D71E D7F3             (dragondos_mmc.asm):04937                 STB     <DosNoBytesMove         ; save record size
D720 C6FF             (dragondos_mmc.asm):04938                 LDB     #$FF                    ; flag record size used
D722 D7F4             (dragondos_mmc.asm):04939                 STB     <DosRecLenFlag          
D724 20CE             (dragondos_mmc.asm):04940                 BRA     LD849
                      (dragondos_mmc.asm):04941         
D726                  (dragondos_mmc.asm):04942         GenBasSNError   
D726 7E89B4           (dragondos_mmc.asm):04943                 JMP     >BasSNError             ; generate syntax error
                      (dragondos_mmc.asm):04944         
D729                  (dragondos_mmc.asm):04945         GenBasFCError   
D729 7E8B8D           (dragondos_mmc.asm):04946                 JMP     >BasFCError             ; generate FC error
                      (dragondos_mmc.asm):04947         
D72C                  (dragondos_mmc.asm):04948         GenBasTMError   
D72C 7E8882           (dragondos_mmc.asm):04949                 JMP     >BasTMError             ; generate TM error
                      (dragondos_mmc.asm):04950         
                      (dragondos_mmc.asm):04951         ; Get a 24 bit number in U:A ?
D72F                  (dragondos_mmc.asm):04952         Get24bitUA   
D72F 0D54             (dragondos_mmc.asm):04953                 TST     <FP0SGN                 ; test sign of mantissa
D731 2BF6             (dragondos_mmc.asm):04954                 BMI     GenBasFCError           ; if minus, generate FC error
                      (dragondos_mmc.asm):04955                 
D733 0D06             (dragondos_mmc.asm):04956                 TST     <BasVarType             ; test variable type
D735 26F5             (dragondos_mmc.asm):04957                 BNE     GenBasTMError           ; if not numeric generate TM error
                      (dragondos_mmc.asm):04958                 
D737 86A0             (dragondos_mmc.asm):04959                 LDA     #$A0                                            
D739 904F             (dragondos_mmc.asm):04960                 SUBA    <FP0EXP                 ; calculate number of shifts to do
D73B 270B             (dragondos_mmc.asm):04961                 BEQ     LD89D                   ; branch if zero, no ajustment needed
                      (dragondos_mmc.asm):04962                 
D73D 0450             (dragondos_mmc.asm):04963         LD892   LSR     <FPA0                   ; rotate / shift FPA0, A times
D73F 0651             (dragondos_mmc.asm):04964                 ROR     <FPA0+1
D741 0652             (dragondos_mmc.asm):04965                 ROR     <FPA0+2
D743 0653             (dragondos_mmc.asm):04966                 ROR     <FPA0+3
D745 4A               (dragondos_mmc.asm):04967                 DECA
D746 26F5             (dragondos_mmc.asm):04968                 BNE     LD892
                      (dragondos_mmc.asm):04969                 
D748 DE51             (dragondos_mmc.asm):04970         LD89D   LDU     <FPA0+1                 ; return in U:A
D74A 9653             (dragondos_mmc.asm):04971                 LDA     <FPA0+3
D74C 39               (dragondos_mmc.asm):04972                 RTS
                      (dragondos_mmc.asm):04973         
D74D 7EC56F           (dragondos_mmc.asm):04974         LD8A2   JMP     >DosHookSysError        ; call error handler
                      (dragondos_mmc.asm):04975         
                      (dragondos_mmc.asm):04976         ; 
                      (dragondos_mmc.asm):04977         ; basic FWRITE command
                      (dragondos_mmc.asm):04978         ;
                      (dragondos_mmc.asm):04979         ; FWRITE "filename",AT xx, FOR yy; variable list
                      (dragondos_mmc.asm):04980         ;
                      (dragondos_mmc.asm):04981         ;       0 > xx > 350208
                      (dragondos_mmc.asm):04982         ;       0 > yy > 255
                      (dragondos_mmc.asm):04983         ;
                      (dragondos_mmc.asm):04984         
D750                  (dragondos_mmc.asm):04985         CmdFWrite   
D750 BDD573           (dragondos_mmc.asm):04986                 JSR     >DosValidateAndOpenDAT  ; open and validate file
D753 2709             (dragondos_mmc.asm):04987                 BEQ     LD8B3                   ; no error, branch on
                      (dragondos_mmc.asm):04988                 
D755 C1A0             (dragondos_mmc.asm):04989                 CMPB    #ErrNE                  ; Does the file not exist?
D757 26F4             (dragondos_mmc.asm):04990                 BNE     LD8A2                   ; no it was another, error handle it.
                      (dragondos_mmc.asm):04991                 
D759 BDCDBF           (dragondos_mmc.asm):04992                 JSR     >DOSCreateFile          ; create the file if it does not exist
D75C 26EF             (dragondos_mmc.asm):04993                 BNE     LD8A2                   ; error handle it
                      (dragondos_mmc.asm):04994                 
D75E BDD6DB           (dragondos_mmc.asm):04995         LD8B3   JSR     >FLRWGetNamePos         ; get name and filepointer to start writing at
D761 BDD11F           (dragondos_mmc.asm):04996                 JSR     >FindFreeDiskBuffer     ; find a free disk buffer, to write data into
D764 26E7             (dragondos_mmc.asm):04997                 BNE     LD8A2                   ; error, exit
                      (dragondos_mmc.asm):04998                 
D766 BF060B           (dragondos_mmc.asm):04999                 STX     DosFWriteBPtr           ; save the buffer pointer 
D769 8655             (dragondos_mmc.asm):05000                 LDA     #BuffInUse              ; mark disk buffer in use       
D76B A702             (dragondos_mmc.asm):05001                 STA     BuffFlag,X              
D76D 0FF2             (dragondos_mmc.asm):05002                 CLR     <DosBytesInDTA          ; no bytes ready to write       
                      (dragondos_mmc.asm):05003                 
D76F 9D9F             (dragondos_mmc.asm):05004                 JSR     <BasChrGet              ; get next character from basic
D771 BD903D           (dragondos_mmc.asm):05005                 JSR     >CmdPrint               ; write it
                      (dragondos_mmc.asm):05006                 
D774 0DF4             (dragondos_mmc.asm):05007                 TST     <DosRecLenFlag          ; test record length
D776 270B             (dragondos_mmc.asm):05008                 BEQ     LD8D8                   ; not used, skip on
                      (dragondos_mmc.asm):05009                 
D778 D6F3             (dragondos_mmc.asm):05010                 LDB     <DosNoBytesMove         ; get record size
D77A 2707             (dragondos_mmc.asm):05011                 BEQ     LD8D8                   ; branch if buffer full?
                      (dragondos_mmc.asm):05012                 
D77C 8620             (dragondos_mmc.asm):05013                 LDA     #' '                    ; else fill remaing buffer with spaces
D77E 8D48             (dragondos_mmc.asm):05014         LD8D3   BSR     LD91D                   ; put in buffer
D780 5A               (dragondos_mmc.asm):05015                 DECB                            ; decrement count
D781 26FB             (dragondos_mmc.asm):05016                 BNE     LD8D3                   ; branch if any left
                      (dragondos_mmc.asm):05017                 
D783 0DF2             (dragondos_mmc.asm):05018         LD8D8   TST     <DosBytesInDTA          ; any bytes in buffer?
D785 2718             (dragondos_mmc.asm):05019                 BEQ     LD8F4                   ; nope, skip
                      (dragondos_mmc.asm):05020                 
D787 BE060B           (dragondos_mmc.asm):05021                 LDX     DosFWriteBPtr           ; get pointer to buffer details
D78A AE05             (dragondos_mmc.asm):05022                 LDX     BuffAddr,X              ; get buffer address
D78C 4F               (dragondos_mmc.asm):05023                 CLRA                            ; set D to bytes in buffer
D78D D6F2             (dragondos_mmc.asm):05024                 LDB     <DosBytesInDTA
D78F 1F03             (dragondos_mmc.asm):05025                 TFR     D,U                     ; transfer it to U
D791 96F1             (dragondos_mmc.asm):05026                 LDA     <DosCurrCtrlBlk         ; get current file no
D793 10BE0664         (dragondos_mmc.asm):05027                 LDY     DosFWriteAddr           ; get filepointer to write at
D797 F60666           (dragondos_mmc.asm):05028                 LDB     DosFWriteAddr+2
                      (dragondos_mmc.asm):05029                 
D79A BDCA04           (dragondos_mmc.asm):05030                 JSR     >DOSFWrite              ; go write to the file
D79D 26AE             (dragondos_mmc.asm):05031                 BNE     LD8A2                   ; branch on error
                      (dragondos_mmc.asm):05032                 
D79F BE060B           (dragondos_mmc.asm):05033         LD8F4   LDX     DosFWriteBPtr           ; get pointer to buffer details
D7A2 6F02             (dragondos_mmc.asm):05034                 CLR     BuffFlag,X              ; mark buffer as free
D7A4 39               (dragondos_mmc.asm):05035         LD8F9   RTS
                      (dragondos_mmc.asm):05036         
                      (dragondos_mmc.asm):05037         ;
                      (dragondos_mmc.asm):05038         ; Check validity of device number
                      (dragondos_mmc.asm):05039         ;
                      (dragondos_mmc.asm):05040         
D7A5                  (dragondos_mmc.asm):05041         DosHookCheckIONum   
D7A5 2FFD             (dragondos_mmc.asm):05042                 BLE     LD8F9                   ; 0 or less, not disk....
D7A7 C104             (dragondos_mmc.asm):05043                 CMPB    #$04                    ; we only use 1
D7A9 2214             (dragondos_mmc.asm):05044                 BHI     LD914                   ; higher, generate DN error
D7AB 3590             (dragondos_mmc.asm):05045                 PULS    X,PC                    ; restore and return
                      (dragondos_mmc.asm):05046         
                      (dragondos_mmc.asm):05047         ;
                      (dragondos_mmc.asm):05048         ; Check for device open.
                      (dragondos_mmc.asm):05049         ;   If device number is greater than zero, the a DN error is called for.
                      (dragondos_mmc.asm):05050         ;
                      (dragondos_mmc.asm):05051         
D7AD                  (dragondos_mmc.asm):05052         DosHookOpenDev   
D7AD 3262             (dragondos_mmc.asm):05053                 LEAS    2,S                     ; drop return address
D7AF BD8887           (dragondos_mmc.asm):05054                 JSR     >VarGetStr              ; evaluate expression
D7B2 BD8DEA           (dragondos_mmc.asm):05055                 JSR     >BasGetStrFirst         ; get first byte of string in B
D7B5 3404             (dragondos_mmc.asm):05056                 PSHS    B                       ; save b
D7B7 BDB7D4           (dragondos_mmc.asm):05057                 JSR     >BasGetDevNo            ; get device number
D7BA 5D               (dragondos_mmc.asm):05058                 TSTB                            ; check device number
D7BB 102FE076         (dragondos_mmc.asm):05059                 LBLE    CmdOpenEntry            ; >=0, go open it
                      (dragondos_mmc.asm):05060                 
D7BF 7EB851           (dragondos_mmc.asm):05061         LD914   JMP     >BasDNError             ; device number error
                      (dragondos_mmc.asm):05062         
                      (dragondos_mmc.asm):05063         ;
                      (dragondos_mmc.asm):05064         ; Character output hook.
                      (dragondos_mmc.asm):05065         ;  The hook routine for writing a single byte to a data file.
                      (dragondos_mmc.asm):05066         ;
                      (dragondos_mmc.asm):05067         
D7C2                  (dragondos_mmc.asm):05068         DosHookCharOut   
D7C2 0D6F             (dragondos_mmc.asm):05069                 TST     <TextDevN               ; test device number
D7C4 2FDE             (dragondos_mmc.asm):05070                 BLE     LD8F9                   ; brance if 0 or -ve, not ours                          
                      (dragondos_mmc.asm):05071                 
D7C6 3262             (dragondos_mmc.asm):05072                 LEAS    2,S                     ; discard return address
D7C8 3476             (dragondos_mmc.asm):05073         LD91D   PSHS    D,X,Y,U                 ; save regs
                      (dragondos_mmc.asm):05074         
D7CA D6F4             (dragondos_mmc.asm):05075                 LDB     <DosRecLenFlag          ; buffering flag?
D7CC 2704             (dragondos_mmc.asm):05076                 BEQ     LD927                   ; no length
                      (dragondos_mmc.asm):05077         
D7CE D6F3             (dragondos_mmc.asm):05078                 LDB     <DosNoBytesMove         ; at end of buffer?
D7D0 2737             (dragondos_mmc.asm):05079                 BEQ     LD95E                   ; write no more
                      (dragondos_mmc.asm):05080         
D7D2 BE060B           (dragondos_mmc.asm):05081         LD927   LDX     DosFWriteBPtr           ; get buffer detail pointer
D7D5 AE05             (dragondos_mmc.asm):05082                 LDX     BuffAddr,X              ; get buffer address    
D7D7 D6F2             (dragondos_mmc.asm):05083                 LDB     <DosBytesInDTA          ; get buffer offset write pointer
D7D9 3A               (dragondos_mmc.asm):05084                 ABX                             ; add to buffer pointer
D7DA A784             (dragondos_mmc.asm):05085                 STA     ,X                      ; save byte in buffer
                      (dragondos_mmc.asm):05086                 
D7DC 0AF3             (dragondos_mmc.asm):05087                 DEC     <DosNoBytesMove         ; decrement bytes left counter
D7DE 0CF2             (dragondos_mmc.asm):05088                 INC     <DosBytesInDTA          ; increment bytes in buffer counter
D7E0 2627             (dragondos_mmc.asm):05089                 BNE     LD95E                   ; branch if still space in buffer
                      (dragondos_mmc.asm):05090                 
D7E2 96F1             (dragondos_mmc.asm):05091                 LDA     <DosCurrCtrlBlk         ; get current file no
D7E4 BE060B           (dragondos_mmc.asm):05092                 LDX     DosFWriteBPtr           ; get buffer detail pointer
D7E7 AE05             (dragondos_mmc.asm):05093                 LDX     BuffAddr,X              ; get buffer address    
D7E9 CE0100           (dragondos_mmc.asm):05094                 LDU     #$0100                  ; write 256 bytes
D7EC 10BE0664         (dragondos_mmc.asm):05095                 LDY     DosFWriteAddr           ; get filepointer
D7F0 F60666           (dragondos_mmc.asm):05096                 LDB     DosFWriteAddr+2
                      (dragondos_mmc.asm):05097                 
D7F3 BDCA04           (dragondos_mmc.asm):05098                 JSR     >DOSFWrite              ; go write it
D7F6 2703             (dragondos_mmc.asm):05099                 BEQ     LD950                   ; branch if no error
                      (dragondos_mmc.asm):05100                 
D7F8 7EC56F           (dragondos_mmc.asm):05101                 JMP     >DosHookSysError        ; call error handler
                      (dragondos_mmc.asm):05102         
D7FB FC0665           (dragondos_mmc.asm):05103         LD950   LDD     DosFWriteAddr+1         ; move filepointer on
D7FE C30100           (dragondos_mmc.asm):05104                 ADDD    #$0100
D801 2403             (dragondos_mmc.asm):05105                 BCC     LD95B                   ; branch if no carry
D803 7C0664           (dragondos_mmc.asm):05106                 INC     DosFWriteAddr           ; carry if needed
D806 FD0665           (dragondos_mmc.asm):05107         LD95B   STD     DosFWriteAddr+1         ; save pilepointer
                      (dragondos_mmc.asm):05108         
D809 35F6             (dragondos_mmc.asm):05109         LD95E   PULS    D,X,Y,U,PC              ; resore and return
                      (dragondos_mmc.asm):05110         
                      (dragondos_mmc.asm):05111         ;
                      (dragondos_mmc.asm):05112         ; Hook to scan input from disk.
                      (dragondos_mmc.asm):05113         ;
                      (dragondos_mmc.asm):05114         ; Should do:
                      (dragondos_mmc.asm):05115         ;   If string:
                      (dragondos_mmc.asm):05116         ;     do not remove leading spaces.
                      (dragondos_mmc.asm):05117         ;     Terminate input on:
                      (dragondos_mmc.asm):05118         ;       $0D - CR
                      (dragondos_mmc.asm):05119         ;       $2C - comma
                      (dragondos_mmc.asm):05120         ;       EOF
                      (dragondos_mmc.asm):05121         ;
                      (dragondos_mmc.asm):05122         ;   If numeric:
                      (dragondos_mmc.asm):05123         ;     remove leading spaces
                      (dragondos_mmc.asm):05124         ;     Terminate on:
                      (dragondos_mmc.asm):05125         ;       Any character less than or equal to space.
                      (dragondos_mmc.asm):05126         ;
                      (dragondos_mmc.asm):05127         
     879A             (dragondos_mmc.asm):05128         L879A   EQU     $879A                   ; return point (Dragon)
                      (dragondos_mmc.asm):05129                 
D80B                  (dragondos_mmc.asm):05130         DosHookDiskItem   
D80B 0D6F             (dragondos_mmc.asm):05131                 TST     <TextDevN               ; test device number
D80D 2F95             (dragondos_mmc.asm):05132                 BLE     LD8F9                   ; 0 or -ve, not ours
                      (dragondos_mmc.asm):05133                 
D80F 8E879A           (dragondos_mmc.asm):05134                 LDX     #L879A                  ; return point in basic ROM
D812 AFE4             (dragondos_mmc.asm):05135                 STX     ,S                      ; stack it
                      (dragondos_mmc.asm):05136                 
D814 96F4             (dragondos_mmc.asm):05137         LD969   LDA     <DosRecLenFlag          ; reading?
D816 2704             (dragondos_mmc.asm):05138                 BEQ     LD971                   ; yep
                      (dragondos_mmc.asm):05139                 
D818 96F3             (dragondos_mmc.asm):05140                 LDA     <DosNoBytesMove         ; check bytes in buffer
D81A 274D             (dragondos_mmc.asm):05141                 BEQ     LD9BE                   ; read no more
                      (dragondos_mmc.asm):05142                 
D81C 8E02DD           (dragondos_mmc.asm):05143         LD971   LDX     #BasLinInpBuff+1        ; point at basic line input buffer
D81F D6F2             (dragondos_mmc.asm):05144                 LDB     <DosBytesInDTA          ; current input pointer
D821 F70603           (dragondos_mmc.asm):05145                 STB     TempC                   ; save it in count
D824 3A               (dragondos_mmc.asm):05146                 ABX                             ; add to buffer base
                      (dragondos_mmc.asm):05147                 
D825 F60604           (dragondos_mmc.asm):05148                 LDB     TempL                   ; save number of bytes in buffer
D828 F70611           (dragondos_mmc.asm):05149                 STB     DosRunLoadFlag
D82B 5F               (dragondos_mmc.asm):05150                 CLRB                            ; clear byte before current input
D82C E71F             (dragondos_mmc.asm):05151                 STB     -1,X
                      (dragondos_mmc.asm):05152                 
D82E D700             (dragondos_mmc.asm):05153                 STB     <BasBreakFlag           ; clear flag
D830 0AF3             (dragondos_mmc.asm):05154         LD985   DEC     <DosNoBytesMove         
D832 7A0604           (dragondos_mmc.asm):05155                 DEC     TempL
D835 0CF2             (dragondos_mmc.asm):05156                 INC     <DosBytesInDTA
D837 A680             (dragondos_mmc.asm):05157                 LDA     ,X+                     ; get a byte from buffer
D839 272E             (dragondos_mmc.asm):05158                 BEQ     LD9BE                   ; done if EOF
                      (dragondos_mmc.asm):05159                 
D83B 810D             (dragondos_mmc.asm):05160                 CMPA    #$0D                    ; is it CR?
D83D 272A             (dragondos_mmc.asm):05161                 BEQ     LD9BE                   ; yep deal with it
                      (dragondos_mmc.asm):05162                 
D83F 7D0612           (dragondos_mmc.asm):05163                 TST     DosFlFreadFlag          ; are we reading a number?
D842 2608             (dragondos_mmc.asm):05164                 BNE     LD9A1                   ; yes, don't check for string terminators
                      (dragondos_mmc.asm):05165                 
D844 812C             (dragondos_mmc.asm):05166                 CMPA    #','                    ; check for comma
D846 2721             (dragondos_mmc.asm):05167                 BEQ     LD9BE                   ; yep deal with it
                      (dragondos_mmc.asm):05168                 
D848 813A             (dragondos_mmc.asm):05169                 CMPA    #':'                    ; check for colon
D84A 271D             (dragondos_mmc.asm):05170                 BEQ     LD9BE                   ; yep deal with it
                      (dragondos_mmc.asm):05171                 
D84C 96F4             (dragondos_mmc.asm):05172         LD9A1   LDA     <DosRecLenFlag          ; get bytes to read     
D84E 2704             (dragondos_mmc.asm):05173                 BEQ     LD9A9                   ; zero, read no more
                      (dragondos_mmc.asm):05174                 
D850 96F3             (dragondos_mmc.asm):05175                 LDA     <DosNoBytesMove         ; 
D852 2715             (dragondos_mmc.asm):05176                 BEQ     LD9BE
                      (dragondos_mmc.asm):05177                 
D854 5C               (dragondos_mmc.asm):05178         LD9A9   INCB                            ; number of bytes in string
D855 C1FF             (dragondos_mmc.asm):05179                 CMPB    #$FF                    ; max string length
D857 270E             (dragondos_mmc.asm):05180                 BEQ     LD9BC                   ; yep! string full
                      (dragondos_mmc.asm):05181                 
D859 B60604           (dragondos_mmc.asm):05182                 LDA     TempL                                           
D85C 26D2             (dragondos_mmc.asm):05183                 BNE     LD985
                      (dragondos_mmc.asm):05184                 
                      (dragondos_mmc.asm):05185         ; read a new buffer of data     
D85E D600             (dragondos_mmc.asm):05186                 LDB     <BasBreakFlag           ; 
D860 2605             (dragondos_mmc.asm):05187                 BNE     LD9BC
                      (dragondos_mmc.asm):05188                 
D862 8D0F             (dragondos_mmc.asm):05189                 BSR     LD9C8
D864 5F               (dragondos_mmc.asm):05190                 CLRB
D865 20C9             (dragondos_mmc.asm):05191                 BRA     LD985
                      (dragondos_mmc.asm):05192         
                      (dragondos_mmc.asm):05193         ; return to input (basic)
D867 3001             (dragondos_mmc.asm):05194         LD9BC   LEAX    1,X                     ; increment past last byte              
D869 F60603           (dragondos_mmc.asm):05195         LD9BE   LDB     TempC                   ; get count
D86C 6F1F             (dragondos_mmc.asm):05196                 CLR     -1,X                    ; clear line termination byte
D86E 8E02DC           (dragondos_mmc.asm):05197                 LDX     #BasLinInpBuff          ; point at buffer
D871 3A               (dragondos_mmc.asm):05198                 ABX                             ; add offset
D872 39               (dragondos_mmc.asm):05199                 RTS
                      (dragondos_mmc.asm):05200         
D873 BDCD57           (dragondos_mmc.asm):05201         LD9C8   JSR     >DosFCBNoToAddr         ; get address of FCB for file
D876 4F               (dragondos_mmc.asm):05202                 CLRA                            ; clear MSB
D877 F60611           (dragondos_mmc.asm):05203                 LDB     DosRunLoadFlag          ; load B with ammount to read
D87A 12               (dragondos_mmc.asm):05204                 NOP
D87B 3406             (dragondos_mmc.asm):05205                 PSHS    D                       ; save D
D87D EC0D             (dragondos_mmc.asm):05206                 LDD     FCBFilePointer+1,X      ; get filepointer
D87F A3E1             (dragondos_mmc.asm):05207                 SUBD    ,S++                    ; move it back?
D881 ED0D             (dragondos_mmc.asm):05208                 STD     FCBFilePointer+1,X
D883 2402             (dragondos_mmc.asm):05209                 BCC     LD9DC
D885 6A0C             (dragondos_mmc.asm):05210                 DEC     FCBFilePointer,X
                      (dragondos_mmc.asm):05211                 
D887 3460             (dragondos_mmc.asm):05212         LD9DC   PSHS    Y,U                     ; save regs
D889 CE00FF           (dragondos_mmc.asm):05213                 LDU     #$00FF                  ; ammount to try reading
D88C 8D1E             (dragondos_mmc.asm):05214                 BSR     LDA01                   ; check enough bytes left
                      (dragondos_mmc.asm):05215                 
D88E CE02DD           (dragondos_mmc.asm):05216                 LDU     #DBasLinInpBuff+1       ; point at basicline buffer
D891 6FCB             (dragondos_mmc.asm):05217                 CLR     D,U                     ; clear byte..... (after end?)
D893 96F1             (dragondos_mmc.asm):05218                 LDA     <DosCurrCtrlBlk         ; get current file no
D895 E60E             (dragondos_mmc.asm):05219                 LDB     FCBFilePointer+2,X      ; get filepointer
D897 AE0C             (dragondos_mmc.asm):05220                 LDX     FCBFilePointer,X
D899 1E13             (dragondos_mmc.asm):05221                 EXG     X,U                     ; swap X and U to get buffer & offset in correct regs
D89B BDC83C           (dragondos_mmc.asm):05222                 JSR     >DOSFRead               ; go read the file
D89E 2609             (dragondos_mmc.asm):05223                 BNE     LD9FE                   ; error, exit
                      (dragondos_mmc.asm):05224                 
D8A0 8E02DD           (dragondos_mmc.asm):05225                 LDX     #DBasLinInpBuff+1       ; point at basicline buffer
D8A3 6F1F             (dragondos_mmc.asm):05226                 CLR     -1,X                    ; clear byte before read data
D8A5 35E0             (dragondos_mmc.asm):05227                 PULS    Y,U,PC                  ; restore and return
                      (dragondos_mmc.asm):05228         
D8A7 C69A             (dragondos_mmc.asm):05229         LD9FC   LDB     #ErrPE                  ; read past end of file
D8A9 7EC56F           (dragondos_mmc.asm):05230         LD9FE   JMP     >DosHookSysError        ; call error handler    
                      (dragondos_mmc.asm):05231         
                      (dragondos_mmc.asm):05232         ; take an ammount of bytes we want to read in U, and work out if there
                      (dragondos_mmc.asm):05233         ; are still U bytes in the file to read. This is doen by adding U to
                      (dragondos_mmc.asm):05234         ; the current file pointer, and then comparing it to the file length.
                      (dragondos_mmc.asm):05235         
D8AC 3440             (dragondos_mmc.asm):05236         LDA01   PSHS    U                       ; save ammount to load?
D8AE EC0D             (dragondos_mmc.asm):05237                 LDD     FCBFilePointer+1,X      ; get LSW of filepointer
D8B0 E3E4             (dragondos_mmc.asm):05238                 ADDD    ,S                      ; add ammount to filepointer
D8B2 3406             (dragondos_mmc.asm):05239                 PSHS    D                       ; save it
D8B4 A60C             (dragondos_mmc.asm):05240                 LDA     FCBFilePointer,X        ; get MSB of filepointer        
D8B6 8900             (dragondos_mmc.asm):05241                 ADCA    #$00                    ; propagate carry
D8B8 A08810           (dragondos_mmc.asm):05242                 SUBA    FCBFileLen,X            ; subtract file length msb
D8BB 3506             (dragondos_mmc.asm):05243                 PULS    D                       ; restore LSW of difference, flags untouched
D8BD 2512             (dragondos_mmc.asm):05244                 BCS     LDA26                   ; was much at least 64K lower so safe to read
D8BF 22E6             (dragondos_mmc.asm):05245                 BHI     LD9FC                   ; error will read past EOF
                      (dragondos_mmc.asm):05246                 
D8C1 A38811           (dragondos_mmc.asm):05247                 SUBD    FCBFileLen+1,X          ; sheck the LSW of the filepointer
D8C4 230B             (dragondos_mmc.asm):05248                 BLS     LDA26                   ; was lower so safe to read
                      (dragondos_mmc.asm):05249                 
                      (dragondos_mmc.asm):05250         ; if we still have bytes that can be read but have not reached EOF, then work
                      (dragondos_mmc.asm):05251         ; out how many bytes left       
                      (dragondos_mmc.asm):05252                 
D8C6 EC8811           (dragondos_mmc.asm):05253                 LDD     FCBFileLen+1,X          ; get the file length
D8C9 A30D             (dragondos_mmc.asm):05254                 SUBD    FCBFilePointer+1,X      ; subtract filepointer
D8CB 27DA             (dragondos_mmc.asm):05255                 BEQ     LD9FC                   ; special case exactly at EOF
D8CD EDE4             (dragondos_mmc.asm):05256                 STD     ,S                      ; save ammount we can read
D8CF 0300             (dragondos_mmc.asm):05257                 COM     <BasBreakFlag           ; ????
                      (dragondos_mmc.asm):05258                 
D8D1 ECE4             (dragondos_mmc.asm):05259         LDA26   LDD     ,S                      ; get ammount we can read
D8D3 F70604           (dragondos_mmc.asm):05260                 STB     TempL                   ; save LSB (ammount read?)
D8D6 F70611           (dragondos_mmc.asm):05261                 STB     DosRunLoadFlag          ; ???
D8D9 7F0603           (dragondos_mmc.asm):05262                 CLR     TempL-1                 ; MSB that we read
D8DC 0FF2             (dragondos_mmc.asm):05263                 CLR     <DosBytesInDTA          
D8DE 35A0             (dragondos_mmc.asm):05264                 PULS    Y,PC                    ; restore and return
                      (dragondos_mmc.asm):05265         
                      (dragondos_mmc.asm):05266         ;
                      (dragondos_mmc.asm):05267         ; Dir command dispatch routine
                      (dragondos_mmc.asm):05268         ;
                      (dragondos_mmc.asm):05269         ; Syntax :
                      (dragondos_mmc.asm):05270         ;       DIR drivenum    
                      (dragondos_mmc.asm):05271         ;
                      (dragondos_mmc.asm):05272         
D8E0                  (dragondos_mmc.asm):05273         CmdDir  
D8E0 2705             (dragondos_mmc.asm):05274                 BEQ     LDA3C                   ; No drive specified, use default
D8E2 BDC560           (dragondos_mmc.asm):05275                 JSR     >GetDriveNoInB          ; Else get from command 
D8E5 2003             (dragondos_mmc.asm):05276                 BRA     LDA3F
                      (dragondos_mmc.asm):05277         
D8E7 F6060A           (dragondos_mmc.asm):05278         LDA3C   LDB     DosDefDriveNo           ; Get default drive
                      (dragondos_mmc.asm):05279         
D8EA D7EB             (dragondos_mmc.asm):05280         LDA3F   STB     <DosDriveNo             ; Flag as last drive used
D8EC 6FE2             (dragondos_mmc.asm):05281                 CLR     ,-S                     ; make temp on stack (file number on disk counter)
                      (dragondos_mmc.asm):05282                 
D8EE 8E0696           (dragondos_mmc.asm):05283                 ldx     #DosD0Online-1          ; point at online flags
D8F1 6F85             (dragondos_mmc.asm):05284                 clr     b,x                     ; mark drive offline, forces directory re-read.
                      (dragondos_mmc.asm):05285                 
D8F3 BDBA77           (dragondos_mmc.asm):05286                 JSR     >TextCls                ; clear screen  
D8F6 5F               (dragondos_mmc.asm):05287                 CLRB
                      (dragondos_mmc.asm):05288                 
D8F7 BD851B           (dragondos_mmc.asm):05289         LDA44   JSR     >BasPollKeyboard        ; poll keyboard
D8FA BDD07F           (dragondos_mmc.asm):05290                 JSR     >DOSGetDirEntry         ; go get next entry
D8FD 1026EC6E         (dragondos_mmc.asm):05291                 LBNE    DosHookSysError         ; error : exit
                      (dragondos_mmc.asm):05292                 
D901 A684             (dragondos_mmc.asm):05293                 LDA     ,X                      ; Get Attribute byte
D903 8508             (dragondos_mmc.asm):05294                 BITA    #AttrEndOfDir           ; Check for end of directory $08
D905 2658             (dragondos_mmc.asm):05295                 BNE     CmdDirDoneAll           ; Yes : stop processing
                      (dragondos_mmc.asm):05296                 
D907 8581             (dragondos_mmc.asm):05297                 BITA    #AttrDeleted+AttrIsCont ; Is entry a deleted file, or continuation entry ? $81                          ; and another thing
D909 264C             (dragondos_mmc.asm):05298                 BNE     CmdDirDoNextEntry       ; yes : do next
                      (dragondos_mmc.asm):05299                 
D90B 3001             (dragondos_mmc.asm):05300                 LEAX    1,X                     ; Point at filename
D90D C608             (dragondos_mmc.asm):05301                 LDB     #$08                    ; Up to 8 chars
D90F 8D5E             (dragondos_mmc.asm):05302                 BSR     PrintBCharsFromX        ; Print it
D911 862E             (dragondos_mmc.asm):05303                 LDA     #$2E                    ; '.'
D913 BDB54A           (dragondos_mmc.asm):05304                 JSR     >TextOutChar            ; output period
D916 C603             (dragondos_mmc.asm):05305                 LDB     #$03                    ; print extension
D918 8D55             (dragondos_mmc.asm):05306                 BSR     PrintBCharsFromX
                      (dragondos_mmc.asm):05307                 
D91A A614             (dragondos_mmc.asm):05308                 LDA     -12,X                   ; Point at attributes
D91C 8502             (dragondos_mmc.asm):05309                 BITA    #AttrWriteProt          ; Is this a protected file ?
D91E 2703             (dragondos_mmc.asm):05310                 BEQ     LDA70                   ; no skip on
D920 8670             (dragondos_mmc.asm):05311                 LDA     #'p                     ; Flag protected $70
D922 8C               (dragondos_mmc.asm):05312                 FCB     Skip2
D923 8620             (dragondos_mmc.asm):05313         LDA70   LDA     #$20                    ; space
D925 BDB54A           (dragondos_mmc.asm):05314                 JSR     >TextOutChar            ; output attribute byte
D928 BD90F5           (dragondos_mmc.asm):05315                 JSR     >TextOutSpace           ; And a space
D92B CEFFFF           (dragondos_mmc.asm):05316                 LDU     #$FFFF
D92E 8E06BD           (dragondos_mmc.asm):05317                 LDX     #DosFCB0Addr            ; Point at first FCB
D931 E6E4             (dragondos_mmc.asm):05318                 LDB     ,S                      ; Get file number
D933 E7881D           (dragondos_mmc.asm):05319                 STB     FCBDiskFileNo,X         ; Save in FCB
                      (dragondos_mmc.asm):05320         
D936 BDC9A4           (dragondos_mmc.asm):05321                 JSR     >FindFSNinU             ; find last File sector
D939 1026EC32         (dragondos_mmc.asm):05322                 LBNE    DosHookSysError         ; error : exit
                      (dragondos_mmc.asm):05323         
D93D BDCD44           (dragondos_mmc.asm):05324                 JSR     >LCE99                  ; add last bytes to length
D940 8D3A             (dragondos_mmc.asm):05325                 BSR     LDAB7                   ; Print filesize
                      (dragondos_mmc.asm):05326         
D942 BD90A1           (dragondos_mmc.asm):05327                 JSR     TextOutCRLF             ; Output EOL
                      (dragondos_mmc.asm):05328                 
D945 DC88             (dragondos_mmc.asm):05329                 LDD     <TextVDUCursAddr        ; Check for near end of screen
D947 108305A0         (dragondos_mmc.asm):05330                 CMPD    #$05A0                          
D94B 230A             (dragondos_mmc.asm):05331                 BLS     CmdDirDoNextEntry       ; not near end, skip on
                      (dragondos_mmc.asm):05332                 
D94D 3476             (dragondos_mmc.asm):05333                 PSHS    D,X,Y,U                 ; save regs
D94F BDEFD5           (dragondos_mmc.asm):05334                 JSR     >CON_PromptMore         ; Prompt for more
D952 BDBA77           (dragondos_mmc.asm):05335                 JSR     >TextCls                ; clear screen
D955 3576             (dragondos_mmc.asm):05336                 PULS    D,X,Y,U                 ; Restore regs
                      (dragondos_mmc.asm):05337                 
D957                  (dragondos_mmc.asm):05338         CmdDirDoNextEntry 
D957 6CE4             (dragondos_mmc.asm):05339                 INC     ,S                      ; do next
D959 E6E4             (dragondos_mmc.asm):05340                 LDB     ,S                      ; Get disk file number counter
D95B C1B4             (dragondos_mmc.asm):05341                 CMPB    #$B4                    ; More than max files on disk ?
D95D 2598             (dragondos_mmc.asm):05342                 BCS     LDA44                   ; Less, loop again.     
                      (dragondos_mmc.asm):05343         
                      (dragondos_mmc.asm):05344         ;
                      (dragondos_mmc.asm):05345         ; We come here either when we have processed $A0 entries, which is the maximum,
                      (dragondos_mmc.asm):05346         ; or we have reached an entry with the AttrEndOfDir bit set which signals the end
                      (dragondos_mmc.asm):05347         ; of the directory.
                      (dragondos_mmc.asm):05348         ;
                      (dragondos_mmc.asm):05349         
D95F                  (dragondos_mmc.asm):05350         CmdDirDoneAll   
D95F 3502             (dragondos_mmc.asm):05351                 PULS    A
D961 BDCFF8           (dragondos_mmc.asm):05352                 JSR     >DOSGetFree             ; Get free bytes on drive
D964 4F               (dragondos_mmc.asm):05353                 CLRA
D965 1F13             (dragondos_mmc.asm):05354                 TFR     X,U
D967 8D13             (dragondos_mmc.asm):05355                 BSR     LDAB7                   ; Display free bytes
D969 8ED992           (dragondos_mmc.asm):05356                 LDX     #BytesFreeMess-1        ; Point to message
D96C 7E90E5           (dragondos_mmc.asm):05357                 JMP     >TextOutString          ; print it, and return
                      (dragondos_mmc.asm):05358         
                      (dragondos_mmc.asm):05359         ; Print B chars pointed to by X, if char is $00, then output a space.
                      (dragondos_mmc.asm):05360         ; Used to print filenames.
                      (dragondos_mmc.asm):05361         
D96F                  (dragondos_mmc.asm):05362         PrintBCharsFromX   
D96F A680             (dragondos_mmc.asm):05363                 LDA     ,X+                     ; Fetch a char
D971 2602             (dragondos_mmc.asm):05364                 BNE     PrintBCharsFromX2       ; Is it zero ? no : skip
D973 8620             (dragondos_mmc.asm):05365                 LDA     #$20                    ; Replace it with a space
                      (dragondos_mmc.asm):05366         
D975                  (dragondos_mmc.asm):05367         PrintBCharsFromX2   
D975 BDB54A           (dragondos_mmc.asm):05368                 JSR     >TextOutChar            ; Output it
D978 5A               (dragondos_mmc.asm):05369                 DECB                            ; Decrement count
D979 26F4             (dragondos_mmc.asm):05370                 BNE     PrintBCharsFromX        ; any left yes : loop again
D97B 39               (dragondos_mmc.asm):05371                 RTS
                      (dragondos_mmc.asm):05372         
D97C                  (dragondos_mmc.asm):05373         LDAB7   
D97C BDDC59           (dragondos_mmc.asm):05374                 JSR     LDD95                   ; put number in FPA0, normalize it
D97F 7E9582           (dragondos_mmc.asm):05375                 JMP     TextOutNumFPA0          ; output it
                      (dragondos_mmc.asm):05376         
D982                  (dragondos_mmc.asm):05377         DosHookReadInputFix
D982 3456             (dragondos_mmc.asm):05378                 PSHS    U,X,D                   ; save regs
D984 8E837D           (dragondos_mmc.asm):05379                 LDX     #$837D                  ; check source PC on stack
D987 AC68             (dragondos_mmc.asm):05380                 CMPX    8,S
D989 2605             (dragondos_mmc.asm):05381                 BNE     LDACB                   ; nope restore & return
D98B BDD5A6           (dragondos_mmc.asm):05382                 JSR     DosCloseAllFiles        ; close all files
D98E 205E             (dragondos_mmc.asm):05383                 BRA     CheckAndDoAutoFix       ; jump to Auto check
D990 35D6             (dragondos_mmc.asm):05384         LDACB   PULS    U,X,D,PC                ; restore & return
D992 12               (dragondos_mmc.asm):05385                 NOP
                      (dragondos_mmc.asm):05386         
D993                  (dragondos_mmc.asm):05387         BytesFreeMess
D993 2046524545204259 (dragondos_mmc.asm):05388                 FCC     / FREE BYTES/
     544553
D99E 0D0D00           (dragondos_mmc.asm):05389                 FCB     $0D,$0D,$00     
                      (dragondos_mmc.asm):05390         ;
                      (dragondos_mmc.asm):05391         ; Auto command dispatch routine
                      (dragondos_mmc.asm):05392         ;
                      (dragondos_mmc.asm):05393         ; Syntax :
                      (dragondos_mmc.asm):05394         ;
                      (dragondos_mmc.asm):05395         ;       AUTO startline,increment
                      (dragondos_mmc.asm):05396         ;
                      (dragondos_mmc.asm):05397         
D9A1                  (dragondos_mmc.asm):05398         CmdAuto 
D9A1 DC68             (dragondos_mmc.asm):05399                 LDD     <BasCurrentLine         ; Get current line number
D9A3 1083FFFF         (dragondos_mmc.asm):05400                 CMPD    #$FFFF                  ; Direct mode ?
D9A7 2703             (dragondos_mmc.asm):05401                 BEQ     LDAE7                   ; yep start numbering
D9A9 7E8B8D           (dragondos_mmc.asm):05402                 JMP     >DBasFCError            ; nope : error
                      (dragondos_mmc.asm):05403         
D9AC CC0064           (dragondos_mmc.asm):05404         LDAE7   LDD     #AutoStartLine          ; set default start line
D9AF 3406             (dragondos_mmc.asm):05405                 PSHS    D
D9B1 C60A             (dragondos_mmc.asm):05406                 LDB     #AutoIncrement          ; set default increment
D9B3 3406             (dragondos_mmc.asm):05407                 PSHS    D
D9B5 9DA5             (dragondos_mmc.asm):05408                 JSR     <BasChrGetCurr          ; get current character
D9B7 271E             (dragondos_mmc.asm):05409                 BEQ     CmdAutoDoAuto           ; nothing, used defaults                
                      (dragondos_mmc.asm):05410                 
D9B9 BD8E83           (dragondos_mmc.asm):05411                 JSR     >VarGet16Bit            ; get startline
D9BC DC52             (dragondos_mmc.asm):05412                 LDD     <FPA0+2
D9BE ED62             (dragondos_mmc.asm):05413                 STD     2,S                     ; update value on stack
D9C0 9DA5             (dragondos_mmc.asm):05414                 JSR     <BasChrGetCurr          ; any more parameters ?
D9C2 2713             (dragondos_mmc.asm):05415                 BEQ     CmdAutoDoAuto           ; nope use default increment
                      (dragondos_mmc.asm):05416                 
D9C4 BD89AA           (dragondos_mmc.asm):05417                 JSR     >VarCKComma             ; get comma, error if not
D9C7 BD8E83           (dragondos_mmc.asm):05418                 JSR     >DVarGet16Bit           ; get increment
D9CA DC52             (dragondos_mmc.asm):05419                 LDD     <FPA0+2
D9CC 2706             (dragondos_mmc.asm):05420                 BEQ     CmdAutoErrorExit                        ; increment is zero : error
D9CE EDE4             (dragondos_mmc.asm):05421                 STD     ,S                      ; update increment value
D9D0 9DA5             (dragondos_mmc.asm):05422                 JSR     <BasChrGetCurr          ; get current char
D9D2 2703             (dragondos_mmc.asm):05423                 BEQ     CmdAutoDoAuto           ; no more : do it !
                      (dragondos_mmc.asm):05424                 
D9D4                  (dragondos_mmc.asm):05425         CmdAutoErrorExit   
D9D4 7E89B4           (dragondos_mmc.asm):05426                 JMP     >BasSNError             ; More chars left, SN? error
                      (dragondos_mmc.asm):05427         
D9D7                  (dragondos_mmc.asm):05428         CmdAutoDoAuto   
D9D7 1A50             (dragondos_mmc.asm):05429                 ORCC    #(FlagIRQ+FlagFIRQ)     ; Disable interrupts    
D9D9 ECE1             (dragondos_mmc.asm):05430                 LDD     ,S++                    ; Get Increment off stack               
D9DB FD060F           (dragondos_mmc.asm):05431                 STD     DosAutoInc
D9DE ECE1             (dragondos_mmc.asm):05432                 LDD     ,S++                    ; Get start line off stack
D9E0 B3060F           (dragondos_mmc.asm):05433                 SUBD    DosAutoInc              ; Subtrack increment
D9E3 FD060D           (dragondos_mmc.asm):05434                 STD     DosAutoCurrent          ; Save in current
D9E6 86FF             (dragondos_mmc.asm):05435                 LDA     #AutoFlag               ; Flag in AUTO mode
D9E8 B70613           (dragondos_mmc.asm):05436                 STA     DosAutoFlag
D9EB 39               (dragondos_mmc.asm):05437                 RTS
                      (dragondos_mmc.asm):05438         
D9EC                  (dragondos_mmc.asm):05439         CheckAndDoAuto   
D9EC 3456             (dragondos_mmc.asm):05440                 PSHS    D,X,U
D9EE                  (dragondos_mmc.asm):05441         CheckAndDoAutoFix
D9EE 7D0613           (dragondos_mmc.asm):05442                 TST     DosAutoFlag             ; is auto enabled ?
D9F1 2602             (dragondos_mmc.asm):05443                 BNE     LDB30                   ; yes : handle it
D9F3 35D6             (dragondos_mmc.asm):05444         LDB2E   PULS    D,X,U,PC
                      (dragondos_mmc.asm):05445         
D9F5 FC060D           (dragondos_mmc.asm):05446         LDB30   LDD     DosAutoCurrent          ; get current line no
D9F8 F3060F           (dragondos_mmc.asm):05447                 ADDD    DosAutoInc              ; add increment
D9FB 1083F9FF         (dragondos_mmc.asm):05448                 CMPD    #BasMaxLineNo           ; greater than max line no ?
D9FF 22F2             (dragondos_mmc.asm):05449                 BHI     LDB2E                   ; yep : exit
                      (dragondos_mmc.asm):05450                 
DA01 EDE4             (dragondos_mmc.asm):05451                 STD     ,S                      ; save new line on stack
DA03 BD957A           (dragondos_mmc.asm):05452                 JSR     >TextOutNum16           ; output line no
DA06 8620             (dragondos_mmc.asm):05453                 LDA     #$20                    ; output a space
DA08 BDB54A           (dragondos_mmc.asm):05454                 JSR     TextOutChar             
                      (dragondos_mmc.asm):05455                 
DA0B CE03DA           (dragondos_mmc.asm):05456                 LDU     #BasBuffer+3            ; point at basic buffer
DA0E ECE4             (dragondos_mmc.asm):05457                 LDD     ,S                      ; get current line no
DA10 FD060D           (dragondos_mmc.asm):05458                 STD     DosAutoCurrent          ; save it
DA13 8E02DD           (dragondos_mmc.asm):05459                 LDX     #BasLinInpBuff+1        ; point to line input buffer
DA16 C600             (dragondos_mmc.asm):05460                 LDB     #$00
DA18 A6C0             (dragondos_mmc.asm):05461         LDB53   LDA     ,U+                     ; get byte from basic buffer
DA1A 2705             (dragondos_mmc.asm):05462                 BEQ     LDB5C                   ; zero ?
                      (dragondos_mmc.asm):05463                 
DA1C A780             (dragondos_mmc.asm):05464                 STA     ,X+                     ; nope put in buffer
DA1E 5C               (dragondos_mmc.asm):05465                 INCB
DA1F 20F7             (dragondos_mmc.asm):05466                 BRA     LDB53
                      (dragondos_mmc.asm):05467         
DA21 8620             (dragondos_mmc.asm):05468         LDB5C   LDA     #$20                    ; store space
DA23 A780             (dragondos_mmc.asm):05469                 STA     ,X+
DA25 5C               (dragondos_mmc.asm):05470                 INCB                    
DA26 BDB505           (dragondos_mmc.asm):05471         LDB61   JSR     TextWaitKeyCurs2        ; Wait with cursor
DA29 810D             (dragondos_mmc.asm):05472                 CMPA    #$0D                    ; return ?
DA2B 2704             (dragondos_mmc.asm):05473                 BEQ     LDB6C                   
                      (dragondos_mmc.asm):05474                 
DA2D 8103             (dragondos_mmc.asm):05475                 CMPA    #$03                    ; break ?
DA2F 2616             (dragondos_mmc.asm):05476                 BNE     LDB82
                      (dragondos_mmc.asm):05477                 
DA31 7F0613           (dragondos_mmc.asm):05478         LDB6C   CLR     DosAutoFlag             ; clear auto flag
DA34 860D             (dragondos_mmc.asm):05479                 LDA     #$0D                    ; output a return
DA36 BDB54A           (dragondos_mmc.asm):05480                 JSR     TextOutChar
                      (dragondos_mmc.asm):05481                 
DA39 3268             (dragondos_mmc.asm):05482                 LEAS    8,S                     ; drop stack frame
DA3B 0F85             (dragondos_mmc.asm):05483                 CLR     <CasLastSine
DA3D 8E02DD           (dragondos_mmc.asm):05484                 LDX     #DBasLinInpBuff+1       ; point at input buffer
DA40 860D             (dragondos_mmc.asm):05485                 LDA     #$0D
DA42 C601             (dragondos_mmc.asm):05486                 LDB     #$01
DA44 7EB5D3           (dragondos_mmc.asm):05487                 JMP     >BasInBuffFromX         ; input it
                      (dragondos_mmc.asm):05488         
DA47 8120             (dragondos_mmc.asm):05489         LDB82   CMPA    #$20                    ; space ?
DA49 25DB             (dragondos_mmc.asm):05490                 BCS     LDB61                   ; yep keep going
                      (dragondos_mmc.asm):05491         
DA4B 817B             (dragondos_mmc.asm):05492                 CMPA    #$7B                    ; max ascii char ?
DA4D 24D7             (dragondos_mmc.asm):05493                 BCC     LDB61                   ; yep keep going
                      (dragondos_mmc.asm):05494         
DA4F 3268             (dragondos_mmc.asm):05495                 LEAS    8,S                     ; drop stack frame
DA51 0F85             (dragondos_mmc.asm):05496                 CLR     <CasLastSine
DA53 7EB5D3           (dragondos_mmc.asm):05497                 JMP     >BasInBuffFromX         
                      (dragondos_mmc.asm):05498         
DA56 4F               (dragondos_mmc.asm):05499         DoBeep  CLRA                            ; A=0   
DA57 8E0008           (dragondos_mmc.asm):05500                 LDX     #$0008                  ; Repeat 8 times
DA5A BDBE12           (dragondos_mmc.asm):05501         LDB95   JSR     >CasByteOut             ; Output A to cassette
DA5D 301F             (dragondos_mmc.asm):05502                 LEAX    -1,X                    ; Decrement count
DA5F 26F9             (dragondos_mmc.asm):05503                 BNE     LDB95                   ; Loop again if all not done
DA61 39               (dragondos_mmc.asm):05504         LDB9C   RTS
                      (dragondos_mmc.asm):05505         
                      (dragondos_mmc.asm):05506         ;
                      (dragondos_mmc.asm):05507         ; Beep command dispatch routine
                      (dragondos_mmc.asm):05508         ;
                      (dragondos_mmc.asm):05509         ; Syntax :
                      (dragondos_mmc.asm):05510         ;       BEEP nobeeps
                      (dragondos_mmc.asm):05511         ;
                      (dragondos_mmc.asm):05512         
DA62                  (dragondos_mmc.asm):05513         CmdBeep   
DA62 2704             (dragondos_mmc.asm):05514                 BEQ     CmdBeepDef              ; if no params, default to 1 beep
DA64 BDC510           (dragondos_mmc.asm):05515                 JSR     >Get8BitorError         ; get beep count 
                      (dragondos_mmc.asm):05516         
DA67 8C               (dragondos_mmc.asm):05517                 FCB     Skip2
DA68                  (dragondos_mmc.asm):05518         CmdBeepDef
DA68 C601             (dragondos_mmc.asm):05519                 LDB     #$01                    ; Default beep count
                      (dragondos_mmc.asm):05520         
DA6A 3404             (dragondos_mmc.asm):05521                 PSHS    B                       ; save count on stack
DA6C 5F               (dragondos_mmc.asm):05522                 CLRB
DA6D BDBAED           (dragondos_mmc.asm):05523                 JSR     >SndDTOAOn              ; switch sound to D to A
DA70 BDDA56           (dragondos_mmc.asm):05524         LDBAB   JSR     DoBeep
DA73 BD851B           (dragondos_mmc.asm):05525                 JSR     >BasPollKeyboard        ; check for key
DA76 6AE4             (dragondos_mmc.asm):05526                 DEC     ,S                      ; decrement beep count
DA78 270A             (dragondos_mmc.asm):05527                 BEQ     LDBBF                   ; done all : restore and exit
DA7A 108E6000         (dragondos_mmc.asm):05528                 LDY     #$6000                  ; wait a short while
DA7E 313F             (dragondos_mmc.asm):05529         LDBB9   LEAY    -1,Y
DA80 27EE             (dragondos_mmc.asm):05530                 BEQ     LDBAB                   ; loop back and do next beep
DA82 20FA             (dragondos_mmc.asm):05531                 BRA     LDBB9
                      (dragondos_mmc.asm):05532         
DA84 3584             (dragondos_mmc.asm):05533         LDBBF   PULS    B,PC
                      (dragondos_mmc.asm):05534         
                      (dragondos_mmc.asm):05535         ;
                      (dragondos_mmc.asm):05536         ; Wait command dispatch routine.
                      (dragondos_mmc.asm):05537         ;
                      (dragondos_mmc.asm):05538         ; Syntax :
                      (dragondos_mmc.asm):05539         ;       WAIT miliseconds
                      (dragondos_mmc.asm):05540         ;
                      (dragondos_mmc.asm):05541         
DA86                  (dragondos_mmc.asm):05542         CmdWait   
DA86 27D9             (dragondos_mmc.asm):05543                 BEQ     LDB9C                   ; no params : exit
DA88 BD8E83           (dragondos_mmc.asm):05544                 JSR     >VarGet16Bit            ; get no of ms to wait
DA8B 9E52             (dragondos_mmc.asm):05545                 LDX     <FPA0+2
DA8D BD851B           (dragondos_mmc.asm):05546         LDBC8   JSR     >BasPollKeyboard        ; scan keyboard
DA90 C6A0             (dragondos_mmc.asm):05547                 LDB     #$A0                    ; loop to delay
DA92 5A               (dragondos_mmc.asm):05548         LDBCD   DECB
DA93 26FD             (dragondos_mmc.asm):05549                 BNE     LDBCD                   ; keep going
                      (dragondos_mmc.asm):05550                 
DA95 301F             (dragondos_mmc.asm):05551                 LEAX    -1,X                    ; decrement ms counter
DA97 26F4             (dragondos_mmc.asm):05552                 BNE     LDBC8                   ; keep going if not zero
DA99 39               (dragondos_mmc.asm):05553                 RTS
                      (dragondos_mmc.asm):05554         
                      (dragondos_mmc.asm):05555         ;
                      (dragondos_mmc.asm):05556         ; Swap command dispatch routine.
                      (dragondos_mmc.asm):05557         ;
                      (dragondos_mmc.asm):05558         ; Syntax :
                      (dragondos_mmc.asm):05559         ;       SWAP var1,var2
                      (dragondos_mmc.asm):05560         ;
                      (dragondos_mmc.asm):05561         
DA9A                  (dragondos_mmc.asm):05562         CmdSwap   
DA9A BD8A94           (dragondos_mmc.asm):05563                 JSR     >VarGetVar              ; Get var from basic
DA9D 9E39             (dragondos_mmc.asm):05564                 LDX     <BasVarPtrLast          ; get variable pointer and type
DA9F 9606             (dragondos_mmc.asm):05565                 LDA     <BasVarType
DAA1 3412             (dragondos_mmc.asm):05566                 PSHS    A,X                     ; save them
DAA3 BD89AA           (dragondos_mmc.asm):05567                 JSR     >VarCKComma             ; check for comma
DAA6 BD8A94           (dragondos_mmc.asm):05568                 JSR     >VarGetVar              ; get second var
DAA9 3522             (dragondos_mmc.asm):05569                 PULS    A,Y                     ; recover pointer and type of first
DAAB 9106             (dragondos_mmc.asm):05570                 CMPA    <BasVarType             ; var types the same ?
DAAD 1026ADD1         (dragondos_mmc.asm):05571                 LBNE    BasTMError              ; nope : error
                      (dragondos_mmc.asm):05572                 
DAB1 DE39             (dragondos_mmc.asm):05573                 LDU     <BasVarPtrLast          ; get pointer to second var
DAB3 8E0005           (dragondos_mmc.asm):05574                 LDX     #$0005                  ; 5 bytes for var discriptor
DAB6 A6C4             (dragondos_mmc.asm):05575         LDBF1   LDA     ,U                      ; swap a pair of bytes
DAB8 E6A4             (dragondos_mmc.asm):05576                 LDB     ,Y
DABA E7C0             (dragondos_mmc.asm):05577                 STB     ,U+                     ; increment pointers
DABC A7A0             (dragondos_mmc.asm):05578                 STA     ,Y+
DABE 301F             (dragondos_mmc.asm):05579                 LEAX    -1,X                    ; decrement count
DAC0 26F4             (dragondos_mmc.asm):05580                 BNE     LDBF1                   ; keep going if more bytes
DAC2 39               (dragondos_mmc.asm):05581                 RTS
                      (dragondos_mmc.asm):05582         
DAC3 C68E             (dragondos_mmc.asm):05583         LDBFE   LDB     #ErrBT          ; flag boot error
DAC5 7EC56F           (dragondos_mmc.asm):05584         LDC00   JMP     >DosHookSysError
                      (dragondos_mmc.asm):05585         
                      (dragondos_mmc.asm):05586         ;               
                      (dragondos_mmc.asm):05587         ; Boot command dispatch routine (DragonDos only).
                      (dragondos_mmc.asm):05588         ;
                      (dragondos_mmc.asm):05589         ; Syntax :
                      (dragondos_mmc.asm):05590         ;       BOOT drivenum   
                      (dragondos_mmc.asm):05591         ;
                      (dragondos_mmc.asm):05592         
DAC8                  (dragondos_mmc.asm):05593         CmdBoot   
DAC8 2705             (dragondos_mmc.asm):05594                 BEQ     LDC0A                   ; No drive supplied, use default
DACA BDC560           (dragondos_mmc.asm):05595                 JSR     >GetDriveNoInB          ; Get drive number 
DACD 2003             (dragondos_mmc.asm):05596                 BRA     LDC0D
                      (dragondos_mmc.asm):05597         
DACF F6060A           (dragondos_mmc.asm):05598         LDC0A   LDB     DosDefDriveNo           ; use default drive no
DAD2 8603             (dragondos_mmc.asm):05599         LDC0D   LDA     #BootFirstSector        ; Read boot sector      
DAD4 97ED             (dragondos_mmc.asm):05600                 STA     <DskSectorNo
DAD6 D7EB             (dragondos_mmc.asm):05601                 STB     <DosDriveNo             ; Set drive number
DAD8 17E68A           (dragondos_mmc.asm):05602                 LBSR    DosDoRestore            ; Restore to track 0
DADB 25E8             (dragondos_mmc.asm):05603                 BCS     LDC00                   ; Error : exit
                      (dragondos_mmc.asm):05604                 
DADD 17E67F           (dragondos_mmc.asm):05605                 LBSR    DosDoReadSec2           ; Read first 2 chars of boot sec
DAE0 25E3             (dragondos_mmc.asm):05606                 BCS     LDC00                   ; error : exit
                      (dragondos_mmc.asm):05607                 
DAE2 CC4F53           (dragondos_mmc.asm):05608                 LDD     #BootSignature          ; Boot signature found ?
DAE5 10934F           (dragondos_mmc.asm):05609                 CMPD    <FP0EXP
DAE8 26D9             (dragondos_mmc.asm):05610                 BNE     LDBFE                   ; no : error
                      (dragondos_mmc.asm):05611                 
DAEA CC2600           (dragondos_mmc.asm):05612                 LDD     #BootLoadAddr           ; start at boot load address
DAED DDEE             (dragondos_mmc.asm):05613                 STD     <DiskBuffPtr            ; Set disk buffer to point there
                      (dragondos_mmc.asm):05614                 
DAEF BDC104           (dragondos_mmc.asm):05615         LDC2A   JSR     >DosDoReadSec           ; Read a sector
DAF2 25D1             (dragondos_mmc.asm):05616                 BCS     LDC00                   ; Error : exit
                      (dragondos_mmc.asm):05617                 
DAF4 0CEE             (dragondos_mmc.asm):05618                 INC     <DiskBuffPtr            ; increment page of buffer pointer      
DAF6 0CED             (dragondos_mmc.asm):05619                 INC     <DskSectorNo            ; increment sector number
DAF8 96ED             (dragondos_mmc.asm):05620                 LDA     <DskSectorNo            ; get sector number
DAFA 8112             (dragondos_mmc.asm):05621                 CMPA    #BootLastSector         ; Read the whole boot area ?
DAFC 23F1             (dragondos_mmc.asm):05622                 BLS     LDC2A                   ; no : read next sector
                      (dragondos_mmc.asm):05623                 
DAFE 7E2602           (dragondos_mmc.asm):05624                 JMP     >BootEntryAddr          ; jump to loaded boot code
                      (dragondos_mmc.asm):05625                         
                      (dragondos_mmc.asm):05626         ;
                      (dragondos_mmc.asm):05627         ;Drive command dispatch routine.
                      (dragondos_mmc.asm):05628         ;
                      (dragondos_mmc.asm):05629         ; Syntax :
                      (dragondos_mmc.asm):05630         ;       DRIVE drivenum  
                      (dragondos_mmc.asm):05631         ;
                      (dragondos_mmc.asm):05632         
DB01                  (dragondos_mmc.asm):05633         CmdDrive
DB01 2707             (dragondos_mmc.asm):05634                 BEQ     LDC46                   ; If no parameters : error
DB03 BDC560           (dragondos_mmc.asm):05635                 JSR     >GetDriveNoInB          ; Get drive number      
DB06 F7060A           (dragondos_mmc.asm):05636                 STB     DosDefDriveNo           ; set it
DB09 39               (dragondos_mmc.asm):05637                 rts
                      (dragondos_mmc.asm):05638         ;        JMP     <BasChrGet             ; back to interpreter loop
                      (dragondos_mmc.asm):05639         
DB0A 7E89B4           (dragondos_mmc.asm):05640         LDC46   JMP     >BasSNError
                      (dragondos_mmc.asm):05641         
                      (dragondos_mmc.asm):05642         ;
                      (dragondos_mmc.asm):05643         ; Error command dispatch routine.
                      (dragondos_mmc.asm):05644         ;
                      (dragondos_mmc.asm):05645         ; Syntax :
                      (dragondos_mmc.asm):05646         ;       ERROR GOTO lineno
                      (dragondos_mmc.asm):05647         ;
                      (dragondos_mmc.asm):05648         
                      (dragondos_mmc.asm):05649                 ifdef   Dragon
     0081             (dragondos_mmc.asm):05650         TokGO   equ     DTokGO
     00BC             (dragondos_mmc.asm):05651         TokTO   equ     DTokTO
                      (dragondos_mmc.asm):05652                 else
DB0D                  (dragondos_mmc.asm):05653         TokGO   equ     CTokGO
DB0D                  (dragondos_mmc.asm):05654         TokTO   equ     CTokTO
                      (dragondos_mmc.asm):05655                 endc
                      (dragondos_mmc.asm):05656         
DB0D                  (dragondos_mmc.asm):05657         CmdError   
DB0D 8181             (dragondos_mmc.asm):05658                 CMPA    #TokGO                  ; Check next token is GO
DB0F 26F9             (dragondos_mmc.asm):05659                 BNE     LDC46                   ; Error if not
                      (dragondos_mmc.asm):05660                 
DB11 9D9F             (dragondos_mmc.asm):05661                 JSR     <BasChrGet              ; get next char from basic
                      (dragondos_mmc.asm):05662                 
DB13 81BC             (dragondos_mmc.asm):05663                 CMPA    #TokTO                  ; check next token is TO
DB15 26F3             (dragondos_mmc.asm):05664                 BNE     LDC46                   ; Error if not TO
                      (dragondos_mmc.asm):05665                 
DB17 9D9F             (dragondos_mmc.asm):05666                 JSR     <BasChrGet              ; skip to token
DB19 BD869A           (dragondos_mmc.asm):05667                 JSR     >BasGetLineNo           ; get line number for error handler
DB1C 9E2B             (dragondos_mmc.asm):05668                 LDX     <BasTempLine            
DB1E 8CF9FF           (dragondos_mmc.asm):05669                 CMPX    #BasMaxLineNo           ; if bigger than max line no : FCer
DB21 1022B068         (dragondos_mmc.asm):05670                 LBHI    BasFCError              
                      (dragondos_mmc.asm):05671                 
DB25 BF0615           (dragondos_mmc.asm):05672                 STX     DosErrDestLine          ; save in error handler line 
DB28 2706             (dragondos_mmc.asm):05673                 BEQ     LDC6C                   ; if Zero : clear error handler flag
DB2A 86FF             (dragondos_mmc.asm):05674                 LDA     #ErrGotoEnabled         ; flag goto enabled
DB2C B70614           (dragondos_mmc.asm):05675                 STA     DosErrGotoFlag
DB2F 39               (dragondos_mmc.asm):05676                 RTS
                      (dragondos_mmc.asm):05677         
DB30 7F0614           (dragondos_mmc.asm):05678         LDC6C   CLR     DosErrGotoFlag          ; Turn off error goto
DB33 39               (dragondos_mmc.asm):05679                 RTS
                      (dragondos_mmc.asm):05680         
                      (dragondos_mmc.asm):05681         ;
                      (dragondos_mmc.asm):05682         ; Gets address of a string  supplied on command line into X
                      (dragondos_mmc.asm):05683         ;
                      (dragondos_mmc.asm):05684         
DB34                  (dragondos_mmc.asm):05685         DosGetStr   
DB34 BD89AA           (dragondos_mmc.asm):05686                 JSR     >VarCKComma             ; Check for a comma
DB37 BD8A94           (dragondos_mmc.asm):05687                 JSR     >VarGetVar              ; get next variable
DB3A 7E8877           (dragondos_mmc.asm):05688                 JMP     >VarGetExpr             ; and evaluate it
                      (dragondos_mmc.asm):05689         
                      (dragondos_mmc.asm):05690         ;
                      (dragondos_mmc.asm):05691         ;Sread command dispatch routine.
                      (dragondos_mmc.asm):05692         ;
                      (dragondos_mmc.asm):05693         ; Syntax :
                      (dragondos_mmc.asm):05694         ;       SREAD driveno,trackno,secno,part1$,part2$
                      (dragondos_mmc.asm):05695         ;
                      (dragondos_mmc.asm):05696         
DB3D                  (dragondos_mmc.asm):05697         CmdSread   
DB3D 17009E           (dragondos_mmc.asm):05698                 LBSR    GetSreadWriteParams     ; Get drive,track,secno
DB40 8DF2             (dragondos_mmc.asm):05699                 BSR     DosGetStr               ; Get address of first 128 bytes to read
DB42 3410             (dragondos_mmc.asm):05700                 PSHS    X                       ; save on stack
DB44 8DEE             (dragondos_mmc.asm):05701                 BSR     DosGetStr               ; Get address of second 128 bytes to read
DB46 3410             (dragondos_mmc.asm):05702                 PSHS    X
                      (dragondos_mmc.asm):05703                 
DB48 C6FF             (dragondos_mmc.asm):05704                 LDB     #DosFlagTrue
DB4A D7F6             (dragondos_mmc.asm):05705                 STB     <DosIOInProgress        ; Flag Dos IO in progress
DB4C BDD11F           (dragondos_mmc.asm):05706                 JSR     >FindFreeDiskBuffer     ; Find a buffer to read sector into
DB4F 2624             (dragondos_mmc.asm):05707                 BNE     LDCB1                   ; Error : exit
                      (dragondos_mmc.asm):05708                 
DB51 6F02             (dragondos_mmc.asm):05709                 CLR     BuffFlag,X              ; Clear buffer flag
DB53 AE05             (dragondos_mmc.asm):05710                 LDX     BuffAddr,X              ; Get buffer address
DB55 9FEE             (dragondos_mmc.asm):05711                 STX     <DiskBuffPtr            ; Save as pointer to do read
DB57 BDC104           (dragondos_mmc.asm):05712                 JSR     >DosDoReadSec           ; Read the sector
                      (dragondos_mmc.asm):05713                 
DB5A F70603           (dragondos_mmc.asm):05714                 STB     DosErrorCode            ; Save error code in temp storage
DB5D DEEE             (dragondos_mmc.asm):05715                 LDU     <DiskBuffPtr            ; Get pointer to read data
DB5F 33C90080         (dragondos_mmc.asm):05716                 LEAU    $0080,U                 ; Point to second half of sector
DB63 3510             (dragondos_mmc.asm):05717                 PULS    X                       ; Get address of second string
DB65 8D11             (dragondos_mmc.asm):05718                 BSR     LDCB4                   ; Copy bytes to string
                      (dragondos_mmc.asm):05719                 
DB67 DEEE             (dragondos_mmc.asm):05720                 LDU     <DiskBuffPtr            ; Point at begining of disk buffer
DB69 3510             (dragondos_mmc.asm):05721                 PULS    X                       ; Get address of first string
DB6B 8D0B             (dragondos_mmc.asm):05722                 BSR     LDCB4                   ; Copy bytes to string
                      (dragondos_mmc.asm):05723                 
DB6D 0FF6             (dragondos_mmc.asm):05724                 CLR     <DosIOInProgress        ; Flag Dos IO not in progress
DB6F F60603           (dragondos_mmc.asm):05725                 LDB     DosErrorCode            ; Retrieve error code from read
DB72 2601             (dragondos_mmc.asm):05726                 BNE     LDCB1                   ; Error : go to error handler
DB74 39               (dragondos_mmc.asm):05727                 RTS                             ; return to caller
                      (dragondos_mmc.asm):05728         
DB75 7EC56F           (dragondos_mmc.asm):05729         LDCB1   JMP     >DosHookSysError        ; Jump to error hook
                      (dragondos_mmc.asm):05730         
DB78 3450             (dragondos_mmc.asm):05731         LDCB4   PSHS    X,U                     ; save regs             
DB7A C680             (dragondos_mmc.asm):05732                 LDB     #$80                    ; Make room for 128 bytes
DB7C BD8C52           (dragondos_mmc.asm):05733                 JSR     >BasResStr              ; resize the string
DB7F 3384             (dragondos_mmc.asm):05734                 LEAU    ,X
DB81 3510             (dragondos_mmc.asm):05735                 PULS    X
DB83 E784             (dragondos_mmc.asm):05736                 STB     ,X
DB85 EF02             (dragondos_mmc.asm):05737                 STU     2,X
DB87 3510             (dragondos_mmc.asm):05738                 PULS    X
DB89 7EB7CC           (dragondos_mmc.asm):05739                 JMP     >UtilCopyBXtoU          ; copy the bytes, return to caller
                      (dragondos_mmc.asm):05740         
                      (dragondos_mmc.asm):05741         ;
                      (dragondos_mmc.asm):05742         ; Swrite command dispatch routine.
                      (dragondos_mmc.asm):05743         ;
                      (dragondos_mmc.asm):05744         ; Syntax :
                      (dragondos_mmc.asm):05745         ;       SWRITE driveno,side,sector,part1$,part2$
                      (dragondos_mmc.asm):05746         ;
                      (dragondos_mmc.asm):05747         
DB8C                  (dragondos_mmc.asm):05748         CmdSwrite   
DB8C 8D50             (dragondos_mmc.asm):05749                 BSR     GetSreadWriteParams     ; get parameters
DB8E 8D48             (dragondos_mmc.asm):05750                 BSR     LDD14                   ; get first half of sector
DB90 BD8877           (dragondos_mmc.asm):05751                 JSR     >VarGetExpr
DB93 9E52             (dragondos_mmc.asm):05752                 LDX     <FPA0+2                 ; get address of string
DB95 3410             (dragondos_mmc.asm):05753                 PSHS    X
DB97 8D3F             (dragondos_mmc.asm):05754                 BSR     LDD14                   ; get second half of sector
DB99 BD8D9A           (dragondos_mmc.asm):05755                 JSR     >BasGetStrLenAddr       ; get length & addr
DB9C 3414             (dragondos_mmc.asm):05756                 PSHS    B,X
                      (dragondos_mmc.asm):05757                 
DB9E C6FF             (dragondos_mmc.asm):05758                 LDB     #IOInProgress           ; flag that IO is in progress
DBA0 D7F6             (dragondos_mmc.asm):05759                 STB     <DosIOInProgress
DBA2 BDD11F           (dragondos_mmc.asm):05760                 JSR     FindFreeDiskBuffer      ; Go find a disk buffer to use
DBA5 26CE             (dragondos_mmc.asm):05761                 BNE     LDCB1                   ; error : exit
                      (dragondos_mmc.asm):05762                 
DBA7 6F02             (dragondos_mmc.asm):05763                 CLR     BuffFlag,X              ; make buffer free
DBA9 AE05             (dragondos_mmc.asm):05764                 LDX     BuffAddr,X              ; get buffer address
DBAB 9FEE             (dragondos_mmc.asm):05765                 STX     <DiskBuffPtr            ; use this for disk io
DBAD 5F               (dragondos_mmc.asm):05766                 CLRB
DBAE 6F80             (dragondos_mmc.asm):05767         LDCEA   CLR     ,X+                     ; Clear buffer
DBB0 5A               (dragondos_mmc.asm):05768                 DECB
DBB1 26FB             (dragondos_mmc.asm):05769                 BNE     LDCEA
                      (dragondos_mmc.asm):05770                 
DBB3 3514             (dragondos_mmc.asm):05771                 PULS    B,X                     ; get saved string pointers for second half of sec
DBB5 DEEE             (dragondos_mmc.asm):05772                 LDU     <DiskBuffPtr            ; point to disk buffer
DBB7 33C90080         (dragondos_mmc.asm):05773                 LEAU    $0080,U                 ; start halfway through
DBBB 5D               (dragondos_mmc.asm):05774                 TSTB                            ; any bytes to transfer ?
DBBC 2703             (dragondos_mmc.asm):05775                 BEQ     LDCFD                   ; nope skip on
DBBE BDB7CC           (dragondos_mmc.asm):05776                 JSR     UtilCopyBXtoU           ; copy bytes
                      (dragondos_mmc.asm):05777         
DBC1 3510             (dragondos_mmc.asm):05778         LDCFD   PULS    X                       ; recover pointer to fist half of sector
DBC3 BD8D9F           (dragondos_mmc.asm):05779                 JSR     >VarDelVar              ; delete var
DBC6 DEEE             (dragondos_mmc.asm):05780                 LDU     <DiskBuffPtr            ; recover disk buffer ptr
DBC8 5D               (dragondos_mmc.asm):05781                 TSTB                            ; any bytes to transfer ?
DBC9 2703             (dragondos_mmc.asm):05782                 BEQ     LDD0A                   ; nope skip
                      (dragondos_mmc.asm):05783                 
DBCB BDB7CC           (dragondos_mmc.asm):05784                 JSR     >UtilCopyBXtoU          ; copy first half of sector
                      (dragondos_mmc.asm):05785                 
DBCE BDC101           (dragondos_mmc.asm):05786         LDD0A   JSR     DosDoWriteSecV          ; go write it
DBD1 1025E99A         (dragondos_mmc.asm):05787                 LBCS    DosHookSysError         ; error : exit
DBD5 0FF6             (dragondos_mmc.asm):05788                 CLR     <DosIOInProgress        ; flag no io in progresss       
DBD7 39               (dragondos_mmc.asm):05789                 RTS
                      (dragondos_mmc.asm):05790         
DBD8 BD89AA           (dragondos_mmc.asm):05791         LDD14   JSR     VarCKComma              ; check for comma
DBDB 7E8887           (dragondos_mmc.asm):05792                 JMP     >VarGetStr              ; get string
                      (dragondos_mmc.asm):05793         
DBDE                  (dragondos_mmc.asm):05794         GetSreadWriteParams   
DBDE 2603             (dragondos_mmc.asm):05795                 BNE     LDD1F                   ; params, read them
DBE0 7E89B4           (dragondos_mmc.asm):05796                 JMP     >BasSNError             ; none : SN Error
                      (dragondos_mmc.asm):05797         
                      (dragondos_mmc.asm):05798         ;
                      (dragondos_mmc.asm):05799         ; Get params for Sread/Swrite
                      (dragondos_mmc.asm):05800         ;
                      (dragondos_mmc.asm):05801         
DBE3 BDC560           (dragondos_mmc.asm):05802         LDD1F   JSR     GetDriveNoInB           ; Drive number
DBE6 D7EB             (dragondos_mmc.asm):05803                 STB     <DosDriveNo
DBE8 BD8E7E           (dragondos_mmc.asm):05804                 JSR     >VarGetComma8           ; Track number
DBEB C14F             (dragondos_mmc.asm):05805                 CMPB    #MaxTrack               ; greater than track 80 ?
DBED 2208             (dragondos_mmc.asm):05806                 BHI     LDD33                   ; Yes : error
                      (dragondos_mmc.asm):05807                 
DBEF D7EC             (dragondos_mmc.asm):05808                 STB     <DskTrackNo             ; Save track number
DBF1 BD8E7E           (dragondos_mmc.asm):05809                 JSR     >VarGetComma8           ; Get sector number
DBF4 D7ED             (dragondos_mmc.asm):05810                 STB     <DskSectorNo            ; save it
DBF6 39               (dragondos_mmc.asm):05811         LDD32   RTS
                      (dragondos_mmc.asm):05812         
DBF7 7E8B8D           (dragondos_mmc.asm):05813         LDD33   JMP     >BasFCError             ; Error!
                      (dragondos_mmc.asm):05814         
                      (dragondos_mmc.asm):05815         
                      (dragondos_mmc.asm):05816         ;
                      (dragondos_mmc.asm):05817         ; Verify command dispatch routine.
                      (dragondos_mmc.asm):05818         ;
                      (dragondos_mmc.asm):05819         ; Syntax :
                      (dragondos_mmc.asm):05820         ;       VERIFY ON
                      (dragondos_mmc.asm):05821         ;       VERIFY OFF
                      (dragondos_mmc.asm):05822         ;
                      (dragondos_mmc.asm):05823         
DBFA                  (dragondos_mmc.asm):05824         CmdVerify   
DBFA 270E             (dragondos_mmc.asm):05825                 BEQ     LDD46                   ; end of command : error
                      (dragondos_mmc.asm):05826                 ifndef  Tandy
DBFC 81C2             (dragondos_mmc.asm):05827                 CMPA    #DTokOFF                ; is next token 'OFF'
                      (dragondos_mmc.asm):05828                 else
                      (dragondos_mmc.asm):05829                 CMPA    #CTokOFF                ; is next token 'OFF'
                      (dragondos_mmc.asm):05830                 endc
DBFE 2603             (dragondos_mmc.asm):05831                 BNE     LDD3F                   ; no : check for 'ON'
DC00 5F               (dragondos_mmc.asm):05832                 CLRB                            ; set verify off
DC01 2009             (dragondos_mmc.asm):05833                 BRA     LDD48
                      (dragondos_mmc.asm):05834         
DC03 8188             (dragondos_mmc.asm):05835         LDD3F   CMPA    #DTokON                 ; is next token 'ON' ?
DC05 2703             (dragondos_mmc.asm):05836                 BEQ     LDD46                   ; yes : skip
DC07 7E89B4           (dragondos_mmc.asm):05837                 JMP     >BasSNError             ; return error
                      (dragondos_mmc.asm):05838         
DC0A C6FF             (dragondos_mmc.asm):05839         LDD46   LDB     #$FF                    ; set verify flag
DC0C F70608           (dragondos_mmc.asm):05840         LDD48   STB     DosVerifyFlag
DC0F 0E9F             (dragondos_mmc.asm):05841                 JMP     <BasChrGet              ; go get char from basic
                      (dragondos_mmc.asm):05842         
DC11                  (dragondos_mmc.asm):05843         DosHookEOF   
DC11 0D06             (dragondos_mmc.asm):05844                 TST     <BasVarType             ; check var type
DC13 27E1             (dragondos_mmc.asm):05845                 BEQ     LDD32                   ; if numeric exit
                      (dragondos_mmc.asm):05846                 
DC15 0F06             (dragondos_mmc.asm):05847                 CLR     <BasVarType             ; set var type numeric !
DC17 3262             (dragondos_mmc.asm):05848                 LEAS    2,S                     ; drop return addresss
DC19 108EDD0A         (dragondos_mmc.asm):05849                 LDY     #DosExtDat
DC1D BDD58D           (dragondos_mmc.asm):05850                 JSR     DosOpenFileExtY         ; validate and open file
DC20 2619             (dragondos_mmc.asm):05851                 BNE     JMPSysErrHook           ; Error : exit
                      (dragondos_mmc.asm):05852                 
DC22 BDCD24           (dragondos_mmc.asm):05853                 JSR     DOSGetFLen              ; get file length
DC25 2614             (dragondos_mmc.asm):05854                 BNE     JMPSysErrHook           ; Error : exit
                      (dragondos_mmc.asm):05855                 
DC27 BDCD57           (dragondos_mmc.asm):05856                 JSR     DosFCBNoToAddr          ; get address of FCB
DC2A 11A30C           (dragondos_mmc.asm):05857                 CMPU    FCBFilePointer,X        ; check to see if file pointer is same as length, so EOF
DC2D 2204             (dragondos_mmc.asm):05858                 BHI     LDD6F                   ; nope
DC2F A10E             (dragondos_mmc.asm):05859                 CMPA    FCBFilePointer+2,X      
DC31 2302             (dragondos_mmc.asm):05860                 BLS     LDD71                   
                      (dragondos_mmc.asm):05861                 
DC33 4F               (dragondos_mmc.asm):05862         LDD6F   CLRA                            ; return false
DC34 8C               (dragondos_mmc.asm):05863                 FCB     Skip2
DC35 8601             (dragondos_mmc.asm):05864         LDD71   LDA     #$01                    ; return true
DC37 DE8A             (dragondos_mmc.asm):05865                 LDU     <DBZero
DC39 201B             (dragondos_mmc.asm):05866                 BRA     ReturnFP
                      (dragondos_mmc.asm):05867         
DC3B                  (dragondos_mmc.asm):05868         JMPSysErrHook   
DC3B 7EC56F           (dragondos_mmc.asm):05869                 JMP     >DosHookSysError        ; Deal with errors
                      (dragondos_mmc.asm):05870         
                      (dragondos_mmc.asm):05871         ;
                      (dragondos_mmc.asm):05872         ; LOC "filename" get file pointer
                      (dragondos_mmc.asm):05873         ; 
DC3E                  (dragondos_mmc.asm):05874         FuncLoc
DC3E BDD573           (dragondos_mmc.asm):05875                 JSR     DosValidateAndOpenDAT   ; Validate and open file
DC41 26F8             (dragondos_mmc.asm):05876                 BNE     JMPSysErrHook                   ; error : exit
                      (dragondos_mmc.asm):05877                 
DC43 BDCD57           (dragondos_mmc.asm):05878                 JSR     DosFCBNoToAddr          ; get address of current FCB
DC46 EE0C             (dragondos_mmc.asm):05879                 LDU     FCBFilePointer,X        ; get filepointer from FCB
DC48 A60E             (dragondos_mmc.asm):05880                 LDA     FCBFilePointer+2,X
DC4A 200A             (dragondos_mmc.asm):05881                 BRA     ReturnFP                ; return as float in fpa0
                      (dragondos_mmc.asm):05882         
                      (dragondos_mmc.asm):05883         ;
                      (dragondos_mmc.asm):05884         ; Function LOF "filename" get length of file.
                      (dragondos_mmc.asm):05885         ; bug: file is left open.
                      (dragondos_mmc.asm):05886         ; 
DC4C                  (dragondos_mmc.asm):05887         FuncLof 
DC4C BDD573           (dragondos_mmc.asm):05888                 JSR     DosValidateAndOpenDAT   ; Validate and open file
DC4F 26EA             (dragondos_mmc.asm):05889                 BNE     JMPSysErrHook           ; error : exit
                      (dragondos_mmc.asm):05890                 
DC51 BDCD24           (dragondos_mmc.asm):05891                 JSR     DOSGetFLen              ; get file length
DC54 26E5             (dragondos_mmc.asm):05892                 BNE     JMPSysErrHook           ; error : exit
                      (dragondos_mmc.asm):05893         
DC56                  (dragondos_mmc.asm):05894         ReturnFP   
DC56 0F06             (dragondos_mmc.asm):05895                 CLR     <BasVarType             ; numeric var type
                      (dragondos_mmc.asm):05896                 
DC58 12               (dragondos_mmc.asm):05897                 NOP
DC59 5F               (dragondos_mmc.asm):05898         LDD95   CLRB
DC5A DF51             (dragondos_mmc.asm):05899                 STU     <FP0EXP+2
                      (dragondos_mmc.asm):05900                 
DC5C DD53             (dragondos_mmc.asm):05901                 STD     <FP0EXP+4
DC5E 0F63             (dragondos_mmc.asm):05902                 CLR     <$63
DC60 86A0             (dragondos_mmc.asm):05903                 LDA     #$A0
DC62 DD4F             (dragondos_mmc.asm):05904                 STD     <FP0EXP
                      (dragondos_mmc.asm):05905                 
DC64 7E9165           (dragondos_mmc.asm):05906                 JMP     >VarNormFPA0            ; normalize FPA0
                      (dragondos_mmc.asm):05907         
                      (dragondos_mmc.asm):05908         
DC67                  (dragondos_mmc.asm):05909         FuncFree   
DC67 9DA5             (dragondos_mmc.asm):05910                 JSR     <BasChrGetCurr          ; get current bas char
DC69 2705             (dragondos_mmc.asm):05911                 BEQ     LDDAC                   ; none, use default drive no
DC6B BDC560           (dragondos_mmc.asm):05912                 JSR     GetDriveNoInB           ; else get drive from command line
DC6E 2003             (dragondos_mmc.asm):05913                 BRA     LDDAF                   ; skip on
                      (dragondos_mmc.asm):05914         
DC70 F6060A           (dragondos_mmc.asm):05915         LDDAC   LDB     DosDefDriveNo           ; get default drive
DC73 D7EB             (dragondos_mmc.asm):05916         LDDAF   STB     <DosDriveNo             ; set it as current
DC75 BDCFF8           (dragondos_mmc.asm):05917                 JSR     DOSGetFree              ; go get free space
DC78 26C1             (dragondos_mmc.asm):05918                 BNE     JMPSysErrHook                   ; error : exit
DC7A 1F13             (dragondos_mmc.asm):05919                 TFR     X,U                     
DC7C 4F               (dragondos_mmc.asm):05920                 CLRA
DC7D 20D7             (dragondos_mmc.asm):05921                 BRA     ReturnFP                ; return as float in fpa0
                      (dragondos_mmc.asm):05922         
DC7F                  (dragondos_mmc.asm):05923         FuncErl   
DC7F FC0617           (dragondos_mmc.asm):05924                 LDD     DosErrLineNo            ; get last error line
DC82                  (dragondos_mmc.asm):05925         FuncRetVal   
DC82 7E8C37           (dragondos_mmc.asm):05926                 JMP     >VarAssign16Bit2        ; return value to basic
                      (dragondos_mmc.asm):05927         
DC85                  (dragondos_mmc.asm):05928         FuncErr   
DC85 4F               (dragondos_mmc.asm):05929                 CLRA                            ; msb=0
DC86 F60619           (dragondos_mmc.asm):05930                 LDB     DosErrLast              ; get last error no
DC89 20F7             (dragondos_mmc.asm):05931                 BRA     FuncRetVal                      ; return it to basic
                      (dragondos_mmc.asm):05932         
DC8B                  (dragondos_mmc.asm):05933         FuncHimem   
DC8B DC27             (dragondos_mmc.asm):05934                 LDD     <AddrFWareRamTop        ; get hardware ramtop
DC8D 20F3             (dragondos_mmc.asm):05935                 BRA     FuncRetVal                      ; return it to basic
                      (dragondos_mmc.asm):05936         
DC8F                  (dragondos_mmc.asm):05937         FuncFres   
DC8F BD8CD7           (dragondos_mmc.asm):05938                 JSR     >VarGarbageCollect      ; collect garbage...defrag string space !
DC92 DC23             (dragondos_mmc.asm):05939                 LDD     <BasVarStrTop           ; work out size of string space
DC94 9321             (dragondos_mmc.asm):05940                 SUBD    <BasVarStringBase
DC96 20EA             (dragondos_mmc.asm):05941                 BRA     FuncRetVal              ; return it to basic
                      (dragondos_mmc.asm):05942         
                      (dragondos_mmc.asm):05943         ;
                      (dragondos_mmc.asm):05944         ; The actual core disk IO routine, accepts a function code $00..$07
                      (dragondos_mmc.asm):05945         ; these are dispatched through this table
                      (dragondos_mmc.asm):05946         ;
                      (dragondos_mmc.asm):05947         
DC98                  (dragondos_mmc.asm):05948         DosFunctionTable   
DC98 C256             (dragondos_mmc.asm):05949                 FDB     DosFunctionRestore
DC9A C25C             (dragondos_mmc.asm):05950                 FDB     DosFunctionSeek
DC9C C270             (dragondos_mmc.asm):05951                 FDB     DosFunctionReadSec
DC9E C299             (dragondos_mmc.asm):05952                 FDB     DosFunctionWriteSecV
DCA0 C299             (dragondos_mmc.asm):05953                 FDB     DosFunctionWriteSecN
DCA2 C2AC             (dragondos_mmc.asm):05954                 FDB     DosFunctionWriteTrack
DCA4 C26E             (dragondos_mmc.asm):05955                 FDB     DosFunctionReadAddr
DCA6 C283             (dragondos_mmc.asm):05956                 FDB     DosFunctionReadSec2
                      (dragondos_mmc.asm):05957         
                      (dragondos_mmc.asm):05958         ;*********************[Redundent begin]**********************************        
                      (dragondos_mmc.asm):05959                 ifdef   IncludeRedundent        
                      (dragondos_mmc.asm):05960         ;
                      (dragondos_mmc.asm):05961         ; Data table for Format ?
                      (dragondos_mmc.asm):05962         ;
                      (dragondos_mmc.asm):05963                 
DCA8                  (dragondos_mmc.asm):05964         SectorIDTable   
                      (dragondos_mmc.asm):05965                 FCB     $01,$0A                 ; Sector layout table for format ?
                      (dragondos_mmc.asm):05966                 FCB     $02,$0B
                      (dragondos_mmc.asm):05967                 FCB     $03,$0C
                      (dragondos_mmc.asm):05968                 FCB     $04,$0D
                      (dragondos_mmc.asm):05969                 FCB     $05,$0E
                      (dragondos_mmc.asm):05970                 FCB     $06,$0F
                      (dragondos_mmc.asm):05971                 FCB     $07,$10
                      (dragondos_mmc.asm):05972                 FCB     $08,$11
                      (dragondos_mmc.asm):05973                 FCB     $09,$12
                      (dragondos_mmc.asm):05974                 FCB     $00
                      (dragondos_mmc.asm):05975         
                      (dragondos_mmc.asm):05976         ; Track header
DCA8                  (dragondos_mmc.asm):05977         TrackHeaderTable        
                      (dragondos_mmc.asm):05978                 FCB     $35,$4E                 ; 54 bytes of $4E Gap 0
                      (dragondos_mmc.asm):05979                 FCB     $4E                     ; terminator $4E
                      (dragondos_mmc.asm):05980                 FCB     $08,$00                 ; 8 bytes of $00 Preamble
                      (dragondos_mmc.asm):05981                 FCB     $00                     ; terminator $00        
                      (dragondos_mmc.asm):05982                 FCB     $03,$F6                 ; 3 bytes of $F6 Index maek IDAM
                      (dragondos_mmc.asm):05983                 FCB     $FC                     ; terminator $FC
                      (dragondos_mmc.asm):05984                 FCB     $1F,$4E                 ; 31 bytes of $4E Gap 1
                      (dragondos_mmc.asm):05985                 FCB     $4E                     ; terminator $4E
                      (dragondos_mmc.asm):05986         
DCA8                  (dragondos_mmc.asm):05987         TrackHeaderSize EQU     *-TrackHeaderTable      ; size of track header table
                      (dragondos_mmc.asm):05988         
DCA8                  (dragondos_mmc.asm):05989         SectorIDLayout  
                      (dragondos_mmc.asm):05990                 FCB     $07,$00                 ; 7 bytes of $00, Sector ID gap
                      (dragondos_mmc.asm):05991                 FCB     $00                     ; terminator $00
                      (dragondos_mmc.asm):05992                 FCB     $03,$F5                 ; 3 bytes of $F5, ID mark IDAM
                      (dragondos_mmc.asm):05993                 FCB     $FE                     ; terminator $FE
                      (dragondos_mmc.asm):05994                 
DCA8                  (dragondos_mmc.asm):05995         SectorIDP1Len   equ     *-SectorIDLayout        ; size of first part of sector ID
                      (dragondos_mmc.asm):05996                 
DCA8                  (dragondos_mmc.asm):05997         SectorIDLayout2
                      (dragondos_mmc.asm):05998                 FCB     $01,$F7                 ; 1 byte of $F7, generates CRC bytes
                      (dragondos_mmc.asm):05999                 FCB     $4E                     ; terminator $4E        
                      (dragondos_mmc.asm):06000                 FCB     $14,$4E                 ; 20 bytes of $4E Gap 2
                      (dragondos_mmc.asm):06001                 FCB     $4E                     ; terminator $4E
                      (dragondos_mmc.asm):06002                 
                      (dragondos_mmc.asm):06003         ; the sector data starts here   
                      (dragondos_mmc.asm):06004                 FCB     $0B,$00                 ; 11 bytes of $00
                      (dragondos_mmc.asm):06005                 FCB     $00                     ; terminator $00
                      (dragondos_mmc.asm):06006                 FCB     $03,$F5                 ; 3 bytes of $F5 Data IDAM
                      (dragondos_mmc.asm):06007                 FCB     $FB                     ; terminator $FB
                      (dragondos_mmc.asm):06008                 FCB     $00,$E5                 ; 256 bytes of $E5 sector data
                      (dragondos_mmc.asm):06009                 FCB     $F7                     ; terminator $F7, generates 2 CRC bytes
                      (dragondos_mmc.asm):06010                 FCB     $17,$4E                 ; 23 bytes of $4E
                      (dragondos_mmc.asm):06011                 FCB     $4E                     ; terminator $4E
DCA8                  (dragondos_mmc.asm):06012         SectorIDP2Len   equ     *-SectorIDLayout2
                      (dragondos_mmc.asm):06013         
                      (dragondos_mmc.asm):06014         ; this data is used at the end of the scrtor data for this track
DCA8                  (dragondos_mmc.asm):06015         TrackFiller
                      (dragondos_mmc.asm):06016                 FCB     $00,$4E                 ; 256 bytes of $4E
                      (dragondos_mmc.asm):06017                 FCB     $4E                     ; terminator $4E
                      (dragondos_mmc.asm):06018         
DCA8                  (dragondos_mmc.asm):06019         TrackFillerLen  EQU     *-TrackFiller   ; length of filler bytes        
                      (dragondos_mmc.asm):06020         
                      (dragondos_mmc.asm):06021                 endc
                      (dragondos_mmc.asm):06022         ;*********************[Redundent end]************************************        
                      (dragondos_mmc.asm):06023         
                      (dragondos_mmc.asm):06024         ;
                      (dragondos_mmc.asm):06025         ; Data copied into low ram at init, interrupt vectors etc
                      (dragondos_mmc.asm):06026         ;
                      (dragondos_mmc.asm):06027         
                      (dragondos_mmc.asm):06028                 ifeq    1
DCA8                  (dragondos_mmc.asm):06029         NewVectorTable   FCB     (ENDINTVEC-NMIJMP)     ; No bytes
                      (dragondos_mmc.asm):06030                 FDB     SecVecNMI               ; address to copy
                      (dragondos_mmc.asm):06031         ; interrupt vectors
DCA8                  (dragondos_mmc.asm):06032         NMIJMP  JMP     >NMISrv
DCA8                  (dragondos_mmc.asm):06033         IRQJMP  JMP     >IRQSrv
DCA8                  (dragondos_mmc.asm):06034         FIRQJMP JMP     >FIRQSrv
DCA8                  (dragondos_mmc.asm):06035         ENDINTVEC
                      (dragondos_mmc.asm):06036                 else
                      (dragondos_mmc.asm):06037         ; The MMC version only uses IRQ.
DCA8                  (dragondos_mmc.asm):06038         NewVectorTable   
DCA8 03               (dragondos_mmc.asm):06039                 FCB     (ENDINTVEC-IRQJMP)      ; No bytes
DCA9 010C             (dragondos_mmc.asm):06040                 FDB     SecVecIRQ               ; address to copy
DCAB 7EC5BF           (dragondos_mmc.asm):06041         IRQJMP  JMP     >IRQSrv
DCAE                  (dragondos_mmc.asm):06042         ENDINTVEC       
                      (dragondos_mmc.asm):06043                 endc
                      (dragondos_mmc.asm):06044                 
                      (dragondos_mmc.asm):06045         ; Dos vars, step rates for drives
                      (dragondos_mmc.asm):06046         ;
                      (dragondos_mmc.asm):06047         ;        FCB     (EndStep-BeginStep)    ; No bytes
                      (dragondos_mmc.asm):06048         ;        FDB     DosD0StepRate          ; address to copy
                      (dragondos_mmc.asm):06049         ;
                      (dragondos_mmc.asm):06050         ;BeginStep
                      (dragondos_mmc.asm):06051         ;        FCB     SeepRateDefault
                      (dragondos_mmc.asm):06052         ;        FCB     SeepRateDefault
                      (dragondos_mmc.asm):06053         ;        FCB     SeepRateDefault
                      (dragondos_mmc.asm):06054         ;        FCB     SeepRateDefault
                      (dragondos_mmc.asm):06055         ;EndStep
                      (dragondos_mmc.asm):06056         
DCAE 00               (dragondos_mmc.asm):06057                 FCB     $00                     ; No bytes : terminate
                      (dragondos_mmc.asm):06058         
DCAF                  (dragondos_mmc.asm):06059         RamHookTable   
DCAF D7AD             (dragondos_mmc.asm):06060                 FDB     DosHookOpenDev          ; open dev/file
DCB1 D7A5             (dragondos_mmc.asm):06061         DDE97   FDB     DosHookCheckIONum       ; check io num
DCB3 C247             (dragondos_mmc.asm):06062         DDE99   FDB     DosHookRetDevParam      ; return dev parameters
DCB5 D7C2             (dragondos_mmc.asm):06063         DDE9B   FDB     DosHookCharOut          ; char output   
DCB7 C247             (dragondos_mmc.asm):06064                 FDB     DosHookRetDevParam      ; char input
DCB9 C247             (dragondos_mmc.asm):06065                 FDB     DosHookRetDevParam      ; check dev open for input
DCBB C247             (dragondos_mmc.asm):06066                 FDB     DosHookRetDevParam      ; check dev open for output
DCBD D5A6             (dragondos_mmc.asm):06067                 FDB     DosCloseAllFiles        ; close all devs and files
DCBF D5B6             (dragondos_mmc.asm):06068         DDEA5   FDB     DosCloseSingleFile      ; close single dev/file
DCC1 C247             (dragondos_mmc.asm):06069         DDEA7   FDB     DosHookRetDevParam      ; first char of new statement
DCC3 D80B             (dragondos_mmc.asm):06070         DDEA9   FDB     DosHookDiskItem         ; Disk file item scanner
DCC5 C247             (dragondos_mmc.asm):06071         DDEAB   FDB     DosHookRetDevParam      ; poll for break
DCC7 D982             (dragondos_mmc.asm):06072                 FDB     DosHookReadInputFix     ; read line of input
DCC9 C247             (dragondos_mmc.asm):06073                 FDB     DosHookRetDevParam      ; finish loading ASCII program
DCCB DC11             (dragondos_mmc.asm):06074                 FDB     DosHookEOF              ; EOF function
DCCD C247             (dragondos_mmc.asm):06075                 FDB     DosHookRetDevParam      ; Eval expression
DCCF C247             (dragondos_mmc.asm):06076                 FDB     DosHookRetDevParam      ; User error trap
DCD1 C56F             (dragondos_mmc.asm):06077                 FDB     DosHookSysError         ; System error trap
DCD3 D33B             (dragondos_mmc.asm):06078                 FDB     DosHookRun              ; run statement
                      (dragondos_mmc.asm):06079                                         
                      (dragondos_mmc.asm):06080         ;
                      (dragondos_mmc.asm):06081         ; Some mesagaes
                      (dragondos_mmc.asm):06082         ;
DCD5                  (dragondos_mmc.asm):06083         MessInsertSource
DCD5 494E534552542053 (dragondos_mmc.asm):06084                 FCC     /INSERT SOURCE/
     4F55524345
DCE2 0D               (dragondos_mmc.asm):06085                 FCB     $0D
DCE3 00               (dragondos_mmc.asm):06086                 FCB     $00
DCE4                  (dragondos_mmc.asm):06087         MessInsertDest
DCE4 494E534552542044 (dragondos_mmc.asm):06088                 FCC     /INSERT DESTINATION/
     455354494E415449
     4F4E
DCF6 0D               (dragondos_mmc.asm):06089                 FCB     $0D
DCF7 00               (dragondos_mmc.asm):06090                 FCB     $00
                      (dragondos_mmc.asm):06091                 
DCF8                  (dragondos_mmc.asm):06092         DMessPressAnyKey   
DCF8 505245535320414E (dragondos_mmc.asm):06093                 FCC     /PRESS ANY KEY/
     59204B4559
DD05 0D               (dragondos_mmc.asm):06094                 FCB     $0D
DD06 00               (dragondos_mmc.asm):06095                 FCB     $00
                      (dragondos_mmc.asm):06096         
DD07                  (dragondos_mmc.asm):06097         DosExtBas   
DD07 424153           (dragondos_mmc.asm):06098                 FCC     /BAS/
DD0A                  (dragondos_mmc.asm):06099         DosExtDat       
DD0A 444154           (dragondos_mmc.asm):06100                 FCC     /DAT/
DD0D                  (dragondos_mmc.asm):06101         DosExtBin       
DD0D 42494E           (dragondos_mmc.asm):06102                 FCC     /BIN/
DD10                  (dragondos_mmc.asm):06103         DosExtNone      
DD10 202020           (dragondos_mmc.asm):06104                 FCC     /   /
                      (dragondos_mmc.asm):06105         
DD13                  (dragondos_mmc.asm):06106         DosErrorCodeTable
DD13 4E52             (dragondos_mmc.asm):06107                 FCC     /NR/            ; $80 : not ready
DD15 534B             (dragondos_mmc.asm):06108                 FCC     /SK/            ; $82 : seek
DD17 5750             (dragondos_mmc.asm):06109                 FCC     /WP/            ; $84 : write protect
DD19 5254             (dragondos_mmc.asm):06110                 FCC     /RT/            ; $86 : record type
DD1B 5246             (dragondos_mmc.asm):06111                 FCC     /RF/            ; $88 : record not found
DD1D 4343             (dragondos_mmc.asm):06112                 FCC     /CC/            ; $8A : CRC
DD1F 4C44             (dragondos_mmc.asm):06113                 FCC     /LD/            ; $8C : Lost data
DD21 4254             (dragondos_mmc.asm):06114                 FCC     /BT/            ; $8E : boot
DD23 4956             (dragondos_mmc.asm):06115                 FCC     /IV/            ; $90 : invalid volume / directory
DD25 4644             (dragondos_mmc.asm):06116                 FCC     /FD/            ; $92 : Full directory
DD27 4446             (dragondos_mmc.asm):06117                 FCC     /DF/            ; $94 : Disk full
DD29 4653             (dragondos_mmc.asm):06118                 FCC     /FS/            ; $96 : File spec
DD2B 5054             (dragondos_mmc.asm):06119                 FCC     /PT/            ; $98 : Protection
DD2D 5045             (dragondos_mmc.asm):06120                 FCC     /PE/            ; $9A : (read) Past end 
DD2F 4646             (dragondos_mmc.asm):06121                 FCC     /FF/            ; $9C : File not Found 
DD31 4645             (dragondos_mmc.asm):06122                 FCC     /FE/            ; $9E : File exists
DD33 4E45             (dragondos_mmc.asm):06123                 FCC     /NE/            ; $A0 : (file does) Not Exist
DD35 5446             (dragondos_mmc.asm):06124                 FCC     /TF/            ; $A2 : Too many Files open
DD37 5052             (dragondos_mmc.asm):06125                 FCC     /PR/            ; $A4 : Parameter
DD39 3F3F             (dragondos_mmc.asm):06126                 FCC     /??/            ; $A6 : Undefined
                      (dragondos_mmc.asm):06127         
DD3B                  (dragondos_mmc.asm):06128         DosSignonMess   
DD3B 445241474F4E444F (dragondos_mmc.asm):06129                 FCC     /DRAGONDOS /
     5320
DD45 312E334D4D43     (dragondos_mmc.asm):06130                 FCC     /1.3MMC/
DD4B 0D               (dragondos_mmc.asm):06131                 FCB     $0D
DD4C 00               (dragondos_mmc.asm):06132                 FCB     $00
                      (dragondos_mmc.asm):06133                 
DD4D B6067D           (dragondos_mmc.asm):06134         LDFCA   LDA     DosTempFCBNo
DD50 6D9F0678         (dragondos_mmc.asm):06135                 TST     [DosSaveFCB]
DD54 39               (dragondos_mmc.asm):06136                 RTS
                      (dragondos_mmc.asm):06137                 
                      (dragondos_mmc.asm):06138         ; Set PIAs, called with X=FF01 or X=FF21
                      (dragondos_mmc.asm):06139         ; Called with EXG as that way we can return ans still leave things on the stack.
                      (dragondos_mmc.asm):06140         
                      (dragondos_mmc.asm):06141                 if 0
DD55                  (dragondos_mmc.asm):06142         SetPIA  LDA     ,X
                      (dragondos_mmc.asm):06143                 PSHS    A
                      (dragondos_mmc.asm):06144                 STB     ,X++
                      (dragondos_mmc.asm):06145                 LDA     ,X
                      (dragondos_mmc.asm):06146                 PSHS    A
                      (dragondos_mmc.asm):06147                 STB     ,X
                      (dragondos_mmc.asm):06148                 LDX     #PIA1CRA
                      (dragondos_mmc.asm):06149                 TFR     U,PC
                      (dragondos_mmc.asm):06150         
DD55                  (dragondos_mmc.asm):06151         ResetPIA   
                      (dragondos_mmc.asm):06152                 LDX     #$FF25
DD55                  (dragondos_mmc.asm):06153         ResetPIA2   
                      (dragondos_mmc.asm):06154                 PULS    A
                      (dragondos_mmc.asm):06155                 STA     ,--X
                      (dragondos_mmc.asm):06156                 PULS    A
                      (dragondos_mmc.asm):06157                 STA     ,--X
                      (dragondos_mmc.asm):06158                 LDX     #$FF05
                      (dragondos_mmc.asm):06159                 TFR     U,PC
                      (dragondos_mmc.asm):06160                 endc
                      (dragondos_mmc.asm):06161                 
DD55 5D               (dragondos_mmc.asm):06162         LDFF3   TSTB
DD56 2603             (dragondos_mmc.asm):06163                 BNE     LDFF9
DD58 C696             (dragondos_mmc.asm):06164                 LDB     #$96
DD5A 39               (dragondos_mmc.asm):06165                 RTS
DD5B B6060A           (dragondos_mmc.asm):06166         LDFF9   LDA     DosDefDriveNo
DD5E 7EC66C           (dragondos_mmc.asm):06167                 JMP     LC7C1
DD61 00               (dragondos_mmc.asm):06168                 FCB     $00
                      (dragondos_mmc.asm):06169                 
                      (dragondos_mmc.asm):06170                 
                      (dragondos_mmc.asm):06171         ;DE000   END
                      (    DragonMMC.asm):00138                         endc
                      (    DragonMMC.asm):00139                         
                      (    DragonMMC.asm):00140                         ifdef   Tandy
                      (    DragonMMC.asm):00141                         use             rsdos_mmc.asm
                      (    DragonMMC.asm):00142                         endc
                      (    DragonMMC.asm):00143         
DD62                  (    DragonMMC.asm):00144         __dosspare      
DD62 0000000000000000 (    DragonMMC.asm):00145                         zmb             ($e000-*)
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     000000000000
E000                  (    DragonMMC.asm):00146         __dosspare_end
                      (    DragonMMC.asm):00147                         
E000                  (    DragonMMC.asm):00148         __main
E000 444B             (    DragonMMC.asm):00149                         FCC     /DK/
E002 2008             (    DragonMMC.asm):00150                         BRA     RealMMCInit     
                      (    DragonMMC.asm):00151                         endc
                      (    DragonMMC.asm):00152         
                      (    DragonMMC.asm):00153         ;Util_SafeCopy
                      (    DragonMMC.asm):00154         ;               JMP             >DO_SafeCopy            ; Jump to safe copy routine     
                      (    DragonMMC.asm):00155         ;Util_RamCopy
                      (    DragonMMC.asm):00156         ;               JMP             >DO_RamCopy
E004                  (    DragonMMC.asm):00157         Util_Select     
E004 7EE035           (    DragonMMC.asm):00158                         JMP             >DO_Select
                      (    DragonMMC.asm):00159         ;Util_AssignU16D
                      (    DragonMMC.asm):00160         ;               JMP             >DO_Assign16
                      (    DragonMMC.asm):00161         
E007 7EF33F           (    DragonMMC.asm):00162                         jmp             >Inverse
                      (    DragonMMC.asm):00163                         
E00A                  (    DragonMMC.asm):00164         Signature:
E00A 2112             (    DragonMMC.asm):00165                         FDB             SignatureWord   ; So NMI chan check to see if we are paged in.
                      (    DragonMMC.asm):00166         ;
                      (    DragonMMC.asm):00167         ; Init Dos
                      (    DragonMMC.asm):00168         ; 
                      (    DragonMMC.asm):00169                         ifeq    BuildDos
E00C                  (    DragonMMC.asm):00170         MMCInit
                      (    DragonMMC.asm):00171                         else
E00C                  (    DragonMMC.asm):00172         RealMMCInit
                      (    DragonMMC.asm):00173                 endc
                      (    DragonMMC.asm):00174         
E00C 2039             (    DragonMMC.asm):00175                         bra             DoInit
                      (    DragonMMC.asm):00176                         
                      (    DragonMMC.asm):00177                         use     mmc_simple_func.asm
                      (c_simple_func.asm):00001         ;
                      (c_simple_func.asm):00002         ; Simple MMC functions.
                      (c_simple_func.asm):00003         ;
                      (c_simple_func.asm):00004         ; 2011-06-13 Phill Harvey-Smith.
                      (c_simple_func.asm):00005         ;
                      (c_simple_func.asm):00006         ; 2024-09-28, Moved into own function so could be included in early
                      (c_simple_func.asm):00007         ; part of rom that is the same for Dragon and CoCo. 
                      (c_simple_func.asm):00008         ;
                      (c_simple_func.asm):00009         ; Define MINIMUM to exclude code not needed by FLASH
                      (c_simple_func.asm):00010         ;
                      (c_simple_func.asm):00011         
                      (c_simple_func.asm):00012         ;
                      (c_simple_func.asm):00013         ; **** NOTE ****
                      (c_simple_func.asm):00014         ;
                      (c_simple_func.asm):00015         ; Send CMD_INIT_READ with MMC_sendCmdRaw *NOT* MMC_SendCmd
                      (c_simple_func.asm):00016         ;
E00E                  (c_simple_func.asm):00017         __mmc_simple_func
                      (c_simple_func.asm):00018         
                      (c_simple_func.asm):00019         ;
                      (c_simple_func.asm):00020         ; Send Command
                      (c_simple_func.asm):00021         ;
                      (c_simple_func.asm):00022         ; Entry a = command to send
                      (c_simple_func.asm):00023         ;
                      (c_simple_func.asm):00024         ; exit a = status code.
                      (c_simple_func.asm):00025         ;
                      (c_simple_func.asm):00026         
E00E                  (c_simple_func.asm):00027         MMC_SendCmd
E00E 8D07             (c_simple_func.asm):00028                         bsr             MMC_SendCmdRaw                  ; send the command
                      (c_simple_func.asm):00029         
                      (c_simple_func.asm):00030         ;               lda             #STATUS_FLAG_WRITTEN    ; Written flag
                      (c_simple_func.asm):00031         ;               anda    D_STATUS_REG                    ; is it set ?
                      (c_simple_func.asm):00032         ;               beq             MMC_SendCmdNoResult             ; no clear a and return
                      (c_simple_func.asm):00033         
E010 B6FF50           (c_simple_func.asm):00034                         lda             D_CMD_REG                               ; Get status (if any)
E013 4D               (c_simple_func.asm):00035                         tsta
E014 39               (c_simple_func.asm):00036                         rts                                                             ; return
                      (c_simple_func.asm):00037                         
E015                  (c_simple_func.asm):00038         MMC_SendCmdNoResult
                      (c_simple_func.asm):00039         
E015 4F               (c_simple_func.asm):00040                         clra                                                    ; flag no error
E016 39               (c_simple_func.asm):00041                         rts
                      (c_simple_func.asm):00042                         
                      (c_simple_func.asm):00043         ;
                      (c_simple_func.asm):00044         ; Send a command but don't read a result.
                      (c_simple_func.asm):00045         ;
                      (c_simple_func.asm):00046         
E017                  (c_simple_func.asm):00047         MMC_SendCmdRaw
E017 B7FF50           (c_simple_func.asm):00048                         sta             D_CMD_REG                               ; send the command
                      (c_simple_func.asm):00049         
                      (c_simple_func.asm):00050         ;
                      (c_simple_func.asm):00051         ; MMC_WaitNotBusy, waits for the Pico busy flag to be reset.
                      (c_simple_func.asm):00052         ;
E01A                  (c_simple_func.asm):00053         MMC_WaitNotBusy
                      (c_simple_func.asm):00054                 ifndef  EMULATE
                      (c_simple_func.asm):00055                 
E01A                  (c_simple_func.asm):00056         MMC_WaitNotBusyLoop        
E01A B6FF53           (c_simple_func.asm):00057                         lda             D_STATUS_REG
                      (c_simple_func.asm):00058         ;               jsr             CON_HexByteAt0          
E01D 4D               (c_simple_func.asm):00059                         tsta
E01E 2BFA             (c_simple_func.asm):00060                         bmi             MMC_WaitNotBusyLoop             ; yes : keep waiting
                      (c_simple_func.asm):00061         
                      (c_simple_func.asm):00062                 endc
E020 39               (c_simple_func.asm):00063                         rts
                      (c_simple_func.asm):00064         
                      (c_simple_func.asm):00065         ;
                      (c_simple_func.asm):00066         ; MMC_WaitPutLatchRead Send a byte in a to the AVR LATCH_REG and wait for it to read it
                      (c_simple_func.asm):00067         ;
E021                  (c_simple_func.asm):00068         MMC_WaitPutLatchRead
E021 B7FF51           (c_simple_func.asm):00069                         sta             D_LATCH_REG                             ; write the data
E024 20F4             (c_simple_func.asm):00070                         bra             MMC_WaitNotBusy
                      (c_simple_func.asm):00071         
                      (c_simple_func.asm):00072         ;
                      (c_simple_func.asm):00073         ; MMC_GetRAMCTRL
                      (c_simple_func.asm):00074         ; 
                      (c_simple_func.asm):00075         ; Return the current RAM_CTRL byte in a
                      (c_simple_func.asm):00076         ;
E026                  (c_simple_func.asm):00077         MMC_GetRAMCTRL
E026 86E8             (c_simple_func.asm):00078                         lda             #CMD_GET_RAM_CTRL               ; Get the RAM_CTRL register
                      (c_simple_func.asm):00079                         
                      (c_simple_func.asm):00080         ;
                      (c_simple_func.asm):00081         ; MMC_SendCmdLatchRead
                      (c_simple_func.asm):00082         ; 
                      (c_simple_func.asm):00083         ; Send command in a, and get single byte reply (from latch) in a
                      (c_simple_func.asm):00084         ;               
E028                  (c_simple_func.asm):00085         MMC_SendCmdLatchRead
E028 8DE4             (c_simple_func.asm):00086                         bsr             MMC_SendCmd                             ; send it
                      (c_simple_func.asm):00087                         
E02A B6FF51           (c_simple_func.asm):00088                         lda             D_LATCH_REG                             ; retrieve it.
E02D 39               (c_simple_func.asm):00089                         rts
                      (c_simple_func.asm):00090         
                      (c_simple_func.asm):00091         ;
                      (c_simple_func.asm):00092         ; MMC_SetRAMCTRL
                      (c_simple_func.asm):00093         ; 
                      (c_simple_func.asm):00094         ; Set the RAM_CTRL byte in to the value in a
                      (c_simple_func.asm):00095         ;
                      (c_simple_func.asm):00096         
E02E                  (c_simple_func.asm):00097         MMC_SetRAMCTRL
E02E 8DF1             (c_simple_func.asm):00098                         bsr             MMC_WaitPutLatchRead    ; Put the new byte in the latch
E030 86E9             (c_simple_func.asm):00099                         lda             #CMD_SET_RAM_CTRL               ; Set it.
E032 8DDA             (c_simple_func.asm):00100                         bsr             MMC_SendCmd                             ; send it
E034 39               (c_simple_func.asm):00101                         rts
                      (c_simple_func.asm):00102         
E035                  (c_simple_func.asm):00103         __mmc_simple_func_end
                      (    DragonMMC.asm):00178                 
                      (    DragonMMC.asm):00179         ;
                      (    DragonMMC.asm):00180         ; First try and detect the machine type
                      (    DragonMMC.asm):00181         ;
E035                  (    DragonMMC.asm):00182         DO_Select
                      (    DragonMMC.asm):00183                         
E035 8DEF             (    DragonMMC.asm):00184                         bsr             MMC_GetRAMCTRL                  ; Get ram control reg
                      (    DragonMMC.asm):00185         
E037 84F7             (    DragonMMC.asm):00186                 anda    #D_SEL_DRAGON           ; Default to dragon
                      (    DragonMMC.asm):00187                 
E039 3402             (    DragonMMC.asm):00188                 pshs    a
E03B BDE36F           (    DragonMMC.asm):00189                         jsr     >MachineDetect          ; Detect the machine
E03E 3502             (    DragonMMC.asm):00190                         puls    a                                               ; note doesn't change flags
E040 2702             (    DragonMMC.asm):00191                 beq     InitDragon
                      (    DragonMMC.asm):00192                 
E042 8A08             (    DragonMMC.asm):00193                 ora     #D_SEL_COCO             ; Select CoCo version
                      (    DragonMMC.asm):00194                 
E044                  (    DragonMMC.asm):00195         InitDragon
E044 8DE8             (    DragonMMC.asm):00196                         bsr             MMC_SetRAMCTRL                  ; Update it
                      (    DragonMMC.asm):00197         
E046 39               (    DragonMMC.asm):00198                         rts
                      (    DragonMMC.asm):00199         
                      (    DragonMMC.asm):00200                         ifne    0
E047                  (    DragonMMC.asm):00201         DO_SWI
                      (    DragonMMC.asm):00202                         swi                                                             ; So we can test in MESS
                      (    DragonMMC.asm):00203                         rts
                      (    DragonMMC.asm):00204                         endc 
                      (    DragonMMC.asm):00205                         
                      (    DragonMMC.asm):00206         ;
                      (    DragonMMC.asm):00207         ; Init various low ram stuff, interrupt vectors, basic stub etc
                      (    DragonMMC.asm):00208         ; 
                      (    DragonMMC.asm):00209                 
E047                  (    DragonMMC.asm):00210         DoInit    
E047 BDE004           (    DragonMMC.asm):00211                         jsr             >Util_Select                    ; Select correct ROM version
E04A BDF0AB           (    DragonMMC.asm):00212                         jsr             >InterruptInit                  ; Initialize interrupt vectors
                      (    DragonMMC.asm):00213         
E04D 8EE106           (    DragonMMC.asm):00214                 LDX     #RamVarPointer                  ; Point to rom copy of data to copy
E050                  (    DragonMMC.asm):00215         MMCLC049   
E050 E680             (    DragonMMC.asm):00216                         LDB     ,X+                                             ; Get byte count byte
E052 2707             (    DragonMMC.asm):00217                 BEQ     MMCLC054                                ; zero= end of table, exit copy
E054 EE81             (    DragonMMC.asm):00218                 LDU     ,X++                                    ; Get destination address
E056 BDB7CC           (    DragonMMC.asm):00219                 JSR     >UtilCopyBXtoU                  ; do copy
E059 20F5             (    DragonMMC.asm):00220                 BRA     MMCLC049                                ; do next
                      (    DragonMMC.asm):00221         
E05B                  (    DragonMMC.asm):00222         MMCLC054
E05B BDECAE           (    DragonMMC.asm):00223                         JSR             >SetPlatform                    ; Tell the Pico what our platform is
E05E BDECB8           (    DragonMMC.asm):00224                         JSR             >GetConfig                              ; get config byte
                      (    DragonMMC.asm):00225         
                      (    DragonMMC.asm):00226                         ifdef   BuildDos
E061 9676             (    DragonMMC.asm):00227                         lda             <CFGByte                                ; Get config byte
                      (    DragonMMC.asm):00228                         
                      (    DragonMMC.asm):00229                         ifdef   EMULATE
                      (    DragonMMC.asm):00230                 lda     #$08                                    ; show compile date only
                      (    DragonMMC.asm):00231                 sta     <CFGByte
                      (    DragonMMC.asm):00232                         endc
                      (    DragonMMC.asm):00233                 
E063 8520             (    DragonMMC.asm):00234                         bita    #CFG_ENABLE_DOS                 ; is dos emulation enabled ?
E065 260F             (    DragonMMC.asm):00235                         bne             MMCNoMoveUSR                    ; dos emulation enabled don't move USR vectors
                      (    DragonMMC.asm):00236                         
                      (    DragonMMC.asm):00237                         endc
E067 8E00EC           (    DragonMMC.asm):00238                         LDX     #NewUsrVec                              ; Adjust usr vector base
E06A 9FB0             (    DragonMMC.asm):00239                 STX     <BasUSRTableAddr        
E06C CE8B8D           (    DragonMMC.asm):00240                 LDU     #BasFCError                             ; Setup the 10 usr vectors to point to BasFCError
E06F C60A             (    DragonMMC.asm):00241                 LDB     #$0A                                    ; do 10
E071                  (    DragonMMC.asm):00242         MMCLC064   
E071 EF81             (    DragonMMC.asm):00243                         STU     ,X++                                    ; setup vector
E073 5A               (    DragonMMC.asm):00244                 DECB                                                    ; decrement count
E074 26FB             (    DragonMMC.asm):00245                 BNE     MMCLC064                                ; loop again if more to do
                      (    DragonMMC.asm):00246         
E076                  (    DragonMMC.asm):00247         MMCNoMoveUSR            
E076 8EE0FC           (    DragonMMC.asm):00248                 LDX     #ResetVector                    ; Setup new reset vector
E079 9F72             (    DragonMMC.asm):00249                 STX     <IndVecReset
E07B 8655             (    DragonMMC.asm):00250                         lda             #$55                                    ; Mark reset vector valid
E07D 9771             (    DragonMMC.asm):00251                         sta             <WarmStartFlag
                      (    DragonMMC.asm):00252                                 
E07F 1CAF             (    DragonMMC.asm):00253                 ANDCC   #~(FlagIRQ+FlagFIRQ)    ; reenable inturrupts
                      (    DragonMMC.asm):00254                     
E081 8EB4B2           (    DragonMMC.asm):00255                 LDX     #BasSignonMess                  ; Print staandard Basic signon message
E084 BD90E5           (    DragonMMC.asm):00256                 JSR     >TextOutString
                      (    DragonMMC.asm):00257                 
E087 8EE37C           (    DragonMMC.asm):00258                 LDX     #SignonMess-1
E08A BD90E5           (    DragonMMC.asm):00259                 JSR     >TextOutString
                      (    DragonMMC.asm):00260                 
E08D 9676             (    DragonMMC.asm):00261                 lda             <CFGByte                                ; Get config byte (as DosInit may have trashed it!)
E08F 8508             (    DragonMMC.asm):00262                         bita    #CFG_SHOW_COMPILE       ; show compile date?
E091 2706             (    DragonMMC.asm):00263                 beq     CheckDateTime           ; nope
                      (    DragonMMC.asm):00264                 
E093 8EE39D           (    DragonMMC.asm):00265                 LDX     #CompileDate-1          ; show compile date
E096 BD90E5           (    DragonMMC.asm):00266                 JSR     >TextOutString      
                      (    DragonMMC.asm):00267                 
E099                  (    DragonMMC.asm):00268         CheckDateTime
E099 9676             (    DragonMMC.asm):00269                 lda             <CFGByte                                ; Get config byte (as DosInit may have trashed it!)
E09B 8510             (    DragonMMC.asm):00270                         bita    #CFG_SHOW_DATETIME      ; show date and time?
E09D 2703             (    DragonMMC.asm):00271                 beq     NoDateTime
                      (    DragonMMC.asm):00272                 
E09F BDEBF8           (    DragonMMC.asm):00273                 jsr     >ShowDateTime            ; Display date and time from RTC
E0A2                  (    DragonMMC.asm):00274         NoDateTime
                      (    DragonMMC.asm):00275                         
                      (    DragonMMC.asm):00276                         ifdef   BuildDos
E0A2 9676             (    DragonMMC.asm):00277                         lda             <CFGByte                                ; Get config byte
                      (    DragonMMC.asm):00278         
E0A4 8520             (    DragonMMC.asm):00279                         bita    #CFG_ENABLE_DOS                 ; is dos emulation enabled ?
E0A6 2703             (    DragonMMC.asm):00280                         BEQ             MMCNoDosInit                    ; nope : don't init
E0A8 7EC02D           (    DragonMMC.asm):00281                         JMP             DosInit                                 ; init dos if linked and enabled, exits to command mode
                      (    DragonMMC.asm):00282         
E0AB                  (    DragonMMC.asm):00283         MMCNoDosInit
                      (    DragonMMC.asm):00284                         endc
                      (    DragonMMC.asm):00285         
E0AB                  (    DragonMMC.asm):00286         MMC_InitDone
E0AB BDE890           (    DragonMMC.asm):00287                         jsr         >TestAutoBoot                       ; test for auto-boot, does not return if boots
                      (    DragonMMC.asm):00288         
E0AE 7E8371           (    DragonMMC.asm):00289                 JMP     >BasCmdMode                             ; Jump to normal basic command mode
                      (    DragonMMC.asm):00290                 
                      (    DragonMMC.asm):00291         ;
                      (    DragonMMC.asm):00292         ; Dispatch routines for new functions/commands
                      (    DragonMMC.asm):00293         ;
                      (    DragonMMC.asm):00294         
E0B1                  (    DragonMMC.asm):00295         CmdDispatch   
E0B1 81FF             (    DragonMMC.asm):00296                         CMPA    #$FF                                    ; Token in range ?
E0B3 2704             (    DragonMMC.asm):00297                 BEQ     CmdDispatchSN                   ; nope : error
E0B5 80CE             (    DragonMMC.asm):00298                 SUBA    #DOSTokFirstC                   ; make our tokens zero based
E0B7 2A03             (    DragonMMC.asm):00299                 BPL     CmdCheckDOS                             
E0B9                  (    DragonMMC.asm):00300         CmdDispatchSN
E0B9 7E89B4           (    DragonMMC.asm):00301                         JMP     >BasSNError                             ; Basic : ?SNerror
                      (    DragonMMC.asm):00302         
E0BC                  (    DragonMMC.asm):00303         CmdCheckDOS
E0BC 3402             (    DragonMMC.asm):00304                         pshs    a
E0BE 9676             (    DragonMMC.asm):00305                         lda             <CFGByte                                ; Get config byte
E0C0 8520             (    DragonMMC.asm):00306                         bita    #CFG_ENABLE_DOS                 ; is dos emulation enabled ?
E0C2 3502             (    DragonMMC.asm):00307                         puls    a                                               ; doesn't affect flags !
E0C4 2604             (    DragonMMC.asm):00308                         bne             CmdDOSOk                                ; dos emulation enabled accept all tokens
                      (    DragonMMC.asm):00309         
E0C6 811A             (    DragonMMC.asm):00310                         cmpa    #DOSTokCountC                   ; Is it a dos token with DOS disabled ?
E0C8 25EF             (    DragonMMC.asm):00311                         blo             CmdDispatchSN                   ; yes : ?SNError        
                      (    DragonMMC.asm):00312         
E0CA                  (    DragonMMC.asm):00313         CmdDOSOk
E0CA 812D             (    DragonMMC.asm):00314                         CMPA    #NoCmds                                 ; Is this one of our commands ?
E0CC 2406             (    DragonMMC.asm):00315                 BCC     JumpToNextStubCmd               ; nope : try next stub (if any)
E0CE 8EE11F           (    DragonMMC.asm):00316                 LDX     #CommandDispatchTable   ; point to table of commands
E0D1 7E84ED           (    DragonMMC.asm):00317                         JMP             BasDoDispatch                   ; go execute it !
                      (    DragonMMC.asm):00318                         
E0D4                  (    DragonMMC.asm):00319         JumpToNextStubCmd
                      (    DragonMMC.asm):00320                         ifdef   Dragon
E0D4 6E9F0137         (    DragonMMC.asm):00321                         JMP     [>DBasStub2+DStubResJumpOfs]
                      (    DragonMMC.asm):00322                         else
                      (    DragonMMC.asm):00323                         jmp             [>CBasStub3+DStubResJumpOfs]
                      (    DragonMMC.asm):00324                         endc
                      (    DragonMMC.asm):00325         
                      (    DragonMMC.asm):00326         ;
                      (    DragonMMC.asm):00327         ; On entering this routine, the function code has been left shifted 1 bit.
                      (    DragonMMC.asm):00328         ; This has the effect of discarding the top bit and converting the remaining
                      (    DragonMMC.asm):00329         ; bits to an offset into the jump table.
                      (    DragonMMC.asm):00330         ;
E0D8                  (    DragonMMC.asm):00331         FuncDispatch   
E0D8 C044             (    DragonMMC.asm):00332                         SUBB    #((DOSTokFirstF*2)&$FF)         ; Make function offset zero based
E0DA 2A02             (    DragonMMC.asm):00333                 BPL     LC691                                   ; is this a basic function ?
E0DC 20DB             (    DragonMMC.asm):00334                 BRA     CmdDispatchSN                   ; yep : error
                      (    DragonMMC.asm):00335         
E0DE C122             (    DragonMMC.asm):00336         LC691   CMPB    #((NoFunc+1)*2)                 ; is this function handled by us ?
E0E0 2416             (    DragonMMC.asm):00337                 BCC     JumpToNextStubFn                ; nope : try next stub
                      (    DragonMMC.asm):00338                         
E0E2 3402             (    DragonMMC.asm):00339                         pshs    a
E0E4 9676             (    DragonMMC.asm):00340                         lda             <CFGByte                                ; Get config byte
E0E6 8520             (    DragonMMC.asm):00341                         bita    #CFG_ENABLE_DOS                 ; is dos emulation enabled ?
E0E8 3502             (    DragonMMC.asm):00342                         puls    a                                               ; doesn't affect flags !
E0EA 2604             (    DragonMMC.asm):00343                         bne             FuncDOSOk                               ; dos emulation enabled accept all tokens
                      (    DragonMMC.asm):00344         
E0EC C10E             (    DragonMMC.asm):00345                         cmpb    #(DOSTokCountF*2)               ; Is it a dos token with DOS disabled ?
E0EE 25C9             (    DragonMMC.asm):00346                         blo             CmdDispatchSN                   ; yes : ?SNError        
                      (    DragonMMC.asm):00347                 
E0F0                  (    DragonMMC.asm):00348         FuncDOSOk               
E0F0 8EE179           (    DragonMMC.asm):00349                 LDX     #FunctionDipatchTable
E0F3 AD95             (    DragonMMC.asm):00350                 JSR     [B,X]
E0F5 7E8874           (    DragonMMC.asm):00351                         JMP             VarGetExprCC
                      (    DragonMMC.asm):00352         
E0F8                  (    DragonMMC.asm):00353         JumpToNextStubFn
                      (    DragonMMC.asm):00354         
                      (    DragonMMC.asm):00355                         ifdef   Dragon
E0F8 6E9F013C         (    DragonMMC.asm):00356                         JMP     [>DBasStub2+DStubFuncsJumpOfs]
                      (    DragonMMC.asm):00357                         else
                      (    DragonMMC.asm):00358                         JMP     [>CBasStub3+DStubFuncsJumpOfs]
                      (    DragonMMC.asm):00359                         endc
                      (    DragonMMC.asm):00360         
                      (    DragonMMC.asm):00361         ;
                      (    DragonMMC.asm):00362         ; New reset vector
                      (    DragonMMC.asm):00363         ;
                      (    DragonMMC.asm):00364         
E0FC                  (    DragonMMC.asm):00365         ResetVector   
E0FC 12               (    DragonMMC.asm):00366                         NOP                                                             ; Main ROM checks for reset->NOP
E0FD 4F               (    DragonMMC.asm):00367                 CLRA                                                    ; Reset DP=0
E0FE 1F8B             (    DragonMMC.asm):00368                 TFR     A,DP            
                      (    DragonMMC.asm):00369                         
                      (    DragonMMC.asm):00370                         ifdef   BuildDos
E100 BDC5B0           (    DragonMMC.asm):00371                         jsr             DOSResetVector                  ; Reset dos
                      (    DragonMMC.asm):00372                         endc
                      (    DragonMMC.asm):00373                         
                      (    DragonMMC.asm):00374         ;        LDA     #$35                                   ; Re-enable NMI
                      (    DragonMMC.asm):00375         ;        STA     PIA0CRB
                      (    DragonMMC.asm):00376                 
E103 7EB44F           (    DragonMMC.asm):00377                         JMP             WarmStart                               ; Jump back to Main ROM reset routine
                      (    DragonMMC.asm):00378         
E106                  (    DragonMMC.asm):00379         RamVarPointer   
                      (    DragonMMC.asm):00380         ; New basic dispatch stub
                      (    DragonMMC.asm):00381         ;
                      (    DragonMMC.asm):00382         ; The Dragon in an unexpanded state has both Colour basic an Extended colour basic
                      (    DragonMMC.asm):00383         ; in the same rom, and so only has one command table, so we put our commainds in
                      (    DragonMMC.asm):00384         ; the second stub.
                      (    DragonMMC.asm):00385         ; The CoCo has CB & ECB in seperate roms, and so already has two command tables
                      (    DragonMMC.asm):00386         ; therefore our commands must go in the third table.
                      (    DragonMMC.asm):00387         ;
E106 14               (    DragonMMC.asm):00388                 FCB     StubLen                                 ; No bytes
                      (    DragonMMC.asm):00389         
                      (    DragonMMC.asm):00390                         ifdef   Dragon
                      (    DragonMMC.asm):00391         ; Dragon
E107 012A             (    DragonMMC.asm):00392                 FDB     DBasStub1                               ; address to copy
                      (    DragonMMC.asm):00393                         else
                      (    DragonMMC.asm):00394         ;CoCo ECB only !                
                      (    DragonMMC.asm):00395                 FDB     CBasStub2                               ; address to copy
                      (    DragonMMC.asm):00396                         endc
                      (    DragonMMC.asm):00397         ;
                      (    DragonMMC.asm):00398         ; Stub for our new commands
                      (    DragonMMC.asm):00399         ;
                      (    DragonMMC.asm):00400         ; note NoCmds & No Funcs defined below....
E109                  (    DragonMMC.asm):00401         NewStub
E109 2D               (    DragonMMC.asm):00402                 FCB     NoCmds                                  ; No of commands
E10A E199             (    DragonMMC.asm):00403                 FDB     CmdNames                                ; command list
E10C E0B1             (    DragonMMC.asm):00404                 FDB     CmdDispatch                             ; command dispatch routine
E10E 10               (    DragonMMC.asm):00405                 FCB     NoFunc                                  ; No of functions
E10F E285             (    DragonMMC.asm):00406                 FDB     FuncNames                               ; function list
E111 E0D8             (    DragonMMC.asm):00407                 FDB     FuncDispatch                    ; function dispatch table
                      (    DragonMMC.asm):00408         
                      (    DragonMMC.asm):00409         ;
                      (    DragonMMC.asm):00410         ; New null terminating stub
                      (    DragonMMC.asm):00411         ;
E113 00               (    DragonMMC.asm):00412                 FCB     $00                                             ; No of commands
E114 0000             (    DragonMMC.asm):00413                 FDB     $0000                                   ; Null list
E116 89B4             (    DragonMMC.asm):00414                 FDB     BasSNError                              ; command dispatch 
E118 00               (    DragonMMC.asm):00415                 FCB     $00                                             ; no of functions
E119 0000             (    DragonMMC.asm):00416                 FDB     $0000                                   ; function dispatch
E11B 89B4             (    DragonMMC.asm):00417                 FDB     BasSNError
     0014             (    DragonMMC.asm):00418         StubLen EQU             (*-NewStub)
                      (    DragonMMC.asm):00419                
E11D 00               (    DragonMMC.asm):00420                 FCB     $00                                             ; No bytes : terminate copy table
E11E 00               (    DragonMMC.asm):00421                 FCB     $00
                      (    DragonMMC.asm):00422         
                      (    DragonMMC.asm):00423         ;
                      (    DragonMMC.asm):00424         ; Command routine pointers
                      (    DragonMMC.asm):00425         ; 
                      (    DragonMMC.asm):00426         
E11F                  (    DragonMMC.asm):00427         CommandDispatchTable
                      (    DragonMMC.asm):00428                         use             dos_cmd_addrs.asm
E11F                  (dos_cmd_addrs.asm):00001         DosCommandDispatchTable   
E11F D9A1             (dos_cmd_addrs.asm):00002                         FDB     CmdAuto
E121 C3F1             (dos_cmd_addrs.asm):00003                 FDB     CmdBackup
E123 DA62             (dos_cmd_addrs.asm):00004                 FDB     CmdBeep
E125 DAC8             (dos_cmd_addrs.asm):00005                 FDB     CmdBoot         ; Else, if dragondos, boot command 
E127 D47E             (dos_cmd_addrs.asm):00006                 FDB     CmdChain
E129 D1DD             (dos_cmd_addrs.asm):00007                 FDB     CmdCopy
E12B D5D0             (dos_cmd_addrs.asm):00008                 FDB     CmdCreate
E12D D8E0             (dos_cmd_addrs.asm):00009                 FDB     CmdDir
E12F DB01             (dos_cmd_addrs.asm):00010                 FDB     CmdDrive
E131 C2B3             (dos_cmd_addrs.asm):00011                 FDB     CmdDskInit
E133 D6A6             (dos_cmd_addrs.asm):00012                 FDB     CmdFRead
E135 D750             (dos_cmd_addrs.asm):00013                 FDB     CmdFWrite
E137 DB0D             (dos_cmd_addrs.asm):00014                 FDB     CmdError
E139 D61F             (dos_cmd_addrs.asm):00015                 FDB     CmdKill
E13B D352             (dos_cmd_addrs.asm):00016                 FDB     CmdLoad
E13D D290             (dos_cmd_addrs.asm):00017                 FDB     CmdMerge
E13F D62C             (dos_cmd_addrs.asm):00018                 FDB     CmdProtect
E141 DA86             (dos_cmd_addrs.asm):00019                 FDB     CmdWait
E143 D650             (dos_cmd_addrs.asm):00020                 FDB     CmdRename
E145 D3EA             (dos_cmd_addrs.asm):00021                 FDB     CmdSave
E147 DB3D             (dos_cmd_addrs.asm):00022                 FDB     CmdSread
E149 DB8C             (dos_cmd_addrs.asm):00023                 FDB     CmdSwrite
E14B DBFA             (dos_cmd_addrs.asm):00024                 FDB     CmdVerify
E14D 89B4             (dos_cmd_addrs.asm):00025                 FDB     BasSNError
E14F D672             (dos_cmd_addrs.asm):00026                 FDB     CmdFLRead
E151 DA9A             (dos_cmd_addrs.asm):00027                 FDB     CmdSwap
                      (dos_cmd_addrs.asm):00028         
                      (dos_cmd_addrs.asm):00029                         
                      (dos_cmd_addrs.asm):00030         ; Note no spaces must appear in the EQU below!
     001A             (dos_cmd_addrs.asm):00031         DosCMDTableLen          EQU     (*-DosCommandDispatchTable)/2
E153 E56E             (    DragonMMC.asm):00429                         FDB             CmdMCas 
E155 E4DA             (    DragonMMC.asm):00430                         FDB             CmdMMirror
E157 E407             (    DragonMMC.asm):00431                         FDB             CmdMMount
E159 E31D             (    DragonMMC.asm):00432                         FDB             CmdHelp
E15B E541             (    DragonMMC.asm):00433                         FDB             CmdRamBoot
E15D E5CD             (    DragonMMC.asm):00434                         FDB             CmdCat
E15F E6A1             (    DragonMMC.asm):00435                         FDB             CmdMDelete
E161 E6F8             (    DragonMMC.asm):00436                         FDB             CmdMSave
E163 E76E             (    DragonMMC.asm):00437                         FDB             CmdMLoad
E165 E8E5             (    DragonMMC.asm):00438                         FDB             CmdCartLoad
E167 E473             (    DragonMMC.asm):00439                         FDB             CmdTapeRun
E169 E63E             (    DragonMMC.asm):00440                         FDB             CmdCWD
E16B EC1C             (    DragonMMC.asm):00441                         FDB             CmdSetCFG
E16D E941             (    DragonMMC.asm):00442                         FDB             CmdReTok
E16F EAF6             (    DragonMMC.asm):00443                         FDB             CmdMDisk
E171 E4D0             (    DragonMMC.asm):00444                         FDB             CmdRewind
E173 EBE8             (    DragonMMC.asm):00445                 FDB     CmdSetDT
E175 E64F             (    DragonMMC.asm):00446                         FDB             CmdMKDir
E177 E6C2             (    DragonMMC.asm):00447                         FDB             CmdMFile
                      (    DragonMMC.asm):00448         
                      (    DragonMMC.asm):00449         ; Note no spaces must appear in the EQU below!
     002D             (    DragonMMC.asm):00450         CMDTableLen             EQU     (*-CommandDispatchTable)/2
                      (    DragonMMC.asm):00451         
                      (    DragonMMC.asm):00452         
E179                  (    DragonMMC.asm):00453         FunctionDipatchTable   
                      (    DragonMMC.asm):00454                         use             dos_func_addrs.asm
E179                  (os_func_addrs.asm):00001         DosFunctionDipatchTable   
E179 DC4C             (os_func_addrs.asm):00002                         FDB     FuncLof
E17B DC67             (os_func_addrs.asm):00003                 FDB     FuncFree
E17D DC7F             (os_func_addrs.asm):00004                 FDB     FuncErl
E17F DC85             (os_func_addrs.asm):00005                 FDB     FuncErr
E181 DC8B             (os_func_addrs.asm):00006                 FDB     FuncHimem
E183 DC3E             (os_func_addrs.asm):00007                 FDB     FuncLoc
E185 DC8F             (os_func_addrs.asm):00008                         FDB     FuncFres
                      (os_func_addrs.asm):00009         
                      (os_func_addrs.asm):00010                         
                      (os_func_addrs.asm):00011         ; Note no spaces must appear in the EQU below!
     0007             (os_func_addrs.asm):00012         DosFuncTableLen         EQU     (*-DosFunctionDipatchTable)/2
E187 8B8D             (    DragonMMC.asm):00455                         FDB     BasFCError
E189 E65D             (    DragonMMC.asm):00456                 FDB             FuncCWD
E18B E68E             (    DragonMMC.asm):00457                         FDB             FuncFindFirst
E18D E690             (    DragonMMC.asm):00458                         FDB             FuncFindNext
E18F E435             (    DragonMMC.asm):00459                         FDB             FuncCFType
E191 EC53             (    DragonMMC.asm):00460                         FDB             FUNCGetCFG
E193 EBED             (    DragonMMC.asm):00461                 FDB     FuncGetDT
E195 EBAB             (    DragonMMC.asm):00462                 FDB     FuncGetIName
E197 E659             (    DragonMMC.asm):00463                 FDB             FuncGetSnapDir
                      (    DragonMMC.asm):00464                         
                      (    DragonMMC.asm):00465         ; Note no spaces must appear in the EQU below!
     0010             (    DragonMMC.asm):00466         FuncTableLen    EQU     (*-FunctionDipatchTable)/2
                      (    DragonMMC.asm):00467                 
E199                  (    DragonMMC.asm):00468         CmdNames   
                      (    DragonMMC.asm):00469                         use             dos_cmd_names.asm
E199                  (dos_cmd_names.asm):00001         DosCmdNames   
E199 415554CF         (dos_cmd_names.asm):00002                         FCS     /AUTO/
E19D 4241434B55D0     (dos_cmd_names.asm):00003                 FCS     /BACKUP/
E1A3 424545D0         (dos_cmd_names.asm):00004                 FCS     /BEEP/
E1A7 424F4FD4         (dos_cmd_names.asm):00005                 FCS     /BOOT/
E1AB 43484149CE       (dos_cmd_names.asm):00006                 FCS     /CHAIN/
E1B0 434F50D9         (dos_cmd_names.asm):00007                 FCS     /COPY/
E1B4 4352454154C5     (dos_cmd_names.asm):00008                 FCS     /CREATE/
E1BA 4449D2           (dos_cmd_names.asm):00009                 FCS     /DIR/
E1BD 44524956C5       (dos_cmd_names.asm):00010                 FCS     /DRIVE/
E1C2 44534B494E49D4   (dos_cmd_names.asm):00011                 FCS     /DSKINIT/
E1C9 46524541C4       (dos_cmd_names.asm):00012                 FCS     /FREAD/
E1CE 4657524954C5     (dos_cmd_names.asm):00013                 FCS     /FWRITE/
E1D4 4552524FD2       (dos_cmd_names.asm):00014                 FCS     /ERROR/
E1D9 4B494CCC         (dos_cmd_names.asm):00015                 FCS     /KILL/
E1DD 4C4F41C4         (dos_cmd_names.asm):00016                 FCS     /LOAD/
E1E1 4D455247C5       (dos_cmd_names.asm):00017                 FCS     /MERGE/
E1E6 50524F544543D4   (dos_cmd_names.asm):00018                 FCS     /PROTECT/
E1ED 574149D4         (dos_cmd_names.asm):00019                 FCS     /WAIT/
E1F1 52454E414DC5     (dos_cmd_names.asm):00020                 FCS     /RENAME/
E1F7 534156C5         (dos_cmd_names.asm):00021                 FCS     /SAVE/
E1FB 53524541C4       (dos_cmd_names.asm):00022                 FCS     /SREAD/
E200 5357524954C5     (dos_cmd_names.asm):00023                 FCS     /SWRITE/
E206 5645524946D9     (dos_cmd_names.asm):00024                 FCS     /VERIFY/
E20C 46524FCD         (dos_cmd_names.asm):00025                 FCS     /FROM/
E210 464C524541C4     (dos_cmd_names.asm):00026                 FCS     /FLREAD/
E216 535741D0         (dos_cmd_names.asm):00027                 FCS     /SWAP/
                      (    DragonMMC.asm):00470         
E21A 4D4341D3         (    DragonMMC.asm):00471                         FCS             /MCAS/
E21E 4D4D4952524FD2   (    DragonMMC.asm):00472                         FCS             /MMIRROR/
E225 4D4D4F554ED4     (    DragonMMC.asm):00473                         FCS             /MMOUNT/
E22B 48454CD0         (    DragonMMC.asm):00474                         FCS             /HELP/
E22F 52414D424F4FD4   (    DragonMMC.asm):00475                         FCS             /RAMBOOT/
E236 4341D4           (    DragonMMC.asm):00476                         FCS             /CAT/
E239 4D44454C4554C5   (    DragonMMC.asm):00477                         FCS             /MDELETE/
E240 4D534156C5       (    DragonMMC.asm):00478                         FCS             /MSAVE/
E245 4D4C4F41C4       (    DragonMMC.asm):00479                         FCS             /MLOAD/
E24A 4D434152544C4F41 (    DragonMMC.asm):00480                         FCS             /MCARTLOAD/
     C4
E253 4D544150455255CE (    DragonMMC.asm):00481                         FCS             /MTAPERUN/
E25B 4357C4           (    DragonMMC.asm):00482                         FCS             /CWD/
E25E 4D5345544346C7   (    DragonMMC.asm):00483                         FCS             /MSETCFG/
E265 5245544FCB       (    DragonMMC.asm):00484                         FCS             /RETOK/
E26A 4D444953CB       (    DragonMMC.asm):00485                         FCS             /MDISK/
E26F 524557494EC4     (    DragonMMC.asm):00486                         FCS             /REWIND/
E275 4D53455444D4     (    DragonMMC.asm):00487                 FCS     /MSETDT/
E27B 4D4B4449D2       (    DragonMMC.asm):00488                         FCS             /MKDIR/
E280 4D46494CC5       (    DragonMMC.asm):00489                         FCS             /MFILE/
                      (    DragonMMC.asm):00490                         
E285                  (    DragonMMC.asm):00491         FuncNames   
                      (    DragonMMC.asm):00492                         use             dos_func_names.asm
                      (os_func_names.asm):00001         ;
                      (os_func_names.asm):00002         ; New Function names table
                      (os_func_names.asm):00003         ;
                      (os_func_names.asm):00004                 
E285                  (os_func_names.asm):00005         DosFuncNames   
E285 4C4FC6           (os_func_names.asm):00006                         FCS     /LOF/
E288 465245C5         (os_func_names.asm):00007                 FCS     /FREE/
E28C 4552CC           (os_func_names.asm):00008                 FCS     /ERL/
E28F 4552D2           (os_func_names.asm):00009                 FCS     /ERR/
E292 48494D45CD       (os_func_names.asm):00010                 FCS     /HIMEM/
E297 4C4FC3           (os_func_names.asm):00011                 FCS     /LOC/
E29A 465245A4         (os_func_names.asm):00012                 FCS     /FRE$/
                      (os_func_names.asm):00013                         
                      (    DragonMMC.asm):00493                         
E29E 5645D2           (    DragonMMC.asm):00494                         FCS             /VER/
E2A1 5744A4           (    DragonMMC.asm):00495                         FCS             /WD$/
E2A4 46494E4446495253 (    DragonMMC.asm):00496                         FCS             /FINDFIRST$/
     54A4
E2AE 46494E444E455854 (    DragonMMC.asm):00497                         FCS             /FINDNEXT$/
     A4
E2B7 4346545950C5     (    DragonMMC.asm):00498                         FCS             /CFTYPE/
E2BD 4D4745544346C7   (    DragonMMC.asm):00499                         FCS             /MGETCFG/
E2C4 4D4745544454A4   (    DragonMMC.asm):00500                 FCS     /MGETDT$/
E2CB 4D474554494E414D (    DragonMMC.asm):00501                 FCS     /MGETINAME$/
     45A4
E2D5 5344A4           (    DragonMMC.asm):00502                 FCS             /SD$/
                      (    DragonMMC.asm):00503         
     002D             (    DragonMMC.asm):00504         NoCmds  EQU             CMDTableLen
     0010             (    DragonMMC.asm):00505         NoFunc  EQU     FuncTableLen
                      (    DragonMMC.asm):00506         
                      (    DragonMMC.asm):00507         ;
                      (    DragonMMC.asm):00508         ; Get string from command into temp var.
                      (    DragonMMC.asm):00509         ; Exits :
                      (    DragonMMC.asm):00510         ;       x = pointer to string data
                      (    DragonMMC.asm):00511         ;       b = length of string
                      (    DragonMMC.asm):00512         ;
                      (    DragonMMC.asm):00513         
E2D8                  (    DragonMMC.asm):00514         GetCmdStrXB
E2D8 BD8887           (    DragonMMC.asm):00515                 JSR     >VarGetStr                              ; get string into temp variable
E2DB BD8D9A           (    DragonMMC.asm):00516                         JSR             >BasGetStrLenAddr               ; Get pointer in x len in b
E2DE 39               (    DragonMMC.asm):00517                         rts
                      (    DragonMMC.asm):00518         
                      (    DragonMMC.asm):00519         ;
                      (    DragonMMC.asm):00520         ; Get a filename and send to MMC
                      (    DragonMMC.asm):00521         ;
                      (    DragonMMC.asm):00522         
E2DF                  (    DragonMMC.asm):00523         GetSendFileName
E2DF 8DF7             (    DragonMMC.asm):00524                         bsr             GetCmdStrXB                             ; Get string from basic
                      (    DragonMMC.asm):00525         
E2E1 170A0F           (    DragonMMC.asm):00526                         lbsr    MMC_SendName                    ; Send name to MMC
E2E4 39               (    DragonMMC.asm):00527                         rts
                      (    DragonMMC.asm):00528         
E2E5                  (    DragonMMC.asm):00529         GetSendFileName2
E2E5 8DF1             (    DragonMMC.asm):00530                         bsr             GetCmdStrXB                             ; Get string from basic
                      (    DragonMMC.asm):00531         
E2E7 170A0B           (    DragonMMC.asm):00532                         lbsr    MMC_SendName2                   ; Send name to MMC
E2EA 39               (    DragonMMC.asm):00533                         rts
                      (    DragonMMC.asm):00534                         
                      (    DragonMMC.asm):00535         ;
                      (    DragonMMC.asm):00536         ; Get a filename and send to MMC folowed by command in a
                      (    DragonMMC.asm):00537         ;
                      (    DragonMMC.asm):00538                         
E2EB                  (    DragonMMC.asm):00539         CmdSendFilenameCmd
E2EB                  (    DragonMMC.asm):00540         CmdSendStringCmd
E2EB 3402             (    DragonMMC.asm):00541                         pshs    a
E2ED 8DF0             (    DragonMMC.asm):00542                         bsr             GetSendFileName                 ; get filename and send it
                      (    DragonMMC.asm):00543                         
E2EF 3502             (    DragonMMC.asm):00544                         puls    a                                               ; Restore read or write
E2F1 17FD1A           (    DragonMMC.asm):00545                         lbsr    MMC_SendCmd                             ; Open file
E2F4 170016           (    DragonMMC.asm):00546                         lbsr    CheckError                              ; Bomb out on error
                      (    DragonMMC.asm):00547                         
E2F7 4F               (    DragonMMC.asm):00548                         clra
E2F8 39               (    DragonMMC.asm):00549                         rts
                      (    DragonMMC.asm):00550         
E2F9                  (    DragonMMC.asm):00551         CkComma
E2F9 3404             (    DragonMMC.asm):00552                         pshs    b                                               ; save b
E2FB C62C             (    DragonMMC.asm):00553                         ldb             #Comma                                  ; comma character
E2FD E19F00A6         (    DragonMMC.asm):00554                         cmpb    [BasAddrSigByte]                
E301 3584             (    DragonMMC.asm):00555                         puls    b,pc                                    ; flags untouched
                      (    DragonMMC.asm):00556         
E303                  (    DragonMMC.asm):00557         CkOpenBrac
E303 3404             (    DragonMMC.asm):00558                         pshs    b                                               ; save b
E305 C628             (    DragonMMC.asm):00559                         ldb             #OpenBrac                               ; comma character
E307 E19F00A6         (    DragonMMC.asm):00560                         cmpb    [BasAddrSigByte]                
E30B 3584             (    DragonMMC.asm):00561                         puls    b,pc                                    ; flags untouched
                      (    DragonMMC.asm):00562                         
E30D                  (    DragonMMC.asm):00563         CheckError
E30D 4D               (    DragonMMC.asm):00564                         tsta                                                    ; Test for error, if bit 7 set
E30E 2B01             (    DragonMMC.asm):00565                         bmi             ReportError                             ; Yes : error
E310 39               (    DragonMMC.asm):00566                         rts
                      (    DragonMMC.asm):00567         
E311                  (    DragonMMC.asm):00568         ReportError     
E311 2601             (    DragonMMC.asm):00569                         bne             FlagError                               ; Yes : flag it
E313 39               (    DragonMMC.asm):00570                         rts
                      (    DragonMMC.asm):00571                 
E314                  (    DragonMMC.asm):00572         FlagError
E314 170BEB           (    DragonMMC.asm):00573                         lbsr    CON_WriteHexByte                ; Write to screen as hex
E317 170C76           (    DragonMMC.asm):00574                         lbsr    CON_EOL
E31A 7E8B8D           (    DragonMMC.asm):00575                         jmp             BasFCError
                      (    DragonMMC.asm):00576                 
                      (    DragonMMC.asm):00577         
E31D                  (    DragonMMC.asm):00578         CmdHelp 
E31D 8158             (    DragonMMC.asm):00579                 cmpa    #'X'                    ; helpx ?
E31F 2606             (    DragonMMC.asm):00580                 bne     CmdHelpNoX              ; no skip
                      (    DragonMMC.asm):00581                 
E321 9D9F             (    DragonMMC.asm):00582                 jsr             <BasChrGet                              ; skip first char       
E323 86FF             (    DragonMMC.asm):00583                 lda     #$FF                    ; flag extended.
E325 2001             (    DragonMMC.asm):00584                 bra     CmdHelpMain             ; skip forward
                      (    DragonMMC.asm):00585                 
E327                  (    DragonMMC.asm):00586         CmdHelpNoX
E327 4F               (    DragonMMC.asm):00587                 clra                            ; Flag normal
E328                  (    DragonMMC.asm):00588         CmdHelpMain
E328 3402             (    DragonMMC.asm):00589                 pshs    a
                      (    DragonMMC.asm):00590                 
E32A 8EE37C           (    DragonMMC.asm):00591                 ldx     #SignonMess-1               ; Print signon message including compile date
E32D BD90E5           (    DragonMMC.asm):00592                 JSR     >TextOutString
                      (    DragonMMC.asm):00593                 
E330 8EE39D           (    DragonMMC.asm):00594                 LDX     #CompileDate-1          ; show compile date
E333 BD90E5           (    DragonMMC.asm):00595                 JSR     >TextOutString      
                      (    DragonMMC.asm):00596                         
E336 8EE3C2           (    DragonMMC.asm):00597                         ldx         #IFVerMess-1                        ; print IF ver message
E339 BD90E5           (    DragonMMC.asm):00598                         JSR     >TextOutString
                      (    DragonMMC.asm):00599                         
E33C 86E0             (    DragonMMC.asm):00600                         lda             #CMD_GET_FW_VER                 ; Get firmware version
E33E BDE028           (    DragonMMC.asm):00601                         jsr         >MMC_SendCmdLatchRead       ; send command get version                      
E341 BDEFB5           (    DragonMMC.asm):00602                         jsr         >CON_NdotN                          ; Write msn.lsn
                      (    DragonMMC.asm):00603                                 
E344 BDEF90           (    DragonMMC.asm):00604                 jsr         >CON_EOL
                      (    DragonMMC.asm):00605                         
E347 3502             (    DragonMMC.asm):00606                 puls    a                       ; retrieve flag
E349 4D               (    DragonMMC.asm):00607                 tsta                            ; Check it
E34A 2708             (    DragonMMC.asm):00608                 beq     CmdHelpLoopExit         ; Not extended : exit
                      (    DragonMMC.asm):00609                 
                      (    DragonMMC.asm):00610         ; HelpX, also display AVR firmware & Bootloader compile dates.
                      (    DragonMMC.asm):00611                 
E34C 86E0             (    DragonMMC.asm):00612                 lda             #CMD_GET_FW_VER                 ; Get firmware version
E34E 8D06             (    DragonMMC.asm):00613                         bsr     CmdGetSend64            ; send command display string
                      (    DragonMMC.asm):00614                         
E350 86E1             (    DragonMMC.asm):00615                 lda             #CMD_GET_BL_VER                 ; Get bootloader version
E352 8D02             (    DragonMMC.asm):00616                         bsr     CmdGetSend64            ; send command display string
                      (    DragonMMC.asm):00617                                 
E354                  (    DragonMMC.asm):00618         CmdHelpLoopExit
E354 4F               (    DragonMMC.asm):00619                         clra
E355 39               (    DragonMMC.asm):00620                         rts
                      (    DragonMMC.asm):00621         
E356                  (    DragonMMC.asm):00622         CmdGetSend64
E356 BDE00E           (    DragonMMC.asm):00623                 jsr         >MMC_SendCmd                        ; send the command
                      (    DragonMMC.asm):00624         
E359 8620             (    DragonMMC.asm):00625                         lda     #CMD_INIT_READ                  ; Read compile message
E35B BDE017           (    DragonMMC.asm):00626                         jsr         >MMC_SendCmdRaw                     
                      (    DragonMMC.asm):00627                 
E35E C640             (    DragonMMC.asm):00628                         ldb             #64                                             ; 64 chars max.
                      (    DragonMMC.asm):00629         
E360                  (    DragonMMC.asm):00630         GetSendBBytes
E360 BDED16           (    DragonMMC.asm):00631                         jsr         >MMC_WaitGetWritten         ; Wait for byte
                      (    DragonMMC.asm):00632                         
E363 4D               (    DragonMMC.asm):00633                         tsta                                                    ; test a
E364 2706             (    DragonMMC.asm):00634                         beq             GetSendBBytesExit               ; Zero : exit loop
                      (    DragonMMC.asm):00635                         
E366 BD800C           (    DragonMMC.asm):00636                         jsr             >BasicScreenOut                 ; output character
                      (    DragonMMC.asm):00637                         
E369 5A               (    DragonMMC.asm):00638                         decb                                                    ; decrement character count
E36A 26F4             (    DragonMMC.asm):00639                         bne             GetSendBBytes                   ; loop if more
                      (    DragonMMC.asm):00640                         
E36C                  (    DragonMMC.asm):00641         GetSendBBytesExit
E36C 7EEF90           (    DragonMMC.asm):00642                         jmp             >CON_EOL                                ; newline & return
                      (    DragonMMC.asm):00643         
                      (    DragonMMC.asm):00644         ;
                      (    DragonMMC.asm):00645         ; Detect Dragon or CoCo, returns cc.z = 1 if Dragon 
                      (    DragonMMC.asm):00646         ;
                      (    DragonMMC.asm):00647                         
E36F                  (    DragonMMC.asm):00648         MachineDetect
E36F 8EB4BC           (    DragonMMC.asm):00649                         ldx     #$B4BC                  ; Dragon ROM contains the word DRAGON at $B4BC.
E372 EC81             (    DragonMMC.asm):00650                 ldd             ,x++                                    ; looks for 'DRAGON' string 
E374 E381             (    DragonMMC.asm):00651                         addd    ,x++
E376 E381             (    DragonMMC.asm):00652                         addd    ,x++
E378 1083D4E7         (    DragonMMC.asm):00653                         cmpd    #$D4E7                                  ; Sum of the letters of 'DR' + 'AG' + 'ON'
E37C 39               (    DragonMMC.asm):00654                         rts
                      (    DragonMMC.asm):00655         
E37D                  (    DragonMMC.asm):00656         __main_end
                      (    DragonMMC.asm):00657         
                      (    DragonMMC.asm):00658         ; Messages
                      (    DragonMMC.asm):00659                         use             message.asm
                      (      message.asm):00001         ;
                      (      message.asm):00002         ; Message.asm : text messages.
                      (      message.asm):00003         ;
                      (      message.asm):00004         
E37D                  (      message.asm):00005         __message
                      (      message.asm):00006         
                      (      message.asm):00007                 ifne    0
E37D                  (      message.asm):00008         MessPressAnyKey   
                      (      message.asm):00009                         FCB     $00
                      (      message.asm):00010                 FCC     /PRESS ANY KEY     /
                      (      message.asm):00011                 FCB     $0D
                      (      message.asm):00012                 FCB     $00
                      (      message.asm):00013                 endc
                      (      message.asm):00014         
E37D                  (      message.asm):00015         SignonMess      
                      (      message.asm):00016                 IFdef   Dragon
E37D 445241474F4E     (      message.asm):00017                 FCC     /DRAGON/
                      (      message.asm):00018                 ELSE
                      (      message.asm):00019                 FCC     /COCO/
                      (      message.asm):00020                 ENDC
                      (      message.asm):00021                 
E383 205049434F2D5344 (      message.asm):00022                 FCC     / PICO-SD V1.00 BETA/
     2056312E30302042
     455441
                      (      message.asm):00023                 
                      (      message.asm):00024                 IFGT DEVEL
E396 2D646576656C     (      message.asm):00025                 FCC     /-devel/
                      (      message.asm):00026                 ENDC
                      (      message.asm):00027                 
E39C 0D               (      message.asm):00028                 FCB     $0D
E39D 00               (      message.asm):00029                 FCB     $00
E39E                  (      message.asm):00030         CompileDate        
E39E 434F4D50494C4544 (      message.asm):00031                 FCC     /COMPILED: /
     3A20
                      (      message.asm):00032                 use     datetime.asm
E3A8 323032352D31312D (     datetime.asm):00001          FCC "2025-11-09 14:28:35"
     30392031343A3238
     3A3335
                      (      message.asm):00033                 
E3BB 0D               (      message.asm):00034                 FCB     $0D
E3BC 00               (      message.asm):00035                 FCB     $00
                      (      message.asm):00036         
E3BD                  (      message.asm):00037         RTCMess 
E3BD 5254433A20       (      message.asm):00038                 FCC     /RTC: /
E3C2 00               (      message.asm):00039                 FCB     $00
                      (      message.asm):00040                 
                      (      message.asm):00041         ;                01234567890123456789012345678901
                      (      message.asm):00042         ;               '1234 12 12 1234 1234 1234 12 12
E3C3                  (      message.asm):00043         IFVerMess
E3C3 5049434F20465720 (      message.asm):00044                 FCC     'PICO FW V' 
     56
E3CC 00               (      message.asm):00045                 FCB     $00
                      (      message.asm):00046         
                      (      message.asm):00047         ;BLVerMess       
                      (      message.asm):00048         ;       FCC     'BLD FW V'
                      (      message.asm):00049         ;       FCB     $00
                      (      message.asm):00050         
E3CD                  (      message.asm):00051         DeleteMess
E3CD 41524520594F5520 (      message.asm):00052                 FCC     'ARE YOU SURE (Y/N)'
     535552452028592F
     4E29
E3DF 00               (      message.asm):00053                 FCB     $00
                      (      message.asm):00054                         
E3E0                  (      message.asm):00055         MoreMess
E3E0 4D4F52453A       (      message.asm):00056                 FCC     'MORE:'
E3E5 00               (      message.asm):00057                 FCB     $00
                      (      message.asm):00058         ;                01234567890123456789012345678901
                      (      message.asm):00059         ;               '1234 12 12 1234 1234 1234 12 12
E3E6                  (      message.asm):00060         RegNames
E3E6 2050432020204120 (      message.asm):00061                 FCC     ' PC   A  B  X    Y    U   DP CC'
     2042202058202020
     2059202020205520
     20204450204343
E405 0D00             (      message.asm):00062                 FCB     $0D,$00
                      (      message.asm):00063         
                      (      message.asm):00064                 ifne    0
E407                  (      message.asm):00065         CROKMess
                      (      message.asm):00066                 FCB     $0D
E407                  (      message.asm):00067         OKMess
                      (      message.asm):00068                 FCC     'OK'
                      (      message.asm):00069                 FCB     $0D,$00
                      (      message.asm):00070                 endc
                      (      message.asm):00071                         
                      (      message.asm):00072                         
E407                  (      message.asm):00073         __message_end
                      (      message.asm):00074                 
                      (      message.asm):00075                 
                      (    DragonMMC.asm):00660                 
                      (    DragonMMC.asm):00661         ; Command includes
                      (    DragonMMC.asm):00662                         use             cmds_tape.asm
                      (    cmds_tape.asm):00001         ;
                      (    cmds_tape.asm):00002         ; cmds_tape.asm : Cassette emulation commands.
                      (    cmds_tape.asm):00003         ;
                      (    cmds_tape.asm):00004         
E407                  (    cmds_tape.asm):00005         __cmd_tape
                      (    cmds_tape.asm):00006         
                      (    cmds_tape.asm):00007         ;
                      (    cmds_tape.asm):00008         ; Note some routines make calls / returns into the Dragon and CoCo roms.
                      (    cmds_tape.asm):00009         ; Please remember to define them so they assemble correctly on *BOTH* 
                      (    cmds_tape.asm):00010         ; machines.
                      (    cmds_tape.asm):00011         ; 
                      (    cmds_tape.asm):00012                         ifdef   Dragon
     A095             (    cmds_tape.asm):00013         CloadMEntry             EQU             $A095
     B6E1             (    cmds_tape.asm):00014         CloadEntry              EQU             $B6E1
     8424             (    cmds_tape.asm):00015         ClearEntry              EQU             $8424
     B663             (    cmds_tape.asm):00016         CloseFilesEntry EQU             $B663
     849F             (    cmds_tape.asm):00017         BasicLoop               EQU             $849F
                      (    cmds_tape.asm):00018                         else
E407                  (    cmds_tape.asm):00019         CloadMEntry             EQU             $A502
E407                  (    cmds_tape.asm):00020         CloadEntry              EQU             $A4A3
E407                  (    cmds_tape.asm):00021         ClearEntry              EQU             $AE6F
E407                  (    cmds_tape.asm):00022         CloseFilesEntry EQU             $A42D
E407                  (    cmds_tape.asm):00023         BasicLoop               EQU             $AD9E
                      (    cmds_tape.asm):00024                         endc
                      (    cmds_tape.asm):00025                 
     00A8             (    cmds_tape.asm):00026         ScannerExit     EQU     $00A8    
                      (    cmds_tape.asm):00027         
                      (    cmds_tape.asm):00028         
     0000             (    cmds_tape.asm):00029         FTBasic equ             0
     0002             (    cmds_tape.asm):00030         FTCode  equ             2
                      (    cmds_tape.asm):00031         
                      (    cmds_tape.asm):00032         
E407                  (    cmds_tape.asm):00033         CmdMMount
E407 1F89             (    cmds_tape.asm):00034                         tfr             a,b                                             ; keep current next char
E409 9D9F             (    cmds_tape.asm):00035                         jsr             <BasChrGet                              ; skip first char       
                      (    cmds_tape.asm):00036                 
E40B C152             (    cmds_tape.asm):00037                         cmpb    #'R'                                    ; MMountR ?
E40D 270B             (    cmds_tape.asm):00038                         beq             CmdMRMount                              ; Yep insert, read only
                      (    cmds_tape.asm):00039                 
E40F C157             (    cmds_tape.asm):00040                         cmpb    #'W'                                    ; MMountW ?
E411 2711             (    cmds_tape.asm):00041                         beq             CmdMWMount                              ; Yep insert, write only
                      (    cmds_tape.asm):00042                 
E413 C143             (    cmds_tape.asm):00043                         cmpb    #'C'                                    ; MMountC ?
E415 2716             (    cmds_tape.asm):00044                         beq             CmdMUNMount                             ; Yep, unmount
                      (    cmds_tape.asm):00045                 
E417 7E89B4           (    cmds_tape.asm):00046                         jmp             >BasSNError                             ; no : ?SN Error
                      (    cmds_tape.asm):00047                         
                      (    cmds_tape.asm):00048         ;
                      (    cmds_tape.asm):00049         ; Mount a cas file for input.
                      (    cmds_tape.asm):00050         ;
                      (    cmds_tape.asm):00051         ; syntax :
                      (    cmds_tape.asm):00052         ;       mrmount "filename"
                      (    cmds_tape.asm):00053         ;
                      (    cmds_tape.asm):00054         
E41A                  (    cmds_tape.asm):00055         CmdMRMount
E41A                  (    cmds_tape.asm):00056         CmdMRMountEntry 
E41A 8600             (    cmds_tape.asm):00057                         lda             #CAS_FILE                               ; open default file
E41C 17FC02           (    cmds_tape.asm):00058                         lbsr    MMC_WaitPutLatchRead    ; send file id to latch register
                      (    cmds_tape.asm):00059         
E41F 8611             (    cmds_tape.asm):00060                         lda             #CMD_FILE_OPEN_READ             ; Open file
                      (    cmds_tape.asm):00061                         
E421                  (    cmds_tape.asm):00062         CmdMMountCommon
E421 16FEC7           (    cmds_tape.asm):00063                         lbra    CmdSendFilenameCmd
                      (    cmds_tape.asm):00064         
                      (    cmds_tape.asm):00065         ;
                      (    cmds_tape.asm):00066         ; Mount a cas file for output.
                      (    cmds_tape.asm):00067         ;
                      (    cmds_tape.asm):00068         ; syntax :
                      (    cmds_tape.asm):00069         ;       mwmount "filename"
                      (    cmds_tape.asm):00070         ;
                      (    cmds_tape.asm):00071         
E424                  (    cmds_tape.asm):00072         CmdMWMount
E424 8600             (    cmds_tape.asm):00073                         lda             #CAS_FILE                               ; open default file
E426 17FBF8           (    cmds_tape.asm):00074                         lbsr    MMC_WaitPutLatchRead    ; send file id to latch register
                      (    cmds_tape.asm):00075         
E429 8613             (    cmds_tape.asm):00076                         lda             #CMD_FILE_OPEN_WRITE    ; Open file
E42B 20F4             (    cmds_tape.asm):00077                         bra             CmdMMountCommon                 ; rest same as rmount
                      (    cmds_tape.asm):00078         
                      (    cmds_tape.asm):00079         ;
                      (    cmds_tape.asm):00080         ; Unmount a cas file, closing it and flushing any output.
                      (    cmds_tape.asm):00081         ;
                      (    cmds_tape.asm):00082         
E42D                  (    cmds_tape.asm):00083         CmdMUNMount
                      (    cmds_tape.asm):00084         ;               jsr             <BasChrGet                              ; skip first char               
E42D 1708EC           (    cmds_tape.asm):00085                         lbsr    MMC_CloseFile                   ; Close tape file
E430 17FEDA           (    cmds_tape.asm):00086                         lbsr    CheckError                              ; Check for error
E433 4F               (    cmds_tape.asm):00087                         clra                                                    
E434 39               (    cmds_tape.asm):00088                         rts
                      (    cmds_tape.asm):00089         
                      (    cmds_tape.asm):00090         ;
                      (    cmds_tape.asm):00091         ; Get the filetype of the next file on (emulated) tape
                      (    cmds_tape.asm):00092         ; 
                      (    cmds_tape.asm):00093         ; Syntax :
                      (    cmds_tape.asm):00094         ;       X=CFTYPE
                      (    cmds_tape.asm):00095         
                      (    cmds_tape.asm):00096         
E435                  (    cmds_tape.asm):00097         FuncCFType
E435 8145             (    cmds_tape.asm):00098                 cmpa    #'E'                    ; Exec: get exec address
E437 271C             (    cmds_tape.asm):00099                 beq     GetCFExecD
                      (    cmds_tape.asm):00100                 
E439 814C             (    cmds_tape.asm):00101                 cmpa    #'L'                    ; Load, get load address
E43B 271C             (    cmds_tape.asm):00102                 beq     GetCFLoadD
                      (    cmds_tape.asm):00103                 
E43D 8D05             (    cmds_tape.asm):00104                         bsr             GetCFTypeA                              ; get cas filetype in A
                      (    cmds_tape.asm):00105         
E43F 1F89             (    cmds_tape.asm):00106                         tfr             a,b                                             ; move to b     
E441 7E8C36           (    cmds_tape.asm):00107                         jmp             VarAssign8Bit                   ; return it to basic
                      (    cmds_tape.asm):00108         
                      (    cmds_tape.asm):00109         
E444                  (    cmds_tape.asm):00110         GetCFTypeA
E444 8650             (    cmds_tape.asm):00111                         lda             #CMD_CAS_FTYPE                  ; Get file type
E446 17FBC5           (    cmds_tape.asm):00112                         lbsr    MMC_SendCmd                             
E449 17FEC1           (    cmds_tape.asm):00113                         lbsr    CheckError                              ; Bomb out on error
                      (    cmds_tape.asm):00114                         
E44C 8620             (    cmds_tape.asm):00115                         lda             #CMD_INIT_READ                  ; init read
E44E 17FBC6           (    cmds_tape.asm):00116                         lbsr    MMC_SendCmdRaw
E451 1708C2           (    cmds_tape.asm):00117                         lbsr    MMC_WaitGetWritten              ; Wait for byte, and get it in a
E454 39               (    cmds_tape.asm):00118                         rts
                      (    cmds_tape.asm):00119         
                      (    cmds_tape.asm):00120         ;CFTypeE
                      (    cmds_tape.asm):00121         ;        bsr     GetCFExecD                  ; Get exec address
                      (    cmds_tape.asm):00122         ;        jmp     VarAssign16Bit2             ; assign it and return
                      (    cmds_tape.asm):00123         ;        
                      (    cmds_tape.asm):00124         ;        
                      (    cmds_tape.asm):00125         ;CFTypeL      
                      (    cmds_tape.asm):00126         ;        bsr     GetCFLoadD                  ; get load address
                      (    cmds_tape.asm):00127                 
                      (    cmds_tape.asm):00128         ;
                      (    cmds_tape.asm):00129         ; Get exec address for next cassette file in D
                      (    cmds_tape.asm):00130         ;
E455                  (    cmds_tape.asm):00131         GetCFExecD      
E455 C60E             (    cmds_tape.asm):00132                 ldb     #14                     ; Exec address offset
E457 2002             (    cmds_tape.asm):00133                 bra     GetFC16
                      (    cmds_tape.asm):00134         ;
                      (    cmds_tape.asm):00135         ; Get load address for next cassette file in D
                      (    cmds_tape.asm):00136         ;
                      (    cmds_tape.asm):00137         
E459                  (    cmds_tape.asm):00138         GetCFLoadD      
E459 C610             (    cmds_tape.asm):00139                 ldb     #16                     ; Load address is 15 bytes in
                      (    cmds_tape.asm):00140         
E45B                  (    cmds_tape.asm):00141         GetFC16
E45B 9D9F             (    cmds_tape.asm):00142                 jsr     <BasChrGet                              ; skip first char, B un affected        
E45D 8DE5             (    cmds_tape.asm):00143                 bsr     GetCFTypeA              ; Get filetype, header block in AVR buffer
                      (    cmds_tape.asm):00144         
E45F                  (    cmds_tape.asm):00145         GetCFLoadDLoop        
E45F 1708B4           (    cmds_tape.asm):00146                 lbsr    MMC_WaitGetWritten      ; get a byte
E462 5A               (    cmds_tape.asm):00147                 decb                            ; decrement count
E463 26FA             (    cmds_tape.asm):00148                 bne     GetCFLoadDLoop          ; Keep going until at right place
                      (    cmds_tape.asm):00149                 
E465 1F89             (    cmds_tape.asm):00150                 tfr     a,b                     ; get msb
E467 1708AC           (    cmds_tape.asm):00151                 lbsr    MMC_WaitGetWritten      ; get second byte of Load address
                      (    cmds_tape.asm):00152                 
E46A 1E89             (    cmds_tape.asm):00153                 exg     a,b        
                      (    cmds_tape.asm):00154         
                      (    cmds_tape.asm):00155         ;
                      (    cmds_tape.asm):00156         ; Assign an unsigned 16 bit value from the D register
                      (    cmds_tape.asm):00157         ; call as you would VarAssign16Bit or VarAssign16Bit2
                      (    cmds_tape.asm):00158         ;
                      (    cmds_tape.asm):00159         
E46C                  (    cmds_tape.asm):00160         DO_Assign16
E46C 0F06             (    cmds_tape.asm):00161                         CLR     <BasVarType
E46E DD52             (    cmds_tape.asm):00162                 STD     <BasVarAssign16
E470 7E9C3E           (    cmds_tape.asm):00163                 JMP     >VarAssign16BitB
                      (    cmds_tape.asm):00164         ;
                      (    cmds_tape.asm):00165         ; Enable tape emulatiom, open, and load a tape using cload/cloadm as needed.
                      (    cmds_tape.asm):00166         ;
                      (    cmds_tape.asm):00167         
E473                  (    cmds_tape.asm):00168         CmdTapeRun
E473 170101           (    cmds_tape.asm):00169                         lbsr    CmdMCasNormal                   ; boot into RAM mode
E476 17FFA1           (    cmds_tape.asm):00170                         lbsr    CmdMRMountEntry                 ; Open the file
                      (    cmds_tape.asm):00171         
E479 BDF096           (    cmds_tape.asm):00172                         jsr             >DO_ResetPoweron                ; reset memory map.
                      (    cmds_tape.asm):00173         
E47C 8E0420           (    cmds_tape.asm):00174                 ldx     #(TextScreenBase+TextLineLen) ; point to screen, beginning of line 2
E47F 9F88             (    cmds_tape.asm):00175                 stx     <TextVDUCursAddr        ; Set cursor address 
                      (    cmds_tape.asm):00176                         
E481 8DC1             (    cmds_tape.asm):00177                 bsr             GetCFTypeA                              ; get cas filetype in A
                      (    cmds_tape.asm):00178         
E483 8100             (    cmds_tape.asm):00179                         cmpa    #FTBasic                                ; Basic program ?
E485 2707             (    cmds_tape.asm):00180                         beq             CmdTapeRunLBas                  ; yes load it
                      (    cmds_tape.asm):00181                         
E487 8102             (    cmds_tape.asm):00182                         cmpa    #FTCode                                 ; Machine code ?
E489 271B             (    cmds_tape.asm):00183                         beq             CmdTapeRunCode                  ; yes load it
                      (    cmds_tape.asm):00184                         
E48B 7E8B8D           (    cmds_tape.asm):00185                         jmp             BasFCError                              ; nope : error 
                      (    cmds_tape.asm):00186                         
E48E                  (    cmds_tape.asm):00187         CmdTapeRunLBas          
E48E 0F78             (    cmds_tape.asm):00188                         CLR     <CasStatus
E490 3262             (    cmds_tape.asm):00189                         leas    2,s
                      (    cmds_tape.asm):00190                         
E492 7EB6E1           (    cmds_tape.asm):00191                         jmp             CloadEntry                              ; cload the file, this never returns!
                      (    cmds_tape.asm):00192         
                      (    cmds_tape.asm):00193         ; Emulated CLOAD command patched to come back to here if loading ASCII Basic!
                      (    cmds_tape.asm):00194         
E495                  (    cmds_tape.asm):00195         CLoadRunASCII
E495 327E             (    cmds_tape.asm):00196                         leas    -2,s                                    ; drop return address
E497 BDB663           (    cmds_tape.asm):00197                         jsr             CloseFilesEntry                 ; Close all files
E49A 2006             (    cmds_tape.asm):00198                         bra             CLoadRunRun                             ; Go run it
                      (    cmds_tape.asm):00199                         
                      (    cmds_tape.asm):00200         ; Emulated CLOAD command patched to come back to here !
E49C                  (    cmds_tape.asm):00201         CLoadRun
E49C BD841F           (    cmds_tape.asm):00202                         jsr             >BasVect1                               ; Reset basic memory
E49F BD83ED           (    cmds_tape.asm):00203                         jsr             >BasVect2                               ; Reset basic memory
                      (    cmds_tape.asm):00204                 
E4A2                  (    cmds_tape.asm):00205         CLoadRunRun
E4A2 4F               (    cmds_tape.asm):00206                         clra
E4A3 7E849F           (    cmds_tape.asm):00207                         jmp             BasRun
                      (    cmds_tape.asm):00208                         
E4A6                  (    cmds_tape.asm):00209         CmdTapeRunCode
E4A6 8DB1             (    cmds_tape.asm):00210                 bsr     GetCFLoadD              ; get load address in d
E4A8 3406             (    cmds_tape.asm):00211                 pshs    d                       ; save it
                      (    cmds_tape.asm):00212                         
E4AA 0F78             (    cmds_tape.asm):00213                         CLR     <CasStatus
E4AC BDA095           (    cmds_tape.asm):00214                         jsr             CloadMEntry                             ; cloadm the file
                      (    cmds_tape.asm):00215                 
E4AF 3506             (    cmds_tape.asm):00216                 puls    d                       ; recover load address
                      (    cmds_tape.asm):00217         
                      (    cmds_tape.asm):00218         ;
                      (    cmds_tape.asm):00219         ; Check to see if the IRQ vector has been changed to point to the loaded area?
                      (    cmds_tape.asm):00220         ; Some software does this to auto-run, notably "Facemaker" by DragonData.
                      (    cmds_tape.asm):00221         ;
                      (    cmds_tape.asm):00222                 
E4B1 10B3010D         (    cmds_tape.asm):00223                 cmpd    SecVecIRQ+1             ; load > SecIRQ ?           
E4B5 2207             (    cmds_tape.asm):00224                 bhi     CmdTapeRunCodeCheckExec ; lower, check exec address                  
                      (    cmds_tape.asm):00225                 
E4B7 BE010D           (    cmds_tape.asm):00226                 ldx     SecVecIRQ+1             ; get IRQ vector
                      (    cmds_tape.asm):00227                 
E4BA 9C7E             (    cmds_tape.asm):00228                 cmpx    <CasIOBuffAddr          ; Vector below end load address ?
E4BC 250F             (    cmds_tape.asm):00229                 blo     RunViaIRQ               ; yep it's in loaded area, just exit.
                      (    cmds_tape.asm):00230          
                      (    cmds_tape.asm):00231                 
                      (    cmds_tape.asm):00232         ;
                      (    cmds_tape.asm):00233         ; Check to see if EXEC address is within the loaded area, if so call it to run the code.
                      (    cmds_tape.asm):00234         ;
                      (    cmds_tape.asm):00235                 
E4BE                  (    cmds_tape.asm):00236         CmdTapeRunCodeCheckExec
E4BE 10939D           (    cmds_tape.asm):00237                 cmpd    <BasExecAddr            ; Load address below Exec address?
E4C1 2208             (    cmds_tape.asm):00238                 bhi     CmdTapeRunCodeExit      ; Exec < Load, invalid exit
                      (    cmds_tape.asm):00239                 
E4C3 9E9D             (    cmds_tape.asm):00240                 ldx     <BasExecAddr            ; get exec address
E4C5 9C7E             (    cmds_tape.asm):00241                 cmpx    <CasIOBuffAddr          ; Exec address below end load address ?
E4C7 2402             (    cmds_tape.asm):00242                 bhs     CmdTapeRunCodeExit      ; Exec > Last loaded, invalid exit
                      (    cmds_tape.asm):00243                   
E4C9 6E84             (    cmds_tape.asm):00244                 jmp     ,x                      ; call it
                      (    cmds_tape.asm):00245         
                      (    cmds_tape.asm):00246         ;
                      (    cmds_tape.asm):00247         ; Some auto-runners catch the line scanner, call it to try and catch them.
                      (    cmds_tape.asm):00248         ; Notably "FlagonBird".
                      (    cmds_tape.asm):00249         ;
E4CB                  (    cmds_tape.asm):00250         CmdTapeRunCodeExit        
E4CB 9DA8             (    cmds_tape.asm):00251                 jsr     <ScannerExit            ; Jump to last line of scanner, catch some auto-runs
                      (    cmds_tape.asm):00252         
E4CD                  (    cmds_tape.asm):00253         RunViaIRQ
E4CD 7E849F           (    cmds_tape.asm):00254                         jmp             BasicLoop                               ; jump to interpreter.
                      (    cmds_tape.asm):00255         ;               rts
                      (    cmds_tape.asm):00256         
                      (    cmds_tape.asm):00257         ;
                      (    cmds_tape.asm):00258         ; Rewind the emulated tape
                      (    cmds_tape.asm):00259         ;
E4D0                  (    cmds_tape.asm):00260         CmdRewind
E4D0 8624             (    cmds_tape.asm):00261                         lda             #CMD_REWIND                             ; Rewind tape file back to 0
                      (    cmds_tape.asm):00262         
E4D2 17FB39           (    cmds_tape.asm):00263                         lbsr    MMC_SendCmd                             ; Send Command
E4D5 17FE35           (    cmds_tape.asm):00264                         lbsr    CheckError                              ; Bomb out on error
                      (    cmds_tape.asm):00265         
E4D8 4F               (    cmds_tape.asm):00266                         clra
E4D9 39               (    cmds_tape.asm):00267                         rts
                      (    cmds_tape.asm):00268         
                      (    cmds_tape.asm):00269         ;
                      (    cmds_tape.asm):00270         ; Mirror incoming tape to MMC.
                      (    cmds_tape.asm):00271         ;               
                      (    cmds_tape.asm):00272         
                      (    cmds_tape.asm):00273         
E4DA                  (    cmds_tape.asm):00274         CmdMMirror
E4DA 8141             (    cmds_tape.asm):00275                 cmpa    #'A'                    ; Auto flag?
E4DC 2705             (    cmds_tape.asm):00276                 beq     CmdMMirrorA             ; yep deal with it
                      (    cmds_tape.asm):00277                 
E4DE 4F               (    cmds_tape.asm):00278                 clra    
E4DF 3402             (    cmds_tape.asm):00279                 pshs    a                       ; save auto flag
E4E1 2004             (    cmds_tape.asm):00280                         bra     CmdMMirrorCommon        ; Flag not auto
E4E3                  (    cmds_tape.asm):00281         CmdMMirrorA
E4E3 3402             (    cmds_tape.asm):00282                 pshs    a                       ; save auto flag
E4E5 9D9F             (    cmds_tape.asm):00283                         jsr             <BasChrGet                              ; skip first char       
E4E7                  (    cmds_tape.asm):00284         CmdMMirrorCommon
E4E7 BDE541           (    cmds_tape.asm):00285                 jsr             >CmdRamBoot                             ; Copy ROM into RAM.
                      (    cmds_tape.asm):00286         
E4EA 8611             (    cmds_tape.asm):00287                         lda             #D_RAM_ENABLE+D_RAM_WP  ; put us in ram mode, write protected.
E4EC 8EE533           (    cmds_tape.asm):00288                         ldx             #MirrorPatches                  ; Point to our patches.
E4EF BDE57C           (    cmds_tape.asm):00289                         jsr             >CmdMcasGo2                             ; go copy rom and patch it.
                      (    cmds_tape.asm):00290         
E4F2 8600             (    cmds_tape.asm):00291                         lda             #CAS_FILE                               ; open default file
E4F4 17FB2A           (    cmds_tape.asm):00292                         lbsr    MMC_WaitPutLatchRead    ; send file id to latch register
                      (    cmds_tape.asm):00293         
E4F7 861C             (    cmds_tape.asm):00294                         lda             #CMD_FILE_OPEN_STREAMW  ; Open file for streaming to
E4F9 BDE2EB           (    cmds_tape.asm):00295                         jsr             >CmdSendFilenameCmd             ; Send it and init streaming
E4FC 3502             (    cmds_tape.asm):00296                 puls    a                       ; recover auto flag
E4FE 8141             (    cmds_tape.asm):00297                 cmpa    #'A'                    ; Auto?
E500 2702             (    cmds_tape.asm):00298                 beq     CmdMMirrorAuto          ; yep : do it.
                      (    cmds_tape.asm):00299                 
E502 4F               (    cmds_tape.asm):00300                         clra
E503 39               (    cmds_tape.asm):00301                         rts
                      (    cmds_tape.asm):00302         
                      (    cmds_tape.asm):00303         ;
                      (    cmds_tape.asm):00304         ; Turn on motor and audio.
                      (    cmds_tape.asm):00305         ; Go into an endless loop that does block read to a constant buffer.
                      (    cmds_tape.asm):00306         ; this will of course then be mirrored to the cas file.
                      (    cmds_tape.asm):00307         ;        
E504                  (    cmds_tape.asm):00308         CmdMMirrorAuto
E504 BDBDCF           (    cmds_tape.asm):00309                 jsr     >CasMotorOn             ; Turn on motor
E507 5F               (    cmds_tape.asm):00310                         clrb                                                    ; B must be zero !
E508 BDBAEC           (    cmds_tape.asm):00311                 jsr     >CasAudioOn             ; turn on audio
                      (    cmds_tape.asm):00312         
E50B                  (    cmds_tape.asm):00313         CmdMMirrorAutoLoop        
E50B 8E0600           (    cmds_tape.asm):00314                 ldx     #$600                   ; use graphics screen
E50E 9F7E             (    cmds_tape.asm):00315                 stx     CasIOBuffAddr
                      (    cmds_tape.asm):00316         
E510 BDB93E           (    cmds_tape.asm):00317                 jsr     >CasBlockIn             ; Read block, ignore any error
E513 20F6             (    cmds_tape.asm):00318                 bra     CmdMMirrorAutoLoop      ; loop again!
                      (    cmds_tape.asm):00319                 
                      (    cmds_tape.asm):00320         ;
                      (    cmds_tape.asm):00321         ; This replaces the byte in routine in the Dragon / CoCo roms, it's exactly the same code
                      (    cmds_tape.asm):00322         ; with the addition of a save at the end to send the read byte to the MMC
                      (    cmds_tape.asm):00323         ;               
E515                  (    cmds_tape.asm):00324         NewByteIn
E515 8608             (    cmds_tape.asm):00325                         LDA     #$08                                    ; Read 8 bits
E517 9783             (    cmds_tape.asm):00326                 STA     <CasBitCount
E519                  (    cmds_tape.asm):00327         NewByteInLoop                                                   
E519 BDBDA5           (    cmds_tape.asm):00328                         JSR     >CasBitIn                               ; read a bit
E51C 46               (    cmds_tape.asm):00329                 RORA                                                    ; rotate it into A
E51D 0A83             (    cmds_tape.asm):00330                 DEC     <CasBitCount                    ; decrement count
E51F 26F8             (    cmds_tape.asm):00331                 BNE     NewByteInLoop                   ; keep going if not all done.
E521 B7FF52           (    cmds_tape.asm):00332                         sta             D_WRITE_DATA_REG                ; send it to the AVR, don't wait
E524 39               (    cmds_tape.asm):00333                 RTS
                      (    cmds_tape.asm):00334         
                      (    cmds_tape.asm):00335         ;
                      (    cmds_tape.asm):00336         ; Make sure beggining of block mark is copied to the output
                      (    cmds_tape.asm):00337         ;
E525                  (    cmds_tape.asm):00338         NewFoundBlkMark
E525 3402             (    cmds_tape.asm):00339                         pshs    a
E527 8655             (    cmds_tape.asm):00340                 lda     #'U
E529 B7FF52           (    cmds_tape.asm):00341                 sta             D_WRITE_DATA_REG            ; send it to the AVR, don't wait
E52C 3502             (    cmds_tape.asm):00342                         puls    a
E52E B7FF52           (    cmds_tape.asm):00343                 sta             D_WRITE_DATA_REG            ; send it to the AVR, don't wait
                      (    cmds_tape.asm):00344                         
                      (    cmds_tape.asm):00345                         ifdef   Dragon          
E531 20E2             (    cmds_tape.asm):00346                         bra             NewByteIn                               ; get next byte
                      (    cmds_tape.asm):00347                         else
                      (    cmds_tape.asm):00348                         bsr             NewByteIn                               ; get next byte
                      (    cmds_tape.asm):00349                         sta             <CCasBlockType                  ; save it
                      (    cmds_tape.asm):00350                         rts
                      (    cmds_tape.asm):00351                         endc
                      (    cmds_tape.asm):00352                         
                      (    cmds_tape.asm):00353                                 ifdef   Dragon
     B94D             (    cmds_tape.asm):00354         CMP2Addr        EQU             $B94D
                      (    cmds_tape.asm):00355                                 else
E533                  (    cmds_tape.asm):00356         CMP2Addr        EQU             $A719
                      (    cmds_tape.asm):00357                                 endc
                      (    cmds_tape.asm):00358                         
                      (    cmds_tape.asm):00359                         
E533                  (    cmds_tape.asm):00360         MirrorPatches
                      (    cmds_tape.asm):00361         
E533 BDAD             (    cmds_tape.asm):00362                         FDB             CasByteIn                               ; Byte in routine
E535 03               (    cmds_tape.asm):00363                         FCB             CasMP1E-CasMP1                  ; length
E536                  (    cmds_tape.asm):00364         CasMP1
E536 7EE515           (    cmds_tape.asm):00365                         JMP             >NewByteIn                              ; Jump to our copy of byte in
E539                  (    cmds_tape.asm):00366         CasMP1E
                      (    cmds_tape.asm):00367         
                      (    cmds_tape.asm):00368                         ifdef   Dragon
E539 B94D             (    cmds_tape.asm):00369                         FDB             CMP2Addr
E53B 03               (    cmds_tape.asm):00370                         FCB             CasMP2E-CasMP2                  ; length
E53C                  (    cmds_tape.asm):00371         CasMP2
E53C BDE525           (    cmds_tape.asm):00372                         JSR             >NewFoundBlkMark                ; Jump to our copy of byte in
E53F                  (    cmds_tape.asm):00373         CasMP2E
                      (    cmds_tape.asm):00374                         
                      (    cmds_tape.asm):00375                         else
                      (    cmds_tape.asm):00376                         FDB             CMP2Addr
                      (    cmds_tape.asm):00377                         FCB             CasMP2E-CasMP2                  ; length
E53F                  (    cmds_tape.asm):00378         CasMP2
                      (    cmds_tape.asm):00379                         JSR             >NewFoundBlkMark                ; Jump to our copy of byte in
                      (    cmds_tape.asm):00380                         NOP
E53F                  (    cmds_tape.asm):00381         CasMP2E
                      (    cmds_tape.asm):00382                         
                      (    cmds_tape.asm):00383                         endc
                      (    cmds_tape.asm):00384         
                      (    cmds_tape.asm):00385         ;*****************************************************************
                      (    cmds_tape.asm):00386         ;******************[ End of Patches ]*****************************
                      (    cmds_tape.asm):00387         ;*****************************************************************
E53F 0000             (    cmds_tape.asm):00388                         FDB     $0000                   ; end of patches
                      (    cmds_tape.asm):00389                         
E541                  (    cmds_tape.asm):00390         __cmd_tape_end
                      (    cmds_tape.asm):00391         
                      (    DragonMMC.asm):00663                         use             cmds_ram.asm
                      (     cmds_ram.asm):00001         ;
                      (     cmds_ram.asm):00002         ; CmdsRam       : Ram copy related commands.
                      (     cmds_ram.asm):00003         ;
                      (     cmds_ram.asm):00004         
                      (     cmds_ram.asm):00005         ;
                      (     cmds_ram.asm):00006         ; Note some routines make calls / returns into the Dragon and CoCo roms.
                      (     cmds_ram.asm):00007         ; Please remember to define them so they assemble correctly on *BOTH* 
                      (     cmds_ram.asm):00008         ; machines.
                      (     cmds_ram.asm):00009         ; 
                      (     cmds_ram.asm):00010         
E541                  (     cmds_ram.asm):00011         __cmd_ram
                      (     cmds_ram.asm):00012         
                      (     cmds_ram.asm):00013         ;
                      (     cmds_ram.asm):00014         ; Copy Dragon ROM from $8000-$FEFF to ram.
                      (     cmds_ram.asm):00015         ;
E541                  (     cmds_ram.asm):00016         CmdRamBoot
E541 3410             (     cmds_ram.asm):00017                         pshs    x                                               ; save x
                      (     cmds_ram.asm):00018         
                      (     cmds_ram.asm):00019                         ifndef  EMULATE
                      (     cmds_ram.asm):00020         ;; Code if on real hardware.
E543 8D11             (     cmds_ram.asm):00021                 bsr     GoROMMode               ; make sure we are in ROM mode, RAM write enabled
E545 8E8000           (     cmds_ram.asm):00022                         ldx             #$8000                                  ; point at base of system ROM
E548                  (     cmds_ram.asm):00023         RamBootLoop
E548 EC84             (     cmds_ram.asm):00024                         ldd             ,X                                              ; get a word
E54A ED81             (     cmds_ram.asm):00025                         std             ,x++                                    ; put it in ram, writes always go to ram
E54C 8CFF00           (     cmds_ram.asm):00026                         cmpx    #$FF00                                  ; done all
E54F 25F7             (     cmds_ram.asm):00027                         blo             RamBootLoop                             ; nope, do next
                      (     cmds_ram.asm):00028                         
E551 8D0F             (     cmds_ram.asm):00029                 bsr     GoRAMMode               ; Switch to RAM mode
                      (     cmds_ram.asm):00030                         
                      (     cmds_ram.asm):00031                         else
                      (     cmds_ram.asm):00032         ;; Code if emulated.
                      (     cmds_ram.asm):00033                         ldx             #RamBoot                                ; Copy to tape buffer
                      (     cmds_ram.asm):00034                         ldu             #DCasFNameLen                   
E553                  (     cmds_ram.asm):00035         RamBootCopyLoop
                      (     cmds_ram.asm):00036                         lda             ,x+                                             ; get byte
                      (     cmds_ram.asm):00037                         sta             ,u+                                             ; save it
                      (     cmds_ram.asm):00038                         cmpx    #GoROMMode                              ; done all?
                      (     cmds_ram.asm):00039                         bne             RamBootCopyLoop
                      (     cmds_ram.asm):00040                         jmp             >DCasFNameLen                   ; call copied code
                      (     cmds_ram.asm):00041                         
E553                  (     cmds_ram.asm):00042         RamBoot         
                      (     cmds_ram.asm):00043                         ldx             #$8000                                  ; point at base of system ROM
E553                  (     cmds_ram.asm):00044         RamBootLoop
                      (     cmds_ram.asm):00045                         clr             SAMCTY                                  ; ROM mode
                      (     cmds_ram.asm):00046                         ldd             ,X                                              ; get a word
                      (     cmds_ram.asm):00047                         clr             SAMSTY                                  ; RAM mode
                      (     cmds_ram.asm):00048                         std             ,x++                                    ; put it in ram, writes always go to ram
                      (     cmds_ram.asm):00049                         cmpx    #$FF00                                  ; done all
                      (     cmds_ram.asm):00050                         blo             RamBootLoop                             ; nope, do next
                      (     cmds_ram.asm):00051                         jmp             >RamBootDone
                      (     cmds_ram.asm):00052         
E553                  (     cmds_ram.asm):00053         RamBootDone             
                      (     cmds_ram.asm):00054                         endc
                      (     cmds_ram.asm):00055                         
E553 4F               (     cmds_ram.asm):00056                         clra                                                    ; no error
E554 3590             (     cmds_ram.asm):00057                         puls    x,pc                                    ; restore and return
                      (     cmds_ram.asm):00058         
E556                  (     cmds_ram.asm):00059         GoROMMode
E556 3402             (     cmds_ram.asm):00060                 pshs    a                       ; save a
E558 BDE026           (     cmds_ram.asm):00061                         jsr             MMC_GetRAMCTRL                  ; Go get current value
E55B 84EE             (     cmds_ram.asm):00062                         anda    #~(D_RAM_ENABLE+D_RAM_WP)  
E55D BDE02E           (     cmds_ram.asm):00063                         jsr             MMC_SetRAMCTRL                  ; and update
                      (     cmds_ram.asm):00064                         
E560 3582             (     cmds_ram.asm):00065                 puls    a,pc                    ; restore and return
                      (     cmds_ram.asm):00066                 
                      (     cmds_ram.asm):00067         
E562                  (     cmds_ram.asm):00068         GoRAMMode
E562 3402             (     cmds_ram.asm):00069                 pshs    a                       ; save a
E564 BDE026           (     cmds_ram.asm):00070                         jsr             MMC_GetRAMCTRL                  ; Go get current value
E567 8A01             (     cmds_ram.asm):00071                         ora         #D_RAM_ENABLE          
E569 BDE02E           (     cmds_ram.asm):00072                         jsr             MMC_SetRAMCTRL                  ; and update
E56C 3582             (     cmds_ram.asm):00073                 puls    a,pc                    ; restore and return
                      (     cmds_ram.asm):00074         
                      (     cmds_ram.asm):00075         ;
                      (     cmds_ram.asm):00076         ; Copy Dragon rom to ram and patch for cassette emulation on mmc
                      (     cmds_ram.asm):00077         ;
                      (     cmds_ram.asm):00078         
E56E                  (     cmds_ram.asm):00079         CmdMCas
E56E 4D               (     cmds_ram.asm):00080                         tsta
E56F 2706             (     cmds_ram.asm):00081                         beq             CmdMCasNormal
E571 9D9F             (     cmds_ram.asm):00082                         JSR     <BasChrGet                              ; skip the charcter
                      (     cmds_ram.asm):00083                         
E573 8601             (     cmds_ram.asm):00084                         lda             #D_RAM_ENABLE                   ; Leave it write enabled
E575 2002             (     cmds_ram.asm):00085                         bra             CmdMcasGo
                      (     cmds_ram.asm):00086                         
E577                  (     cmds_ram.asm):00087         CmdMCasNormal
E577 8611             (     cmds_ram.asm):00088                         lda             #D_RAM_ENABLE+D_RAM_WP  ; put us in ram mode, write protected.
E579                  (     cmds_ram.asm):00089         CmdMcasGo       
E579 8EE599           (     cmds_ram.asm):00090                         ldx             #CasPatch                               ; point to patches
E57C                  (     cmds_ram.asm):00091         CmdMcasGo2
E57C 3402             (     cmds_ram.asm):00092                         pshs    a
                      (     cmds_ram.asm):00093                 
E57E 8DC1             (     cmds_ram.asm):00094                         bsr             CmdRamBoot                              ; Switch to all ram mode
E580                  (     cmds_ram.asm):00095         CmdMCasNext
E580 10AE81           (     cmds_ram.asm):00096                         ldy             ,x++                                    ; Get address to patch
E583 270B             (     cmds_ram.asm):00097                         beq             CmdMCasPatchDone                ; address=0, end
                      (     cmds_ram.asm):00098                 
E585 E680             (     cmds_ram.asm):00099                         ldb             ,x+                                             ; Byte count
E587                  (     cmds_ram.asm):00100         CmdMCasPLoop
E587 A680             (     cmds_ram.asm):00101                         lda             ,x+                                             ; Get a byte
E589 A7A0             (     cmds_ram.asm):00102                         sta             ,y+                                             ; Put in ram
E58B 5A               (     cmds_ram.asm):00103                         decb                                                    ; Decrement count
E58C 26F9             (     cmds_ram.asm):00104                         bne             CmdMCasPLoop
E58E 20F0             (     cmds_ram.asm):00105                         bra             CmdMCasNext                             ; Do next patch
                      (     cmds_ram.asm):00106                 
E590                  (     cmds_ram.asm):00107         CmdMCasPatchDone
E590 BDE026           (     cmds_ram.asm):00108                         jsr             MMC_GetRAMCTRL                  ; Go get current value
E593 AAE0             (     cmds_ram.asm):00109                 ora         ,s+                                         ; mask in flags
E595 BDE02E           (     cmds_ram.asm):00110                         jsr             MMC_SetRAMCTRL                  ; and update
                      (     cmds_ram.asm):00111         
                      (     cmds_ram.asm):00112         ;               lda             D_RAM_CTRL              ; Get ram control register
                      (     cmds_ram.asm):00113         ;        ora        ,s+                                         ; mask in flags
                      (     cmds_ram.asm):00114         ;               sta             D_RAM_CTRL              ; Put back.
                      (     cmds_ram.asm):00115                         
E598 39               (     cmds_ram.asm):00116                         rts
                      (     cmds_ram.asm):00117         
                      (     cmds_ram.asm):00118                                 ifdef Dragon
     BDED             (     cmds_ram.asm):00119         CP1Addr         EQU             $BDED
     B945             (     cmds_ram.asm):00120         CP3Addr         EQU             $B945
     B961             (     cmds_ram.asm):00121         CP4Addr         EQU             $B961
     B9C1             (     cmds_ram.asm):00122         CP6Addr         EQU             $b9c1
     B733             (     cmds_ram.asm):00123         CloadExit       EQU             $B733
                      (     cmds_ram.asm):00124                                 else
E599                  (     cmds_ram.asm):00125         CP1Addr         EQU             $A782
E599                  (     cmds_ram.asm):00126         CP3Addr         EQU             $A712
E599                  (     cmds_ram.asm):00127         CP4Addr         EQU             $A72B
E599                  (     cmds_ram.asm):00128         CP6Addr         EQU             $A81C
E599                  (     cmds_ram.asm):00129         CloadExit       EQU             $A4F5   
                      (     cmds_ram.asm):00130                                 endc
                      (     cmds_ram.asm):00131         
                      (     cmds_ram.asm):00132         ;******************************
                      (     cmds_ram.asm):00133         ; Patches to rom for CmdMcas. *
                      (     cmds_ram.asm):00134         ;******************************
                      (     cmds_ram.asm):00135         
E599                  (     cmds_ram.asm):00136         CasPatch
                      (     cmds_ram.asm):00137                         ifndef  EMULATE
                      (     cmds_ram.asm):00138                         
E599 BDED             (     cmds_ram.asm):00139                         FDB     CP1Addr                         ; Address
E59B 01               (     cmds_ram.asm):00140                         FCB     CasP1E-CasP1            ; length
                      (     cmds_ram.asm):00141         
                      (     cmds_ram.asm):00142         ; Patch wait for leader to just return
E59C                  (     cmds_ram.asm):00143         CasP1
E59C 39               (     cmds_ram.asm):00144                         rts                                             ; Bytes to patch
E59D                  (     cmds_ram.asm):00145         CasP1E
                      (     cmds_ram.asm):00146         
                      (     cmds_ram.asm):00147         
E59D BDAD             (     cmds_ram.asm):00148                         FDB     CasByteIn                       ; Address
E59F 03               (     cmds_ram.asm):00149                         FCB     CasP2E-CasP2            ; length
                      (     cmds_ram.asm):00150         
                      (     cmds_ram.asm):00151         ; Patch byte in to read a byte from the MMC
E5A0                  (     cmds_ram.asm):00152         CasP2
E5A0 7EED27           (     cmds_ram.asm):00153                         JMP     >MMC_ReadFByte  
E5A3                  (     cmds_ram.asm):00154         CasP2E  
                      (     cmds_ram.asm):00155         
                      (     cmds_ram.asm):00156         
E5A3 B945             (     cmds_ram.asm):00157                         FDB     CP3Addr                         ; Address
E5A5 04               (     cmds_ram.asm):00158                         FCB     CasP3E-CasP3            ; length
                      (     cmds_ram.asm):00159         
                      (     cmds_ram.asm):00160         ; Patch byte in to read a byte from MMC
E5A6                  (     cmds_ram.asm):00161         CasP3
E5A6 BDED27           (     cmds_ram.asm):00162                         JSR             >MMC_ReadFByte  
                      (     cmds_ram.asm):00163                         ifdef   Dragon  
E5A9 12               (     cmds_ram.asm):00164                         NOP
                      (     cmds_ram.asm):00165                         endc
E5AA                  (     cmds_ram.asm):00166         CasP3E
                      (     cmds_ram.asm):00167         
E5AA B961             (     cmds_ram.asm):00168                         FDB     CP4Addr                         ; Address
E5AC 05               (     cmds_ram.asm):00169                         FCB     CasP4E-CasP4            ; length
                      (     cmds_ram.asm):00170         
                      (     cmds_ram.asm):00171         ; Patch byte in to read a block from the MMC
E5AD                  (     cmds_ram.asm):00172         CasP4
E5AD 12               (     cmds_ram.asm):00173                         nop
E5AE 12               (     cmds_ram.asm):00174                         nop
E5AF 7EED44           (     cmds_ram.asm):00175                         jmp             >MMC_ReadFBlock ;Read block
E5B2                  (     cmds_ram.asm):00176         CasP4E
                      (     cmds_ram.asm):00177         
                      (     cmds_ram.asm):00178         
E5B2 BE12             (     cmds_ram.asm):00179                         FDB     CasByteOut                      ; Address
E5B4 03               (     cmds_ram.asm):00180                         FCB     CasP5E-CasP5            ; length
                      (     cmds_ram.asm):00181         
                      (     cmds_ram.asm):00182         ; Patch write a byte to the MMC
E5B5                  (     cmds_ram.asm):00183         CasP5
E5B5 7EED81           (     cmds_ram.asm):00184                         JMP             >MMC_WriteFByte 
E5B8                  (     cmds_ram.asm):00185         CasP5E
                      (     cmds_ram.asm):00186         
                      (     cmds_ram.asm):00187         
                      (     cmds_ram.asm):00188         ;
                      (     cmds_ram.asm):00189         ; Patch the write byte loop in the CasBlockOut to use a multi-byte write file.
                      (     cmds_ram.asm):00190         ;
                      (     cmds_ram.asm):00191         
E5B8 B9C1             (     cmds_ram.asm):00192                         fdb     CP6Addr
E5BA 04               (     cmds_ram.asm):00193                         FCB     CasP6E-CasP6            ; length
                      (     cmds_ram.asm):00194         
                      (     cmds_ram.asm):00195         ; Patch write a byte to the MMC
E5BB                  (     cmds_ram.asm):00196         CasP6
E5BB 7EEDB9           (     cmds_ram.asm):00197                         JMP             >MMC_WriteFBlock
E5BE 12               (     cmds_ram.asm):00198                         nop
E5BF                  (     cmds_ram.asm):00199         CasP6E
                      (     cmds_ram.asm):00200         
                      (     cmds_ram.asm):00201         ;
                      (     cmds_ram.asm):00202         ; Patch the gap checking routine to not toggle the cassette relay.
                      (     cmds_ram.asm):00203         ;
                      (     cmds_ram.asm):00204         
                      (     cmds_ram.asm):00205         ;               fdb     $b906
                      (     cmds_ram.asm):00206         ;               fcb     CasP7E-CasP7            ; length
                      (     cmds_ram.asm):00207         ;
                      (     cmds_ram.asm):00208         ;CasP7
                      (     cmds_ram.asm):00209         ;               fcb     $21                                     ; code for BRN
                      (     cmds_ram.asm):00210         ;CasP7E
                      (     cmds_ram.asm):00211         
                      (     cmds_ram.asm):00212         ;
                      (     cmds_ram.asm):00213         ; Patch motor on to just return, without turning on motor.
                      (     cmds_ram.asm):00214         ;
                      (     cmds_ram.asm):00215         
                      (     cmds_ram.asm):00216         ;               fdb     CasMotorOn
                      (     cmds_ram.asm):00217         ;               fcb     CasP8E-CasP8            ; length
                      (     cmds_ram.asm):00218         ;
                      (     cmds_ram.asm):00219         ;CasP8
                      (     cmds_ram.asm):00220         ;               rts
                      (     cmds_ram.asm):00221         ;CasP8E
                      (     cmds_ram.asm):00222         
                      (     cmds_ram.asm):00223                         endc
                      (     cmds_ram.asm):00224         ;
                      (     cmds_ram.asm):00225         ; Patch Cload, to run loaded basic program (tokenized)
                      (     cmds_ram.asm):00226         ;
E5BF B733             (     cmds_ram.asm):00227                         fdb     CloadExit
E5C1 03               (     cmds_ram.asm):00228                         fcb     CasP9E-CasP9            ; length
                      (     cmds_ram.asm):00229         
E5C2                  (     cmds_ram.asm):00230         CasP9
E5C2 7EE49C           (     cmds_ram.asm):00231                         JMP     CLoadRun                        ; Go run it!
E5C5                  (     cmds_ram.asm):00232         CasP9E
                      (     cmds_ram.asm):00233         
                      (     cmds_ram.asm):00234         ;
                      (     cmds_ram.asm):00235         ; Patch Cload, to run loaded basic program (ASCII)
                      (     cmds_ram.asm):00236         ;
E5C5 0185             (     cmds_ram.asm):00237                         fdb     VectCloseFileCmd
E5C7 03               (     cmds_ram.asm):00238                         fcb     CasP10E-CasP10          ; length
                      (     cmds_ram.asm):00239         
E5C8                  (     cmds_ram.asm):00240         CasP10
E5C8 7EE495           (     cmds_ram.asm):00241                         JMP     CLoadRunASCII           ; Go run it!
E5CB                  (     cmds_ram.asm):00242         CasP10E
                      (     cmds_ram.asm):00243                 
                      (     cmds_ram.asm):00244         ;*****************************************************************
                      (     cmds_ram.asm):00245         ;******************[ End of Patches ]*****************************
                      (     cmds_ram.asm):00246         ;*****************************************************************
E5CB 0000             (     cmds_ram.asm):00247                         FDB     $0000                   ; end of patches
                      (     cmds_ram.asm):00248         
E5CD                  (     cmds_ram.asm):00249         __cmd_ram_end
                      (    DragonMMC.asm):00664                         use             cmd_cat.asm
                      (      cmd_cat.asm):00001         ;
                      (      cmd_cat.asm):00002         ;
                      (      cmd_cat.asm):00003         ; CmdCat.asm
                      (      cmd_cat.asm):00004         ;
                      (      cmd_cat.asm):00005         ; Catalog the MMC.
                      (      cmd_cat.asm):00006         ;
                      (      cmd_cat.asm):00007         
E5CD                  (      cmd_cat.asm):00008         __cmd_cat
                      (      cmd_cat.asm):00009         
                      (      cmd_cat.asm):00010                 ifdef           Dragon
     8DE1             (      cmd_cat.asm):00011         VarReturnStr    EQU     $8DE1
                      (      cmd_cat.asm):00012                 else
E5CD                  (      cmd_cat.asm):00013         VarReturnStr    EQU     $B69B
                      (      cmd_cat.asm):00014                 endc
                      (      cmd_cat.asm):00015         
     000F             (      cmd_cat.asm):00016         LinesPerPage    equ     15                                      ; line per page
                      (      cmd_cat.asm):00017         
E5CD                  (      cmd_cat.asm):00018         CmdCat
E5CD 327E             (      cmd_cat.asm):00019                 leas    -2,s                                            ; make room on stack
E5CF A761             (      cmd_cat.asm):00020                 sta             1,s                                                     ; save paged flag
E5D1 8150             (      cmd_cat.asm):00021                 cmpa    #'P                                                     ; Paged ?
E5D3 2608             (      cmd_cat.asm):00022                 bne             CmdCatNonPaged                          ; nope skip
E5D5 9D9F             (      cmd_cat.asm):00023                 JSR     <BasChrGet                                      ; skip the P
                      (      cmd_cat.asm):00024         
E5D7 8610             (      cmd_cat.asm):00025                 lda             #LinesPerPage+1                         ; set lines to next prompt
E5D9 A7E4             (      cmd_cat.asm):00026                 sta             ,s
E5DB 2004             (      cmd_cat.asm):00027                 bra             CmdCatGo
                      (      cmd_cat.asm):00028                 
E5DD                  (      cmd_cat.asm):00029         CmdCatNonPaged
E5DD 6FE4             (      cmd_cat.asm):00030                 clr             ,s                                                      ; flag not paged
E5DF 6F61             (      cmd_cat.asm):00031                 clr             1,s
                      (      cmd_cat.asm):00032         
E5E1                  (      cmd_cat.asm):00033         CmdCatGo
E5E1 8D3C             (      cmd_cat.asm):00034                 bsr             InitDirRead                                     ; Shared by cat and findfirst
                      (      cmd_cat.asm):00035                 
E5E3                  (      cmd_cat.asm):00036         CmdCatLoop
E5E3 8601             (      cmd_cat.asm):00037                 lda             #CMD_DIR_READ                           ; get next entry
E5E5 17FA26           (      cmd_cat.asm):00038                 lbsr    MMC_SendCmd
E5E8 17FD22           (      cmd_cat.asm):00039                 lbsr    CheckError                                      ; check for errors, returns to basic on error
                      (      cmd_cat.asm):00040                 
E5EB 8141             (      cmd_cat.asm):00041                 cmpa    #STATUS_COMPLETE+STATUS_LAST    ; Listed all entries ?
E5ED 2604             (      cmd_cat.asm):00042                 bne             CmdCatPrintNext                         ; nope : print next entry
E5EF                  (      cmd_cat.asm):00043         CmdCatEnd
E5EF 3262             (      cmd_cat.asm):00044                 leas    2,s                                                     ; drop stack bytes
E5F1 4F               (      cmd_cat.asm):00045                 clra    
E5F2 39               (      cmd_cat.asm):00046                 rts             
                      (      cmd_cat.asm):00047         
E5F3                  (      cmd_cat.asm):00048         CmdCatPrintNext
E5F3 6D61             (      cmd_cat.asm):00049                 tst             1,s                                                     ; Paged mode ?
E5F5 2712             (      cmd_cat.asm):00050                 beq             CmdCatPrintNext1                        ; nope, just print
                      (      cmd_cat.asm):00051                 
E5F7 6AE4             (      cmd_cat.asm):00052                 dec             ,s                                                      ; decrement counter
E5F9 260E             (      cmd_cat.asm):00053                 bne             CmdCatPrintNext1                        ; If not done LinesPerPage lines keep printing 
                      (      cmd_cat.asm):00054                 
E5FB 860F             (      cmd_cat.asm):00055                 lda             #LinesPerPage                           ; re-initialize counter
E5FD A7E4             (      cmd_cat.asm):00056                 sta             ,s
                      (      cmd_cat.asm):00057                 
E5FF 1709D3           (      cmd_cat.asm):00058                 lbsr    CON_PromptMore                          ; Display prompt and wait for key
E602 8151             (      cmd_cat.asm):00059                 cmpa    #'Q                                                     ; Quit?
E604 27E9             (      cmd_cat.asm):00060                 beq             CmdCatEnd                                       ; Yep : exit
                      (      cmd_cat.asm):00061                 
E606 170987           (      cmd_cat.asm):00062                 lbsr    CON_EOL                                         ; next line
                      (      cmd_cat.asm):00063                 
E609                  (      cmd_cat.asm):00064         CmdCatPrintNext1
E609 8620             (      cmd_cat.asm):00065                 lda             #CMD_INIT_READ                          ; Start reading filename 
E60B 17FA09           (      cmd_cat.asm):00066                 lbsr    MMC_SendCmdRaw
                      (      cmd_cat.asm):00067                 
E60E                  (      cmd_cat.asm):00068         CmdCatPrintLoop
E60E 170705           (      cmd_cat.asm):00069                 lbsr    MMC_WaitGetWritten                      ; Wait for byte, and get it in a
E611 8100             (      cmd_cat.asm):00070                 cmpa    #0                                                      ; end of filename ?
E613 2705             (      cmd_cat.asm):00071                 beq             CmdCatEOL                                       ; yes : process next name
                      (      cmd_cat.asm):00072                 
E615 BD800C           (      cmd_cat.asm):00073                 jsr             BasicScreenOut                          ; nope print it
E618 20F4             (      cmd_cat.asm):00074                 bra             CmdCatPrintLoop
                      (      cmd_cat.asm):00075         
E61A                  (      cmd_cat.asm):00076         CmdCatEOL
E61A 170973           (      cmd_cat.asm):00077                 lbsr    CON_EOL                                         ; send eol
E61D 20C4             (      cmd_cat.asm):00078                 bra             CmdCatLoop                                      ; do next entry
                      (      cmd_cat.asm):00079         
                      (      cmd_cat.asm):00080         
E61F                  (      cmd_cat.asm):00081         InitDirRead
E61F 9DA5             (      cmd_cat.asm):00082                 JSR     <BasChrGetCurr                          ; get current character from command
E621 2705             (      cmd_cat.asm):00083                 beq             InitNullDir
                      (      cmd_cat.asm):00084         
E623 17FCB9           (      cmd_cat.asm):00085                 lbsr    GetSendFileName                         ; Get path / wildcard 
E626 200D             (      cmd_cat.asm):00086                 bra             InitDirReadOpen                         ; open the directory
                      (      cmd_cat.asm):00087                 
                      (      cmd_cat.asm):00088         ; No filename supplied, set a null filename, which also reset wildcard to *
E628                  (      cmd_cat.asm):00089         InitNullDir
E628 8621             (      cmd_cat.asm):00090                 lda     #CMD_INIT_WRITE                         ; init write, clear dir name
E62A 17F9E1           (      cmd_cat.asm):00091                 lbsr    MMC_SendCmd
E62D 17FCDD           (      cmd_cat.asm):00092                 lbsr    CheckError                                      ; check for errors, returns to basic on error
                      (      cmd_cat.asm):00093                 
E630 8600             (      cmd_cat.asm):00094                 lda             #0
E632 B7FF52           (      cmd_cat.asm):00095                 sta             D_WRITE_DATA_REG                        ; Send null dirname for now
                      (      cmd_cat.asm):00096                 
E635                  (      cmd_cat.asm):00097         InitDirReadOpen
E635 8600             (      cmd_cat.asm):00098                 lda             #CMD_DIR_OPEN                           ; open dir
E637 17F9D4           (      cmd_cat.asm):00099                 lbsr    MMC_SendCmd
E63A 17FCD0           (      cmd_cat.asm):00100                 lbsr    CheckError                                      ; check for errors, returns to basic on error
E63D 39               (      cmd_cat.asm):00101                 rts
                      (      cmd_cat.asm):00102                 
                      (      cmd_cat.asm):00103         ;
                      (      cmd_cat.asm):00104         ; CmdCWD, change current working directory, change current snapshot directory.
                      (      cmd_cat.asm):00105         ;
                      (      cmd_cat.asm):00106         
E63E                  (      cmd_cat.asm):00107         CmdCWD
E63E 8153             (      cmd_cat.asm):00108                 cmpa    #'S                                                     ; CWDS ? (change snapshot dir?)
E640 2606             (      cmd_cat.asm):00109                 bne             CmdDoCWD                                        ; nope do CWD
E642 9D9F             (      cmd_cat.asm):00110                 JSR     <BasChrGet                                      ; skip the S
                      (      cmd_cat.asm):00111         
E644 8606             (      cmd_cat.asm):00112                 lda             #CMD_DIR_SET_SNAPPATH           ; change the snapshot path
E646 2002             (      cmd_cat.asm):00113             bra     CmdWD
E648                  (      cmd_cat.asm):00114         CmdDoCWD
E648 8602             (      cmd_cat.asm):00115                 lda             #CMD_DIR_CWD                            ; change working directory
                      (      cmd_cat.asm):00116         
E64A                  (      cmd_cat.asm):00117         CmdWD
E64A 17FC9E           (      cmd_cat.asm):00118                 lbsr    CmdSendFilenameCmd                      ; Send directory name and command
E64D 4F               (      cmd_cat.asm):00119                 clra    
E64E 39               (      cmd_cat.asm):00120                 rts
                      (      cmd_cat.asm):00121         
                      (      cmd_cat.asm):00122         ;
                      (      cmd_cat.asm):00123         ; CmdMkdir Make a directory.
                      (      cmd_cat.asm):00124         ;
E64F                  (      cmd_cat.asm):00125         CmdMKDir
E64F 8604             (      cmd_cat.asm):00126                 lda             #CMD_DIR_MAKE                           ; Make directory
E651 17FC97           (      cmd_cat.asm):00127                 lbsr    CmdSendFilenameCmd                      ; Send directory name and command
E654 17FCB6           (      cmd_cat.asm):00128                 lbsr    CheckError                                      ; check for errors, returns to basic on error
                      (      cmd_cat.asm):00129                 
E657 4F               (      cmd_cat.asm):00130                 clra
E658 39               (      cmd_cat.asm):00131                 rts
                      (      cmd_cat.asm):00132         
                      (      cmd_cat.asm):00133         ;
                      (      cmd_cat.asm):00134         ; FuncGetSnapDir, like CWD bugt get snapshot directory.
                      (      cmd_cat.asm):00135         ;
E659                  (      cmd_cat.asm):00136         FuncGetSnapDir
E659 8607             (      cmd_cat.asm):00137                 lda             #CMD_DIR_GET_SNAPPATH           ; get snapshot path
E65B 2002             (      cmd_cat.asm):00138                 bra             FuncCWDC                                        ; Rest same as WD$
                      (      cmd_cat.asm):00139                 
                      (      cmd_cat.asm):00140         ;
                      (      cmd_cat.asm):00141         ; FuncCWD, return the current working directory as a string.
                      (      cmd_cat.asm):00142         ;
                      (      cmd_cat.asm):00143         
E65D                  (      cmd_cat.asm):00144         FuncCWD
E65D 8603             (      cmd_cat.asm):00145                 lda             #CMD_DIR_GETCWD                         ; Get current working directory
E65F                  (      cmd_cat.asm):00146         FuncCWDC
E65F BDE00E           (      cmd_cat.asm):00147                 jsr     >MMC_SendCmd
E662 BDE30D           (      cmd_cat.asm):00148                 jsr     >CheckError                                     ; check for errors, returns to basic on error
                      (      cmd_cat.asm):00149         
E665 2009             (      cmd_cat.asm):00150             bra     FuncRetMMCString            ; Return it
                      (      cmd_cat.asm):00151         
E667                  (      cmd_cat.asm):00152         GetStrLenA
E667 8630             (      cmd_cat.asm):00153                 lda             #CMD_GET_STRLEN                         ; get length of returned path
E669 BDE017           (      cmd_cat.asm):00154                 jsr     >MMC_SendCmdRaw
E66C B6FF51           (      cmd_cat.asm):00155                 lda             D_LATCH_REG
                      (      cmd_cat.asm):00156         ;       jsr     >MMC_WaitGetWritten                     ; Wait for byte, and get it in a
E66F 39               (      cmd_cat.asm):00157             rts
                      (      cmd_cat.asm):00158             
E670                  (      cmd_cat.asm):00159         FuncRetMMCString
E670 8DF5             (      cmd_cat.asm):00160             bsr     GetStrLenA
                      (      cmd_cat.asm):00161             
E672                  (      cmd_cat.asm):00162         FuncRetMMCStringLenA
E672 1F89             (      cmd_cat.asm):00163                 tfr             a,b                                                     ; move length to b
E674 3402             (      cmd_cat.asm):00164                 pshs    a
E676 BD8C52           (      cmd_cat.asm):00165                 JSR     >BasResStr                                      ; reserve string space, exits with OS error if no space
                      (      cmd_cat.asm):00166                                                                                         ; X points to string
E679 3504             (      cmd_cat.asm):00167                 puls    b                                                       ; recover length
E67B 5D               (      cmd_cat.asm):00168                 tstb                                                            ; check for zero length string
E67C 270D             (      cmd_cat.asm):00169                 beq             FuncRetMMCStringExit            ; yes don't copy anything
                      (      cmd_cat.asm):00170                 
E67E 8620             (      cmd_cat.asm):00171                 lda             #CMD_INIT_READ                          ; Start reading filename 
E680 BDE017           (      cmd_cat.asm):00172                 jsr         >MMC_SendCmdRaw
                      (      cmd_cat.asm):00173         
E683                  (      cmd_cat.asm):00174         FuncCWDLoop
E683 BDED16           (      cmd_cat.asm):00175                 jsr         >MMC_WaitGetWritten                 ; Wait for byte, and get it in a
E686 A780             (      cmd_cat.asm):00176                 sta             ,x+
E688 5A               (      cmd_cat.asm):00177                 decb                                                            ; decrement count
E689 26F8             (      cmd_cat.asm):00178                 bne             FuncCWDLoop                                     ; more : keep going
                      (      cmd_cat.asm):00179                 
E68B                  (      cmd_cat.asm):00180         FuncRetMMCStringExit
E68B 7E8DE1           (      cmd_cat.asm):00181                 JMP             >VarReturnStr                           ; return string to basic.
                      (      cmd_cat.asm):00182                 
                      (      cmd_cat.asm):00183         ;
                      (      cmd_cat.asm):00184         ; Find first file
                      (      cmd_cat.asm):00185         ;
                      (      cmd_cat.asm):00186         
E68E                  (      cmd_cat.asm):00187         FuncFindFirst
E68E 8D8F             (      cmd_cat.asm):00188                 bsr             InitDirRead                                     ; Shared by cat and findfirst
                      (      cmd_cat.asm):00189         
                      (      cmd_cat.asm):00190         ;
                      (      cmd_cat.asm):00191         ; Find next file.
                      (      cmd_cat.asm):00192         ;
                      (      cmd_cat.asm):00193         
E690                  (      cmd_cat.asm):00194         FuncFindNext
E690 8601             (      cmd_cat.asm):00195                 lda             #CMD_DIR_READ                           ; get next entry
E692 17F979           (      cmd_cat.asm):00196                 lbsr    MMC_SendCmd
E695 17FC75           (      cmd_cat.asm):00197                 lbsr    CheckError                                      ; check for errors, returns to basic on error
                      (      cmd_cat.asm):00198                 
E698 8141             (      cmd_cat.asm):00199                 cmpa    #STATUS_COMPLETE+STATUS_LAST            ; Listed all entries ?
E69A 2702             (      cmd_cat.asm):00200                 beq             FindEnd
E69C 20D2             (      cmd_cat.asm):00201                 bra             FuncRetMMCString                        ; return filename to basic
                      (      cmd_cat.asm):00202                 
E69E                  (      cmd_cat.asm):00203         FindEnd
E69E 4F               (      cmd_cat.asm):00204                 clra                                                            ; return no bytes
E69F 20D1             (      cmd_cat.asm):00205                 bra             FuncRetMMCStringLenA
                      (      cmd_cat.asm):00206                 
E6A1                  (      cmd_cat.asm):00207         __cmd_cat_end
                      (      cmd_cat.asm):00208         
                      (    DragonMMC.asm):00665                         use             cmd_delete.asm
                      (   cmd_delete.asm):00001         ;
                      (   cmd_delete.asm):00002         ; cmd_delete.asm : delete the specified file.
                      (   cmd_delete.asm):00003         ;
                      (   cmd_delete.asm):00004         
E6A1                  (   cmd_delete.asm):00005         __cmd_delete
                      (   cmd_delete.asm):00006         
     0043             (   cmd_delete.asm):00007         MFileFlagCopy   equ     'C'
     0052             (   cmd_delete.asm):00008         MFileFlagRename equ     'R'
     0053             (   cmd_delete.asm):00009         MFileFlagSync   equ     'S'
                      (   cmd_delete.asm):00010         
E6A1                  (   cmd_delete.asm):00011         CmdMDelete
E6A1 17FC3B           (   cmd_delete.asm):00012                         lbsr    GetSendFileName         ; Get filename send to MMC
E6A4 308DFD24         (   cmd_delete.asm):00013                         leax    DeleteMess-1,PCR        ; Prompt the user
E6A8 BD90E5           (   cmd_delete.asm):00014                         jsr     >TextOutString  
                      (   cmd_delete.asm):00015                         
                      (   cmd_delete.asm):00016                         
E6AB                  (   cmd_delete.asm):00017         CmdMDeleteLoop
E6AB BD8006           (   cmd_delete.asm):00018                         jsr             >BasicKbdIn                     ; Poll keyboard
E6AE 27FB             (   cmd_delete.asm):00019                         beq             CmdMDeleteLoop          ; No key pressed loop again
                      (   cmd_delete.asm):00020                         
E6B0 814E             (   cmd_delete.asm):00021                         cmpa    #'N'                                    ; No key pressed ?
E6B2 270C             (   cmd_delete.asm):00022                         beq             CmdMDeleteExit          ; yes : exit
                      (   cmd_delete.asm):00023                         
E6B4 8159             (   cmd_delete.asm):00024                         cmpa    #'Y'                                    ; Yes key pressed ?
E6B6 26F3             (   cmd_delete.asm):00025                         bne             CmdMDeleteLoop          ; no : keep waiting
                      (   cmd_delete.asm):00026                         
E6B8 8614             (   cmd_delete.asm):00027                         lda             #CMD_FILE_DELETE        ; Delete the file
E6BA 17F951           (   cmd_delete.asm):00028                         lbsr    MMC_SendCmd                     ; send it
E6BD 17FC4D           (   cmd_delete.asm):00029                         lbsr    CheckError                      ; and check for error
                      (   cmd_delete.asm):00030         
E6C0                  (   cmd_delete.asm):00031         CmdMDeleteExit
E6C0 4F               (   cmd_delete.asm):00032                         clra
E6C1 39               (   cmd_delete.asm):00033                         rts
                      (   cmd_delete.asm):00034         ;
                      (   cmd_delete.asm):00035         ; MFile, copy or rename file.
                      (   cmd_delete.asm):00036         ;               
E6C2                  (   cmd_delete.asm):00037         CmdMFile
E6C2 8143             (   cmd_delete.asm):00038                         cmpa    #MFileFlagCopy          ; is it a copy?
E6C4 270B             (   cmd_delete.asm):00039                         beq             CmdMFileValid           ; yep
E6C6 8152             (   cmd_delete.asm):00040                         cmpa    #MFileFlagRename        ; is it a copy?
E6C8 2707             (   cmd_delete.asm):00041                         beq             CmdMFileValid           ; yep
E6CA 8153             (   cmd_delete.asm):00042                         cmpa    #MFileFlagSync          ; is it a Sync?
E6CC 2724             (   cmd_delete.asm):00043                         beq             CmdMFileSync            ; do a sync
E6CE 7E89B4           (   cmd_delete.asm):00044                         jmp             >BasSNError                     ; none, error
                      (   cmd_delete.asm):00045                         
E6D1                  (   cmd_delete.asm):00046         CmdMFileValid
E6D1 3402             (   cmd_delete.asm):00047                         pshs    a                                       ; save copy / rename flag
                      (   cmd_delete.asm):00048                         
E6D3 9D9F             (   cmd_delete.asm):00049                         jsr     <BasChrGet                      ; skip op flag.
E6D5 BDE2DF           (   cmd_delete.asm):00050                 jsr             >GetSendFileName        ; get first filename, send it
E6D8 BD89AA           (   cmd_delete.asm):00051                         jsr             >VarCKComma                     ; check for comma, error if not
E6DB BDE2E5           (   cmd_delete.asm):00052                         jsr             >GetSendFileName2       ; Send the second name
                      (   cmd_delete.asm):00053                         
E6DE 3502             (   cmd_delete.asm):00054                         puls    a                                       ; retrieve copy / rename flag
                      (   cmd_delete.asm):00055                         
E6E0 8143             (   cmd_delete.asm):00056                         cmpa    #MFileFlagCopy          ; Copy ?
E6E2 2604             (   cmd_delete.asm):00057                         bne             CmdMFileDoRename        ; nope skip
E6E4 861D             (   cmd_delete.asm):00058                         lda             #CMD_FILE_COPY          ; do a copy
E6E6 2002             (   cmd_delete.asm):00059                         bra             CmdMfileDoCmd
                      (   cmd_delete.asm):00060                         
E6E8                  (   cmd_delete.asm):00061         CmdMFileDoRename
E6E8 861E             (   cmd_delete.asm):00062                         lda             #CMD_FILE_RENAME        ; do a rename
                      (   cmd_delete.asm):00063         
E6EA                  (   cmd_delete.asm):00064         CmdMfileDoCmd
E6EA 17F921           (   cmd_delete.asm):00065                         lbsr    MMC_SendCmd                     ; send it
E6ED 17FC1D           (   cmd_delete.asm):00066                         lbsr    CheckError                      ; and check for error
                      (   cmd_delete.asm):00067         
E6F0 4F               (   cmd_delete.asm):00068                         clra
E6F1 39               (   cmd_delete.asm):00069                         rts
                      (   cmd_delete.asm):00070         
E6F2                  (   cmd_delete.asm):00071         CmdMFileSync
E6F2 9D9F             (   cmd_delete.asm):00072                         jsr     <BasChrGet                      ; skip op flag.
E6F4 8692             (   cmd_delete.asm):00073                         lda             #CMD_SYNC                       ; Sync command
E6F6 20F2             (   cmd_delete.asm):00074                         bra             CmdMfileDoCmd           ; go do it!
                      (   cmd_delete.asm):00075                         
E6F8                  (   cmd_delete.asm):00076         __cmd_delete_end
                      (    DragonMMC.asm):00666                         use             cmds_direct.asm
                      (  cmds_direct.asm):00001         ;
                      (  cmds_direct.asm):00002         ; cmds_direct.asm : commands for loading and saving direct to the disk.
                      (  cmds_direct.asm):00003         ;
                      (  cmds_direct.asm):00004         ; 2019-04-01, added MLOADR / MSAVER for loading / saving raw files 
                      (  cmds_direct.asm):00005         ; (without a header) to / from  memory.
                      (  cmds_direct.asm):00006         ; 
                      (  cmds_direct.asm):00007         
E6F8                  (  cmds_direct.asm):00008         __cmd_direct
                      (  cmds_direct.asm):00009         
     0000             (  cmds_direct.asm):00010         DebugTest       equ     0
                      (  cmds_direct.asm):00011         
     004D             (  cmds_direct.asm):00012         MSaveFlagMCode  equ             'M'
     0041             (  cmds_direct.asm):00013         MLoadFlagAuto   equ             'A'
     0043             (  cmds_direct.asm):00014         MloadFlagClear  equ             'C'
     0053             (  cmds_direct.asm):00015         MloadFlagSnap   equ             'S'
     0052             (  cmds_direct.asm):00016         MloadFlagRaw    equ             'R'
                      (  cmds_direct.asm):00017         
                      (  cmds_direct.asm):00018         
     0032             (  cmds_direct.asm):00019         AutoWaitTime    equ     (1*50)          ; Wait time in IRQ periods 50Hz for PAL, 60Hz for NTSC.
                      (  cmds_direct.asm):00020         
                      (  cmds_direct.asm):00021         ;
                      (  cmds_direct.asm):00022         ; MSave, same format as DragonDos save, files format compatible.
                      (  cmds_direct.asm):00023         ;
                      (  cmds_direct.asm):00024         ; MSave  "filename"
                      (  cmds_direct.asm):00025         ; MSaveM "Filename",start,end,entry
                      (  cmds_direct.asm):00026         ;
                      (  cmds_direct.asm):00027         
E6F8                  (  cmds_direct.asm):00028         CmdMSave
E6F8 814D             (  cmds_direct.asm):00029                         cmpa    #MSaveFlagMCode                 ; check for 'M'
E6FA 3402             (  cmds_direct.asm):00030                         pshs    a                                               ; save next letter
E6FC 2602             (  cmds_direct.asm):00031                         bne             CmdMSaveFname                   ; nope, skip
E6FE 9D9F             (  cmds_direct.asm):00032                         JSR     <BasChrGet                              ; skip the M
                      (  cmds_direct.asm):00033         
E700                  (  cmds_direct.asm):00034         CmdMSaveFname
E700 17FBDC           (  cmds_direct.asm):00035                         lbsr    GetSendFileName                 ; Get filename send to MMC
E703 3502             (  cmds_direct.asm):00036                         puls    a
                      (  cmds_direct.asm):00037         
E705 3440             (  cmds_direct.asm):00038                         pshs    u                                               ; Make temp stack frame
E707 3277             (  cmds_direct.asm):00039                         leas    -FileHeadLen,s
                      (  cmds_direct.asm):00040         
                      (  cmds_direct.asm):00041         
E709 814D             (  cmds_direct.asm):00042                 cmpa    #MSaveFlagMCode                 ; is it MSAVEM  
E70B 2623             (  cmds_direct.asm):00043                         bne             CmdSaveBasic                    ; nope : it's basic save as such
                      (  cmds_direct.asm):00044                         
E70D 33E4             (  cmds_direct.asm):00045                         leau    ,s                                              ; U=S
                      (  cmds_direct.asm):00046                         
E70F 8D53             (  cmds_direct.asm):00047                         bsr             GetCommaThen16                  ; Get start addr
E711 AF42             (  cmds_direct.asm):00048                         stx             HdrLoad,u
                      (  cmds_direct.asm):00049                         
E713 8D4F             (  cmds_direct.asm):00050                         bsr             GetCommaThen16                  ; Get end addr
E715 1F10             (  cmds_direct.asm):00051                         tfr             x,d
E717 AC42             (  cmds_direct.asm):00052                         cmpx    HdrLoad,u               
E719 1025A470         (  cmds_direct.asm):00053                         lbcs    BasFCError
                      (  cmds_direct.asm):00054                         
E71D A342             (  cmds_direct.asm):00055                         subd    HdrLoad,u                               ; Convert to length
E71F 102BA46A         (  cmds_direct.asm):00056                         lbmi    BasFCError                              ; ?FC error if -ve
E723 C30001           (  cmds_direct.asm):00057                         addd    #1                                              ; fixup 
E726 ED44             (  cmds_direct.asm):00058                         std             HdrLen,u                                ; Save length
                      (  cmds_direct.asm):00059                         
E728 8D3A             (  cmds_direct.asm):00060                         bsr             GetCommaThen16                  ; Get entry address
E72A AF46             (  cmds_direct.asm):00061                         stx             HdrExec,u
                      (  cmds_direct.asm):00062                         
E72C 8602             (  cmds_direct.asm):00063                         lda             #FTypeBin                               ; Set as binary
                      (  cmds_direct.asm):00064                         
E72E 2013             (  cmds_direct.asm):00065                         bra             CmdSaveCommon                   ; Go save it
                      (  cmds_direct.asm):00066                         
E730                  (  cmds_direct.asm):00067         CmdSaveBasic
E730 33E4             (  cmds_direct.asm):00068                         leau    ,s                                              ; U=S
E732 9E19             (  cmds_direct.asm):00069                         ldx             <BasStartProg                   ; get start of program
E734 AF42             (  cmds_direct.asm):00070                         stx             HdrLoad,u
                      (  cmds_direct.asm):00071                         
E736 DC1B             (  cmds_direct.asm):00072                         ldd             <BasVarSimpleAddr               ; get end of program
E738 9319             (  cmds_direct.asm):00073                         subd    <BasStartProg                   ; calculate length
E73A ED44             (  cmds_direct.asm):00074                         std             HdrLen,u
                      (  cmds_direct.asm):00075                         
E73C 8E8B8D           (  cmds_direct.asm):00076                         LDX     #BasFCError                             ; Exec address = FC Error
E73F AF46             (  cmds_direct.asm):00077                         stx             HdrExec,u
                      (  cmds_direct.asm):00078         
E741 8601             (  cmds_direct.asm):00079                         lda             #FTypeBas                               ; Set as basic
                      (  cmds_direct.asm):00080                         
E743                  (  cmds_direct.asm):00081         CmdSaveCommon
E743 A741             (  cmds_direct.asm):00082                         sta             HdrType,u               
                      (  cmds_direct.asm):00083         
E745 8655             (  cmds_direct.asm):00084                         lda             #$55                                    ; Save ID bytes
E747 A7C4             (  cmds_direct.asm):00085                         sta             HdrID55,u
E749 43               (  cmds_direct.asm):00086                         coma
E74A A748             (  cmds_direct.asm):00087                         sta             HdrIDAA,u
                      (  cmds_direct.asm):00088                         
E74C 8600             (  cmds_direct.asm):00089                         lda             #CAS_FILE                               ; open default file
E74E 17F8D0           (  cmds_direct.asm):00090                         lbsr    MMC_WaitPutLatchRead    ; send file id to latch register
                      (  cmds_direct.asm):00091         
E751 8613             (  cmds_direct.asm):00092                         lda             #CMD_FILE_OPEN_WRITE    ; Open file
E753 17F8B8           (  cmds_direct.asm):00093                         lbsr    MMC_SendCmd                             ; Open file
E756 17FBB4           (  cmds_direct.asm):00094                         lbsr    CheckError                              ; Bomb out on error
                      (  cmds_direct.asm):00095                         
E759 170688           (  cmds_direct.asm):00096                         lbsr    MMC_SaveFile                    ; Save the file
                      (  cmds_direct.asm):00097                         
E75C 1705BD           (  cmds_direct.asm):00098                         lbsr    MMC_CloseFile                   ; close the file
                      (  cmds_direct.asm):00099                         
E75F 4F               (  cmds_direct.asm):00100                         clra
E760 3269             (  cmds_direct.asm):00101                         leas    FileHeadLen,s                   ; cleanup stack frame
E762 35C0             (  cmds_direct.asm):00102                         puls    u,pc                                    ; restore / return
                      (  cmds_direct.asm):00103                 
E764                  (  cmds_direct.asm):00104         GetCommaThen16
E764 3440             (  cmds_direct.asm):00105                         pshs    u                                               ; save u as often clobbered !
E766 BD89AA           (  cmds_direct.asm):00106                         jsr     >VarCKComma                             ; Check for comma
E769 BD8E83           (  cmds_direct.asm):00107                 jsr     >VarGet16Bit                    ; returned in X, FCError if invalid
E76C 35C0             (  cmds_direct.asm):00108                         puls    u,pc                                    ; restore / return
                      (  cmds_direct.asm):00109                         
                      (  cmds_direct.asm):00110         ;
                      (  cmds_direct.asm):00111         ; MLoad, load a DragonDos format compatible file.
                      (  cmds_direct.asm):00112         ;
                      (  cmds_direct.asm):00113         ; Syntax :
                      (  cmds_direct.asm):00114         ;       MLOAD filespec
                      (  cmds_direct.asm):00115         ;       MLOAD filespec,new_start_addr
                      (  cmds_direct.asm):00116         ;
                      (  cmds_direct.asm):00117         ; Auto-start:
                      (  cmds_direct.asm):00118         ;   MLOADA filespec
                      (  cmds_direct.asm):00119         ; Snapshot:
                      (  cmds_direct.asm):00120         ;   MLOADS filespec
                      (  cmds_direct.asm):00121         ; Clear back to machine power on state, then autorun 
                      (  cmds_direct.asm):00122         ;       MLOADC filespec
                      (  cmds_direct.asm):00123         ; Load a raw file :
                      (  cmds_direct.asm):00124         ;       MLOADR filespec,load_addr,length
                      (  cmds_direct.asm):00125         ;
                      (  cmds_direct.asm):00126         
E76E                  (  cmds_direct.asm):00127         CmdMLoad
E76E 8D07             (  cmds_direct.asm):00128                         bsr             DoCmdMLoad                              ; attempt to load
E770 4D               (  cmds_direct.asm):00129                         tsta                                                    ; Error ?
E771 2703             (  cmds_direct.asm):00130                         beq             CmdMLoadOK                              ; nope : just return
E773 7E8B8D           (  cmds_direct.asm):00131                         jmp             BasFCError                              ; Yep : error 
                      (  cmds_direct.asm):00132                         
E776                  (  cmds_direct.asm):00133         CmdMLoadOK
E776 39               (  cmds_direct.asm):00134                         rts
                      (  cmds_direct.asm):00135                         
E777                  (  cmds_direct.asm):00136         DoCmdMLoad
E777 3442             (  cmds_direct.asm):00137                         pshs    a,u                                             ; save next character
E779 8141             (  cmds_direct.asm):00138                         cmpa    #MLoadFlagAuto                  ; is it LOADA ?
E77B 2714             (  cmds_direct.asm):00139                         beq             CmdMLoadAutoBoot                ; yep : do it
                      (  cmds_direct.asm):00140         
E77D 8153             (  cmds_direct.asm):00141                 cmpa    #MloadFlagSnap          ; is is MLOADS ?
E77F 10270100         (  cmds_direct.asm):00142                 lbeq    CmdMLoadS               ; yep : do it
                      (  cmds_direct.asm):00143         
E783 8143             (  cmds_direct.asm):00144                         cmpa    #MloadFlagClear                 ; is it MLOADC
E785 10270008         (  cmds_direct.asm):00145                         lbeq    CmdMLoadAutoBoot        ; yep : do it
                      (  cmds_direct.asm):00146         
E789 8152             (  cmds_direct.asm):00147                         cmpa    #MloadFlagRaw                   ; Is it MLOADR 
E78B 1027006D         (  cmds_direct.asm):00148                         lbeq    CmdMloadRaw                             ; yep : do it
                      (  cmds_direct.asm):00149         
E78F 2002             (  cmds_direct.asm):00150                 bra     CmdMLoadNoSkip          ; don't skip first
                      (  cmds_direct.asm):00151                 
E791                  (  cmds_direct.asm):00152         CmdMLoadAutoBoot
E791 9D9F             (  cmds_direct.asm):00153                         JSR     <BasChrGet                              ; skip the A
E793                  (  cmds_direct.asm):00154         CmdMLoadNoSkip
E793 BDE875           (  cmds_direct.asm):00155                         JSR             CmdMLoadSendFName               ; Get filename send to MMC, open file
E796 8180             (  cmds_direct.asm):00156                         cmpa    #STATUS_ERROR           ; Error ?
E798 102400B2         (  cmds_direct.asm):00157                         lbhs    CmdMLoadError2                  ; Yes : flag it
                      (  cmds_direct.asm):00158         
E79C A6E4             (  cmds_direct.asm):00159                         lda             ,s                                              ; Recover flag
E79E 8143             (  cmds_direct.asm):00160                         cmpa    #MloadFlagClear                 ; MLOADC?
E7A0 2609             (  cmds_direct.asm):00161                         bne             CmdMloadAutoexec                ; nope : skip
                      (  cmds_direct.asm):00162                         
E7A2 3542             (  cmds_direct.asm):00163                         puls    a,u                                             ; get saved regs off stack as we will move it
                      (  cmds_direct.asm):00164                         
E7A4 BDF096           (  cmds_direct.asm):00165                         jsr             >DO_ResetPoweron                ; reset memory map.
                      (  cmds_direct.asm):00166         
E7A7 8641             (  cmds_direct.asm):00167                         lda             #MLoadFlagAuto                  ; change to auto-run flag
E7A9 3442             (  cmds_direct.asm):00168                         pshs    a,u                                             ; re-save them
                      (  cmds_direct.asm):00169         
E7AB                  (  cmds_direct.asm):00170         CmdMloadAutoexec
E7AB 3277             (  cmds_direct.asm):00171                         leas    -FileHeadLen,s                  ; Make temp stack frame
E7AD 33E4             (  cmds_direct.asm):00172                         leau    ,s                                              ; U=S
                      (  cmds_direct.asm):00173         
E7AF 30C4             (  cmds_direct.asm):00174                         leax    ,u                                              ; Get address for file header
E7B1 C609             (  cmds_direct.asm):00175                         ldb             #FileHeadLen                    ; Read file header bytes
E7B3 170593           (  cmds_direct.asm):00176                         lbsr    MMC_ReadFileBlock               ; go read it
                      (  cmds_direct.asm):00177                         
E7B6 8655             (  cmds_direct.asm):00178                         lda             #$55                                    ; Check marker bytes
E7B8 A1C4             (  cmds_direct.asm):00179                         cmpa    HdrID55,u               
E7BA 1026008E         (  cmds_direct.asm):00180                         lbne    CmdMLoadError           
                      (  cmds_direct.asm):00181                         
E7BE 43               (  cmds_direct.asm):00182                         coma
E7BF A148             (  cmds_direct.asm):00183                         cmpa    HdrIDAA,u
E7C1 10260087         (  cmds_direct.asm):00184                         lbne    CmdMLoadError           
                      (  cmds_direct.asm):00185                         
E7C5 A641             (  cmds_direct.asm):00186                         lda             HdrType,u                               ; Get filetype
E7C7 8101             (  cmds_direct.asm):00187                         cmpa    #FTypeBas                               ; Basic file ?
E7C9 275A             (  cmds_direct.asm):00188                         beq             CmdMLoadBas                             ; yep : load it
                      (  cmds_direct.asm):00189                         
E7CB 8102             (  cmds_direct.asm):00190                         cmpa    #FTypeBin                               ; Binary file ?
E7CD 1026007B         (  cmds_direct.asm):00191                         lbne    CmdMLoadError                   ; nope, error
                      (  cmds_direct.asm):00192         
E7D1 AE46             (  cmds_direct.asm):00193                         ldx             HdrExec,u                               ; Get exec address
E7D3 9F9D             (  cmds_direct.asm):00194                         stx             BasExecAddr                             ; set exec address
                      (  cmds_direct.asm):00195                 
E7D5 17FB21           (  cmds_direct.asm):00196                         lbsr    CkComma                                 ; Comma ?
E7D8 260E             (  cmds_direct.asm):00197                         bne             CmdMLoadBinDef                  ; no : use default addresses
                      (  cmds_direct.asm):00198                         
E7DA 8D88             (  cmds_direct.asm):00199                         bsr             GetCommaThen16                  ; get new load address
E7DC 33E4             (  cmds_direct.asm):00200                         leau    ,s                                              ; U=S
                      (  cmds_direct.asm):00201                         
E7DE EC46             (  cmds_direct.asm):00202                         ldd             HdrExec,u                               ; get exec address
E7E0 A342             (  cmds_direct.asm):00203                         subd    HdrLoad,u                               ; subtract start address, calculate exec offset from start
E7E2 AF42             (  cmds_direct.asm):00204                         stx             HdrLoad,u                               ; save new load address in header
E7E4 E342             (  cmds_direct.asm):00205                         addd    HdrLoad,u                               ; calculate new exec address
E7E6 DD9D             (  cmds_direct.asm):00206                         std             BasExecAddr                             ; set exec address
                      (  cmds_direct.asm):00207         
E7E8                  (  cmds_direct.asm):00208         CmdMLoadBinDef          
E7E8 17061A           (  cmds_direct.asm):00209                         lbsr    MMC_LoadFile                    ; load the file
E7EB 17052E           (  cmds_direct.asm):00210                         lbsr    MMC_CloseFile                   ; close the file
                      (  cmds_direct.asm):00211         
E7EE 3269             (  cmds_direct.asm):00212                         leas    FileHeadLen,s                   ; cleanup stack frame
E7F0 3542             (  cmds_direct.asm):00213                         puls    a,u                                             ; recover auto flag
E7F2 8141             (  cmds_direct.asm):00214                         cmpa    #MLoadFlagAuto                  ; auto-run ?
E7F4 2604             (  cmds_direct.asm):00215                         bne             CmdMLoadBinExit                 ; nope : return
                      (  cmds_direct.asm):00216         
E7F6 6E9F009D         (  cmds_direct.asm):00217                         jmp             [BasExecAddr]                   ; Run the loaded code
                      (  cmds_direct.asm):00218         
E7FA                  (  cmds_direct.asm):00219         CmdMLoadBinExit         
E7FA 4F               (  cmds_direct.asm):00220                         clra
E7FB 39               (  cmds_direct.asm):00221                         rts                                                             ; restore / return
                      (  cmds_direct.asm):00222         
E7FC                  (  cmds_direct.asm):00223         CmdMloadRaw
E7FC BDE873           (  cmds_direct.asm):00224                         JSR             CmdMLoadSkipSendFName   ; skicp character, send filename
                      (  cmds_direct.asm):00225                         
E7FF 8180             (  cmds_direct.asm):00226                         cmpa    #STATUS_ERROR           ; Error ?
E801 10240049         (  cmds_direct.asm):00227                         lbhs    CmdMLoadError2                  ; Yes : flag it
                      (  cmds_direct.asm):00228         
E805 17FAF1           (  cmds_direct.asm):00229                         lbsr    CkComma                                 ; Is there a comma and load address?
E808 2644             (  cmds_direct.asm):00230                         bne             CmdMLoadError2
E80A 17FF57           (  cmds_direct.asm):00231                         lbsr    GetCommaThen16                  ; get new load address
                      (  cmds_direct.asm):00232                         
E80D 3410             (  cmds_direct.asm):00233                         pshs    x                                               ; save load address
                      (  cmds_direct.asm):00234                         
E80F 17FAE7           (  cmds_direct.asm):00235                         lbsr    CkComma                                 ; Is there a comma and byte count?
E812 263A             (  cmds_direct.asm):00236                         bne             CmdMLoadError2
E814 17FF4D           (  cmds_direct.asm):00237                         lbsr    GetCommaThen16                  ; get byte count
                      (  cmds_direct.asm):00238                         
E817 1F13             (  cmds_direct.asm):00239                         tfr             x,u                                             ; byte count to u
E819 3510             (  cmds_direct.asm):00240                         puls    x                                               ; recover load address
                      (  cmds_direct.asm):00241                         
E81B 1705EF           (  cmds_direct.asm):00242                         lbsr    MMC_LoadFile2                   ; Go load into memory
E81E 1704FB           (  cmds_direct.asm):00243                         lbsr    MMC_CloseFile                   ; close the file
                      (  cmds_direct.asm):00244         
E821 3542             (  cmds_direct.asm):00245                         puls    a,u                                             ; clean up stack
E823 4F               (  cmds_direct.asm):00246                         clra
E824 39               (  cmds_direct.asm):00247                         rts                                                             ; restore / return      
                      (  cmds_direct.asm):00248         
E825                  (  cmds_direct.asm):00249         CmdMLoadBas
E825 8D2F             (  cmds_direct.asm):00250                         bsr             LoadBasic                               ; load basic prog into memory
                      (  cmds_direct.asm):00251                                 
E827 9E19             (  cmds_direct.asm):00252                         ldx             <BasStartProg                   ; get base of loaded prog
E829 BD85EE           (  cmds_direct.asm):00253                         jsr             >BasSetProgPtrX                 ; setup
                      (  cmds_direct.asm):00254                         
E82C 9E27             (  cmds_direct.asm):00255                 ldx             <AddrFWareRamTop                ; get ramtop
E82E 9F23             (  cmds_direct.asm):00256                         stx             <BasVarStrTop                   ; set top of string area
E830 9E1B             (  cmds_direct.asm):00257                         ldx             <BasVarSimpleAddr               ; get simple vars addr
E832 9F1D             (  cmds_direct.asm):00258                         stx             <BasVarArrayAddr                ; set array vars to be the same
E834 9F1F             (  cmds_direct.asm):00259                         stx             <BasVarEnd                              ; set end of basic vars
                      (  cmds_direct.asm):00260                         
E836 BD8514           (  cmds_direct.asm):00261                         jsr             >CmdRestore                             ; do a restore
                      (  cmds_direct.asm):00262                 
E839 3269             (  cmds_direct.asm):00263                         leas    FileHeadLen,s                   ; cleanup stack frame
E83B 3542             (  cmds_direct.asm):00264                         puls    a,u                                             ; recover auto flag (a)
                      (  cmds_direct.asm):00265         
E83D BD8434           (  cmds_direct.asm):00266                         jsr             >BasResetStack                  ; reset the stack a preserved
                      (  cmds_direct.asm):00267                         
E840 8141             (  cmds_direct.asm):00268                         cmpa    #MLoadFlagAuto                  ; Auto run ?
E842 2604             (  cmds_direct.asm):00269                         bne             CmdMLoadBasExit                 ; nope : return to command mode
                      (  cmds_direct.asm):00270                         
E844 4F               (  cmds_direct.asm):00271                         clra    
E845 7E849F           (  cmds_direct.asm):00272                         jmp             BasRun                                  ; run it
                      (  cmds_direct.asm):00273         
E848                  (  cmds_direct.asm):00274         CmdMLoadBasExit
E848 4F               (  cmds_direct.asm):00275                         CLRA
E849 7E8371           (  cmds_direct.asm):00276                 JMP     >BasCmdMode
                      (  cmds_direct.asm):00277         
E84C                  (  cmds_direct.asm):00278         CmdMLoadError
E84C 3269             (  cmds_direct.asm):00279                         leas    FileHeadLen,s                   ; cleanup stack frame
E84E                  (  cmds_direct.asm):00280         CmdMLoadError2
E84E BDED1C           (  cmds_direct.asm):00281                         jsr             >MMC_CloseFile                  ; close the file
                      (  cmds_direct.asm):00282         
E851 3542             (  cmds_direct.asm):00283                         puls    a,u                                             ; recover auto flag (a)
                      (  cmds_direct.asm):00284         
E853 4F               (  cmds_direct.asm):00285                         clra                                                    ; flag error
E854 43               (  cmds_direct.asm):00286                         coma
E855 39               (  cmds_direct.asm):00287                         rts
                      (  cmds_direct.asm):00288                         
E856                  (  cmds_direct.asm):00289         LoadBasic
E856 EC44             (  cmds_direct.asm):00290                         ldd             HdrLen,u                                ; get file length
E858 D319             (  cmds_direct.asm):00291                         addd    <BasStartProg                   ; add start of basic text
E85A DD1F             (  cmds_direct.asm):00292                         std             <BasVarEnd                              ; set end of storage
                      (  cmds_direct.asm):00293                         
E85C C640             (  cmds_direct.asm):00294                         ldb             #$40                                    ; check to see there's enough memory
E85E BD8331           (  cmds_direct.asm):00295                         jsr             >BasChkB2Free
                      (  cmds_direct.asm):00296                 
E861 9E19             (  cmds_direct.asm):00297                         ldx             <BasStartProg                   ; get load address
E863 AF42             (  cmds_direct.asm):00298                         stx             HdrLoad,u                               ; save in header
                      (  cmds_direct.asm):00299                 
E865 17059D           (  cmds_direct.asm):00300                         lbsr    MMC_LoadFile                    ; load the file
E868 BD83ED           (  cmds_direct.asm):00301                         jsr             >BasVect2                               ; setup basic program 
                      (  cmds_direct.asm):00302                 
E86B 3002             (  cmds_direct.asm):00303                         leax    2,x                                             ; setup vars
E86D 9F1B             (  cmds_direct.asm):00304                         stx             <BasVarSimpleAddr
E86F 1704AA           (  cmds_direct.asm):00305                         lbsr    MMC_CloseFile                   ; close the file
E872 39               (  cmds_direct.asm):00306                         rts
                      (  cmds_direct.asm):00307         
                      (  cmds_direct.asm):00308         ;
                      (  cmds_direct.asm):00309         ; Skip first character send filename....
                      (  cmds_direct.asm):00310         ;
                      (  cmds_direct.asm):00311         
E873                  (  cmds_direct.asm):00312         CmdMLoadSkipSendFName
E873 9D9F             (  cmds_direct.asm):00313                         JSR     <BasChrGet                          ; skip the fist char
E875                  (  cmds_direct.asm):00314         CmdMLoadSendFName
E875 BDE2DF           (  cmds_direct.asm):00315                         JSR         >GetSendFileName            ; Get filename send to MMC
                      (  cmds_direct.asm):00316         
E878 8600             (  cmds_direct.asm):00317                         lda             #CAS_FILE                               ; open default file
E87A 17F7A4           (  cmds_direct.asm):00318                         lbsr    MMC_WaitPutLatchRead    ; send file id to latch register
                      (  cmds_direct.asm):00319                 
E87D 8611             (  cmds_direct.asm):00320                         lda             #CMD_FILE_OPEN_READ         ; Open file
E87F 17F78C           (  cmds_direct.asm):00321                         lbsr    MMC_SendCmd                     ; Open file
                      (  cmds_direct.asm):00322                 
E882 39               (  cmds_direct.asm):00323                 rts
                      (  cmds_direct.asm):00324                 
E883                  (  cmds_direct.asm):00325         CmdMLoadS
E883 BDE873           (  cmds_direct.asm):00326                 jsr     CmdMLoadSkipSendFName   ; get send filename
E886 2B05             (  cmds_direct.asm):00327                 bmi     CmdMLoadSError          ; error :exit
                      (  cmds_direct.asm):00328                         
E888 1A50             (  cmds_direct.asm):00329                 orcc    #(FlagFIRQ+FlagIRQ)             ; Make sure ints disabled
                      (  cmds_direct.asm):00330                 
E88A 160968           (  cmds_direct.asm):00331                 lbra    NMILoadEntry            ; file open, jump into snapshot load.
                      (  cmds_direct.asm):00332                 
E88D                  (  cmds_direct.asm):00333         CmdMLoadSError
E88D 3263             (  cmds_direct.asm):00334                 leas    3,s                     ; drop saved registers
E88F 39               (  cmds_direct.asm):00335                 rts
                      (  cmds_direct.asm):00336                         
                      (  cmds_direct.asm):00337         ;
                      (  cmds_direct.asm):00338         ; TestAutoBoot, test if auto-booting is enabled, and try to boot if it is.
                      (  cmds_direct.asm):00339         ;
                      (  cmds_direct.asm):00340         
E890                  (  cmds_direct.asm):00341         TestAutoBoot
E890 9676             (  cmds_direct.asm):00342                         lda             <CFGByte                                ; Get config byte
                      (  cmds_direct.asm):00343                         
E892 8440             (  cmds_direct.asm):00344                         anda    #CFG_ENABLE_AUTOBOOT    ; auto-boot enabled ?
E894 2723             (  cmds_direct.asm):00345                         beq             NoAutoBoot                              ; nope return
                      (  cmds_direct.asm):00346         
E896 308D0034         (  cmds_direct.asm):00347                         leax    AttemptBootMess,pcr             ; point at message
E89A BDEF9E           (  cmds_direct.asm):00348                         jsr             >CON_WriteString                ; print it
                      (  cmds_direct.asm):00349         
E89D 8D1C             (  cmds_direct.asm):00350                 bsr     AutoScanKbd             ; scan keyboard
E89F 8120             (  cmds_direct.asm):00351                         cmpa    #$20                                    ; space ?
E8A1 270F             (  cmds_direct.asm):00352                         beq             AutoBootAbort                   ; yep skip auto boot
                      (  cmds_direct.asm):00353         
E8A3 BDEF90           (  cmds_direct.asm):00354                         jsr             >CON_EOL
                      (  cmds_direct.asm):00355                         
                      (  cmds_direct.asm):00356                         ifdef   Dragon
E8A6 8616             (  cmds_direct.asm):00357                 lda     #CMD_FILE_OPENAUTOD     ; Change to root & Open AUTOEXEC, Dragon
                      (  cmds_direct.asm):00358                         else
                      (  cmds_direct.asm):00359                         lda             #CMD_FILE_OPENAUTOC     ; Change to root & Open AUTOEXEC, CoCo
                      (  cmds_direct.asm):00360                         endc
                      (  cmds_direct.asm):00361                         
E8A8 17F763           (  cmds_direct.asm):00362                         lbsr    MMC_SendCmd
                      (  cmds_direct.asm):00363                 
E8AB 8641             (  cmds_direct.asm):00364                         lda             #MLoadFlagAuto                  ; Auto boot 'flag'
E8AD 3442             (  cmds_direct.asm):00365                         pshs    u,a                                             ; stack them
                      (  cmds_direct.asm):00366                         
E8AF 16FEF9           (  cmds_direct.asm):00367                         lbra    CmdMloadAutoexec        ; Attempt to open / load
                      (  cmds_direct.asm):00368         
E8B2                  (  cmds_direct.asm):00369         AutoBootAbort
E8B2 308D0025         (  cmds_direct.asm):00370                         leax    AbortBootMess,pcr               ; point at message
E8B6 BDEF9E           (  cmds_direct.asm):00371                         jsr             >CON_WriteString                ; print it
                      (  cmds_direct.asm):00372                         
E8B9                  (  cmds_direct.asm):00373         NoAutoBoot
E8B9 4F               (  cmds_direct.asm):00374                         clra    
E8BA 39               (  cmds_direct.asm):00375                         rts
                      (  cmds_direct.asm):00376         
E8BB                  (  cmds_direct.asm):00377         AutoScanKbd
E8BB BE0112           (  cmds_direct.asm):00378                         ldx             SysTimeVal                              ; Get current timer
E8BE 308832           (  cmds_direct.asm):00379                         leax    AutoWaitTime,x                  ; Time to wait
                      (  cmds_direct.asm):00380                 
E8C1                  (  cmds_direct.asm):00381         PollAgain
E8C1 13               (  cmds_direct.asm):00382                 sync
E8C2 BD8006           (  cmds_direct.asm):00383                         jsr             >BasicKbdIn                             ; check keyboard
E8C5 2605             (  cmds_direct.asm):00384                         bne             AutoScanKbdExit                 ; key pressed, exit loop        
E8C7 BC0112           (  cmds_direct.asm):00385                 cmpx    SysTimeVal                              ; time reached value yet?
E8CA 24F5             (  cmds_direct.asm):00386                         bhs             PollAgain                               ; nope keep going       
                      (  cmds_direct.asm):00387         
E8CC                  (  cmds_direct.asm):00388         AutoScanKbdExit
E8CC 4D               (  cmds_direct.asm):00389                 tsta
E8CD 39               (  cmds_direct.asm):00390                 rts
                      (  cmds_direct.asm):00391                 
E8CE                  (  cmds_direct.asm):00392         AttemptBootMess 
E8CE 4155544F424F4F54 (  cmds_direct.asm):00393                         FCC             "AUTOBOOT...."
     2E2E2E2E
E8DA 00               (  cmds_direct.asm):00394                         FCB             $00
                      (  cmds_direct.asm):00395         
E8DB                  (  cmds_direct.asm):00396         AbortBootMess
E8DB 41424F525445442E (  cmds_direct.asm):00397                         FCC             "ABORTED."
E8E3 0D00             (  cmds_direct.asm):00398                         FCB             $0d,$00
                      (  cmds_direct.asm):00399         
E8E5                  (  cmds_direct.asm):00400         __cmd_direct_end
                      (    DragonMMC.asm):00667                         use             cmds_cart.asm
                      (    cmds_cart.asm):00001         ;
                      (    cmds_cart.asm):00002         ; cmds_cart, commands for loading carts.
                      (    cmds_cart.asm):00003         ; 
                      (    cmds_cart.asm):00004         
E8E5                  (    cmds_cart.asm):00005         __cmd_cart
                      (    cmds_cart.asm):00006         
E8E5                  (    cmds_cart.asm):00007         CmdCartLoad:
E8E5 8141             (    cmds_cart.asm):00008                         cmpa    #'A                                             ; is this a McartloadA ?
E8E7 2606             (    cmds_cart.asm):00009                         bne             CmdCartLoadNoAuto
E8E9 3402             (    cmds_cart.asm):00010                         pshs    a                                               ; save auto flag for later
E8EB 9D9F             (    cmds_cart.asm):00011                         JSR     <BasChrGet                              ; skip the A
                      (    cmds_cart.asm):00012                         
E8ED 2003             (    cmds_cart.asm):00013                         bra             CmdCartLoadOpen                 ; open the file
E8EF                  (    cmds_cart.asm):00014         CmdCartLoadNoAuto
E8EF 4F               (    cmds_cart.asm):00015                         clra                                                    ; flag not auto
E8F0 3402             (    cmds_cart.asm):00016                         pshs    a                                               ; save for later
                      (    cmds_cart.asm):00017         
E8F2                  (    cmds_cart.asm):00018         CmdCartLoadOpen
E8F2 17FB25           (    cmds_cart.asm):00019                         lbsr    CmdMRMountEntry                 ; Get filename and open for reading
E8F5 17FC49           (    cmds_cart.asm):00020                         lbsr    CmdRamBoot                              ; Copy Basic / Cart rom to ram
                      (    cmds_cart.asm):00021                         
E8F8 17FC5B           (    cmds_cart.asm):00022                 lbsr    GoROMMode               ; make sure we are in ROM, ram write enabled
                      (    cmds_cart.asm):00023                         
E8FB 8EC000           (    cmds_cart.asm):00024                         ldx             #$c000                                  ; point at cart rom base
                      (    cmds_cart.asm):00025         
E8FE                  (    cmds_cart.asm):00026         CmdCartLoadNext:
E8FE 4F               (    cmds_cart.asm):00027                         clra                                                    ; read 256 bytes
                      (    cmds_cart.asm):00028                         
E8FF 17042B           (    cmds_cart.asm):00029                         lbsr    MMC_ReadFCommon                 ; Tell AVR we want to read bytes
E902 5F               (    cmds_cart.asm):00030                         clrb
                      (    cmds_cart.asm):00031                                                 
E903                  (    cmds_cart.asm):00032         CmdCartLoadBlkLoop:
E903 170410           (    cmds_cart.asm):00033                         lbsr    MMC_WaitGetWritten              ; get the byte, returned in a
E906 A780             (    cmds_cart.asm):00034                         sta             ,x+                                             ; save in buffer
E908 5C               (    cmds_cart.asm):00035                         incb                                                    ; inc counter
E909 26F8             (    cmds_cart.asm):00036                         bne             CmdCartLoadBlkLoop              ; Get next byte
                      (    cmds_cart.asm):00037                         
E90B 8CFF00           (    cmds_cart.asm):00038                         cmpx    #$ff00                                  ; end of cart area ?
E90E 26EE             (    cmds_cart.asm):00039                         bne             CmdCartLoadNext                 ; nope do next block
                      (    cmds_cart.asm):00040                                 
E910 0F71             (    cmds_cart.asm):00041                         clr             WarmStartFlag                   ; make sure it's a cold boot
                      (    cmds_cart.asm):00042                         
E912 1A50             (    cmds_cart.asm):00043                         orcc    #FlagIRQ+FlagFIRQ               ; disable ints
                      (    cmds_cart.asm):00044                         
E914 CE01DA           (    cmds_cart.asm):00045                         ldu             #CasIOBuff                              ; Copy code to cas buffer
E917 308D0008         (    cmds_cart.asm):00046                         leax    CmdCartRAMCode,pcr              ; point to ram code
E91B C61E             (    cmds_cart.asm):00047                         ldb             #CmdCartRAMCodeLen              ; bytes to copy
E91D BDB7CC           (    cmds_cart.asm):00048                         jsr             UtilCopyBXtoU                   ; copy them
E920 7E01DA           (    cmds_cart.asm):00049                         jmp             CasIOBuff                               ; jump to called code
                      (    cmds_cart.asm):00050                         
                      (    cmds_cart.asm):00051                         
                      (    cmds_cart.asm):00052         ; This code has to be executed from outside the cart space as it pages
                      (    cmds_cart.asm):00053         ; the rom out. Though until the call is made to set the RAM_CTRL reg,
                      (    cmds_cart.asm):00054         ; we can still call ROM routines.
                      (    cmds_cart.asm):00055         
E923                  (    cmds_cart.asm):00056         CmdCartRAMCode:
                      (    cmds_cart.asm):00057         ;               lda     D_RAM_CTRL              ; get current control register
                      (    cmds_cart.asm):00058         
E923 BDE026           (    cmds_cart.asm):00059                         jsr             MMC_GetRAMCTRL          ; get current control register
E926 84BD             (    cmds_cart.asm):00060                 anda    #~(D_RAM_VEC+D_NMI_ENABLE)  ; Turn off NMI button as almost certainly will be wrong!
E928 8A11             (    cmds_cart.asm):00061                         ora             #D_RAM_ENABLE+D_RAM_WP  ; put us in ram mode, write protected.
E92A 6DE4             (    cmds_cart.asm):00062                 tst             ,s                                              ; test auto flag
E92C 2702             (    cmds_cart.asm):00063                         beq             CmdCartRAMNoAuto
E92E 8A04             (    cmds_cart.asm):00064                         ora             #D_FIRQ_ENABLE                  ; turn on FIRQ enable for auto-boot
E930                  (    cmds_cart.asm):00065         CmdCartRAMNoAuto:
E930 BDE021           (    cmds_cart.asm):00066                         jsr             MMC_WaitPutLatchRead    ; Put the new D_RAM_CTRL in the latch
                      (    cmds_cart.asm):00067                         
E933 86E9             (    cmds_cart.asm):00068                         lda             #CMD_SET_RAM_CTRL               ; Set it.
E935 B7FF50           (    cmds_cart.asm):00069                         sta             D_CMD_REG                               
E938                  (    cmds_cart.asm):00070         CmdCartWait             
E938 B6FF53           (    cmds_cart.asm):00071                         lda             D_STATUS_REG                    ; Wait for command to exec
E93B 2BFB             (    cmds_cart.asm):00072                         bmi             CmdCartWait
                      (    cmds_cart.asm):00073                                         
                      (    cmds_cart.asm):00074         ;               sta             D_RAM_CTRL                              ; set flags
E93D 6E9FFFFE         (    cmds_cart.asm):00075                         jmp             [HWVecReset]                    ; Reset machine !
E941                  (    cmds_cart.asm):00076         CmdCartRAMCodeEnd:
                      (    cmds_cart.asm):00077         
     001E             (    cmds_cart.asm):00078         CmdCartRAMCodeLen       equ             CmdCartRAMCodeEnd-CmdCartRAMCode
                      (    cmds_cart.asm):00079         
E941                  (    cmds_cart.asm):00080         __cmd_cart_end
                      (    DragonMMC.asm):00668                         use             cmds_retok.asm
                      (   cmds_retok.asm):00001         ;
                      (   cmds_retok.asm):00002         ; Retokenize basic between Dragon and CoCo
                      (   cmds_retok.asm):00003         ;
                      (   cmds_retok.asm):00004         ; Majority of code borrowed from MultiCartBoot.
                      (   cmds_retok.asm):00005         ;
                      (   cmds_retok.asm):00006         
E941                  (   cmds_retok.asm):00007         __cmd_retok
                      (   cmds_retok.asm):00008         
                      (   cmds_retok.asm):00009                 use     tokens.asm
                      (       tokens.asm):00001         ;
                      (       tokens.asm):00002         ; Dragon BASIC tokens.
                      (       tokens.asm):00003         ; 
                      (       tokens.asm):00004         
     0080             (       tokens.asm):00005         DgnFOR          equ     $80     
     0081             (       tokens.asm):00006         DgnGO           equ     $81     
     0082             (       tokens.asm):00007         DgnREM          equ     $82     
     0083             (       tokens.asm):00008         DgnREM2         equ     $83     
     0084             (       tokens.asm):00009         DgnELSE         equ     $84     
     0085             (       tokens.asm):00010         DgnIF           equ     $85     
     0086             (       tokens.asm):00011         DgnDATA         equ     $86     
     0087             (       tokens.asm):00012         DgnPRINT        equ     $87     
     0088             (       tokens.asm):00013         DgnON           equ     $88     
     0089             (       tokens.asm):00014         DgnINPUT        equ     $89     
     008A             (       tokens.asm):00015         DgnEND          equ     $8a     
     008B             (       tokens.asm):00016         DgnNEXT         equ     $8b     
     008C             (       tokens.asm):00017         DgnDIM          equ     $8c     
     008D             (       tokens.asm):00018         DgnREAD         equ     $8d     
     008E             (       tokens.asm):00019         DgnLET          equ     $8e     
     008F             (       tokens.asm):00020         DgnRUN          equ     $8f     
     0090             (       tokens.asm):00021         DgnRESTORE      equ     $90     
     0091             (       tokens.asm):00022         DgnRETURN       equ     $91     
     0092             (       tokens.asm):00023         DgnSTOP         equ     $92     
     0093             (       tokens.asm):00024         DgnPOKE         equ     $93     
     0094             (       tokens.asm):00025         DgnCONT         equ     $94     
     0095             (       tokens.asm):00026         DgnLIST         equ     $95     
     0096             (       tokens.asm):00027         DgnCLEAR        equ     $96     
     0097             (       tokens.asm):00028         DgnNEW          equ     $97     
     0098             (       tokens.asm):00029         DgnDEF          equ     $98     
     0099             (       tokens.asm):00030         DgnCLOAD        equ     $99     
     009A             (       tokens.asm):00031         DgnCSAVE        equ     $9a     
     009B             (       tokens.asm):00032         DgnOPEN         equ     $9b     
     009C             (       tokens.asm):00033         DgnCLOSE        equ     $9c     
     009D             (       tokens.asm):00034         DgnLLIST        equ     $9d     
     009E             (       tokens.asm):00035         DgnSET          equ     $9e     
     009F             (       tokens.asm):00036         DgnRESET        equ     $9f     
     00A0             (       tokens.asm):00037         DgnCLS          equ     $a0     
     00A1             (       tokens.asm):00038         DgnMOTOR        equ     $a1     
     00A2             (       tokens.asm):00039         DgnSOUND        equ     $a2     
     00A3             (       tokens.asm):00040         DgnAUDIO        equ     $a3     
     00A4             (       tokens.asm):00041         DgnEXEC         equ     $a4     
     00A5             (       tokens.asm):00042         DgnSKIPF        equ     $a5     
     00A6             (       tokens.asm):00043         DgnDEL          equ     $a6     
     00A7             (       tokens.asm):00044         DgnEDIT         equ     $a7     
     00A8             (       tokens.asm):00045         DgnTRON         equ     $a8     
     00A9             (       tokens.asm):00046         DgnTROFF        equ     $a9     
     00AA             (       tokens.asm):00047         DgnLINE         equ     $aa     
     00AB             (       tokens.asm):00048         DgnPCLS         equ     $ab     
     00AC             (       tokens.asm):00049         DgnPSET         equ     $ac     
     00AD             (       tokens.asm):00050         DgnPRESET       equ     $ad     
     00AE             (       tokens.asm):00051         DgnSCREEN       equ     $ae     
     00AF             (       tokens.asm):00052         DgnPCLEAR       equ     $af     
     00B0             (       tokens.asm):00053         DgnCOLOR        equ     $b0     
     00B1             (       tokens.asm):00054         DgnCIRCLE       equ     $b1     
     00B2             (       tokens.asm):00055         DgnPAINT        equ     $b2     
     00B3             (       tokens.asm):00056         DgnGET          equ     $b3     
     00B4             (       tokens.asm):00057         DgnPUT          equ     $b4     
     00B5             (       tokens.asm):00058         DgnDRAW         equ     $b5     
     00B6             (       tokens.asm):00059         DgnPCOPY        equ     $b6     
     00B7             (       tokens.asm):00060         DgnPMODE        equ     $b7     
     00B8             (       tokens.asm):00061         DgnPLAY         equ     $b8     
     00B9             (       tokens.asm):00062         DgnDLOAD        equ     $b9     
     00BA             (       tokens.asm):00063         DgnRENUM        equ     $ba     
     00BB             (       tokens.asm):00064         DgnTAB          equ     $bb     
     00BC             (       tokens.asm):00065         DgnTO           equ     $bc     
     00BD             (       tokens.asm):00066         DgnSUB          equ     $bd     
     00BE             (       tokens.asm):00067         DgnFN           equ     $be     
     00BF             (       tokens.asm):00068         DgnTHEN         equ     $bf     
     00C0             (       tokens.asm):00069         DgnNOT          equ     $c0     
     00C1             (       tokens.asm):00070         DgnSTEP         equ     $c1     
     00C2             (       tokens.asm):00071         DgnOFF          equ     $c2     
     00C3             (       tokens.asm):00072         DgnPlus         equ     $c3     
     00C4             (       tokens.asm):00073         DgnMinus        equ     $c4     
     00C5             (       tokens.asm):00074         DgnTimes        equ     $c5     
     00C6             (       tokens.asm):00075         DgnDivide       equ     $c6     
     00C7             (       tokens.asm):00076         DgnPower        equ     $c7     
     00C8             (       tokens.asm):00077         DgnAND          equ     $c8     
     00C9             (       tokens.asm):00078         DgnOR           equ     $c9     
     00CA             (       tokens.asm):00079         DgnGt           equ     $ca     
     00CB             (       tokens.asm):00080         DgnEq           equ     $cb     
     00CC             (       tokens.asm):00081         DgnLt           equ     $cc     
     00CD             (       tokens.asm):00082         DgnUSING        equ     $cd     
                      (       tokens.asm):00083         
                      (       tokens.asm):00084         ; DragonDOS command tokens
     00CE             (       tokens.asm):00085         DgnAUTO         equ     $ce     
     00CF             (       tokens.asm):00086         DgnBACKUP       equ     $cf     
     00D0             (       tokens.asm):00087         DgnBEEP         equ     $d0     
     00D1             (       tokens.asm):00088         DgnBOOT         equ     $d1     
     00D2             (       tokens.asm):00089         DgnCHAIN        equ     $d2     
     00D3             (       tokens.asm):00090         DgnCOPY         equ     $d3     
     00D4             (       tokens.asm):00091         DgnCREATE       equ     $d4     
     00D5             (       tokens.asm):00092         DgnDIR          equ     $d5     
     00D6             (       tokens.asm):00093         DgnDRIVE        equ     $d6     
     00D7             (       tokens.asm):00094         DgnDSKINIT      equ     $d7     
     00D8             (       tokens.asm):00095         DgnFREAD        equ     $d8     
     00D9             (       tokens.asm):00096         DgnFWRITE       equ     $d9     
     00DA             (       tokens.asm):00097         DgnERROR        equ     $da     
     00DB             (       tokens.asm):00098         DgnKILL         equ     $db     
     00DC             (       tokens.asm):00099         DgnLOAD         equ     $dc     
     00DD             (       tokens.asm):00100         DgnMERGE        equ     $dd     
     00DE             (       tokens.asm):00101         DgnPROTECT      equ     $de     
     00DF             (       tokens.asm):00102         DgnWAIT         equ     $df     
     00E0             (       tokens.asm):00103         DgnRENAME       equ     $e0     
     00E1             (       tokens.asm):00104         DgnSAVE         equ     $e1     
     00E2             (       tokens.asm):00105         DgnSREAD        equ     $e2     
     00E3             (       tokens.asm):00106         DgnSWRITE       equ     $e3     
     00E4             (       tokens.asm):00107         DgnVERIFY       equ     $e4     
     00E5             (       tokens.asm):00108         DgnFROM         equ     $e5     
     00E6             (       tokens.asm):00109         DgnFLREAD       equ     $e6     
     00E7             (       tokens.asm):00110         DgnSWAP         equ     $e7     
                      (       tokens.asm):00111         
                      (       tokens.asm):00112         ; Dragon DragonMMC Command tokens
                      (       tokens.asm):00113         
     00E8             (       tokens.asm):00114         DgnMCAS         equ     $e8
     00E9             (       tokens.asm):00115         DgnMMIRROR      equ     $e9
     00EA             (       tokens.asm):00116         DgnMMOUNT       equ     $ea
     00EB             (       tokens.asm):00117         DgnHELP         equ     $eb
     00EC             (       tokens.asm):00118         DgnRAMBOOT      equ     $ec
     00ED             (       tokens.asm):00119         DgnCAT          equ     $ed
     00EE             (       tokens.asm):00120         DgnMDELETE      equ     $ee
     00EF             (       tokens.asm):00121         DgnMSAVE        equ     $ef
     00F0             (       tokens.asm):00122         DgnMLOAD        equ     $f0
     00F1             (       tokens.asm):00123         DgnMCARTLOAD    equ     $f1
     00F2             (       tokens.asm):00124         DgnMTAPERUN     equ     $f2
     00F3             (       tokens.asm):00125         DgnCWD          equ     $f3
     00F4             (       tokens.asm):00126         DgnMSETCFG      equ     $f4
     00F5             (       tokens.asm):00127         DgnRETOK        equ     $f5
     00F6             (       tokens.asm):00128         DgnMDISK        equ     $f6
     00F7             (       tokens.asm):00129         DgnREWIND       equ     $f7
     00F8             (       tokens.asm):00130         DgnMSETDT       equ     $f8
     00F9             (       tokens.asm):00131         DgnMKDIR        equ     $f9
                      (       tokens.asm):00132                         
                      (       tokens.asm):00133         ;Dragon BASIC Function tokens - all proceeded by equ    $ff to differentiate from operators
     0080             (       tokens.asm):00134         DgnSGN          equ     $80     
     0081             (       tokens.asm):00135         DgnINT          equ     $81     
     0082             (       tokens.asm):00136         DgnABS          equ     $82     
     0083             (       tokens.asm):00137         DgnPOS          equ     $83     
     0084             (       tokens.asm):00138         DgnRND          equ     $84     
     0085             (       tokens.asm):00139         DgnSQR          equ     $85     
     0086             (       tokens.asm):00140         DgnLOG          equ     $86     
     0087             (       tokens.asm):00141         DgnEXP          equ     $87     
     0088             (       tokens.asm):00142         DgnSIN          equ     $88     
     0089             (       tokens.asm):00143         DgnCOS          equ     $89     
     008A             (       tokens.asm):00144         DgnTAN          equ     $8a     
     008B             (       tokens.asm):00145         DgnATN          equ     $8b     
     008C             (       tokens.asm):00146         DgnPEEK         equ     $8c     
     008D             (       tokens.asm):00147         DgnLEN          equ     $8d     
     008E             (       tokens.asm):00148         DgnSTRS         equ     $8e     
     008F             (       tokens.asm):00149         DgnVAL          equ     $8f     
     0090             (       tokens.asm):00150         DgnASC          equ     $90     
     0091             (       tokens.asm):00151         DgnCHRS         equ     $91     
     0092             (       tokens.asm):00152         DgnEOF          equ     $92     
     0093             (       tokens.asm):00153         DgnJOYSTK       equ     $93     
     0094             (       tokens.asm):00154         DgnFIX          equ     $94     
     0095             (       tokens.asm):00155         DgnHEXS         equ     $95     
     0096             (       tokens.asm):00156         DgnLEFTS        equ     $96     
     0097             (       tokens.asm):00157         DgnRIGHTS       equ     $97     
     0098             (       tokens.asm):00158         DgnMIDS         equ     $98     
     0099             (       tokens.asm):00159         DgnPOINT        equ     $99     
     009A             (       tokens.asm):00160         DgnINKEYS       equ     $9a     
     009B             (       tokens.asm):00161         DgnMEM          equ     $9b     
     009C             (       tokens.asm):00162         DgnVARPTR       equ     $9c     
     009D             (       tokens.asm):00163         DgnINSTR        equ     $9d     
     009E             (       tokens.asm):00164         DgnTIMER        equ     $9e     
     009F             (       tokens.asm):00165         DgnPPOINT       equ     $9f     
     00A0             (       tokens.asm):00166         DgnSTRINGS      equ     $a0     
     00A1             (       tokens.asm):00167         DgnUSR          equ     $a1     
                      (       tokens.asm):00168         
                      (       tokens.asm):00169         ; DragonDOS function tokens
     00A2             (       tokens.asm):00170         DgnLOF          equ     $a2     
     00A3             (       tokens.asm):00171         DgnFREE         equ     $a3     
     00A4             (       tokens.asm):00172         DgnERL          equ     $a4     
     00A5             (       tokens.asm):00173         DgnERR          equ     $a5     
     00A6             (       tokens.asm):00174         DgnHIMEM        equ     $a6     
     00A7             (       tokens.asm):00175         DgnLOC          equ     $a7     
     00A8             (       tokens.asm):00176         DgnFRES         equ     $a8     
                      (       tokens.asm):00177         
                      (       tokens.asm):00178         ;Dragon DragonMMC function tokens
                      (       tokens.asm):00179         
     00A9             (       tokens.asm):00180         DgnVER          equ     $a9
     00AA             (       tokens.asm):00181         DgnWDS          equ     $aa
     00AB             (       tokens.asm):00182         DgnFINDFIRSTS   equ     $ab
     00AC             (       tokens.asm):00183         DgnFINDNEXTS    equ     $ac
     00AD             (       tokens.asm):00184         DgnCFTYPE       equ     $ad
     00AE             (       tokens.asm):00185         DgnMGETCFG      equ     $ae
     00AF             (       tokens.asm):00186         DgnMGETDTS      equ     $af
     00B0             (       tokens.asm):00187         DgnMGETINAMES   equ     $b0
     00B1             (       tokens.asm):00188         DgnSDS          equ     $b1
                      (       tokens.asm):00189         
                      (       tokens.asm):00190         ; CoCo BASIC command tokens
                      (       tokens.asm):00191         
     0080             (       tokens.asm):00192         CoFOR           equ     $80
     0081             (       tokens.asm):00193         CoGO            equ     $81
     0082             (       tokens.asm):00194         CoREM           equ     $82
     0083             (       tokens.asm):00195         CoREM2          equ     $83
     0084             (       tokens.asm):00196         CoELSE          equ     $84
     0085             (       tokens.asm):00197         CoIF            equ     $85
     0086             (       tokens.asm):00198         CoDATA          equ     $86
     0087             (       tokens.asm):00199         CoPRINT         equ     $87
     0088             (       tokens.asm):00200         CoON            equ     $88
     0089             (       tokens.asm):00201         CoINPUT         equ     $89
     008A             (       tokens.asm):00202         CoEND           equ     $8a
     008B             (       tokens.asm):00203         CoNEXT          equ     $8b
     008C             (       tokens.asm):00204         CoDIM           equ     $8c
     008D             (       tokens.asm):00205         CoREAD          equ     $8d
     008E             (       tokens.asm):00206         CoRUN           equ     $8e
     008F             (       tokens.asm):00207         CoRESTORE       equ     $8f
     0090             (       tokens.asm):00208         CoRETURN        equ     $90
     0091             (       tokens.asm):00209         CoSTOP          equ     $91
     0092             (       tokens.asm):00210         CoPOKE          equ     $92
     0093             (       tokens.asm):00211         CoCONT          equ     $93
     0094             (       tokens.asm):00212         CoLIST          equ     $94
     0095             (       tokens.asm):00213         CoCLEAR         equ     $95
     0096             (       tokens.asm):00214         CoNEW           equ     $96
     0097             (       tokens.asm):00215         CoCLOAD         equ     $97
     0098             (       tokens.asm):00216         CoCSAVE         equ     $98
     0099             (       tokens.asm):00217         CoOPEN          equ     $99
     009A             (       tokens.asm):00218         CoCLOSE         equ     $9a
     009B             (       tokens.asm):00219         CoLLIST         equ     $9b
     009C             (       tokens.asm):00220         CoSET           equ     $9c
     009D             (       tokens.asm):00221         CoRESET         equ     $9d
     009E             (       tokens.asm):00222         CoCLS           equ     $9e
     009F             (       tokens.asm):00223         CoMOTOR         equ     $9f
     00A0             (       tokens.asm):00224         CoSOUND         equ     $a0
     00A1             (       tokens.asm):00225         CoAUDIO         equ     $a1
     00A2             (       tokens.asm):00226         CoEXEC          equ     $a2
     00A3             (       tokens.asm):00227         CoSKIPF         equ     $a3
     00A4             (       tokens.asm):00228         CoTAB           equ     $a4
     00A5             (       tokens.asm):00229         CoTO            equ     $a5
     00A6             (       tokens.asm):00230         CoSUB           equ     $a6
     00A7             (       tokens.asm):00231         CoTHEN          equ     $a7
     00A8             (       tokens.asm):00232         CoNOT           equ     $a8
     00A9             (       tokens.asm):00233         CoSTEP          equ     $a9
     00AA             (       tokens.asm):00234         CoOFF           equ     $aa
     00AB             (       tokens.asm):00235         CoPlus          equ     $ab
     00AC             (       tokens.asm):00236         CoMinus         equ     $ac
     00AD             (       tokens.asm):00237         CoTimes         equ     $ad
     00AE             (       tokens.asm):00238         CoDivide        equ     $ae
     00AF             (       tokens.asm):00239         CoPower         equ     $af
     00B0             (       tokens.asm):00240         CoAND           equ     $b0
     00B1             (       tokens.asm):00241         CoOR            equ     $b1
     00B2             (       tokens.asm):00242         CoGt            equ     $b2
     00B3             (       tokens.asm):00243         CoEq            equ     $b3
     00B4             (       tokens.asm):00244         CoLt            equ     $b4
     00B5             (       tokens.asm):00245         CoDEL           equ     $b5
     00B6             (       tokens.asm):00246         CoEDIT          equ     $b6
     00B7             (       tokens.asm):00247         CoTRON          equ     $b7
     00B8             (       tokens.asm):00248         CoTROFF         equ     $b8
     00B9             (       tokens.asm):00249         CoDEF           equ     $b9
     00BA             (       tokens.asm):00250         CoLET           equ     $ba
     00BB             (       tokens.asm):00251         CoLINE          equ     $bb
     00BC             (       tokens.asm):00252         CoPCLS          equ     $bc
     00BD             (       tokens.asm):00253         CoPSET          equ     $bd
     00BE             (       tokens.asm):00254         CoPRESET        equ     $be
     00BF             (       tokens.asm):00255         CoSCREEN        equ     $bf
     00C0             (       tokens.asm):00256         CoPCLEAR        equ     $c0
     00C1             (       tokens.asm):00257         CoCOLOR         equ     $c1
     00C2             (       tokens.asm):00258         CoCIRCLE        equ     $c2
     00C3             (       tokens.asm):00259         CoPAINT         equ     $c3
     00C4             (       tokens.asm):00260         CoGET           equ     $c4
     00C5             (       tokens.asm):00261         CoPUT           equ     $c5
     00C6             (       tokens.asm):00262         CoDRAW          equ     $c6
     00C7             (       tokens.asm):00263         CoPCOPY         equ     $c7
     00C8             (       tokens.asm):00264         CoPMODE         equ     $c8
     00C9             (       tokens.asm):00265         CoPLAY          equ     $c9
     00CA             (       tokens.asm):00266         CoDLOAD         equ     $ca
     00CB             (       tokens.asm):00267         CoRENUM         equ     $cb
     00CC             (       tokens.asm):00268         CoFN            equ     $cc
     00CD             (       tokens.asm):00269         CoUSING         equ     $cd
                      (       tokens.asm):00270         
                      (       tokens.asm):00271         ; RSDOS adds these .. (from Dragon User 12/84)
     00CE             (       tokens.asm):00272         CoDIR           equ     $ce
     00CF             (       tokens.asm):00273         CoDRIVE         equ     $cf
     00D0             (       tokens.asm):00274         CoFIELD         equ     $d0
     00D1             (       tokens.asm):00275         CoFILES         equ     $d1
     00D2             (       tokens.asm):00276         CoKILL          equ     $d2
     00D3             (       tokens.asm):00277         CoLOAD          equ     $d3
     00D4             (       tokens.asm):00278         CoLSET          equ     $d4
     00D5             (       tokens.asm):00279         CoMERGE         equ     $d5
     00D6             (       tokens.asm):00280         CoRENAME        equ     $d6
     00D7             (       tokens.asm):00281         CoRSET          equ     $d7
     00D8             (       tokens.asm):00282         CoSAVE          equ     $d8
     00D9             (       tokens.asm):00283         CoWRITE         equ     $d9
     00DA             (       tokens.asm):00284         CoVERIFY        equ     $da
     00DB             (       tokens.asm):00285         CoUNLOAD        equ     $db
     00DC             (       tokens.asm):00286         CoDSKINI        equ     $dc
     00DD             (       tokens.asm):00287         CoBACKUP        equ     $dd
     00DE             (       tokens.asm):00288         CoCOPY          equ     $de
     00DF             (       tokens.asm):00289         CoDSKIS         equ     $df
     00E0             (       tokens.asm):00290         CoDSKOS         equ     $e0
     00E1             (       tokens.asm):00291         CoDOS       equ $e1
                      (       tokens.asm):00292         
                      (       tokens.asm):00293         ; Dragon DragonMMC Command tokens
                      (       tokens.asm):00294         
     00E2             (       tokens.asm):00295         CoMCAS          equ     $e2
     00E3             (       tokens.asm):00296         CoMMIRROR       equ     $e3
     00E4             (       tokens.asm):00297         CoMMOUNT        equ     $e4
     00E5             (       tokens.asm):00298         CoHELP          equ     $e5
     00E6             (       tokens.asm):00299         CoRAMBOOT       equ     $e6
     00E7             (       tokens.asm):00300         CoCAT           equ     $e7
     00E8             (       tokens.asm):00301         CoMDELETE       equ     $e8
     00E9             (       tokens.asm):00302         CoMSAVE         equ     $e9
     00EA             (       tokens.asm):00303         CoMLOAD         equ     $ea
     00EB             (       tokens.asm):00304         CoMCARTLOAD     equ     $eb
     00EC             (       tokens.asm):00305         CoMTAPERUN      equ     $ec
     00ED             (       tokens.asm):00306         CoCWD           equ     $ed
     00EE             (       tokens.asm):00307         CoMSETCFG       equ     $ee
     00EF             (       tokens.asm):00308         CoRETOK         equ     $ef
     00F0             (       tokens.asm):00309         CoMDISK         equ     $f0
     00F1             (       tokens.asm):00310         CoREWIND        equ     $f1
     00F2             (       tokens.asm):00311         CoMSETDT        equ     $f2
     00F3             (       tokens.asm):00312         CoMKDIR         equ     $f3
                      (       tokens.asm):00313         
                      (       tokens.asm):00314         
                      (       tokens.asm):00315         ;Function tokens - all proceeded by $ff to differentiate from operators
                      (       tokens.asm):00316         ;Token  Keyword
     0080             (       tokens.asm):00317         CoSGN           equ     $80
     0081             (       tokens.asm):00318         CoINT           equ     $81
     0082             (       tokens.asm):00319         CoABS           equ     $82
     0083             (       tokens.asm):00320         CoUSR           equ     $83
     0084             (       tokens.asm):00321         CoRND           equ     $84
     0085             (       tokens.asm):00322         CoSIN           equ     $85
     0086             (       tokens.asm):00323         CoPEEK          equ     $86
     0087             (       tokens.asm):00324         CoLEN           equ     $87
     0088             (       tokens.asm):00325         CoSTRS          equ     $88
     0089             (       tokens.asm):00326         CoVAL           equ     $89
     008A             (       tokens.asm):00327         CoASC           equ     $8a
     008B             (       tokens.asm):00328         CoCHRS          equ     $8b
     008C             (       tokens.asm):00329         CoEOF           equ     $8c
     008D             (       tokens.asm):00330         CoJOYSTK        equ     $8d
     008E             (       tokens.asm):00331         CoLEFTS         equ     $8e
     008F             (       tokens.asm):00332         CoRIGHTS        equ     $8f
     0090             (       tokens.asm):00333         CoMIDS          equ     $90
     0091             (       tokens.asm):00334         CoPOINT         equ     $91
     0092             (       tokens.asm):00335         CoINKEYS        equ     $92
     0093             (       tokens.asm):00336         CoMEM           equ     $93
     0094             (       tokens.asm):00337         CoATN           equ     $94
     0095             (       tokens.asm):00338         CoCOS           equ     $95
     0096             (       tokens.asm):00339         CoTAN           equ     $96
     0097             (       tokens.asm):00340         CoEXP           equ     $97
     0098             (       tokens.asm):00341         CoFIX           equ     $98
     0099             (       tokens.asm):00342         CoLOG           equ     $99
     009A             (       tokens.asm):00343         CoPOS           equ     $9a
     009B             (       tokens.asm):00344         CoSQR           equ     $9b
     009C             (       tokens.asm):00345         CoHEXS          equ     $9c
     009D             (       tokens.asm):00346         CoVARPTR        equ     $9d
     009E             (       tokens.asm):00347         CoINSTR         equ     $9e
     009F             (       tokens.asm):00348         CoTIMER         equ     $9f
     00A0             (       tokens.asm):00349         CoPPOINT        equ     $a0
     00A1             (       tokens.asm):00350         CoSTRINGS       equ     $a1
                      (       tokens.asm):00351         
                      (       tokens.asm):00352         ; RSDOS adds these .. (from Dragon User 12/84)
     00A2             (       tokens.asm):00353         CoCVN           equ     $a2
     00A3             (       tokens.asm):00354         CoFREE          equ     $a3
     00A4             (       tokens.asm):00355         CoLOC           equ     $a4
     00A5             (       tokens.asm):00356         CoLOF           equ     $a5
     00A6             (       tokens.asm):00357         CoMKNS          equ     $a6
     00A7             (       tokens.asm):00358         CoAS            equ     $a7
                      (       tokens.asm):00359         
                      (       tokens.asm):00360         ; CoCo DragonMMC function tokens
                      (       tokens.asm):00361         
     00A8             (       tokens.asm):00362         CoVER           equ     $a8
     00A9             (       tokens.asm):00363         CoWDS           equ     $a9
     00AA             (       tokens.asm):00364         CoFINDFIRSTS    equ     $aa
     00AB             (       tokens.asm):00365         CoFINDNEXTS     equ     $ab
     00AC             (       tokens.asm):00366         CoCFTYPE        equ     $ac
     00AD             (       tokens.asm):00367         CoMGETCFG       equ     $ad
     00AE             (       tokens.asm):00368         CoMGETDTS       equ     $ae
     00AF             (       tokens.asm):00369         CoMGETINAMES    equ     $af
     00B0             (       tokens.asm):00370         CoSDS           equ     $b0
                      (   cmds_retok.asm):00010         
E941                  (   cmds_retok.asm):00011         CmdReTok:
E941 1F89             (   cmds_retok.asm):00012                         tfr             a,b                                     ; save next char
E943 9D9F             (   cmds_retok.asm):00013                         jsr             <BasChrGet                      ; skip the D or C
                      (   cmds_retok.asm):00014                         
E945 C144             (   cmds_retok.asm):00015                         cmpb    #'D                                     ; RetokD CoCo->Dragon ?
E947 2706             (   cmds_retok.asm):00016                         beq             CmdRetokToDragon        ; yep, do it
E949 C143             (   cmds_retok.asm):00017                         cmpb    #'C                                     ; RetokC Dragon->CoCo ?
E94B 2708             (   cmds_retok.asm):00018                         beq             CmdRetokToCoCo          ; yep, do it
E94D 4F               (   cmds_retok.asm):00019                         clra                                            ; no error
E94E 39               (   cmds_retok.asm):00020                         rts
                      (   cmds_retok.asm):00021         
                      (   cmds_retok.asm):00022         ; retokenize CoCo to Dragon.
E94F                  (   cmds_retok.asm):00023         CmdRetokToDragon:
E94F 308D004C         (   cmds_retok.asm):00024                         leax    TokCoCoToDragon,pcr     ; point at token tables
E953 2006             (   cmds_retok.asm):00025                         bra             DoRetok                         ; Retokenize
                      (   cmds_retok.asm):00026         
                      (   cmds_retok.asm):00027         ; retokenize Dragon to CoCo.
E955                  (   cmds_retok.asm):00028         CmdRetokToCoCo:
E955 308D0040         (   cmds_retok.asm):00029                         leax    TokDragonToCoCo,pcr     ; point at token tables
E959 2000             (   cmds_retok.asm):00030                         bra             DoRetok                         ; Retokenize
                      (   cmds_retok.asm):00031         
E95B                  (   cmds_retok.asm):00032         DoRetok
E95B 3410             (   cmds_retok.asm):00033                         pshs    x
E95D DE19             (   cmds_retok.asm):00034                         ldu             BasStartProg            ; Get start of basic 
                      (   cmds_retok.asm):00035                 
E95F                  (   cmds_retok.asm):00036         DoRetokNewLine
E95F 3344             (   cmds_retok.asm):00037                         leau    4,u                                     ; skip link & lineno
E961                  (   cmds_retok.asm):00038         RetokLoop
E961 A6C4             (   cmds_retok.asm):00039                         lda             ,u                                      ; get a byte
                      (   cmds_retok.asm):00040                 
E963 4D               (   cmds_retok.asm):00041                         tsta                                            ; Test a and set flags
E964 272A             (   cmds_retok.asm):00042                         beq             DoRetokEol                      ; end of line, check for end of code
                      (   cmds_retok.asm):00043                 
E966 2B04             (   cmds_retok.asm):00044                         bmi             LookupToken                     ; Token, yes process it
                      (   cmds_retok.asm):00045         
E968                  (   cmds_retok.asm):00046         RetokNextByte
E968 3341             (   cmds_retok.asm):00047                         leau    1,u                                     ; increment pointer
E96A 20F5             (   cmds_retok.asm):00048                         bra             RetokLoop                       ; do next
                      (   cmds_retok.asm):00049                 
E96C                  (   cmds_retok.asm):00050         LookupToken
E96C 81FF             (   cmds_retok.asm):00051                         cmpa    #$FF                            ; Check extended token flag
E96E 27F8             (   cmds_retok.asm):00052                         beq             RetokNextByte           ; yes : do next
                      (   cmds_retok.asm):00053                 
E970 847F             (   cmds_retok.asm):00054                         anda    #$7f                            ; Make token zero based
                      (   cmds_retok.asm):00055         
E972 AEE4             (   cmds_retok.asm):00056                 ldx             ,s                                      ; Pointer to pointer table
                      (   cmds_retok.asm):00057         
E974 E65F             (   cmds_retok.asm):00058                         ldb             -1,u                            ; Get previous byte
E976 C1FF             (   cmds_retok.asm):00059                         cmpb    #$FF                            ; Extended token flag ?
E978 2708             (   cmds_retok.asm):00060                         beq             DoExtended                      ; Yes do it
                      (   cmds_retok.asm):00061            
E97A A102             (   cmds_retok.asm):00062                         cmpa    2,x                 ; Token not one of ours?
E97C 24EA             (   cmds_retok.asm):00063                         bhs             RetokNextByte           ; if so ignore it
                      (   cmds_retok.asm):00064                 
E97E AE84             (   cmds_retok.asm):00065                         ldx             ,x                                      ; get normal function pointer
E980 2008             (   cmds_retok.asm):00066                         bra             DoTranslate                     ; skip
                      (   cmds_retok.asm):00067         
E982                  (   cmds_retok.asm):00068         DoExtended
E982 3003             (   cmds_retok.asm):00069                         leax    3,x                                     ; Point at extended token table
E984 A102             (   cmds_retok.asm):00070                         cmpa    2,x                 ; Token not one of ours?
E986 24E0             (   cmds_retok.asm):00071                         bhs             RetokNextByte           ; if so ignore it
E988 AE84             (   cmds_retok.asm):00072                 ldx     ,x                  ; Get function pointer 
                      (   cmds_retok.asm):00073                 
E98A                  (   cmds_retok.asm):00074         DoTranslate
E98A E686             (   cmds_retok.asm):00075                         ldb             a,x                                     ; get new token
E98C E7C4             (   cmds_retok.asm):00076                         stb             ,u                                      ; replace it
E98E 20D8             (   cmds_retok.asm):00077                         bra             RetokNextByte           ; do next
                      (   cmds_retok.asm):00078                 
E990                  (   cmds_retok.asm):00079         DoRetokEol
E990 3341             (   cmds_retok.asm):00080                         leau    1,u                                     ; increment pointer
E992 6DC4             (   cmds_retok.asm):00081                         tst             ,u                                      ; check for a second zero, marking end of program
E994 26C9             (   cmds_retok.asm):00082                         bne             DoRetokNewLine          ; no : do next line
E996 4F               (   cmds_retok.asm):00083                         clra                                            ; no error
E997 3590             (   cmds_retok.asm):00084                         puls    x,pc
                      (   cmds_retok.asm):00085         
                      (   cmds_retok.asm):00086         
                      (   cmds_retok.asm):00087         ;***********************************************
                      (   cmds_retok.asm):00088         ; Token translation tables for basic programs. *
                      (   cmds_retok.asm):00089         ;***********************************************
                      (   cmds_retok.asm):00090         
E999                  (   cmds_retok.asm):00091         TokDragonToCoCo
E999 E9A5             (   cmds_retok.asm):00092                 FDB     DragonCoCoCmd
E99B 7A               (   cmds_retok.asm):00093             FCB NoCommandsDgn
E99C EA1F             (   cmds_retok.asm):00094                 FDB     DragonCoCoFunc
E99E 32               (   cmds_retok.asm):00095             FCB NoFuncsDgn
                      (   cmds_retok.asm):00096                 
E99F                  (   cmds_retok.asm):00097         TokCoCoToDragon
E99F EA51             (   cmds_retok.asm):00098                 FDB     CoCoDragonCmd
E9A1 74               (   cmds_retok.asm):00099                 FCB NoCommandsCoCo
E9A2 EAC5             (   cmds_retok.asm):00100                 FDB     CoCoDragonFunc
E9A4 31               (   cmds_retok.asm):00101             FCB NoFuncsCoCo
                      (   cmds_retok.asm):00102         
                      (   cmds_retok.asm):00103         ;*****************
                      (   cmds_retok.asm):00104         ; Dragon to CoCo *
                      (   cmds_retok.asm):00105         ;*****************
                      (   cmds_retok.asm):00106         
E9A5                  (   cmds_retok.asm):00107         DragonCoCoCmd
E9A5 80               (   cmds_retok.asm):00108                 FCB     CoFOR
E9A6 81               (   cmds_retok.asm):00109                 FCB     CoGO
E9A7 82               (   cmds_retok.asm):00110                 FCB     CoREM
E9A8 83               (   cmds_retok.asm):00111                 FCB     CoREM2
E9A9 84               (   cmds_retok.asm):00112                 FCB     CoELSE
E9AA 85               (   cmds_retok.asm):00113                 FCB     CoIF
E9AB 86               (   cmds_retok.asm):00114                 FCB     CoDATA
E9AC 87               (   cmds_retok.asm):00115                 FCB     CoPRINT
E9AD 88               (   cmds_retok.asm):00116                 FCB     CoON
E9AE 89               (   cmds_retok.asm):00117                 FCB     CoINPUT
E9AF 8A               (   cmds_retok.asm):00118                 FCB     CoEND
E9B0 8B               (   cmds_retok.asm):00119                 FCB     CoNEXT
E9B1 8C               (   cmds_retok.asm):00120                 FCB     CoDIM
E9B2 8D               (   cmds_retok.asm):00121                 FCB     CoREAD
E9B3 BA               (   cmds_retok.asm):00122                 FCB     CoLET
E9B4 8E               (   cmds_retok.asm):00123                 FCB     CoRUN
E9B5 8F               (   cmds_retok.asm):00124                 FCB     CoRESTORE
E9B6 90               (   cmds_retok.asm):00125                 FCB     CoRETURN
E9B7 91               (   cmds_retok.asm):00126                 FCB     CoSTOP
E9B8 92               (   cmds_retok.asm):00127                 FCB     CoPOKE
E9B9 93               (   cmds_retok.asm):00128                 FCB     CoCONT
E9BA 94               (   cmds_retok.asm):00129                 FCB     CoLIST
E9BB 95               (   cmds_retok.asm):00130                 FCB     CoCLEAR
E9BC 96               (   cmds_retok.asm):00131                 FCB     CoNEW
E9BD B9               (   cmds_retok.asm):00132                 FCB     CoDEF
E9BE 97               (   cmds_retok.asm):00133                 FCB     CoCLOAD
E9BF 98               (   cmds_retok.asm):00134                 FCB     CoCSAVE
E9C0 99               (   cmds_retok.asm):00135                 FCB     CoOPEN
E9C1 9A               (   cmds_retok.asm):00136                 FCB     CoCLOSE
E9C2 9B               (   cmds_retok.asm):00137                 FCB     CoLLIST
E9C3 9C               (   cmds_retok.asm):00138                 FCB     CoSET
E9C4 9D               (   cmds_retok.asm):00139                 FCB     CoRESET
E9C5 9E               (   cmds_retok.asm):00140                 FCB     CoCLS
E9C6 9F               (   cmds_retok.asm):00141                 FCB     CoMOTOR
E9C7 A0               (   cmds_retok.asm):00142                 FCB     CoSOUND
E9C8 A1               (   cmds_retok.asm):00143                 FCB     CoAUDIO
E9C9 A2               (   cmds_retok.asm):00144                 FCB     CoEXEC
E9CA A3               (   cmds_retok.asm):00145                 FCB     CoSKIPF
E9CB B5               (   cmds_retok.asm):00146                 FCB     CoDEL
E9CC B6               (   cmds_retok.asm):00147                 FCB     CoEDIT
E9CD B7               (   cmds_retok.asm):00148                 FCB     CoTRON
E9CE B8               (   cmds_retok.asm):00149                 FCB     CoTROFF
E9CF BB               (   cmds_retok.asm):00150                 FCB     CoLINE
E9D0 BC               (   cmds_retok.asm):00151                 FCB     CoPCLS
E9D1 BD               (   cmds_retok.asm):00152                 FCB     CoPSET
E9D2 BE               (   cmds_retok.asm):00153                 FCB     CoPRESET
E9D3 BF               (   cmds_retok.asm):00154                 FCB     CoSCREEN
E9D4 C0               (   cmds_retok.asm):00155                 FCB     CoPCLEAR
E9D5 C1               (   cmds_retok.asm):00156                 FCB     CoCOLOR
E9D6 C2               (   cmds_retok.asm):00157                 FCB     CoCIRCLE
E9D7 C3               (   cmds_retok.asm):00158                 FCB     CoPAINT
E9D8 C4               (   cmds_retok.asm):00159                 FCB     CoGET
E9D9 C5               (   cmds_retok.asm):00160                 FCB     CoPUT
E9DA C6               (   cmds_retok.asm):00161                 FCB     CoDRAW
E9DB C7               (   cmds_retok.asm):00162                 FCB     CoPCOPY
E9DC C8               (   cmds_retok.asm):00163                 FCB     CoPMODE
E9DD C9               (   cmds_retok.asm):00164                 FCB     CoPLAY
E9DE CA               (   cmds_retok.asm):00165                 FCB     CoDLOAD
E9DF CB               (   cmds_retok.asm):00166                 FCB     CoRENUM
E9E0 A4               (   cmds_retok.asm):00167                 FCB     CoTAB
E9E1 A5               (   cmds_retok.asm):00168                 FCB     CoTO
E9E2 A6               (   cmds_retok.asm):00169                 FCB     CoSUB
E9E3 CC               (   cmds_retok.asm):00170                 FCB     CoFN
E9E4 A7               (   cmds_retok.asm):00171                 FCB     CoTHEN
E9E5 A8               (   cmds_retok.asm):00172                 FCB     CoNOT
E9E6 A9               (   cmds_retok.asm):00173                 FCB     CoSTEP
E9E7 AA               (   cmds_retok.asm):00174                 FCB     CoOFF
E9E8 AB               (   cmds_retok.asm):00175                 FCB     CoPlus
E9E9 AC               (   cmds_retok.asm):00176                 FCB     CoMinus
E9EA AD               (   cmds_retok.asm):00177                 FCB     CoTimes
E9EB AE               (   cmds_retok.asm):00178                 FCB     CoDivide
E9EC AF               (   cmds_retok.asm):00179                 FCB     CoPower
E9ED B0               (   cmds_retok.asm):00180                 FCB     CoAND
E9EE B1               (   cmds_retok.asm):00181                 FCB     CoOR
E9EF B2               (   cmds_retok.asm):00182                 FCB     CoGt
E9F0 B3               (   cmds_retok.asm):00183                 FCB     CoEq
E9F1 B4               (   cmds_retok.asm):00184                 FCB     CoLt
E9F2 CD               (   cmds_retok.asm):00185                 FCB     CoUSING
                      (   cmds_retok.asm):00186         
                      (   cmds_retok.asm):00187         ; DOS
                      (   cmds_retok.asm):00188                 
E9F3 82               (   cmds_retok.asm):00189                 FCB     CoREM
E9F4 DD               (   cmds_retok.asm):00190                 FCB     CoBACKUP
E9F5 82               (   cmds_retok.asm):00191                 FCB     CoREM
E9F6 E1               (   cmds_retok.asm):00192                 FCB     CoDOS
E9F7 82               (   cmds_retok.asm):00193                 FCB     CoREM
E9F8 DE               (   cmds_retok.asm):00194                 FCB     CoCOPY
E9F9 82               (   cmds_retok.asm):00195                 FCB     CoREM
E9FA CE               (   cmds_retok.asm):00196                 FCB     CoDIR
E9FB CF               (   cmds_retok.asm):00197                 FCB     CoDRIVE
E9FC DC               (   cmds_retok.asm):00198                 FCB     CoDSKINI
E9FD 82               (   cmds_retok.asm):00199                 FCB     CoREM
E9FE 82               (   cmds_retok.asm):00200                 FCB     CoREM
E9FF 82               (   cmds_retok.asm):00201                 FCB     CoREM
EA00 D2               (   cmds_retok.asm):00202                 FCB     CoKILL
EA01 D3               (   cmds_retok.asm):00203                 FCB     CoLOAD
EA02 D5               (   cmds_retok.asm):00204                 FCB     CoMERGE
EA03 82               (   cmds_retok.asm):00205                 FCB     CoREM
EA04 82               (   cmds_retok.asm):00206                 FCB     CoREM
EA05 D6               (   cmds_retok.asm):00207                 FCB     CoRENAME
EA06 D8               (   cmds_retok.asm):00208                 FCB     CoSAVE
EA07 DF               (   cmds_retok.asm):00209                 FCB     CoDSKIS 
EA08 E0               (   cmds_retok.asm):00210                 FCB     CoDSKOS         
EA09 DA               (   cmds_retok.asm):00211                 FCB     CoVERIFY
EA0A 82               (   cmds_retok.asm):00212                 FCB     CoREM 
EA0B 82               (   cmds_retok.asm):00213                 FCB     CoREM 
EA0C 82               (   cmds_retok.asm):00214                 FCB     CoREM 
                      (   cmds_retok.asm):00215                 
                      (   cmds_retok.asm):00216         ; MMC
                      (   cmds_retok.asm):00217                 
EA0D E2               (   cmds_retok.asm):00218                 FCB     CoMCAS
EA0E E3               (   cmds_retok.asm):00219                 FCB     CoMMIRROR
EA0F E4               (   cmds_retok.asm):00220                 FCB     CoMMOUNT
EA10 E5               (   cmds_retok.asm):00221                 FCB     CoHELP  
EA11 E6               (   cmds_retok.asm):00222                 FCB     CoRAMBOOT
EA12 E7               (   cmds_retok.asm):00223                 FCB     CoCAT   
EA13 E8               (   cmds_retok.asm):00224                 FCB     CoMDELETE
EA14 E9               (   cmds_retok.asm):00225                 FCB     CoMSAVE 
EA15 EA               (   cmds_retok.asm):00226                 FCB     CoMLOAD 
EA16 EB               (   cmds_retok.asm):00227                 FCB     CoMCARTLOAD
EA17 EC               (   cmds_retok.asm):00228                 FCB     CoMTAPERUN
EA18 ED               (   cmds_retok.asm):00229                 FCB     CoCWD   
EA19 EE               (   cmds_retok.asm):00230                 FCB     CoMSETCFG
EA1A EF               (   cmds_retok.asm):00231                 FCB     CoRETOK 
EA1B F0               (   cmds_retok.asm):00232                 FCB     CoMDISK 
EA1C F1               (   cmds_retok.asm):00233                 FCB     CoREWIND
EA1D F2               (   cmds_retok.asm):00234                 FCB     CoMSETDT
EA1E F3               (   cmds_retok.asm):00235                 FCB     CoMKDIR
EA1F                  (   cmds_retok.asm):00236         DragonCoCoCmdEnd
                      (   cmds_retok.asm):00237         
EA1F                  (   cmds_retok.asm):00238         DragonCoCoFunc
EA1F 80               (   cmds_retok.asm):00239                 FCB     CoSGN
EA20 81               (   cmds_retok.asm):00240                 FCB     CoINT
EA21 82               (   cmds_retok.asm):00241                 FCB     CoABS
EA22 9A               (   cmds_retok.asm):00242                 FCB     CoPOS
EA23 84               (   cmds_retok.asm):00243                 FCB     CoRND
EA24 9B               (   cmds_retok.asm):00244                 FCB     CoSQR
EA25 99               (   cmds_retok.asm):00245                 FCB     CoLOG
EA26 97               (   cmds_retok.asm):00246                 FCB     CoEXP
EA27 85               (   cmds_retok.asm):00247                 FCB     CoSIN
EA28 95               (   cmds_retok.asm):00248                 FCB     CoCOS
EA29 96               (   cmds_retok.asm):00249                 FCB     CoTAN
EA2A 94               (   cmds_retok.asm):00250                 FCB     CoATN
EA2B 86               (   cmds_retok.asm):00251                 FCB     CoPEEK
EA2C 87               (   cmds_retok.asm):00252                 FCB     CoLEN
EA2D 88               (   cmds_retok.asm):00253                 FCB     CoSTRS
EA2E 89               (   cmds_retok.asm):00254                 FCB     CoVAL
EA2F 8A               (   cmds_retok.asm):00255                 FCB     CoASC
EA30 8B               (   cmds_retok.asm):00256                 FCB     CoCHRS
EA31 8C               (   cmds_retok.asm):00257                 FCB     CoEOF
EA32 8D               (   cmds_retok.asm):00258                 FCB     CoJOYSTK
EA33 98               (   cmds_retok.asm):00259                 FCB     CoFIX
EA34 9C               (   cmds_retok.asm):00260                 FCB     CoHEXS
EA35 8E               (   cmds_retok.asm):00261                 FCB     CoLEFTS
EA36 8F               (   cmds_retok.asm):00262                 FCB     CoRIGHTS
EA37 90               (   cmds_retok.asm):00263                 FCB     CoMIDS
EA38 91               (   cmds_retok.asm):00264                 FCB     CoPOINT
EA39 92               (   cmds_retok.asm):00265                 FCB     CoINKEYS
EA3A 93               (   cmds_retok.asm):00266                 FCB     CoMEM
EA3B 9D               (   cmds_retok.asm):00267                 FCB     CoVARPTR
EA3C 9E               (   cmds_retok.asm):00268                 FCB     CoINSTR
EA3D 9F               (   cmds_retok.asm):00269                 FCB     CoTIMER
EA3E A0               (   cmds_retok.asm):00270                 FCB     CoPPOINT
EA3F A1               (   cmds_retok.asm):00271                 FCB     CoSTRINGS
EA40 83               (   cmds_retok.asm):00272                 FCB     CoUSR
                      (   cmds_retok.asm):00273         
                      (   cmds_retok.asm):00274         ; DOS
                      (   cmds_retok.asm):00275         
EA41 A5               (   cmds_retok.asm):00276                 FCB     CoLOF                   
EA42 A3               (   cmds_retok.asm):00277                 FCB     CoFREE                  
EA43 82               (   cmds_retok.asm):00278                 FCB     CoREM           ; DgnERL                        
EA44 82               (   cmds_retok.asm):00279                 FCB     CoREM           ; DgnERR                        
EA45 82               (   cmds_retok.asm):00280                 FCB     CoREM           ; DgnHIMEM              
EA46 A4               (   cmds_retok.asm):00281                 FCB     CoLOC                   
EA47 82               (   cmds_retok.asm):00282                 FCB     CoREM           ; DgnFRES                       
                      (   cmds_retok.asm):00283         
                      (   cmds_retok.asm):00284         ; MMC
                      (   cmds_retok.asm):00285         
EA48 A8               (   cmds_retok.asm):00286                 FCB     CoVER           
EA49 A9               (   cmds_retok.asm):00287                 FCB     CoWDS           
EA4A AA               (   cmds_retok.asm):00288                 FCB     CoFINDFIRSTS    
EA4B AB               (   cmds_retok.asm):00289                 FCB     CoFINDNEXTS     
EA4C AC               (   cmds_retok.asm):00290                 FCB     CoCFTYPE        
EA4D AD               (   cmds_retok.asm):00291                 FCB     CoMGETCFG       
EA4E AE               (   cmds_retok.asm):00292                 FCB     CoMGETDTS       
EA4F AF               (   cmds_retok.asm):00293                 FCB     CoMGETINAMES    
EA50 B0               (   cmds_retok.asm):00294                 FCB     CoSDS           
EA51                  (   cmds_retok.asm):00295         DragonCoCoFuncEnd
                      (   cmds_retok.asm):00296         
     007A             (   cmds_retok.asm):00297         NoCommandsDgn   EQU             DragonCoCoCmdEnd-DragonCoCoCmd
     0032             (   cmds_retok.asm):00298         NoFuncsDgn          EQU         DragonCoCoFuncEnd-DragonCoCoFunc
                      (   cmds_retok.asm):00299         
     007A             (   cmds_retok.asm):00300         NoCommands      EQU     NoCommandsDgn
     0032             (   cmds_retok.asm):00301         NoFuncs         EQU     NoFuncsDgn
                      (   cmds_retok.asm):00302         
                      (   cmds_retok.asm):00303         ;*****************
                      (   cmds_retok.asm):00304         ; CoCo to Dragon *
                      (   cmds_retok.asm):00305         ;*****************
                      (   cmds_retok.asm):00306         
EA51                  (   cmds_retok.asm):00307         CoCoDragonCmd
EA51 80               (   cmds_retok.asm):00308                 FCB     DgnFOR
EA52 81               (   cmds_retok.asm):00309                 FCB     DgnGO
EA53 82               (   cmds_retok.asm):00310                 FCB     DgnREM
EA54 83               (   cmds_retok.asm):00311                 FCB     DgnREM2
EA55 84               (   cmds_retok.asm):00312                 FCB     DgnELSE
EA56 85               (   cmds_retok.asm):00313                 FCB     DgnIF
EA57 86               (   cmds_retok.asm):00314                 FCB     DgnDATA
EA58 87               (   cmds_retok.asm):00315                 FCB     DgnPRINT
EA59 88               (   cmds_retok.asm):00316                 FCB     DgnON
EA5A 89               (   cmds_retok.asm):00317                 FCB     DgnINPUT
EA5B 8A               (   cmds_retok.asm):00318                 FCB     DgnEND
EA5C 8B               (   cmds_retok.asm):00319                 FCB     DgnNEXT
EA5D 8C               (   cmds_retok.asm):00320                 FCB     DgnDIM
EA5E 8D               (   cmds_retok.asm):00321                 FCB     DgnREAD
EA5F 8F               (   cmds_retok.asm):00322                 FCB     DgnRUN
EA60 90               (   cmds_retok.asm):00323                 FCB     DgnRESTORE
EA61 91               (   cmds_retok.asm):00324                 FCB     DgnRETURN
EA62 92               (   cmds_retok.asm):00325                 FCB     DgnSTOP
EA63 93               (   cmds_retok.asm):00326                 FCB     DgnPOKE
EA64 94               (   cmds_retok.asm):00327                 FCB     DgnCONT
EA65 95               (   cmds_retok.asm):00328                 FCB     DgnLIST
EA66 96               (   cmds_retok.asm):00329                 FCB     DgnCLEAR
EA67 97               (   cmds_retok.asm):00330                 FCB     DgnNEW
EA68 99               (   cmds_retok.asm):00331                 FCB     DgnCLOAD
EA69 9A               (   cmds_retok.asm):00332                 FCB     DgnCSAVE
EA6A 9B               (   cmds_retok.asm):00333                 FCB     DgnOPEN
EA6B 9C               (   cmds_retok.asm):00334                 FCB     DgnCLOSE
EA6C 9D               (   cmds_retok.asm):00335                 FCB     DgnLLIST
EA6D 9E               (   cmds_retok.asm):00336                 FCB     DgnSET
EA6E 9F               (   cmds_retok.asm):00337                 FCB     DgnRESET
EA6F A0               (   cmds_retok.asm):00338                 FCB     DgnCLS
EA70 A1               (   cmds_retok.asm):00339                 FCB     DgnMOTOR
EA71 A2               (   cmds_retok.asm):00340                 FCB     DgnSOUND
EA72 A3               (   cmds_retok.asm):00341                 FCB     DgnAUDIO
EA73 A4               (   cmds_retok.asm):00342                 FCB     DgnEXEC
EA74 A5               (   cmds_retok.asm):00343                 FCB     DgnSKIPF
EA75 BB               (   cmds_retok.asm):00344                 FCB     DgnTAB
EA76 BC               (   cmds_retok.asm):00345                 FCB     DgnTO
EA77 BD               (   cmds_retok.asm):00346                 FCB     DgnSUB
EA78 BF               (   cmds_retok.asm):00347                 FCB     DgnTHEN
EA79 C0               (   cmds_retok.asm):00348                 FCB     DgnNOT
EA7A C1               (   cmds_retok.asm):00349                 FCB     DgnSTEP
EA7B C2               (   cmds_retok.asm):00350                 FCB     DgnOFF
EA7C C3               (   cmds_retok.asm):00351                 FCB     DgnPlus
EA7D C4               (   cmds_retok.asm):00352                 FCB     DgnMinus
EA7E C5               (   cmds_retok.asm):00353                 FCB     DgnTimes
EA7F C6               (   cmds_retok.asm):00354                 FCB     DgnDivide
EA80 C7               (   cmds_retok.asm):00355                 FCB     DgnPower
EA81 C8               (   cmds_retok.asm):00356                 FCB     DgnAND
EA82 C9               (   cmds_retok.asm):00357                 FCB     DgnOR
EA83 CA               (   cmds_retok.asm):00358                 FCB     DgnGt
EA84 CB               (   cmds_retok.asm):00359                 FCB     DgnEq
EA85 CC               (   cmds_retok.asm):00360                 FCB     DgnLt
EA86 A6               (   cmds_retok.asm):00361                 FCB     DgnDEL
EA87 A7               (   cmds_retok.asm):00362                 FCB     DgnEDIT
EA88 A8               (   cmds_retok.asm):00363                 FCB     DgnTRON
EA89 A9               (   cmds_retok.asm):00364                 FCB     DgnTROFF
EA8A 98               (   cmds_retok.asm):00365                 FCB     DgnDEF
EA8B 8E               (   cmds_retok.asm):00366                 FCB     DgnLET
EA8C AA               (   cmds_retok.asm):00367                 FCB     DgnLINE
EA8D AB               (   cmds_retok.asm):00368                 FCB     DgnPCLS
EA8E AC               (   cmds_retok.asm):00369                 FCB     DgnPSET
EA8F AD               (   cmds_retok.asm):00370                 FCB     DgnPRESET
EA90 AE               (   cmds_retok.asm):00371                 FCB     DgnSCREEN
EA91 AF               (   cmds_retok.asm):00372                 FCB     DgnPCLEAR
EA92 B0               (   cmds_retok.asm):00373                 FCB     DgnCOLOR
EA93 B1               (   cmds_retok.asm):00374                 FCB     DgnCIRCLE
EA94 B2               (   cmds_retok.asm):00375                 FCB     DgnPAINT
EA95 B3               (   cmds_retok.asm):00376                 FCB     DgnGET
EA96 B4               (   cmds_retok.asm):00377                 FCB     DgnPUT
EA97 B5               (   cmds_retok.asm):00378                 FCB     DgnDRAW
EA98 B6               (   cmds_retok.asm):00379                 FCB     DgnPCOPY
EA99 B7               (   cmds_retok.asm):00380                 FCB     DgnPMODE
EA9A B8               (   cmds_retok.asm):00381                 FCB     DgnPLAY
EA9B B9               (   cmds_retok.asm):00382                 FCB     DgnDLOAD
EA9C BA               (   cmds_retok.asm):00383                 FCB     DgnRENUM
EA9D BE               (   cmds_retok.asm):00384                 FCB     DgnFN
EA9E CD               (   cmds_retok.asm):00385                 FCB     DgnUSING
                      (   cmds_retok.asm):00386         
                      (   cmds_retok.asm):00387         ;DOS
EA9F D5               (   cmds_retok.asm):00388                 FCB     DgnDIR
EAA0 D6               (   cmds_retok.asm):00389                 FCB     DgnDRIVE
EAA1 82               (   cmds_retok.asm):00390                 FCB     DgnREM          ; CoFIELD
EAA2 82               (   cmds_retok.asm):00391                 FCB     DgnREM          ; CoFILES
EAA3 DB               (   cmds_retok.asm):00392                 FCB     DgnKILL
EAA4 DC               (   cmds_retok.asm):00393                 FCB     DgnLOAD
EAA5 82               (   cmds_retok.asm):00394                 FCB     DgnREM          ; CoLSET
EAA6 DD               (   cmds_retok.asm):00395                 FCB     DgnMERGE
EAA7 E0               (   cmds_retok.asm):00396                 FCB     DgnRENAME
EAA8 82               (   cmds_retok.asm):00397                 FCB     DgnREM          ; CoRSET
EAA9 E1               (   cmds_retok.asm):00398                 FCB     DgnSAVE
EAAA 82               (   cmds_retok.asm):00399                 FCB     DgnREM          ; CoWRITE
EAAB E4               (   cmds_retok.asm):00400                 FCB     DgnVERIFY
EAAC 82               (   cmds_retok.asm):00401                 FCB     DgnREM          ; CoUNLOAD
EAAD D7               (   cmds_retok.asm):00402                 FCB     DgnDSKINIT
EAAE CF               (   cmds_retok.asm):00403                 FCB     DgnBACKUP
EAAF D3               (   cmds_retok.asm):00404                 FCB     DgnCOPY
EAB0 E2               (   cmds_retok.asm):00405                 FCB     DgnSREAD        ; CoDSKIS
EAB1 E3               (   cmds_retok.asm):00406                 FCB     DgnSWRITE       ; CoDSKOS
EAB2 D1               (   cmds_retok.asm):00407                 FCB DgnBOOT     ; CoDOS
                      (   cmds_retok.asm):00408             
                      (   cmds_retok.asm):00409         ; MMC
EAB3 E8               (   cmds_retok.asm):00410                 FCB     DgnMCAS         
EAB4 E9               (   cmds_retok.asm):00411                 FCB     DgnMMIRROR      
EAB5 EA               (   cmds_retok.asm):00412                 FCB     DgnMMOUNT       
EAB6 EB               (   cmds_retok.asm):00413                 FCB     DgnHELP         
EAB7 EC               (   cmds_retok.asm):00414                 FCB     DgnRAMBOOT      
EAB8 ED               (   cmds_retok.asm):00415                 FCB     DgnCAT          
EAB9 EE               (   cmds_retok.asm):00416                 FCB     DgnMDELETE      
EABA EF               (   cmds_retok.asm):00417                 FCB     DgnMSAVE        
EABB F0               (   cmds_retok.asm):00418                 FCB     DgnMLOAD        
EABC F1               (   cmds_retok.asm):00419                 FCB     DgnMCARTLOAD    
EABD F2               (   cmds_retok.asm):00420                 FCB     DgnMTAPERUN     
EABE F3               (   cmds_retok.asm):00421                 FCB     DgnCWD          
EABF F4               (   cmds_retok.asm):00422                 FCB     DgnMSETCFG      
EAC0 F5               (   cmds_retok.asm):00423                 FCB     DgnRETOK        
EAC1 F6               (   cmds_retok.asm):00424                 FCB     DgnMDISK        
EAC2 F7               (   cmds_retok.asm):00425                 FCB     DgnREWIND       
EAC3 F8               (   cmds_retok.asm):00426                 FCB     DgnMSETDT       
EAC4 F9               (   cmds_retok.asm):00427                 FCB     DgnMKDIR        
EAC5                  (   cmds_retok.asm):00428         CoCoDragonCmdEnd
                      (   cmds_retok.asm):00429         
                      (   cmds_retok.asm):00430         ;       FILL    DgnREM,(NoCommandsDgn-NoCommandsCoCo)
                      (   cmds_retok.asm):00431         
                      (   cmds_retok.asm):00432                 
EAC5                  (   cmds_retok.asm):00433         CoCoDragonFunc
EAC5 80               (   cmds_retok.asm):00434                 FCB     DgnSGN
EAC6 81               (   cmds_retok.asm):00435                 FCB     DgnINT
EAC7 82               (   cmds_retok.asm):00436                 FCB     DgnABS
EAC8 A1               (   cmds_retok.asm):00437                 FCB     DgnUSR
EAC9 84               (   cmds_retok.asm):00438                 FCB     DgnRND
EACA 88               (   cmds_retok.asm):00439                 FCB     DgnSIN
EACB 8C               (   cmds_retok.asm):00440                 FCB     DgnPEEK
EACC 8D               (   cmds_retok.asm):00441                 FCB     DgnLEN
EACD 8E               (   cmds_retok.asm):00442                 FCB     DgnSTRS
EACE 8F               (   cmds_retok.asm):00443                 FCB     DgnVAL
EACF 90               (   cmds_retok.asm):00444                 FCB     DgnASC
EAD0 91               (   cmds_retok.asm):00445                 FCB     DgnCHRS
EAD1 92               (   cmds_retok.asm):00446                 FCB     DgnEOF
EAD2 93               (   cmds_retok.asm):00447                 FCB     DgnJOYSTK
EAD3 96               (   cmds_retok.asm):00448                 FCB     DgnLEFTS
EAD4 97               (   cmds_retok.asm):00449                 FCB     DgnRIGHTS
EAD5 98               (   cmds_retok.asm):00450                 FCB     DgnMIDS
EAD6 99               (   cmds_retok.asm):00451                 FCB     DgnPOINT
EAD7 9A               (   cmds_retok.asm):00452                 FCB     DgnINKEYS
EAD8 9B               (   cmds_retok.asm):00453                 FCB     DgnMEM
EAD9 8B               (   cmds_retok.asm):00454                 FCB     DgnATN
EADA 89               (   cmds_retok.asm):00455                 FCB     DgnCOS
EADB 8A               (   cmds_retok.asm):00456                 FCB     DgnTAN
EADC 87               (   cmds_retok.asm):00457                 FCB     DgnEXP
EADD 94               (   cmds_retok.asm):00458                 FCB     DgnFIX
EADE 86               (   cmds_retok.asm):00459                 FCB     DgnLOG
EADF 83               (   cmds_retok.asm):00460                 FCB     DgnPOS
EAE0 85               (   cmds_retok.asm):00461                 FCB     DgnSQR
EAE1 95               (   cmds_retok.asm):00462                 FCB     DgnHEXS
EAE2 9C               (   cmds_retok.asm):00463                 FCB     DgnVARPTR
EAE3 9D               (   cmds_retok.asm):00464                 FCB     DgnINSTR
EAE4 9E               (   cmds_retok.asm):00465                 FCB     DgnTIMER
EAE5 9F               (   cmds_retok.asm):00466                 FCB     DgnPPOINT
EAE6 A0               (   cmds_retok.asm):00467                 FCB     DgnSTRINGS
                      (   cmds_retok.asm):00468         
                      (   cmds_retok.asm):00469         ; DOS
EAE7 82               (   cmds_retok.asm):00470                 FCB     DgnREM          ; CoCVN
EAE8 A3               (   cmds_retok.asm):00471                 FCB     DgnFREE
EAE9 A7               (   cmds_retok.asm):00472                 FCB     DgnLOC
EAEA A2               (   cmds_retok.asm):00473                 FCB     DgnLOF
EAEB 82               (   cmds_retok.asm):00474                 FCB     DgnREM          ; CoMKNS
EAEC 82               (   cmds_retok.asm):00475                 FCB     DgnREM          ; CoAS
                      (   cmds_retok.asm):00476         
                      (   cmds_retok.asm):00477         ; MMC
EAED A9               (   cmds_retok.asm):00478                 FCB     DgnVER          
EAEE AA               (   cmds_retok.asm):00479                 FCB     DgnWDS          
EAEF AB               (   cmds_retok.asm):00480                 FCB     DgnFINDFIRSTS   
EAF0 AC               (   cmds_retok.asm):00481                 FCB     DgnFINDNEXTS    
EAF1 AD               (   cmds_retok.asm):00482                 FCB     DgnCFTYPE       
EAF2 AE               (   cmds_retok.asm):00483                 FCB     DgnMGETCFG      
EAF3 AF               (   cmds_retok.asm):00484                 FCB     DgnMGETDTS      
EAF4 B0               (   cmds_retok.asm):00485                 FCB     DgnMGETINAMES   
EAF5 B1               (   cmds_retok.asm):00486                 FCB     DgnSDS          
                      (   cmds_retok.asm):00487                 
EAF6                  (   cmds_retok.asm):00488         CoCoDragonFuncEnd
                      (   cmds_retok.asm):00489                 
                      (   cmds_retok.asm):00490         ;    FILL       DgnREM,(NoFuncsDgn-NoFuncsCoCo)
                      (   cmds_retok.asm):00491         
     0074             (   cmds_retok.asm):00492         NoCommandsCoCo  EQU     CoCoDragonCmdEnd-CoCoDragonCmd
     0031             (   cmds_retok.asm):00493         NoFuncsCoCo         EQU CoCoDragonFuncEnd-CoCoDragonFunc
                      (   cmds_retok.asm):00494         
                      (   cmds_retok.asm):00495         
                      (   cmds_retok.asm):00496             ifne    0
EAF6                  (   cmds_retok.asm):00497         DragonCoCoCmd
                      (   cmds_retok.asm):00498                 FCB     $80
                      (   cmds_retok.asm):00499                 FCB     $81
                      (   cmds_retok.asm):00500                 FCB     $82
                      (   cmds_retok.asm):00501                 FCB     $83
                      (   cmds_retok.asm):00502                 FCB     $84
                      (   cmds_retok.asm):00503                 FCB     $85
                      (   cmds_retok.asm):00504                 FCB     $86
                      (   cmds_retok.asm):00505                 FCB     $87
                      (   cmds_retok.asm):00506                 FCB     $88
                      (   cmds_retok.asm):00507                 FCB     $89
                      (   cmds_retok.asm):00508                 FCB     $8a
                      (   cmds_retok.asm):00509                 FCB     $8b
                      (   cmds_retok.asm):00510                 FCB     $8c
                      (   cmds_retok.asm):00511                 FCB     $8d
                      (   cmds_retok.asm):00512                 FCB     $ba
                      (   cmds_retok.asm):00513                 FCB     $8e
                      (   cmds_retok.asm):00514                 FCB     $8f
                      (   cmds_retok.asm):00515                 FCB     $90
                      (   cmds_retok.asm):00516                 FCB     $91
                      (   cmds_retok.asm):00517                 FCB     $92
                      (   cmds_retok.asm):00518                 FCB     $93
                      (   cmds_retok.asm):00519                 FCB     $94
                      (   cmds_retok.asm):00520                 FCB     $95
                      (   cmds_retok.asm):00521                 FCB     $96
                      (   cmds_retok.asm):00522                 FCB     $b9
                      (   cmds_retok.asm):00523                 FCB     $97
                      (   cmds_retok.asm):00524                 FCB     $98
                      (   cmds_retok.asm):00525                 FCB     $99
                      (   cmds_retok.asm):00526                 FCB     $9a
                      (   cmds_retok.asm):00527                 FCB     $9b
                      (   cmds_retok.asm):00528                 FCB     $9c
                      (   cmds_retok.asm):00529                 FCB     $9d
                      (   cmds_retok.asm):00530                 FCB     $9e
                      (   cmds_retok.asm):00531                 FCB     $9f
                      (   cmds_retok.asm):00532                 FCB     $a0
                      (   cmds_retok.asm):00533                 FCB     $a1
                      (   cmds_retok.asm):00534                 FCB     $a2
                      (   cmds_retok.asm):00535                 FCB     $a3
                      (   cmds_retok.asm):00536                 FCB     $b5
                      (   cmds_retok.asm):00537                 FCB     $b6
                      (   cmds_retok.asm):00538                 FCB     $b7
                      (   cmds_retok.asm):00539                 FCB     $b8
                      (   cmds_retok.asm):00540                 FCB     $bb
                      (   cmds_retok.asm):00541                 FCB     $bc
                      (   cmds_retok.asm):00542                 FCB     $bd
                      (   cmds_retok.asm):00543                 FCB     $be
                      (   cmds_retok.asm):00544                 FCB     $bf
                      (   cmds_retok.asm):00545                 FCB     $c0
                      (   cmds_retok.asm):00546                 FCB     $c1
                      (   cmds_retok.asm):00547                 FCB     $c2
                      (   cmds_retok.asm):00548                 FCB     $c3
                      (   cmds_retok.asm):00549                 FCB     $c4
                      (   cmds_retok.asm):00550                 FCB     $c5
                      (   cmds_retok.asm):00551                 FCB     $c6
                      (   cmds_retok.asm):00552                 FCB     $c7
                      (   cmds_retok.asm):00553                 FCB     $c8
                      (   cmds_retok.asm):00554                 FCB     $c9
                      (   cmds_retok.asm):00555                 FCB     $ca
                      (   cmds_retok.asm):00556                 FCB     $cb
                      (   cmds_retok.asm):00557                 FCB     $a4
                      (   cmds_retok.asm):00558                 FCB     $a5
                      (   cmds_retok.asm):00559                 FCB     $a6
                      (   cmds_retok.asm):00560                 FCB     $cc
                      (   cmds_retok.asm):00561                 FCB     $a7
                      (   cmds_retok.asm):00562                 FCB     $a8
                      (   cmds_retok.asm):00563                 FCB     $a9
                      (   cmds_retok.asm):00564                 FCB     $aa
                      (   cmds_retok.asm):00565                 FCB     $ab
                      (   cmds_retok.asm):00566                 FCB     $ac
                      (   cmds_retok.asm):00567                 FCB     $ad
                      (   cmds_retok.asm):00568                 FCB     $ae
                      (   cmds_retok.asm):00569                 FCB     $af
                      (   cmds_retok.asm):00570                 FCB     $b0
                      (   cmds_retok.asm):00571                 FCB     $b1
                      (   cmds_retok.asm):00572                 FCB     $b2
                      (   cmds_retok.asm):00573                 FCB     $b3
                      (   cmds_retok.asm):00574                 FCB     $b4
                      (   cmds_retok.asm):00575                 FCB     $cd
EAF6                  (   cmds_retok.asm):00576         DragonCoCoCmdEnd
                      (   cmds_retok.asm):00577         
EAF6                  (   cmds_retok.asm):00578         DragonCoCoFunc
                      (   cmds_retok.asm):00579                 FCB     $80
                      (   cmds_retok.asm):00580                 FCB     $81
                      (   cmds_retok.asm):00581                 FCB     $82
                      (   cmds_retok.asm):00582                 FCB     $9a
                      (   cmds_retok.asm):00583                 FCB     $84
                      (   cmds_retok.asm):00584                 FCB     $9b
                      (   cmds_retok.asm):00585                 FCB     $99
                      (   cmds_retok.asm):00586                 FCB     $97
                      (   cmds_retok.asm):00587                 FCB     $85
                      (   cmds_retok.asm):00588                 FCB     $95
                      (   cmds_retok.asm):00589                 FCB     $96
                      (   cmds_retok.asm):00590                 FCB     $94
                      (   cmds_retok.asm):00591                 FCB     $86
                      (   cmds_retok.asm):00592                 FCB     $87
                      (   cmds_retok.asm):00593                 FCB     $88
                      (   cmds_retok.asm):00594                 FCB     $89
                      (   cmds_retok.asm):00595                 FCB     $8a
                      (   cmds_retok.asm):00596                 FCB     $8b
                      (   cmds_retok.asm):00597                 FCB     $8c
                      (   cmds_retok.asm):00598                 FCB     $8d
                      (   cmds_retok.asm):00599                 FCB     $98
                      (   cmds_retok.asm):00600                 FCB     $9c
                      (   cmds_retok.asm):00601                 FCB     $8e
                      (   cmds_retok.asm):00602                 FCB     $8f
                      (   cmds_retok.asm):00603                 FCB     $90
                      (   cmds_retok.asm):00604                 FCB     $91
                      (   cmds_retok.asm):00605                 FCB     $92
                      (   cmds_retok.asm):00606                 FCB     $93
                      (   cmds_retok.asm):00607                 FCB     $9d
                      (   cmds_retok.asm):00608                 FCB     $9e
                      (   cmds_retok.asm):00609                 FCB     $9f
                      (   cmds_retok.asm):00610                 FCB     $a0
                      (   cmds_retok.asm):00611                 FCB     $a1
                      (   cmds_retok.asm):00612                 FCB     $83
EAF6                  (   cmds_retok.asm):00613         DragonCoCoFuncEnd
                      (   cmds_retok.asm):00614         
EAF6                  (   cmds_retok.asm):00615         NoCommands      EQU             DragonCoCoCmdEnd-DragonCoCoCmd
EAF6                  (   cmds_retok.asm):00616         NoFuncs         EQU             DragonCoCoFuncEnd-DragonCoCoFunc
                      (   cmds_retok.asm):00617         
                      (   cmds_retok.asm):00618         ;*****************
                      (   cmds_retok.asm):00619         ; CoCo to Dragon *
                      (   cmds_retok.asm):00620         ;*****************
                      (   cmds_retok.asm):00621         
EAF6                  (   cmds_retok.asm):00622         CoCoDragonCmd
                      (   cmds_retok.asm):00623                 FCB     $80
                      (   cmds_retok.asm):00624                 FCB     $81
                      (   cmds_retok.asm):00625                 FCB     $82
                      (   cmds_retok.asm):00626                 FCB     $83
                      (   cmds_retok.asm):00627                 FCB     $84
                      (   cmds_retok.asm):00628                 FCB     $85
                      (   cmds_retok.asm):00629                 FCB     $86
                      (   cmds_retok.asm):00630                 FCB     $87
                      (   cmds_retok.asm):00631                 FCB     $88
                      (   cmds_retok.asm):00632                 FCB     $89
                      (   cmds_retok.asm):00633                 FCB     $8a
                      (   cmds_retok.asm):00634                 FCB     $8b
                      (   cmds_retok.asm):00635                 FCB     $8c
                      (   cmds_retok.asm):00636                 FCB     $8d
                      (   cmds_retok.asm):00637                 FCB     $8f
                      (   cmds_retok.asm):00638                 FCB     $90
                      (   cmds_retok.asm):00639                 FCB     $91
                      (   cmds_retok.asm):00640                 FCB     $92
                      (   cmds_retok.asm):00641                 FCB     $93
                      (   cmds_retok.asm):00642                 FCB     $94
                      (   cmds_retok.asm):00643                 FCB     $95
                      (   cmds_retok.asm):00644                 FCB     $96
                      (   cmds_retok.asm):00645                 FCB     $97
                      (   cmds_retok.asm):00646                 FCB     $99
                      (   cmds_retok.asm):00647                 FCB     $9a
                      (   cmds_retok.asm):00648                 FCB     $9b
                      (   cmds_retok.asm):00649                 FCB     $9c
                      (   cmds_retok.asm):00650                 FCB     $9d
                      (   cmds_retok.asm):00651                 FCB     $9e
                      (   cmds_retok.asm):00652                 FCB     $9f
                      (   cmds_retok.asm):00653                 FCB     $a0
                      (   cmds_retok.asm):00654                 FCB     $a1
                      (   cmds_retok.asm):00655                 FCB     $a2
                      (   cmds_retok.asm):00656                 FCB     $a3
                      (   cmds_retok.asm):00657                 FCB     $a4
                      (   cmds_retok.asm):00658                 FCB     $a5
                      (   cmds_retok.asm):00659                 FCB     $bb
                      (   cmds_retok.asm):00660                 FCB     $bc
                      (   cmds_retok.asm):00661                 FCB     $bd
                      (   cmds_retok.asm):00662                 FCB     $bf
                      (   cmds_retok.asm):00663                 FCB     $c0
                      (   cmds_retok.asm):00664                 FCB     $c1
                      (   cmds_retok.asm):00665                 FCB     $c2
                      (   cmds_retok.asm):00666                 FCB     $c3
                      (   cmds_retok.asm):00667                 FCB     $c4
                      (   cmds_retok.asm):00668                 FCB     $c5
                      (   cmds_retok.asm):00669                 FCB     $c6
                      (   cmds_retok.asm):00670                 FCB     $c7
                      (   cmds_retok.asm):00671                 FCB     $c8
                      (   cmds_retok.asm):00672                 FCB     $c9
                      (   cmds_retok.asm):00673                 FCB     $ca
                      (   cmds_retok.asm):00674                 FCB     $cb
                      (   cmds_retok.asm):00675                 FCB     $cc
                      (   cmds_retok.asm):00676                 FCB     $a6
                      (   cmds_retok.asm):00677                 FCB     $a7
                      (   cmds_retok.asm):00678                 FCB     $a8
                      (   cmds_retok.asm):00679                 FCB     $a9
                      (   cmds_retok.asm):00680                 FCB     $98
                      (   cmds_retok.asm):00681                 FCB     $8e
                      (   cmds_retok.asm):00682                 FCB     $aa
                      (   cmds_retok.asm):00683                 FCB     $ab
                      (   cmds_retok.asm):00684                 FCB     $ac
                      (   cmds_retok.asm):00685                 FCB     $ad
                      (   cmds_retok.asm):00686                 FCB     $ae
                      (   cmds_retok.asm):00687                 FCB     $af
                      (   cmds_retok.asm):00688                 FCB     $b0
                      (   cmds_retok.asm):00689                 FCB     $b1
                      (   cmds_retok.asm):00690                 FCB     $b2
                      (   cmds_retok.asm):00691                 FCB     $b3
                      (   cmds_retok.asm):00692                 FCB     $b4
                      (   cmds_retok.asm):00693                 FCB     $b5
                      (   cmds_retok.asm):00694                 FCB     $b6
                      (   cmds_retok.asm):00695                 FCB     $b7
                      (   cmds_retok.asm):00696                 FCB     $b8
                      (   cmds_retok.asm):00697                 FCB     $b9
                      (   cmds_retok.asm):00698                 FCB     $ba
                      (   cmds_retok.asm):00699                 FCB     $be
                      (   cmds_retok.asm):00700                 FCB     $cd
                      (   cmds_retok.asm):00701         
EAF6                  (   cmds_retok.asm):00702         CoCoDragonFunc
                      (   cmds_retok.asm):00703                 FCB     $80
                      (   cmds_retok.asm):00704                 FCB     $81
                      (   cmds_retok.asm):00705                 FCB     $82
                      (   cmds_retok.asm):00706                 FCB     $a1
                      (   cmds_retok.asm):00707                 FCB     $84
                      (   cmds_retok.asm):00708                 FCB     $88
                      (   cmds_retok.asm):00709                 FCB     $8c
                      (   cmds_retok.asm):00710                 FCB     $8d
                      (   cmds_retok.asm):00711                 FCB     $8e
                      (   cmds_retok.asm):00712                 FCB     $8f
                      (   cmds_retok.asm):00713                 FCB     $90
                      (   cmds_retok.asm):00714                 FCB     $91
                      (   cmds_retok.asm):00715                 FCB     $92
                      (   cmds_retok.asm):00716                 FCB     $93
                      (   cmds_retok.asm):00717                 FCB     $96
                      (   cmds_retok.asm):00718                 FCB     $97
                      (   cmds_retok.asm):00719                 FCB     $98
                      (   cmds_retok.asm):00720                 FCB     $99
                      (   cmds_retok.asm):00721                 FCB     $9a
                      (   cmds_retok.asm):00722                 FCB     $9b
                      (   cmds_retok.asm):00723                 FCB     $8b
                      (   cmds_retok.asm):00724                 FCB     $89
                      (   cmds_retok.asm):00725                 FCB     $8a
                      (   cmds_retok.asm):00726                 FCB     $87
                      (   cmds_retok.asm):00727                 FCB     $94
                      (   cmds_retok.asm):00728                 FCB     $86
                      (   cmds_retok.asm):00729                 FCB     $83
                      (   cmds_retok.asm):00730                 FCB     $85
                      (   cmds_retok.asm):00731                 FCB     $95
                      (   cmds_retok.asm):00732                 FCB     $9c
                      (   cmds_retok.asm):00733                 FCB     $9d
                      (   cmds_retok.asm):00734                 FCB     $9e
                      (   cmds_retok.asm):00735                 FCB     $9f
                      (   cmds_retok.asm):00736                 FCB     $a0
                      (   cmds_retok.asm):00737         
                      (   cmds_retok.asm):00738             endc
                      (   cmds_retok.asm):00739                 
EAF6                  (   cmds_retok.asm):00740         __cmd_retok_end
                      (   cmds_retok.asm):00741         
                      (    DragonMMC.asm):00669                         use             cmds_diskimg.asm
                      ( cmds_diskimg.asm):00001         ;
                      ( cmds_diskimg.asm):00002         ; cmds_diskimg.asm
                      ( cmds_diskimg.asm):00003         ;
                      ( cmds_diskimg.asm):00004         ; Disk image manipulation.
                      ( cmds_diskimg.asm):00005         ;
                      ( cmds_diskimg.asm):00006         
EAF6                  ( cmds_diskimg.asm):00007         __cmd_diskimg
                      ( cmds_diskimg.asm):00008         
                      ( cmds_diskimg.asm):00009                 ifdef   Dragon
     0088             ( cmds_diskimg.asm):00010         TokOn   equ     DTokON
     00C2             ( cmds_diskimg.asm):00011         TokOff  equ     DTokOFF
                      ( cmds_diskimg.asm):00012                 else
EAF6                  ( cmds_diskimg.asm):00013         TokOn   equ     CTokON
EAF6                  ( cmds_diskimg.asm):00014         TokOff  equ     CTokOFF
                      ( cmds_diskimg.asm):00015                 endc
                      ( cmds_diskimg.asm):00016         
EAF6                  ( cmds_diskimg.asm):00017         CmdMDisk
EAF6 1F89             ( cmds_diskimg.asm):00018                 tfr     a,b
EAF8 9D9F             ( cmds_diskimg.asm):00019                 jsr     <BasChrGet              ; skip first char               
                      ( cmds_diskimg.asm):00020         
EAFA C149             ( cmds_diskimg.asm):00021                 cmpb    #'I                     ; MDiskI ?
EAFC 2721             ( cmds_diskimg.asm):00022                 beq     CmdMDiskIC              ; Yep insert
                      ( cmds_diskimg.asm):00023                 
EAFE C143             ( cmds_diskimg.asm):00024                 cmpb    #'C                     ; MDiskC ?
EB00 271D             ( cmds_diskimg.asm):00025                 beq     CmdMDiskIC              ; Yep insert
                      ( cmds_diskimg.asm):00026                 
EB02 C14F             ( cmds_diskimg.asm):00027                 cmpb    #'O                     ; MDiskO ?
EB04 274F             ( cmds_diskimg.asm):00028                 beq     CmdMdiskO               ; Yep, eject
                      ( cmds_diskimg.asm):00029                 
EB06 C14C             ( cmds_diskimg.asm):00030                 cmpb    #'L                     ; MDiskL ?
EB08 2754             ( cmds_diskimg.asm):00031                 beq     CmdMDiskL               ; Yep, list
                      ( cmds_diskimg.asm):00032                 
EB0A C188             ( cmds_diskimg.asm):00033                 cmpb    #TokOn                  ; MDisk ON ?
EB0C 10270088         ( cmds_diskimg.asm):00034                 lbeq    CmdMdiskOn
                      ( cmds_diskimg.asm):00035                 
EB10 C1C2             ( cmds_diskimg.asm):00036                 cmpb    #TokOff                 ; MDisk OFF ?
EB12 1027008F         ( cmds_diskimg.asm):00037                 lbeq    CmdMDiskOff
                      ( cmds_diskimg.asm):00038                 
EB16 C142             ( cmds_diskimg.asm):00039                 cmpb    #'B                     ; MdiskB ?
EB18 102700A1         ( cmds_diskimg.asm):00040                 lbeq    CmdMdiskB               ; Yep, boot
                      ( cmds_diskimg.asm):00041             
EB1C 7E89B4           ( cmds_diskimg.asm):00042                 jmp     >BasSNError             ; no : ?SN Error
                      ( cmds_diskimg.asm):00043         
                      ( cmds_diskimg.asm):00044         ;
                      ( cmds_diskimg.asm):00045         ; Insert a disk image into a virtual drive.
                      ( cmds_diskimg.asm):00046         ;
                      ( cmds_diskimg.asm):00047         
EB1F                  ( cmds_diskimg.asm):00048         CmdMDiskIC
EB1F 3404             ( cmds_diskimg.asm):00049                 pshs    b                       ; Save 'I' or 'C'
EB21 8D18             ( cmds_diskimg.asm):00050                 bsr     CmdDiskIOCommon         ; get drive number and send it
EB23 BD89AA           ( cmds_diskimg.asm):00051                 jsr     >VarCKComma             ; Check for comma, error if not
                      ( cmds_diskimg.asm):00052                 
EB26 BDE2E5           ( cmds_diskimg.asm):00053                 jsr     >GetSendFileName2       ; get filename and send to AVR
                      ( cmds_diskimg.asm):00054                 
EB29 8612             ( cmds_diskimg.asm):00055                 lda     #CMD_FILE_OPEN_IMG      ; Open disk image
EB2B 3504             ( cmds_diskimg.asm):00056                 puls    b                       ; revover version code
EB2D C143             ( cmds_diskimg.asm):00057                 cmpb    #'C                     ; Open/Create?
EB2F 2602             ( cmds_diskimg.asm):00058                 bne     CmdMDiskICSend
EB31 861F             ( cmds_diskimg.asm):00059                 lda     #CMD_FILE_OPENCRE_IMG   ; Open / create disk image
                      ( cmds_diskimg.asm):00060                 
EB33                  ( cmds_diskimg.asm):00061         CmdMDiskICSend  
EB33 BDE00E           ( cmds_diskimg.asm):00062                 jsr     >MMC_SendCmd            ; Do it !
EB36 BDE30D           ( cmds_diskimg.asm):00063                 jsr     >CheckError             ; Check for error 
                      ( cmds_diskimg.asm):00064                 
EB39 4F               ( cmds_diskimg.asm):00065                 clra
EB3A 39               ( cmds_diskimg.asm):00066                 rts
                      ( cmds_diskimg.asm):00067         
EB3B                  ( cmds_diskimg.asm):00068         CmdDiskIOCommon
EB3B 8D09             ( cmds_diskimg.asm):00069                 bsr     CmdDiskIOGetID          ; get disk id in a
                      ( cmds_diskimg.asm):00070                 
EB3D BDECCA           ( cmds_diskimg.asm):00071                 jsr     >MMC_InitSendBytes      ; Begin sending bytes to the AVR
EB40 7EED0B           ( cmds_diskimg.asm):00072                 jmp     >MMC_WaitPutRead        ; send the drive number
                      ( cmds_diskimg.asm):00073                 
EB43                  ( cmds_diskimg.asm):00074         CmdDiskFC
EB43 7E8B8D           ( cmds_diskimg.asm):00075                 jmp     >BasFCError             ; Generate FC error
                      ( cmds_diskimg.asm):00076         
                      ( cmds_diskimg.asm):00077         ;
                      ( cmds_diskimg.asm):00078         ; Get an 8 bit number and validate as drive id
                      ( cmds_diskimg.asm):00079         ;
EB46                  ( cmds_diskimg.asm):00080         CmdDiskIOGetID
EB46 BD8E51           ( cmds_diskimg.asm):00081                 jsr     >VarGet8Bit             ; Get drive no into b
                      ( cmds_diskimg.asm):00082                 
EB49 1F98             ( cmds_diskimg.asm):00083                 tfr     b,a                     ; get into a
                      ( cmds_diskimg.asm):00084         
                      ( cmds_diskimg.asm):00085         ; Dragon DOS drives are 1..4, RS-DOS are 0..3
                      ( cmds_diskimg.asm):00086                 ifdef   Dragon
EB4B 8101             ( cmds_diskimg.asm):00087                 cmpa    #1                      ; less than 1 ?
EB4D 25F4             ( cmds_diskimg.asm):00088                 blo     CmdDiskFC               ; yep : error
EB4F 8105             ( cmds_diskimg.asm):00089                 cmpa    #5                      ; greater than 4 ?
EB51 24F0             ( cmds_diskimg.asm):00090                 bhs     CmdDiskFC               ; yep : error
EB53 4A               ( cmds_diskimg.asm):00091                 deca                            ; make zero based
                      ( cmds_diskimg.asm):00092                 
                      ( cmds_diskimg.asm):00093                 else
                      ( cmds_diskimg.asm):00094                 
                      ( cmds_diskimg.asm):00095                 cmpa    #0                      ; less than 0 ?
                      ( cmds_diskimg.asm):00096                 blo     CmdDiskFC               ; yep : error
                      ( cmds_diskimg.asm):00097                 cmpa    #4                      ; greater than 3 ?
                      ( cmds_diskimg.asm):00098                 bhs     CmdDiskFC               ; yep : error
                      ( cmds_diskimg.asm):00099                 endc
EB54 39               ( cmds_diskimg.asm):00100                 rts
                      ( cmds_diskimg.asm):00101                 
                      ( cmds_diskimg.asm):00102         ;
                      ( cmds_diskimg.asm):00103         ; Eject a disk image from a virtual drive.
                      ( cmds_diskimg.asm):00104         ;
                      ( cmds_diskimg.asm):00105                 
EB55                  ( cmds_diskimg.asm):00106         CmdMdiskO
EB55 8DE4             ( cmds_diskimg.asm):00107                 bsr     CmdDiskIOCommon         ; get drive number and send it
                      ( cmds_diskimg.asm):00108         
EB57 8647             ( cmds_diskimg.asm):00109                 lda     #CMD_IMG_UNMOUNT        ; Unmount the image
EB59 BDE00E           ( cmds_diskimg.asm):00110                 jsr     >MMC_SendCmd            ; do it
                      ( cmds_diskimg.asm):00111         
EB5C 4F               ( cmds_diskimg.asm):00112                 clra                            ; no error
EB5D 39               ( cmds_diskimg.asm):00113                 rts
                      ( cmds_diskimg.asm):00114         
                      ( cmds_diskimg.asm):00115         ;
                      ( cmds_diskimg.asm):00116         ; List mounted disks
                      ( cmds_diskimg.asm):00117         ;
                      ( cmds_diskimg.asm):00118                 
EB5E                  ( cmds_diskimg.asm):00119         CmdMDiskL
EB5E 4F               ( cmds_diskimg.asm):00120                 clra                            ; send first and last disk IDs required
EB5F C603             ( cmds_diskimg.asm):00121                 ldb     #3                      ; 0..3
EB61 17032E           ( cmds_diskimg.asm):00122                 lbsr    MMC_SendDriveIDs
                      ( cmds_diskimg.asm):00123                 
EB64 8642             ( cmds_diskimg.asm):00124                 lda     #CMD_GET_IMG_NAME       ; Get names of images
EB66 BDE00E           ( cmds_diskimg.asm):00125                 jsr     >MMC_SendCmd            ; do it
EB69 BDE30D           ( cmds_diskimg.asm):00126                 jsr     >CheckError             ; Check for error 
                      ( cmds_diskimg.asm):00127         
                      ( cmds_diskimg.asm):00128         ; If we get here, then we have the images names in the AVR data buffer
                      ( cmds_diskimg.asm):00129         ; we will read them back and display them
                      ( cmds_diskimg.asm):00130         
EB6C 8620             ( cmds_diskimg.asm):00131                 lda     #CMD_INIT_READ          ; start reading
EB6E BDE017           ( cmds_diskimg.asm):00132                 jsr     >MMC_SendCmdRaw         ; do it
                      ( cmds_diskimg.asm):00133         
EB71 5F               ( cmds_diskimg.asm):00134                 clrb                            ; name counter
                      ( cmds_diskimg.asm):00135                 
EB72                  ( cmds_diskimg.asm):00136         CmdMDiskLNext
EB72 3404             ( cmds_diskimg.asm):00137                 pshs    b                       ; save it
                      ( cmds_diskimg.asm):00138                 
                      ( cmds_diskimg.asm):00139                 ifdef   Dragon
EB74 CB31             ( cmds_diskimg.asm):00140                 addb    #'1
                      ( cmds_diskimg.asm):00141                 else
                      ( cmds_diskimg.asm):00142                 addb    #'0                     ; convert to ASCII
                      ( cmds_diskimg.asm):00143                 endc
EB76 1F98             ( cmds_diskimg.asm):00144                 tfr     b,a
EB78 BD800C           ( cmds_diskimg.asm):00145                 jsr     >BasicScreenOut         ; print it
                      ( cmds_diskimg.asm):00146                 
EB7B 863A             ( cmds_diskimg.asm):00147                 lda     #':                     ; print :
EB7D BD800C           ( cmds_diskimg.asm):00148                 jsr     >BasicScreenOut         ; print it
                      ( cmds_diskimg.asm):00149                 
EB80                  ( cmds_diskimg.asm):00150         CmdMDiskLNextChar       
EB80 BDED16           ( cmds_diskimg.asm):00151                 jsr     >MMC_WaitGetWritten     ; wait for a byte
                      ( cmds_diskimg.asm):00152                 
EB83 8100             ( cmds_diskimg.asm):00153                 cmpa    #0                      ; end of name ?
EB85 2705             ( cmds_diskimg.asm):00154                 beq     CmdMDiskLEOL
EB87 BD800C           ( cmds_diskimg.asm):00155                 jsr     >BasicScreenOut         ; print it
EB8A 20F4             ( cmds_diskimg.asm):00156                 bra     CmdMDiskLNextChar
                      ( cmds_diskimg.asm):00157         
EB8C                  ( cmds_diskimg.asm):00158         CmdMDiskLEOL
EB8C 170401           ( cmds_diskimg.asm):00159                 lbsr    CON_EOL                 ; send eol
EB8F 3504             ( cmds_diskimg.asm):00160                 puls    b                       ; recover drive no
                      ( cmds_diskimg.asm):00161                 
EB91 5C               ( cmds_diskimg.asm):00162                 incb                            ; increment
EB92 C104             ( cmds_diskimg.asm):00163                 cmpb    #4                      ; all done ?
EB94 25DC             ( cmds_diskimg.asm):00164                 blo     CmdMDiskLNext           ; nope do next 
                      ( cmds_diskimg.asm):00165                 
EB96 4F               ( cmds_diskimg.asm):00166                 clra
EB97 39               ( cmds_diskimg.asm):00167                 rts
                      ( cmds_diskimg.asm):00168         
                      ( cmds_diskimg.asm):00169         ;
                      ( cmds_diskimg.asm):00170         ; Turn on disk emulation and reboot
                      ( cmds_diskimg.asm):00171         ;
EB98                  ( cmds_diskimg.asm):00172         CmdMdiskOn
EB98 D676             ( cmds_diskimg.asm):00173                 ldb     <CFGByte                ; Get config byte
EB9A CA20             ( cmds_diskimg.asm):00174                 orb     #CFG_ENABLE_DOS         ; Flag Dos enabled
EB9C                  ( cmds_diskimg.asm):00175         MDiskOnOff
EB9C BDEC4F           ( cmds_diskimg.asm):00176                 jsr     >SetCfgDefaultB 
                      ( cmds_diskimg.asm):00177                 
EB9F 0F71             ( cmds_diskimg.asm):00178                 clr     WarmStartFlag           ; flag cold start
EBA1 6E9FFFFE         ( cmds_diskimg.asm):00179                 jmp     [$FFFE]                 ; reset machine, never returns
                      ( cmds_diskimg.asm):00180                 
                      ( cmds_diskimg.asm):00181         
EBA5                  ( cmds_diskimg.asm):00182         CmdMDiskOff
EBA5 D676             ( cmds_diskimg.asm):00183                 ldb     <CFGByte                ; Get config byte
EBA7 C4DF             ( cmds_diskimg.asm):00184                 andb    #~CFG_ENABLE_DOS         ; Flag Dos enabled
EBA9 20F1             ( cmds_diskimg.asm):00185                 bra     MDiskOnOff
                      ( cmds_diskimg.asm):00186                 
                      ( cmds_diskimg.asm):00187         ; 
                      ( cmds_diskimg.asm):00188         ; Get the name of a specified image
                      ( cmds_diskimg.asm):00189         ; returns an empty string if no image mounted.
                      ( cmds_diskimg.asm):00190         ;
EBAB                  ( cmds_diskimg.asm):00191         FuncGetIName
EBAB 8D99             ( cmds_diskimg.asm):00192                 bsr     CmdDiskIOGetID          ; get drive id, and adjust as needed, FCerror if invalid
EBAD 1F89             ( cmds_diskimg.asm):00193                 tfr     a,b                     ; copy it into, so we only get one filename
                      ( cmds_diskimg.asm):00194                 
EBAF 1702E0           ( cmds_diskimg.asm):00195                 lbsr    MMC_SendDriveIDs        ; send them
                      ( cmds_diskimg.asm):00196                 
EBB2 8642             ( cmds_diskimg.asm):00197                 lda     #CMD_GET_IMG_NAME       ; Get names of images
EBB4 BDE00E           ( cmds_diskimg.asm):00198                 jsr     >MMC_SendCmd            ; do it
EBB7 BDE30D           ( cmds_diskimg.asm):00199                 jsr     >CheckError             ; Check for error 
                      ( cmds_diskimg.asm):00200         
EBBA 7EE670           ( cmds_diskimg.asm):00201                 jmp     >FuncRetMMCString       ; Return it to basic
                      ( cmds_diskimg.asm):00202         
                      ( cmds_diskimg.asm):00203         ;
                      ( cmds_diskimg.asm):00204         ; Boot disk inserted into the first drive. 
                      ( cmds_diskimg.asm):00205         ; This command can be used to boot a disk *WITHOUT* Basic disk emulation
                      ( cmds_diskimg.asm):00206         ; being enabled, for example to boot OS-9, NitrOS9, Flex etc.
                      ( cmds_diskimg.asm):00207         ;
                      ( cmds_diskimg.asm):00208         
EBBD                  ( cmds_diskimg.asm):00209         CmdMdiskB
                      ( cmds_diskimg.asm):00210                 ifdef   Dragon
EBBD CE0002           ( cmds_diskimg.asm):00211                 ldu     #2                      ; track 0, sector 2
                      ( cmds_diskimg.asm):00212                 endc
                      ( cmds_diskimg.asm):00213                 
                      ( cmds_diskimg.asm):00214                 ifdef   Tandy
                      ( cmds_diskimg.asm):00215                 ldu     #(34*18)                ; track 34, sector 0
                      ( cmds_diskimg.asm):00216                 endc
                      ( cmds_diskimg.asm):00217         
EBC0 5F               ( cmds_diskimg.asm):00218                 clrb                            ; MSB of LSN always 0
EBC1 4F               ( cmds_diskimg.asm):00219                 clra                            ; drive 0
EBC2 8E2600           ( cmds_diskimg.asm):00220                 ldx     #$2600                  ; boot address
EBC5 BDEE2C           ( cmds_diskimg.asm):00221                 jsr     >MMC_ReadDOSSec         ; go read first sector
EBC8 261B             ( cmds_diskimg.asm):00222                 bne     CmdMdiskBErr
                      ( cmds_diskimg.asm):00223                 
EBCA CC2600           ( cmds_diskimg.asm):00224                 ldd     #$2600                  ; get first 2 bytes
EBCD 10834F53         ( cmds_diskimg.asm):00225                 cmpd    #$4f53                  ; is it 'OS' ?
EBD1 2612             ( cmds_diskimg.asm):00226                 bne     CmdMdiskBErr            ; nope : error
                      ( cmds_diskimg.asm):00227                 
                      ( cmds_diskimg.asm):00228                 ifdef   Dragon
EBD3 C60F             ( cmds_diskimg.asm):00229                 ldb     #15                     ; 15 more sectors
                      ( cmds_diskimg.asm):00230                 endc
                      ( cmds_diskimg.asm):00231                 
                      ( cmds_diskimg.asm):00232                 ifdef   Tandy
                      ( cmds_diskimg.asm):00233                 ldb     #17                     ; 17 more sectors
                      ( cmds_diskimg.asm):00234                 endc
                      ( cmds_diskimg.asm):00235         
EBD5                  ( cmds_diskimg.asm):00236         CmdMdiskBLoop   
EBD5 3404             ( cmds_diskimg.asm):00237                 pshs    b                       ; save count
EBD7 BDEE44           ( cmds_diskimg.asm):00238                 jsr     >MMC_ReadNextDOSSec     ; go read next sector
EBDA 2609             ( cmds_diskimg.asm):00239                 bne     CmdMdiskBErr
EBDC 3504             ( cmds_diskimg.asm):00240                 puls    b                       ; recover count
                      ( cmds_diskimg.asm):00241                 
EBDE 5A               ( cmds_diskimg.asm):00242                 decb                            ; decrement count
EBDF 26F4             ( cmds_diskimg.asm):00243                 bne     CmdMdiskBLoop           ; do next.
                      ( cmds_diskimg.asm):00244                 
EBE1 7E2602           ( cmds_diskimg.asm):00245                 jmp     $2602                   ; jump to loaded code
EBE4 39               ( cmds_diskimg.asm):00246                 rts
                      ( cmds_diskimg.asm):00247              
EBE5                  ( cmds_diskimg.asm):00248         CmdMdiskBErr
EBE5 7E8B8D           ( cmds_diskimg.asm):00249                 jmp     >BasFCError
                      ( cmds_diskimg.asm):00250              
EBE8                  ( cmds_diskimg.asm):00251         __cmd_diskimg_end
                      (    DragonMMC.asm):00670                 use     cmds_datetime.asm
                      (cmds_datetime.asm):00001         ;
                      (cmds_datetime.asm):00002         ; Data and time functions
                      (cmds_datetime.asm):00003         ;
                      (cmds_datetime.asm):00004         
EBE8                  (cmds_datetime.asm):00005         __cmd_datetime
                      (cmds_datetime.asm):00006         
EBE8                  (cmds_datetime.asm):00007         CmdSetDT
EBE8 86C1             (cmds_datetime.asm):00008             lda     #CMD_SET_DATETIME           ; Set data and time
EBEA 7EE2EB           (cmds_datetime.asm):00009             jmp     >CmdSendStringCmd           ; Go send it!
                      (cmds_datetime.asm):00010                 
EBED                  (cmds_datetime.asm):00011         FuncGetDT
EBED 86C0             (cmds_datetime.asm):00012             lda         #CMD_GET_DATETIME                       ; Get date and time
EBEF BDE00E           (cmds_datetime.asm):00013                 jsr         >MMC_SendCmd
EBF2 BDE30D           (cmds_datetime.asm):00014                 jsr     >CheckError                                     ; check for errors, returns to basic on error
                      (cmds_datetime.asm):00015         
EBF5 7EE670           (cmds_datetime.asm):00016             jmp     >FuncRetMMCString           ; Return it to basic.
                      (cmds_datetime.asm):00017         
                      (cmds_datetime.asm):00018         
                      (cmds_datetime.asm):00019         
EBF8                  (cmds_datetime.asm):00020         ShowDateTime
EBF8 8EE3BC           (cmds_datetime.asm):00021             ldx     #RTCMess-1                  ; get address of messgae
EBFB BD90E5           (cmds_datetime.asm):00022             jsr     >TextOutString
                      (cmds_datetime.asm):00023         
EBFE 86C0             (cmds_datetime.asm):00024             lda         #CMD_GET_DATETIME                       ; Get date and time
EC00 BDE00E           (cmds_datetime.asm):00025                 jsr         >MMC_SendCmd
                      (cmds_datetime.asm):00026         
EC03 BDE667           (cmds_datetime.asm):00027             jsr     >GetStrLenA                 ; Get length in A
                      (cmds_datetime.asm):00028         
EC06 3402             (cmds_datetime.asm):00029             pshs    a                           ; save length
                      (cmds_datetime.asm):00030             
EC08 8620             (cmds_datetime.asm):00031                 lda             #CMD_INIT_READ                          ; Get date string
EC0A BDE017           (cmds_datetime.asm):00032                 jsr         >MMC_SendCmdRaw
                      (cmds_datetime.asm):00033            
EC0D 3504             (cmds_datetime.asm):00034             puls    b                           ; retrieve length
                      (cmds_datetime.asm):00035         
EC0F                  (cmds_datetime.asm):00036         ShowDateNext
EC0F BDED16           (cmds_datetime.asm):00037                 jsr         >MMC_WaitGetWritten                 ; Wait for byte, and get it in a
EC12 BD800C           (cmds_datetime.asm):00038             jsr     >BasicScreenOut             ; send to screen
EC15 5A               (cmds_datetime.asm):00039             decb                                ; decrement count
EC16 26F7             (cmds_datetime.asm):00040             bne     ShowDateNext
                      (cmds_datetime.asm):00041             
EC18 BDEF90           (cmds_datetime.asm):00042             jsr     >CON_EOL                    ; print eol.
                      (cmds_datetime.asm):00043         
EC1B 39               (cmds_datetime.asm):00044             rts
                      (cmds_datetime.asm):00045         
EC1C                  (cmds_datetime.asm):00046         __cmd_datetime_end
                      (    DragonMMC.asm):00671                         use             cmds_config.asm
                      (  cmds_config.asm):00001         ;
                      (  cmds_config.asm):00002         ; cmds_config.asm Get/Set config.
                      (  cmds_config.asm):00003         ;
                      (  cmds_config.asm):00004         
                      (  cmds_config.asm):00005         ;
                      (  cmds_config.asm):00006         ; If one byte supplied then set config for this platform, else if two 
                      (  cmds_config.asm):00007         ; bytes supplied, then set for the supplied platform plat,value
                      (  cmds_config.asm):00008         ;       
                      (  cmds_config.asm):00009         ; SetCfg configbyte,<platform>
                      (  cmds_config.asm):00010         ;       
                      (  cmds_config.asm):00011         
EC1C                  (  cmds_config.asm):00012         __cmd_config
                      (  cmds_config.asm):00013         
EC1C                  (  cmds_config.asm):00014         CmdSetCFG
EC1C 8153             (  cmds_config.asm):00015                         cmpa    #'S                                             ; Setbit ?
EC1E 270D             (  cmds_config.asm):00016                         beq             CmdSetCFGSetBits
EC20 8143             (  cmds_config.asm):00017                         cmpa    #'C                                             ; Clearbit ?
EC22 270F             (  cmds_config.asm):00018                         beq             CmdSetCFGClearBits
                      (  cmds_config.asm):00019         
                      (  cmds_config.asm):00020         ; Come here if setting directly 
EC24 170353           (  cmds_config.asm):00021                         lbsr    CON_DotEOL
EC27 8D10             (  cmds_config.asm):00022                         bsr             CmdSetCFGGetParm                ; Get params
EC29                  (  cmds_config.asm):00023         CmdSetCFGSetByte                
EC29 8D4D             (  cmds_config.asm):00024                         bsr             SetCFGinAB                              ; set config byte
EC2B 4F               (  cmds_config.asm):00025                         clra
EC2C 39               (  cmds_config.asm):00026                         rts
                      (  cmds_config.asm):00027         
EC2D                  (  cmds_config.asm):00028         CmdSetCFGSetBits
EC2D 9D9F             (  cmds_config.asm):00029                         JSR     <BasChrGet                              ; skip  
                      (  cmds_config.asm):00030                         
EC2F 8D08             (  cmds_config.asm):00031                         bsr             CmdSetCFGGetParm                ; Get params in 
EC31 2052             (  cmds_config.asm):00032                         bra             SetCFGBitsAB                    ; Go set them
                      (  cmds_config.asm):00033                         
EC33                  (  cmds_config.asm):00034         CmdSetCFGClearBits              
EC33 9D9F             (  cmds_config.asm):00035                         JSR     <BasChrGet                              ; skip  
                      (  cmds_config.asm):00036                         
EC35 8D02             (  cmds_config.asm):00037                         bsr             CmdSetCFGGetParm                ; Get params in 
EC37 205C             (  cmds_config.asm):00038                         bra             ClearCFGBitsAB                  ; Go set them
                      (  cmds_config.asm):00039                         
EC39                  (  cmds_config.asm):00040         CmdSetCFGGetParm                
EC39 BD8E51           (  cmds_config.asm):00041                         jsr             >VarGet8Bit                             ; Get first byte from basic
EC3C BDE2F9           (  cmds_config.asm):00042                         jsr             >CkComma                                ; is there another param?
EC3F 260B             (  cmds_config.asm):00043                         bne             CmdSetCFGDefault                ; no assume current platform
                      (  cmds_config.asm):00044                         
EC41 3404             (  cmds_config.asm):00045                         pshs    b                                               ; save value
EC43 BDF087           (  cmds_config.asm):00046                         jsr             >MGetCommaThen8Bit              ; yes: go get platform
                      (  cmds_config.asm):00047         
EC46 3502             (  cmds_config.asm):00048                         puls    a                                               ; recover value
EC48 1E89             (  cmds_config.asm):00049                 exg             a,b                                             ; get platform in a, value in b
EC4A 2002             (  cmds_config.asm):00050                         bra             CmdSetCFGGetParmEnd             ; Go set it
                      (  cmds_config.asm):00051         
EC4C                  (  cmds_config.asm):00052         CmdSetCFGDefault
EC4C 8D6F             (  cmds_config.asm):00053                         bsr             GetPlatform                             ; go get platform
EC4E                  (  cmds_config.asm):00054         CmdSetCFGGetParmEnd
EC4E 39               (  cmds_config.asm):00055                         rts
                      (  cmds_config.asm):00056                         
                      (  cmds_config.asm):00057                 
EC4F                  (  cmds_config.asm):00058         SetCfgDefaultB
EC4F 8DFB             (  cmds_config.asm):00059                 bsr     CmdSetCFGDefault        ; go set it
EC51 20D6             (  cmds_config.asm):00060                 bra             CmdSetCFGSetByte
                      (  cmds_config.asm):00061                 
                      (  cmds_config.asm):00062         ;
                      (  cmds_config.asm):00063         ; GetCfg (<platform>)
                      (  cmds_config.asm):00064         ;       
                      (  cmds_config.asm):00065                         
EC53                  (  cmds_config.asm):00066         FUNCGetCFG
EC53 BDE303           (  cmds_config.asm):00067                         jsr             >CkOpenBrac                             ; Any parameters?
EC56 2619             (  cmds_config.asm):00068                         bne             FUNCGetCFGDef
                      (  cmds_config.asm):00069                         
EC58 BD89A7           (  cmds_config.asm):00070                         jsr             >VarCKOpBrac                    ; Skip bracket
EC5B BD8E51           (  cmds_config.asm):00071                         jsr             >VarGet8Bit                             ; Get platform byte from basic
EC5E 3404             (  cmds_config.asm):00072                         pshs    b
EC60 BD89A4           (  cmds_config.asm):00073                 jsr             >VarCKClBrac                    ; Close bracket, error if not
EC63 3502             (  cmds_config.asm):00074                         puls    a
                      (  cmds_config.asm):00075                 
EC65 81FF             (  cmds_config.asm):00076                 cmpa    #$FF                    ; flag to get ID rather than cfg byte
EC67 2604             (  cmds_config.asm):00077                 bne     FUNCGetCFGID
EC69 8D52             (  cmds_config.asm):00078                 bsr     GetPlatform             ; get platform
EC6B 2006             (  cmds_config.asm):00079                 bra             FUNCGetCFGAssign                ; and assign 
                      (  cmds_config.asm):00080                 
EC6D                  (  cmds_config.asm):00081         FUNCGetCFGID
EC6D 8D33             (  cmds_config.asm):00082                         bsr             GetCFGinA                               ; go get it
EC6F 2002             (  cmds_config.asm):00083                         bra             FUNCGetCFGAssign                ; and assign 
EC71                  (  cmds_config.asm):00084         FUNCGetCFGDef
EC71 8D2D             (  cmds_config.asm):00085                         bsr             GetDefCFGinA                    ; get config byte
EC73                  (  cmds_config.asm):00086         FUNCGetCFGAssign
EC73 1F89             (  cmds_config.asm):00087                         tfr             a,b
EC75 7E8C36           (  cmds_config.asm):00088                         jmp             >VarAssign8Bit                  ; return it to basic
                      (  cmds_config.asm):00089                                         
EC78                  (  cmds_config.asm):00090         __cmd_config_end
                      (  cmds_config.asm):00091         
                      (    DragonMMC.asm):00672         
                      (    DragonMMC.asm):00673         ; Driver function includes
                      (    DragonMMC.asm):00674                         use             config_func.asm
                      (  config_func.asm):00001         ;
                      (  config_func.asm):00002         ; config_func.asm Get/Set config functions
                      (  config_func.asm):00003         ;
                      (  config_func.asm):00004         ; Seperated from cmds_config.asm 2017-09-04, PHS.
                      (  config_func.asm):00005         ;
                      (  config_func.asm):00006         ; Define MINIMUM to exclude code not needed by FLASH
                      (  config_func.asm):00007         ; 
EC78                  (  config_func.asm):00008         __config_func
                      (  config_func.asm):00009         ;
                      (  config_func.asm):00010         ; Set the config byte from platform in A, byte in B
                      (  config_func.asm):00011         ;
                      (  config_func.asm):00012         ; Writes the config byte to the global data area, using CMD_SEND_BYTES.
                      (  config_func.asm):00013         ; Then writes the platform byte to the latch register and give a
                      (  config_func.asm):00014         ; CMD_SET_CFG.
                      (  config_func.asm):00015         ;
EC78                  (  config_func.asm):00016         SetCFGinAB
                      (  config_func.asm):00017         ;               lbsr    MMC_InitSendBytes               ; send config byte
EC78 17F3A6           (  config_func.asm):00018                         lbsr    MMC_WaitPutLatchRead    ; send platform byte to AVR     
                      (  config_func.asm):00019         
EC7B 1E89             (  config_func.asm):00020                         exg             a,b     
EC7D 17F3A1           (  config_func.asm):00021                         lbsr    MMC_WaitPutLatchRead    ; send config byte to AVR       
                      (  config_func.asm):00022         
EC80 86F1             (  config_func.asm):00023                         lda             #CMD_SET_CFG_BYTE               ; set config byte
EC82 16F389           (  config_func.asm):00024                         lbra    MMC_SendCmd                             ; Exec send command
                      (  config_func.asm):00025         
                      (  config_func.asm):00026                         ifndef  MINIMUM
                      (  config_func.asm):00027         
EC85                  (  config_func.asm):00028         SetCFGBitsAB
EC85 3402             (  config_func.asm):00029                         pshs    a                                               ; save platform
EC87 8D19             (  config_func.asm):00030                         bsr             GetCFGinA                               ; get it's config byte
EC89 3404             (  config_func.asm):00031                         pshs    b                                               ; save mask
EC8B AAE4             (  config_func.asm):00032                         ora             ,s                                              ; mask it in
EC8D                  (  config_func.asm):00033         SetClearCFGBitsAB
EC8D 1E89             (  config_func.asm):00034                         exg             a,b                                             ; platform in a value in b
EC8F 3261             (  config_func.asm):00035                         leas    1,s                                             ; drop mask
                      (  config_func.asm):00036                         
EC91 3502             (  config_func.asm):00037                         puls    a                                               ; recover platform
EC93 20E3             (  config_func.asm):00038                         bra             SetCFGinAB                              ; go set it
                      (  config_func.asm):00039                         
                      (  config_func.asm):00040         
EC95                  (  config_func.asm):00041         ClearCFGBitsAB
EC95 3402             (  config_func.asm):00042                         pshs    a                                               ; save platform
EC97 8D09             (  config_func.asm):00043                         bsr             GetCFGinA                               ; get it's config byte
EC99 53               (  config_func.asm):00044                         comb                                                    ; and with inverse mask
EC9A 3404             (  config_func.asm):00045                         pshs    b                                               ; save mask
EC9C A4E4             (  config_func.asm):00046                         anda    ,s                                              ; mask it
                      (  config_func.asm):00047                         
EC9E 20ED             (  config_func.asm):00048                         bra             SetClearCFGBitsAB               ; go set it
                      (  config_func.asm):00049         
                      (  config_func.asm):00050         ;
                      (  config_func.asm):00051         ; Get default (our) platform's config in a      
                      (  config_func.asm):00052         ;
                      (  config_func.asm):00053         
                      (  config_func.asm):00054         
ECA0                  (  config_func.asm):00055         GetDefCFGinA
ECA0 8D1B             (  config_func.asm):00056                         bsr             GetPlatform                             ; get platform, 1=Dragon, 2=CoCo
                      (  config_func.asm):00057         
                      (  config_func.asm):00058                         endc
                      (  config_func.asm):00059                         
ECA2                  (  config_func.asm):00060         GetCFGinA
ECA2 17F37C           (  config_func.asm):00061                         lbsr    MMC_WaitPutLatchRead    ; send platform byte to AVR
                      (  config_func.asm):00062                         
ECA5 86F0             (  config_func.asm):00063                         lda             #CMD_GET_CFG_BYTE               ; Get the config byte
ECA7 17F36D           (  config_func.asm):00064                         lbsr    MMC_SendCmdRaw
ECAA 170069           (  config_func.asm):00065                         lbsr    MMC_WaitGetWritten              ; wait for reply return it        
ECAD 39               (  config_func.asm):00066                         rts
                      (  config_func.asm):00067                                 
                      (  config_func.asm):00068                         ifndef  MINIMUM
                      (  config_func.asm):00069         
                      (  config_func.asm):00070         ;
                      (  config_func.asm):00071         ; Tell the AVR what platform it is running on, we do this here, so
                      (  config_func.asm):00072         ; that if the 6809 changes platform (for example in a DraCo) the AVR
                      (  config_func.asm):00073         ; is aware of the fact.
                      (  config_func.asm):00074         ;
                      (  config_func.asm):00075         
ECAE                  (  config_func.asm):00076         SetPlatform
ECAE 8D0D             (  config_func.asm):00077                         bsr             GetPlatform                             ; get the platform by reading D_RAM_CTRL
                      (  config_func.asm):00078         
ECB0 17F36E           (  config_func.asm):00079                         lbsr    MMC_WaitPutLatchRead    ; send platform byte to AVR
                      (  config_func.asm):00080                         
ECB3 86F2             (  config_func.asm):00081                         lda             #CMD_SET_PLATFORM               ; set the platform
ECB5 16F356           (  config_func.asm):00082                         lbra    MMC_SendCmd                             ; send the cnd and get the result
                      (  config_func.asm):00083         
                      (  config_func.asm):00084         ;
                      (  config_func.asm):00085         ; Get our config and set system var.
                      (  config_func.asm):00086         ;
ECB8                  (  config_func.asm):00087         GetConfig
ECB8 8DE6             (  config_func.asm):00088                 bsr     GetDefCFGinA            ; get default config
ECBA 9776             (  config_func.asm):00089                         sta             <CFGByte                                ; save it in ram
ECBC 39               (  config_func.asm):00090                 rts
                      (  config_func.asm):00091         
                      (  config_func.asm):00092         ; Check if we are running on a Dragon or CoCo by looking at the ROM select bit
                      (  config_func.asm):00093         ; returns 1 if Dragon, 2 if CoCo
ECBD                  (  config_func.asm):00094         GetPlatform
ECBD BDE026           (  config_func.asm):00095                         jsr             MMC_GetRAMCTRL                  ; Get ram control reg
                      (  config_func.asm):00096         ;               lda             D_RAM_CTRL              ; Get ram control reg
ECC0 8408             (  config_func.asm):00097                         anda    #D_ROM_A14                              ; check rom sel bit
ECC2 2603             (  config_func.asm):00098                         bne             GetPlatformCoCo                 ; CoCo : exit
ECC4 8601             (  config_func.asm):00099                         lda             #PLAT_DRAGON                    ; Flag Dragon
ECC6 39               (  config_func.asm):00100                         rts
                      (  config_func.asm):00101                                 
ECC7                  (  config_func.asm):00102         GetPlatformCoCo
ECC7 8602             (  config_func.asm):00103                         lda             #PLAT_COCO                              ; Flag CoCo
ECC9 39               (  config_func.asm):00104                         rts
                      (  config_func.asm):00105         
                      (  config_func.asm):00106                         endc
                      (  config_func.asm):00107                         
ECCA                  (  config_func.asm):00108         __config_func_end
                      (  config_func.asm):00109         
                      (    DragonMMC.asm):00675                         use             mmc_func.asm
                      (     mmc_func.asm):00001         ;
                      (     mmc_func.asm):00002         ; MMC functions.
                      (     mmc_func.asm):00003         ;
                      (     mmc_func.asm):00004         ; 2011-06-13 Phill Harvey-Smith.
                      (     mmc_func.asm):00005         ;
                      (     mmc_func.asm):00006         ; Define MINIMUM to exclude code not needed by FLASH
                      (     mmc_func.asm):00007         ;
                      (     mmc_func.asm):00008         
                      (     mmc_func.asm):00009         ;
                      (     mmc_func.asm):00010         ; Note some routines make calls / returns into the Dragon and CoCo roms.
                      (     mmc_func.asm):00011         ; Please remember to define them so they assemble correctly on *BOTH* 
                      (     mmc_func.asm):00012         ; machines.
                      (     mmc_func.asm):00013         ; 
                      (     mmc_func.asm):00014         
                      (     mmc_func.asm):00015         ;
                      (     mmc_func.asm):00016         ; **** NOTE ****
                      (     mmc_func.asm):00017         ;
                      (     mmc_func.asm):00018         ; Send CMD_INIT_READ with MMC_sendCmdRaw *NOT* MMC_SendCmd
                      (     mmc_func.asm):00019         ;
                      (     mmc_func.asm):00020         
ECCA                  (     mmc_func.asm):00021         __mmc_func
                      (     mmc_func.asm):00022         
                      (     mmc_func.asm):00023                         ifdef   Dragon
     B972             (     mmc_func.asm):00024         CasRDCksum              EQU             $B972                           
     B9C9             (     mmc_func.asm):00025         CasWRCksum              EQU             $B9C9
                      (     mmc_func.asm):00026                         else
ECCA                  (     mmc_func.asm):00027         CasRDCksum              EQU             $A73B
ECCA                  (     mmc_func.asm):00028         CasWRCksum              EQU             $A824
                      (     mmc_func.asm):00029                         endc
                      (     mmc_func.asm):00030         
                      (     mmc_func.asm):00031         ; Moved to mmc_simple_func.asm :
                      (     mmc_func.asm):00032         ;
                      (     mmc_func.asm):00033         ; MMC_SendCommand
                      (     mmc_func.asm):00034         ; MMC_SendCommandRaw
                      (     mmc_func.asm):00035         ; MMC_WaitNotBusy
                      (     mmc_func.asm):00036         ; MMC_WaitPutLatchRead
                      (     mmc_func.asm):00037                         
                      (     mmc_func.asm):00038         ;
                      (     mmc_func.asm):00039         ; Init buffer write
                      (     mmc_func.asm):00040         ;
ECCA                  (     mmc_func.asm):00041         MMC_InitSendBytes
ECCA 3402             (     mmc_func.asm):00042                         pshs    a
ECCC 8621             (     mmc_func.asm):00043                         lda             #CMD_INIT_WRITE                 ; Write bytes
ECCE BDE00E           (     mmc_func.asm):00044                         jsr             MMC_SendCmd                             ; send the command
ECD1 3582             (     mmc_func.asm):00045                         puls    a,pc
                      (     mmc_func.asm):00046                         
                      (     mmc_func.asm):00047                         ifne    0
                      (     mmc_func.asm):00048         ;
                      (     mmc_func.asm):00049         ; Init write buffer and send B bytes from X to MMC 
                      (     mmc_func.asm):00050         ;
                      (     mmc_func.asm):00051         
ECD3                  (     mmc_func.asm):00052         MMC_StartSendBBytes
                      (     mmc_func.asm):00053                         bsr             MMC_InitSendBytes
                      (     mmc_func.asm):00054                         endc
                      (     mmc_func.asm):00055                         
                      (     mmc_func.asm):00056         ;
                      (     mmc_func.asm):00057         ; Send B bytes pointed to by X to the WRITE_DATA_REG
                      (     mmc_func.asm):00058         ;
ECD3                  (     mmc_func.asm):00059         MMC_SendBBytes
ECD3 3416             (     mmc_func.asm):00060                         pshs    d,x
ECD5 5D               (     mmc_func.asm):00061                 tstb                            ; Is b zero ?
ECD6 2707             (     mmc_func.asm):00062                 beq     MMC_SendBBytesExit      ; yep : exit
                      (     mmc_func.asm):00063                         
ECD8                  (     mmc_func.asm):00064         MMC_SendBBytesLoop
ECD8 A680             (     mmc_func.asm):00065                 lda             ,x+                                             ; get a byte
                      (     mmc_func.asm):00066         
ECDA 8D2F             (     mmc_func.asm):00067                         bsr             MMC_WaitPutRead                 ; send byte, wait for AVR to read it
                      (     mmc_func.asm):00068         
ECDC 5A               (     mmc_func.asm):00069                         decb                                                    ; decrement count
ECDD 26F9             (     mmc_func.asm):00070                         bne             MMC_SendBBytesLoop              ; more : loop again
                      (     mmc_func.asm):00071         
ECDF                  (     mmc_func.asm):00072         MMC_SendBBytesExit
ECDF 3596             (     mmc_func.asm):00073                         puls    d,x,pc                                  ; restore and return
                      (     mmc_func.asm):00074                 
                      (     mmc_func.asm):00075         ;
                      (     mmc_func.asm):00076         ; Send U bytes pointed to by X to the WRITE_DATA_REG
                      (     mmc_func.asm):00077         ;       
                      (     mmc_func.asm):00078                 
ECE1                  (     mmc_func.asm):00079         MMC_SendUBytes
ECE1 3456             (     mmc_func.asm):00080                         pshs    u,d,x
                      (     mmc_func.asm):00081                 
ECE3                  (     mmc_func.asm):00082         MMC_SendUBytesLoop        
ECE3 11830000         (     mmc_func.asm):00083                 cmpu    #$0000                  ; U already zero?
ECE7 2708             (     mmc_func.asm):00084                 beq     MMC_SendUBytesExit      ; yep : exit
                      (     mmc_func.asm):00085                 
ECE9 A680             (     mmc_func.asm):00086                         lda             ,x+                                             ; get a byte
                      (     mmc_func.asm):00087         
ECEB 8D1E             (     mmc_func.asm):00088                         bsr             MMC_WaitPutRead                 ; send byte, wait for AVR to read it
                      (     mmc_func.asm):00089         
ECED 335F             (     mmc_func.asm):00090                         leau    -1,u                                    ; decrement count
ECEF 20F2             (     mmc_func.asm):00091                         bra             MMC_SendUBytesLoop              ; more : loop again
                      (     mmc_func.asm):00092         
ECF1                  (     mmc_func.asm):00093         MMC_SendUBytesExit
ECF1 35D6             (     mmc_func.asm):00094                 puls    u,d,x,pc
                      (     mmc_func.asm):00095         ;
                      (     mmc_func.asm):00096         ; Init buffer and write B bytes from X, and terminate with 0 byte 
                      (     mmc_func.asm):00097         ;       
                      (     mmc_func.asm):00098         ; MMC_Sendname2 differs from MMC_Sendname, in that it assumes that a write 
                      (     mmc_func.asm):00099         ; bytes command has already been written, for example if parameters have been 
                      (     mmc_func.asm):00100         ; written before the filename
                      (     mmc_func.asm):00101         ;
ECF3                  (     mmc_func.asm):00102         MMC_SendName
ECF3 8DD5             (     mmc_func.asm):00103                         bsr             MMC_InitSendBytes               ; start sending bytes
                      (     mmc_func.asm):00104         
ECF5                  (     mmc_func.asm):00105         MMC_SendName2
ECF5 3402             (     mmc_func.asm):00106                         pshs    a
ECF7 8DDA             (     mmc_func.asm):00107                         bsr             MMC_SendBBytes                  ; Send the bytes
                      (     mmc_func.asm):00108                         
ECF9 8600             (     mmc_func.asm):00109                         lda             #0                                              ; Send terminator
ECFB 8D0E             (     mmc_func.asm):00110                         bsr             MMC_WaitPutRead                 ; send byte, wait for AVR to read it
ECFD 3582             (     mmc_func.asm):00111                         puls    a,pc                                    ; restore and return
                      (     mmc_func.asm):00112                 
                      (     mmc_func.asm):00113         ;
                      (     mmc_func.asm):00114         ; Init buffer and write bytes from X, till a zero terminator reached.
                      (     mmc_func.asm):00115         ; does *NOT* send the zero terminator
                      (     mmc_func.asm):00116         ;
                      (     mmc_func.asm):00117         
ECFF                  (     mmc_func.asm):00118         MMC_SendTillZero
ECFF 8DC9             (     mmc_func.asm):00119                         bsr             MMC_InitSendBytes               ; start sending bytes
                      (     mmc_func.asm):00120         
ED01                  (     mmc_func.asm):00121         MMC_SendTillZeroLoop
ED01 A680             (     mmc_func.asm):00122                 lda     ,x+                     ; get a byte
ED03 4D               (     mmc_func.asm):00123                 tsta                            ; Zero?
ED04 2704             (     mmc_func.asm):00124                 beq     MMC_SendTillZeroExit    ; yep : stop sending
                      (     mmc_func.asm):00125                 
ED06 8D03             (     mmc_func.asm):00126                 bsr     MMC_WaitPutRead                 ; send byte, wait for AVR to read it
ED08 20F7             (     mmc_func.asm):00127                 bra     MMC_SendTillZeroLoop
                      (     mmc_func.asm):00128         
ED0A                  (     mmc_func.asm):00129         MMC_SendTillZeroExit
ED0A 39               (     mmc_func.asm):00130                 rts
                      (     mmc_func.asm):00131                 
                      (     mmc_func.asm):00132                         
                      (     mmc_func.asm):00133         ;               bra             MMC_WaitRead                    ; and wait for it to be read
                      (     mmc_func.asm):00134         ;
                      (     mmc_func.asm):00135         ; MMC_WaitPutRead Send a byte in a to the AVR DATA_REG and wait for it to read it
                      (     mmc_func.asm):00136         ;
                      (     mmc_func.asm):00137         
ED0B                  (     mmc_func.asm):00138         MMC_WaitPutRead 
ED0B B7FF52           (     mmc_func.asm):00139                         sta             D_WRITE_DATA_REG                ; send it, and fall through.....
                      (     mmc_func.asm):00140         
                      (     mmc_func.asm):00141         ;
                      (     mmc_func.asm):00142         ; MMC_WaitRead : waits for the AVR to read byte
                      (     mmc_func.asm):00143         ;
ED0E                  (     mmc_func.asm):00144         MMC_WaitRead
                      (     mmc_func.asm):00145                 ifndef  EMULATE
                      (     mmc_func.asm):00146         
ED0E                  (     mmc_func.asm):00147         MMC_WaitReadLoop
ED0E B6FF53           (     mmc_func.asm):00148                         lda             D_STATUS_REG
                      (     mmc_func.asm):00149         ;               anda    #STATUS_FLAG_READ               ; Has it been read yet ?
                      (     mmc_func.asm):00150         ;               bne             MMC_WaitReadLoop                ; no : keep waiting
                      (     mmc_func.asm):00151                 endc
ED11 39               (     mmc_func.asm):00152                         rts
                      (     mmc_func.asm):00153         
                      (     mmc_func.asm):00154         ;
                      (     mmc_func.asm):00155         ; MMC_WaitWritten, waits for the AVR to write a byte
                      (     mmc_func.asm):00156         ;
ED12                  (     mmc_func.asm):00157         MMC_WaitWritten
                      (     mmc_func.asm):00158                 ifndef  EMULATE
                      (     mmc_func.asm):00159                 
ED12                  (     mmc_func.asm):00160         MMC_WaitWrittenLoop
ED12 B6FF53           (     mmc_func.asm):00161                         lda             D_STATUS_REG
                      (     mmc_func.asm):00162         ;               anda    #STATUS_FLAG_WRITTEN    ; Written flag is it set ?
                      (     mmc_func.asm):00163         ;               beq             MMC_WaitWrittenLoop                     ; no : keep waiting
                      (     mmc_func.asm):00164                 endc
ED15 39               (     mmc_func.asm):00165                         rts
                      (     mmc_func.asm):00166         
                      (     mmc_func.asm):00167         ;
                      (     mmc_func.asm):00168         ; MMC_WaitGetWritten, wait for the AVR to write a byte, return it in a
                      (     mmc_func.asm):00169         ;
ED16                  (     mmc_func.asm):00170         MMC_WaitGetWritten
ED16 8DFA             (     mmc_func.asm):00171                         bsr             MMC_WaitWritten                 ; Wait for byte
ED18 B6FF52           (     mmc_func.asm):00172                         lda             D_READ_DATA_REG                 ; get byte
ED1B 39               (     mmc_func.asm):00173                         rts
                      (     mmc_func.asm):00174         
                      (     mmc_func.asm):00175                         ifndef  MINIMUM
                      (     mmc_func.asm):00176                         ifne    0
                      (     mmc_func.asm):00177         ;
                      (     mmc_func.asm):00178         ; MMC_WaitGetWrittenReturn, wait for the AVR to write a byte, return it to basic
                      (     mmc_func.asm):00179         ;
                      (     mmc_func.asm):00180         
ED1C                  (     mmc_func.asm):00181         MMC_WaitGetWrittenReturn
                      (     mmc_func.asm):00182                         bsr             MMC_WaitWritten                 ; Wait for byte
                      (     mmc_func.asm):00183                         ldb             D_READ_DATA_REG                 ; get byte
                      (     mmc_func.asm):00184                         jmp             VarAssign8Bit                   ; return it to basic
                      (     mmc_func.asm):00185         
                      (     mmc_func.asm):00186                         endc
                      (     mmc_func.asm):00187                         endc
                      (     mmc_func.asm):00188         ;
                      (     mmc_func.asm):00189         ; MMC_CloseFile : close current file
                      (     mmc_func.asm):00190         ;               
ED1C                  (     mmc_func.asm):00191         MMC_CloseFile
ED1C 8600             (     mmc_func.asm):00192                         lda             #CAS_FILE                               ; file id of cas file
ED1E BDE021           (     mmc_func.asm):00193                         jsr             MMC_WaitPutLatchRead    ; send it to latch register
                      (     mmc_func.asm):00194                 
ED21 8610             (     mmc_func.asm):00195                         lda             #CMD_FILE_CLOSE                 ; Close the file
ED23 17F2E8           (     mmc_func.asm):00196                         lbsr    MMC_SendCmd                             ; send the command
ED26 39               (     mmc_func.asm):00197                         rts
                      (     mmc_func.asm):00198         
                      (     mmc_func.asm):00199                         
                      (     mmc_func.asm):00200         ;
                      (     mmc_func.asm):00201         ; MMC_ReadFByte : Read a byte from a file and return it in a
                      (     mmc_func.asm):00202         ;
ED27                  (     mmc_func.asm):00203         MMC_ReadFByte
ED27 8601             (     mmc_func.asm):00204                         lda             #1                                              ; One byte
ED29 8D02             (     mmc_func.asm):00205                         bsr             MMC_ReadFCommon
ED2B 20E9             (     mmc_func.asm):00206                         bra             MMC_WaitGetWritten              ; get the byte, returned in a
                      (     mmc_func.asm):00207         
ED2D                  (     mmc_func.asm):00208         MMC_ReadFCommon
ED2D 3402             (     mmc_func.asm):00209                         pshs    a                                               ; save byte count
ED2F 8600             (     mmc_func.asm):00210                         lda             #CAS_FILE                               ; file id of cas file
ED31 BDE021           (     mmc_func.asm):00211                         jsr             MMC_WaitPutLatchRead    ; send it to latch register
ED34 3502             (     mmc_func.asm):00212                         puls    a                                               ; restore byte count
                      (     mmc_func.asm):00213                         
ED36 BDE021           (     mmc_func.asm):00214                         jsr             MMC_WaitPutLatchRead    ; send it to latch register
                      (     mmc_func.asm):00215                         
ED39 8622             (     mmc_func.asm):00216                         lda     #CMD_READ_BYTES                 ; Read bytes from file
ED3B 17F2D0           (     mmc_func.asm):00217                         lbsr    MMC_SendCmd                             ; send the command
                      (     mmc_func.asm):00218                         
ED3E 8620             (     mmc_func.asm):00219                         lda             #CMD_INIT_READ                  ; Read the byte
ED40 17F2D4           (     mmc_func.asm):00220                         lbsr    MMC_SendCmdRaw                  
ED43 39               (     mmc_func.asm):00221                         rts
                      (     mmc_func.asm):00222                         
                      (     mmc_func.asm):00223         ;
                      (     mmc_func.asm):00224         ; Read a block from open cas file, length in 
                      (     mmc_func.asm):00225         ; Entry :
                      (     mmc_func.asm):00226         ;       CasBlockLen     = size of block in bytes $00..$FF
                      (     mmc_func.asm):00227         ;       X                               = Pointer to buffer to recieve bytes
                      (     mmc_func.asm):00228         ;
                      (     mmc_func.asm):00229         ; Exit :
                      (     mmc_func.asm):00230         ;       X                               = Updated to point to byte after last byte read.
                      (     mmc_func.asm):00231         ;       a                               = error code, $00=none, $01=Csum error, $02=invalid dest addr
                      (     mmc_func.asm):00232         ;       CasCkSum                = Checksum of block
                      (     mmc_func.asm):00233         ;       
                      (     mmc_func.asm):00234         ;
                      (     mmc_func.asm):00235         
                      (     mmc_func.asm):00236                         ifndef  MINIMUM
                      (     mmc_func.asm):00237         
ED44                  (     mmc_func.asm):00238         MMC_ReadFBlock
ED44 8D07             (     mmc_func.asm):00239                         bsr             MMC_ReadFileBlockCas    ; read the block
ED46 7EB972           (     mmc_func.asm):00240                         jmp             CasRDCksum                              ; and back to the rom for the checksum
                      (     mmc_func.asm):00241         
                      (     mmc_func.asm):00242                         endc
                      (     mmc_func.asm):00243         ;               
                      (     mmc_func.asm):00244         ; Read a block pointed to by X from MMC 
                      (     mmc_func.asm):00245         ;
                      (     mmc_func.asm):00246         ; Entry :
                      (     mmc_func.asm):00247         ;       b                               = size of block in bytes $00..$FF
                      (     mmc_func.asm):00248         ;       X                               = Pointer to buffer to recieve bytes
                      (     mmc_func.asm):00249         ;
                      (     mmc_func.asm):00250         ; Exit :
                      (     mmc_func.asm):00251         ;       X                               = Updated to point to byte after last byte written.
                      (     mmc_func.asm):00252         ;
                      (     mmc_func.asm):00253         
ED49                  (     mmc_func.asm):00254         MMC_ReadFileBlock
ED49 D77D             (     mmc_func.asm):00255                         stb             <CasBlockLen            ; Save block length
ED4B D781             (     mmc_func.asm):00256                         stb             <CasIOErrorCode         ; running count
                      (     mmc_func.asm):00257                         
ED4D                  (     mmc_func.asm):00258         MMC_ReadFileBlockCas
ED4D 967D             (     mmc_func.asm):00259                         lda             <CasBlockLen            ; get length of block
ED4F 8DDC             (     mmc_func.asm):00260                         bsr             MMC_ReadFCommon         ; Set the bytes
                      (     mmc_func.asm):00261                         
ED51                  (     mmc_func.asm):00262         MMC_ReadFBlockLoop
ED51 17FFC2           (     mmc_func.asm):00263                         lbsr    MMC_WaitGetWritten      ; get the byte, returned in a
ED54 A784             (     mmc_func.asm):00264                         sta             ,x                                      ; save in buffer
ED56 A180             (     mmc_func.asm):00265                         cmpa    ,x+                                     ; Did it save ok ? 
ED58 2612             (     mmc_func.asm):00266                         bne             MMC_ReadFBlockError     ; Yep eat rest of read and return error
ED5A 9B80             (     mmc_func.asm):00267                         adda    <CasCkSum                       ; add read byte to checksum
ED5C 9780             (     mmc_func.asm):00268                 sta     <CasCkSum                       
ED5E 0A81             (     mmc_func.asm):00269                 dec     <CasIOErrorCode         ; decrement byte count
ED60 26EF             (     mmc_func.asm):00270                         bne             MMC_ReadFBlockLoop      ; Keep going if more bytes
                      (     mmc_func.asm):00271         
ED62 39               (     mmc_func.asm):00272                         rts
                      (     mmc_func.asm):00273                 
ED63 9080             (     mmc_func.asm):00274                         suba    <CasCkSum                       ; check against calculated checksum
ED65 2602             (     mmc_func.asm):00275                         bne             MMC_ReadFBlockExit
                      (     mmc_func.asm):00276                 
ED67 8601             (     mmc_func.asm):00277                         lda             #$01                            ; Flag error
                      (     mmc_func.asm):00278                 
ED69                  (     mmc_func.asm):00279         MMC_ReadFBlockExit
ED69 9781             (     mmc_func.asm):00280                         sta             <CasIOErrorCode         ; Save error code
ED6B 39               (     mmc_func.asm):00281                         rts     
                      (     mmc_func.asm):00282         
ED6C                  (     mmc_func.asm):00283         MMC_ReadFBlockError
ED6C 8602             (     mmc_func.asm):00284                         lda             #$02                            ; Flag error    
ED6E 20F9             (     mmc_func.asm):00285                         bra             MMC_ReadFBlockExit      
                      (     mmc_func.asm):00286                         
                      (     mmc_func.asm):00287         
                      (     mmc_func.asm):00288                         ifndef  MINIMUM
                      (     mmc_func.asm):00289         ;               
                      (     mmc_func.asm):00290         ; Read a block pointed to by X from MMC, does not use tape vars like MMC_ReadFileBlock 
                      (     mmc_func.asm):00291         ;
                      (     mmc_func.asm):00292         ; Entry :
                      (     mmc_func.asm):00293         ;       b                               = size of block in bytes $00..$FF
                      (     mmc_func.asm):00294         ;       X                               = Pointer to buffer to recieve bytes
                      (     mmc_func.asm):00295         ;
                      (     mmc_func.asm):00296         ; Exit :
                      (     mmc_func.asm):00297         ;       X                               = Updated to point to byte after last byte written.
                      (     mmc_func.asm):00298         ;
                      (     mmc_func.asm):00299         
ED70                  (     mmc_func.asm):00300         MMC_ReadFileBlockRaw
ED70 3404             (     mmc_func.asm):00301                 pshs    b                   ; save byte count                       
ED72 1E98             (     mmc_func.asm):00302                 exg     b,a                 ; get byte count
ED74 8DB7             (     mmc_func.asm):00303                 bsr     MMC_ReadFCommon     ; Tell AVR to read bytes & begin reading
                      (     mmc_func.asm):00304         
ED76 3504             (     mmc_func.asm):00305                 puls    b                   ; restore byte count
ED78                  (     mmc_func.asm):00306         MMC_ReadFileBlockRawLoop
ED78 17FF9B           (     mmc_func.asm):00307                         lbsr    MMC_WaitGetWritten      ; get the byte, returned in a
ED7B A780             (     mmc_func.asm):00308                         sta             ,x+                             ; save in buffer
ED7D 5A               (     mmc_func.asm):00309                 decb                        ; decrement byte count
ED7E 26F8             (     mmc_func.asm):00310                         bne             MMC_ReadFileBlockRawLoop ; Keep going if more bytes
                      (     mmc_func.asm):00311         
ED80 39               (     mmc_func.asm):00312                         rts
                      (     mmc_func.asm):00313         ;
                      (     mmc_func.asm):00314         ; Write a byte to open cas file, from a
                      (     mmc_func.asm):00315         ;
                      (     mmc_func.asm):00316                 
ED81                  (     mmc_func.asm):00317         MMC_WriteFByte
ED81 3402             (     mmc_func.asm):00318                         pshs    a
ED83 8621             (     mmc_func.asm):00319                         lda             #CMD_INIT_WRITE         ; Initiialise write
ED85 17F286           (     mmc_func.asm):00320                         lbsr    MMC_SendCmd                     ; send command
ED88 A6E4             (     mmc_func.asm):00321                         lda             ,s                                      ; peek a back off stack 
                      (     mmc_func.asm):00322                         
ED8A 17FF7E           (     mmc_func.asm):00323                         lbsr    MMC_WaitPutRead         ; send byte to AVR
                      (     mmc_func.asm):00324                         
ED8D 8600             (     mmc_func.asm):00325                         lda             #CAS_FILE                               ; file id of cas file
ED8F 17F28F           (     mmc_func.asm):00326                         lbsr    MMC_WaitPutLatchRead    ; send it to latch register
                      (     mmc_func.asm):00327                         
ED92 8601             (     mmc_func.asm):00328                         lda             #1                                      ; Write 1 byte
ED94 17F28A           (     mmc_func.asm):00329                         lbsr    MMC_WaitPutLatchRead    ; send it to latch register
                      (     mmc_func.asm):00330                         
ED97 8623             (     mmc_func.asm):00331                         lda             #CMD_WRITE_BYTES        ; Write bytes
ED99 17F272           (     mmc_func.asm):00332                         lbsr    MMC_SendCmd                     ; send command
                      (     mmc_func.asm):00333                         
ED9C 3582             (     mmc_func.asm):00334                         puls    a,pc                            ; restore and return
                      (     mmc_func.asm):00335         
                      (     mmc_func.asm):00336         ;
                      (     mmc_func.asm):00337         ; Read 2 bytes from file and into D
                      (     mmc_func.asm):00338         ;
ED9E                  (     mmc_func.asm):00339         MMC_ReadDFile        
ED9E 8602             (     mmc_func.asm):00340                 lda     #2                  ; 2 bytes
EDA0 8D8B             (     mmc_func.asm):00341                 bsr     MMC_ReadFCommon     ; go read them 
                      (     mmc_func.asm):00342         ;
                      (     mmc_func.asm):00343         ; Fetch two bytes into D register, assumes CMD_INIT_READ already reading bytes
                      (     mmc_func.asm):00344         ; 
                      (     mmc_func.asm):00345                         
EDA2                  (     mmc_func.asm):00346         MMC_ReadD
EDA2 17FF71           (     mmc_func.asm):00347                 lbsr    MMC_WaitGetWritten  ; get msb
EDA5 1E89             (     mmc_func.asm):00348                 exg     a,b                 ; swap them
EDA7 17FF6C           (     mmc_func.asm):00349                 lbsr    MMC_WaitGetWritten  ; get lsb
EDAA 1E89             (     mmc_func.asm):00350                 exg     a,b                 ; swap them back
EDAC 39               (     mmc_func.asm):00351                 rts
                      (     mmc_func.asm):00352         
                      (     mmc_func.asm):00353         ;
                      (     mmc_func.asm):00354         ; Send D register, assumes CMD_INIT_WRITE already sending bytes
                      (     mmc_func.asm):00355         ; 
                      (     mmc_func.asm):00356                         
EDAD                  (     mmc_func.asm):00357         MMC_WriteD
EDAD 3406             (     mmc_func.asm):00358                 pshs    d
EDAF 17FF59           (     mmc_func.asm):00359                 lbsr    MMC_WaitPutRead     ; send msb
EDB2 1E89             (     mmc_func.asm):00360                 exg     a,b                 ; swap them
EDB4 17FF54           (     mmc_func.asm):00361                 lbsr    MMC_WaitPutRead     ; send lsb
EDB7 3586             (     mmc_func.asm):00362                 puls    d,pc
                      (     mmc_func.asm):00363                 
                      (     mmc_func.asm):00364                 
                      (     mmc_func.asm):00365         ;
                      (     mmc_func.asm):00366         ; Write a block pointed to by X to MMC (tape emulation)
                      (     mmc_func.asm):00367         ;
                      (     mmc_func.asm):00368         ; Entry :
                      (     mmc_func.asm):00369         ;       CasBlockLen     = size of block in bytes $00..$FF
                      (     mmc_func.asm):00370         ;       CasIOErrorCode  = CasBlockLen
                      (     mmc_func.asm):00371         ;       X                               = Pointer to buffer to recieve bytes
                      (     mmc_func.asm):00372         ;
                      (     mmc_func.asm):00373         ; Exit :
                      (     mmc_func.asm):00374         ;       X                               = Updated to point to byte after last byte written.
                      (     mmc_func.asm):00375         ;
                      (     mmc_func.asm):00376         
EDB9                  (     mmc_func.asm):00377         MMC_WriteFBlock
EDB9 8D07             (     mmc_func.asm):00378                         bsr             MMC_WriteFileBlockCas   ; Write it
EDBB 7EB9C9           (     mmc_func.asm):00379                         jmp             CasWRCksum                              ; Jump back to rom
                      (     mmc_func.asm):00380         
                      (     mmc_func.asm):00381         ;               
                      (     mmc_func.asm):00382         ; Write a block pointed to by X to MMC 
                      (     mmc_func.asm):00383         ;
                      (     mmc_func.asm):00384         ; Entry :
                      (     mmc_func.asm):00385         ;       b                               = size of block in bytes $00..$FF
                      (     mmc_func.asm):00386         ;       X                               = Pointer to buffer to recieve bytes
                      (     mmc_func.asm):00387         ;
                      (     mmc_func.asm):00388         ; Exit :
                      (     mmc_func.asm):00389         ;       X                               = Updated to point to byte after last byte written.
                      (     mmc_func.asm):00390         ;
                      (     mmc_func.asm):00391         
EDBE                  (     mmc_func.asm):00392         MMC_WriteFileBlock
EDBE D77D             (     mmc_func.asm):00393                         stb             <CasBlockLen            ; Initialise block len / count
EDC0 D781             (     mmc_func.asm):00394                         stb             <CasIOErrorCode
                      (     mmc_func.asm):00395                         
EDC2                  (     mmc_func.asm):00396         MMC_WriteFileBlockCas
EDC2 8621             (     mmc_func.asm):00397                         lda             #CMD_INIT_WRITE         ; Initiialise write
EDC4 17F247           (     mmc_func.asm):00398                         lbsr    MMC_SendCmd                     ; send command
EDC7                  (     mmc_func.asm):00399         MMC_WriteFBlockLoop
                      (     mmc_func.asm):00400         ;               com             $401
EDC7 A680             (     mmc_func.asm):00401                         lda             ,x+                                     ; get byte to write
EDC9 17FF3F           (     mmc_func.asm):00402                         lbsr    MMC_WaitPutRead         ; send byte to AVR
                      (     mmc_func.asm):00403                 
EDCC 0A81             (     mmc_func.asm):00404                         dec     <CasIOErrorCode         ; Decrement count
EDCE 26F7             (     mmc_func.asm):00405                         bne             MMC_WriteFBlockLoop     ; More ? yep : keep going
                      (     mmc_func.asm):00406                         
EDD0 967D             (     mmc_func.asm):00407                         lda             <CasBlockLen            ; get length of block
EDD2                  (     mmc_func.asm):00408         MMC_WriteAFromAVRBuf
EDD2 3402             (     mmc_func.asm):00409                         pshs    a                                               ; save byte count
EDD4 8600             (     mmc_func.asm):00410                         lda             #CAS_FILE                               ; file id of cas file
EDD6 17F248           (     mmc_func.asm):00411                         lbsr    MMC_WaitPutLatchRead    ; send it to latch register
EDD9 3502             (     mmc_func.asm):00412                         puls    a                                               ; restore byte count
                      (     mmc_func.asm):00413                         
EDDB 17F243           (     mmc_func.asm):00414                         lbsr    MMC_WaitPutLatchRead    ; send it to latch register
                      (     mmc_func.asm):00415                                         
EDDE 8623             (     mmc_func.asm):00416                         lda             #CMD_WRITE_BYTES        ; Write it to the file
EDE0 17F22B           (     mmc_func.asm):00417                         lbsr    MMC_SendCmd                     ; send it
EDE3 39               (     mmc_func.asm):00418                         rts     
                      (     mmc_func.asm):00419         
                      (     mmc_func.asm):00420         ;
                      (     mmc_func.asm):00421         ; MMC_SaveFile, save to the open file 
                      (     mmc_func.asm):00422         ; 
                      (     mmc_func.asm):00423         ; Entry :
                      (     mmc_func.asm):00424         ;       u                               = Pointer to the file header for the file to save.
                      (     mmc_func.asm):00425         ;
                      (     mmc_func.asm):00426         
EDE4                  (     mmc_func.asm):00427         MMC_SaveFile
EDE4 C609             (     mmc_func.asm):00428                         ldb             #FileHeadLen            ; Header length
EDE6 30C4             (     mmc_func.asm):00429                         leax    ,u                                      ; point to header
EDE8 8DD4             (     mmc_func.asm):00430                         bsr             MMC_WriteFileBlock      ; Write the block
                      (     mmc_func.asm):00431         
EDEA AE42             (     mmc_func.asm):00432                         ldx             HdrLoad,u                       ; Get load address
                      (     mmc_func.asm):00433         
EDEC                  (     mmc_func.asm):00434         MMC_SaveFileLoop        
EDEC EC44             (     mmc_func.asm):00435                         ldd             HdrLen,u                        ; Get file length
EDEE 10830100         (     mmc_func.asm):00436                         cmpd    #$100                           ; > 256 bytes ?
EDF2 250A             (     mmc_func.asm):00437                         blo             MMC_SaveTail            ; no : last block
                      (     mmc_func.asm):00438         
EDF4 830100           (     mmc_func.asm):00439                         subd    #$100                           ; decrement length
EDF7 ED44             (     mmc_func.asm):00440                         std             HdrLen,u                        ; update
                      (     mmc_func.asm):00441                         
EDF9 5F               (     mmc_func.asm):00442                         clrb                                            ; flag 256 bytes
EDFA 8DC2             (     mmc_func.asm):00443                         bsr             MMC_WriteFileBlock      ; Write the block
EDFC 20EE             (     mmc_func.asm):00444                         bra             MMC_SaveFileLoop        ; Do next block 
                      (     mmc_func.asm):00445                         
EDFE                  (     mmc_func.asm):00446         MMC_SaveTail
EDFE 5D               (     mmc_func.asm):00447                         tstb                                            ; any more bytes ?
EDFF 2702             (     mmc_func.asm):00448                         beq             MMC_SaveFileExit        ; nope : exit
EE01 8DBB             (     mmc_func.asm):00449                         bsr             MMC_WriteFileBlock      ; Write the block
                      (     mmc_func.asm):00450                                         
EE03                  (     mmc_func.asm):00451         MMC_SaveFileExit
EE03 4F               (     mmc_func.asm):00452                         clra    
EE04 39               (     mmc_func.asm):00453                         rts
                      (     mmc_func.asm):00454                         
                      (     mmc_func.asm):00455         ;
                      (     mmc_func.asm):00456         ; MMC_LoadFile, load from the open file
                      (     mmc_func.asm):00457         ;
                      (     mmc_func.asm):00458         ; Entry :
                      (     mmc_func.asm):00459         ;       u       = Pointer to the file header for the file to load.
                      (     mmc_func.asm):00460         ; Exit :
                      (     mmc_func.asm):00461         ;       x       = pointer just beyond end of loaded buffer.
                      (     mmc_func.asm):00462         ;
                      (     mmc_func.asm):00463         
                      (     mmc_func.asm):00464         
EE05                  (     mmc_func.asm):00465         MMC_LoadFile
EE05 AE44             (     mmc_func.asm):00466                         ldx             HdrLen,u                        ; Get length
EE07 3410             (     mmc_func.asm):00467                         pshs    x                                       ; save on stack
EE09 AE42             (     mmc_func.asm):00468                         ldx             HdrLoad,u                       ; get load address
EE0B 2002             (     mmc_func.asm):00469                         bra             MMC_LoadFileLoop        ; go do it
                      (     mmc_func.asm):00470         
                      (     mmc_func.asm):00471         ;
                      (     mmc_func.asm):00472         ; MMC_LoadFile2, load from the open file
                      (     mmc_func.asm):00473         ;
                      (     mmc_func.asm):00474         ; Entry :
                      (     mmc_func.asm):00475         ;   x   = Pointer to buffer to load file into
                      (     mmc_func.asm):00476         ;       u       = Bytes to read from the file.
                      (     mmc_func.asm):00477         ; Exit :
                      (     mmc_func.asm):00478         ;       x       = pointer just beyond end of loaded buffer.
                      (     mmc_func.asm):00479         ;
                      (     mmc_func.asm):00480         
EE0D                  (     mmc_func.asm):00481         MMC_LoadFile2
EE0D 3440             (     mmc_func.asm):00482                         pshs    u                                       ; save length   
                      (     mmc_func.asm):00483                         
EE0F                  (     mmc_func.asm):00484         MMC_LoadFileLoop
EE0F ECE4             (     mmc_func.asm):00485                         ldd             ,s                                      ; Get length remaining
EE11 10830100         (     mmc_func.asm):00486                         cmpd    #$100                           ; > 256 bytes ?
EE15 250B             (     mmc_func.asm):00487                         blo             MMC_LoadTail            ; no : last block
                      (     mmc_func.asm):00488                         
EE17 830100           (     mmc_func.asm):00489                         subd    #$100                           ; decrement remaining length
EE1A EDE4             (     mmc_func.asm):00490                         std             ,s                                      ; update
                      (     mmc_func.asm):00491                         
EE1C 5F               (     mmc_func.asm):00492                         clrb                                            ; flag 256 bytes
EE1D 17FF29           (     mmc_func.asm):00493                         lbsr    MMC_ReadFileBlock       ; read next block
EE20 20ED             (     mmc_func.asm):00494                         bra             MMC_LoadFileLoop        ; do next block
                      (     mmc_func.asm):00495                         
EE22                  (     mmc_func.asm):00496         MMC_LoadTail
EE22 5D               (     mmc_func.asm):00497                         tstb                                            ; any more bytes ?
EE23 2703             (     mmc_func.asm):00498                         beq             MMC_LoadFileExit        ; nope : exit
EE25 17FF21           (     mmc_func.asm):00499                         lbsr    MMC_ReadFileBlock       ; load last block
                      (     mmc_func.asm):00500                         
EE28                  (     mmc_func.asm):00501         MMC_LoadFileExit
EE28 3262             (     mmc_func.asm):00502                         leas    2,s                                     ; drop saved count
EE2A 4F               (     mmc_func.asm):00503                         clra
EE2B 39               (     mmc_func.asm):00504                         rts
                      (     mmc_func.asm):00505         
                      (     mmc_func.asm):00506                 ifeq    1
                      (     mmc_func.asm):00507         ;
                      (     mmc_func.asm):00508         ; Send LBA to AVR
                      (     mmc_func.asm):00509         ;
EE2C                  (     mmc_func.asm):00510         MMC_SendLBA
                      (     mmc_func.asm):00511                         pshs    u,d
                      (     mmc_func.asm):00512                         lbsr    MMC_InitSendBytes       ; Begin sending bytes
                      (     mmc_func.asm):00513                         
                      (     mmc_func.asm):00514                         lbsr    MMC_WaitPutRead         ; send drive id it
                      (     mmc_func.asm):00515                         
                      (     mmc_func.asm):00516                         exg             u,d                                     ; get LSW of LBA
                      (     mmc_func.asm):00517                         exg             a,b                                     ; move lsb into a
                      (     mmc_func.asm):00518                         
                      (     mmc_func.asm):00519                         lbsr    MMC_WaitPutRead         ; send LSB of LSN
                      (     mmc_func.asm):00520                         
                      (     mmc_func.asm):00521                         exg             a,b                                     ; get next byte of LBA
                      (     mmc_func.asm):00522                         
                      (     mmc_func.asm):00523                         lbsr    MMC_WaitPutRead         ; send it
                      (     mmc_func.asm):00524                         
                      (     mmc_func.asm):00525                         exg             d,u                                     ; retrieve MSB
                      (     mmc_func.asm):00526                         
                      (     mmc_func.asm):00527                         exg             a,b                                     ; move lsb into a
                      (     mmc_func.asm):00528                         lbsr    MMC_WaitPutRead         ; send it
                      (     mmc_func.asm):00529         
                      (     mmc_func.asm):00530                         clra                                            ; msb of LSN always 0
                      (     mmc_func.asm):00531                         lbsr    MMC_WaitPutRead         ; send it
                      (     mmc_func.asm):00532         
                      (     mmc_func.asm):00533                         lda             #CMD_LOAD_PARAM         ; Tell AVR
                      (     mmc_func.asm):00534                         lbsr    MMC_SendCmd                     ; send command
                      (     mmc_func.asm):00535                         
                      (     mmc_func.asm):00536                         puls    u,d,pc                          ; restore / return
                      (     mmc_func.asm):00537                 
                      (     mmc_func.asm):00538                 endc
                      (     mmc_func.asm):00539                         
                      (     mmc_func.asm):00540         ;
                      (     mmc_func.asm):00541         ; MMC_ReadDOSSec,  Read an emulated dos sector
                      (     mmc_func.asm):00542         ; MMC_ReadDOSSec2  Read just the first two bytes, used by 'BOOT'
                      (     mmc_func.asm):00543         ;
                      (     mmc_func.asm):00544         ; Entry :
                      (     mmc_func.asm):00545         ;       A       = drive id
                      (     mmc_func.asm):00546         ;       X       = buffer
                      (     mmc_func.asm):00547         ;
                      (     mmc_func.asm):00548         ; Before calling :
                      (     mmc_func.asm):00549         ; Drive track should have been set with a call to MMC_SeekCheck
                      (     mmc_func.asm):00550         ; Head and Sector number should have been set with a call to MMC_SendHR
                      (     mmc_func.asm):00551         ;
                      (     mmc_func.asm):00552         ; Note for whatever path this code takes it should always pickup the
                      (     mmc_func.asm):00553         ; simulated WD error at the end
                      (     mmc_func.asm):00554         ;
                      (     mmc_func.asm):00555         
EE2C                  (     mmc_func.asm):00556         MMC_ReadDOSSec
                      (     mmc_func.asm):00557         ;        jsr     >CON_DumpRegs
EE2C 8D1F             (     mmc_func.asm):00558                         bsr             MMC_ReadDOSSecInit      ; init the read
EE2E 2B11             (     mmc_func.asm):00559                         bmi             MMC_ReadDOSSecEExit     ; Error : exit
                      (     mmc_func.asm):00560                         
EE30 5F               (     mmc_func.asm):00561                         clrb                                            ; init count
EE31 2006             (     mmc_func.asm):00562                         bra             MMC_ReadDOSSecLoopB     ; Go read the data
                      (     mmc_func.asm):00563         
EE33                  (     mmc_func.asm):00564         MMC_ReadDOSSec2
EE33 8D18             (     mmc_func.asm):00565                         bsr             MMC_ReadDOSSecInit      ; init the read
EE35 2B0A             (     mmc_func.asm):00566                         bmi             MMC_ReadDOSSecEExit     ; Error : exit
EE37 C6FE             (     mmc_func.asm):00567                         ldb             #$FE                            ; init count, reads 2 bytes
                      (     mmc_func.asm):00568                 
EE39                  (     mmc_func.asm):00569         MMC_ReadDOSSecLoopB
                      (     mmc_func.asm):00570         ;               lbsr    ConWriteHexX
EE39                  (     mmc_func.asm):00571         MMC_ReadDOSSecLoop              
EE39 17FEDA           (     mmc_func.asm):00572                         lbsr    MMC_WaitGetWritten      ; wait for byte
EE3C A780             (     mmc_func.asm):00573                         sta             ,x+                                     ; save in buffer
EE3E 5C               (     mmc_func.asm):00574                         incb                                            ; inc count
EE3F 26F8             (     mmc_func.asm):00575                         bne             MMC_ReadDOSSecLoop      ; not done, loop again
                      (     mmc_func.asm):00576                         
EE41                  (     mmc_func.asm):00577         MMC_ReadDOSSecEExit
EE41 8D33             (     mmc_func.asm):00578                         bsr             MMC_GetWDError
EE43 39               (     mmc_func.asm):00579                         rts
                      (     mmc_func.asm):00580         
                      (     mmc_func.asm):00581         ;
                      (     mmc_func.asm):00582         ; Read the next dos sector, must be preceeded by a call to 
                      (     mmc_func.asm):00583         ; MMC_ReadDOSSec, that will correctly set the starting LSN and drive ID.
                      (     mmc_func.asm):00584         ;
                      (     mmc_func.asm):00585         ; Entry :
                      (     mmc_func.asm):00586         ;       X       = buffer
                      (     mmc_func.asm):00587         ;
                      (     mmc_func.asm):00588         
EE44                  (     mmc_func.asm):00589         MMC_ReadNextDOSSec
EE44 8D03             (     mmc_func.asm):00590                         bsr             MMC_ReadDOSSecInitNext  ; Init the read
EE46 5F               (     mmc_func.asm):00591                         clrb                                            ; init count
EE47 20F0             (     mmc_func.asm):00592                         bra             MMC_ReadDOSSecLoopB     ; Go read the data              
                      (     mmc_func.asm):00593         
EE49                  (     mmc_func.asm):00594         MMC_ReadDOSSecInitNext
EE49 864B             (     mmc_func.asm):00595                         lda             #CMD_READ_NEXT_IMG_SEC  ; read next sector
EE4B 2002             (     mmc_func.asm):00596                         bra             MMC_ReadDOSSecInit2
                      (     mmc_func.asm):00597         
EE4D                  (     mmc_func.asm):00598         MMC_ReadDOSSecInit
EE4D 8643             (     mmc_func.asm):00599                         lda             #CMD_READ_IMG_SEC       ; Read sector from AVR
EE4F                  (     mmc_func.asm):00600         MMC_ReadDOSSecInit2             
EE4F 17F1BC           (     mmc_func.asm):00601                         lbsr    MMC_SendCmd                     ; send command
EE52 2B05             (     mmc_func.asm):00602                         bmi             MMC_ReadDOSSecExit      ; if error handle it
                      (     mmc_func.asm):00603                         
EE54 8620             (     mmc_func.asm):00604                         lda             #CMD_INIT_READ          ; read the sector
EE56 17F1BE           (     mmc_func.asm):00605                         lbsr    MMC_SendCmdRaw          ; send command
                      (     mmc_func.asm):00606         
EE59                  (     mmc_func.asm):00607         MMC_ReadDOSSecExit
EE59 39               (     mmc_func.asm):00608                         rts
                      (     mmc_func.asm):00609         
                      (     mmc_func.asm):00610         ;
                      (     mmc_func.asm):00611         ; MMC_WriteDOSSec,  Read an emulated dos sector
                      (     mmc_func.asm):00612         ;
                      (     mmc_func.asm):00613         ; Entry :
                      (     mmc_func.asm):00614         ;       A       = drive id
                      (     mmc_func.asm):00615         ;       X       = buffer
                      (     mmc_func.asm):00616         ;
                      (     mmc_func.asm):00617         ; Before calling :
                      (     mmc_func.asm):00618         ; Drive track should have been set with a call to MMC_SeekCheck
                      (     mmc_func.asm):00619         ; Head and Sector number should have been set with a call to MMC_SendHR
                      (     mmc_func.asm):00620         ;
                      (     mmc_func.asm):00621         ; Note for whatever path this code takes it should always pickup the
                      (     mmc_func.asm):00622         ; simulated WD error at the end
                      (     mmc_func.asm):00623         ;
                      (     mmc_func.asm):00624         
EE5A                  (     mmc_func.asm):00625         MMC_WriteDOSSec
EE5A 8D14             (     mmc_func.asm):00626                         bsr             MMC_WriteDOSSecInit     ; init the write
EE5C 25FB             (     mmc_func.asm):00627                         bcs             MMC_ReadDOSSecExit      ; Error : exit
                      (     mmc_func.asm):00628                         
EE5E 3440             (     mmc_func.asm):00629                 pshs    u
EE60 CE0100           (     mmc_func.asm):00630                         ldu     #$100                           ; send 256 bytes
EE63 17FE7B           (     mmc_func.asm):00631                         lbsr    MMC_SendUBytes          ; send 256 bytes from x
EE66 3540             (     mmc_func.asm):00632                         puls    u
                      (     mmc_func.asm):00633                 
EE68 8644             (     mmc_func.asm):00634                         lda             #CMD_WRITE_IMG_SEC      ; write the sector
EE6A 17F1A1           (     mmc_func.asm):00635                         lbsr    MMC_SendCmd
                      (     mmc_func.asm):00636         
EE6D 8D07             (     mmc_func.asm):00637                         bsr             MMC_GetWDError          ; Get simulated WD error        
EE6F 39               (     mmc_func.asm):00638                         rts
                      (     mmc_func.asm):00639         
                      (     mmc_func.asm):00640         
EE70                  (     mmc_func.asm):00641         MMC_WriteDOSSecInit
                      (     mmc_func.asm):00642         ;               bsr             MMC_SendLBA                     ; send LBA to AVR
                      (     mmc_func.asm):00643                         
EE70 8621             (     mmc_func.asm):00644                         lda             #CMD_INIT_WRITE         ; Prepare to send the data
EE72 17F199           (     mmc_func.asm):00645                         lbsr    MMC_SendCmd                     ; send command
EE75 39               (     mmc_func.asm):00646                         rts
                      (     mmc_func.asm):00647         
                      (     mmc_func.asm):00648         ;
                      (     mmc_func.asm):00649         ; Get the simulated WD17xx/WD27xx error from the AVR
                      (     mmc_func.asm):00650         ; simulated WD error returned in a
                      (     mmc_func.asm):00651         ;
EE76                  (     mmc_func.asm):00652         MMC_GetWDError
EE76 864A             (     mmc_func.asm):00653                         lda             #CMD_GET_FDC_STATUS     ; Get status
EE78 17F193           (     mmc_func.asm):00654                         lbsr    MMC_SendCmd                     ; send command
EE7B 4D               (     mmc_func.asm):00655                         tsta                                            ; set flags
EE7C 39               (     mmc_func.asm):00656                         rts
                      (     mmc_func.asm):00657         
                      (     mmc_func.asm):00658         ;
                      (     mmc_func.asm):00659         ; Check to see if image is valid and we can seek to track.
                      (     mmc_func.asm):00660         ; track to seek to in a
                      (     mmc_func.asm):00661         ;
                      (     mmc_func.asm):00662         ; Entry :
                      (     mmc_func.asm):00663         ;       A       = Drive id 0..3
                      (     mmc_func.asm):00664         ;       B       = Track 0..79
                      (     mmc_func.asm):00665         ; Exit :
                      (     mmc_func.asm):00666         ;       A       = Simulated WD error.
                      (     mmc_func.asm):00667         ;
                      (     mmc_func.asm):00668         
EE7D                  (     mmc_func.asm):00669         MMC_SeekCheck
EE7D 3404             (     mmc_func.asm):00670                         pshs    b
EE7F 17FE48           (     mmc_func.asm):00671                         lbsr    MMC_InitSendBytes       ; Send drive id and track to AVR
                      (     mmc_func.asm):00672                         
EE82 17FE86           (     mmc_func.asm):00673                         lbsr    MMC_WaitPutRead         ; send drive id to AVR
EE85 3502             (     mmc_func.asm):00674                         puls    a                                       ; recover track
EE87 17FE81           (     mmc_func.asm):00675                         lbsr    MMC_WaitPutRead         ; send track AVR
                      (     mmc_func.asm):00676                         
EE8A 8648             (     mmc_func.asm):00677                         lda             #CMD_IMG_SEEK           ; Try the seek
EE8C 17F17F           (     mmc_func.asm):00678                         lbsr    MMC_SendCmd
                      (     mmc_func.asm):00679                         
EE8F 8DE5             (     mmc_func.asm):00680                         bsr             MMC_GetWDError          ; Get simulated WD error
EE91 39               (     mmc_func.asm):00681                         rts
                      (     mmc_func.asm):00682                         
                      (     mmc_func.asm):00683         ;
                      (     mmc_func.asm):00684         ; Send first and last drive ids to MMC for list drives command
                      (     mmc_func.asm):00685         ;
                      (     mmc_func.asm):00686         ; Entry :
                      (     mmc_func.asm):00687         ;       A       = First drive id 0..3
                      (     mmc_func.asm):00688         ;       B       = Second drive id 0..3
                      (     mmc_func.asm):00689         ; Exit :
                      (     mmc_func.asm):00690                 
EE92                  (     mmc_func.asm):00691         MMC_SendDriveIDs
EE92 17FE35           (     mmc_func.asm):00692                 lbsr    MMC_InitSendBytes  ; Init writing bytes
                      (     mmc_func.asm):00693                 
EE95 17FE73           (     mmc_func.asm):00694                 lbsr    MMC_WaitPutRead     ; send first drive
EE98 1E98             (     mmc_func.asm):00695                 exg     b,a                 ; get second drive
EE9A 17FE6E           (     mmc_func.asm):00696                 lbsr    MMC_WaitPutRead     ; send second drive
EE9D 39               (     mmc_func.asm):00697                 rts
                      (     mmc_func.asm):00698           
                      (     mmc_func.asm):00699         ;
                      (     mmc_func.asm):00700         ; issue a format image command.
                      (     mmc_func.asm):00701         ; Entry :
                      (     mmc_func.asm):00702         ;   A = Drive id 0..3
                      (     mmc_func.asm):00703         ;   B = Tracks / sides, b7=0 single sided,  b7=1 double sided.
                      (     mmc_func.asm):00704         ;
EE9E                  (     mmc_func.asm):00705         MMC_FormatImage
EE9E BDECCA           (     mmc_func.asm):00706                 jsr         >MMC_InitSendBytes ; Init writing bytes
                      (     mmc_func.asm):00707                 
EEA1 BDED0B           (     mmc_func.asm):00708                 jsr     >MMC_WaitPutRead    ; send drive id
                      (     mmc_func.asm):00709         
EEA4 1F98             (     mmc_func.asm):00710                 tfr     b,a                 ; get tracks LSB
EEA6 847F             (     mmc_func.asm):00711                 anda    #$7F                ; mask out sides
EEA8 BDED0B           (     mmc_func.asm):00712                 jsr     >MMC_WaitPutRead    ; tracks LSB
                      (     mmc_func.asm):00713                         
EEAB 4F               (     mmc_func.asm):00714                 clra                        ; Send MSB of tracks = 0
EEAC BDED0B           (     mmc_func.asm):00715                 jsr     >MMC_WaitPutRead    ; tracks MSB
                      (     mmc_func.asm):00716                      
EEAF 8601             (     mmc_func.asm):00717                 lda     #$01                ; Assume single sided
EEB1 5D               (     mmc_func.asm):00718                 tstb                        ; check for double sided
EEB2 2A01             (     mmc_func.asm):00719                 bpl     MMC_FormatImageSS   ; no : skip
EEB4 4C               (     mmc_func.asm):00720                 inca
                      (     mmc_func.asm):00721                 
EEB5                  (     mmc_func.asm):00722         MMC_FormatImageSS
EEB5 BDED0B           (     mmc_func.asm):00723                 jsr     >MMC_WaitPutRead    ; heads
EEB8 8612             (     mmc_func.asm):00724                 lda     #SectorsPerTrack    ; 18 sectors / track
EEBA BDED0B           (     mmc_func.asm):00725                 jsr     >MMC_WaitPutRead    
                      (     mmc_func.asm):00726                 
EEBD 8649             (     mmc_func.asm):00727                 lda     #CMD_CREATE_IMG     ; Send command
                      (     mmc_func.asm):00728                 
EEBF 17F14C           (     mmc_func.asm):00729                 lbsr    MMC_SendCmd
EEC2 39               (     mmc_func.asm):00730                 rts
                      (     mmc_func.asm):00731         
                      (     mmc_func.asm):00732         ;
                      (     mmc_func.asm):00733         ; Send Head and record (sector) number.
                      (     mmc_func.asm):00734         ; Logical sector no in a, 1..36 for Dragondos 1..18 for RSDOS
                      (     mmc_func.asm):00735         ; DragonDos version needs to deal with both head and sector
                      (     mmc_func.asm):00736         ; 
                      (     mmc_func.asm):00737         
                      (     mmc_func.asm):00738                 ifdef    Dragon
EEC3                  (     mmc_func.asm):00739         MMC_SendHR       
                      (     mmc_func.asm):00740                 
EEC3 3402             (     mmc_func.asm):00741                 pshs    a
EEC5 BDECCA           (     mmc_func.asm):00742                 jsr         >MMC_InitSendBytes ; Init writing bytes
                      (     mmc_func.asm):00743                 
EEC8 D6EB             (     mmc_func.asm):00744                 ldb     <DosDriveNo             ; Get drive no
EECA 5A               (     mmc_func.asm):00745                 decb
EECB 1E89             (     mmc_func.asm):00746                 exg     a,b                 ; swap it into a
                      (     mmc_func.asm):00747                 
EECD BDED0B           (     mmc_func.asm):00748                 jsr     >MMC_WaitPutRead    ; send drive id
EED0 1E89             (     mmc_func.asm):00749                 exg     a,b                 ; recover sector no
                      (     mmc_func.asm):00750         
EED2 5F               (     mmc_func.asm):00751                 clrb                        ; Head no -1
EED3 8112             (     mmc_func.asm):00752                 cmpa    #SectorsPerTrack    ; > Sectors / Track, if so on side 2
EED5 2303             (     mmc_func.asm):00753                 bls     MMC_SendHR_side0    ; lower, on side 0
                      (     mmc_func.asm):00754                 
EED7 8012             (     mmc_func.asm):00755                 suba    #SectorsPerTrack    ; get correct sector no
EED9 5C               (     mmc_func.asm):00756                 incb                        ; on side 2
                      (     mmc_func.asm):00757                 
EEDA                  (     mmc_func.asm):00758         MMC_SendHR_side0
EEDA 1E89             (     mmc_func.asm):00759                 exg     a,b                 ; send head first
EEDC BDED0B           (     mmc_func.asm):00760                 jsr     >MMC_WaitPutRead    ; send head       
EEDF 1E89             (     mmc_func.asm):00761                 exg     a,b                 ; get sec no into a
EEE1 4A               (     mmc_func.asm):00762                 deca
EEE2 BDED0B           (     mmc_func.asm):00763                 jsr     >MMC_WaitPutRead    ; send it
                      (     mmc_func.asm):00764                 
EEE5 864C             (     mmc_func.asm):00765                 lda     #CMD_LOAD_HR        ; set sector and head
EEE7 BDE00E           (     mmc_func.asm):00766                 jsr     >MMC_SendCmd
                      (     mmc_func.asm):00767                 
EEEA 3582             (     mmc_func.asm):00768                 puls    a,pc                ; restore and return.
                      (     mmc_func.asm):00769                 
                      (     mmc_func.asm):00770                 else
                      (     mmc_func.asm):00771         
                      (     mmc_func.asm):00772         ;
                      (     mmc_func.asm):00773         ; RSDOS version, much simpler as head is always 0
                      (     mmc_func.asm):00774         ;
                      (     mmc_func.asm):00775         
EEEC                  (     mmc_func.asm):00776         MMC_SendHR       
                      (     mmc_func.asm):00777         
                      (     mmc_func.asm):00778                 pshs    a
                      (     mmc_func.asm):00779                 jsr         >MMC_InitSendBytes ; Init writing bytes
                      (     mmc_func.asm):00780                 
                      (     mmc_func.asm):00781                 ldb     dcdrv               ; Get drive no
                      (     mmc_func.asm):00782                 exg     a,b                 ; swap it into a
                      (     mmc_func.asm):00783                 
                      (     mmc_func.asm):00784                 jsr     >MMC_WaitPutRead    ; send drive id
                      (     mmc_func.asm):00785          
                      (     mmc_func.asm):00786                 clra    
                      (     mmc_func.asm):00787                 jsr     >MMC_WaitPutRead    ; send head, always 0 for RSDOS
                      (     mmc_func.asm):00788                
                      (     mmc_func.asm):00789                 exg     a,b                 ; get sec no into a
                      (     mmc_func.asm):00790                 deca
                      (     mmc_func.asm):00791                 jsr     >MMC_WaitPutRead    ; send it
                      (     mmc_func.asm):00792                 
                      (     mmc_func.asm):00793                 lda     #CMD_LOAD_HR        ; set sector and head
                      (     mmc_func.asm):00794                 jsr     >MMC_SendCmd
                      (     mmc_func.asm):00795                 
                      (     mmc_func.asm):00796                 puls    a,pc                ; restore and return.
                      (     mmc_func.asm):00797                 
                      (     mmc_func.asm):00798                 endc
                      (     mmc_func.asm):00799                 
                      (     mmc_func.asm):00800                 
                      (     mmc_func.asm):00801         ;
                      (     mmc_func.asm):00802         ; Get disk geometry of drive in DosLastDrive
                      (     mmc_func.asm):00803         ;
                      (     mmc_func.asm):00804         ; Entry : DosLastDrive contains drive to interigate
                      (     mmc_func.asm):00805         ; Exit  : DosDxTracks and DosDxSecTrack set for drive
                      (     mmc_func.asm):00806         ;                 Also returned in A=Tracks, B=Sec/Trk
                      (     mmc_func.asm):00807         ;
                      (     mmc_func.asm):00808         ; If an error occours, or a geometry block is not present
                      (     mmc_func.asm):00809         ; defaults to standard single sided, 40 track.
                      (     mmc_func.asm):00810         ;
                      (     mmc_func.asm):00811         
                      (     mmc_func.asm):00812                         ifne    0
EEEC                  (     mmc_func.asm):00813         MMC_GetGeom
                      (     mmc_func.asm):00814                         pshs    x
                      (     mmc_func.asm):00815                         lda             <DosLastDrive           ; Pickup drive id
                      (     mmc_func.asm):00816                         deca                                            ; make zero based
                      (     mmc_func.asm):00817         
                      (     mmc_func.asm):00818                         ldx             #DosD0Online            ; Point to tables for this drive
                      (     mmc_func.asm):00819                         leax    a,x
                      (     mmc_func.asm):00820         
                      (     mmc_func.asm):00821                         lbsr    MMC_WaitPutLatchRead    ; send the drive id             
                      (     mmc_func.asm):00822                         
                      (     mmc_func.asm):00823                         lda             #CMD_IMG_GET_GEOM       ; get geometry
                      (     mmc_func.asm):00824                         lbsr    MMC_SendCmd                     ; send command
                      (     mmc_func.asm):00825                         
                      (     mmc_func.asm):00826                         lda             #CMD_INIT_READ          ; Read the results
                      (     mmc_func.asm):00827                         lbsr    MMC_SendCmdRaw          ; send command
                      (     mmc_func.asm):00828                         
                      (     mmc_func.asm):00829                         lbsr    MMC_WaitGetWritten      ; get sec/track
                      (     mmc_func.asm):00830                         
                      (     mmc_func.asm):00831                         sta             DosSecTrkTblOfs,x       ; save sec/trk it
                      (     mmc_func.asm):00832                         exg             a,b                                     ; get sec / trk in b
                      (     mmc_func.asm):00833                 
                      (     mmc_func.asm):00834                         lbsr    MMC_WaitGetWritten      ; get tracks
                      (     mmc_func.asm):00835                         sta             DosTracksTblOfs,x       ; save tracks it
                      (     mmc_func.asm):00836                         
                      (     mmc_func.asm):00837                         puls    x,pc                            ; restore / return
                      (     mmc_func.asm):00838                         endc 
                      (     mmc_func.asm):00839                         
                      (     mmc_func.asm):00840                         endc
                      (     mmc_func.asm):00841                         
EEEC                  (     mmc_func.asm):00842         __mmc_func_end
                      (    DragonMMC.asm):00676                         use             console.asm
                      (      console.asm):00001         ;
                      (      console.asm):00002         ; Console.asm : write things to Dragon screen.
                      (      console.asm):00003         ;
                      (      console.asm):00004         ; Define MINIMUM to exclude code not needed by FLASH
                      (      console.asm):00005         ;
                      (      console.asm):00006         ; 2017-03-22, removed all calls to TextOutString, **DO NOT** put any back in
                      (      console.asm):00007         ; as they mess with the system area too much.
                      (      console.asm):00008         ; use CON_WriteString instead.
                      (      console.asm):00009         ;
EEEC                  (      console.asm):00010         __console
                      (      console.asm):00011         
                      (      console.asm):00012         ; Set CONDEB to 1 to include console debugging code usefull for debugging
                      (      console.asm):00013         ; other routines, but not needed when building release version.
     0001             (      console.asm):00014         CONDEB  equ             1       
                      (      console.asm):00015         
                      (      console.asm):00016                         ifne    CONDEB
EEEC                  (      console.asm):00017         CON_WriteHexX
EEEC 3406             (      console.asm):00018                         pshs    d
EEEE 1F10             (      console.asm):00019                         tfr             x,d
EEF0 8D0C             (      console.asm):00020                         bsr             CON_WriteHexWordS               ; Write x
EEF2 3586             (      console.asm):00021                         puls    d,pc
                      (      console.asm):00022                         
                      (      console.asm):00023         ;
                      (      console.asm):00024         ; Write hex word in D.
                      (      console.asm):00025         ;
                      (      console.asm):00026         
EEF4                  (      console.asm):00027         CON_WriteHexWord
EEF4 3406             (      console.asm):00028                         pshs    d                                           ; save d
EEF6 8D0A             (      console.asm):00029                         bsr             CON_WriteHexByte                ; Write MSB
EEF8 1E89             (      console.asm):00030                         exg             a,b                                         ; get LSB
EEFA 8D06             (      console.asm):00031                         bsr             CON_WriteHexByte                ; Write LSB
EEFC 3586             (      console.asm):00032                         puls    d,pc                                ; restore / return
                      (      console.asm):00033         
EEFE                  (      console.asm):00034         CON_WriteHexWordS
EEFE 8DF4             (      console.asm):00035                         bsr             CON_WriteHexWord                ; Write word
EF00 2016             (      console.asm):00036                         bra             CON_WriteSpace              ; write space
                      (      console.asm):00037                         endc
                      (      console.asm):00038                         
                      (      console.asm):00039         ;
                      (      console.asm):00040         ; Write byte in a as hex followed by space.
                      (      console.asm):00041         ;
                      (      console.asm):00042                         
EF02                  (      console.asm):00043         CON_WriteHexByte
EF02 3402             (      console.asm):00044                         pshs    a
                      (      console.asm):00045                 
EF04 44               (      console.asm):00046                         lsra                                                ; Move msn to lsn
EF05 44               (      console.asm):00047                         lsra    
EF06 44               (      console.asm):00048                         lsra    
EF07 44               (      console.asm):00049                         lsra    
                      (      console.asm):00050         
EF08 8D27             (      console.asm):00051                         bsr             CON_GetHexNibbleA               ; send msn
EF0A BD800C           (      console.asm):00052                         jsr             BasicScreenOut  
                      (      console.asm):00053                 
EF0D A6E4             (      console.asm):00054                         lda             ,s                                          ; retrive digit
EF0F 8D20             (      console.asm):00055                         bsr             CON_GetHexNibbleA               ; send lsn
EF11 BD800C           (      console.asm):00056                         jsr             BasicScreenOut  
EF14 3582             (      console.asm):00057                         puls    a,pc
                      (      console.asm):00058         
                      (      console.asm):00059                         ifne    CONDEB
EF16                  (      console.asm):00060         CON_WriteHexByteS
EF16 8DEA             (      console.asm):00061                         bsr             CON_WriteHexByte        
                      (      console.asm):00062                         
EF18                  (      console.asm):00063         CON_WriteSpace
EF18 3402             (      console.asm):00064                         pshs    a
EF1A 8620             (      console.asm):00065                         lda             #$20                                ; send space
EF1C BD800C           (      console.asm):00066                         jsr             BasicScreenOut              ; send it
EF1F 3582             (      console.asm):00067                         puls    a,pc
                      (      console.asm):00068                         endc
                      (      console.asm):00069                         
EF21                  (      console.asm):00070         CON_HexDigits
EF21 3031323334353637 (      console.asm):00071                         fcc             /0123456789ABCDEF/
     3839414243444546
                      (      console.asm):00072                 
EF31                  (      console.asm):00073         CON_GetHexNibbleA
EF31 3410             (      console.asm):00074                         pshs    x
EF33 840F             (      console.asm):00075                         anda    #$0F                                ; mask out bytes
                      (      console.asm):00076                 
EF35 308DFFE8         (      console.asm):00077                         leax    >CON_HexDigits,pcr              ; Point to digits
EF39 3086             (      console.asm):00078                         leax    a,x                                         ; point to needed digit
EF3B A684             (      console.asm):00079                         lda             ,x                                          ; **GET** hex digit !
EF3D 3590             (      console.asm):00080                         puls    x,pc
                      (      console.asm):00081         
                      (      console.asm):00082                         ifne    CONDEB
                      (      console.asm):00083         
EF3F                  (      console.asm):00084         CON_HexByteAt0
EF3F 3412             (      console.asm):00085                         pshs    a,x                                                     ; save regs
EF41 9E88             (      console.asm):00086                         ldx     <TextVDUCursAddr            ; get cursor pos
EF43 3410             (      console.asm):00087                         pshs    x                                                       ; save it
EF45 8E0400           (      console.asm):00088                         ldx             #$400                                           ; pos 0
EF48 9F88             (      console.asm):00089                         stx     <TextVDUCursAddr            ; set cursor pos
                      (      console.asm):00090                         
EF4A 8DB6             (      console.asm):00091                         bsr             CON_WriteHexByte                        ; write it
                      (      console.asm):00092                         
EF4C 3510             (      console.asm):00093                         puls    x                                                       ; restore old cursor pos
EF4E 9F88             (      console.asm):00094                         stx     <TextVDUCursAddr            ; set cursor pos
                      (      console.asm):00095                         
EF50 3592             (      console.asm):00096                         puls    a,x,pc                                          ; restore and return
                      (      console.asm):00097         
EF52                  (      console.asm):00098         ASCII_AToHexA
EF52 3414             (      console.asm):00099                 pshs    x,b
EF54 5F               (      console.asm):00100                 clrb
EF55 308CC9           (      console.asm):00101                 leax    CON_HexDigits,pcr           ; Point to hex digits
EF58                  (      console.asm):00102         ASCII_AToHexALoop
EF58 A185             (      console.asm):00103                 cmpa    b,x                         ; same digit?
EF5A 2709             (      console.asm):00104                 beq     ValidHex
EF5C 5C               (      console.asm):00105                 incb                                ; next digit
EF5D C110             (      console.asm):00106                 cmpb    #16                         ; tried all?
EF5F 25F7             (      console.asm):00107                 blo     ASCII_AToHexALoop           ; no : loop again
EF61 1A01             (      console.asm):00108                 orcc    #FlagCarry                  ; flag error
EF63 3594             (      console.asm):00109                 puls    b,x,pc                      ; return it
                      (      console.asm):00110                 
EF65                  (      console.asm):00111         ValidHex
EF65 1F98             (      console.asm):00112                 tfr     b,a                         ; get position into a
EF67 3594             (      console.asm):00113                 puls    b,x,pc
                      (      console.asm):00114                         
EF69                  (      console.asm):00115         ASCII_XToHexByte
EF69 A684             (      console.asm):00116                 lda     ,x                          ; Get byte
EF6B 8DE5             (      console.asm):00117                 bsr     ASCII_AToHexA               ; convert it
EF6D 48               (      console.asm):00118                 asla                                ; convert to MSN
EF6E 48               (      console.asm):00119                 asla
EF6F 48               (      console.asm):00120                 asla
EF70 48               (      console.asm):00121                 asla                                
EF71 3402             (      console.asm):00122                 pshs    a                           ; save it
EF73 A601             (      console.asm):00123                 lda     1,x                         ; Get byte
EF75 8DDB             (      console.asm):00124                 bsr     ASCII_AToHexA               ; convert it
EF77 AAE0             (      console.asm):00125                 ora     ,s+                         ; combine with stacked MSN
EF79 39               (      console.asm):00126                 rts
                      (      console.asm):00127                 
                      (      console.asm):00128                         endc
                      (      console.asm):00129                 
                      (      console.asm):00130                         ifne    CONDEB
EF7A                  (      console.asm):00131         CON_DotEOL
EF7A 3402             (      console.asm):00132                         pshs    a                                                       ; save a
EF7C 862E             (      console.asm):00133                         lda             #'.'                                            ; print dot
EF7E BD800C           (      console.asm):00134                         jsr             BasicScreenOut              ; send it
EF81 8D0D             (      console.asm):00135                         bsr             CON_EOL                                         ; and EOL
EF83 3582             (      console.asm):00136                         puls    a,pc
                      (      console.asm):00137         
EF85                  (      console.asm):00138         CON_DashEOL
EF85 3402             (      console.asm):00139                         pshs    a                                                       ; save a
EF87 862D             (      console.asm):00140                         lda             #'-'                                            ; print dot
EF89 BD800C           (      console.asm):00141                         jsr             BasicScreenOut              ; send it
EF8C 8D02             (      console.asm):00142                         bsr             CON_EOL                                         ; and EOL
EF8E 3582             (      console.asm):00143                         puls    a,pc
                      (      console.asm):00144         
                      (      console.asm):00145                         endc
                      (      console.asm):00146                         
                      (      console.asm):00147         ;
                      (      console.asm):00148         ; CON_EOL : Write end of line sequence
                      (      console.asm):00149         ;
                      (      console.asm):00150         
EF90                  (      console.asm):00151         CON_EOL
EF90 860D             (      console.asm):00152                         lda             #$0d                                ; EOL
EF92 7E800C           (      console.asm):00153                         jmp             BasicScreenOut              ; send it
                      (      console.asm):00154                         
                      (      console.asm):00155         
                      (      console.asm):00156                         ifne    CONDEB
                      (      console.asm):00157         
EF95                  (      console.asm):00158         CON_WriteHexByteEOL
EF95 3402             (      console.asm):00159                         pshs    a
EF97 17FF68           (      console.asm):00160                         lbsr            CON_WriteHexByte
EF9A 8DF4             (      console.asm):00161                         bsr             CON_EOL
EF9C 3582             (      console.asm):00162                         puls    a,pc
                      (      console.asm):00163                         endc
                      (      console.asm):00164                         
                      (      console.asm):00165         ;
                      (      console.asm):00166         ; Write a zero terminated string to the screen, does not screw with 
                      (      console.asm):00167         ; as many of system vars as rom routine at $90E5
                      (      console.asm):00168         ; 
                      (      console.asm):00169         ; Entry : X address of ASCIIZ string to print.
                      (      console.asm):00170         ;
                      (      console.asm):00171                 
EF9E                  (      console.asm):00172         CON_WriteString
EF9E 3412             (      console.asm):00173                 pshs    x,a
EFA0                  (      console.asm):00174         CON_WriteStringLoop        
EFA0 A680             (      console.asm):00175                 lda     ,x+                         ; Get character to print
EFA2 4D               (      console.asm):00176                 tsta                                ; Zero : end of string
EFA3 2705             (      console.asm):00177                 beq     CON_WriteStringExit         ; exit
EFA5 BD800C           (      console.asm):00178                 jsr     BasicScreenOut              ; output it
EFA8 20F6             (      console.asm):00179                 bra     CON_WriteStringLoop         ; do next
EFAA                  (      console.asm):00180         CON_WriteStringExit        
EFAA 3592             (      console.asm):00181                 puls    x,a,pc
                      (      console.asm):00182                     
                      (      console.asm):00183                         ifndef  MINIMUM
                      (      console.asm):00184                         ifne    CONDEB
EFAC                  (      console.asm):00185         CON_WaitKey
EFAC 3402             (      console.asm):00186                         pshs    a
EFAE                  (      console.asm):00187         CON_WaitKeyLoop
EFAE BD8006           (      console.asm):00188                         jsr             BasicKbdIn              
EFB1 27FB             (      console.asm):00189                         beq             CON_WaitKeyLoop
EFB3 3582             (      console.asm):00190                         puls    a,pc
                      (      console.asm):00191                         
                      (      console.asm):00192                         endc
                      (      console.asm):00193         ;
                      (      console.asm):00194         ; Write a version number in a as msn.lsn followed by space.
                      (      console.asm):00195         ;
                      (      console.asm):00196         
EFB5                  (      console.asm):00197         CON_NdotN
EFB5 3402             (      console.asm):00198                         pshs    a
                      (      console.asm):00199                 
EFB7 44               (      console.asm):00200                         lsra                                                ; Move msn to lsn
EFB8 44               (      console.asm):00201                         lsra    
EFB9 44               (      console.asm):00202                         lsra    
EFBA 44               (      console.asm):00203                         lsra    
                      (      console.asm):00204         
EFBB BDEF31           (      console.asm):00205                         jsr             CON_GetHexNibbleA           ; send msn
EFBE BD800C           (      console.asm):00206                         jsr             BasicScreenOut  
                      (      console.asm):00207         
EFC1 862E             (      console.asm):00208                         lda             #'.'                                    ; send dot
EFC3 BD800C           (      console.asm):00209                         jsr             BasicScreenOut  
                      (      console.asm):00210         
EFC6 A6E4             (      console.asm):00211                         lda             ,s                                          ; retrive digit
EFC8 BDEF31           (      console.asm):00212                         jsr             CON_GetHexNibbleA               ; send lsn
EFCB BD800C           (      console.asm):00213                         jsr             BasicScreenOut  
                      (      console.asm):00214                 
EFCE 8620             (      console.asm):00215                         lda             #$20                                ; send space
EFD0 BD800C           (      console.asm):00216                         jsr             BasicScreenOut              ; send it
                      (      console.asm):00217                 
EFD3 3582             (      console.asm):00218                         puls    a,pc
                      (      console.asm):00219                         
                      (      console.asm):00220         ;
                      (      console.asm):00221         ; CON_PromptMore : display a prompt and wait for a key
                      (      console.asm):00222         ;                                  Key pressed returned in a
                      (      console.asm):00223         ; 
                      (      console.asm):00224         
EFD5                  (      console.asm):00225         CON_PromptMore
EFD5 308DF407         (      console.asm):00226                         leax    MoreMess,PCR                            ; Prompt for more
EFD9 BDEF9E           (      console.asm):00227                         JSR     >CON_WriteString
EFDC                  (      console.asm):00228         CON_PromptMoreWait              
EFDC BD8006           (      console.asm):00229                         jsr             >BasicKbdIn                                     ; Poll keyboard
EFDF 27FB             (      console.asm):00230                         beq             CON_PromptMoreWait                      ; No key pressed loop again
                      (      console.asm):00231         
EFE1 39               (      console.asm):00232                         rts
                      (      console.asm):00233                         
                      (      console.asm):00234                         ifne    CONDEB
                      (      console.asm):00235         ;
                      (      console.asm):00236         ; CON_DumpRegs : Dump the registers.
                      (      console.asm):00237         ;
                      (      console.asm):00238         ; After the push (and set of wait flag) the stack will be....
                      (      console.asm):00239         ;
                      (      console.asm):00240         ; PCL   from BSR/JSR
                      (      console.asm):00241         ; PCH   S+11
                      (      console.asm):00242         ; UL    From pshs
                      (      console.asm):00243         ; UH    S+9
                      (      console.asm):00244         ; YL
                      (      console.asm):00245         ; YH    S+7
                      (      console.asm):00246         ; XL
                      (      console.asm):00247         ; XH    S+5
                      (      console.asm):00248         ; DP    S+4
                      (      console.asm):00249         ; B             S+3
                      (      console.asm):00250         ; A             S+2
                      (      console.asm):00251         ; CC    S+1
                      (      console.asm):00252         ; WFLAG S+0
                      (      console.asm):00253         
EFE2                  (      console.asm):00254         CON_DumpRegs
EFE2 347F             (      console.asm):00255                         pshs    u,y,x,dp,b,a,cc                         ; pushed in this order
EFE4 4F               (      console.asm):00256                         clra                                                            ; flag don't wait for keypress
                      (      console.asm):00257         
EFE5                  (      console.asm):00258         CON_DumpRegsCommon
EFE5 3402             (      console.asm):00259                         pshs    a                                                       ; save wait flag
                      (      console.asm):00260         
EFE7 308DF3FB         (      console.asm):00261                         leax    RegNames,pcr                            ; print reg names
EFEB BDEF9E           (      console.asm):00262                         JSR     >CON_WriteString
                      (      console.asm):00263                         
EFEE EC6B             (      console.asm):00264                         ldd             11,s                                            ; Get PC
EFF0 17FF0B           (      console.asm):00265                         lbsr    CON_WriteHexWordS                       ; display it
                      (      console.asm):00266         
EFF3 A662             (      console.asm):00267                         lda             2,s                                                     ; get A
EFF5 17FF1E           (      console.asm):00268                         lbsr    CON_WriteHexByteS                       ; display it
                      (      console.asm):00269                         
EFF8 A663             (      console.asm):00270                         lda             3,s                                                     ; get B
EFFA 17FF19           (      console.asm):00271                         lbsr    CON_WriteHexByteS                       ; display it
                      (      console.asm):00272                         
EFFD EC65             (      console.asm):00273                         ldd             5,s                                             ; Get X
EFFF 17FEFC           (      console.asm):00274                         lbsr    CON_WriteHexWordS                       ; display it
                      (      console.asm):00275                         
F002 EC67             (      console.asm):00276                         ldd             7,s                                                     ; Get Y
F004 17FEF7           (      console.asm):00277                         lbsr    CON_WriteHexWordS                       ; display it
                      (      console.asm):00278                                 
F007 EC69             (      console.asm):00279                         ldd             9,s                                                     ; Get U
F009 17FEF2           (      console.asm):00280                         lbsr    CON_WriteHexWordS                       ; display it
                      (      console.asm):00281                 
F00C A664             (      console.asm):00282                         lda             4,s                                                     ; get DP
F00E 17FF05           (      console.asm):00283                         lbsr    CON_WriteHexByteS                       ; display it
                      (      console.asm):00284                 
F011 A661             (      console.asm):00285                         lda             1,s                                                     ; get CC
F013 17FF00           (      console.asm):00286                         lbsr    CON_WriteHexByteS                       ; display it
                      (      console.asm):00287                 
F016 3502             (      console.asm):00288                         puls    a                                                       ; get wait flag
F018 2702             (      console.asm):00289                         beq             CON_DumpRegsExit                        ; Don't wait exit
                      (      console.asm):00290         
F01A                  (      console.asm):00291         CON_DumpRegsLoop        
F01A 8D90             (      console.asm):00292                         bsr             CON_WaitKey                                     ; wait for a keypress
F01C                  (      console.asm):00293         CON_DumpRegsExit        
F01C 357F             (      console.asm):00294                         puls    u,y,x,dp,b,a,cc
F01E 39               (      console.asm):00295                         rts
                      (      console.asm):00296         
F01F                  (      console.asm):00297         CON_DumpRegsWait                
F01F 347F             (      console.asm):00298                         pshs    u,y,x,dp,b,a,cc                         ; pushed in this order
F021 86FF             (      console.asm):00299                         lda             #$FF                                            ; flag wait for keypress
F023 20C0             (      console.asm):00300                         bra             CON_DumpRegsCommon
                      (      console.asm):00301         
                      (      console.asm):00302                         endc
                      (      console.asm):00303         ;
                      (      console.asm):00304         ; Get maximum of B bytes of input into buffer at X
                      (      console.asm):00305         ;
                      (      console.asm):00306         
F025                  (      console.asm):00307         CON_InputBufXB
F025 5A               (      console.asm):00308                 decb
F026 3404             (      console.asm):00309                 pshs    b
F028 5F               (      console.asm):00310                 clrb
                      (      console.asm):00311                 
F029                  (      console.asm):00312         CON_InputBufXBLoop
F029 3414             (      console.asm):00313                 pshs    x,b
F02B BD8009           (      console.asm):00314                 jsr     >BasicCursorB               ; Blink cursor
F02E BD8006           (      console.asm):00315                 jsr             >BasicKbdIn                                 ; Read keyboard
F031 3514             (      console.asm):00316                 puls    x,b
                      (      console.asm):00317                 
F033 8100             (      console.asm):00318                 cmpa    #0
F035 27F2             (      console.asm):00319                 beq     CON_InputBufXBLoop          ; keep looping until keypressed
                      (      console.asm):00320                 
F037 810D             (      console.asm):00321                 cmpa    #$0d                        ; Enter pressed?
F039 272A             (      console.asm):00322                 beq     CON_InputBufXBEnd
                      (      console.asm):00323                 
F03B 8108             (      console.asm):00324                 cmpa    #$08                        ; Backspace?
F03D 270C             (      console.asm):00325                 beq     CON_InputBufXBBack          ; yep : act on it
                      (      console.asm):00326                 
F03F E1E4             (      console.asm):00327                 cmpb    ,s                          ; Past end of buffer?
F041 24E6             (      console.asm):00328                 bhs     CON_InputBufXBLoop          ; yep : do nothing
                      (      console.asm):00329                 
F043 A785             (      console.asm):00330                 sta     b,x                         ; save in buffer
F045 5C               (      console.asm):00331                 incb                                ; increment count
                      (      console.asm):00332                 
F046                  (      console.asm):00333         CON_InputBufXBOut
F046 BD800C           (      console.asm):00334                 jsr     >BasicScreenOut             ; output character
F049 20DE             (      console.asm):00335                 bra     CON_InputBufXBLoop          ; go again
                      (      console.asm):00336                 
                      (      console.asm):00337                 
F04B                  (      console.asm):00338         CON_InputBufXBBack
F04B C100             (      console.asm):00339                 cmpb    #0                          ; at beginning of buffer?
F04D 27DA             (      console.asm):00340                 beq     CON_InputBufXBLoop          ; Yep do nothing
                      (      console.asm):00341                 
F04F 5A               (      console.asm):00342                 decb                                ; decrement pointer
F050 3410             (      console.asm):00343                 pshs    x                           ; save x
F052 9E88             (      console.asm):00344                 ldx     <TextVDUCursAddr            ; get cursor pos
F054 301F             (      console.asm):00345                 leax    -1,x                        ; previous char
F056 9F88             (      console.asm):00346                         stx     <TextVDUCursAddr            ; update it
F058 8620             (      console.asm):00347                 lda             #' '
F05A BD800C           (      console.asm):00348                 jsr     >BasicScreenOut             ; output character
F05D 9F88             (      console.asm):00349                 stx     <TextVDUCursAddr            ; reset pointer
F05F 3510             (      console.asm):00350                 puls    x
F061 20C6             (      console.asm):00351                 bra             CON_InputBufXBLoop
F063 20E1             (      console.asm):00352                 bra     CON_InputBufXBOut           
                      (      console.asm):00353                 
F065                  (      console.asm):00354         CON_InputBufXBEnd
F065 6F85             (      console.asm):00355                 clr     b,x                         ; Terminate string
F067 3584             (      console.asm):00356                 puls    b,pc
                      (      console.asm):00357                 
                      (      console.asm):00358         ;
                      (      console.asm):00359         ; Clear text screen line specified in B
                      (      console.asm):00360         ;
F069                  (      console.asm):00361         CON_ClearLineB
F069 3416             (      console.asm):00362                 pshs    d,x
                      (      console.asm):00363                 
F06B 8620             (      console.asm):00364                 lda     #TextLineLen                ; line length
F06D 3D               (      console.asm):00365                 mul                                 ; calculate offset
F06E 8E0400           (      console.asm):00366                 ldx     #TextScreenBase             ; point to screen
F071 308B             (      console.asm):00367                 leax    d,x                         ; add offset
F073 9F88             (      console.asm):00368                 stx     <TextVDUCursAddr            ; Set cursor address to beginning of line
                      (      console.asm):00369                 
F075 8660             (      console.asm):00370                 lda     #$60                        ; VDG space :)
F077 5F               (      console.asm):00371                 clrb
F078                  (      console.asm):00372         CON_ClearLineBLoop
F078 A785             (      console.asm):00373                 sta     b,x                         ; blank it
F07A 5C               (      console.asm):00374                 incb                                ; next
F07B C120             (      console.asm):00375                 cmpb    #TextLineLen                ; done a line ?
F07D 25F9             (      console.asm):00376                 blo     CON_ClearLineBLoop          ; nope keep going
                      (      console.asm):00377                 
F07F 3596             (      console.asm):00378                 puls    d,x,pc
                      (      console.asm):00379                 
                      (      console.asm):00380         ;
                      (      console.asm):00381         ; Clear line B and print string at X
                      (      console.asm):00382         ;
F081                  (      console.asm):00383         CON_ClearBPrintX
F081 8DE6             (      console.asm):00384                 bsr     CON_ClearLineB              ; clear line
F083 17FF18           (      console.asm):00385                 lbsr    CON_WriteString             ; print it
F086 39               (      console.asm):00386                 rts
                      (      console.asm):00387         
                      (      console.asm):00388                
                      (      console.asm):00389         ;
                      (      console.asm):00390         ; Acorn style inline print where string to be printed follows jsr/bsr
                      (      console.asm):00391         ;
                      (      console.asm):00392                 ifne    DEBUG
                      (      console.asm):00393                 ifne    0
F087                  (      console.asm):00394         CON_InlinePrint
                      (      console.asm):00395                 pshs    x,d                         ; PC now at s+4
                      (      console.asm):00396                 ldx     4,s                         ; Get PC of return address
                      (      console.asm):00397                 
F087                  (      console.asm):00398         CON_InlinePrintLoop
                      (      console.asm):00399                 lda     ,x+                         ; get a byte from string
                      (      console.asm):00400                 beq     CON_InlinePrintEnd          ; zero end of sting : exit
                      (      console.asm):00401                 jsr     >BasicScreenOut
                      (      console.asm):00402                 bra     CON_InlinePrintLoop         ; loop again!
F087                  (      console.asm):00403         CON_InlinePrintEnd
                      (      console.asm):00404                 
                      (      console.asm):00405                 stx     4,s                         ; Update return address
                      (      console.asm):00406                 puls    d,x,pc
                      (      console.asm):00407                 endc
                      (      console.asm):00408                 endc
                      (      console.asm):00409                 
                      (      console.asm):00410                         endc
                      (      console.asm):00411                         
F087                  (      console.asm):00412         __console_end
                      (    DragonMMC.asm):00677                         use             util.asm
                      (         util.asm):00001         ;
                      (         util.asm):00002         ; Utility routines
                      (         util.asm):00003         ;
                      (         util.asm):00004         
                      (         util.asm):00005         ;
                      (         util.asm):00006         ; wrapper for UtilCopyBXtoU, that disables interrupts whilst doing it's work
                      (         util.asm):00007         ; 
F087                  (         util.asm):00008         __utils
                      (         util.asm):00009                         ifne    0
F087                  (         util.asm):00010         DO_SafeCopy
                      (         util.asm):00011                         pshs    cc                                              ; save condition codes
                      (         util.asm):00012                         orcc    #FlagIRQ+FlagFIRQ               ; disable ints
                      (         util.asm):00013                         jsr             UtilCopyBXtoU                   ; do the copy
                      (         util.asm):00014                         puls    cc,pc                                   ; restore and return
                      (         util.asm):00015         
                      (         util.asm):00016         ;
                      (         util.asm):00017         ; Wrapper for UtilCopyBXtoU which enables extra ram before copying, and disables afterwards
                      (         util.asm):00018         ; this assumes that the roms have already been mirrored to ram, and is to be used
                      (         util.asm):00019         ; for copying data to ram e.g. whilst snapshotting.
                      (         util.asm):00020         ;
                      (         util.asm):00021                         
F087                  (         util.asm):00022         DO_RamCopy
                      (         util.asm):00023                         pshs    a,cc                                    ; save condition codes
                      (         util.asm):00024                         orcc    #FlagIRQ+FlagFIRQ               ; disable ints
                      (         util.asm):00025         
                      (         util.asm):00026                         lda     D_RAM_CTRL                              ; Get RAM control reg
                      (         util.asm):00027                 ora             #D_RAM_ENABLE                   ; put us in RAM mode
                      (         util.asm):00028                         sta             D_RAM_CTRL                              ; set flags
                      (         util.asm):00029                 
                      (         util.asm):00030                         jsr             UtilCopyBXtoU                   ; do the copy
                      (         util.asm):00031                         
                      (         util.asm):00032                         lda     D_RAM_CTRL                              ; Get RAM control reg
                      (         util.asm):00033                 anda    #~D_RAM_ENABLE                  ; put us in ROM mode
                      (         util.asm):00034                         sta             D_RAM_CTRL                              ; set flags
                      (         util.asm):00035         
                      (         util.asm):00036                         puls    a,cc,pc                                 ; restore and return
                      (         util.asm):00037         
                      (         util.asm):00038                         endc
                      (         util.asm):00039         
                      (         util.asm):00040         ;
                      (         util.asm):00041         ; MGetCommaThen8Bit, scan for comma, error if not found, then fetch 8 bit that follows (or error). 
                      (         util.asm):00042         ;
                      (         util.asm):00043         
F087                  (         util.asm):00044         MGetCommaThen8Bit
F087 9DA5             (         util.asm):00045                         JSR     <BasChrGetCurr                  ; Get current basic char
F089 270A             (         util.asm):00046                 BEQ     MGetCommaThen8BitExit   ; Any left no: return 
F08B BD89AA           (         util.asm):00047                 JSR     >VarCKComma                             ; check for comma
                      (         util.asm):00048         ;        bra     MGet8Bit                               ; go get it
F08E                  (         util.asm):00049         MGet8Bit
F08E 3460             (         util.asm):00050                         PSHS    Y,U
F090 BD8E51           (         util.asm):00051                 JSR     >VarGet8Bit                             ; Get 8 bit value into B
                      (         util.asm):00052         ;MGet8BitorErrorExit    
F093 3560             (         util.asm):00053                         PULS    Y,U                                             ; Restore and return
                      (         util.asm):00054         
F095                  (         util.asm):00055         MGetCommaThen8BitExit
F095 39               (         util.asm):00056                         rts
                      (         util.asm):00057         ;
                      (         util.asm):00058         ; Reset the machine to power on memory map, used by tape and direct loading routines.
                      (         util.asm):00059         ; Note : corrupts Y and moves stack.
                      (         util.asm):00060         ;
                      (         util.asm):00061         
F096                  (         util.asm):00062         DO_ResetPoweron
F096 3520             (         util.asm):00063                         puls    y                                               ; get our return address
                      (         util.asm):00064         
                      (         util.asm):00065         ; Perform the equivelent of a clear 200,MaxRam so the machine has it's ramtop
                      (         util.asm):00066         ; reset as if it had just been turned on, as a lot of commercial tape software 
                      (         util.asm):00067         ; assumes this condition, and will bomb on loading due to stack being over-written!
                      (         util.asm):00068         
F098 9E74             (         util.asm):00069                         ldx             <AddrRamTop                             ; Get top of RAM
F09A 9F27             (         util.asm):00070                         stx             <AddrFWareRamTop                ; Firmware ramtop, last basic used address
F09C 3089FF38         (         util.asm):00071                         leax    -200,x                                  ; 200 bytes string space
F0A0 9F21             (         util.asm):00072                         stx             <AddrStack                              ; Stack address here
F0A2 BD8424           (         util.asm):00073                         jsr             ClearEntry                              ; perform a clear, moves stack!
F0A5 BD8417           (         util.asm):00074                         jsr             >BasNew                                 ; Do a 'new'
F0A8 3420             (         util.asm):00075                         pshs    y                                               ; restore our return address!
F0AA 39               (         util.asm):00076                         rts
                      (         util.asm):00077         
F0AB                  (         util.asm):00078         __utils_end
                      (    DragonMMC.asm):00678                         use     interrupt.asm
                      (    interrupt.asm):00001         ;
                      (    interrupt.asm):00002         ; New NMI handler, for 'Snap' button on DragonMMC.
                      (    interrupt.asm):00003         ;
                      (    interrupt.asm):00004         
                      (    interrupt.asm):00005         ;
                      (    interrupt.asm):00006         ; Initialize the interrupt vector area at the top of memory
                      (    interrupt.asm):00007         ;
                      (    interrupt.asm):00008         
F0AB                  (    interrupt.asm):00009         __interrupt
                      (    interrupt.asm):00010         
     05C0             (    interrupt.asm):00011         MenuLoc         equ             TextScreenBase+(14*TextLineLen)                 ; Address of NMI menu
                      (    interrupt.asm):00012         
     0009             (    interrupt.asm):00013         FileNameLen     equ     9               ; Filename length including terminating 0
     0500             (    interrupt.asm):00014         TempS           equ     $500            ; Tempory S whilst loading image 
                      (    interrupt.asm):00015         
     0000             (    interrupt.asm):00016         LoadBlock1      equ     $0000           ; beginning of first image load block 
     0600             (    interrupt.asm):00017         LoadBlock1a     equ     $0600           ; Top of text screen
     4000             (    interrupt.asm):00018         LoadBlock2      equ     $4000           ; beginning of second image load block 
     8000             (    interrupt.asm):00019         LoadEnd         equ     $8000           ; End of load area (beginning of ROM)
                      (    interrupt.asm):00020         
F0AB                  (    interrupt.asm):00021         InterruptInit
F0AB 3401             (    interrupt.asm):00022                         pshs    cc                                              ; save ccr
F0AD 1A50             (    interrupt.asm):00023                         orcc    #FlagIRQ+FlagFIRQ               ; disable interrupts
                      (    interrupt.asm):00024                         
F0AF 308D002D         (    interrupt.asm):00025                 leax    NewNMI,pcr              ; get new vector
F0B3 BF010A           (    interrupt.asm):00026                 stx     SecVecNMI+1             ; set it up
F0B6 867E             (    interrupt.asm):00027                 lda     #$7E                    ; JMP opcode
F0B8 B70109           (    interrupt.asm):00028                 sta     SecVecNMI               ; fill in jump
                      (    interrupt.asm):00029                 
                      (    interrupt.asm):00030         ;               ldx     #MonStart               ; Set SWI->mon
                      (    interrupt.asm):00031         ;        stx            SecVecSWI+1                             ; Temp point SWI at it so we can test in MESS!
                      (    interrupt.asm):00032         ;               sta             SecVecSWI
                      (    interrupt.asm):00033         
F0BB BDE026           (    interrupt.asm):00034                         jsr             MMC_GetRAMCTRL                  ; Go get current value
F0BE 849D             (    interrupt.asm):00035                         anda    #~(D_NMI_ENABLE+D_RAM_VEC+D_RAM_VEC_WP) ; Disable NMI + Select rom vectors, remove write prot on RAM vectors
F0C0 3402             (    interrupt.asm):00036                         pshs    a                                               ; save current RAM_CTRL
F0C2 BDE02E           (    interrupt.asm):00037                         jsr             MMC_SetRAMCTRL                  ; and update
                      (    interrupt.asm):00038                         
                      (    interrupt.asm):00039         ;       lda     D_RAM_CTRL              ; Get ram control       
                      (    interrupt.asm):00040         ;               anda    #~(D_NMI_ENABLE+D_RAM_VEC+D_RAM_VEC_WP) ; Disable NMI + Select rom vectors, remove write prot on RAM vectors
                      (    interrupt.asm):00041         ;               sta             D_RAM_CTRL
                      (    interrupt.asm):00042         ;               pshs    a                                               ; save current RAM_CTRL
                      (    interrupt.asm):00043         
                      (    interrupt.asm):00044         ;
                      (    interrupt.asm):00045         ; Copy hardware interrupt vectors from ROM to RAM, as writes always go to RAM, no need to swap.
                      (    interrupt.asm):00046         ;
                      (    interrupt.asm):00047         ; 2024-11-07, Modified to do a byte at a time, yes a word at a time is fatser, but for
                      (    interrupt.asm):00048         ; 16 bytes worth this is not going to be significant.
                      (    interrupt.asm):00049         ; The reason for this change is that the Pico code uses a read of the reset vector bytes one 
                      (    interrupt.asm):00050         ; after the other to detect a reset (as this is how it is fetched at reset time). 
                      (    interrupt.asm):00051         ; Unfortunately moving the vectors a word at a time will also trigger this causing the Pico
                      (    interrupt.asm):00052         ; to think it is getting a reset, and clearing it's copy of the SAM registers.
                      (    interrupt.asm):00053         ; By doing this a byte at a time, it should not trigger this behavior as there will be 
                      (    interrupt.asm):00054         ; instruction fetches between the two vector bytes.
                      (    interrupt.asm):00055          
F0C5 860E             (    interrupt.asm):00056                         lda             #HWVecCount*2                   ; No of vectors * bytes/vector
F0C7 8EFFF2           (    interrupt.asm):00057                         ldx             #HWVecBase                              ; point to base
F0CA                  (    interrupt.asm):00058         IntCopyLoop
F0CA E684             (    interrupt.asm):00059                         ldb             ,x                                              ; get vector
F0CC E780             (    interrupt.asm):00060                         stb             ,x+                                             ; put it in RAM 
F0CE 4A               (    interrupt.asm):00061                         deca                                                    ; decrement counter
F0CF 26F9             (    interrupt.asm):00062                         bne             IntCopyLoop
                      (    interrupt.asm):00063                 
F0D1 8EF0E0           (    interrupt.asm):00064                 ldx     #NewNMI                 ; set newnmi
F0D4 BFFFFC           (    interrupt.asm):00065                 stx     HWVecNMI                
                      (    interrupt.asm):00066             
                      (    interrupt.asm):00067         ;        ldx     #MonStart               ; Set SWI->mon
                      (    interrupt.asm):00068         ;        stx     HWVecSWI
                      (    interrupt.asm):00069             
F0D7 3502             (    interrupt.asm):00070                         puls    a                                               ; recover saved  RAM_CTRL
F0D9 8A62             (    interrupt.asm):00071                 ora             #D_NMI_ENABLE+D_RAM_VEC+D_RAM_VEC_WP    ; Enable NMI routing + RAM vectors, write protect RAM vectors.
F0DB BDE02E           (    interrupt.asm):00072                         jsr             MMC_SetRAMCTRL                  ; and update
                      (    interrupt.asm):00073                                
F0DE 3581             (    interrupt.asm):00074                         puls    cc,pc                                   ; restore CC (and int flags if enabled) + return
                      (    interrupt.asm):00075                 
                      (    interrupt.asm):00076         ;
                      (    interrupt.asm):00077         ; We are in the NMI handler, and therefore the registers of the 
                      (    interrupt.asm):00078         ; currently running program are saved on the stack, so we are free 
                      (    interrupt.asm):00079         ; to use them as long as S is the same at exit. 
                      (    interrupt.asm):00080         ;
F0E0                  (    interrupt.asm):00081         NewNMI
                      (    interrupt.asm):00082         ; Disable NMI so we don't get called recursively
F0E0 BDE026           (    interrupt.asm):00083                         jsr             MMC_GetRAMCTRL                  ; Go get current value
F0E3 84BF             (    interrupt.asm):00084                 anda    #~D_NMI_ENABLE          ; Mask out NMI enable
F0E5 BDE02E           (    interrupt.asm):00085                         jsr             MMC_SetRAMCTRL                  ; and update
                      (    interrupt.asm):00086         
F0E8 338D019A         (    interrupt.asm):00087                 leau    NMI_SavePIA,pcr         ; save PIA register contents on stack
F0EC 1E53             (    interrupt.asm):00088                 exg     pc,u                    ; call subroutine without using stack!
                      (    interrupt.asm):00089         
                      (    interrupt.asm):00090         ;               ldd     D_SAMBITS_MSB           ; get sambits into D
                      (    interrupt.asm):00091         ; New code for Pico, read SAM bits from pico
F0EE 86EF             (    interrupt.asm):00092                         lda             #CMD_GET_SAMBITS
F0F0 BDE00E           (    interrupt.asm):00093                         jsr             MMC_SendCmd                             ; Send the command, and wait for it.
                      (    interrupt.asm):00094                         
F0F3 8620             (    interrupt.asm):00095                         lda             #CMD_INIT_READ                  ; read the data
F0F5 BDE017           (    interrupt.asm):00096                         jsr             MMC_SendCmdRaw                  
                      (    interrupt.asm):00097                         
F0F8 B6FF52           (    interrupt.asm):00098                         lda             D_READ_DATA_REG                 ; get MSB
F0FB F6FF52           (    interrupt.asm):00099                         ldb             D_READ_DATA_REG                 ; get LSB
F0FE 3406             (    interrupt.asm):00100                         pshs    D                                               ; save on stack
                      (    interrupt.asm):00101         
F100 DC88             (    interrupt.asm):00102                         ldd             <TextVDUCursAddr                ; Save cursor address
F102 3406             (    interrupt.asm):00103                         pshs    d
                      (    interrupt.asm):00104                         
F104 4F               (    interrupt.asm):00105                 clra                            ; DP=0, as ROM routines assume this.
F105 1F8B             (    interrupt.asm):00106                 tfr     a,dp
                      (    interrupt.asm):00107                 
F107 BDA93A           (    interrupt.asm):00108                 jsr     >TextResetVDU           ; Go to text mode
                      (    interrupt.asm):00109                 
F10A 8E05C0           (    interrupt.asm):00110                         ldx             #MenuLoc                                ; Beginning of line #14
F10D 9F88             (    interrupt.asm):00111                         stx             <TextVDUCursAddr                ; set cursor address
                      (    interrupt.asm):00112                         
F10F                  (    interrupt.asm):00113         SaveTextLoop
F10F EC81             (    interrupt.asm):00114                         ldd             ,x++                                    ; Get bytes from screen
F111 3406             (    interrupt.asm):00115                         pshs    d                                               ; save on stack
F113 8C0600           (    interrupt.asm):00116                         cmpx    #$600                                   ; end of screen?
F116 25F7             (    interrupt.asm):00117                         blo             SaveTextLoop                    ; keep going
                      (    interrupt.asm):00118                         
F118 308D01D8         (    interrupt.asm):00119                         leax    NMIMenu1,pcr                    ; point to menu text
F11C 318D020A         (    interrupt.asm):00120                         leay    NMIMenuTable1,pcr               ; Keycodes & jump table
F120 8D27             (    interrupt.asm):00121                         bsr             NMIMenu
                      (    interrupt.asm):00122              
F122                  (    interrupt.asm):00123         NMI_Exit
                      (    interrupt.asm):00124         
F122 8E0600           (    interrupt.asm):00125                         ldx             #$600                                   ; end of screen
F125                  (    interrupt.asm):00126         RestoreTextLoop
F125 3506             (    interrupt.asm):00127                         puls    d                                               ; get bytes
F127 ED83             (    interrupt.asm):00128                         std             ,--x                                    ; save on screen
F129 8C05C0           (    interrupt.asm):00129                         cmpx    #MenuLoc                                ; done all?
F12C 22F7             (    interrupt.asm):00130                         bhi             RestoreTextLoop                 ; nope keep going
                      (    interrupt.asm):00131         
F12E 3506             (    interrupt.asm):00132                         puls    d                                               ; restore cursor address
F130 DD88             (    interrupt.asm):00133                         std             <TextVDUCursAddr
                      (    interrupt.asm):00134                         
F132 3506             (    interrupt.asm):00135                         puls    D                                               ; restore sambits
F134 17013A           (    interrupt.asm):00136                         lbsr    SetSambits                              ; set them
                      (    interrupt.asm):00137                         
F137 338D0180         (    interrupt.asm):00138                 leau    NMI_RestorePIA,pcr      ; save PIA register contents on stack
F13B 1E53             (    interrupt.asm):00139                 exg     pc,u                    ; call subroutine without using stack!
                      (    interrupt.asm):00140         
F13D 8D01             (    interrupt.asm):00141                 bsr     NMI_Enable
F13F 3B               (    interrupt.asm):00142                 rti                             ; return.
                      (    interrupt.asm):00143         
F140                  (    interrupt.asm):00144         NMI_Enable
F140 BDE026           (    interrupt.asm):00145                         jsr             MMC_GetRAMCTRL                  ; Go get current value
F143 8A40             (    interrupt.asm):00146                 ora     #D_NMI_ENABLE           ; Enable NMI routing
F145 BDE02E           (    interrupt.asm):00147                         jsr             MMC_SetRAMCTRL                  ; and update
F148 39               (    interrupt.asm):00148                 rts
                      (    interrupt.asm):00149         
F149                  (    interrupt.asm):00150         NMIMenu
F149 C60F             (    interrupt.asm):00151                         ldb     #15                     ; clear bottom two lines
F14B BDF069           (    interrupt.asm):00152                 jsr     >CON_ClearLineB         ; line 15
F14E 5A               (    interrupt.asm):00153                 decb    
F14F BDF069           (    interrupt.asm):00154                 jsr     >CON_ClearLineB         ; line 14
                      (    interrupt.asm):00155                 
F152 3430             (    interrupt.asm):00156                 pshs    x,y                                             ; save pointer to text & table
F154 BDEF9E           (    interrupt.asm):00157                 jsr     CON_WriteString
F157                  (    interrupt.asm):00158         WaitKey
F157 BD8006           (    interrupt.asm):00159                         jsr             BasicKbdIn                              ; Read keyboard
F15A 8100             (    interrupt.asm):00160                         cmpa    #0                                              ; Key pressed?
F15C 27F9             (    interrupt.asm):00161                         beq             WaitKey                                 ; nope loop again
                      (    interrupt.asm):00162                         
F15E                  (    interrupt.asm):00163         check_next
F15E A1A4             (    interrupt.asm):00164                         cmpa    ,y                                              ; Check key from table?
F160 2607             (    interrupt.asm):00165                         bne             try_next                                ; no try next
                      (    interrupt.asm):00166                         
F162 3422             (    interrupt.asm):00167                         pshs    a,y                                             ; save on stack
F164 ADB801           (    interrupt.asm):00168                         jsr             [1,y]                                   ; Jump to handler
                      (    interrupt.asm):00169         
F167 3522             (    interrupt.asm):00170                         puls    a,y                                             ; restore
                      (    interrupt.asm):00171                         
F169                  (    interrupt.asm):00172         try_next
F169 3123             (    interrupt.asm):00173                         leay    3,y                                             ; next entry in table
F16B 6DA4             (    interrupt.asm):00174                         tst             ,y                                              ; last entry?
F16D 26EF             (    interrupt.asm):00175                         bne             check_next                              ; nope loop again
                      (    interrupt.asm):00176                         
F16F 10AE21           (    interrupt.asm):00177                         ldy             1,y                                             ; recover pointer to table beginning
F172 20E3             (    interrupt.asm):00178                         bra             WaitKey                                 ; invalid key keep going!
                      (    interrupt.asm):00179         
F174                  (    interrupt.asm):00180         NMIMenuExit
F174 3265             (    interrupt.asm):00181                         leas    5,s                                             ; drop return address & saved a,y
F176 35B0             (    interrupt.asm):00182                         puls    x,y,pc                                  ; restore and return
                      (    interrupt.asm):00183         
                      (    interrupt.asm):00184              
                      (    interrupt.asm):00185                         
F178                  (    interrupt.asm):00186         NMICold
F178 0F71             (    interrupt.asm):00187                         clr             WarmStartFlag                   ; clear warm start flag
                      (    interrupt.asm):00188         
F17A BDE026           (    interrupt.asm):00189                         jsr             MMC_GetRAMCTRL                  ; Go get current value
F17D 8408             (    interrupt.asm):00190                 anda    #D_ROM_A14              ; Reset all bits *EXECPT* rom select           
F17F BDE02E           (    interrupt.asm):00191                         jsr             MMC_SetRAMCTRL                  ; and update
                      (    interrupt.asm):00192         
                      (    interrupt.asm):00193         ; Clear the RAM on cold boot.
                      (    interrupt.asm):00194                 
F182 4F               (    interrupt.asm):00195                 clra                            ; D=0, X=0
F183 5F               (    interrupt.asm):00196                 clrb
                      (    interrupt.asm):00197                 
F184 1F01             (    interrupt.asm):00198                 tfr     d,x
F186                  (    interrupt.asm):00199         NMIClearLoop
F186 ED81             (    interrupt.asm):00200                 std     ,x++                    ; save it
F188 8C8000           (    interrupt.asm):00201                 cmpx    #$8000                  ; end of ram
F18B 25F9             (    interrupt.asm):00202                 blo     NMIClearLoop
                      (    interrupt.asm):00203                 
F18D 2004             (    interrupt.asm):00204                 bra     NMIDoReset
F18F                  (    interrupt.asm):00205         NMIWarm
F18F 8655             (    interrupt.asm):00206                 lda     #$55                    ; Make sure it's a warm start
F191 9771             (    interrupt.asm):00207                 sta     WarmStartFlag                   
F193                  (    interrupt.asm):00208         NMIDoReset
F193 8DAB             (    interrupt.asm):00209                         bsr     NMI_Enable              ; We have to re-enable here for warm start
F195 6E9FFFFE         (    interrupt.asm):00210                 JMP             [HWVecReset]                    ; Jump to reset vector
                      (    interrupt.asm):00211                         
                      (    interrupt.asm):00212         ;
                      (    interrupt.asm):00213         ; Save a dump of memory to card, prompts for filename and dumps memory to that file.
                      (    interrupt.asm):00214         ; not yet error checked, and will overwrite exiting files.
                      (    interrupt.asm):00215         ;
                      (    interrupt.asm):00216                 
F199                  (    interrupt.asm):00217         NMISave
F199 8D2C             (    interrupt.asm):00218                 bsr     NMIGetSendFileName      ; Get filename, send to AVR
                      (    interrupt.asm):00219                 
F19B 8600             (    interrupt.asm):00220                         lda             #CAS_FILE                               ; file id of cas file
F19D 17EE81           (    interrupt.asm):00221                         lbsr    MMC_WaitPutLatchRead    ; send it to latch register
                      (    interrupt.asm):00222         
F1A0 861A             (    interrupt.asm):00223                         lda             #CMD_FILE_OPEN_SNAPW    ; Open snapshot file for write file
F1A2 17EE69           (    interrupt.asm):00224                         lbsr    MMC_SendCmd                     ; Open file
                      (    interrupt.asm):00225         
F1A5 1F40             (    interrupt.asm):00226                 tfr     s,d                     ; get copy of stack pointer
F1A7 BDECCA           (    interrupt.asm):00227                 jsr     >MMC_InitSendBytes      ; send S to file
F1AA BDEDAD           (    interrupt.asm):00228                 jsr     >MMC_WriteD             ; Write S to file
                      (    interrupt.asm):00229         
F1AD 8602             (    interrupt.asm):00230                 lda     #2                      ; 2 bytes
F1AF BDEDD2           (    interrupt.asm):00231                 jsr     >MMC_WriteAFromAVRBuf   ; Write to file.
                      (    interrupt.asm):00232         
F1B2 8E0000           (    interrupt.asm):00233                 ldx     #LoadBlock1             ; start of RAM
                      (    interrupt.asm):00234                 
F1B5                  (    interrupt.asm):00235         NMISaveLoop
F1B5 5F               (    interrupt.asm):00236                 clrb                            ; 256 bytes
F1B6 BDEDBE           (    interrupt.asm):00237                         jsr     >MMC_WriteFileBlock     ; write to MMC
                      (    interrupt.asm):00238                 
F1B9 8C8000           (    interrupt.asm):00239                 cmpx    #LoadEnd                ; End of RAM?
F1BC 25F7             (    interrupt.asm):00240                 blo     NMISaveLoop             ; no do next block
                      (    interrupt.asm):00241                 
F1BE 17FB5B           (    interrupt.asm):00242                 lbsr    MMC_CloseFile               ; close the file
                      (    interrupt.asm):00243         
F1C1 C60F             (    interrupt.asm):00244                 ldb     #15                     ; Clear last line
F1C3 BDF069           (    interrupt.asm):00245                 jsr     >CON_ClearLineB         
                      (    interrupt.asm):00246                 
F1C6 39               (    interrupt.asm):00247                         rts
                      (    interrupt.asm):00248         
F1C7                  (    interrupt.asm):00249         NMIGetSendFileName
F1C7 C60F             (    interrupt.asm):00250                 ldb     #15                     ; Line 15
F1C9 308D0146         (    interrupt.asm):00251                 leax    FilePrompt,pcr          ; Point to prompt
F1CD BDF081           (    interrupt.asm):00252                 jsr     >CON_ClearBPrintX       ; print it
                      (    interrupt.asm):00253                 
F1D0 3277             (    interrupt.asm):00254                 leas    -FileNameLen,s          ; Make room on stack
                      (    interrupt.asm):00255                 
F1D2 30E4             (    interrupt.asm):00256                 leax    ,s                      ; get pointer to buffer
F1D4 C609             (    interrupt.asm):00257                 ldb     #FileNameLen            ; filename length
F1D6 BDF025           (    interrupt.asm):00258                 jsr     >CON_InputBufXB         ; go read it
                      (    interrupt.asm):00259                 
F1D9 BDECFF           (    interrupt.asm):00260                 jsr     >MMC_SendTillZero       ; send filename to AVR
                      (    interrupt.asm):00261                 
F1DC 3269             (    interrupt.asm):00262                 leas    FileNameLen,s           ; discard buffer
                      (    interrupt.asm):00263                 
F1DE 308D013C         (    interrupt.asm):00264                 leax    SnapExt,pcr             ; point to extension
F1E2 C604             (    interrupt.asm):00265                 ldb     #4                      ; 4 bytes in extension
F1E4 7EECF5           (    interrupt.asm):00266                 jmp     >MMC_SendName2          ; send the name
                      (    interrupt.asm):00267         
                      (    interrupt.asm):00268         ;
                      (    interrupt.asm):00269         ; Load a snapshot file from card, will need to load the file in parts
                      (    interrupt.asm):00270         ; so as to avoid over-writing stack.
                      (    interrupt.asm):00271         ; Proposed method is : 
                      (    interrupt.asm):00272         ;   check / move** stack to top 16K of RAM, then load in the first 16K.
                      (    interrupt.asm):00273         ;   move stack pointer to the screen area at $500, and load the top 16K.
                      (    interrupt.asm):00274         ;   read the real stack pointer loaction from the file (first 2 bytes) and set it.
                      (    interrupt.asm):00275         ;   re-read the screen ram at $400.
                      (    interrupt.asm):00276         ;   return from the load routine which will return into the snap menu. 
                      (    interrupt.asm):00277         
                      (    interrupt.asm):00278         
F1E7                  (    interrupt.asm):00279         NMILoad
F1E7 8DDE             (    interrupt.asm):00280                 bsr     NMIGetSendFileName      ; Get filename, send to AVR
                      (    interrupt.asm):00281                 
F1E9 8600             (    interrupt.asm):00282                         lda             #CAS_FILE                               ; file id of cas file
F1EB 17EE33           (    interrupt.asm):00283                         lbsr    MMC_WaitPutLatchRead    ; send it to latch register
                      (    interrupt.asm):00284         
F1EE 8619             (    interrupt.asm):00285                         lda             #CMD_FILE_OPEN_SNAPR    ; Open snapshot for read 
F1F0 17EE1B           (    interrupt.asm):00286                         lbsr    MMC_SendCmd                     ; Open file
F1F3 2B63             (    interrupt.asm):00287                 bmi     NMILoadError            ; error opening file
F1F5                  (    interrupt.asm):00288         NMILoadEntry               
F1F5 118C4000         (    interrupt.asm):00289                 cmps    #LoadBlock2             ; Is stack in top of RAM?
F1F9 2404             (    interrupt.asm):00290                 bhs     NMIStackHigh            ; yes : do nothing
F1FB 10CE7FFF         (    interrupt.asm):00291                 lds     #LoadEnd-1              ; no : move to top of ram
                      (    interrupt.asm):00292                 
F1FF                  (    interrupt.asm):00293         NMIStackHigh        
F1FF 17FB9C           (    interrupt.asm):00294                 lbsr    MMC_ReadDFile           ; Read saved S (skip past it)
F202 3406             (    interrupt.asm):00295                 pshs    d                       ; Save stapshot's S
                      (    interrupt.asm):00296                 
                      (    interrupt.asm):00297         ; Load the first 16K of the image        
F204 8E0000           (    interrupt.asm):00298                 ldx     #LoadBlock1             ; begin loading at bottom of RAM
F207                  (    interrupt.asm):00299         NMILoadLoop1
F207 5F               (    interrupt.asm):00300                 clrb                            ; flag 256 bytes
F208 BDED70           (    interrupt.asm):00301                 jsr     >MMC_ReadFileBlockRaw   ; read a block
F20B 8C4000           (    interrupt.asm):00302                 cmpx    #LoadBlock2             ; top of first 16K
F20E 26F7             (    interrupt.asm):00303                 bne     NMILoadLoop1            ; no : keep loading
                      (    interrupt.asm):00304         
                      (    interrupt.asm):00305         ; We have loaded the first 16K of the image, move stack pointer to $500        
F210 3506             (    interrupt.asm):00306                 puls    d                       ; recover saved snapshot S
F212 10834000         (    interrupt.asm):00307                 cmpd    #LoadBlock2             ; in already laded RAM ?
F216 2404             (    interrupt.asm):00308                 bhs     NMITempS                ; no : use temp stack in screen ram
F218 1F04             (    interrupt.asm):00309                 tfr     d,s                     ; yes : make it active
F21A 2004             (    interrupt.asm):00310                 bra     NMIDoBlock2             ; Go load upper ram
                      (    interrupt.asm):00311                 
F21C                  (    interrupt.asm):00312         NMITempS        
F21C 10CE0500         (    interrupt.asm):00313                 lds     #TempS                  ; setup temp stack
F220                  (    interrupt.asm):00314         NMIDoBlock2        
F220 8E4000           (    interrupt.asm):00315                 ldx     #LoadBlock2             ; begin loading at bottom of RAM
F223                  (    interrupt.asm):00316         NMILoadLoop2
F223 5F               (    interrupt.asm):00317                 clrb                            ; flag 256 bytes
F224 BDED70           (    interrupt.asm):00318                 jsr     >MMC_ReadFileBlockRaw   ; read a block
F227 8C8000           (    interrupt.asm):00319                 cmpx    #LoadEnd                ; top of first 16K
F22A 26F7             (    interrupt.asm):00320                 bne     NMILoadLoop2            ; no : keep loading
                      (    interrupt.asm):00321                 
                      (    interrupt.asm):00322         ; we now have loaded the whole image, except the text screen ram which we used as
                      (    interrupt.asm):00323         ; a stack. We need to position the stack pointer at the saved stack pointer and
                      (    interrupt.asm):00324         ; re-load the screen ram from $400-$500        
F22C 8600             (    interrupt.asm):00325                         lda             #CAS_FILE                               ; file id of cas file
F22E 17EDF0           (    interrupt.asm):00326                         lbsr    MMC_WaitPutLatchRead    ; send it to latch register
                      (    interrupt.asm):00327                         
F231 8624             (    interrupt.asm):00328                 lda     #CMD_REWIND             ; rewind file to beginning
F233 BDE00E           (    interrupt.asm):00329                 jsr     >MMC_SendCmd            
                      (    interrupt.asm):00330                 
F236 17FB65           (    interrupt.asm):00331                 lbsr    MMC_ReadDFile           ; Read saved S        
F239 1F04             (    interrupt.asm):00332                 tfr     d,s                     ; setup loaded stack pointer
                      (    interrupt.asm):00333         
F23B 10834000         (    interrupt.asm):00334                 cmpd    #LoadBlock2             ; in bottom of RAM?
F23F 250C             (    interrupt.asm):00335                 blo     NMINoBlock3             ; yes no need to re-read bottom of RAM
                      (    interrupt.asm):00336         
F241 8E0000           (    interrupt.asm):00337                 ldx     #LoadBlock1             ; begin loading at bottom of RAM
F244                  (    interrupt.asm):00338         NMILoadLoop3
F244 5F               (    interrupt.asm):00339                 clrb                            ; flag 256 bytes
F245 BDED70           (    interrupt.asm):00340                 jsr     >MMC_ReadFileBlockRaw   ; read a block
F248 8C0600           (    interrupt.asm):00341                 cmpx    #LoadBlock1a            ; top of text screen
F24B 26F7             (    interrupt.asm):00342                 bne     NMILoadLoop3            ; no : keep loading
                      (    interrupt.asm):00343         
F24D                  (    interrupt.asm):00344         NMINoBlock3 
                      (    interrupt.asm):00345         
F24D 17FACC           (    interrupt.asm):00346                 lbsr    MMC_CloseFile               ; close the file
F250 17FE58           (    interrupt.asm):00347                 lbsr    InterruptInit           ; Reinit our vectors as they may be different in image
                      (    interrupt.asm):00348              
F253 326B             (    interrupt.asm):00349                 leas    11,s                    ; Drop bytes saved by menu etc
F255 7EF122           (    interrupt.asm):00350                 jmp     NMI_Exit                ; exit NMI back to loaded program
                      (    interrupt.asm):00351                 
F258                  (    interrupt.asm):00352         NMILoadError
F258 3402             (    interrupt.asm):00353                 pshs    a                       ; save error code
F25A C60F             (    interrupt.asm):00354                 ldb     #15                     ; Line 15
F25C 308D00C2         (    interrupt.asm):00355                 leax    ErrorMess1,pcr          ; Point to message
F260 BDF081           (    interrupt.asm):00356                 jsr     >CON_ClearBPrintX       ; print it
                      (    interrupt.asm):00357                 
F263 3502             (    interrupt.asm):00358                 puls    a                       ; retrieve error code
F265 BDEF02           (    interrupt.asm):00359                 jsr     >CON_WriteHexByte        ; write it.
                      (    interrupt.asm):00360                 
F268 308D00B6         (    interrupt.asm):00361                 leax    ErrorMess1,pcr          ; Point to message
F26C BDEF9E           (    interrupt.asm):00362                 jsr     CON_WriteString         ; print it
                      (    interrupt.asm):00363                 
F26F 39               (    interrupt.asm):00364                 rts
                      (    interrupt.asm):00365                 
F270                  (    interrupt.asm):00366         NMIUtil
F270 39               (    interrupt.asm):00367                         rts
                      (    interrupt.asm):00368                                 
                      (    interrupt.asm):00369         ;
                      (    interrupt.asm):00370         ; On entry D contains SAM bits to set.
                      (    interrupt.asm):00371         ;       
                      (    interrupt.asm):00372         ; We only set the graphics mode and offset bits, we should not need to touch
                      (    interrupt.asm):00373         ; the memory type & CPU speed as they should not have been changed.
                      (    interrupt.asm):00374         ;
F271                  (    interrupt.asm):00375         SetSambits
F271 8EFFC0           (    interrupt.asm):00376                         ldx             #SAMBase                                ; point at base of SAM registers
                      (    interrupt.asm):00377         
F274                  (    interrupt.asm):00378         SetSambitsLoop          
F274 44               (    interrupt.asm):00379                         lsra                                                    ; bottom bit into carry
F275 56               (    interrupt.asm):00380                         rorb                                                    ; carry-> top bit, bottom bit into carry
F276 2504             (    interrupt.asm):00381                         bcs             SetSambit                               ; yes set it
F278 6F84             (    interrupt.asm):00382                         clr             ,x                                              ; Clear sam bit
F27A 2002             (    interrupt.asm):00383                         bra             NextBit
F27C                  (    interrupt.asm):00384         SetSambit
F27C 6F01             (    interrupt.asm):00385                         clr             1,x                                             ; set sambit
F27E                  (    interrupt.asm):00386         NextBit
F27E 3002             (    interrupt.asm):00387                         leax    2,x                                             ; next bit
F280 8CFFD4           (    interrupt.asm):00388                         cmpx    #SAMCP1                                 ; done all?
F283 25EF             (    interrupt.asm):00389                         blo             SetSambitsLoop                  ; no : go again
F285 39               (    interrupt.asm):00390                         rts
                      (    interrupt.asm):00391                         
                      (    interrupt.asm):00392         ;
                      (    interrupt.asm):00393         ; Save PIA registers on stack :
                      (    interrupt.asm):00394         ;
                      (    interrupt.asm):00395         ; CRA           <- highest address
                      (    interrupt.asm):00396         ; DDRA
                      (    interrupt.asm):00397         ; PA
                      (    interrupt.asm):00398         ; CRB
                      (    interrupt.asm):00399         ; DDRB
                      (    interrupt.asm):00400         ; DB            <- lowest address
                      (    interrupt.asm):00401         ;
                      (    interrupt.asm):00402         ; This is repeated for PIA2
                      (    interrupt.asm):00403         ;
F286                  (    interrupt.asm):00404         NMI_SavePIA
F286 8EFF00           (    interrupt.asm):00405                 ldx     #PIA0DA                 ; point to PIA0
                      (    interrupt.asm):00406         
F289                  (    interrupt.asm):00407         NMI_SavePIALoop
F289 A601             (    interrupt.asm):00408                 lda     1,x                     ; get control register A side
F28B 3402             (    interrupt.asm):00409                 pshs    a                       ; save it
                      (    interrupt.asm):00410                 
F28D 84FB             (    interrupt.asm):00411                 anda    #$FF-PIACRDDR           ; select DDR
F28F A701             (    interrupt.asm):00412                 sta     1,x                     
F291 E684             (    interrupt.asm):00413                 ldb     ,x                      ; Get DDR
F293 3404             (    interrupt.asm):00414                 pshs    b
                      (    interrupt.asm):00415                 
F295 8A04             (    interrupt.asm):00416                 ora     #PIACRDDR               ; select data register
F297 A701             (    interrupt.asm):00417                 sta     1,x
F299 E684             (    interrupt.asm):00418                 ldb     ,x
F29B 3404             (    interrupt.asm):00419                 pshs    b
                      (    interrupt.asm):00420                 
F29D A603             (    interrupt.asm):00421                 lda     3,x                     ; get control register A side
F29F 3402             (    interrupt.asm):00422                 pshs    a                       ; save it
                      (    interrupt.asm):00423                 
F2A1 84FB             (    interrupt.asm):00424                 anda    #$FF-PIACRDDR           ; select DDR
F2A3 A703             (    interrupt.asm):00425                 sta     3,x                     
F2A5 E602             (    interrupt.asm):00426                 ldb     2,x                     ; Get DDR
F2A7 3404             (    interrupt.asm):00427                 pshs    b
                      (    interrupt.asm):00428                 
F2A9 8A04             (    interrupt.asm):00429                 ora     #PIACRDDR               ; select data register
F2AB A703             (    interrupt.asm):00430                 sta     3,x
F2AD E602             (    interrupt.asm):00431                 ldb     2,x
F2AF 3404             (    interrupt.asm):00432                 pshs    b
                      (    interrupt.asm):00433                 
F2B1 308820           (    interrupt.asm):00434                 leax    $20,x                   ; do next PIA
F2B4 8CFF40           (    interrupt.asm):00435                 cmpx    #$FF40                  ; Done both ?
F2B7 25D0             (    interrupt.asm):00436                 blo     NMI_SavePIALoop         ; no go again.
                      (    interrupt.asm):00437                 
F2B9 1E53             (    interrupt.asm):00438                 exg     pc,u                    ; return to caller
                      (    interrupt.asm):00439         
                      (    interrupt.asm):00440                 
F2BB                  (    interrupt.asm):00441         NMI_RestorePIA
F2BB 8EFF20           (    interrupt.asm):00442                 ldx     #PIA1DA                 ; point to PIA1
                      (    interrupt.asm):00443         
F2BE                  (    interrupt.asm):00444         NMI_RestorePIALoop
F2BE A603             (    interrupt.asm):00445                 lda     3,x                     ; get control register A side
                      (    interrupt.asm):00446         
                      (    interrupt.asm):00447         ; Restore B side
F2C0 8A04             (    interrupt.asm):00448                 ora     #PIACRDDR               ; select Data reg
F2C2 A703             (    interrupt.asm):00449                 sta     3,x                     
F2C4 3504             (    interrupt.asm):00450                 puls    b                       ; restore it
F2C6 E702             (    interrupt.asm):00451                 stb     2,x
                      (    interrupt.asm):00452                 
F2C8 84FB             (    interrupt.asm):00453                 anda    #$FF-PIACRDDR           ; select DDR register
F2CA A703             (    interrupt.asm):00454                 sta     3,x
F2CC 3504             (    interrupt.asm):00455                 puls    b                       ; restore it
F2CE E702             (    interrupt.asm):00456                 stb     2,x
                      (    interrupt.asm):00457                 
F2D0 3502             (    interrupt.asm):00458                 puls    a                       ; Restore CRB
F2D2 A703             (    interrupt.asm):00459                 sta     3,x
                      (    interrupt.asm):00460         
                      (    interrupt.asm):00461         ;Restore A side
F2D4 A601             (    interrupt.asm):00462                 lda     1,x                     ; get control register A side
                      (    interrupt.asm):00463         
F2D6 8A04             (    interrupt.asm):00464                 ora     #PIACRDDR               ; select Data reg
F2D8 A701             (    interrupt.asm):00465                 sta     1,x                     
F2DA 3504             (    interrupt.asm):00466                 puls    b                       ; restore it
F2DC E784             (    interrupt.asm):00467                 stb     ,x
                      (    interrupt.asm):00468                 
F2DE 84FB             (    interrupt.asm):00469                 anda    #$FF-PIACRDDR           ; select DDR register
F2E0 A701             (    interrupt.asm):00470                 sta     1,x
F2E2 3504             (    interrupt.asm):00471                 puls    b                       ; restore it
F2E4 E784             (    interrupt.asm):00472                 stb     ,x
                      (    interrupt.asm):00473                 
F2E6 3502             (    interrupt.asm):00474                 puls    a                       ; Restore CRA
F2E8 A701             (    interrupt.asm):00475                 sta     1,x
                      (    interrupt.asm):00476            
F2EA 3088E0           (    interrupt.asm):00477                 leax    -$20,x                  ; do next PIA
F2ED 8CFF00           (    interrupt.asm):00478                 cmpx    #$FF00                  ; Done both ?
F2F0 24CC             (    interrupt.asm):00479                 bhs     NMI_RestorePIALoop      ; no go again.
                      (    interrupt.asm):00480                 
F2F2 1E53             (    interrupt.asm):00481                 exg     pc,u                    ; return to caller
                      (    interrupt.asm):00482         
                      (    interrupt.asm):00483         ;
                      (    interrupt.asm):00484         ; Data, menu tables messages etc.
                      (    interrupt.asm):00485         ;
                      (    interrupt.asm):00486             
F2F4                  (    interrupt.asm):00487         NMIMenu1
                      (    interrupt.asm):00488         ;                                01234567890123456789012345678901
F2F4 7741524D20634F4C (    interrupt.asm):00489                         FCC             'wARM cOLD sAVE lOAD uTIL ExIT'
     442073415645206C
     4F4144207554494C
     2045784954
F311 0D00             (    interrupt.asm):00490                         FCB             $0d,$00
                      (    interrupt.asm):00491         
F313                  (    interrupt.asm):00492         FilePrompt
F313 46494C454E414D45 (    interrupt.asm):00493                 FCC     'FILENAME >'
     203E
F31D 00               (    interrupt.asm):00494                 FCB     $00
                      (    interrupt.asm):00495         
                      (    interrupt.asm):00496         ;
                      (    interrupt.asm):00497         ; Use different extensions for Dragon and CoCo so we don't inadvertently load a snapshot
                      (    interrupt.asm):00498         ; on the wrong platform.
                      (    interrupt.asm):00499         ;
F31E                  (    interrupt.asm):00500         SnapExt
                      (    interrupt.asm):00501                 ifdef   Dragon
F31E 2E535344         (    interrupt.asm):00502                 FCC     '.SSD'
                      (    interrupt.asm):00503                 else
                      (    interrupt.asm):00504                 FCC     '.SSC'
                      (    interrupt.asm):00505                 endc
                      (    interrupt.asm):00506                 
F322                  (    interrupt.asm):00507         ErrorMess1
F322 4552524F523A20   (    interrupt.asm):00508                 FCC     'ERROR: '
F329 00               (    interrupt.asm):00509                 FCB     $00
                      (    interrupt.asm):00510         
                      (    interrupt.asm):00511                         ifne    0
F32A                  (    interrupt.asm):00512         ErrorMess2
                      (    interrupt.asm):00513                 FCC     'OPENING FILE'
                      (    interrupt.asm):00514                 FCB     $00
                      (    interrupt.asm):00515                         endc
                      (    interrupt.asm):00516                         
F32A                  (    interrupt.asm):00517         NMIMenuTable1
F32A 57               (    interrupt.asm):00518                         FCB             'W'                                             ; Warm start
F32B F18F             (    interrupt.asm):00519                         FDB             NMIWarm
                      (    interrupt.asm):00520                         
F32D 43               (    interrupt.asm):00521                         FCB             'C'                                             ; Cold start
F32E F178             (    interrupt.asm):00522                         FDB             NMICold
                      (    interrupt.asm):00523                         
F330 53               (    interrupt.asm):00524                         FCB             'S'                                             ; Save snapshot
F331 F199             (    interrupt.asm):00525                         FDB             NMISave
                      (    interrupt.asm):00526                         
F333 4C               (    interrupt.asm):00527                 FCB             'L'                                             ; Load snapshot
F334 F1E7             (    interrupt.asm):00528                         FDB             NMILoad
                      (    interrupt.asm):00529                                 
F336 55               (    interrupt.asm):00530                         FCB             'U'                                             ; Utils
F337 F270             (    interrupt.asm):00531                         FDB             NMIUtil
                      (    interrupt.asm):00532                         
F339 58               (    interrupt.asm):00533                         FCB             'X'                                             ; Exit
F33A F174             (    interrupt.asm):00534                         FDB             NMIMenuExit
                      (    interrupt.asm):00535                         
F33C 00               (    interrupt.asm):00536                         FCB             0                                               ; end of table
F33D F32A             (    interrupt.asm):00537                         FDB             NMIMenuTable1                   ; pointer back to beginnig of table
                      (    interrupt.asm):00538         
F33F                  (    interrupt.asm):00539         __interrupt_end
                      (    DragonMMC.asm):00679         ;        use     mon.asm
                      (    DragonMMC.asm):00680         
                      (    DragonMMC.asm):00681         
F33F                  (    DragonMMC.asm):00682         Inverse
F33F BD89AA           (    DragonMMC.asm):00683                         jsr             VarCKComma                              ; Check for comma, SN error if not
F342 BD8E83           (    DragonMMC.asm):00684                         jsr             VarGet16Bit                             ; Get print pos
F345 8C0000           (    DragonMMC.asm):00685                         cmpx    #0                                              ; beforer first?
F348 2521             (    DragonMMC.asm):00686                         blo             InvError
F34A 8C01FF           (    DragonMMC.asm):00687                         cmpx    #$1FF                                   ; beyond end of screen?
F34D 221C             (    DragonMMC.asm):00688                         bhi             InvError                                ; yep 
                      (    DragonMMC.asm):00689                         
F34F 30890400         (    DragonMMC.asm):00690                         leax    $400,x                                  ; turn into screen offset
                      (    DragonMMC.asm):00691                         
F353 3410             (    DragonMMC.asm):00692                         pshs    x                                               ; save on stack
                      (    DragonMMC.asm):00693                         
F355 BD89AA           (    DragonMMC.asm):00694                         jsr             VarCKComma                              ; Check for comma, SN error if not
F358 BD8E51           (    DragonMMC.asm):00695                         jsr             VarGet8Bit                              ; Get char count (in b)
                      (    DragonMMC.asm):00696                         
F35B 3510             (    DragonMMC.asm):00697                         puls    x
                      (    DragonMMC.asm):00698                         
F35D                  (    DragonMMC.asm):00699         InvLoop
F35D A684             (    DragonMMC.asm):00700                         lda             ,x                                              ; get char from screen
F35F 8180             (    DragonMMC.asm):00701                         cmpa    #$80                                    ; >$80, semigraphic, leave unchanged.
F361 2402             (    DragonMMC.asm):00702                         bhs             NoInv
F363 8840             (    DragonMMC.asm):00703                         eora    #$40                                    ; flip bit
F365                  (    DragonMMC.asm):00704         NoInv
F365 A780             (    DragonMMC.asm):00705                         sta             ,x+                                             ; resave it
F367 5A               (    DragonMMC.asm):00706                         decb                                                    ; decrement count
F368 26F3             (    DragonMMC.asm):00707                         bne             InvLoop                                 ; not zero loop again
                      (    DragonMMC.asm):00708                 
F36A 39               (    DragonMMC.asm):00709                         rts
                      (    DragonMMC.asm):00710                         
F36B                  (    DragonMMC.asm):00711         InvError
F36B 7E8B8D           (    DragonMMC.asm):00712                         jmp             BasFCError
                      (    DragonMMC.asm):00713         
                      (    DragonMMC.asm):00714         
                      (    DragonMMC.asm):00715         ;********************************
                      (    DragonMMC.asm):00716         ;** PLACE NO CODE BELOW HERE ! **
                      (    DragonMMC.asm):00717         ;********************************
                      (    DragonMMC.asm):00718         
F36E 0000000000000000 (    DragonMMC.asm):00719                         zmb             $fffd-*
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     0000000000000000
     00000000000000
                      (    DragonMMC.asm):00720                 
FFFD 504853           (    DragonMMC.asm):00721                         FCC             /PHS/
                      (    DragonMMC.asm):00722         ;DE000   END
                      (    DragonMMC.asm):00723                 
